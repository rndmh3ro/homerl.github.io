<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[Dump sparse file data segment]]></title>
      <url>http://yoursite.com/2016/12/18/dump-sparse-file-data-segment/</url>
      <content type="html"><![CDATA[<h3 id="Test-file"><a href="#Test-file" class="headerlink" title="Test file"></a>Test file</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ rm data-A</span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..1500&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span> &gt;&gt; data-A ; <span class="keyword">done</span></span><br><span class="line">$ filefrag -v data-A </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of data-A is 6394 (2 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:        0..       0:    3464588..   3464588:      1:            </span><br><span class="line">   1:        1..       1:          0..         0:      1:    3464589: last,unknown_loc,delalloc,eof</span><br><span class="line">$ dd <span class="keyword">if</span>=data-A of=data-A-1 bs=4096 count=1</span><br><span class="line">$ dd <span class="keyword">if</span>=data-A of=data-A-2 bs=4096 count=1 skip=1</span><br><span class="line">$ head data-A-2</span><br><span class="line">1</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ cat data-A-1 data-A-2 | md5sum</span><br><span class="line">30ef7f11d29b8ad47542e97ed9d2a398  -</span><br><span class="line">$ cat data-A | md5sum</span><br><span class="line">30ef7f11d29b8ad47542e97ed9d2a398  -</span><br></pre></td></tr></table></figure>
<h3 id="Test-sparse-file"><a href="#Test-sparse-file" class="headerlink" title="Test sparse file"></a>Test sparse file</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">$ rm ./data-A;<span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..1500&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span> &gt;&gt; data-A ; <span class="keyword">done</span></span><br><span class="line">$ filefrag -v data-A </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of data-A is 6393 (2 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:        0..       1:          0..         1:      2:             last,unknown_loc,delalloc,eof</span><br><span class="line">data-A: 1 extent found</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=<span class="built_in">test</span> bs=4096 count=0 seek=25 <span class="comment">#write 100K sparse file</span></span><br><span class="line">$ cat data-A &gt;&gt; <span class="built_in">test</span></span><br><span class="line">$ ls -lhs </span><br><span class="line">total 16K</span><br><span class="line">8.0K -rw-rw-r-- 1 homerl homerl 6.3K 12月 19 14:04 data-A</span><br><span class="line">8.0K -rw-rw-r-- 1 homerl homerl 107K 12月 19 14:06 <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">$ df -h / </span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda2       101G   35G   61G  37% /</span><br><span class="line"></span><br><span class="line">$ sudo dumpe2fs /dev/sda2 | grep -i <span class="string">"Block size"</span></span><br><span class="line">dumpe2fs 1.42.13 (17-May-2015)</span><br><span class="line">Block size:               4096</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ filefrag -v data-A </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of data-A is 6393 (2 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:        0..       1:    3713508..   3713509:      2:             last,eof</span><br><span class="line">data-A: 1 extent found</span><br><span class="line"></span><br><span class="line">$ sudo dd <span class="keyword">if</span>=/dev/sda2 of=<span class="built_in">test</span>-1 bs=4096 count=1 skip=3713508</span><br><span class="line">$ head <span class="built_in">test</span>-1 </span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line"></span><br><span class="line">$ tail <span class="built_in">test</span>-1</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">104</span><br><span class="line"></span><br><span class="line">$ cat <span class="built_in">test</span>-1 | md5sum</span><br><span class="line">27260c41d34d5a01f5fba073f9059a90  -</span><br><span class="line"></span><br><span class="line">$ filefrag -v <span class="built_in">test</span></span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of <span class="built_in">test</span> is 108793 (27 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:       25..      26:    3713510..   3713511:      2:             last,eof</span><br><span class="line"><span class="built_in">test</span>: 1 extent found</span><br><span class="line"></span><br><span class="line">$ sudo dd <span class="keyword">if</span>=/dev/sda2 of=<span class="built_in">test</span><span class="_">-s</span>-1 bs=4096 count=1 skip=3713510</span><br><span class="line"></span><br><span class="line">$ md5sum <span class="built_in">test</span>-*</span><br><span class="line">27260c41d34d5a01f5fba073f9059a90  <span class="built_in">test</span>-1</span><br><span class="line">27260c41d34d5a01f5fba073f9059a90  <span class="built_in">test</span><span class="_">-s</span>-1</span><br><span class="line"></span><br><span class="line">$ sudo dd <span class="keyword">if</span>=/dev/sda2 of=<span class="built_in">test</span><span class="_">-s</span>-2 bs=4096 count=1 skip=3713511</span><br><span class="line"></span><br><span class="line"><span class="comment"># the checksum difference between test-s-2 and test</span></span><br><span class="line">$ hexdump <span class="built_in">test</span><span class="_">-s</span>-2 | tail</span><br><span class="line">0000890 3431 3038 310a 3834 0a31 3431 3238 310a</span><br><span class="line">00008a0 3834 0a33 3431 3438 310a 3834 0a35 3431</span><br><span class="line">00008b0 3638 310a 3834 0a37 3431 3838 310a 3834</span><br><span class="line">00008c0 0a39 3431 3039 310a 3934 0a31 3431 3239</span><br><span class="line">00008d0 310a 3934 0a33 3431 3439 310a 3934 0a35</span><br><span class="line">00008e0 3431 3639 310a 3934 0a37 3431 3839 310a</span><br><span class="line">00008f0 3934 0a39 3531 3030 000a 0000 0000 0000</span><br><span class="line">0000900 0000 0000 0000 0000 0000 0000 0000 0000</span><br><span class="line">*</span><br><span class="line">0001000</span><br><span class="line"></span><br><span class="line">$ hexdump <span class="built_in">test</span> | tail</span><br><span class="line">001a870 0a33 3431 3437 310a 3734 0a35 3431 3637</span><br><span class="line">001a880 310a 3734 0a37 3431 3837 310a 3734 0a39</span><br><span class="line">001a890 3431 3038 310a 3834 0a31 3431 3238 310a</span><br><span class="line">001a8a0 3834 0a33 3431 3438 310a 3834 0a35 3431</span><br><span class="line">001a8b0 3638 310a 3834 0a37 3431 3838 310a 3834</span><br><span class="line">001a8c0 0a39 3431 3039 310a 3934 0a31 3431 3239</span><br><span class="line">001a8d0 310a 3934 0a33 3431 3439 310a 3934 0a35</span><br><span class="line">001a8e0 3431 3639 310a 3934 0a37 3431 3839 310a</span><br><span class="line">001a8f0 3934 0a39 3531 3030 000a               </span><br><span class="line">001a8f9</span><br></pre></td></tr></table></figure>
<p>There are some of zero fill in the file bottom.</p>
<h3 id="dd-update"><a href="#dd-update" class="headerlink" title="dd update"></a>dd update</h3><p>operate single byte<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=data-A of=data-A-1Byte bs=1  count=1 ibs=1 obs=1</span><br><span class="line">$ dd <span class="keyword">if</span>=data-A of=data-A-skip-1byte bs=1  skip=2 count=1 ibs=1 obs=1 iflag=count_bytes iflag=skip_bytes</span><br><span class="line"></span><br><span class="line">$ ls -ls | grep -i by</span><br><span class="line"></span><br><span class="line"><span class="comment">#first column is KiB , 4 is 4KiB</span></span><br><span class="line"><span class="comment">#sixth column is byte , 1 byte</span></span><br><span class="line"></span><br><span class="line">  4 -rw-rw-r-- 1 homerl homerl      1 12月 19 15:23 data-A-1Byte</span><br><span class="line">  4 -rw-rw-r-- 1 homerl homerl      1 12月 19 15:22 data-A-skip-1byte</span><br><span class="line"></span><br><span class="line">$ cat data-A-1Byte</span><br><span class="line">1 $ cat data-A-skip-1byte</span><br><span class="line">2</span><br><span class="line"></span><br><span class="line">$ ls -ls <span class="built_in">test</span> data-A </span><br><span class="line">8 -rw-rw-r-- 1 homerl homerl   6393 12月 19 14:54 data-A</span><br><span class="line">8 -rw-rw-r-- 1 homerl homerl 108793 12月 19 15:30 <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">$  dd <span class="keyword">if</span>=<span class="built_in">test</span> of=<span class="built_in">test</span>-data bs=1 count=6393 skip=102400 iflag=skip_bytes ibs=1 obs=1</span><br><span class="line">$ $ sha1sum   data-A <span class="built_in">test</span>-data <span class="built_in">test</span></span><br><span class="line">8f8374832cb6536f580eef3b316ad08293a47617  data-A</span><br><span class="line">8f8374832cb6536f580eef3b316ad08293a47617  <span class="built_in">test</span>-data</span><br><span class="line">03e31af4c89c9003ee0f43e49a65ad2e24367024  <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">$ hexdump data-A | tail</span><br><span class="line">0001870 0a33 3431 3437 310a 3734 0a35 3431 3637</span><br><span class="line">0001880 310a 3734 0a37 3431 3837 310a 3734 0a39</span><br><span class="line">0001890 3431 3038 310a 3834 0a31 3431 3238 310a</span><br><span class="line">00018a0 3834 0a33 3431 3438 310a 3834 0a35 3431</span><br><span class="line">00018b0 3638 310a 3834 0a37 3431 3838 310a 3834</span><br><span class="line">00018c0 0a39 3431 3039 310a 3934 0a31 3431 3239</span><br><span class="line">00018d0 310a 3934 0a33 3431 3439 310a 3934 0a35</span><br><span class="line">00018e0 3431 3639 310a 3934 0a37 3431 3839 310a</span><br><span class="line">00018f0 3934 0a39 3531 3030 000a               </span><br><span class="line">00018f9</span><br><span class="line">$ hexdump <span class="built_in">test</span>-data | tail</span><br><span class="line">0001870 0a33 3431 3437 310a 3734 0a35 3431 3637</span><br><span class="line">0001880 310a 3734 0a37 3431 3837 310a 3734 0a39</span><br><span class="line">0001890 3431 3038 310a 3834 0a31 3431 3238 310a</span><br><span class="line">00018a0 3834 0a33 3431 3438 310a 3834 0a35 3431</span><br><span class="line">00018b0 3638 310a 3834 0a37 3431 3838 310a 3834</span><br><span class="line">00018c0 0a39 3431 3039 310a 3934 0a31 3431 3239</span><br><span class="line">00018d0 310a 3934 0a33 3431 3439 310a 3934 0a35</span><br><span class="line">00018e0 3431 3639 310a 3934 0a37 3431 3839 310a</span><br><span class="line">00018f0 3934 0a39 3531 3030 000a               </span><br><span class="line">00018f9</span><br><span class="line">$ hexdump <span class="built_in">test</span> | tail</span><br><span class="line">001a870 0a33 3431 3437 310a 3734 0a35 3431 3637</span><br><span class="line">001a880 310a 3734 0a37 3431 3837 310a 3734 0a39</span><br><span class="line">001a890 3431 3038 310a 3834 0a31 3431 3238 310a</span><br><span class="line">001a8a0 3834 0a33 3431 3438 310a 3834 0a35 3431</span><br><span class="line">001a8b0 3638 310a 3834 0a37 3431 3838 310a 3834</span><br><span class="line">001a8c0 0a39 3431 3039 310a 3934 0a31 3431 3239</span><br><span class="line">001a8d0 310a 3934 0a33 3431 3439 310a 3934 0a35</span><br><span class="line">001a8e0 3431 3639 310a 3934 0a37 3431 3839 310a</span><br><span class="line">001a8f0 3934 0a39 3531 3030 000a               </span><br><span class="line">001a8f9</span><br></pre></td></tr></table></figure></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Ping test in serial link]]></title>
      <url>http://yoursite.com/2016/12/05/Ping-test-in-serial-link/</url>
      <content type="html"><![CDATA[<h3 id="Calculate-upload-download-speed-by-ping"><a href="#Calculate-upload-download-speed-by-ping" class="headerlink" title="Calculate upload/download speed by ping"></a><a href="http://stackoverflow.com/questions/4575537/calculate-upload-download-speed-by-ping" target="_blank" rel="external">Calculate upload/download speed by ping</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ping <span class="_">-f</span> -c 10000 <span class="_">-s</span> 1472 10.100.100.100</span><br></pre></td></tr></table></figure>
<p>At the end of the result i get: round-trip min/avg/max/stddev = 0.174/0.219/2.078/0.020 ms<br>so in average it takes 0.219 ms to send 1500 bytes and receive 1500 bytes, that’s 24 kb. 24 kb / 0.219 ms = 110 Mb/s<br>If you want to use that to a server on the internet, you need to lower the packet size to something like 1464 (for MTU 1492), drop the -f option and lower the count so it won’t take too long to finish.</p>
<p>1500 TX Bytes + 1500 RX Bytes= 3000 Bytes = 3000 * 8 = 24000 bits<br>24000 / 0.219 = 109.589 Mb/s</p>
<p>It ‘s not represent full throughput. just test single link in your ethernet adapter. not parallel.</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Record and Replay Linux Terminal]]></title>
      <url>http://yoursite.com/2016/12/01/Record-and-Replay-Linux-Terminal/</url>
      <content type="html"><![CDATA[<h3 id="script-and-scriptreplay"><a href="#script-and-scriptreplay" class="headerlink" title="script and scriptreplay"></a>script and scriptreplay</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ script --timing=time.txt script.log</span><br><span class="line"><span class="comment"># record what you do</span></span><br><span class="line">$ <span class="built_in">exit</span></span><br><span class="line">$ scriptreplay --timing=time.txt script.log</span><br><span class="line"><span class="comment"># replay</span></span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[kcptun_and_shadowsocks]]></title>
      <url>http://yoursite.com/2016/09/04/kcptun-and-shadowsocks/</url>
      <content type="html"><![CDATA[<h3 id="Server-Parameters"><a href="#Server-Parameters" class="headerlink" title="Server Parameters"></a>Server Parameters</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su <span class="_">-s</span> /bin/bash nobody -c <span class="string">'./server_linux_amd64 -l "vps_ip:kcptun_port" -t "serer_ip:shadowsocks_port" -key yourkeyfile -mode fast2 --crypt aes-128 --datashard 10 --parityshard 3'</span></span><br></pre></td></tr></table></figure>
<h3 id="Client-Parameters"><a href="#Client-Parameters" class="headerlink" title="Client Parameters"></a>Client Parameters</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./client_linux_amd64 -r <span class="string">"vps_ip:kcptun_port"</span> <span class="_">-l</span> <span class="string">":kcptun_client_port"</span> -key yourkeyfile -mode fast2 --crypt aes-128 --datashard 10 --parityshard 3</span><br></pre></td></tr></table></figure>
<h3 id="Modify-shadowsocks-config"><a href="#Modify-shadowsocks-config" class="headerlink" title="Modify shadowsocks config"></a>Modify shadowsocks config</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">"server":"127.0.0.1",</span><br><span class="line">"server_port":kcptun_client_port,</span><br></pre></td></tr></table></figure>
<p>Browser proxy setting no changed (local port of shadowsocks client)</p>
<h3 id="Some-of-issues"><a href="#Some-of-issues" class="headerlink" title="Some of issues"></a>Some of issues</h3><p>There is no “localhost/127.0.0.1” in openvz envirnoment, you need replace it by ip address</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Advance reformat 4Kn HDD to 512 Bytes]]></title>
      <url>http://yoursite.com/2016/08/10/Advance-reformat-4Kn-HDD-to-512-Bytes/</url>
      <content type="html"><![CDATA[<h3 id="4Kn-HDD-to-512-Bytes-sectora"><a href="#4Kn-HDD-to-512-Bytes-sectora" class="headerlink" title="4Kn HDD to 512 Bytes sectora"></a>4Kn HDD to 512 Bytes sectora</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ smartctl <span class="_">-a</span> <span class="_">-d</span> scsi /dev/sdd</span><br><span class="line">smartctl 5.43 2012-06-30 r3573 [x86_64-linux-2.6.32-504.30.3.el6_lustre.x86_64] (<span class="built_in">local</span> build)</span><br><span class="line">Copyright (C) 2002-12 by Bruce Allen, http://smartmontools.sourceforge.net</span><br><span class="line"></span><br><span class="line">Vendor:               HGST    </span><br><span class="line">Product:              HUH728080AL4200 </span><br><span class="line">Revision:             A7J0</span><br><span class="line">User Capacity:        8,001,563,222,016 bytes [8.00 TB]</span><br><span class="line">Logical block size:   4096 bytes</span><br><span class="line"></span><br><span class="line">$ smartctl <span class="_">-a</span> <span class="_">-d</span> scsi /dev/sdc</span><br><span class="line">smartctl 5.43 2012-06-30 r3573 [x86_64-linux-2.6.32-504.30.3.el6_lustre.x86_64] (<span class="built_in">local</span> build)</span><br><span class="line">Copyright (C) 2002-12 by Bruce Allen, http://smartmontools.sourceforge.net</span><br><span class="line"></span><br><span class="line">Vendor:               HGST    </span><br><span class="line">Product:              HUH728080AL4200 </span><br><span class="line">Revision:             A7J0</span><br><span class="line">User Capacity:        8,001,563,222,016 bytes [8.00 TB]</span><br><span class="line">Logical block size:   512 bytes</span><br></pre></td></tr></table></figure>
<h4 id="sg3-utils-format"><a href="#sg3-utils-format" class="headerlink" title="sg3_utils format"></a>sg3_utils format</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ sg_format --format --size=512 /dev/sdc</span><br><span class="line">HGST      HUH728080AL4200   A7J0   peripheral_<span class="built_in">type</span>: disk [0x0]</span><br><span class="line">&lt;&lt; supports protection information&gt;&gt;</span><br><span class="line">Mode Sense (block descriptor) data, prior to changes:</span><br><span class="line">  Number of blocks=1953506646 [0x74702556]</span><br><span class="line">  Block size=4096 [0x1000]</span><br><span class="line"></span><br><span class="line">A FORMAT will commence <span class="keyword">in</span> 10 seconds</span><br><span class="line">    ALL data on /dev/sdc will be DESTROYED</span><br><span class="line">        Press control-C to abort</span><br><span class="line">A FORMAT will commence <span class="keyword">in</span> 5 seconds</span><br><span class="line">    ALL data on /dev/sdc will be DESTROYED</span><br><span class="line">        Press control-C to abort</span><br><span class="line"></span><br><span class="line">Format has started</span><br><span class="line">FORMAT Complete</span><br></pre></td></tr></table></figure>
<p>It ‘s not complete,  just backend operate<br>sdparm ,smartctl, /sys could not access the device, when format complete, it’s ok.</p>
<h4 id="Read-cap"><a href="#Read-cap" class="headerlink" title="Read cap"></a>Read cap</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ sg_readcap <span class="_">-l</span> /dev/sdc</span><br><span class="line">Read Capacity results:</span><br><span class="line">   Protection: prot_en=0, p_<span class="built_in">type</span>=0, p_i_exponent=0</span><br><span class="line">   Thin provisioning: tpe=0, tprz=0</span><br><span class="line">   Last logical block address=15628053167 (0x3a3812aaf), Number of logical blocks=15628053168</span><br><span class="line">   Logical block length=512 bytes</span><br><span class="line">   Logical blocks per physical block exponent=3</span><br><span class="line">   Lowest aligned logical block address=0</span><br><span class="line">Hence:</span><br><span class="line">   Device size: 8001563222016 bytes, 7630885.3 MiB, 8001.56 GB</span><br></pre></td></tr></table></figure>
<h4 id="Get-HDD-status"><a href="#Get-HDD-status" class="headerlink" title="Get HDD status"></a>Get HDD status</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sg_turs -v /dev/sdb</span><br><span class="line">   <span class="built_in">test</span> unit ready cdb: 00 00 00 00 00 00 </span><br><span class="line">   <span class="built_in">test</span> unit ready:  Descriptor format, current;  Sense key: Not Ready Additional sense: Logical unit not ready, format <span class="keyword">in</span> progress  </span><br><span class="line">   Descriptor <span class="built_in">type</span>: Information    00 00 00 00 00 00 00 00 00 00</span><br><span class="line">   Descriptor <span class="built_in">type</span>: Command specific    0x0000000000000000</span><br><span class="line">   device not ready</span><br></pre></td></tr></table></figure>
<p>After 18 hours, format finish , I ‘m not sure what time it complete.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat /sys/class/block/sdc/queue/hw_sector_size </span><br><span class="line">512</span><br><span class="line"></span><br><span class="line">$ cat /sys/class/block/sdd/queue/hw_sector_size </span><br><span class="line">4096</span><br></pre></td></tr></table></figure>
<h4 id="Security-erasing-SAS-SATA-SSD"><a href="#Security-erasing-SAS-SATA-SSD" class="headerlink" title="Security erasing SAS/SATA SSD"></a>Security erasing SAS/SATA SSD</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sg_format --format /dev/sdx</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdparm --user-master u --security-set-pass password /dev/sdx</span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Calculate HDD SSD fault ratio]]></title>
      <url>http://yoursite.com/2016/07/20/Calculate_HDD_SSD_fault_ratio/</url>
      <content type="html"><![CDATA[<h3 id="Nonrecoverable-Read-Errors-URE-per-Bits-Read"><a href="#Nonrecoverable-Read-Errors-URE-per-Bits-Read" class="headerlink" title="Nonrecoverable Read Errors(URE) per Bits Read"></a>Nonrecoverable Read Errors(URE) per Bits Read</h3><p>1 byte per 10E15 (Enterprise 7.2k HDD 10E15=1000000000000000)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1e12*8 bytes = 1 (TB)</span><br><span class="line">(1e15)/(1e12*8)=125 (TB)</span><br></pre></td></tr></table></figure></p>
<p>1 byte per 10E14 (Desktop 5.9k/7.2k HDD)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(1e14)/(1e12*8)=12.5 (TB)</span><br></pre></td></tr></table></figure></p>
<p>1 byte per 10E17 (Enterprise SSD)<br>1 byte per 10E16 (Desktop SSD/SAS 15k HDD)</p>
<h4 id="Calculate-failt-ratio-of-unrecoverable-read-error"><a href="#Calculate-failt-ratio-of-unrecoverable-read-error" class="headerlink" title="Calculate failt ratio of unrecoverable read error"></a><a href="https://www.high-rely.com/blog/why-raid-5-stops-working-in-2009-not/" target="_blank" rel="external">Calculate failt ratio of unrecoverable read error</a></h4><p>The probability equation they use for a successful read of all bits on a drive is<br>(1-1/b)^a<br>“b” = the Bit Error Rate (BER) also known as Unrecoverable Read Error(URE) rate<br>“a” = Number of Bits read (the amount of data on an entire volume or drive)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">6e12*8=6TB (raidz 5/6 rebuild is that raid of each HDD full scan 6TB data for XOR)</span><br><span class="line">I think each device has the same fault ratio,there is no any connection with raid disk number, it &apos;s just talk about &quot;Nonrecoverable Read Errors&quot;.</span><br><span class="line"></span><br><span class="line">rebuild device fault ratio cause by URE:</span><br><span class="line"></span><br><span class="line">6TB (if this byte has read 6TB)</span><br><span class="line">1-(1-1e-15)^(6e12*8)=0.046829644</span><br><span class="line"></span><br><span class="line">8TB </span><br><span class="line">0.06194</span><br><span class="line"></span><br><span class="line">10TB</span><br><span class="line">0.07682</span><br><span class="line"></span><br><span class="line">12TB</span><br><span class="line">0.09147</span><br><span class="line"></span><br><span class="line">20TB</span><br><span class="line">0.14775</span><br></pre></td></tr></table></figure>
<h4 id="rebuild-device-error-ratio-by-MTBF"><a href="#rebuild-device-error-ratio-by-MTBF" class="headerlink" title="rebuild device error ratio by MTBF"></a>rebuild device error ratio by MTBF</h4><p>Mean Time Between Failures (MTBF) (hours) = 1M<br>You could get running time from smartctl<br>I assumed the raid device had running 1,3,5 years<br>365<em>1</em>24/1000000=0.00876 in each HDD<br>365<em>3</em>24/1000000=0.02628 in each HDD<br>365<em>5</em>24/1000000=0.04380 in each HDD</p>
<h4 id="Production-environment-data-read-size"><a href="#Production-environment-data-read-size" class="headerlink" title="Production environment data read size"></a>Production environment data read size</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">smartctl <span class="_">-a</span> <span class="_">-d</span> scsi /dev/sdz</span><br><span class="line">number of hours powered up = 9919.17</span><br><span class="line">       Gigabytes</span><br><span class="line">       processed</span><br><span class="line">       [10^9 bytes]</span><br><span class="line"><span class="built_in">read</span>:  366268.989</span><br><span class="line"></span><br><span class="line">Read data:</span><br><span class="line">366274.390/9921.3*24*356*3/8/1000=118.285 (TB)</span><br><span class="line">Sort each byte <span class="built_in">read</span> capacity of HDD and get the maximum <span class="built_in">read</span> capacity of the byte ? I don <span class="string">'t know how to do.</span><br><span class="line">If the maximum byte of HDD has been read 23.657 TB (20% hot data)</span><br><span class="line"></span><br><span class="line">1-(1-1e-15)^(7.88568*8)=0.061089 (1y)</span><br><span class="line"></span><br><span class="line">1-(1-1e-15)^(23.657e12*8)=0.1723 (3y)</span><br><span class="line"></span><br><span class="line">1-(1-1e-15)^(39.4284*8)=0.270339 (5y)</span></span><br></pre></td></tr></table></figure>
<h5 id="Ratio-of-2-devices-damaged-simultaneously-some-case-could-be-cause-data-loss"><a href="#Ratio-of-2-devices-damaged-simultaneously-some-case-could-be-cause-data-loss" class="headerlink" title="Ratio of 2 devices damaged simultaneously (some case could be cause data loss)"></a>Ratio of 2 devices damaged simultaneously (some case could be cause data loss)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(0.00876+0.061089)^2=0.004879 (1 years, 20% hot)</span><br><span class="line">(0.02628+0.1723)^2=0.039434 (3 years, 20% hot)</span><br><span class="line">(0.04380+0.270339)^2=0.0986833 (5 years, 20% hot)</span><br><span class="line"></span><br><span class="line">Rebuild speed about 1TB/day</span><br><span class="line">6TB = 144 hours</span><br><span class="line">8TB = 192 hours</span><br><span class="line">10TB = 240 hours</span><br><span class="line">12TB = 288 hours</span><br></pre></td></tr></table></figure>
<h3 id="HDD-DWPD"><a href="#HDD-DWPD" class="headerlink" title="HDD DWPD"></a>HDD DWPD</h3><p>ST10000VN0004 10TB<br>Workload Rate Limit (WRL) (TB/year) = 180<br>Warranty, Limited (years) = 3<br>DWPD(5y)=540/365/5=0.29589</p>
<p><a href="http://superuser.com/questions/516949/formula-to-calculate-probability-of-unrecoverable-read-error-during-raid-rebuild" target="_blank" rel="external">Formula to calculate probability of unrecoverable read error during RAID rebuild</a><br><a href="http://queue.acm.org/detail.cfm?id=1670144" target="_blank" rel="external">Triple-Parity RAID and Beyond</a><br><a href="http://www.seagate.com/www-content/product-content/ironwolf/files/ironwolf-ds-1904-1-1606us.pdf" target="_blank" rel="external">seagate ironwolf spec</a><br><a href="http://math.stackexchange.com/questions/853643/how-to-convert-1e11-into-number" target="_blank" rel="external">how to convert 1e11 into number</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Install blasr in CentOS6]]></title>
      <url>http://yoursite.com/2016/07/05/Install-blasr-in-CentOS6/</url>
      <content type="html"><![CDATA[<h3 id="Install-GCC-5-2-0"><a href="#Install-GCC-5-2-0" class="headerlink" title="Install GCC 5.2.0"></a><a href="http://en.librehat.com/blog/build-gcc-5-dot-2-on-rhel-6/" target="_blank" rel="external">Install GCC 5.2.0</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">wget http://ftpmirror.gnu.org/gcc/gcc-5.2.0/gcc-5.2.0.tar.bz2</span><br><span class="line">tar xf gcc-5.2.0.tar.bz2</span><br><span class="line">wget https://gmplib.org/download/gmp/gmp-6.0.0a.tar.xz</span><br><span class="line">tar xf gmp-6.0.0a.tar.xz</span><br><span class="line">mv gmp-6.0.0 gcc-5.2.0/gmp </span><br><span class="line">wget ftp://ftp.gnu.org/gnu/mpc/mpc-1.0.3.tar.gz</span><br><span class="line">tar xf mpc-1.0.3.tar.gz</span><br><span class="line">mv mpc-1.0.3 gcc-5.2.0/mpc</span><br><span class="line">wget http://www.mpfr.org/mpfr-current/mpfr-3.1.4.tar.xz</span><br><span class="line">tar xf mpfr-3.1.3.tar.xz</span><br><span class="line">mv mpfr-3.1.3 gcc-5.2.0/mpfr</span><br><span class="line">mkdir gcc-5.2.0/gcc-build &amp;&amp; <span class="built_in">cd</span> gcc-5.2.0/gcc-build</span><br><span class="line">../configure --prefix=<span class="variable">$HOME</span>/gcc5 </span><br><span class="line">            --disable-multilib </span><br><span class="line">            --enable-languages=c,c++ </span><br><span class="line">            --enable-libstdcxx-threads </span><br><span class="line">            --enable-libstdcxx-time </span><br><span class="line">            --enable-shared </span><br><span class="line">            --enable-__cxa_atexit </span><br><span class="line">            --disable-libunwind-exceptions </span><br><span class="line">            --disable-libada </span><br><span class="line">            --host x86_64-redhat-linux-gnu </span><br><span class="line">            --build x86_64-redhat-linux-gnu </span><br><span class="line">            --with-default-libstdcxx-abi=gcc4-compatible</span><br><span class="line"></span><br><span class="line">make -j 40</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<h3 id="Check-C-11-support"><a href="#Check-C-11-support" class="headerlink" title="Check C++11 support"></a>Check C++11 support</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat test.cpp</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line"></span><br><span class="line">int main()&#123;</span><br><span class="line">        #if __cplusplus==201402L</span><br><span class="line">        std::cout &lt;&lt; &quot;C++14&quot; &lt;&lt; std::endl;</span><br><span class="line">        #elif __cplusplus==201103L</span><br><span class="line">        std::cout &lt;&lt; &quot;C++11&quot; &lt;&lt; std::endl;</span><br><span class="line">        #else</span><br><span class="line">        std::cout &lt;&lt; &quot;C++&quot; &lt;&lt; std::endl;</span><br><span class="line">        #endif</span><br><span class="line"></span><br><span class="line">        return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">g++ -std=c++11 test.cpp -o test</span><br></pre></td></tr></table></figure>
<p>./test<br>C++11</p>
<h3 id="Install-blasr"><a href="#Install-blasr" class="headerlink" title="Install blasr"></a>Install blasr</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">blasrpath=/xxxxxx/BLASR/blasr_el6</span><br><span class="line">HDF5=/xxxxxx/BLASR/hdf5-1.8.16-linux-centos6-x86_64-gcc447-shared</span><br><span class="line">LD_LIBRARY_PATH=<span class="variable">$blasrpath</span>/libcpp/alignment:<span class="variable">$blasrpath</span>/libcpp/hdf:<span class="variable">$blasrpath</span>/libcpp/pbdata:<span class="variable">$HDF5</span>/lib/:/xxxxxx/BLASR/blasr_el6/gcc/gcc5_el6/lib64:LD_LIBRARY</span><br><span class="line">PATH=/xxxxxx/BLASR/blasr_el6/gcc/gcc5_el6/bin:<span class="variable">$PATH</span></span><br><span class="line">./configure.py --shared --sub --no-pbbam HDF5_INCLUDE=<span class="variable">$HDF5</span>/include/ HDF5_LIB=<span class="variable">$HDF5</span>/lib</span><br><span class="line">make configure-submodule</span><br><span class="line">make build-submodule</span><br><span class="line">make blasr</span><br><span class="line">./blasr --version</span><br><span class="line">5.2</span><br><span class="line"></span><br><span class="line"><span class="comment">#benchamrk cpu</span></span><br><span class="line">time ./blasr /xxxxxx/BLASR/error_corrected_reads_7.fa /xxxxxx/BLASR/platypus.v2.fa.gapfilled.fa --sa /xxxxxx/BLASR/platypus.v2.fa.gapfilled.fa.blasr_sa --minMatch 11 --maxAnchorsPerPosition 500 --nproc $(cat /proc/cpuinfo | grep MHz -c) &gt; /dev/zero</span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Monitor ssd device]]></title>
      <url>http://yoursite.com/2016/07/04/Monitor-ssd-device/</url>
      <content type="html"><![CDATA[<h3 id="Monitor-Intel-SATA-SSD"><a href="#Monitor-Intel-SATA-SSD" class="headerlink" title="Monitor Intel SATA SSD"></a>Monitor Intel SATA SSD</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">smartctl <span class="_">-a</span> /dev/sdaa</span><br><span class="line">233 Media_Wearout_Indicator 0x0032   097   097   000    Old_age   Always       -       0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">241 Host_Writes_32MiB       0x0032   100   100   000    Old_age   Always       -       24439</span><br><span class="line">242 Host_Reads_32MiB        0x0032   100   100   000    Old_age   Always       -       4275</span><br><span class="line">243 NAND_Writes_32MiB       0x0032   100   100   000    Old_age   Always       -       40857</span><br><span class="line"></span><br><span class="line">dd <span class="keyword">if</span>=/dev/zero of=<span class="built_in">test</span> bs=1M count=1024</span><br><span class="line"></span><br><span class="line">241 Host_Writes_32MiB       0x0032   100   100   000    Old_age   Always       -       24471</span><br><span class="line">242 Host_Reads_32MiB        0x0032   100   100   000    Old_age   Always       -       4275</span><br><span class="line">243 NAND_Writes_32MiB       0x0032   100   100   000    Old_age   Always       -       40857</span><br></pre></td></tr></table></figure>
<p>You can see write 32*32=1024M write to ssd. the value is “MB”.</p>
<h3 id="Samsung-SATA-SSD"><a href="#Samsung-SATA-SSD" class="headerlink" title="Samsung SATA SSD"></a><a href="https://www.smartmontools.org/ticket/661" target="_blank" rel="external">Samsung SATA SSD</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">251 NAND_Writes             -O--CK   100   100   000    -    7546253904</span><br><span class="line">                            ||||||_ K auto-keep</span><br><span class="line">                            |||||__ C event count</span><br><span class="line">                            ||||___ R error rate</span><br><span class="line">                            |||____ S speed/performance</span><br><span class="line">                            ||_____ O updated online</span><br><span class="line">                            |______ P prefailure warning</span><br></pre></td></tr></table></figure>
<h3 id="NVME-Intel-SSD"><a href="#NVME-Intel-SSD" class="headerlink" title="NVME Intel SSD"></a>NVME Intel SSD</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">isdct  show -smart -intelssd 0</span><br><span class="line">Description : NAND Bytes Written</span><br><span class="line">ID : F4</span><br><span class="line">Normalized : 100</span><br><span class="line">Raw : 6142760</span><br><span class="line"></span><br><span class="line">- F5 -</span><br><span class="line"></span><br><span class="line">Description : Host Bytes Written</span><br><span class="line">ID : F5</span><br><span class="line">Normalized : 100</span><br><span class="line">Raw : 2790072</span><br><span class="line"></span><br><span class="line">dd <span class="keyword">if</span>=/dev/zero of=<span class="built_in">test</span> bs=1M count=1024</span><br><span class="line"></span><br><span class="line">Description : NAND Bytes Written</span><br><span class="line">ID : F4</span><br><span class="line">Normalized : 100</span><br><span class="line">Raw : 6142930</span><br><span class="line"></span><br><span class="line">- F5 -</span><br><span class="line"></span><br><span class="line">Description : Host Bytes Written</span><br><span class="line">ID : F5</span><br><span class="line">Normalized : 100</span><br><span class="line">Raw : 2790104</span><br></pre></td></tr></table></figure>
<p>Raw value of Host Bytes Written improved 32</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Main board SATA port bottle neck]]></title>
      <url>http://yoursite.com/2016/06/16/Main-board-SATA-bottle-neck/</url>
      <content type="html"><![CDATA[<p><img src="/img/Dt9p6.jpg" alt=""><br>DMI 2.0 2 GB/s<br>DMI 3.0 3.93 GB/s<br>SATA SSD 500MB/s x 4/8 = 2000/4000MB/s<br><a href="http://electronics.stackexchange.com/questions/219440/why-do-cpus-typically-connect-to-only-one-bus/219446" target="_blank" rel="external">reference</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Benchmark ConnectX®-3 Pro VMA]]></title>
      <url>http://yoursite.com/2016/06/03/Benchmark_ConnectX%C2%AE_3_Pro/</url>
      <content type="html"><![CDATA[<h3 id="RDMA-support"><a href="#RDMA-support" class="headerlink" title="RDMA support"></a>RDMA support</h3><p>RDMA allows for communication between systems but can bypass the overhead associated with the operating system kernel, so applications have reduced latency and much lower CPU utilization.</p>
<p><a href="https://github.com/Mellanox/libvma" target="_blank" rel="external">libvma</a><br>Linux user space library for network socket acceleration based on RDMA compatible network adaptors</p>
<p>socket ip layer ?</p>
<h3 id="Update-driver"><a href="#Update-driver" class="headerlink" title="Update driver"></a>Update driver</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apt install module-init-tools dkms</span><br><span class="line">modprobe -r mlx4_en</span><br><span class="line">modprobe -r mlx4_core</span><br><span class="line">modprobe mlx4_en mlx4_core</span><br><span class="line">modinfo mlx4_core</span><br><span class="line">filename:       /lib/modules/4.4.0-22-generic/updates/dkms/mlx4_core.ko</span><br><span class="line">version:        3.3-1.0.0</span><br><span class="line">license:        Dual BSD/GPL</span><br><span class="line">description:    Mellanox ConnectX HCA low-level driver</span><br><span class="line">author:         Roland Dreier</span><br><span class="line">srcversion:     E63C21909524B057DF41E97</span><br></pre></td></tr></table></figure>
<h3 id="NIC-info"><a href="#NIC-info" class="headerlink" title="NIC info"></a>NIC info</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ethtool -i enp5s0</span><br><span class="line">driver: mlx4_en</span><br><span class="line">version: 3.3-1.0.0 (31 May 2016)</span><br><span class="line">firmware-version: 2.36.5000</span><br><span class="line">expansion-rom-version: </span><br><span class="line">bus-info: 0000:05:00.0</span><br><span class="line">supports-statistics: yes</span><br><span class="line">supports-test: yes</span><br><span class="line">supports-eeprom-access: no</span><br><span class="line">supports-register-dump: no</span><br><span class="line">supports-priv-flags: yes</span><br></pre></td></tr></table></figure>
<h3 id="NIC-offload"><a href="#NIC-offload" class="headerlink" title="NIC offload"></a>NIC offload</h3><table>
<thead>
<tr>
<th>Features</th>
</tr>
</thead>
<tbody>
<tr>
<td>TSO (TCP Segmentation Offload)</td>
<td>on</td>
</tr>
<tr>
<td>GSO (Generic Segmentation Offload)</td>
<td>on</td>
</tr>
<tr>
<td>GRO (Generic Receive Offload)</td>
<td>on</td>
</tr>
<tr>
<td>rx-checksumming</td>
<td>on</td>
</tr>
<tr>
<td>tx-checksumming</td>
<td>on</td>
</tr>
<tr>
<td>scatter-gather</td>
<td>on</td>
</tr>
</tbody>
</table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool --offload enp5s0 rx on tx on</span><br><span class="line">Actual changes:</span><br><span class="line">rx-checksumming: on</span><br><span class="line">tx-checksumming: on</span><br><span class="line">	tx-checksum-ipv4: on</span><br><span class="line">	tx-checksum-ipv6: on</span><br><span class="line">tcp-segmentation-offload: on</span><br><span class="line">	tx-tcp-segmentation: on</span><br><span class="line">	tx-tcp6-segmentation: on</span><br><span class="line"></span><br><span class="line">$ ethtool -k enp4s0d1 | grep -v fixed</span><br><span class="line">Features <span class="keyword">for</span> enp4s0d1:</span><br><span class="line">rx-checksumming: on</span><br><span class="line">tx-checksumming: on</span><br><span class="line">	tx-checksum-ipv4: on</span><br><span class="line">	tx-checksum-ipv6: on</span><br><span class="line">scatter-gather: on</span><br><span class="line">	tx-scatter-gather: on</span><br><span class="line">tcp-segmentation-offload: on</span><br><span class="line">	tx-tcp-segmentation: on</span><br><span class="line">	tx-tcp6-segmentation: on</span><br><span class="line">generic-segmentation-offload: on</span><br><span class="line">generic-receive-offload: on</span><br><span class="line">rx-vlan-offload: on</span><br><span class="line">tx-vlan-offload: on</span><br><span class="line">ntuple-filters: on</span><br><span class="line">receive-hashing: on</span><br><span class="line">tx-nocache-copy: off</span><br><span class="line">loopback: off</span><br><span class="line">rx-fcs: off</span><br><span class="line">tx-vlan-stag-hw-insert: off</span><br><span class="line">rx-vlan-stag-hw-parse: on</span><br><span class="line"></span><br><span class="line"><span class="comment">#enable TSO</span></span><br><span class="line">$ ethtool -K enp4s0 tso on</span><br><span class="line">$ ethtool -K enp4s0 gso off</span><br></pre></td></tr></table></figure>
<p>Transmit:</p>
<ul>
<li>TSO</li>
<li>GSO  (software ?)</li>
</ul>
<p>Receive:</p>
<ul>
<li>GRO</li>
</ul>
<p>Interrupt mitigation or interrupt coalescing</p>
<p>rx-frames[-irq] rx-usecs[-irq] tx-frames[-irq] tx-usecs[-irq]</p>
<p><a href="http://serverfault.com/questions/278756/interpreting-ethtool-coalesce-output" target="_blank" rel="external">The frames parameters specify how many packets are received/transmitted before generating an interrupt. The usecs parameters specify how many microseconds after at least 1 packet is received/transmitted before generating an interrupt. The [-irq] parameters are the corresponding delays in updating the status when the interrupt is disabled.</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -c enp4s0d1</span><br><span class="line">Coalesce parameters <span class="keyword">for</span> enp4s0d1:</span><br><span class="line">Adaptive RX: off  TX: off</span><br><span class="line">stats-block-usecs: 0</span><br><span class="line">sample-interval: 0</span><br><span class="line">pkt-rate-low: 400000</span><br><span class="line">pkt-rate-high: 450000</span><br><span class="line"></span><br><span class="line">rx-usecs: 0</span><br><span class="line">rx-frames: 0</span><br><span class="line">rx-usecs-irq: 0</span><br><span class="line">rx-frames-irq: 0</span><br><span class="line"></span><br><span class="line">tx-usecs: 8</span><br><span class="line">tx-frames: 16</span><br><span class="line">tx-usecs-irq: 0</span><br><span class="line">tx-frames-irq: 256</span><br><span class="line"></span><br><span class="line">rx-usecs-low: 0</span><br><span class="line">rx-frame-low: 0</span><br><span class="line">tx-usecs-low: 0</span><br><span class="line">tx-frame-low: 0</span><br><span class="line"></span><br><span class="line">rx-usecs-high: 128</span><br><span class="line">rx-frame-high: 0</span><br><span class="line">tx-usecs-high: 0</span><br><span class="line">tx-frame-high: 0</span><br><span class="line"></span><br><span class="line"><span class="comment">#reduce lantency,improve cpu usage</span></span><br><span class="line">$ ethtool -C enp5s0 adaptive-rx off rx-usecs 0 rx-frames 0</span><br><span class="line">$ ethtool -C enp5s0d1 adaptive-rx off rx-usecs 0 rx-frames 0</span><br></pre></td></tr></table></figure>
<p>if you need to improve value of rx-usecs, improve latency and througput, and suggestion improve<br>net.ipv4.tcp_tso_win_divisor = 30 (default 3) too.</p>
<p><a href="http://digital.ni.com/public.nsf/allkb/65B0708FE161D8C0852563DA00620887" target="_blank" rel="external">What is Scatter-Gather DMA</a><br><a href="https://lwn.net/Articles/358910/" target="_blank" rel="external">Replace LRO with GRO</a><br><a href="https://en.wikipedia.org/wiki/Direct_memory_access" target="_blank" rel="external">Scatter-gather or vectored I/O DMA allows the transfer of data to and from multiple memory areas in a single DMA transaction. It is equivalent to the chaining together of multiple simple DMA requests. The motivation is to off-load multiple input/output interrupt and data copy tasks from the CPU</a></p>
<h5 id="About-GSO"><a href="#About-GSO" class="headerlink" title="About GSO"></a>About GSO</h5><p><a href="https://lwn.net/Articles/188489/" target="_blank" rel="external">Many people have observed that a lot of the savings in TSO come from traversing the networking stack once rather than many times for each super-packet.  These savings can be obtained without hardware support.</a><br>[GSO like TSO is only effective if the MTU is significantly less than the<br>maximum value of 64K.  So only the case where the MTU was set to 1500 is<br>of interest.</p>
<p>TSO 是使得网络协议栈能够将大块 buffer 推送至网卡，然后网卡执行分片工作，这样减轻了 CPU 的负荷，但 TSO 需要硬件来实现分片功能；而性能上的提高，主要是因为延缓分片而减轻了 CPU 的负载，因此，可以考虑将 TSO 技术一般化，因为其本质实际是延缓分片，这种技术，在 Linux 中被叫做 GSO(Generic Segmentation Offload)，它比 TSO 更通用，原因在于它不需要硬件的支持分片就可使用，对于支持 TSO 功能的硬件，则先经过 GSO 功能，然后使用网卡的硬件分片能力执行分片；而对于不支持 TSO 功能的网卡，将分片的执行，放在了将数据推送的网卡的前一刻，也就是在调用驱动的 xmit 函数前。(<a href="https://www.ibm.com/developerworks/cn/linux/l-cn-network-pt/#icomments" target="_blank" rel="external">https://www.ibm.com/developerworks/cn/linux/l-cn-network-pt/#icomments</a>)</p>
<p>if mtu 1500, kernel will split large data to 1448 bytes per packages , after enable gso (hardware), There are some 2896 bytes packages in tcpdump, and split operation in nic device.</p>
<p><a href="https://en.wikipedia.org/wiki/Goodput" target="_blank" rel="external">20 bytes of IPv4 header information and 20 bytes of TCP header information,Linux and Mac OS are further limited to 1448 bytes as they also carry a 12-byte time stamp</a><br>1500-20-20-12=1448</p>
<p><img src="http://sandilands.info/sgordon/images/wireshark-capture-1.png" alt=""><br><img src="http://sandilands.info/sgordon/images/wireshark-capture-2.png" alt=""><br><a href="http://sandilands.info/sgordon/segmentation-offloading-with-wireshark-and-ethtool" target="_blank" rel="external">Segmentation and Checksum Offloading: Turning Off with ethtool</a></p>
<h4 id="DMA-Ring-Buffer-Sizes-and-statistics"><a href="#DMA-Ring-Buffer-Sizes-and-statistics" class="headerlink" title="DMA Ring Buffer Sizes and statistics"></a>DMA Ring Buffer Sizes and statistics</h4><p>The pre-set maximum is 8192 packets. The default is 256 packets. For purposes of LAN testing, using the smallest possible ring size provides the best results<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">ethtool -S enp5s0</span><br><span class="line"></span><br><span class="line"><span class="comment"># ethtool -S eth0 | grep rx_no_buffer_count</span></span><br><span class="line">     rx_no_buffer_count: 100590</span><br><span class="line"><span class="comment"># ethtool -S eth0 | grep rx_missed_errors  </span></span><br><span class="line">     rx_missed_errors: 9188</span><br><span class="line"></span><br><span class="line">reduce buffer,<span class="keyword">in</span> this old machine, 4096 is maxinum</span><br><span class="line"></span><br><span class="line"><span class="comment">#1GbE</span></span><br><span class="line">$ ethtool -G eth0 rx 2048 tx 2048</span><br><span class="line"></span><br><span class="line">$ ethtool -g eth0</span><br><span class="line">Ring parameters <span class="keyword">for</span> eth0:</span><br><span class="line">Pre-set maximums:</span><br><span class="line">RX:		4096</span><br><span class="line">RX Mini:	0</span><br><span class="line">RX Jumbo:	0</span><br><span class="line">TX:		4096</span><br><span class="line">Current hardware settings:</span><br><span class="line">RX:		2048</span><br><span class="line">RX Mini:	0</span><br><span class="line">RX Jumbo:	0</span><br><span class="line">TX:		2048</span><br><span class="line"></span><br><span class="line"><span class="comment">#10GbE</span></span><br><span class="line">$ ethtool -g enp4s0</span><br><span class="line">Ring parameters <span class="keyword">for</span> enp4s0:</span><br><span class="line">Pre-set maximums:</span><br><span class="line">RX:		8192</span><br><span class="line">RX Mini:	0</span><br><span class="line">RX Jumbo:	0</span><br><span class="line">TX:		8192</span><br><span class="line">Current hardware settings:</span><br><span class="line">RX:		1024</span><br><span class="line">RX Mini:	0</span><br><span class="line">RX Jumbo:	0</span><br><span class="line">TX:		512</span><br></pre></td></tr></table></figure></p>
<h4 id="Enable-RSS-RFS"><a href="#Enable-RSS-RFS" class="headerlink" title="Enable RSS/RFS"></a>Enable RSS/RFS</h4><p>RSS Contemporary NICs support multiple receive and transmit descriptor queues (multi-queue). you can show it from /etc/interrupt</p>
<p><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Performance_Tuning_Guide/network-rfs.html" target="_blank" rel="external">Receive Flow Steering (RFS) extends RPS behavior to increase the CPU cache hit rate and thereby reduce network latency</a><br><a href="http://www.mellanox.com/related-docs/prod_software/Mellanox_OFED_Linux_User_Manual_v2.2-1.0.1.pdf" target="_blank" rel="external">Enabling the RFS requires enabling the ‘ntuple’ flag via the ethtool,RFS requires the kernel to be compiled with the CONFIG_RFS_ACCEL option. This options is available in kernels 2.6.39 and above. Furthermore, RFS requires Device Managed Flow Steering support.</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ethtool -K enp5s0 ntuple on</span><br><span class="line">ethtool -K enp5s0d1 ntuple on</span><br></pre></td></tr></table></figure>
<h4 id="RSS-RFS-XPS"><a href="#RSS-RFS-XPS" class="headerlink" title="RSS RFS XPS"></a>RSS RFS XPS</h4><p><a href="http://www.mellanox.com/related-docs/prod_software/Mellanox_OFED_Linux_Release_Notes_3_1-1_0_3.pdf" target="_blank" rel="external">Added Transmit Packet Steering (XPS) support</a><br><a href="http://www.mellanox.com/related-docs/prod_software/Mellanox_OFED_Linux_Release_Notes_3_1-1_0_3.pdf" target="_blank" rel="external">RFS does not support UDP</a><br><a href="http://www.mellanox.com/related-docs/prod_software/Mellanox_OFED_Linux_Release_Notes_3_1-1_0_3.pdf" target="_blank" rel="external">RSS support of fragmented IP datagram</a><br><a href="http://www.mellanox.com/related-docs/prod_software/Mellanox_OFED_Linux_User_Manual_v2.2-1.0.1.pdf" target="_blank" rel="external">XOR RSS Hash Function</a></p>
<h4 id="Enable-Receive-Packet-Steering"><a href="#Enable-Receive-Packet-Steering" class="headerlink" title="Enable Receive Packet Steering"></a>Enable Receive Packet Steering</h4><p>Maybe mellanox not support hardware acceleration<br>Receive Packet Steering (RPS) is logically a software implementation of RSS</p>
<p>RPS has some advantages over RSS: </p>
<ul>
<li>it can be used with any NIC,</li>
<li>software filters can easily be added to hash over new protocols,</li>
<li>it does not increase hardware device interrupt rate (although it doesintroduce inter-processor interrupts (IPIs)).<br><a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt" target="_blank" rel="external">kernel networking scaling</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span> <span class="string">'%x\n'</span> <span class="string">"<span class="variable">$((2#10101)</span>)"</span> <span class="comment"># core 0,2,4</span></span><br><span class="line">15</span><br><span class="line"><span class="built_in">printf</span> <span class="string">'%x\n'</span> <span class="string">"<span class="variable">$((2#10101000000)</span>)"</span> core 6,8,10</span><br><span class="line">540</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(ls /sys/class/net/enp5s0/queues/ | grep rx-);</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> 15 &gt; /sys/class/net/enp5s0/queues/<span class="variable">$i</span>/rps_cpus;</span><br><span class="line">        cat /sys/class/net/enp5s0/queues/<span class="variable">$i</span>/rps_cpus;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(ls /sys/class/net/enp5s0d1/queues/ | grep rx-);</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> 540 &gt; /sys/class/net/enp5s0/queues/<span class="variable">$i</span>/rps_cpus;</span><br><span class="line">        cat /sys/class/net/enp5s0/queues/<span class="variable">$i</span>/rps_cpus;</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h4 id="Enable-autonegotiation"><a href="#Enable-autonegotiation" class="headerlink" title="Enable autonegotiation"></a>Enable autonegotiation</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ethtool -A enp5s0 autoneg on <span class="comment">#could not work for mellanox</span></span><br><span class="line">Cannot <span class="built_in">set</span> device pause parameters: Invalid argument</span><br><span class="line"></span><br><span class="line">ethtool -A enp5s0 rx on</span><br><span class="line">ethtool -A enp5s0 tx on</span><br><span class="line"></span><br><span class="line">ethtool <span class="_">-a</span>  <span class="variable">$nic0</span></span><br><span class="line">Pause parameters <span class="keyword">for</span> enp5s0:</span><br><span class="line">Autonegotiate:  off</span><br><span class="line">RX:             on</span><br><span class="line">TX:             on</span><br></pre></td></tr></table></figure>
<h3 id="CPU-info"><a href="#CPU-info" class="headerlink" title="CPU info"></a>CPU info</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-16:/sys/class/net/enp5s0/device<span class="comment"># cat /sys/class/net/enp5s0/device/numa_node </span></span><br><span class="line">0</span><br><span class="line">root@ubuntu-16:/sys/class/net/enp5s0d1/device<span class="comment"># cat /sys/class/net/enp5s0d1/device/numa_node </span></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">cat /sys/class/net/enp5s0/device/<span class="built_in">local</span>_cpus</span><br><span class="line">0000,00000000,00000000,00000000,00000555</span><br><span class="line"></span><br><span class="line"><span class="comment">#same with</span></span><br><span class="line"><span class="built_in">printf</span> <span class="string">'%x\n'</span> <span class="string">"<span class="variable">$((2#10101010101)</span>)"</span></span><br><span class="line">555</span><br><span class="line"></span><br><span class="line"><span class="comment"># CPU Tubro mode</span></span><br><span class="line">```bash</span><br><span class="line">cat /sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_max_freq</span><br><span class="line">3200000</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disable cstate in grub.conf</span></span><br><span class="line">intel_idle.max_cstate=0 processor.max_cstate=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># disable irqbalance</span></span><br><span class="line">/etc/init.d/irqbalance stop</span><br><span class="line">[ ok ] Stopping irqbalance (via systemctl): irqbalance.service.</span><br><span class="line"></span><br><span class="line"><span class="comment"># install numactl collectl irqstat</span></span><br><span class="line">apt install numactl collectl</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/lanceshelton/irqstat</span><br><span class="line"></span><br><span class="line"><span class="comment">#lscpu</span></span><br><span class="line">Architecture:          x86_64</span><br><span class="line">CPU op-mode(s):        32-bit, 64-bit</span><br><span class="line">Byte Order:            Little Endian</span><br><span class="line">CPU(s):                12</span><br><span class="line">On-line CPU(s) list:   0-11</span><br><span class="line">Thread(s) per core:    1</span><br><span class="line">Core(s) per socket:    6</span><br><span class="line">Socket(s):             2</span><br><span class="line">NUMA node(s):          2</span><br><span class="line">Vendor ID:             GenuineIntel</span><br><span class="line">CPU family:            6</span><br><span class="line">Model:                 63</span><br><span class="line">Model name:            Intel(R) Xeon(R) CPU E5-2620 v3 @ 2.40GHz</span><br><span class="line">Stepping:              2</span><br><span class="line">CPU MHz:               1200.187</span><br><span class="line">CPU max MHz:           3200.0000</span><br><span class="line">CPU min MHz:           1200.0000</span><br><span class="line">BogoMIPS:              4795.72</span><br><span class="line">Virtualization:        VT-x</span><br><span class="line">L1d cache:             32K</span><br><span class="line">L1i cache:             32K</span><br><span class="line">L2 cache:              256K</span><br><span class="line">L3 cache:              15360K</span><br><span class="line">NUMA node0 CPU(s):     0,2,4,6,8,10</span><br><span class="line">NUMA node1 CPU(s):     1,3,5,7,9,11</span><br></pre></td></tr></table></figure>
<p>That means you ‘d better use cpus in numa node0, I guess, if numa node1 read/write data to the PCIE device, the data has to pass through QPI(Intel QuickPath Interconnect)<br>In my benchmark ,numactl will bind all applications on numa node0.</p>
<h3 id="OPS"><a href="#OPS" class="headerlink" title="OPS"></a>OPS</h3><ul>
<li>Disabled hyper thread    </li>
<li>Enable turbo mode</li>
<li>Enable numa, preferred each node</li>
<li>Disabled irqbalance</li>
</ul>
<h4 id="CPU-Affinity"><a href="#CPU-Affinity" class="headerlink" title="CPU Affinity"></a>CPU Affinity</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span> <span class="string">'%x\n'</span> <span class="string">"<span class="variable">$((2#10101010101)</span>)"</span></span><br><span class="line">555 <span class="comment">#numa_node0</span></span><br><span class="line"></span><br><span class="line">awk -F: <span class="string">'$0~/enp5/ || $0~/mlx4/ &#123;print $1&#125;'</span> /proc/interrupts | <span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">        <span class="built_in">echo</span> 555 &gt; /proc/irq/<span class="variable">$line</span>/smp_affinity </span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h4 id="sysctl-conf-for-ipv4"><a href="#sysctl-conf-for-ipv4" class="headerlink" title="sysctl.conf for ipv4"></a>sysctl.conf for ipv4</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_sack = 0 <span class="comment">#Disable the TCP timestamps option for better CPU utilization</span></span><br><span class="line">net.core.netdev_budget = 300 </span><br><span class="line">net.ipv4.tcp_timestamps=0 <span class="comment">#Disable the TCP timestamps option for better CPU utilization</span></span><br><span class="line">net.core.netdev_max_backlog=250000 <span class="comment">#Increase the maximum length of processor input queues</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Increase the TCP maximum and default buffer sizes </span></span><br><span class="line">net.core.rmem_max=4194304</span><br><span class="line">net.core.wmem_max=4194304</span><br><span class="line">net.core.rmem_default=4194304</span><br><span class="line">net.core.wmem_default=4194304</span><br><span class="line">net.core.optmem_max=4194304</span><br><span class="line"></span><br><span class="line"><span class="comment">#Increase memory thresholds to prevent packet dropping</span></span><br><span class="line">net.ipv4.tcp_rmem=<span class="string">"4096 87380 4194304"</span></span><br><span class="line">net.ipv4.tcp_wmem=<span class="string">"4096 65536 4194304"</span></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_low_latency=1 <span class="comment">#Enable low latency mode for TCP</span></span><br><span class="line">net.ipv4.tcp_adv_win_scale=1  <span class="comment">#A value of 1 means the socket buffer will be divided evenly between TCP windows size and application.</span></span><br></pre></td></tr></table></figure>
<h4 id="txqueueleng"><a href="#txqueueleng" class="headerlink" title="txqueueleng"></a>txqueueleng</h4><p><a href="https://www.nas.nasa.gov/assets/pdf/papers/NAS_Technical_Report_NAS-2014-01.pdf" target="_blank" rel="external">This queue parameter is mostly applicable for high-speed WAN transfers. For low-latency networks, the default setting of 1000 is sufficient. The receiving end is configured with the sysctl setting net.core.netdev_max_backlog. The default for this setting is also 1000 and does not need to be modified unless there is significant latency.</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ip link <span class="built_in">set</span> dev enp5s0 txqueuelen 1000</span><br><span class="line">ip link <span class="built_in">set</span> dev enp5s0d1 txqueuelen 1000</span><br><span class="line">ip link <span class="built_in">set</span> dev bond0 txqueuelen 2000</span><br></pre></td></tr></table></figure></p>
<h4 id="Enable-jumbo-frames"><a href="#Enable-jumbo-frames" class="headerlink" title="Enable jumbo frames"></a><a href="http://ehealth-aussie.blogspot.com/2011/11/in-depth-look-into-path-mtu-discovery.html" target="_blank" rel="external">Enable jumbo frames</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_mtu_probing = 1</span><br><span class="line">net.ipv4.tcp_base_mss = 512</span><br><span class="line">net.ipv4.ip_no_pmtu_disc = 0</span><br></pre></td></tr></table></figure>
<p><img src="https://dl.dropboxusercontent.com/u/4919408/tec/blog/net/net_kernel/tcp_packet_reception.png" alt=""><br><img src="https://dl.dropboxusercontent.com/u/4919408/tec/blog/net/net_kernel/tcp_packet_transmission.png" alt=""></p>
<h3 id="Configure-libvma"><a href="#Configure-libvma" class="headerlink" title="Configure libvma"></a>Configure libvma</h3><p><a href="https://github.com/Mellanox/libvma/wiki/Build-Instruction" target="_blank" rel="external">Install libvma in linux</a><br><a href="https://github.com/Mellanox/libvma/blob/master/src/vma/util/libvma.conf#L22" target="_blank" rel="external">libvma.conf</a><br><a href="https://community.mellanox.com/docs/DOC-2431" target="_blank" rel="external">Using ConnectX-3 Pro with VMA over Ubuntu 16.04 Inbox Driver</a><br><a href="http://www.mellanox.com/page/products_dyn?product_family=26" target="_blank" rel="external">Mellanox OpenFabrics Enterprise Distribution for Linux MLNX_OFED</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> apt-get install dkms infiniband-diags libibverbs* ibacm librdmacm* libmlx4* libmlx5* mstflint libibcm.* libibmad.* libibumad* opensm srptools libmlx4-dev librdmacm-dev rdmacm-utils ibverbs-utils perftest vlan ibutils</span><br><span class="line"> apt-get install libnl-3-200 libnl-route-3-200 libnl-route-3-dev libnl-utils</span><br><span class="line"> git <span class="built_in">clone</span> https://github.com/Mellanox/libvma.git $ <span class="built_in">cd</span> libvma </span><br><span class="line"> ./autogen.sh</span><br><span class="line"> ./configure --prefix=/usr</span><br><span class="line"> make -j 12</span><br><span class="line"> make install</span><br><span class="line"> ldconfig</span><br><span class="line"> <span class="built_in">echo</span> options mlx4_core <span class="built_in">log</span>_num_mgm_entry_size=-1 &gt; /etc/modprobe.d/mlnx.conf</span><br><span class="line"> <span class="built_in">echo</span> 1000000000 &gt; /proc/sys/kernel/shmmax</span><br><span class="line"> <span class="built_in">echo</span> 800 &gt; /proc/sys/vm/nr_hugepage</span><br><span class="line"> <span class="built_in">ulimit</span> <span class="_">-l</span> unlimited</span><br><span class="line"> LD_PRELOAD=libvma.so &lt;<span class="built_in">test</span>_app&gt;</span><br><span class="line"></span><br><span class="line">$ cat /etc/modprobe.d/mlx4.conf </span><br><span class="line"><span class="comment"># mlx4_core gets automatically loaded, load mlx4_en also (LP: #1115710)</span></span><br><span class="line">softdep mlx4_core post: mlx4_en</span><br><span class="line"><span class="comment">#options mlx4_en inline_thold=0</span></span><br><span class="line">options mlx4_core port_<span class="built_in">type</span>_array=2,2 num_vfs=2 probe_vf=0 <span class="built_in">enable</span>_64b_cqe_eqe=0  <span class="built_in">log</span>_num_mgm_entry_size=-1</span><br></pre></td></tr></table></figure></p>
<h3 id="Benchmark"><a href="#Benchmark" class="headerlink" title="Benchmark"></a>Benchmark</h3><h4 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h4><p><img src="/img/mellanox_network.jpg" alt="Network_Arch"><br>CPU is not bottle neck, 2620 was enough for quad/dual 10GbE</p>
<h4 id="sockperf"><a href="#sockperf" class="headerlink" title="sockperf"></a>sockperf</h4><p>sockperf: == version #2.7-53.git6f0f32c1fb02 ==<br>MTU 1500<br>single core server/client, single port</p>
<p>./sockperf server –tcp -p 11111<br>./sockperf server -p 11111 #udp<br>numactl -C 2 /opt/sockperf/bin/sockperf tp -m 256  -i 192.168.12.201 -p 11111 -t 20<br>numactl -C 2 /opt/sockperf/bin/sockperf pp -m 256  -i 192.168.12.201 -p 11111 -t 20</p>
<p>Throughput (MBps)</p>
<table>
<thead>
<tr>
<th>msg size bytes</th>
<th>TCP TP MBps</th>
<th>TCP TP VMA</th>
<th>UDP TP</th>
<th>UDP TP VMA</th>
</tr>
</thead>
<tbody>
<tr>
<td>256</td>
<td>289.160</td>
<td>695.808</td>
<td>78.632</td>
<td>766.952</td>
</tr>
<tr>
<td>512</td>
<td>420.863</td>
<td>1125.157</td>
<td>154.019</td>
<td>1055.240</td>
</tr>
<tr>
<td>1024</td>
<td>1129.297</td>
<td>1130.277</td>
<td>301.421</td>
<td>1119.500</td>
</tr>
<tr>
<td>2048</td>
<td>1131.170</td>
<td>1130.346</td>
<td>381.049</td>
<td>1123.660</td>
</tr>
<tr>
<td>4096</td>
<td>1131.160</td>
<td>1130.387</td>
<td>564.496</td>
<td>1141.008</td>
</tr>
</tbody>
</table>
<p>Package num (msg/s)<br>msg/s=(send+rec msg) per second</p>
<table>
<thead>
<tr>
<th>msg size bytes</th>
<th>TCP PP</th>
<th>TCP PP VMA</th>
<th>TCP PP 3x</th>
<th>TCP PP 3x VMA</th>
<th>Intel X540</th>
<th>ConnectX-3</th>
<th>ConnectX-3 VMA</th>
</tr>
</thead>
<tbody>
<tr>
<td>256</td>
<td>61813</td>
<td>261712</td>
<td>181845</td>
<td>702355</td>
<td>53663</td>
<td>63698</td>
<td>258556</td>
</tr>
<tr>
<td>512</td>
<td>65832</td>
<td>225369</td>
<td>154585</td>
<td>615563</td>
<td>53414</td>
<td>52425</td>
<td>223479</td>
</tr>
<tr>
<td>1024</td>
<td>51411</td>
<td>182045</td>
<td>158244</td>
<td>503944</td>
<td>53067</td>
<td>56812</td>
<td>179406</td>
</tr>
<tr>
<td>2048</td>
<td>40918</td>
<td>130620</td>
<td>130946</td>
<td>353721</td>
<td>36214</td>
<td>35772</td>
<td>127449</td>
</tr>
</tbody>
</table>
<p>AVG Latency(us)                                                                                                       </p>
<table>
<thead>
<tr>
<th>msg size bytes</th>
<th>TCP PP</th>
<th>TCP PP VMA</th>
<th>TCP PP 3x</th>
<th>TCP PP 3x VMA</th>
<th>Intel X540</th>
<th>ConnectX-3</th>
<th>ConnectX-3 VMA</th>
</tr>
</thead>
<tbody>
<tr>
<td>256</td>
<td>14.611</td>
<td>3.798</td>
<td>16.7707</td>
<td>4.268</td>
<td>17.072</td>
<td>15.644</td>
<td>3.845</td>
</tr>
<tr>
<td>512</td>
<td>16.162</td>
<td>4.434</td>
<td>19.8913</td>
<td>4.866</td>
<td>18.667</td>
<td>19.013</td>
<td>4.456</td>
</tr>
<tr>
<td>1024</td>
<td>17.433</td>
<td>5.455</td>
<td>30.7607</td>
<td>5.9526</td>
<td>18.789</td>
<td>17.547</td>
<td>5.576</td>
</tr>
<tr>
<td>2048</td>
<td>24.768</td>
<td>7.849</td>
<td>28.7957</td>
<td>8.49</td>
<td>27.556</td>
<td>27.347</td>
<td>7.857</td>
</tr>
</tbody>
</table>
<h4 id="UDP-performance"><a href="#UDP-performance" class="headerlink" title="UDP performance"></a>UDP performance</h4><table>
<thead>
<tr>
<th>msg size bytes</th>
<th>UDP PP</th>
<th>UDP PP VMA </th>
</tr>
</thead>
<tbody>
<tr>
<td>256</td>
<td>65921</td>
<td>311823     </td>
</tr>
<tr>
<td>512</td>
<td>68160</td>
<td>261528     </td>
</tr>
<tr>
<td>1024</td>
<td>62480</td>
<td>203539     </td>
</tr>
<tr>
<td>1472</td>
<td>62233</td>
<td>171311     </td>
</tr>
<tr>
<td>2048</td>
<td>49457</td>
<td>46734      </td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>msg size bytes</th>
<th>UDP PP</th>
<th>UDP PP VMA </th>
</tr>
</thead>
<tbody>
<tr>
<td>256</td>
<td>9.474</td>
<td>3.201       </td>
</tr>
<tr>
<td>512</td>
<td>9.635</td>
<td>3.757       </td>
</tr>
<tr>
<td>1024</td>
<td>10.800</td>
<td>4.822       </td>
</tr>
<tr>
<td>1472</td>
<td>16.016</td>
<td>5.815           </td>
</tr>
<tr>
<td>2048</td>
<td>20.161</td>
<td>19.953      </td>
</tr>
</tbody>
</table>
<h4 id="netperf"><a href="#netperf" class="headerlink" title="netperf"></a>netperf</h4><p>numactl -C 2 netserver -D  -4 -v 2 -p 5000 -f -L 192.168.12.201<br>numactl -N 0 ./netperf -n 6 -p 5000 -H 192.168.12.201 -c -C -t TCP_STREAM -l 15 -T 2,2 – -m $((2<strong>$i))<br>numactl -N 0 ./netperf -n 6 -p 5000 -H 192.168.12.201 -c -C -t TCP_RR -l 20 -T 2,2 – -m $((2</strong>$i))<br>numactl -N 0 ./netperf -n 6 -p 5000 -H 192.168.12.201 -c -C -t UDP_RR -l 20 -T 2,2 – -m $((2**$i))</p>
<table>
<thead>
<tr>
<th>msg size bytes</th>
<th>TCP RR</th>
<th>TCP RR VMA</th>
<th>UDP RR</th>
<th>UDP RR VMA </th>
</tr>
</thead>
<tbody>
<tr>
<td>256</td>
<td>43428.69</td>
<td>129390.97</td>
<td>49805.09</td>
<td>146545.15  </td>
</tr>
<tr>
<td>512</td>
<td>37705.07</td>
<td>107808.85</td>
<td>46393.12</td>
<td>125839.11  </td>
</tr>
<tr>
<td>1024</td>
<td>35005.28</td>
<td>90787.06</td>
<td>39591.57</td>
<td>98669.99   </td>
</tr>
<tr>
<td>2048</td>
<td>23688.22</td>
<td>63992.85</td>
<td>22633.36</td>
<td>19961.70   </td>
</tr>
<tr>
<td>4096</td>
<td>22933.14</td>
<td>51851.17</td>
<td>20772.47</td>
<td>18604.53   </td>
</tr>
</tbody>
</table>
<h4 id="redis-benchmark"><a href="#redis-benchmark" class="headerlink" title="redis-benchmark"></a>redis-benchmark</h4><p>LD_PRELOAD=libvma.so VMA_STATS_FD_NUM=500 redis-server –port 7777  –protected-mode no –maxmemory 12000mb –maxmemory-samples 10 –maxmemory-policy allkeys-lru<br>numactl -C 2 redis-benchmark -r 10000000 -n 20000000 -t get,set,lpush,lpop -P 16 -q -h 192.168.12.201 -p 7777 -d 16</p>
<p>set/get/lpush/lpop records/s</p>
<table>
<thead>
<tr>
<th>size bytes</th>
<th>set</th>
<th>get</th>
<th>lpush</th>
<th>lpop</th>
<th>set vma</th>
<th>get vma</th>
<th>lpush vma</th>
<th>lpop vma   </th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>909628.44</td>
<td>995668.88</td>
<td>1125492.38</td>
<td>1092836.38</td>
<td>1051801.25</td>
<td>1383604.25</td>
<td>1427857.50</td>
<td>1412230.00 </td>
</tr>
<tr>
<td>16</td>
<td>877077.62</td>
<td>975181.56</td>
<td>1126506.75</td>
<td>1058537.12</td>
<td>960937.88</td>
<td>1332001.25</td>
<td>1403213.38</td>
<td>1408054.00 </td>
</tr>
<tr>
<td>64</td>
<td>765814.06</td>
<td>963205.56</td>
<td>881834.19</td>
<td>1040203.94</td>
<td>785360.88</td>
<td>1114082.00</td>
<td>1179384.38</td>
<td>1258890.88 </td>
</tr>
<tr>
<td>256</td>
<td>596801.12</td>
<td>714030.69</td>
<td>787928.94</td>
<td>864416.31</td>
<td>614420.50</td>
<td>943129.31</td>
<td>868847.50</td>
<td>970167.38  </td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>size bytes</th>
<th>set x4</th>
<th>get x4</th>
<th>lpush x4</th>
<th>lpop x4</th>
<th>set x4 vma</th>
<th>get x4</th>
<th>lpush x4</th>
<th>lpop x4   </th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>1179965.09</td>
<td>1580834.26</td>
<td>2055718.79</td>
<td>2001333.44</td>
<td>2432077.24</td>
<td>3466123.12</td>
<td>3255039.99</td>
<td>3349659.25</td>
</tr>
<tr>
<td>16</td>
<td>1205777.63</td>
<td>1656787.75</td>
<td>1685172.72</td>
<td>2167017.68</td>
<td>2212556.32</td>
<td>3204048.56</td>
<td>3243653</td>
<td>3355042</td>
</tr>
<tr>
<td>64</td>
<td>1125920.34</td>
<td>1491794.08</td>
<td>1603009.35</td>
<td>2040705.93</td>
<td>2004204.13</td>
<td>3079092.74</td>
<td>2744756.94</td>
<td>3079859.44</td>
</tr>
<tr>
<td>256</td>
<td>1172390.68</td>
<td>1236795.19</td>
<td>1024634.36</td>
<td>1474094.21</td>
<td>1717803</td>
<td>2521588</td>
<td>1659403.82</td>
<td>2402496.31</td>
</tr>
</tbody>
</table>
<p>Intel X540</p>
<table>
<thead>
<tr>
<th>size bytes</th>
<th>set x4</th>
<th>get x4</th>
<th>lpush x4</th>
<th>lpop x4   </th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>1512821.64</td>
<td>2118883.93</td>
<td>1834559.35</td>
<td>1960360.28</td>
</tr>
<tr>
<td>16</td>
<td>1449761.53</td>
<td>1851285.18</td>
<td>1910151.44</td>
<td>2017602.97</td>
</tr>
<tr>
<td>64</td>
<td>1199011.03</td>
<td>1773449.28</td>
<td>1612987.21</td>
<td>1806331.65</td>
</tr>
<tr>
<td>256</td>
<td>1097519.72</td>
<td>1121691.17</td>
<td>1145548.86</td>
<td>1398369.94</td>
</tr>
</tbody>
</table>
<p>ConnectX-3 </p>
<table>
<thead>
<tr>
<th>size bytes</th>
<th>set x4 VMA</th>
<th>get x4 VMA</th>
<th>lpush x4 VMA</th>
<th>lpop x4 VMA</th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>2455271.19</td>
<td>3476625.19</td>
<td>3360328.38</td>
<td>3401881.00</td>
</tr>
<tr>
<td>16</td>
<td>2461504.31</td>
<td>3309726.63</td>
<td>3224818.00</td>
<td>3322884.63</td>
</tr>
<tr>
<td>64</td>
<td>1954063.35</td>
<td>2876987.38</td>
<td>2729820.24</td>
<td>3035352.45</td>
</tr>
<tr>
<td>256</td>
<td>1498470.37</td>
<td>2356658.57</td>
<td>1650766.50</td>
<td>2362893.44</td>
</tr>
</tbody>
</table>
<p>Because not enough memory in single node, so I can’ t benchamrk 6xredis-server benchmark with 6xredis-benchmark<br>echo 1024 &gt; /proc/sys/net/core/somaxconn<br>vm.overcommit_memory = 1<br>echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled (reduce performance when you enable VMA, cancel)<br>13562:M 10 Jun 01:02:39.054 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.<br>13562:M 10 Jun 01:02:39.054 # Server started, Redis version 3.2.0<br>13562:M 10 Jun 01:02:39.054 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add ‘vm.overcommit_memory = 1’ to /etc/sysctl.conf and then reboot or run the command ‘sysctl vm.overcommit_memory=1’ for this to take effect.<br>13562:M 10 Jun 01:02:39.054 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command ‘echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled’ as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</p>
<ul>
<li>In VMA environment, if you disable Transparent Huge Pages, redis performance will decreased.</li>
</ul>
<h4 id="qperf"><a href="#qperf" class="headerlink" title="qperf"></a>qperf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> VMA PANIC: ib_ctx_handler73:ib_ctx_handler() ibv device 0x1523ee0 pd allocation failure (ibv context 0x15266d0) (errno=13 Permission denied)</span><br><span class="line">terminate called without an active exception</span><br><span class="line"> VMA PANIC: ib_ctx_handler73:ib_ctx_handler() ibv device 0x1523ee0 pd allocation failure (ibv context 0x15266d0) (errno=13 Permission denied)</span><br><span class="line">terminate called without an active exception</span><br><span class="line"> VMA PANIC: ib_ctx_handler73:ib_ctx_handler() ibv device 0x1523ee0 pd allocation failure (ibv context 0x15266d0) (errno=13 Permission denied)</span><br><span class="line">terminate called without an active exception</span><br></pre></td></tr></table></figure>
<p>###Another function<br><a href="http://www.intel.com/content/dam/www/public/us/en/documents/product-briefs/ethernet-x710-brief.pdf" target="_blank" rel="external">ethernet brief</a></p>
<p><a href="https://www.nas.nasa.gov/assets/pdf/papers/NAS_Technical_Report_NAS-2014-01.pdf" target="_blank" rel="external">Comparison of 40G RDMA and Traditional Ethernet Technologies</a><br><a href="http://www.mellanox.com/related-docs/prod_software/Performance_Tuning_Guide_for_Mellanox_Network_Adapters.pdf" target="_blank" rel="external">Performance Tuning Guidelines for Mellanox Network Adapters</a><br><a href="http://jaseywang.me/2013/11/02/10g82599eb-%E7%BD%91%E5%8D%A1%E6%B5%8B%E8%AF%95%E4%BC%98%E5%8C%96ethtool/" target="_blank" rel="external">10G 82599EB 网卡测试优化</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[About SSD power loss]]></title>
      <url>http://yoursite.com/2016/06/02/About-SSD-power-loss/</url>
      <content type="html"><![CDATA[<h3 id="Risks-of-unexpected-power-loss-on-solid-state-drives"><a href="#Risks-of-unexpected-power-loss-on-solid-state-drives" class="headerlink" title="Risks of unexpected power loss on solid state drives"></a><a href="http://www8.hp.com/h20195/v2/GetPDF.aspx/4AA6-1470ENW.pdf" target="_blank" rel="external">Risks of unexpected power loss on solid state drives</a></h3><p>Each time data is accessed or modified on the SSD, metadata is modified pertaining to the state of the data. This information allows for the storage controller to choose what data should be in the drive’s volatile cache at any given moment as well as the ability to implement techniques which increase performance and endurance</p>
<p>The drive then translates the LBA to the Physical Block Address (PBA) by way a flash translation table (FTL). The FTL is stored in cache and it is the responsibility of the controller to flush this table to non-volatile memory at times it deems appropriate or during a clean shutdown. The metadata associated with each page of data written also has information that can be used to rebuild the FTL if it is lost, but this rebuild takes time at the next power-on. If both the FTL and metadata are corrupted due to a sudden power loss event, the data stored on the SSD can become lost or even worse, the SSD, as a whole, can become inaccessible</p>
<p>Turning drive cache off<br>Pros: Data integrity is preserved in the event of a sudden power loss.<br>Cons: Dramatic decrease in read and write performance.<br>Increased writes to NAND resulting in lower write endurance and decreased drive life. FTL data is still stored in the volatile cache, which leaves it at risk</p>
<p>Capacitor hold-up circuitry<br>Pros: Data integrity is preserved in the event of a sudden power loss.<br>Cons: Increased cost due to inclusion of additional circuitry including capacitors. Additional board space is required.</p>
<h3 id="Dell-Solid-State-Drive-FAQ"><a href="#Dell-Solid-State-Drive-FAQ" class="headerlink" title="Dell Solid-State-Drive-FAQ"></a><a href="http://www.dell.com/downloads/global/products/pvaul/en/Solid-State-Drive-FAQ-us.pdf" target="_blank" rel="external">Dell Solid-State-Drive-FAQ</a></h3>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Trim (discard) support]]></title>
      <url>http://yoursite.com/2016/05/06/Trim-discard-support/</url>
      <content type="html"><![CDATA[<h3 id="Why-Trim"><a href="#Why-Trim" class="headerlink" title="Why Trim"></a><a href="https://en.wikipedia.org/wiki/Trim_(computing)" target="_blank" rel="external">Why Trim</a></h3><p>The Trim command is designed to enable the operating system to notify the SSD which pages no longer contain valid data due to erases either by the user or operating system itself. During a delete operation, the OS will mark the sectors as free for new data and send a Trim command to the SSD to mark them as not containing valid data. After that the SSD knows not to preserve the contents of the block when writing a page, resulting in less write amplification with fewer writes to the flash, higher write speed, and increased drive life.<br>Different SSDs implement the Trim command somewhat differently, so performance can vary.<br><img src="http://images.anandtech.com/reviews/storage/Intel/34nmSSD/Review/garbagecollection.png" alt=""></p>
<h3 id="SoftRaid"><a href="#SoftRaid" class="headerlink" title="SoftRaid"></a>SoftRaid</h3><h4 id="Openzfs-on-linux"><a href="#Openzfs-on-linux" class="headerlink" title="Openzfs on linux"></a>Openzfs on linux</h4><p><a href="https://github.com/zfsonlinux/zfs/pull/1016" target="_blank" rel="external">not support trim funtion</a><br><a href="http://list.zfsonlinux.org/pipermail/zfs-discuss/2016-January/024437.html" target="_blank" rel="external">expect to get a upgrade this year that will add TRIM support</a></p>
<h4 id="Trim-patch-for-ZOL"><a href="#Trim-patch-for-ZOL" class="headerlink" title="Trim patch for ZOL"></a>Trim patch for ZOL</h4><p><a href="https://github.com/zfsonlinux/zfs/pull/924" target="_blank" rel="external">DO NOT APPLY THIS PATCH IF YOU CARE ABOUT YOUR DATA</a></p>
<h4 id="Mdadm"><a href="#Mdadm" class="headerlink" title="Mdadm"></a>Mdadm</h4><p><a href="http://kernelnewbies.org/Linux_3.7#head-2fd9b183a4623d96e69ed24f88e0eb83217fa8df" target="_blank" rel="external">Since version 3.7 of the Linux kernel mainline, md supports TRIM operations for the underlying solid-state drives (SSDs), for linear, RAID 0, RAID 1, RAID 5 and RAID 10 layouts</a><br><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html-single/6.5_Release_Notes/" target="_blank" rel="external">CentOS 6.5 The mdadm tool now supports the TRIM commands for RAID0, RAID1, and RAID10.</a></p>
<h3 id="Hardware-Raid"><a href="#Hardware-Raid" class="headerlink" title="Hardware Raid"></a>Hardware Raid</h3><h4 id="LSI-Check-Interoperability-and-Compatibility"><a href="#LSI-Check-Interoperability-and-Compatibility" class="headerlink" title="LSI Check Interoperability and Compatibility"></a><a href="http://www.avagotech.com/support/interop-compatibility" target="_blank" rel="external">LSI Check Interoperability and Compatibility</a></h4><p><a href="http://docs.avagotech.com/docs-and-downloads/raid-controllers/MegaRAID_SAS_Gen3CompatibilityList.pdf" target="_blank" rel="external">MegaRAID SAS Gen3 Compatibility List</a><br><a href="http://docs.avagotech.com/docs-and-downloads/raid-controllers/raid-controllers-common-files/iMR_SAS_Gen3CompatibilityList.pdf" target="_blank" rel="external">iMR SAS Gen3 Compatibility List</a><br><a href="http://www.media-clone.net/v/vspfiles/downloads/LSI_6Gb_SAS_SATA_HBA_Compatibility_List.pdf" target="_blank" rel="external">LSI_6Gb_SAS_SATA_HBA Compatibility List</a><br>Just Compatibility, trim support not clean</p>
<h4 id="HP-Raid-support"><a href="#HP-Raid-support" class="headerlink" title="HP Raid support"></a>HP Raid support</h4><p><a href="http://h20195.www2.hp.com/V2/GetPDF.aspx/4AA5-8637ENW" target="_blank" rel="external">Is TRIM supported when using RAID with SSDs?</a><br><img src="/img/hp-trim-support.png" alt=""><br>Raid 1,10,0 could be support<br>Raid 1E,5,6 has not support</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Raid in SSD]]></title>
      <url>http://yoursite.com/2016/04/25/Raid-in-SSD/</url>
      <content type="html"><![CDATA[<h3 id="Chipset-Bottlenecks-can-occur-SSDs-in-a-RAID"><a href="#Chipset-Bottlenecks-can-occur-SSDs-in-a-RAID" class="headerlink" title="Chipset Bottlenecks can occur SSDs in a RAID"></a>Chipset Bottlenecks can occur SSDs in a RAID</h3><p>Evaluate the I/O topology of the used machine and eliminate bottlenecks<br>e.g., distribute SSDs to multiple controllers</p>
<p>Where is your ssd connectted ?<br>Some sata/M.2 ports through DMI conencetted.<br><img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Intel_5_Series_architecture.png" alt=""></p>
<p>DMI bandwidth<br>DMI 2.0, introduced in 2011, doubles the data transfer rate to 2 GB/s with a ×4 link. It is used to link an Intel CPU with the Intel Platform Controller Hub (PCH), which supersedes the historic implementation of a separate northbridge and southbridge.</p>
<p>DMI 3.0, released in August 2015, allows the 8 GT/s transfer rate per lane, for a total of four lanes and <font color="green">3.93 GB/s</font> for the CPU–PCH link. It is used by two-chip variants of the Intel Skylake microprocessors, which are used in conjunction with Intel 100 Series chipsets</p>
<p>Popular server only DMI 2.0 shipset at 2016-04<br>For example<br><a href="http://www.supermicro.com/products/system/1U/1028/SYS-1028U-E1CR4_.cfm" target="_blank" rel="external">Supermicro 1028U-E1CR4+</a><br><a href="http://www.supermicro.com/products/system/1U/1028/SYS-1028U-TN10RT_.cfm" target="_blank" rel="external">Same with 1028U-TN10RT+</a><br><a href="http://ark.intel.com/products/81759/Intel-DH82029-PCH" target="_blank" rel="external">Intel C612 chipset</a></p>
<h3 id="Enterprise-class-hardware-RAID-controllers-IOPS-bottlenecks"><a href="#Enterprise-class-hardware-RAID-controllers-IOPS-bottlenecks" class="headerlink" title="Enterprise-class hardware RAID controllers IOPS bottlenecks"></a>Enterprise-class hardware RAID controllers IOPS bottlenecks</h3><ul>
<li>Use software RAID to overcome the performance limitations of hardware RAID</li>
<li>Bottlenecks in software RAID implementations can still occur though at higher performance level</li>
</ul>
<h3 id="Asymmetry-between-Read-Write-Speed"><a href="#Asymmetry-between-Read-Write-Speed" class="headerlink" title="Asymmetry between Read/Write Speed"></a>Asymmetry between Read/Write Speed</h3><ul>
<li>Reading flash pages faster than writing</li>
<li>Writes in parity-based RAIDs slower than reads due to Read-Modify-Write operations</li>
<li>Effects can accumulate Even faster reads and slower writes</li>
</ul>
<h3 id="Synchronous-SSD-Aging"><a href="#Synchronous-SSD-Aging" class="headerlink" title="Synchronous SSD Aging"></a>Synchronous SSD Aging</h3><ul>
<li>SSDs have limited number of erase cycles<ul>
<li>Lifespan of SSD depends on write workload</li>
</ul>
</li>
<li>In RAIDs writes often distributed equally to all drives<ul>
<li>Multiple drives may wear out at the same time </li>
</ul>
</li>
</ul>
<p>If broken ssd just read only ,that is fine<br>Until 2016, I think write endurance is not problem.</p>
<h3 id="Workload-History-Dependency"><a href="#Workload-History-Dependency" class="headerlink" title="Workload History Dependency"></a>Workload History Dependency</h3><ul>
<li>Increase spare capacity to ensure that enough free flash blocks will be available anytime</li>
<li>Garbage collector</li>
<li>Write amplification</li>
</ul>
<p>OP (Over Provisioning) is very important for Garbage collector and write amplification</p>
<p>More OP, More perforamnce, Lower fragments(Lower write amplification), More write endurance….</p>
<p><a href="http://www.anandtech.com/show/8954/intel-launches-ssd-dc-s3610-s3710-enterprise-ssds" target="_blank" rel="external">There’s a difference in over-provisioning levels too as the S3710 features a higher 30-40% over-provisioning with the S3610 having only 10-20%, in both models the exact over-provisioning depends on the capacity</a></p>
<p><a href="http://www.anandtech.com/show/9455/samsung-releases-pm863-sm863-enterprise-sata-ssds-up-to-384tb-with-3d-vnand" target="_blank" rel="external">The SM863 actually provides lower random write performance than the 845DC PRO, which is due to the reduced default over-provisioning as the SM863 only has 12% compared to 28% in the 845DC PRO</a></p>
<p><img src="http://www.ssdfans.com/wp-content/uploads/2016/04/041316_0813_FTLOP12.png" alt=""></p>
<h3 id="Benchmark"><a href="#Benchmark" class="headerlink" title="Benchmark"></a>Benchmark</h3><p><a href="http://www.tomshardware.com/reviews/ssd-dc-s3500-raid-performance,3613-7.html" target="_blank" rel="external">6x dc s3500 raid performance</a><br><a href="http://www.phoronix.com/scan.php?page=article&amp;item=linux_raid_fs4&amp;num=1" target="_blank" rel="external">4x intel 530 raid performance</a></p>
<p>In intel’ s <a href="http://www.intel.com/content/dam/www/public/us/en/documents/white-papers/ssd-server-storage-applications-paper.pdf" target="_blank" rel="external">ssd-server-storage-applications-paper</a><br>The document said “With SSDs, RAID level selection criteria are similar to HDDs. However, because of shorter rebuild times under load and lower performance cost of reads during Read-Modify-Write operations, RAID 5/6/50/60 may be more effective in some applications that traditionally would require the use of RAID 10 with HDDs.”</p>
<p>Does it means you could run SSDs in raid 50/60 (intel hardware) ?</p>
<h3 id="Congfiguration"><a href="#Congfiguration" class="headerlink" title="Congfiguration"></a>Congfiguration</h3><h4 id="Posix-file-system"><a href="#Posix-file-system" class="headerlink" title="Posix file system"></a>Posix file system</h4><p>kernel version &gt; 3.7 (ext4,btrfs,xfs,jfs)<br>add “discard” tag on each partition of the SSD<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/dev/sda1 / ext4 defaults,noatime,discard 0 1</span><br></pre></td></tr></table></figure></p>
<h4 id="Secure-Erase"><a href="#Secure-Erase" class="headerlink" title="Secure Erase"></a>Secure Erase</h4><p>wiping out all fragmentation and physically erasing all NAND blocks<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hdparm --user-master master --security-set-pass password /dev/sdX</span><br><span class="line">hdparm --user-master master --security-erase password /dev/sdX</span><br><span class="line">hdparm -Np468862128 /dev/sdX <span class="comment">#PIO mode</span></span><br><span class="line">&lt;Power cycle the drive&gt;</span><br></pre></td></tr></table></figure></p>
<p>ATA defines two classes of transfer mode, called PIO Mode (Programmed I/O Mode) and DMA Mode (Direct Memory Access Mode). PIO mode transfers are much slower and require the processor to arbitrate transfers between the device and memory. DMA mode transfers are much faster and occur without processor intervention</p>
<h4 id="Enable-HPA-not-Recommended"><a href="#Enable-HPA-not-Recommended" class="headerlink" title="Enable HPA (not Recommended)"></a>Enable HPA (not Recommended)</h4><p>(Recommended) Create partition(s) that occupy only the desired usable capacity and leave the<br>remaining capacity unused</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">User Capacity:    900,184,411,136 bytes [900 GB]</span><br><span class="line">awk <span class="string">'BEGIN&#123;print 900184411136/1024/1024/1024&#125;'</span></span><br><span class="line">838.362</span><br><span class="line">hdparm -N /dev/sdb</span><br><span class="line">max sectors = 1953525168/1953525168, HPA is disabled</span><br><span class="line">awk <span class="string">'BEGIN&#123;print 1953525168*512/1024/1024/1024&#125;'</span></span><br><span class="line">931.513</span><br><span class="line"><span class="comment"># Setting 80% could be used, improve OP capacity</span></span><br><span class="line">awk <span class="string">'BEGIN&#123;printf "%0.2f",1953525168*0.8&#125;'</span></span><br><span class="line">1562820134.40</span><br><span class="line">hdparm -Np1562820134 --yes-i-know-what-i-am-doing /dev/sdb</span><br><span class="line"> setting max visible sectors to 1562820134 (permanent)</span><br><span class="line"> max sectors   = 1562820134/1953525168, HPA is enabled</span><br><span class="line"></span><br><span class="line"><span class="comment">#Available space</span></span><br><span class="line">awk <span class="string">'BEGIN&#123;print 1562820134*512/1024/1024/1024&#125;'</span></span><br><span class="line">745.211</span><br></pre></td></tr></table></figure>
<h4 id="Enable-HPA-in-Kernel-Boot-Parameters"><a href="#Enable-HPA-in-Kernel-Boot-Parameters" class="headerlink" title="Enable HPA in Kernel Boot Parameters"></a><a href="http://redsymbol.net/linux-kernel-boot-parameters/" target="_blank" rel="external">Enable HPA in Kernel Boot Parameters</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">libata.ignore_hpa=      [LIBATA] Ignore HPA limit</span><br><span class="line">                        libata.ignore_hpa=0       keep BIOS limits (default)</span><br><span class="line">                        libata.ignore_hpa=1       ignore limits, using full disk</span><br></pre></td></tr></table></figure>
<p>or<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/module/libata/parameters/ignore_hpa</span><br><span class="line"><span class="built_in">echo</span> options libata ignore_hpa=1 &gt; /etc/modprobe.d/libata.conf</span><br></pre></td></tr></table></figure></p>
<p><a href="https://www.thomas-krenn.com/en/wiki/SSD_Over-provisioning_using_hdparm" target="_blank" rel="external">HPA reference</a></p>
<h4 id="Use-Direct-IO"><a href="#Use-Direct-IO" class="headerlink" title="Use Direct IO"></a>Use Direct IO</h4><p>With SSDs in Linux* using direct IO instead of buffered IO is recommended, when possible. The Linux<br>IO subsystem provides read and write buffering at the block device level. In most cases, buffering is<br>undesirable with SSDs for the following reasons:</p>
<ul>
<li>SSDs have lower latencies than HDDs, therefore the benefits of buffering are reduced.</li>
<li>Buffering read IOs consumes extra CPU cycles for memory copy operations. At IO rates typical for<br>SSDs, this extra CPU consumption may be high and create a read performance bottleneck.<br>To use direct IO and bypass the buffer, software can set O_DIRECT flag when opening a file. Many<br>applications and test tools have configurable options that allow selecting direct or buffered IO, for<br>example:</li>
<li>FIO* utility: use ‘–direct=1’ option</li>
<li>MySQL InnoDB*: use ‘–innodb_flush_method=O_DIRECT’ option</li>
<li>Oracle* 10g/11g: use ‘filesystemio_options = SETALL’ or<br>‘filesystemio_options = DIRECTIO’</li>
</ul>
<h4 id="echo-noop-gt-sys-block-sdX-queue-scheduler"><a href="#echo-noop-gt-sys-block-sdX-queue-scheduler" class="headerlink" title="echo noop &gt; /sys/block/sdX/queue/scheduler"></a>echo noop &gt; /sys/block/sdX/queue/scheduler</h4><h4 id="Raid-setting"><a href="#Raid-setting" class="headerlink" title="Raid setting"></a>Raid setting</h4><p>To optimize the speed of random IOPS, stripe unit size should be at least 2X of the typical transfer size used by the application. This minimizes the frequency of transfers crossing the stripe boundaries and writing to more than one drive at a time. If the files and transfers are aligned on the stripe boundaries, the stripe size can be set to be equal to the typical transfer size.</p>
<p>In large RAID sets, you must verify that your stripe size is large enough so that the stripe per drive is<br>not less than 4KB. To calculate the smallest stripe:<br>4096 X Number_of_Striped_Drives = Smallest_Stripe_Size<br>For higher sequential bandwidth with applications that cannot use IO queuing, the following stripe unit<br>size or smaller should be used:<br>0.5 x Transfer_size / Number_of_striped_drives</p>
<h4 id="How-small-files-save-to-Raid-stripe"><a href="#How-small-files-save-to-Raid-stripe" class="headerlink" title="How small files save to Raid stripe"></a><a href="https://communities.intel.com/thread/17622?tstart=0" target="_blank" rel="external">How small files save to Raid stripe</a></h4><p>That same with what I guess. I ‘m so glad :)</p>
<p>Again please remember that you can write multiple data blocks into one strip. Strip is not the smallest storage unit size on the disk.</p>
<p>Let’s take your example. we have a 32KB file and a 96KB file. On the file system they’re stored in a total of 4 clusters, if you have a 32KB cluster. Let’s say you have a 64KB strip size on RAID controller, and let’s assume it’s a sequential write. The first file will be written on the first 32KB of the strip on the first disk. Then the first 32KB of the 2nd file will be written to the rest 32KB of the strip on the first disk. The remaining 64KB goes to the strip on the second disk.</p>
<p>Now let’s change the example a little bit, with multiple (let’s say eight) 8KB files, 32KB cluster size and 64KB strip size. because of the 32KB cluster size, each 8KB file will use 32KB on your file system. Each 64KB strip can still take two 32KB clusters, so you’re using four strips in total, two on each drive. But you’re wasting 24KB * 8 = 192KB drive space here.</p>
<p>What if your cluster size is 4KB? Each 8KB file will take two clusters, and all 8 files can be stored in one 64KB strip.</p>
<p>What about a 1KB file? If you have a 4KB cluster size and 64KB strip size, you still have 60KB on the strip left for other files, wasting 3KB here, which is inevitable. But if you have a 32KB cluster size, you’ll have only 32KB on the strip left for other files, wasting 31KB.</p>
<p>Using RAID Write-Back Caching (BBU)<br>Disabling RAID Read Ahead, except sequential read bandwidth with single threaded applications<br>Disabling RAID Read Cache, read caching consumes RAID memory that could be used by write-back caching.<br><a href="http://www.intel.com/content/dam/www/public/us/en/documents/white-papers/ssd-server-storage-applications-paper.pdf" target="_blank" rel="external">For more info</a></p>
<h4 id="How-stripe-size"><a href="#How-stripe-size" class="headerlink" title="How stripe size"></a>How stripe size</h4><p><a href="http://www.research.ibm.com/haifa/conferences/systor2011/present/session5_talk2_systor2011.pdf" target="_blank" rel="external">Reference</a><br><a href="https://en.wikipedia.org/wiki/Direct_Media_Interface" target="_blank" rel="external">Reference</a><br><a href="http://www.ssdfans.com/?p=1840" target="_blank" rel="external">Garbage collector  Reference</a><br><a href="https://en.wikipedia.org/wiki/Write_amplification#BG-GC" target="_blank" rel="external">Garbage collector  Reference</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Partition alignment]]></title>
      <url>http://yoursite.com/2016/04/20/SSD-partition-alignment/</url>
      <content type="html"><![CDATA[<h3 id="Intel-Reference"><a href="#Intel-Reference" class="headerlink" title="Intel Reference"></a><a href="http://www.intel.com/content/dam/www/public/us/en/documents/technology-briefs/ssd-partition-alignment-tech-brief.pdf" target="_blank" rel="external">Intel Reference</a></h3><p>The default file system for Windows Server 2003, NTFS, uses 4 KB clusters by default.<br>Traditionally,these 4KB clusters take up 8 – 512 Byte sectors. With Intel SSDs, 1 - NTFS cluster takes up less than one NAND page when alignment is correct.<br>When the alignment is not correct, some of the 4 KB clusters will write across 2 NAND pages. </p>
<p>This is illustrated in Figure 1 using 4 KB pages for clarity:</p>
<p>With an offset of 63 sectors, the first 31.5 KB of drive space is left blank. Then Windows begins to<br>write clusters, but the physical page of the SSD ends at 32 KB.<br>Therefore, the cluster is split across 2 pages: 512 Bytes written on the first, 3.5 KB written on the next. </p>
<p>This has a cumulative effect as each subsequent page boundary that is written will have a cluster split across it. Figure 2–1 shows a misaligned partition, figure 2–2 shows a partition properly aligned at 1MB.</p>
<p><img src="/img/ssd-alignment.png" alt=""></p>
<h3 id="Linux-cmd"><a href="#Linux-cmd" class="headerlink" title="Linux cmd"></a>Linux cmd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 2048s = 1MB</span></span><br><span class="line"></span><br><span class="line">$ parted /dev/sda unit s <span class="built_in">print</span></span><br><span class="line">Model: ATA INTEL SSDSC2BW12 (scsi)</span><br><span class="line">Disk /dev/sda: 234441648s</span><br><span class="line">Sector size (logical/physical): 512B/512B</span><br><span class="line">Partition Table: msdos</span><br><span class="line">Disk Flags: </span><br><span class="line"></span><br><span class="line">Number  Start       End         Size        Type     File system  Flags</span><br><span class="line"> 1      2048s       148072447s  148070400s  primary  ntfs         boot</span><br><span class="line"> 2      148072448s  189673471s  41601024s   primary  ext4</span><br><span class="line"> 3      189673472s  234441647s  44768176s   primary  ext4</span><br><span class="line"></span><br><span class="line">parted /dev/sdxx</span><br><span class="line">(parted) <span class="built_in">set</span> 1 boot on</span><br><span class="line"></span><br><span class="line"><span class="comment">#or you can </span></span><br><span class="line">$ parted <span class="_">-a</span> optimal /dev/sdxx mkpart primary 2048s 100%</span><br></pre></td></tr></table></figure>
<h3 id="mkfs-HDD-raid"><a href="#mkfs-HDD-raid" class="headerlink" title="mkfs HDD raid"></a>mkfs HDD raid</h3><h4 id="ext4"><a href="#ext4" class="headerlink" title="ext4"></a>ext4</h4><p>11 HDD + 1HDD HS Raid6 stripe-size=128K, 11-2p=9, if you stride=9<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ parted <span class="_">-a</span> optimal /dev/sdxx mkpart primary 2048s 100%</span><br></pre></td></tr></table></figure></p>
<p>Warning: RAID stripe-width 128 not an even multiple of stride 9. 128%9=2 128%8=0 ??</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkfs.ext4 -E stride=8,stripe-width=128,lazy_itable_init=0,lazy_journal_init=0 /dev/sdxx1</span><br></pre></td></tr></table></figure>
<h4 id="xfs"><a href="#xfs" class="headerlink" title="xfs"></a>xfs</h4><p>Raid 60  24 HDD ，12HDD/per raid6   （12-2）× 2 ， Raid stripe size 64KB<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkfs.xfs <span class="_">-f</span> <span class="_">-d</span> sunit=64,swidth=$((64*20)) /dev/sdxx1</span><br></pre></td></tr></table></figure></p>
<h4 id="Kernel-io-schdule-Read-ahead"><a href="#Kernel-io-schdule-Read-ahead" class="headerlink" title="Kernel io schdule Read ahead"></a>Kernel io schdule Read ahead</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 1024 &gt; /sys/block/sdb/queue/<span class="built_in">read</span>_ahead_kb</span><br></pre></td></tr></table></figure>
<h4 id="increasing-the-maximal-I-O-queue-size-nr-requests"><a href="#increasing-the-maximal-I-O-queue-size-nr-requests" class="headerlink" title="increasing the maximal I/O queue size (nr_requests)"></a>increasing the maximal I/O queue size (nr_requests)</h4><p>Improve raid volume bandwidth (raid 6, 11x15k HDDs + 1HS)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 2048 &gt; /sys/block/sdb/queue/nr_requests</span><br></pre></td></tr></table></figure></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[golang io.reader to string]]></title>
      <url>http://yoursite.com/2016/04/12/golang-io-reader-to-string/</url>
      <content type="html"><![CDATA[<p>###Reader to string<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">buf := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">buf.ReadFrom(yourReader)</span><br><span class="line">s := buf.String() <span class="comment">// Does a complete copy of the bytes in the buffer.</span></span><br><span class="line"></span><br><span class="line">buf := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">buf.ReadFrom(yourReader)</span><br><span class="line">b := buf.Bytes()</span><br><span class="line">s := *(*<span class="keyword">string</span>)(unsafe.Pointer(&amp;b))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> b, err := ioutil.ReadAll(rc); err == <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">string</span>(b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">or gzip the buffer</span><br><span class="line">   raw := bytes.NewBuffer(data)</span><br><span class="line">   unz, err := gzip.NewReader(raw)</span><br><span class="line">   buf, err := ioutil.ReadAll(unz)</span><br><span class="line">   <span class="keyword">return</span> json.Unmarshal(buf, &amp;v)</span><br></pre></td></tr></table></figure></p>
<h3 id="string-to-reader"><a href="#string-to-reader" class="headerlink" title="string to reader"></a>string to reader</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">	r:=strings.NewReader(<span class="string">"(1,2,34,55,666)"</span>)</span><br><span class="line">	<span class="keyword">var</span> d [<span class="number">5</span>]<span class="keyword">int</span></span><br><span class="line">	fmt.Fscanf(r,<span class="string">"(%d,%d,%d,%d,%d)"</span>,&amp;d[<span class="number">0</span>],&amp;d[<span class="number">1</span>],&amp;d[<span class="number">2</span>],&amp;d[<span class="number">3</span>],&amp;d[<span class="number">4</span>])</span><br><span class="line">	fmt.Println(d)</span><br><span class="line">or </span><br><span class="line"></span><br><span class="line">	buf := bytes.NewBufferString(<span class="string">"R29waGVycyBydWxlIQ=="</span>)</span><br><span class="line">	dec := base64.NewDecoder(base64.StdEncoding, buf)</span><br><span class="line">	io.Copy(os.Stdout, dec)</span><br></pre></td></tr></table></figure>
<h3 id="Ouput-to-stdout"><a href="#Ouput-to-stdout" class="headerlink" title="Ouput to stdout"></a>Ouput to stdout</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">reader := bufio.NewReader(os.Stdin)</span><br><span class="line">fmt.Print(<span class="string">"What is your name:"</span>)</span><br><span class="line">data, _, _ := reader.ReadLine()</span><br><span class="line">fmt.Printf(<span class="string">"Your name is %s.\r\n"</span>, data)</span><br></pre></td></tr></table></figure>
<p><a href="http://stackoverflow.com/questions/9644139/from-io-reader-to-string-in-go" target="_blank" rel="external">reference</a><br><a href="https://www.datadoghq.com/blog/crossing-streams-love-letter-gos-io-reader/" target="_blank" rel="external">reference</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[SSD Interface]]></title>
      <url>http://yoursite.com/2016/04/08/SSD-interface/</url>
      <content type="html"><![CDATA[<h3 id="Interface-reference"><a href="#Interface-reference" class="headerlink" title="Interface reference"></a><a href="http://www.nvmexpress.org/wp-content/uploads/NVMe_Infrastructure_final1.pdf" target="_blank" rel="external">Interface reference</a></h3><p><img src="/img/nvme-1.png" alt=""><br><img src="/img/nvme-2.png" alt=""><br><img src="/img/nvme-3.png" alt=""><br><img src="/img/nvme-4.png" alt=""><br><img src="/img/nvme-5.png" alt=""><br><img src="/img/nvme-6.png" alt=""><br><img src="/img/nvme-7.png" alt=""><br><img src="/img/nvme-8.png" alt=""><br><img src="/img/nvme-9.png" alt=""><br><img src="/img/nvme-10.png" alt=""><br><img src="/img/nvme-11.png" alt=""></p>
<h3 id="supermicro-benchmark"><a href="#supermicro-benchmark" class="headerlink" title="supermicro benchmark"></a><a href="https://www.supermicro.com/white_paper/white_paper_NVMe.pdf" target="_blank" rel="external">supermicro benchmark</a></h3><p><img src="/img/nvme-12.png" alt=""></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[SFP+ VS 10GBaseT]]></title>
      <url>http://yoursite.com/2016/04/08/SFP-VS-10GBaseT/</url>
      <content type="html"><![CDATA[<h3 id="reference"><a href="#reference" class="headerlink" title="reference"></a><a href="http://www.missioncriticalmagazine.com/ext/resources/MC/Home/Files/PDFs/WP_Blade_Ethernet_Cabling.pdf" target="_blank" rel="external">reference</a></h3><p><img src="/img/sfp-10bt-1.png" alt=""><br><img src="/img/sfp-10bt-2.png" alt=""></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Lustre operations]]></title>
      <url>http://yoursite.com/2016/04/06/Lustre-operations/</url>
      <content type="html"><![CDATA[<h3 id="Fsck-ldiskfs-file-system-corruption"><a href="#Fsck-ldiskfs-file-system-corruption" class="headerlink" title="Fsck ldiskfs file system corruption"></a>Fsck ldiskfs file system corruption</h3><h4 id="Errors"><a href="#Errors" class="headerlink" title="Errors"></a>Errors</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Dec <span class="number">29</span> <span class="number">14</span>:<span class="number">11</span>:<span class="number">32</span> mookie kernel: LDISKFS-fs error (device sdz): ldiskfs_lookup: unlinked inode <span class="number">5384166</span> in dir <span class="comment">#145170469</span></span><br><span class="line">Dec <span class="number">29</span> <span class="number">14</span>:<span class="number">11</span>:<span class="number">32</span> mookie kernel: Remounting filesystem read-only</span><br></pre></td></tr></table></figure>
<h4 id="Flush-the-journal"><a href="#Flush-the-journal" class="headerlink" title="Flush the journal"></a>Flush the journal</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ umount /ostxx</span><br><span class="line">$ mount -t ldiskfs /dev/sdx /mnt/ost</span><br><span class="line">$ umount /mnt/ost</span><br></pre></td></tr></table></figure>
<h4 id="Caution"><a href="#Caution" class="headerlink" title="Caution"></a>Caution</h4><ul>
<li><p>Ensure e2fsprogs version ,it ‘s not default linux version ,it ‘s lustre version</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa | grep e2fsprogs</span><br><span class="line">e2fsprogs-1.42.12.wc1-7.el6.x86_64</span><br><span class="line">e2fsprogs-libs-1.42.12.wc1-7.el6.x86_64</span><br></pre></td></tr></table></figure>
</li>
<li><p>Before fsck，make sure the mount point has been <font color="red">umount</font></p>
</li>
<li>Can check multiple MDT/OSTs in parallel</li>
</ul>
<h4 id="Check-only-mode"><a href="#Check-only-mode" class="headerlink" title="Check only mode"></a>Check only mode</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ e2fsck -fn /dev/sdx</span><br></pre></td></tr></table></figure>
<h4 id="Prudent-mode"><a href="#Prudent-mode" class="headerlink" title="Prudent mode"></a>Prudent mode</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ e2fsck -fp /dev/sdx</span><br></pre></td></tr></table></figure>
<h4 id="Answer-yes"><a href="#Answer-yes" class="headerlink" title="Answer yes"></a>Answer yes</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ e2fsck -fy /dev/sdx</span><br></pre></td></tr></table></figure>
<h3 id="Storage-target-could-not-mount-mount-lustre-failed"><a href="#Storage-target-could-not-mount-mount-lustre-failed" class="headerlink" title="Storage target could not mount (mount.lustre failed)"></a>Storage target could not mount (mount.lustre failed)</h3><h4 id="Caution-1"><a href="#Caution-1" class="headerlink" title="Caution"></a>Caution</h4><ul>
<li><font color="red">umount</font> all clients</li>
<li><font color="red">umount</font> all MGS,MDT,OSTs</li>
<li>ensure Lustre backing file systems are healthy ( fsck )</li>
</ul>
<h4 id="Writeconf"><a href="#Writeconf" class="headerlink" title="Writeconf"></a>Writeconf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mds<span class="comment"># tunefs.lustre --writeconf /dev/sdx</span></span><br><span class="line">oss<span class="comment"># tunefs.lustre --writeconf /dev/ost0</span></span><br><span class="line">oss<span class="comment"># tunefs.lustre --writeconf /dev/ost1</span></span><br><span class="line">oss<span class="comment"># tunefs.lustre --writeconf /dev/ost2</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<h4 id="Mount"><a href="#Mount" class="headerlink" title="Mount"></a>Mount</h4><ul>
<li>When you writeconf operation complete, mount MGS,MDT,OSTs,clients<ul>
<li>If MGS and MDT in single block device, you can add “-o nosvc” to avoid mount MDT</li>
</ul>
</li>
</ul>
<h3 id="Flush-all-of-the-metadata-client-mdc-locks-on-this-node"><a href="#Flush-all-of-the-metadata-client-mdc-locks-on-this-node" class="headerlink" title="Flush all of the metadata client (mdc) locks on this node"></a>Flush all of the metadata client (mdc) locks on this node</h3><p>If the client files info are not consistent , you could run the comand in the client</p>
<p><a href="http://wiki.old.lustre.org/manual/LustreManual20_HTML/LustreProc.html" target="_blank" rel="external">The lru_size parameter is used to control the number of client-side locks in an LRU queue. LRU size is dynamic, based on load. This optimizes the number of locks available to nodes that have different workloads</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ lctl <span class="built_in">set</span>_param ldlm.namespaces.*mdc*.lru_size=clear</span><br></pre></td></tr></table></figure></p>
<h3 id="Lustre-quota-ldiskfs"><a href="#Lustre-quota-ldiskfs" class="headerlink" title="Lustre quota (ldiskfs)"></a>Lustre quota (ldiskfs)</h3><h4 id="MDS"><a href="#MDS" class="headerlink" title="MDS"></a>MDS</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/fs/lustre/osd-ldiskfs/lfstest-MDT0000/quota_slave/info </span><br><span class="line">target name:    lfstest-MDT0000</span><br><span class="line">pool ID:        0</span><br><span class="line"><span class="built_in">type</span>:           md</span><br><span class="line">quota enabled:  <span class="string">"none"</span></span><br><span class="line">conn to master: setup</span><br><span class="line">space acct:     ug</span><br><span class="line">user uptodate:  glb[0],slv[0],reint[0]</span><br><span class="line">group uptodate: glb[0],slv[0],reint[0]</span><br><span class="line"></span><br><span class="line">mds$ lctl conf_param lfstest.quota.mdt=ug</span><br><span class="line"></span><br><span class="line">mds$ cat /proc/fs/lustre/osd-ldiskfs/lfstest-MDT0000/quota_slave/info </span><br><span class="line">target name:    lfstest-MDT0000</span><br><span class="line">pool ID:        0</span><br><span class="line"><span class="built_in">type</span>:           md</span><br><span class="line">quota enabled:  <span class="string">"ug"</span></span><br><span class="line">conn to master: setup</span><br><span class="line">space acct:     ug</span><br><span class="line">user uptodate:  glb[1],slv[1],reint[0]</span><br><span class="line">group uptodate: glb[1],slv[1],reint[0]</span><br><span class="line"></span><br><span class="line">mds$ lctl conf_param lfstest.quota.ost=ug</span><br></pre></td></tr></table></figure>
<h4 id="Add-pool"><a href="#Add-pool" class="headerlink" title="Add pool"></a>Add pool</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#MDT</span></span><br><span class="line">lctl pool_new lustre.pool1</span><br><span class="line">lctl pool_add lustre.pool1 OST[0-10/2]</span><br><span class="line"></span><br><span class="line"><span class="comment">#Client, set all files</span></span><br><span class="line">find /mnt/lustre/<span class="built_in">test</span> -type d | <span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    lctl setstripe -p lustre.pool1 <span class="variable">$line</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h4 id="OSS"><a href="#OSS" class="headerlink" title="OSS"></a>OSS</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/fs/lustre/osd-ldiskfs/lfstest-OST0001/quota_slave/info </span><br><span class="line">target name:    lfstest-OST0001</span><br><span class="line">pool ID:        0</span><br><span class="line"><span class="built_in">type</span>:           dt</span><br><span class="line">quota enabled:  <span class="string">"ug"</span></span><br><span class="line">conn to master: setup</span><br><span class="line">space acct:     ug</span><br><span class="line">user uptodate:  glb[1],slv[1],reint[0]</span><br><span class="line">group uptodate: glb[1],slv[1],reint[0]</span><br></pre></td></tr></table></figure>
<h4 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h4><h5 id="User-group-Quota"><a href="#User-group-Quota" class="headerlink" title="User/group Quota"></a>User/group Quota</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># No soft limit, Hard limit of 1GB block space, 10000 files</span></span><br><span class="line">$ lfs setquota -u <span class="built_in">test</span> -b 0 -B 1024000 -i 0 -I 10000 /mnt/</span><br><span class="line"></span><br><span class="line"><span class="comment"># Soft limit 1G and 5000 files, Hard limit 2G and 10000 files</span></span><br><span class="line">$ lfs setquota -g <span class="built_in">test</span>1 -b 1G -B 2G -i 5000 -I 10000 /mnt/</span><br><span class="line"></span><br><span class="line">user$ cp: writing <span class="built_in">test</span>1_bak: Disk quota exceeded</span><br><span class="line">user$ touch: cannot touch 10000: Disk quota exceeded</span><br></pre></td></tr></table></figure>
<h5 id="lfs-migrate-data-to-another-OST"><a href="#lfs-migrate-data-to-another-OST" class="headerlink" title="lfs migrate data to another OST"></a>lfs migrate data to another OST</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># move filename to OST0000 and stripe number equal 1</span></span><br><span class="line">lfs migrate -c 1 -i 0 filename</span><br></pre></td></tr></table></figure>
<h3 id="Abort-tgt-reocv"><a href="#Abort-tgt-reocv" class="headerlink" title="Abort tgt_reocv"></a>Abort tgt_reocv</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mds$ lctl dl</span><br><span class="line">mds$ lctl -device 3 abort_recovery</span><br></pre></td></tr></table></figure>
<p>or mount.lustre xxx xxx -o abort_recov</p>
<h3 id="Get-lustre-version"><a href="#Get-lustre-version" class="headerlink" title="Get lustre version"></a>Get lustre version</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ lctl get_param version</span><br></pre></td></tr></table></figure>
<h3 id="No-roots-quash"><a href="#No-roots-quash" class="headerlink" title="No roots quash"></a>No roots quash</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ lctl conf_param <span class="variable">$fsname</span>.mdt.nosquash_nids=<span class="string">"10.xx.xx.xx@tcp 10.xx.xx.xx@tcp"</span></span><br><span class="line">$ cat /proc/fs/lustre/mdt/<span class="variable">$fsname</span>-MDT0000/nosquash_nids</span><br><span class="line">10.xx.xx.xx@tcp 10.xx.xx.xx@tcp</span><br></pre></td></tr></table></figure>
<h3 id="Readonly-OST"><a href="#Readonly-OST" class="headerlink" title="Readonly OST"></a>Readonly OST</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lctl <span class="built_in">set</span>_param obdfilter.lustrewh-OST00XX.degraded=1</span><br></pre></td></tr></table></figure>
<h3 id="Rebalance-OST"><a href="#Rebalance-OST" class="headerlink" title="Rebalance OST"></a>Rebalance OST</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lfs find /opt/lustrewh -obd lustrewh-OST000c_UUID -size +4G | lfs_migrate -y</span><br></pre></td></tr></table></figure>
<h3 id="Move-data-to-one-OST"><a href="#Move-data-to-one-OST" class="headerlink" title="Move data to one OST"></a>Move data to one OST</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lfs migrate -c 1  -i 4  filepath <span class="comment">#to index 4</span></span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Cut file by byte]]></title>
      <url>http://yoursite.com/2016/04/05/Cut-file-by-byte/</url>
      <content type="html"><![CDATA[<h3 id="By-KB"><a href="#By-KB" class="headerlink" title="By KB"></a>By KB</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> &gt; <span class="built_in">test</span>1;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..100000&#125;; </span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">	<span class="built_in">echo</span> <span class="variable">$i</span> &gt;&gt; <span class="built_in">test</span>1; </span><br><span class="line">	<span class="built_in">echo</span> ------------ &gt;&gt; <span class="built_in">test</span>1; </span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h4 id="Read-10th-KB-data"><a href="#Read-10th-KB-data" class="headerlink" title="Read 10th KB data"></a>Read 10th KB data</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">head -c 10k <span class="built_in">test</span>1 | tail -c 1k </span><br><span class="line">dd <span class="keyword">if</span>=<span class="built_in">test</span>1 of=<span class="built_in">test</span>2 bs=1k skip=9 count=1</span><br></pre></td></tr></table></figure>
<h4 id="Read-by-Byte"><a href="#Read-by-Byte" class="headerlink" title="Read by Byte"></a>Read by Byte</h4><pre><code class="bash">
</code></pre>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Sort array with GAWK4]]></title>
      <url>http://yoursite.com/2016/04/04/Sort-array-with-GAWK4/</url>
      <content type="html"><![CDATA[<h3 id="Sort-array-by-awk"><a href="#Sort-array-by-awk" class="headerlink" title="Sort array by awk"></a>Sort array by awk</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ cat file</span><br><span class="line">port <span class="number">12</span></span><br><span class="line">zest <span class="number">2</span></span><br><span class="line">status <span class="number">4</span></span><br><span class="line">flash <span class="number">4</span></span><br><span class="line">hero <span class="number">3</span></span><br><span class="line">awk <span class="number">3</span></span><br><span class="line">innovation <span class="number">10</span></span><br><span class="line">test <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h4 id="Sort-index-descend"><a href="#Sort-index-descend" class="headerlink" title="Sort index (descend)"></a>Sort index (descend)</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/awk -f</span><br><span class="line">&#123; </span><br><span class="line">	a[$<span class="number">1</span>]=$<span class="number">2</span>; </span><br><span class="line">        PROCINFO[<span class="string">"sorted_in"</span>] = <span class="string">"@ind_str_desc"</span></span><br><span class="line">&#125; </span><br><span class="line">END &#123;</span><br><span class="line">	<span class="keyword">for</span> (i in a) &#123;</span><br><span class="line">		<span class="built_in">print</span> i, a[i]</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>output<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/tmp/awkscript file</span><br><span class="line">zest <span class="number">2</span></span><br><span class="line">test <span class="number">1</span></span><br><span class="line">status <span class="number">4</span></span><br><span class="line">port <span class="number">12</span></span><br><span class="line">innovation <span class="number">10</span></span><br><span class="line">hero <span class="number">3</span></span><br><span class="line">flash <span class="number">4</span></span><br><span class="line">awk <span class="number">3</span></span><br></pre></td></tr></table></figure></p>
<h4 id="Sort-value-ascend"><a href="#Sort-value-ascend" class="headerlink" title="Sort value (ascend)"></a>Sort value (ascend)</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/awk -f</span><br><span class="line">&#123; </span><br><span class="line">	a[$<span class="number">1</span>]=$<span class="number">2</span></span><br><span class="line">	PROCINFO[<span class="string">"sorted_in"</span>] = <span class="string">"@val_num_asc"</span></span><br><span class="line">&#125; </span><br><span class="line">END &#123;</span><br><span class="line">	<span class="keyword">for</span> (i in a) &#123;</span><br><span class="line">		<span class="built_in">print</span> i, a[i]</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>output<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/tmp/awkscript file</span><br><span class="line">test <span class="number">1</span></span><br><span class="line">zest <span class="number">2</span></span><br><span class="line">hero <span class="number">3</span></span><br><span class="line">awk <span class="number">3</span></span><br><span class="line">flash <span class="number">4</span></span><br><span class="line">status <span class="number">4</span></span><br><span class="line">innovation <span class="number">10</span></span><br><span class="line">port <span class="number">12</span></span><br></pre></td></tr></table></figure></p>
<p><a href="https://www.gnu.org/software/gawk/manual/html_node/Controlling-Scanning.html" target="_blank" rel="external">gawk reference</a><br><a href="http://stackoverflow.com/questions/5342782/sort-associative-array-with-awk" target="_blank" rel="external">stackoverflow reference</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Blktrace]]></title>
      <url>http://yoursite.com/2016/04/01/blktrace/</url>
      <content type="html"><![CDATA[<p>OS version :CentOS 7.2<br>It ‘s a good tool for trace hot block in your block device</p>
<h3 id="Trace-your-IO-operation"><a href="#Trace-your-IO-operation" class="headerlink" title="Trace your IO operation"></a>Trace your IO operation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">$ yum -y install blktrace</span><br><span class="line">$ mount -t debugfs debugfs /sys/kernel/debug</span><br><span class="line"></span><br><span class="line">$ mount  | grep sdb1</span><br><span class="line">/dev/sdb1 on /<span class="built_in">local</span>/sdb <span class="built_in">type</span> ext4 (rw,noatime,stripe=128,data=ordered)</span><br><span class="line"></span><br><span class="line"><span class="comment"># With Ordered Mode, journal commits are deferred until the data blocks get written to disk. This guarantees that any blocks in the file will be data written by the application, avoiding a possibility of a security breach</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The path mapping to /dev/sdb1</span></span><br><span class="line">$ <span class="built_in">echo</span> 234 &gt; 234</span><br><span class="line"></span><br><span class="line">Sometimes ,the data is not write to block first</span><br><span class="line">$  cat /tmp/tmp  | grep A</span><br><span class="line">  8,16   6        1     0.000000000  3487  A   W 276480 + 8 &lt;- (8,17) <span class="string">"274432"</span></span><br><span class="line">  8,16   6       10     0.000224890 21268  A FWFS 1422142464 + 8 &lt;- (8,17) 1422140416</span><br><span class="line">  8,16   8        1     0.000070650 21268  A  WS 1422142416 + 8 &lt;- (8,17) 1422140368</span><br><span class="line">  8,16   8        5     0.000075917 21268  A  WS 1422142424 + 8 &lt;- (8,17) 1422140376</span><br><span class="line">  8,16   8        8     0.000078252 21268  A  WS 1422142432 + 8 &lt;- (8,17) 1422140384</span><br><span class="line">  8,16   8       11     0.000079337 21268  A  WS 1422142440 + 8 &lt;- (8,17) 1422140392</span><br><span class="line">  8,16   8       14     0.000080280 21268  A  WS 1422142448 + 8 &lt;- (8,17) 1422140400</span><br><span class="line">  8,16   8       17     0.000081320 21268  A  WS 1422142456 + 8 &lt;- (8,17) 1422140408</span><br><span class="line">  8,16   8       23     5.007945786  3487  A  WM 2056 + 8 &lt;- (8,17) 8</span><br><span class="line">  8,16   8       27     5.007958153  3487  A  WM 11616 + 8 &lt;- (8,17) 9568</span><br><span class="line">  8,16   8       30     5.007961458  3487  A  WM 11736 + 8 &lt;- (8,17) 9688</span><br><span class="line">  8,16   8       33     5.007964866  3487  A  WM 11864 + 8 &lt;- (8,17) 9816</span><br><span class="line">  8,16   8       36     5.007967773  3487  A  WM 77400 + 8 &lt;- (8,17) 75352</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ debugfs -R <span class="string">"icheck <span class="variable">$((274432/8)</span>)"</span> /dev/sdb1</span><br><span class="line">debugfs 1.42.9 (28-Dec-2013)</span><br><span class="line">Block	Inode number</span><br><span class="line">34304	15</span><br><span class="line"></span><br><span class="line">$ ls -li</span><br><span class="line">15 -rw-r--r-- 1 root root     4 Apr 1 04:44 234</span><br><span class="line"></span><br><span class="line">$ debugfs -R <span class="string">"ncheck 15"</span> /dev/sdb1</span><br><span class="line">debugfs 1.42.9 (28-Dec-2013)</span><br><span class="line">Inode	Pathname</span><br><span class="line">15	//234</span><br><span class="line"></span><br><span class="line">$ debugfs -R <span class="string">"icheck <span class="variable">$((1422140416/8)</span>)"</span> /dev/sdb1</span><br><span class="line">debugfs 1.42.9 (28-Dec-2013)</span><br><span class="line">Block	Inode number</span><br><span class="line">177767552	8</span><br><span class="line"></span><br><span class="line">$ debugfs -R <span class="string">"ncheck 8"</span> /dev/sdb1</span><br><span class="line">debugfs 1.42.9 (28-Dec-2013)</span><br><span class="line">Inode	Pathname</span><br></pre></td></tr></table></figure>
<p><a href="https://ext4.wiki.kernel.org/index.php/Ext4_Disk_Layout#Journal_.28jbd2.29" target="_blank" rel="external">The journal inode is typically inode 8. The first 68 bytes of the journal inode are replicated in the ext4 superblock. The journal itself is normal (but hidden) file within the filesystem. The file usually consumes an entire block group, though mke2fs tries to put it in the middle of the disk</a></p>
<h3 id="Another-example-full-ouput"><a href="#Another-example-full-ouput" class="headerlink" title="Another example full ouput"></a>Another example full ouput</h3><p>Here is output of my home PC (ubuntu 15.10)<br>Only write small file (dd if=/dev/zero of=/mnt/test bs=512 count=2)</p>
<h4 id="oflag-sync"><a href="#oflag-sync" class="headerlink" title="oflag=sync"></a>oflag=sync</h4><p>write journal, and then write data, hdd return, not wait a second<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>      <span class="number">159</span>   <span class="number">689.878265367</span>  <span class="number">8177</span>  A  WS <span class="number">155454552</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452504</span></span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">160</span>   <span class="number">689.878266393</span>  <span class="number">8177</span>  Q  WS <span class="number">155454552</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">161</span>   <span class="number">689.878268169</span>  <span class="number">8177</span>  G  WS <span class="number">155454552</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">162</span>   <span class="number">689.878268655</span>  <span class="number">8177</span>  P   N [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>      <span class="number">163</span>   <span class="number">689.878269447</span>  <span class="number">8177</span>  A  WS <span class="number">155454560</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452512</span></span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">164</span>   <span class="number">689.878269657</span>  <span class="number">8177</span>  Q  WS <span class="number">155454560</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">165</span>   <span class="number">689.878270524</span>  <span class="number">8177</span>  M  WS <span class="number">155454560</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>      <span class="number">166</span>   <span class="number">689.878271142</span>  <span class="number">8177</span>  A  WS <span class="number">155454568</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452520</span></span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">167</span>   <span class="number">689.878271349</span>  <span class="number">8177</span>  Q  WS <span class="number">155454568</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">168</span>   <span class="number">689.878271577</span>  <span class="number">8177</span>  M  WS <span class="number">155454568</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>      <span class="number">169</span>   <span class="number">689.878272006</span>  <span class="number">8177</span>  A  WS <span class="number">155454576</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452528</span></span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">170</span>   <span class="number">689.878272213</span>  <span class="number">8177</span>  Q  WS <span class="number">155454576</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">171</span>   <span class="number">689.878272441</span>  <span class="number">8177</span>  M  WS <span class="number">155454576</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>      <span class="number">172</span>   <span class="number">689.878272828</span>  <span class="number">8177</span>  A  WS <span class="number">155454584</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452536</span></span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">173</span>   <span class="number">689.878273026</span>  <span class="number">8177</span>  Q  WS <span class="number">155454584</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">174</span>   <span class="number">689.878273248</span>  <span class="number">8177</span>  M  WS <span class="number">155454584</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>      <span class="number">175</span>   <span class="number">689.878273587</span>  <span class="number">8177</span>  A  WS <span class="number">155454592</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452544</span></span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">176</span>   <span class="number">689.878273791</span>  <span class="number">8177</span>  Q  WS <span class="number">155454592</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">177</span>   <span class="number">689.878274019</span>  <span class="number">8177</span>  M  WS <span class="number">155454592</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">178</span>   <span class="number">689.878274829</span>  <span class="number">8177</span>  I  WS <span class="number">155454552</span> + <span class="number">48</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">179</span>   <span class="number">689.878275333</span>  <span class="number">8177</span>  U   N [jbd2/sdc1<span class="bullet">-8</span>] <span class="number">1</span></span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">180</span>   <span class="number">689.878275999</span>  <span class="number">8177</span>  D  WS <span class="number">155454552</span> + <span class="number">48</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">181</span>   <span class="number">689.878535778</span>     <span class="number">0</span>  C  WS <span class="number">155454552</span> + <span class="number">48</span> [<span class="number">0</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>      <span class="number">182</span>   <span class="number">689.878551480</span>  <span class="number">8177</span>  A FWFS <span class="number">155454600</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452552</span></span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">183</span>   <span class="number">689.878551816</span>  <span class="number">8177</span>  Q FWFS <span class="number">155454600</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">184</span>   <span class="number">689.878552509</span>  <span class="number">8177</span>  G FWFS <span class="number">155454600</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">185</span>   <span class="number">689.878553118</span>  <span class="number">8177</span>  I FWFS <span class="number">155454600</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">32</span>   <span class="number">3</span>      <span class="number">194</span>   <span class="number">689.878014170</span>  <span class="number">9030</span>  A  WS <span class="number">276520</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">274472</span></span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>      <span class="number">195</span>   <span class="number">689.878016897</span>  <span class="number">9030</span>  Q  WS <span class="number">276520</span> + <span class="number">8</span> [dd]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>      <span class="number">196</span>   <span class="number">689.878020143</span>  <span class="number">9030</span>  G  WS <span class="number">276520</span> + <span class="number">8</span> [dd]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>      <span class="number">197</span>   <span class="number">689.878021181</span>  <span class="number">9030</span>  P   N [dd]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>      <span class="number">198</span>   <span class="number">689.878022921</span>  <span class="number">9030</span>  I  WS <span class="number">276520</span> + <span class="number">8</span> [dd]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>      <span class="number">199</span>   <span class="number">689.878023761</span>  <span class="number">9030</span>  U   N [dd] <span class="number">1</span></span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>      <span class="number">200</span>   <span class="number">689.878025114</span>  <span class="number">9030</span>  D  WS <span class="number">276520</span> + <span class="number">8</span> [dd]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>      <span class="number">201</span>   <span class="number">689.878227087</span>     <span class="number">0</span>  C  WS <span class="number">276520</span> + <span class="number">8</span> [<span class="number">0</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">235</span>   <span class="number">689.929054795</span>     <span class="number">0</span>  D  WS <span class="number">155454600</span> + <span class="number">8</span> [swapper/<span class="number">2</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">236</span>   <span class="number">689.953664402</span>     <span class="number">0</span>  C  WS <span class="number">155454600</span> [<span class="number">0</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">186</span>   <span class="number">689.929232481</span>     <span class="number">0</span>  C  WS <span class="number">155454600</span> + <span class="number">8</span> [<span class="number">0</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">42</span>   <span class="number">716.440898596</span>  <span class="number">7824</span>  G   N [kworker/u8:<span class="number">0</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">43</span>   <span class="number">716.440899622</span>  <span class="number">7824</span>  I   N <span class="number">0</span> (<span class="number">00</span> ..) [kworker/u8:<span class="number">0</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">44</span>   <span class="number">716.440900483</span>  <span class="number">7824</span>  D   N <span class="number">0</span> (<span class="number">00</span> ..) [kworker/u8:<span class="number">0</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">45</span>   <span class="number">716.440915785</span>     <span class="number">3</span>  C   N (<span class="number">00</span> ..) [<span class="number">0</span>]</span><br></pre></td></tr></table></figure></p>
<h4 id="oflag-direct"><a href="#oflag-direct" class="headerlink" title="oflag=direct"></a>oflag=direct</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">write data first <span class="string">"278560"</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">0</span>       <span class="number">71</span>   <span class="number">924.643982410</span>  <span class="number">9092</span>  A  WS <span class="number">280608</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="string">"278560"</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">72</span>   <span class="number">924.643984999</span>  <span class="number">9092</span>  Q  WS <span class="number">280608</span> + <span class="number">8</span> [dd]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">73</span>   <span class="number">924.643988437</span>  <span class="number">9092</span>  G  WS <span class="number">280608</span> + <span class="number">8</span> [dd]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">74</span>   <span class="number">924.643989544</span>  <span class="number">9092</span>  P   N [dd]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">75</span>   <span class="number">924.643991242</span>  <span class="number">9092</span>  I  WS <span class="number">280608</span> + <span class="number">8</span> [dd]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">76</span>   <span class="number">924.643992202</span>  <span class="number">9092</span> UT   N [dd] <span class="number">1</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">77</span>   <span class="number">924.644003671</span>   <span class="number">113</span>  D  WS <span class="number">280608</span> + <span class="number">8</span> [kworker/<span class="number">0</span>:<span class="number">1</span>H]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">78</span>   <span class="number">924.644187239</span>     <span class="number">0</span>  C  WS <span class="number">280608</span> + <span class="number">8</span> [<span class="number">0</span>]</span><br><span class="line">wait <span class="number">5</span> seconds ... because commit = <span class="number">5</span> (default value)</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>      <span class="number">216</span>   <span class="number">929.750636556</span>     <span class="number">0</span>  D  WS <span class="number">155454648</span> + <span class="number">8</span> [swapper/<span class="number">2</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">1</span>      <span class="number">300</span>   <span class="number">929.725647290</span>  <span class="number">8177</span>  A  WS <span class="number">155454608</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452560</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">301</span>   <span class="number">929.725648586</span>  <span class="number">8177</span>  Q  WS <span class="number">155454608</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">302</span>   <span class="number">929.725651343</span>  <span class="number">8177</span>  G  WS <span class="number">155454608</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">303</span>   <span class="number">929.725651976</span>  <span class="number">8177</span>  P   N [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">1</span>      <span class="number">304</span>   <span class="number">929.725653017</span>  <span class="number">8177</span>  A  WS <span class="number">155454616</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452568</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">305</span>   <span class="number">929.725653281</span>  <span class="number">8177</span>  Q  WS <span class="number">155454616</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">306</span>   <span class="number">929.725654121</span>  <span class="number">8177</span>  M  WS <span class="number">155454616</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">1</span>      <span class="number">307</span>   <span class="number">929.725655039</span>  <span class="number">8177</span>  A  WS <span class="number">155454624</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452576</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">308</span>   <span class="number">929.725655246</span>  <span class="number">8177</span>  Q  WS <span class="number">155454624</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">309</span>   <span class="number">929.725655474</span>  <span class="number">8177</span>  M  WS <span class="number">155454624</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">1</span>      <span class="number">310</span>   <span class="number">929.725655948</span>  <span class="number">8177</span>  A  WS <span class="number">155454632</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452584</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">311</span>   <span class="number">929.725656326</span>  <span class="number">8177</span>  Q  WS <span class="number">155454632</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">312</span>   <span class="number">929.725656644</span>  <span class="number">8177</span>  M  WS <span class="number">155454632</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">1</span>      <span class="number">313</span>   <span class="number">929.725657046</span>  <span class="number">8177</span>  A  WS <span class="number">155454640</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452592</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">314</span>   <span class="number">929.725657247</span>  <span class="number">8177</span>  Q  WS <span class="number">155454640</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">315</span>   <span class="number">929.725657469</span>  <span class="number">8177</span>  M  WS <span class="number">155454640</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">316</span>   <span class="number">929.725658477</span>  <span class="number">8177</span>  I  WS <span class="number">155454608</span> + <span class="number">40</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">317</span>   <span class="number">929.725659326</span>  <span class="number">8177</span>  U   N [jbd2/sdc1<span class="bullet">-8</span>] <span class="number">1</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">318</span>   <span class="number">929.725660286</span>  <span class="number">8177</span>  D  WS <span class="number">155454608</span> + <span class="number">40</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">319</span>   <span class="number">929.725919352</span>     <span class="number">0</span>  C  WS <span class="number">155454608</span> + <span class="number">40</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">1</span>      <span class="number">320</span>   <span class="number">929.725936739</span>  <span class="number">8177</span>  A FWFS <span class="number">155454648</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452600</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">321</span>   <span class="number">929.725937087</span>  <span class="number">8177</span>  Q FWFS <span class="number">155454648</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">322</span>   <span class="number">929.725937786</span>  <span class="number">8177</span>  G FWFS <span class="number">155454648</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">323</span>   <span class="number">929.725938398</span>  <span class="number">8177</span>  I FWFS <span class="number">155454648</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">324</span>   <span class="number">929.750809777</span>     <span class="number">0</span>  C  WS <span class="number">155454648</span> + <span class="number">8</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>      <span class="number">217</span>   <span class="number">929.759034117</span>     <span class="number">0</span>  C  WS <span class="number">155454648</span> [<span class="number">0</span>]</span><br><span class="line">wait <span class="number">15</span>s or <span class="number">20</span>s ... Does it dirty_expire_centisecs = <span class="number">1500</span> ?</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">0</span>       <span class="number">79</span>   <span class="number">954.641636276</span>  <span class="number">8780</span>  A   W <span class="number">2048</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">0</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">80</span>   <span class="number">954.641637644</span>  <span class="number">8780</span>  Q   W <span class="number">2048</span> + <span class="number">8</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">81</span>   <span class="number">954.641641085</span>  <span class="number">8780</span>  G   W <span class="number">2048</span> + <span class="number">8</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">82</span>   <span class="number">954.641642087</span>  <span class="number">8780</span>  P   N [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">0</span>       <span class="number">83</span>   <span class="number">954.641644262</span>  <span class="number">8780</span>  A  WM <span class="number">2056</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">8</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">84</span>   <span class="number">954.641644472</span>  <span class="number">8780</span>  Q  WM <span class="number">2056</span> + <span class="number">8</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">85</span>   <span class="number">954.641645486</span>  <span class="number">8780</span>  M  WM <span class="number">2056</span> + <span class="number">8</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">0</span>       <span class="number">86</span>   <span class="number">954.641647064</span>  <span class="number">8780</span>  A  WM <span class="number">10256</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">8208</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">87</span>   <span class="number">954.641647274</span>  <span class="number">8780</span>  Q  WM <span class="number">10256</span> + <span class="number">8</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">88</span>   <span class="number">954.641648009</span>  <span class="number">8780</span>  G  WM <span class="number">10256</span> + <span class="number">8</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">0</span>       <span class="number">89</span>   <span class="number">954.641649608</span>  <span class="number">8780</span>  A  WM <span class="number">10504</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">8456</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">90</span>   <span class="number">954.641649809</span>  <span class="number">8780</span>  Q  WM <span class="number">10504</span> + <span class="number">8</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">91</span>   <span class="number">954.641650430</span>  <span class="number">8780</span>  G  WM <span class="number">10504</span> + <span class="number">8</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">92</span>   <span class="number">954.641652170</span>  <span class="number">8780</span>  I   W <span class="number">2048</span> + <span class="number">16</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">93</span>   <span class="number">954.641652974</span>  <span class="number">8780</span>  I  WM <span class="number">10256</span> + <span class="number">8</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">94</span>   <span class="number">954.641653406</span>  <span class="number">8780</span>  I  WM <span class="number">10504</span> + <span class="number">8</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">95</span>   <span class="number">954.641653775</span>  <span class="number">8780</span>  U   N [kworker/u8:<span class="number">1</span>] <span class="number">3</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">96</span>   <span class="number">954.641655053</span>  <span class="number">8780</span>  D   W <span class="number">2048</span> + <span class="number">16</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">97</span>   <span class="number">954.641708392</span>  <span class="number">8780</span>  D  WM <span class="number">10256</span> + <span class="number">8</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">98</span>   <span class="number">954.641895755</span>     <span class="number">0</span>  C   W <span class="number">2048</span> + <span class="number">16</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">99</span>   <span class="number">954.641947709</span>     <span class="number">0</span>  D  WM <span class="number">10504</span> + <span class="number">8</span> [swapper/<span class="number">2</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>      <span class="number">100</span>   <span class="number">954.642066976</span>     <span class="number">0</span>  C  WM <span class="number">10256</span> + <span class="number">8</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>      <span class="number">101</span>   <span class="number">954.642239705</span>     <span class="number">0</span>  C  WM <span class="number">10504</span> + <span class="number">8</span> [<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<h4 id="no-oflag"><a href="#no-oflag" class="headerlink" title="no oflag"></a>no oflag</h4><p>There are a lot of different wait time in this situation<br>Because this situation is the most complex<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">wait <span class="number">5</span>s..</span><br><span class="line"> <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>       <span class="number">29</span>    <span class="number">82.996414180</span>     <span class="number">0</span>  D  WS <span class="number">155453784</span> + <span class="number">8</span> [swapper/<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">3</span>       <span class="number">51</span>    <span class="number">82.975991741</span>  <span class="number">9859</span>  A  WS <span class="number">155453736</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451688</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">52</span>    <span class="number">82.975993076</span>  <span class="number">9859</span>  Q  WS <span class="number">155453736</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">53</span>    <span class="number">82.975997048</span>  <span class="number">9859</span>  G  WS <span class="number">155453736</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">54</span>    <span class="number">82.975998182</span>  <span class="number">9859</span>  P   N [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">3</span>       <span class="number">55</span>    <span class="number">82.975999169</span>  <span class="number">9859</span>  A  WS <span class="number">155453744</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451696</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">56</span>    <span class="number">82.975999367</span>  <span class="number">9859</span>  Q  WS <span class="number">155453744</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">57</span>    <span class="number">82.976000324</span>  <span class="number">9859</span>  M  WS <span class="number">155453744</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">3</span>       <span class="number">58</span>    <span class="number">82.976000804</span>  <span class="number">9859</span>  A  WS <span class="number">155453752</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451704</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">59</span>    <span class="number">82.976001005</span>  <span class="number">9859</span>  Q  WS <span class="number">155453752</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">60</span>    <span class="number">82.976001239</span>  <span class="number">9859</span>  M  WS <span class="number">155453752</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">3</span>       <span class="number">61</span>    <span class="number">82.976001674</span>  <span class="number">9859</span>  A  WS <span class="number">155453760</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451712</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">62</span>    <span class="number">82.976001872</span>  <span class="number">9859</span>  Q  WS <span class="number">155453760</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">63</span>    <span class="number">82.976002097</span>  <span class="number">9859</span>  M  WS <span class="number">155453760</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">3</span>       <span class="number">64</span>    <span class="number">82.976002487</span>  <span class="number">9859</span>  A  WS <span class="number">155453768</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451720</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">65</span>    <span class="number">82.976002688</span>  <span class="number">9859</span>  Q  WS <span class="number">155453768</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">66</span>    <span class="number">82.976002913</span>  <span class="number">9859</span>  M  WS <span class="number">155453768</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">3</span>       <span class="number">67</span>    <span class="number">82.976003279</span>  <span class="number">9859</span>  A  WS <span class="number">155453776</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451728</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">68</span>    <span class="number">82.976003474</span>  <span class="number">9859</span>  Q  WS <span class="number">155453776</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">69</span>    <span class="number">82.976003696</span>  <span class="number">9859</span>  M  WS <span class="number">155453776</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">70</span>    <span class="number">82.976004914</span>  <span class="number">9859</span>  I  WS <span class="number">155453736</span> + <span class="number">48</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">71</span>    <span class="number">82.976005793</span>  <span class="number">9859</span>  U   N [jbd2/sdc1<span class="bullet">-8</span>] <span class="number">1</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">72</span>    <span class="number">82.976006999</span>  <span class="number">9859</span>  D  WS <span class="number">155453736</span> + <span class="number">48</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">73</span>    <span class="number">82.976309138</span>     <span class="number">0</span>  C  WS <span class="number">155453736</span> + <span class="number">48</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">3</span>       <span class="number">74</span>    <span class="number">82.976328284</span>  <span class="number">9859</span>  A FWFS <span class="number">155453784</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451736</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">75</span>    <span class="number">82.976328662</span>  <span class="number">9859</span>  Q FWFS <span class="number">155453784</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">76</span>    <span class="number">82.976329421</span>  <span class="number">9859</span>  G FWFS <span class="number">155453784</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">77</span>    <span class="number">82.976330021</span>  <span class="number">9859</span>  I FWFS <span class="number">155453784</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">78</span>    <span class="number">82.996586831</span>     <span class="number">0</span>  C  WS <span class="number">155453784</span> + <span class="number">8</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>        <span class="number">3</span>    <span class="number">83.004773614</span>     <span class="number">0</span>  C  WS <span class="number">155453784</span> [<span class="number">0</span>]</span><br><span class="line">wait <span class="number">8</span>s</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">3</span>       <span class="number">79</span>    <span class="number">92.668012660</span>  <span class="number">9646</span>  A   W <span class="number">272424</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">270376</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">80</span>    <span class="number">92.668014142</span>  <span class="number">9646</span>  Q   W <span class="number">272424</span> + <span class="number">8</span> [kworker/u8:<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">81</span>    <span class="number">92.668017571</span>  <span class="number">9646</span>  G   W <span class="number">272424</span> + <span class="number">8</span> [kworker/u8:<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">82</span>    <span class="number">92.668018489</span>  <span class="number">9646</span>  P   N [kworker/u8:<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">83</span>    <span class="number">92.668021330</span>  <span class="number">9646</span>  I   W <span class="number">272424</span> + <span class="number">8</span> [kworker/u8:<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">84</span>    <span class="number">92.668022206</span>  <span class="number">9646</span>  U   N [kworker/u8:<span class="number">0</span>] <span class="number">1</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">85</span>    <span class="number">92.668023601</span>  <span class="number">9646</span>  D   W <span class="number">272424</span> + <span class="number">8</span> [kworker/u8:<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">86</span>    <span class="number">92.668207032</span>     <span class="number">0</span>  C   W <span class="number">272424</span> + <span class="number">8</span> [<span class="number">0</span>]</span><br><span class="line">wait <span class="number">5</span>s</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>       <span class="number">23</span>    <span class="number">97.967994525</span>  <span class="number">9859</span>  A  WS <span class="number">155453792</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451744</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">24</span>    <span class="number">97.967996184</span>  <span class="number">9859</span>  Q  WS <span class="number">155453792</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">25</span>    <span class="number">97.967999937</span>  <span class="number">9859</span>  G  WS <span class="number">155453792</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">26</span>    <span class="number">97.968001062</span>  <span class="number">9859</span>  P   N [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>       <span class="number">27</span>    <span class="number">97.968002124</span>  <span class="number">9859</span>  A  WS <span class="number">155453800</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451752</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">28</span>    <span class="number">97.968002415</span>  <span class="number">9859</span>  Q  WS <span class="number">155453800</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">29</span>    <span class="number">97.968003315</span>  <span class="number">9859</span>  M  WS <span class="number">155453800</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>       <span class="number">30</span>    <span class="number">97.968003888</span>  <span class="number">9859</span>  A  WS <span class="number">155453808</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451760</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">31</span>    <span class="number">97.968004092</span>  <span class="number">9859</span>  Q  WS <span class="number">155453808</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">32</span>    <span class="number">97.968004323</span>  <span class="number">9859</span>  M  WS <span class="number">155453808</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>       <span class="number">33</span>    <span class="number">97.968004722</span>  <span class="number">9859</span>  A  WS <span class="number">155453816</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451768</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">34</span>    <span class="number">97.968004923</span>  <span class="number">9859</span>  Q  WS <span class="number">155453816</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">35</span>    <span class="number">97.968005148</span>  <span class="number">9859</span>  M  WS <span class="number">155453816</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">36</span>    <span class="number">97.968006597</span>  <span class="number">9859</span>  I  WS <span class="number">155453792</span> + <span class="number">32</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">37</span>    <span class="number">97.968007347</span>  <span class="number">9859</span>  U   N [jbd2/sdc1<span class="bullet">-8</span>] <span class="number">1</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">38</span>    <span class="number">97.968008571</span>  <span class="number">9859</span>  D  WS <span class="number">155453792</span> + <span class="number">32</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">39</span>    <span class="number">97.968260397</span>     <span class="number">0</span>  C  WS <span class="number">155453792</span> + <span class="number">32</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>       <span class="number">40</span>    <span class="number">97.968278433</span>  <span class="number">9859</span>  A FWFS <span class="number">155453824</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451776</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">41</span>    <span class="number">97.968278814</span>  <span class="number">9859</span>  Q FWFS <span class="number">155453824</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">42</span>    <span class="number">97.968279507</span>  <span class="number">9859</span>  G FWFS <span class="number">155453824</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">43</span>    <span class="number">97.968280119</span>  <span class="number">9859</span>  I FWFS <span class="number">155453824</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>        <span class="number">4</span>    <span class="number">97.987635609</span>     <span class="number">0</span>  D  WS <span class="number">155453824</span> + <span class="number">8</span> [swapper/<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>        <span class="number">5</span>    <span class="number">97.996024470</span>     <span class="number">0</span>  C  WS <span class="number">155453824</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">44</span>    <span class="number">97.987810139</span>     <span class="number">0</span>  C  WS <span class="number">155453824</span> + <span class="number">8</span> [<span class="number">0</span>]</span><br></pre></td></tr></table></figure></p>
<p><a href="https://ext4.wiki.kernel.org/index.php/Ext3_Data%3DOrdered_vs_Data%3DWriteback_mode" target="_blank" rel="external">ext4 reference</a><br><a href="http://rick_stone.leanote.com/post/ext4%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%EF%BC%881%EF%BC%89%E5%8A%9F%E8%83%BD%E7%AE%80%E4%BB%8B" target="_blank" rel="external">ext4 reference</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[golang bitwise operators]]></title>
      <url>http://yoursite.com/2016/03/29/golang-bitwise-operators/</url>
      <content type="html"><![CDATA[<h3 id="bitwise-operators-example"><a href="#bitwise-operators-example" class="headerlink" title="bitwise operators example"></a>bitwise operators example</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> main() &#123;</span><br><span class="line">    <span class="comment">// Use bitwise OR | to get the bits that are in 1 OR 2</span></span><br><span class="line">    <span class="comment">// 1     = 00000001</span></span><br><span class="line">    <span class="comment">// 2     = 00000010</span></span><br><span class="line">    <span class="comment">// 1 | 2 = 00000011 = 3</span></span><br><span class="line">    fmt.Println(<span class="number">1</span> | <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use bitwise OR | to get the bits that are in 1 OR 5</span></span><br><span class="line">    <span class="comment">// 1     = 00000001</span></span><br><span class="line">    <span class="comment">// 5     = 00000101</span></span><br><span class="line">    <span class="comment">// 1 | 5 = 00000101 = 5</span></span><br><span class="line">    fmt.Println(<span class="number">1</span> | <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use bitwise XOR ^ to get the bits that are in 3 OR 6 BUT NOT BOTH</span></span><br><span class="line">    <span class="comment">// 3     = 00000011</span></span><br><span class="line">    <span class="comment">// 6     = 00000110</span></span><br><span class="line">    <span class="comment">// 3 ^ 6 = 00000101 = 5</span></span><br><span class="line">    fmt.Println(<span class="number">3</span> ^ <span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use bitwise AND &amp; to get the bits that are in 3 AND 6</span></span><br><span class="line">    <span class="comment">// 3     = 00000011</span></span><br><span class="line">    <span class="comment">// 6     = 00000110</span></span><br><span class="line">    <span class="comment">// 3 &amp; 6 = 00000010 = 2</span></span><br><span class="line">    fmt.Println(<span class="number">3</span> &amp; <span class="number">6</span>)  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use bit clear AND NOT &amp;^ to get the bits that are in 3 AND NOT 6 (order matters)</span></span><br><span class="line">    <span class="comment">// 26     = 00011010</span></span><br><span class="line">    <span class="comment">// 6      = 00000110</span></span><br><span class="line">    <span class="comment">// turn          11111001</span></span><br><span class="line">    <span class="comment">// 3 &amp;^ 6 = 00011000 = 1</span></span><br><span class="line">    fmt.Println(<span class="number">26</span> &amp;^ <span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5  00000101</span></span><br><span class="line"><span class="comment">//-5  11111010+1=1111011 (two's complement of 5, the value was -5)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 6  00000110</span></span><br><span class="line"><span class="comment">//-6  11111001+1=11111010</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 5  00000101</span></span><br><span class="line"><span class="comment">//-6  11111010 (one's complement of 5, the value was -6)</span></span><br><span class="line"></span><br><span class="line">     fmt.Println(^<span class="number">5</span>) </span><br><span class="line"></span><br><span class="line">     a := <span class="number">1</span></span><br><span class="line">     a |= <span class="number">1</span> &lt;&lt; <span class="number">2</span> </span><br><span class="line">     <span class="comment">// 0000100 | 00000001 = 0000101 =5 </span></span><br><span class="line">     </span><br><span class="line">     fmt.Println(a)</span><br><span class="line">     a |= <span class="number">1</span> &lt;&lt; <span class="number">6</span> </span><br><span class="line">     <span class="comment">// 0000101 | 0100000 = 0100101 =69</span></span><br><span class="line">     </span><br><span class="line">     fmt.Println(a)</span><br><span class="line">     fmt.Println(<span class="number">1</span>&lt;&lt;<span class="number">6</span>) </span><br><span class="line">     <span class="comment">//0000001 &lt;&lt;6 = 1000000 = 64</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">24</span></span><br><span class="line"><span class="number">-6</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">69</span></span><br><span class="line"><span class="number">64</span></span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[XFS regularly truncating files after crash]]></title>
      <url>http://yoursite.com/2016/03/23/XFS-regularly-truncating-files-after-crash/</url>
      <content type="html"><![CDATA[<p>There are some CentOS 6.2 server loss xxGB data, write a script to recovery</p>
<h3 id="Recover-file"><a href="#Recover-file" class="headerlink" title="Recover file"></a>Recover file</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ ls -ih</span><br><span class="line">70179 -r-xr-xr-x 1 solexa solexa    0 Jan 10  2013 report.htm</span><br><span class="line"></span><br><span class="line">$ xfs_db -r /dev/sdb -c <span class="string">"inode 70179"</span> -c <span class="string">"bmap"</span></span><br><span class="line">data offset 0 startblock 2459337662 (9/43418558) count 1 flag 0a</span><br><span class="line"></span><br><span class="line">$ agblocks=$(xfs_db -r /dev/sdb -c sb -c p | grep ^agblocks | sed <span class="string">'s/.* = //'</span>)</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$agblocks</span></span><br><span class="line">268435455</span><br><span class="line">$ agcount=9</span><br><span class="line">$ b=43418558</span><br><span class="line">$ c=1</span><br><span class="line">$ <span class="built_in">echo</span> $((<span class="variable">$agblocks</span>*<span class="variable">$agcount</span>+<span class="variable">$b</span>)) </span><br><span class="line">2459337653</span><br><span class="line">$ <span class="built_in">echo</span> $((2459337662-9))</span><br><span class="line">2459337653</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/sdb bs=4096 skip=$((<span class="variable">$agblocks</span>*<span class="variable">$agcount</span>+<span class="variable">$b</span>)) count=<span class="variable">$c</span> of=/tmp/report.htm</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB) copied, 4.6345e-05 s, 88.4 MB/s</span><br><span class="line"></span><br><span class="line">$ cat /tmp/report.htm   <span class="comment"># file come back</span></span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=gbk"</span>/&gt;</span><br><span class="line">&lt;style&gt;</span><br></pre></td></tr></table></figure>
<p><a href="https://bugzilla.redhat.com/show_bug.cgi?id=845233" target="_blank" rel="external">redhat reference</a><br><a href="http://oss.sgi.com/archives/xfs/2012-02/msg00561.html" target="_blank" rel="external">sgi reference</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Yum tips]]></title>
      <url>http://yoursite.com/2016/03/22/Yum-tips/</url>
      <content type="html"><![CDATA[<h3 id="Exclude-packages"><a href="#Exclude-packages" class="headerlink" title="Exclude packages"></a>Exclude packages</h3><h4 id="Cli"><a href="#Cli" class="headerlink" title="Cli"></a>Cli</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum update --exclude=kernel*</span><br></pre></td></tr></table></figure>
<h4 id="yum-conf"><a href="#yum-conf" class="headerlink" title="yum.conf"></a>yum.conf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[main]</span><br><span class="line">cachedir=/var/cache/yum/<span class="variable">$basearch</span>/<span class="variable">$releasever</span></span><br><span class="line">keepcache=0</span><br><span class="line">debuglevel=2</span><br><span class="line">logfile=/var/<span class="built_in">log</span>/yum.log</span><br><span class="line">exclude=kernel* redhat-release* *.i?86</span><br></pre></td></tr></table></figure>
<p><a href="https://access.redhat.com/solutions/10185" target="_blank" rel="external">reference</a></p>
<h3 id="Switch-version"><a href="#Switch-version" class="headerlink" title="Switch version"></a>Switch version</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ yum --showduplicates list kernel</span><br><span class="line">Installed Packages</span><br><span class="line">Installed Packages</span><br><span class="line">kernel.x86_64       2.6.32-573.el6       @anaconda-CentOS-201508042137.x86_64/6.7</span><br><span class="line">kernel.x86_64       2.6.32-573.8.1.el6   @update                                 </span><br><span class="line">Available Packages</span><br><span class="line">kernel.x86_64       2.6.32-573.el6       base                                    </span><br><span class="line">kernel.x86_64       2.6.32-573.1.1.el6   update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.3.1.el6   update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.7.1.el6   update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.8.1.el6   update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.12.1.el6  update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.18.1.el6  update  </span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"><span class="comment">### Save rpms to local</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### Yum.conf</span></span><br><span class="line">```apacheconf</span><br><span class="line">keepcache = 1</span><br></pre></td></tr></table></figure>
<h4 id="Cli-1"><a href="#Cli-1" class="headerlink" title="Cli"></a>Cli</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum -y install yum-plugin-downloadonly</span><br><span class="line">$ yum install --downloadonly --downloaddir=&lt;directory&gt; &lt;package<span class="string">&gt;</span></span><br></pre></td></tr></table></figure>
<p><a href="https://access.redhat.com/solutions/10154" target="_blank" rel="external">reference</a></p>
<h3 id="Resolve-dependency-resolution-errors"><a href="#Resolve-dependency-resolution-errors" class="headerlink" title="Resolve dependency resolution errors"></a>Resolve dependency resolution errors</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum update</span></span><br><span class="line">** Found 5 pre-existing rpmdb problem(s), <span class="string">'yum check'</span> output follows:</span><br><span class="line">MegaCli-8.04.10-1.noarch is a duplicate with MegaCli-8.04.07-1.noarch</span><br><span class="line">kernel-2.6.32-279.5.1.el6_lustre.gb16fe80.x86_64 has missing requires of kernel-firmware &gt;= (<span class="string">'0'</span>, <span class="string">'2.6.32'</span>, <span class="string">'279.5.1.el6_lustre.gb16fe80'</span>)</span><br><span class="line">kernel-firmware-2.6.32-279.5.1.el6.noarch is a duplicate with kernel-firmware-2.6.32-279.el6.noarch</span><br><span class="line">kernel-headers-2.6.32-279.5.1.el6.x86_64 is a duplicate with kernel-headers-2.6.32-279.el6.x86_64</span><br><span class="line">libcom_err-1.42.3.wc3-7.el6.x86_64 is a duplicate with libcom_err-1.41.12-12.el6.i686</span><br><span class="line">......</span><br><span class="line">You could try using --skip-broken to work around the problem</span><br><span class="line">You could try running: rpm -Va --nofiles --nodigest</span><br></pre></td></tr></table></figure>
<h4 id="Uninstall-rpm-packages-from-rpmdb"><a href="#Uninstall-rpm-packages-from-rpmdb" class="headerlink" title="Uninstall rpm packages from rpmdb"></a>Uninstall rpm packages from rpmdb</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ rpm <span class="_">-e</span> --justdb --nodeps <span class="string">"bad rpm packages"</span></span><br><span class="line">$ rpm -ivh --force <span class="string">"replace normal rpm packages"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rebuild rpmdb</span></span><br><span class="line">$ <span class="built_in">cd</span> /var/lib/rpm</span><br><span class="line">$ rm  <span class="_">-f</span> __db*</span><br><span class="line">$ rpm --rebuilddb </span><br><span class="line"></span><br><span class="line">$ yum clean all</span><br><span class="line">$ yum -y update</span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[High availability cluster in linux]]></title>
      <url>http://yoursite.com/2016/03/22/High-availability-cluster-in-linux/</url>
      <content type="html"><![CDATA[<h3 id="pcs"><a href="#pcs" class="headerlink" title="pcs"></a>pcs</h3><h4 id="CentOS-7-Initialization"><a href="#CentOS-7-Initialization" class="headerlink" title="CentOS 7 Initialization"></a>CentOS 7 Initialization</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ scp /etc/hosts nodeA:/etc/ </span><br><span class="line">$ scp /etc/hosts nodeB:/etc/ </span><br><span class="line"></span><br><span class="line">$ yum -y install pacemaker corosync fence-agents-all fence-agents-virsh fence-virt  pacemaker-remote pcs</span><br><span class="line">$ <span class="built_in">echo</span> hacluster | passwd --stdin hacluster</span><br><span class="line">$ systemctl <span class="built_in">enable</span> pcsd.service</span><br><span class="line">$ systemctl start pcsd.service</span><br><span class="line">$ systemctl is-active pcsd.service</span><br><span class="line">$ pcs cluster auth node01 node02 ….</span><br><span class="line">$ pcs cluster setup --start --name ha-kvm node01 node02 …</span><br><span class="line">$ pcs cluster <span class="built_in">enable</span> --all</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 nodes cluster need to disable quorum</span></span><br><span class="line">$ pcs property <span class="built_in">set</span> stonith-enabled=ture</span><br><span class="line">$ pcs property <span class="built_in">set</span> no-quorum-policy=ignore</span><br></pre></td></tr></table></figure>
<h4 id="Create-fence"><a href="#Create-fence" class="headerlink" title="Create fence"></a>Create fence</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ pcs stonith create NodeB-fencing fence_ipmilan pcmk_host_list=<span class="string">"NodeB"</span> ipaddr=<span class="string">"192.xx.xx.xx"</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_<span class="built_in">wait</span>=4 op monitor interval=60s</span><br><span class="line"></span><br><span class="line"><span class="comment"># search fence device metadata</span></span><br><span class="line">$ stonith_admin -M <span class="_">-a</span> fence_ipmilan</span><br><span class="line"></span><br><span class="line"><span class="comment"># Fence the node</span></span><br><span class="line">$ stonith_admin --reboot nodename</span><br></pre></td></tr></table></figure>
<p><a href="http://clusterlabs.org/wiki/Configure_Multiple_Fencing_Devices_Using_pcs" target="_blank" rel="external">config fence level</a></p>
<h4 id="Create-resource"><a href="#Create-resource" class="headerlink" title="Create resource"></a>Create resource</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># VIP</span></span><br><span class="line">$ pcs resource create ClusterIP ocf:heartbeat:IPaddr2 ip=<span class="string">"192.xx.xx.xx"</span> cidr_netmask=32 nic=eth0 op monitor interval=30s</span><br><span class="line"></span><br><span class="line"><span class="comment"># kvm</span></span><br><span class="line">$ pcs resource create vm01 VirtualDomain hypervisor=<span class="string">"qemu:///system"</span> config=<span class="string">"/xx/xx/vm01.xml"</span>  meta remote-node=<span class="string">"vm01"</span>a</span><br><span class="line"></span><br><span class="line"><span class="comment"># filesystem</span></span><br><span class="line">$ pcs resource create Lustre-mgs ocf:heartbeat:Filesystem device=<span class="string">"/dev/sdb1"</span> directory=<span class="string">"/mnt"</span> fstype=<span class="string">"ext4"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># NFS</span></span><br><span class="line">$ pcs resource create WebFS ocf:heartbeat:Filesystem device=<span class="string">"192.xx.xx.xx:/mysqldata"</span> directory=<span class="string">"/var/lib/mysql"</span> fstype=<span class="string">"nfs"</span> options=<span class="string">"-o username=your_name,password=your_password"</span> op start timeout=60s op stop timeout=60s op monitor interval=20s timeout=60s</span><br><span class="line"></span><br><span class="line"><span class="comment"># iscsi</span></span><br><span class="line">$ pcs resource create WebData ocf:heartbeat:iscsi portal=<span class="string">"ip.xx.xx.xx"</span> target=<span class="string">"iqn.2008-08.com.starwindsoftware:"</span> op monitor depth=<span class="string">"0"</span> timeout=<span class="string">"30"</span> interval=<span class="string">"120"</span></span><br></pre></td></tr></table></figure>
<h4 id="Resource-group"><a href="#Resource-group" class="headerlink" title="Resource group"></a>Resource group</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$  pcs resource group add group_name resource_01 resource_02 ...</span><br><span class="line">$  pcs resource group remove group_name resource_01 resource_02 ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># resource1 run on the same machine as resource2</span></span><br><span class="line">$ pcs constraint colocation add myresource1 with myresource2 score=INFINITY</span><br><span class="line"><span class="comment"># myresource1 cannot run on the same machine as myresource2</span></span><br><span class="line">$ pcs constraint colocation add myresource1 with myresource2 score=-INFINITY</span><br><span class="line"><span class="comment"># Remove colocation constraints</span></span><br><span class="line">$  pcs constraint colocation remove &lt;<span class="built_in">source</span> resource id&gt; &lt;target resource id&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Resource priorities</span></span><br><span class="line">$ pcs constraint order resource1 <span class="keyword">then</span> resource2</span><br><span class="line">$ pcs constraint order remove  resource1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Node priorities, the resource prefers run on ServerA , the resource could fail over to ServerB</span></span><br><span class="line">$ pcs constraint location resource_id prefers ServerA=200</span><br><span class="line">$ pcs constraint location resource_id prefers ServerB=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># List all current location, order and colocation constraints</span></span><br><span class="line">$ pcs constraint --full</span><br></pre></td></tr></table></figure>
<h4 id="Backup-Restore-config"><a href="#Backup-Restore-config" class="headerlink" title="Backup/Restore config"></a>Backup/Restore config</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># exprot config</span></span><br><span class="line">$ pcs cluster cib filename</span><br><span class="line"></span><br><span class="line"><span class="comment"># import config</span></span><br><span class="line">$ pcs cluster cib-push filename</span><br></pre></td></tr></table></figure>
<h4 id="Show-config"><a href="#Show-config" class="headerlink" title="Show config"></a>Show config</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ pcs config show</span><br><span class="line">$ pcs stonith show stonith-name</span><br><span class="line">$ pcs resource show resource-name</span><br></pre></td></tr></table></figure>
<h4 id="get-default-value"><a href="#get-default-value" class="headerlink" title="get default value"></a>get default value</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ pcs resource defaults</span><br><span class="line"></span><br><span class="line">$ pcs resource defaults migration-threshold=5</span><br><span class="line">$ pcs resource defaults failure-timeout=240s</span><br><span class="line"></span><br><span class="line"><span class="comment"># not switch resource</span></span><br><span class="line">$ pcs resource defaults resource-stickiness=100</span><br><span class="line"></span><br><span class="line"><span class="comment"># resource timeout</span></span><br><span class="line">$ pcs resource op defaults timeout=240s</span><br><span class="line"></span><br><span class="line">$ pcs property <span class="built_in">set</span> stonith-action=reboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># delete</span></span><br><span class="line">$ pcs resource defaults timeouts=</span><br></pre></td></tr></table></figure>
<h4 id="Switch-and-delete-resource"><a href="#Switch-and-delete-resource" class="headerlink" title="Switch and delete resource"></a>Switch and delete resource</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ pcs resource move resource_name HostnameB</span><br><span class="line">$ pcs resource delete resource_name</span><br></pre></td></tr></table></figure>
<h4 id="Get-status"><a href="#Get-status" class="headerlink" title="Get status"></a>Get status</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ pcs status  	</span><br><span class="line">$ pcs status cluster</span><br><span class="line">$ pcs status corosync</span><br><span class="line">$ pcs cluster stop [nodename]  </span><br><span class="line">$ pcs cluster start --all</span><br><span class="line">$ pcs cluster standby nodename</span><br></pre></td></tr></table></figure>
<h4 id="Clean-info"><a href="#Clean-info" class="headerlink" title="Clean info"></a>Clean info</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># clean all error messages and error counts</span></span><br><span class="line">$ pcs resource cleanup resource_id</span><br><span class="line">$ pcs stonith cleanup fence_name</span><br></pre></td></tr></table></figure>
<p><a href="http://clusterlabs.org/wiki/Configure_Multiple_Fencing_Devices_Using_pcs" target="_blank" rel="external">reference</a></p>
<p>#### </p>
<h3 id="pacemaker"><a href="#pacemaker" class="headerlink" title="pacemaker"></a>pacemaker</h3><h4 id="clear-all-pacemaker-config"><a href="#clear-all-pacemaker-config" class="headerlink" title="clear all pacemaker config"></a>clear all pacemaker config</h4><p>Delete conf files from all nodes and restart services.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ rm <span class="_">-f</span> /var/lib/pacemaker/cib/*</span><br><span class="line">$ systemctl stop pacemaker</span><br><span class="line">$ systemctl stop corosync</span><br><span class="line">$ systemctl start corosync</span><br><span class="line">$ systemctl start pacemaker</span><br></pre></td></tr></table></figure></p>
<h3 id="corosync"><a href="#corosync" class="headerlink" title="corosync"></a>corosync</h3><p>####<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ corosync-cfgtool <span class="_">-s</span>  </span><br><span class="line">Printing ring status.</span><br><span class="line">Local node ID 2</span><br><span class="line">RING ID 0</span><br><span class="line">	id	= 10.xx.xx.xx</span><br><span class="line">	status	= ring 0 active with no faults</span><br><span class="line">RING ID 1</span><br><span class="line">	id	= 172.xx.xx.xx</span><br><span class="line">	status	= ring 1 active with no faults</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ corosync-quorumtool -siH</span><br><span class="line">Quorum information</span><br><span class="line">------------------</span><br><span class="line">Date:             Tue Mar 22 04:07:15 2016</span><br><span class="line">Quorum provider:  corosync_votequorum</span><br><span class="line">Nodes:            3</span><br><span class="line">Node ID:          0x00000002</span><br><span class="line">Ring ID:          656</span><br><span class="line">Quorate:          Yes</span><br><span class="line"></span><br><span class="line">Votequorum information</span><br><span class="line">----------------------</span><br><span class="line">Expected votes:   3</span><br><span class="line">Highest expected: 3</span><br><span class="line">Total votes:      3</span><br><span class="line">Quorum:           2</span><br><span class="line">Flags:            Quorate </span><br><span class="line"></span><br><span class="line">Membership information</span><br><span class="line">----------------------</span><br><span class="line">    Nodeid      Votes Name</span><br><span class="line">0x00000001          1 10.x.x.x</span><br><span class="line">0x00000003          1 10.x.x.x</span><br><span class="line">0x00000002          1 10.x.x.x (<span class="built_in">local</span>)</span><br></pre></td></tr></table></figure></p>
<h4 id="3-x-CentOS-7-corosync-conf"><a href="#3-x-CentOS-7-corosync-conf" class="headerlink" title="3 x CentOS 7 corosync.conf"></a>3 x CentOS 7 corosync.conf</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">totem &#123;</span><br><span class="line"><span class="attr">    version:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">    secauth:</span> off</span><br><span class="line"><span class="attr">    rrp_mode:</span>active</span><br><span class="line"><span class="attr">    cluster_name:</span> ha-kvm</span><br><span class="line"><span class="attr">    transport:</span> udpu</span><br><span class="line"><span class="attr">    token:</span> <span class="number">17000</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nodelist &#123;</span><br><span class="line">  node &#123;</span><br><span class="line"><span class="attr">        ring0_addr:</span> nic0.serverA.xx.xx</span><br><span class="line"><span class="attr">        ring1_addr:</span> nic1.serverA.xx.xx</span><br><span class="line"><span class="attr">        nodeid:</span> <span class="number">1</span></span><br><span class="line">       &#125;</span><br><span class="line">  node &#123;</span><br><span class="line"><span class="attr">        ring0_addr:</span> nic0.serverB.xx.xx</span><br><span class="line"><span class="attr">        ring1_addr:</span> nic1.serverB.xx.xx</span><br><span class="line"><span class="attr">        nodeid:</span> <span class="number">2</span></span><br><span class="line">       &#125;</span><br><span class="line">  node &#123;</span><br><span class="line"><span class="attr">        ring0_addr:</span> nic0.serverC.xx.xx</span><br><span class="line"><span class="attr">        ring1_addr:</span> nic1.serverC.xx.xx</span><br><span class="line"><span class="attr">        nodeid:</span> <span class="number">3</span></span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">quorum &#123;</span><br><span class="line"><span class="attr">    provider:</span> corosync_votequorum</span><br><span class="line"><span class="attr">    expected_votes:</span> <span class="number">3</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line"><span class="attr">        fileline:</span> off</span><br><span class="line"><span class="attr">        to_logfile:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">        to_syslog:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">        logfile:</span> /var/log/cluster/corosync.log</span><br><span class="line"><span class="attr">        timestamp:</span> on</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-x-CentOS6-corosync-conf"><a href="#2-x-CentOS6-corosync-conf" class="headerlink" title="2 x CentOS6 corosync.conf"></a>2 x CentOS6 corosync.conf</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"># Please read the corosync.conf.5 manual page</span><br><span class="line">compatibility: xxxx</span><br><span class="line"></span><br><span class="line">totem &#123;</span><br><span class="line">	version: 2</span><br><span class="line">	secauth: off</span><br><span class="line">	interface &#123;</span><br><span class="line">		member &#123;</span><br><span class="line">			memberaddr: nic0.serverA.xx.xx</span><br><span class="line">		&#125;</span><br><span class="line">		member &#123;</span><br><span class="line">			memberaddr: nic0.serverB.xx.xx</span><br><span class="line">		&#125;</span><br><span class="line">		ringnumber: 0</span><br><span class="line">		bindnetaddr: nic0.xx.xx.xx</span><br><span class="line">		mcastport: 5406</span><br><span class="line">		ttl: 1</span><br><span class="line">	&#125;</span><br><span class="line">	interface &#123;</span><br><span class="line">                member &#123;</span><br><span class="line">                        memberaddr: nic1.serverA.xx.xx</span><br><span class="line">                &#125;</span><br><span class="line">                member &#123;</span><br><span class="line">                        memberaddr: nic1.serverB.xx.xx</span><br><span class="line">                &#125;</span><br><span class="line">                ringnumber: 1</span><br><span class="line">                bindnetaddr: nic1.xx.xx.xx</span><br><span class="line">                mcastport: 5406</span><br><span class="line">                ttl: 1</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">	transport: udpu</span><br><span class="line">	token: 17000</span><br><span class="line">	rrp_mode: passive</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line">	fileline: off</span><br><span class="line">	to_logfile: yes</span><br><span class="line">	to_syslog: yes</span><br><span class="line">	debug: on</span><br><span class="line">	logfile: /var/log/cluster/corosync.log</span><br><span class="line">	debug: off</span><br><span class="line">	timestamp: on</span><br><span class="line">	logger_subsys &#123;</span><br><span class="line">		subsys: AMF</span><br><span class="line">		debug: off</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="http://qiita.com/tukiyo3/items/3f8b99be73798df857fd" target="_blank" rel="external">config refence</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Software install at centos 5/6]]></title>
      <url>http://yoursite.com/2016/03/22/Software-install-at-centos-5-6/</url>
      <content type="html"><![CDATA[<h3 id="Install-python-matplotlib"><a href="#Install-python-matplotlib" class="headerlink" title="Install python matplotlib"></a>Install python matplotlib</h3><h4 id="version-1-5"><a href="#version-1-5" class="headerlink" title="version 1.5"></a>version 1.5</h4><h4 id="freetype-2-3-or-later"><a href="#freetype-2-3-or-later" class="headerlink" title="freetype 2.3 or later"></a>freetype 2.3 or later</h4><h4 id="CentOS-5"><a href="#CentOS-5" class="headerlink" title="CentOS 5"></a>CentOS 5</h4><p>free type &lt; 2.3<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ rpm -qa | grep freetype</span><br><span class="line">freetype-devel-2.2.1-32.el5_9.1</span><br><span class="line">$ sudo yum -y install freetype freetype-devel libpng-devel lapack-devel</span><br><span class="line">$ pip install numpy==1.8</span><br><span class="line">$ pip install matplotlib==1.3.1</span><br></pre></td></tr></table></figure></p>
<p>Because matplotlib dependencies numpy version, if you installed higher numpy version, There are some errors in the installation process.</p>
<p><a href="http://stackoverflow.com/questions/22076553/matplotlib-install-issues-pip-centos-freetype-missing-when-it-is-installed" target="_blank" rel="external">reference</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Mariadb benchmark iops]]></title>
      <url>http://yoursite.com/2016/03/01/Mariadb-benchmark-iops/</url>
      <content type="html"><![CDATA[<h3 id="Install-sysbench-0-5"><a href="#Install-sysbench-0-5" class="headerlink" title="Install sysbench 0.5"></a>Install sysbench 0.5</h3><p>OS version: CentOS 7</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkdir /var/lib/mysql &amp;&amp; mount /dev/sdb1 /var/lib/mysql</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"deadline"</span> &gt; /sys/class/block/sdb/queue/scheduler</span><br><span class="line">yum install git automake libtool</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/hgxl64/sysbench-mariadb.git</span><br><span class="line"><span class="built_in">cd</span> sysbench-mariadb</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line"><span class="built_in">cd</span> sysbech/</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:$(<span class="built_in">pwd</span>)/</span><br><span class="line">sysbench --version</span><br><span class="line">sysbench 0.5</span><br></pre></td></tr></table></figure>
<h3 id="Install-mariadb"><a href="#Install-mariadb" class="headerlink" title="Install mariadb"></a>Install mariadb</h3><p><a href="https://downloads.mariadb.org/mariadb/repositories/#mirror=syringa&amp;distro=CentOS&amp;distro_release=centos7-amd64--centos7&amp;version=10.1" target="_blank" rel="external">MariaDB.repo</a></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MariaDB 10.1 CentOS repository list - created 2016-03-02 02:05 UTC</span></span><br><span class="line"><span class="comment"># http://mariadb.org/mariadb/repositories/</span></span><br><span class="line">[mariadb]</span><br><span class="line">name = MariaDB</span><br><span class="line">baseurl = <span class="symbol">http:</span>/<span class="regexp">/yum.mariadb.org/</span><span class="number">10.1</span>/centos7-amd64</span><br><span class="line">gpgkey=<span class="symbol">https:</span>/<span class="regexp">/yum.mariadb.org/</span>RPM-GPG-KEY-MariaDB</span><br><span class="line">gpgcheck=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">yum install mariadb-server mariadb-client mariadb-devel</span><br></pre></td></tr></table></figure>
<h3 id="limit-conf"><a href="#limit-conf" class="headerlink" title="limit.conf"></a>limit.conf</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*               soft    nofile           <span class="number">20000</span></span><br><span class="line">*               hard    nofile           <span class="number">20000</span></span><br><span class="line">*               soft    nproc            <span class="number">20000</span></span><br><span class="line">*               hard    nproc            <span class="number">20000</span></span><br></pre></td></tr></table></figure>
<h3 id="my-cnf-ubuntu-16-04-mariadb-10-1"><a href="#my-cnf-ubuntu-16-04-mariadb-10-1" class="headerlink" title="my.cnf (ubuntu 16.04, mariadb 10.1)"></a>my.cnf (ubuntu 16.04, mariadb 10.1)</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"> cat /etc/mysql/my.cnf | grep -v \#</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">port		= 3306</span><br><span class="line">socket		= /var/run/mysqld/mysqld.sock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line">socket		= /var/run/mysqld/mysqld.sock</span><br><span class="line">nice		= 0</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">user		= mysql</span><br><span class="line">pid-file	= /var/run/mysqld/mysqld.pid</span><br><span class="line">socket		= /var/run/mysqld/mysqld.sock</span><br><span class="line">port		= 3306</span><br><span class="line">basedir		= /usr</span><br><span class="line">datadir		= /var/lib/mysql</span><br><span class="line">tmpdir		= /tmp</span><br><span class="line">lc_messages_dir	= /usr/share/mysql</span><br><span class="line">lc_messages	= en_US</span><br><span class="line">skip-external-locking</span><br><span class="line">bind-address		= 127.0.0.1</span><br><span class="line">max_connections		= 1024</span><br><span class="line">connect_timeout		= 60</span><br><span class="line">wait_timeout		= 600</span><br><span class="line">max_allowed_packet	= 16M</span><br><span class="line">thread_cache_size       = 128</span><br><span class="line">sort_buffer_size	= 4M</span><br><span class="line">bulk_insert_buffer_size	= 16M</span><br><span class="line">tmp_table_size		= 32M</span><br><span class="line">max_heap_table_size	= 32M</span><br><span class="line">myisam_recover_options = BACKUP</span><br><span class="line">key_buffer_size		= 8M</span><br><span class="line">table_open_cache	= 800</span><br><span class="line">myisam_sort_buffer_size	= 512M</span><br><span class="line">concurrent_insert	= 2</span><br><span class="line">general_log             = 0</span><br><span class="line">log_warnings		= 2</span><br><span class="line">slow_query_log_file	= /var/log/mysql/mariadb-slow.log</span><br><span class="line">long_query_time = 60</span><br><span class="line">log_slow_verbosity	= query_plan</span><br><span class="line"></span><br><span class="line">#log_bin			= /var/log/mysql/mariadb-bin</span><br><span class="line">#log_bin_index		= /var/log/mysql/mariadb-bin.index</span><br><span class="line">#expire_logs_days	= 10</span><br><span class="line">#max_binlog_size         = 100M</span><br><span class="line">#diable /var/log/mysql bin-logs</span><br><span class="line">skip-log-bin</span><br><span class="line">default_storage_engine	= InnoDB</span><br><span class="line">innodb_log_file_size	= 50M</span><br><span class="line">innodb_buffer_pool_size	= 256M</span><br><span class="line">innodb_log_buffer_size	= 16M</span><br><span class="line">innodb_file_per_table	= true</span><br><span class="line">innodb_open_files	= 4000</span><br><span class="line">innodb_io_capacity	= 4000</span><br><span class="line">innodb_lru_scan_depth   = 4000</span><br><span class="line">innodb_flush_method	= O_DIRECT</span><br><span class="line">innodb_use_trim=ON</span><br><span class="line">innodb_use_fallocate=ON</span><br><span class="line">innodb_page_size=16k</span><br><span class="line">innodb_thread_concurrency=0</span><br><span class="line">innodb_write_io_threads=24</span><br><span class="line">innodb_read_io_threads=24</span><br><span class="line">innodb_buffer_pool_instances=16</span><br><span class="line">innodb_mtflush_threads=16</span><br><span class="line">innodb_doublewrite=0</span><br><span class="line"></span><br><span class="line">[galera]</span><br><span class="line"></span><br><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">quote-names</span><br><span class="line">max_allowed_packet	= 16M</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line"></span><br><span class="line">[isamchk]</span><br><span class="line">key_buffer		= 16M</span><br><span class="line"></span><br><span class="line">!includedir /etc/mysql/conf.d/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ulimit -n 20000</span><br><span class="line">mysqld_safe --defaults-file=/etc/my.cnf</span><br><span class="line">mysql -u root -e "create database sbtest"</span><br></pre></td></tr></table></figure>
<h3 id="Run-benchmark"><a href="#Run-benchmark" class="headerlink" title="Run benchmark"></a>Run benchmark</h3><p>If you have password, please add “–mysql-password=yourpass”</p>
<h3 id="prepare"><a href="#prepare" class="headerlink" title="prepare"></a>prepare</h3><p>Could not use prepare, run means parallel.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=tests/db/parallel_prepare.lua --mysql-host=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> --mysql-port=<span class="number">3306</span> --mysql-user=root --oltp-tables-count=<span class="number">128</span> --oltp-table-size=<span class="number">500000</span> --num-threads=<span class="number">128</span> --max-time=<span class="number">300</span> run</span><br></pre></td></tr></table></figure></p>
<h3 id="read"><a href="#read" class="headerlink" title="read"></a>read</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=tests/db/oltp.lua --mysql-host=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> --mysql-port=<span class="number">3306</span> --mysql-user=root --mysql-db=sbtest --oltp_tables_count=<span class="number">128</span> --oltp-table-size=<span class="number">500000</span>  --rand-type=uniform --oltp-read-only=on --num-threads=<span class="number">128</span> --max-requests=<span class="number">0</span> --max-time=<span class="number">300</span> --report-interval=<span class="number">3</span> run</span><br></pre></td></tr></table></figure>
<h3 id="rw"><a href="#rw" class="headerlink" title="rw"></a>rw</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=tests/db/oltp.lua --mysql-host=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> --mysql-port=<span class="number">3306</span> --mysql-user=root --mysql-db=sbtest --oltp_tables_count=<span class="number">128</span> --oltp-table-size=<span class="number">500000</span>  --rand-type=uniform --oltp-read-only=off --num-threads=<span class="number">128</span> --max-requests=<span class="number">0</span> --max-time=<span class="number">300</span> --report-interval=<span class="number">3</span> run</span><br></pre></td></tr></table></figure>
<h3 id="update"><a href="#update" class="headerlink" title="update"></a>update</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=tests/db/update_non_index.lua --mysql-host=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> --mysql-port=<span class="number">3306</span> --mysql-user=root --mysql-db=sbtest --oltp_tables_count=<span class="number">128</span> --oltp-table-size=<span class="number">500000</span>  --rand-type=uniform --oltp-read-only=off --num-threads=<span class="number">128</span> --max-requests=<span class="number">0</span> --max-time=<span class="number">300</span> --report-interval=<span class="number">3</span> run</span><br></pre></td></tr></table></figure>
<h3 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=tests/db/<span class="keyword">delete</span>.lua --mysql-host=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> --mysql-port=<span class="number">3306</span> --mysql-user=root --mysql-db=sbtest --oltp_tables_count=<span class="number">128</span> --oltp-table-size=<span class="number">500000</span>  --rand-type=uniform --oltp-read-only=off --num-threads=<span class="number">128</span> --max-requests=<span class="number">0</span> --max-time=<span class="number">300</span> --report-interval=<span class="number">3</span> run</span><br></pre></td></tr></table></figure>
<h3 id="result"><a href="#result" class="headerlink" title="result"></a>result</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">OLTP test statistics:</span><br><span class="line">    queries performed:</span><br><span class="line"><span class="attr">        read:</span>                            <span class="number">492604</span></span><br><span class="line"><span class="attr">        write:</span>                           <span class="number">140744</span></span><br><span class="line"><span class="attr">        other:</span>                           <span class="number">70372</span></span><br><span class="line"><span class="attr">        total:</span>                           <span class="number">703720</span></span><br><span class="line"><span class="attr">    transactions:</span>                        <span class="number">35186</span>  (<span class="number">117.12</span> per sec.)</span><br><span class="line">    read/write requests:                 <span class="number">633348</span> (<span class="number">2108.17</span> per sec.)</span><br><span class="line">    other operations:                    <span class="number">70372</span>  (<span class="number">234.24</span> per sec.)</span><br><span class="line">    ignored errors:                      <span class="number">0</span>      (<span class="number">0.00</span> per sec.)</span><br><span class="line"><span class="attr">    reconnects:</span>                          <span class="number">0</span>      (<span class="number">0.00</span> per sec.)</span><br><span class="line"></span><br><span class="line">General statistics:</span><br><span class="line">    total time:                          <span class="number">300.4258</span>s</span><br><span class="line">    total number of events:              <span class="number">35186</span></span><br><span class="line">    total time taken by event execution: <span class="number">9603.6924</span>s</span><br><span class="line">    response time:</span><br><span class="line"><span class="attr">         min:</span>                                 <span class="number">53.39</span>ms</span><br><span class="line"><span class="attr">         avg:</span>                                <span class="number">272.94</span>ms</span><br><span class="line"><span class="attr">         max:</span>                               <span class="number">1713.77</span>ms</span><br><span class="line">         approx.  <span class="number">95</span> percentile:             <span class="number">496.65</span>ms</span><br><span class="line"></span><br><span class="line">Threads fairness:</span><br><span class="line">    events (avg/stddev):           <span class="number">1099.5625</span>/<span class="number">11.17</span></span><br><span class="line">    execution time (avg/stddev):   <span class="number">300.1154</span>/<span class="number">0.12</span></span><br></pre></td></tr></table></figure>
<h3 id="About-performance-in-openzfs"><a href="#About-performance-in-openzfs" class="headerlink" title="About performance in openzfs"></a>About performance in openzfs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ zpool  create <span class="_">-f</span> tank -m /var/lib/mysql /dev/sdc  -o ashift=12</span><br><span class="line">$ zfs <span class="built_in">set</span> recordsize=16K tank</span><br><span class="line">$ zfs <span class="built_in">set</span> primarycache=metadata tank</span><br></pre></td></tr></table></figure>
<p>“zfs set logbias=throughput” has no good effect.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW VARIABLES LIKE <span class="string">"innodb_page_size"</span>;</span><br><span class="line">+------------------+-------+</span><br><span class="line">| Variable_name    | Value <span class="string">|</span><br><span class="line">+------------------+-------+</span><br><span class="line">| innodb_page_size | 16384 |</span><br><span class="line">+------------------+-------+</span><br><span class="line">1 row in set (0.00 sec)</span></span><br></pre></td></tr></table></figure>
<p><a href="https://wiki.archlinux.org/index.php/ZFS#Database" target="_blank" rel="external">zfs db</a><br><a href="https://www-304.ibm.com/partnerworld/wps/servlet/download/DownloadServlet?id=YxooL$U5GZkiPCA$cnt&amp;attachmentName=primer_to_run_sysbench_and_mariadb_benchmarks_on_lop.pdf&amp;token=MTQ1NjgyMjIzMTcyNA==&amp;locale=en_ALL_ZZ" target="_blank" rel="external">reference</a><br><a href="https://mariadb.org/using-lua-enabled-sysbench/" target="_blank" rel="external">reference2</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[VLC not show media title]]></title>
      <url>http://yoursite.com/2016/03/01/VLC-not-show-media-title/</url>
      <content type="html"><![CDATA[<h4 id="Not-show-media-title"><a href="#Not-show-media-title" class="headerlink" title="Not show media title"></a>Not show media title</h4><p><a href="https://forum.videolan.org/viewtopic.php?t=50202" target="_blank" rel="external">Same question</a><br>Tools–&gt;Preferences–&gt;Subtitles / OSD–&gt; Show media title on media start (disable it)<br>Tools–&gt;Preferences–&gt;Subtitles / OSD–&gt; Enable on screen display (disable it)</p>
<h4 id="Not-resize-interface"><a href="#Not-resize-interface" class="headerlink" title="Not resize interface"></a>Not resize interface</h4><p><img src="/img/vlc-set1.png" alt=""></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Install robinhood]]></title>
      <url>http://yoursite.com/2016/02/18/Install-robinhood/</url>
      <content type="html"><![CDATA[<p>Just analyse lustre data, not remove or move any file and directory.<br>And I created zfs pool in /var/lib/mysql, and enable lz4 compression.<br>Now here is compressratio<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># zfs get compressratio tank</span></span><br><span class="line">NAME  PROPERTY       VALUE  SOURCE</span><br><span class="line">tank  compressratio  2.50x  -</span><br></pre></td></tr></table></figure></p>
<p>CentOS 7.2 and Robinhood 2.5.5<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum -y install mariadb-devel libuuid-devel mailx glib2-devel libattr-devel mariadb-server attr</span></span><br><span class="line"><span class="comment"># tar xzvf robinhood-2.5.5.tar.gz</span></span><br><span class="line"><span class="comment"># cd robinhood</span></span><br><span class="line"><span class="comment"># ./configure --with-purpose=TMPFS</span></span><br><span class="line">or</span><br><span class="line"><span class="comment"># ./configure --with-purpose=LUSTRE_HSM</span></span><br><span class="line"><span class="comment"># make rpm</span></span><br><span class="line"><span class="comment"># rpm -ivh robinhood-tmpfs-2.5.5-4.lustre2.5.el7.centos.x86_64 robinhood-adm-2.5.5-4.noarch.x86_64</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Init-mariadb"><a href="#Init-mariadb" class="headerlink" title="Init mariadb"></a>Init mariadb</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl enable mariadb</span></span><br><span class="line"><span class="comment"># systemctl start mariadb</span></span><br><span class="line"><span class="comment"># mysqladmin -u root password "your root password";</span></span><br><span class="line"><span class="comment"># rbh-config create_db</span></span><br></pre></td></tr></table></figure>
<p>Modify /etc/robinhood.d/tmpfs/templates/tmpfs_detailed.conf as your wish, and save it to /etc/robinhood.d/tmpfs/tmpfs.conf.</p>
<h3 id="Enable-lustre-changelog"><a href="#Enable-lustre-changelog" class="headerlink" title="Enable lustre changelog"></a>Enable lustre changelog</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ChangeLog</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"># 1 MDT block for each MDT :</span></span><br><span class="line">    MDT</span><br><span class="line">    &#123;</span><br><span class="line">        mdt_name = <span class="string">"MDT0000"</span> ;</span><br><span class="line">        reader_id = <span class="string">"cl1"</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># clear changelog every 1024 records:</span></span><br><span class="line">    batch_ack_count = 1024 ;</span><br><span class="line"></span><br><span class="line">    force_polling    = ON ;</span><br><span class="line">    polling_interval = 1s ;</span><br><span class="line">    queue_max_size   = 1000 ;</span><br><span class="line">    queue_max_age    = 5s ;</span><br><span class="line">    queue_check_interval = 1s ;</span><br><span class="line">    dump_file = <span class="string">"/var/lib/mysql/robinhood/changelog_dump.log"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># lctl --device lustrefs-MDT0000 changelog_register</span></span><br><span class="line">lustrefs-MDT0000: Registered changlog userid <span class="string">'cl1'</span></span><br><span class="line"><span class="comment"># lctl set_param mdd.lustrefs-MDT*.changelog_mask "MARK CREAT MKDIR HLINK SLINK MKNOD UNLNK RMDIR RENME RNMTO OPEN LYOUT TRUNC SATTR XATTR HSM MTIME CTIME"</span></span><br><span class="line"><span class="comment"># lctl get_param mdd.lustrefs-MDT*.changelog_mask </span></span><br><span class="line">MARK CREAT MKDIR HLINK SLINK MKNOD UNLNK RMDIR RENME RNMTO OPEN LYOUT TRUNC SATTR XATTR HSM MTIME CTIME</span><br></pre></td></tr></table></figure>
<h3 id="Run-robinhood"><a href="#Run-robinhood" class="headerlink" title="Run robinhood"></a>Run robinhood</h3><p>write IOPS peak about 9000~10000 in single 10GbE SR SFP+ port.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">robinhood <span class="_">-f</span> /etc/robinhood.d/tmpfs/tmpfs.conf --read-log -C --dry-run --scan</span><br></pre></td></tr></table></figure></p>
<h3 id="Show-data"><a href="#Show-data" class="headerlink" title="Show data"></a>Show data</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rbh-report --top-users -U 10000</span></span><br><span class="line">Using config file <span class="string">'/etc/robinhood.d/tmpfs/tmpfs.conf'</span>.</span><br><span class="line">rank, user      ,   spc_used,      count,   avg_size</span><br><span class="line">   1, 501       ,  142.80 TB,     593083,  252.58 MB</span><br><span class="line">   2, 35061     ,   33.82 TB,      50912,  696.54 MB</span><br><span class="line">   3, 35623     ,   29.91 TB,      42304,  741.30 MB</span><br><span class="line">   4, 666666    ,   26.17 TB,     300038,   91.44 MB</span><br><span class="line">   5, 35939     ,   16.26 TB,    1616106,   10.54 MB</span><br><span class="line">   6, 31344     ,   15.63 TB,     801339,   20.45 MB</span><br><span class="line">   7, 30428     ,   13.54 TB,     272051,   52.19 MB</span><br><span class="line"></span><br><span class="line"><span class="comment"># rbh-report --top-users --by-count</span></span><br><span class="line">Using config file <span class="string">'/etc/robinhood.d/tmpfs/tmpfs.conf'</span>.</span><br><span class="line">rank, user      ,   spc_used,      count,   avg_size</span><br><span class="line">   1, 28904     ,  778.50 GB,    4493723,  179.10 KB</span><br><span class="line">   2, 504       ,    4.14 TB,    2514345,    1.73 MB</span><br><span class="line">   3, 29637     ,    2.81 TB,    2152429,    1.37 MB</span><br><span class="line">   4, 29563     ,  873.35 GB,    1935333,  470.53 KB</span><br><span class="line">   5, 30185     ,  508.22 GB,    1695768,  310.95 KB</span><br><span class="line">   6, 35939     ,   16.26 TB,    1616106,   10.54 MB</span><br><span class="line"></span><br><span class="line"><span class="comment"># rbh-du -sH /lustrefs/share_backup/ -u 30319 --details</span></span><br><span class="line">Using config file <span class="string">'/etc/robinhood.d/tmpfs/tmpfs.conf'</span>.</span><br><span class="line">ls </span><br><span class="line">total</span><br><span class="line">	symlink count:895, size:46.3K, spc_used:1.4M</span><br><span class="line">	dir count:9877, size:42.7M, spc_used:42.7M</span><br><span class="line">	file count:128990, size:5.2T, spc_used:5.2T</span><br><span class="line"></span><br><span class="line"><span class="comment"># rbh-du -H -u 30319</span></span><br><span class="line">Using config file <span class="string">'/etc/robinhood.d/tmpfs/tmpfs.conf'</span>.</span><br><span class="line">5.2T	/lustrefs</span><br><span class="line"></span><br><span class="line"><span class="comment"># rbh-report -u 30319 -S</span></span><br><span class="line">Using config file <span class="string">'/etc/robinhood.d/tmpfs/tmpfs.conf'</span>.</span><br><span class="line">user      ,      group,     <span class="built_in">type</span>,      count,   spc_used,   avg_size</span><br><span class="line">30319     ,        725,  symlink,          5,    4.00 KB,         36</span><br><span class="line">30319     ,        725,      dir,        811,    3.22 MB,    4.07 KB</span><br><span class="line">30319     ,        725,     file,       4388,    5.00 TB,    1.17 GB</span><br><span class="line">30319     ,        820,  symlink,         13,          0,         35</span><br><span class="line">30319     ,        820,      dir,         23,   92.00 KB,    4.00 KB</span><br><span class="line">30319     ,        820,     file,        287,    7.78 GB,   27.77 MB</span><br><span class="line">30319     ,        859,  symlink,        881,    1.38 MB,         53</span><br><span class="line">30319     ,        859,      dir,       9066,   39.48 MB,    4.45 KB</span><br><span class="line">30319     ,        859,     file,     124457,  208.88 GB,    1.72 MB</span><br><span class="line">30319     ,       root,      dir,          1,    4.00 KB,    4.00 KB</span><br><span class="line"></span><br><span class="line"><span class="comment"># rbh-report -u 30319 --szprof</span></span><br><span class="line">Using config file <span class="string">'/etc/robinhood.d/tmpfs/tmpfs.conf'</span>.</span><br><span class="line">user      ,     <span class="built_in">type</span>,      count,   spc_used,   avg_size,        0,     1~31,   32~1K-,   1K~31K,  32K~1M-,   1M~31M,  32M~1G-,   1G~31G,  32G~1T-,      +1T</span><br><span class="line">30319     ,  symlink,        899,    1.39 MB,         53,        0,      357,      542,        0,        0,        0,        0,        0,        0,        0</span><br><span class="line">30319     ,      dir,       9902,   42.80 MB,    4.42 KB,        0,        0,        0,     9875,       27,        0,        0,        0,        0,        0</span><br><span class="line">30319     ,     file,     129132,    5.21 TB,   42.31 MB,     2288,     2300,    31102,    75173,    14854,     2366,      863,      100,       86,        0</span><br><span class="line"></span><br><span class="line">Total: 139933 entries, 5728992747520 bytes used (5.21 TB)</span><br><span class="line"></span><br><span class="line"><span class="comment"># rbh-report --top-users --by-szratio=1G..31G</span></span><br><span class="line">Using config file <span class="string">'/etc/robinhood.d/tmpfs/tmpfs.conf'</span>.</span><br><span class="line">rank, user      ,   spc_used,      count,   avg_size,        0,     1~31,   32~1K-,   1K~31K,  32K~1M-,   1M~31M,  32M~1G-,   1G~31G,  32G~1T-,      +1T, ratio(1G..31G)</span><br><span class="line">   1, 29862     ,    8.96 TB,      10238,  918.14 MB,        9,        2,     1729,     2795,      466,      355,      679,     4185,       18,        0, 40.88%</span><br><span class="line">   2, 35590     ,   37.44 GB,         39,  983.16 MB,        2,        8,       10,        5,        0,        1,        0,       13,        0,        0, 33.33%</span><br><span class="line">   3, 35591     ,   17.47 GB,         22,  812.97 MB,        0,        0,       10,        3,        0,        1,        2,        6,        0,        0, 27.27%</span><br><span class="line">   4, qemu      ,  647.41 GB,        127,    5.27 GB,        0,        0,        5,       39,        3,       39,        6,       31,        4,        0, 24.41%</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rbh-report --top-dirs --by-count</span></span><br><span class="line">Using config file <span class="string">'/etc/robinhood.d/tmpfs/tmpfs.conf'</span>.</span><br><span class="line">rank,                                     path, dircount,    avgsize,       user,      group,             last_mod</span><br><span class="line">   1, /lustrefs/cm/net,  1365749,   56.84 KB,      35697,        904,  2016/02/01 03:58:45</span><br><span class="line">   2, /lustrefs/tte/net,   443993,   54.27 KB,      35697,        904,  2016/01/25 12:24:21</span><br><span class="line">   3, /lustrefs/tte/crf/crf-net,   443993,   39.71 KB,      35697,        904,  2016/01/26 03:04:40</span><br><span class="line">   4, /lustrefs/LabelFree/net,   387909,   82.25 KB,      35697,        904,  2016/01/26 02:36:44</span><br><span class="line">   5, /lustrefs/LabelFree/crf/crf-net,   387909,   50.98 KB,      35697,        904,  2016/01/26 06:02:10</span><br><span class="line"></span><br><span class="line"><span class="comment"># rbh-find /lustrefs/test/ -user 501 -size +1G –ost 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rbh-find -user 501 -print</span></span><br><span class="line">/lustrefs/xxxx</span><br><span class="line">/lustrefs/xxx/xxx</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rbh-report -a</span></span><br><span class="line">Using config file <span class="string">'/etc/robinhood.d/tmpfs/tmpfs.conf'</span>.</span><br><span class="line"></span><br><span class="line">Filesystem scan activity:</span><br><span class="line"></span><br><span class="line">    Current scan interval:   7.0d</span><br><span class="line"></span><br><span class="line">    Previous filesystem scan:</span><br><span class="line">            start:           2016/02/17 21:30:40</span><br><span class="line">            duration:        02s</span><br><span class="line"></span><br><span class="line">    Last filesystem scan:</span><br><span class="line">            status:          <span class="keyword">done</span></span><br><span class="line">            start:           2016/02/17 21:30:43</span><br><span class="line">            end:             2016/02/18 09:32:36</span><br><span class="line">            duration:        12h 01min 53s</span><br><span class="line"></span><br><span class="line">         Statistics:</span><br><span class="line">            entries scanned: 58038696</span><br><span class="line">            errors:          1</span><br><span class="line">            timeouts:        0</span><br><span class="line">            <span class="comment"># threads:       24</span></span><br><span class="line">            average speed:   1450.15 entries/sec</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Changelog stats:</span><br><span class="line"></span><br><span class="line">        Last <span class="built_in">read</span> record id:      5151588</span><br><span class="line">        Last <span class="built_in">read</span> record time:    2016/02/19 01:29:42.783530</span><br><span class="line">        Last receive time:        2016/02/19 01:28:56</span><br><span class="line">        Last committed record id: 5151588</span><br><span class="line">        Changelog stats:</span><br><span class="line">                 <span class="built_in">type</span>            total 	(diff)	(rate)</span><br><span class="line">                 MARK:               0</span><br><span class="line">                CREAT:         2363800 	(+30)	(0.03/sec)</span><br><span class="line">                MKDIR:           48696</span><br><span class="line">                HLINK:             110</span><br><span class="line">                SLINK:            1740 	(+2)	(0.00/sec)</span><br><span class="line">                MKNOD:               0</span><br><span class="line">                UNLNK:          137955 	(+161)	(0.13/sec)</span><br><span class="line">                RMDIR:            5993 	(+1)	(0.00/sec)</span><br><span class="line">                RENME:            3798 	(+5)	(0.00/sec)</span><br><span class="line">                RNMTO:               0</span><br><span class="line">                 OPEN:               0</span><br><span class="line">                CLOSE:               0</span><br><span class="line">                LYOUT:               0</span><br><span class="line">                TRUNC:          236843</span><br><span class="line">                SATTR:         2164457 	(+19)	(0.02/sec)</span><br><span class="line">                XATTR:           16732</span><br><span class="line">                  HSM:               0</span><br><span class="line">                MTIME:             284</span><br><span class="line">                CTIME:               0</span><br><span class="line">                ATIME:               0</span><br><span class="line"></span><br><span class="line">Storage usage has never been checked</span><br><span class="line"></span><br><span class="line">No purge was performed on this filesystem</span><br></pre></td></tr></table></figure>
<h3 id="Install-web-interface"><a href="#Install-web-interface" class="headerlink" title="Install web interface"></a>Install web interface</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rpm -ivh robinhood-webgui-2.5.5-4.noarch.x86_64.rpm</span></span><br><span class="line"><span class="comment"># yum -y install php php-mysql php-xml php-pdo php-gd httpd</span></span><br><span class="line"><span class="comment"># chown -R apache.apache /var/www/html/robinhood</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Modify httpd.conf</span></span><br><span class="line">&lt;Directory <span class="string">"/var/www/html"</span>&gt;</span><br><span class="line">    AllowOverride All</span><br></pre></td></tr></table></figure>
<p>Start httpd<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> httpd</span><br><span class="line">systemctl start httpd</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">```mysql</span><br><span class="line">[mysqld]</span><br><span class="line">user		= mysql</span><br><span class="line">pid-file	= /var/run/mysqld/mysqld.pid</span><br><span class="line">socket		= /var/run/mysqld/mysqld.sock</span><br><span class="line">port		= 3306</span><br><span class="line">basedir		= /usr</span><br><span class="line">datadir		= /var/lib/mysql</span><br><span class="line">tmpdir		= /tmp</span><br><span class="line"></span><br><span class="line">skip-external-locking</span><br><span class="line"></span><br><span class="line">performance_schema</span><br><span class="line">table_open_cache=2028</span><br><span class="line">max_connections=1024</span><br><span class="line">thread_cache_size=512</span><br><span class="line">table_cache=2048</span><br><span class="line">connect_timeout=60</span><br><span class="line">key_buffer_size=512M</span><br><span class="line">query_cache_size=512M</span><br><span class="line">query_cache_<span class="built_in">limit</span>=512M</span><br><span class="line">sort_buffer_size=512M</span><br><span class="line"><span class="built_in">read</span>_rnd_buffer_size=1G</span><br><span class="line">tmp_table_size=1G</span><br><span class="line">max_heap_table_size=1G</span><br><span class="line"></span><br><span class="line">innodb_buffer_pool_size = 16G</span><br><span class="line">innodb_additional_mem_pool_size = 16M</span><br><span class="line">innodb_max_dirty_pages_pct = 20</span><br><span class="line"><span class="comment">#innodb_data_file_path = ibdata1:100M:autoextend</span></span><br><span class="line">innodb_io_capacity=100000</span><br><span class="line">innodb_autoinc_lock_mode = 2</span><br><span class="line">innodb_thread_concurrency = 0</span><br><span class="line">innodb_<span class="built_in">log</span>_buffer_size = 256M</span><br><span class="line">innodb_<span class="built_in">log</span>_file_size = 900M</span><br><span class="line">innodb_<span class="built_in">log</span>_files_<span class="keyword">in</span>_group = 4</span><br><span class="line">innodb_lock_<span class="built_in">wait</span>_timeout = 120</span><br><span class="line"></span><br><span class="line"><span class="built_in">bind</span>-address		= 127.0.0.1</span><br><span class="line">max_connections		= 1024</span><br><span class="line">connect_timeout		= 30</span><br><span class="line"><span class="built_in">wait</span>_timeout		= 60</span><br><span class="line">sort_buffer_size	= 4M</span><br><span class="line">bulk_insert_buffer_size	= 16M</span><br><span class="line">tmp_table_size		= 32M</span><br><span class="line">max_heap_table_size	= 32M</span><br><span class="line">key_buffer_size		= 8M</span><br><span class="line">table_open_cache	= 800</span><br><span class="line">myisam_sort_buffer_size	= 512M</span><br><span class="line">concurrent_insert	= 2</span><br><span class="line">general_<span class="built_in">log</span>             = 0</span><br><span class="line"><span class="built_in">log</span>_warnings		= 2</span><br><span class="line">slow_query_<span class="built_in">log</span>_file	= /var/<span class="built_in">log</span>/mysql/mariadb-slow.log</span><br><span class="line">long_query_time = 60</span><br><span class="line"><span class="built_in">log</span>_slow_verbosity	= query_plan</span><br><span class="line"></span><br><span class="line">skip-log-bin</span><br><span class="line">default_storage_engine	= InnoDB</span><br><span class="line">innodb_<span class="built_in">log</span>_file_size	= 50M</span><br><span class="line">innodb_<span class="built_in">log</span>_buffer_size	= 16M</span><br><span class="line">innodb_file_per_table	= <span class="literal">true</span></span><br><span class="line">innodb_open_files	= 4000</span><br><span class="line">innodb_lru_scan_depth   = 4000</span><br><span class="line">innodb_use_trim=ON</span><br><span class="line">innodb_use_fallocate=ON</span><br><span class="line">innodb_page_size=16k</span><br><span class="line">innodb_write_io_threads=24</span><br><span class="line">innodb_<span class="built_in">read</span>_io_threads=24</span><br><span class="line">innodb_buffer_pool_instances=16</span><br><span class="line">innodb_mtflush_threads=16</span><br><span class="line">innodb_doublewrite=0</span><br></pre></td></tr></table></figure></p>
<p><img src="/img/robinhood_size.png" alt=""></p>
<p>reference:<br><a href="https://github.com/cea-hpc/robinhood/wiki/Documentation" target="_blank" rel="external">https://github.com/cea-hpc/robinhood/wiki/Documentation</a><br><a href="http://cdn.opensfs.org/wp-content/uploads/2013/04/lug13-robinhood.pdf" target="_blank" rel="external">http://cdn.opensfs.org/wp-content/uploads/2013/04/lug13-robinhood.pdf</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Reinstall grub2]]></title>
      <url>http://yoursite.com/2016/02/17/Reinstall-grub2/</url>
      <content type="html"><![CDATA[<h3 id="Boot-livecd-from-your-usb-device-or-network"><a href="#Boot-livecd-from-your-usb-device-or-network" class="headerlink" title="Boot livecd from your usb device or network"></a>Boot livecd from your usb device or network</h3><p>/dev/sdd2 is my linux root partition, OS is pinguyos(ubuntu)</p>
<h3 id="Test-in-ubuntu"><a href="#Test-in-ubuntu" class="headerlink" title="Test in ubuntu"></a>Test in ubuntu</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mount /dev/sdd2 /opt</span><br><span class="line">mount --bind /dev/ /opt/dev</span><br><span class="line">mount --bind /sys/ /opt/sys</span><br><span class="line">mount --bind /proc /opt/proc</span><br><span class="line">chroot /opt</span><br><span class="line">grub-install /dev/sdd</span><br><span class="line">grub-mkconfig -o /boot/grub/grub.cfg</span><br></pre></td></tr></table></figure>
<h3 id="Test-in-CentOS-7-set-boot-menu"><a href="#Test-in-CentOS-7-set-boot-menu" class="headerlink" title="Test in CentOS 7, set boot menu"></a>Test in CentOS 7, set boot menu</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat   /boot/grub2/grub.cfg | grep Windows</span><br><span class="line">menuentry <span class="string">"Windows 7 (loader) (on /dev/sda1)"</span></span><br><span class="line">grub2-set-default  <span class="string">"Windows 7 (loader) (on /dev/sda1)"</span></span><br><span class="line">grub2-editenv list</span><br><span class="line">saved_entry=Windows 7 (loader) (on /dev/sda1)</span><br><span class="line">or </span><br><span class="line">grub2-set-default <span class="string">"windows"</span></span><br><span class="line"></span><br><span class="line">grub2-mkconfig -o /boot/grub2/grub.conf</span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[rdesktop to windows10]]></title>
      <url>http://yoursite.com/2016/01/25/rdesktop-to-windows10/</url>
      <content type="html"><![CDATA[<h3 id="Enable-remote-desktop"><a href="#Enable-remote-desktop" class="headerlink" title="Enable remote desktop"></a>Enable remote desktop</h3><p><img src="/img/e_desktop.png" alt=""><br><img src="/img/e_firewall.png" alt=""></p>
<h3 id="Modify-registry"><a href="#Modify-registry" class="headerlink" title="Modify registry"></a>Modify registry</h3><p>\HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp\SecurityLayer<br>from DWORD Hex ‘2’ to a value of ‘1’</p>
<p>reference:<br><a href="http://ubuntuforums.org/showthread.php?t=2287213" target="_blank" rel="external">http://ubuntuforums.org/showthread.php?t=2287213</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Encrypt block device]]></title>
      <url>http://yoursite.com/2016/01/08/Encrypt-block-device/</url>
      <content type="html"><![CDATA[<h3 id="Input-password"><a href="#Input-password" class="headerlink" title="Input password"></a><em>Input password</em></h3><p>or you can not use openssl<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cryptsetup luksFormat --cipher aes-xts-plain64 --key-size 512 --hash sha256 /dev/vdb     </span><br><span class="line">WARNING!     </span><br><span class="line">========     </span><br><span class="line">This will overwrite data on /dev/vdb irrevocably.     </span><br><span class="line">     </span><br><span class="line">Are you sure? (Type uppercase yes): YES      </span><br><span class="line">Enter passphrase:      </span><br><span class="line">Verify passphrase:</span><br></pre></td></tr></table></figure></p>
<h3 id="mapper-test-device"><a href="#mapper-test-device" class="headerlink" title="mapper test device"></a><em>mapper test device</em></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cryptsetup luksOpen /dev/vdb <span class="built_in">test</span>     </span><br><span class="line">Enter passphrase <span class="keyword">for</span> /dev/vdb:     </span><br><span class="line">``` </span><br><span class="line"><span class="comment">###     </span></span><br><span class="line">or     </span><br><span class="line"><span class="comment">###     </span></span><br><span class="line">``` bash</span><br><span class="line"><span class="built_in">cd</span> /dev/shm     </span><br><span class="line">openssl rand 128 -hex -out ./key     </span><br><span class="line">openssl aes-256-cbc -in ./key -out key.enc     </span><br><span class="line"></span><br><span class="line">Verifying - enter aes-256-cbc encryption password:</span><br><span class="line">openssl aes-256-cbc <span class="_">-d</span> -in ./key.enc | cryptsetup [--allow-discards] --key-file=- luksOpen /dev/vdb <span class="built_in">test</span>     </span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">If you have a SSD, you may want to use --allow-discards. It creates an information leak but it enhances your SSD’s lifetime.     </span><br><span class="line"></span><br><span class="line">``` bash</span><br><span class="line">mkfs.ext4 /dev/mapper/<span class="built_in">test</span>     </span><br><span class="line">cryptsetup luksDump /dev/vdb     </span><br><span class="line">     </span><br><span class="line">``` bash     </span><br><span class="line">LUKS header information <span class="keyword">for</span> /dev/vdb     </span><br><span class="line">Key Slot 0: ENABLED     </span><br><span class="line">	Iterations:         	80604     </span><br><span class="line">	Salt:               	c4 c0 08 9c 77 ef 57 a5 d2 62 f4 94 03 56 24 7a      </span><br><span class="line">	                      	86 0c f4 c6 06 6f 9e 01 80 <span class="built_in">fc</span> 0f 1d 3b a9 59 87      </span><br><span class="line">	Key material offset:	8     </span><br><span class="line">	AF stripes:            	4000     </span><br><span class="line">Key Slot 1: DISABLED</span><br></pre></td></tr></table></figure>
<h3 id="Add-remove-key"><a href="#Add-remove-key" class="headerlink" title="Add/remove key"></a><em>Add/remove key</em></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cryptsetup luksAddKey --key-slot 1 /dev/vdb     </span><br><span class="line">cryptsetup luksRemoveKey /dev/vdb</span><br></pre></td></tr></table></figure>
<h3 id="Back-restore-header"><a href="#Back-restore-header" class="headerlink" title="Back/restore header"></a><em>Back/restore header</em></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cryptsetup luksHeaderBackup /dev/vdb --header-backup-file /root/vdb-header-backup     </span><br><span class="line">cryptsetup luksHeaderRestore /dev/vdb --header-backup-file /root/vdb-header-backup</span><br></pre></td></tr></table></figure>
<h3 id="is-luks-partition"><a href="#is-luks-partition" class="headerlink" title="is luks partition"></a><em>is luks partition</em></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cryptsetup -v isLuks /dev/vdb</span><br></pre></td></tr></table></figure>
<h3 id="Clean-luks-partition"><a href="#Clean-luks-partition" class="headerlink" title="Clean luks partition"></a><em>Clean luks partition</em></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">head -c 3145728 /dev/zero &gt; /dev/vdb;sync</span><br></pre></td></tr></table></figure>
<p>The default LUKS header (with only one key-slot enabled) takes 1052672 bytes, what is slightly more than 1 MiB. Having 2 key-slots enabled this would extend the header almost twice (key-slots <em> stripes </em> keysize + offset bytes). Therefore overwriting the first 3 MiB would do the job for us </p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Replace HDD for openzfs]]></title>
      <url>http://yoursite.com/2015/12/04/Replace-HDD-for-openzfs/</url>
      <content type="html"><![CDATA[<h3 id="Replace-HDD-when-raidz-has-degraded"><a href="#Replace-HDD-when-raidz-has-degraded" class="headerlink" title="Replace HDD when raidz has degraded"></a>Replace HDD when raidz has degraded</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$  zpool replace tank <span class="_">-f</span> sdar</span><br><span class="line">$  zpool status</span><br><span class="line">  pool: tank</span><br><span class="line"> state: DEGRADED</span><br><span class="line">status: One or more devices is currently being resilvered.  The pool will</span><br><span class="line">        <span class="built_in">continue</span> to <span class="keyword">function</span>, possibly <span class="keyword">in</span> a degraded state.</span><br><span class="line">action: Wait <span class="keyword">for</span> the resilver to complete.</span><br><span class="line">  scan: resilver <span class="keyword">in</span> progress since Wed Aug 19 01:45:26 2015</span><br><span class="line">    91.6M scanned out of 66.9T at 9.16M/s, (scan is slow, no estimated time)</span><br><span class="line">    3.94M resilvered, 0.00% <span class="keyword">done</span></span><br><span class="line">......</span><br><span class="line">          raidz2-3                  DEGRADED     0     0     0</span><br><span class="line">            sdal                    ONLINE       0     0     0</span><br><span class="line">            sdam                    ONLINE       1    90     0</span><br><span class="line">            sdan                    ONLINE       0     0     0</span><br><span class="line">            sdao                    ONLINE       0     0     0</span><br><span class="line">            sdap                    ONLINE       0     0     0</span><br><span class="line">            sdaq                    ONLINE       0     0     0</span><br><span class="line">            replacing-6             UNAVAIL      0     0     0</span><br><span class="line">              old                   UNAVAIL    101     0     0</span><br><span class="line">              sdar                  ONLINE       0     0     0  (resilvering)</span><br><span class="line">            sdas                    ONLINE       0     0     0</span><br><span class="line">            sdat                    ONLINE       0     0     0</span><br><span class="line">            sdau                    ONLINE       0     0     0</span><br><span class="line">            sdav                    ONLINE       0     0     0</span><br><span class="line">        spares</span><br><span class="line">          scsi-35000c50021387d97    AVAIL</span><br><span class="line">          sdak                      AVAIL</span><br><span class="line">          sdaw                      AVAIL</span><br></pre></td></tr></table></figure>
<h3 id="Replace-broken-HDD-and-insert-a-new-HDD-to-JBOD-enclosure"><a href="#Replace-broken-HDD-and-insert-a-new-HDD-to-JBOD-enclosure" class="headerlink" title="Replace broken HDD, and insert a new HDD to JBOD enclosure"></a>Replace broken HDD, and insert a new HDD to JBOD enclosure</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">$ zpool status</span><br><span class="line">  pool: tank</span><br><span class="line"> state: DEGRADED</span><br><span class="line">status: One or more devices is currently being resilvered.  The pool will</span><br><span class="line">        <span class="built_in">continue</span> to <span class="keyword">function</span>, possibly <span class="keyword">in</span> a degraded state.</span><br><span class="line">action: Wait <span class="keyword">for</span> the resilver to complete.</span><br><span class="line">  scan: resilver <span class="keyword">in</span> progress since Wed Aug 19 01:45:26 2015</span><br><span class="line">    90.5G scanned out of 66.9T at 232M/s, 83h45m to go</span><br><span class="line">    4.09G resilvered, 0.13% <span class="keyword">done</span></span><br><span class="line">config:</span><br><span class="line"></span><br><span class="line">        NAME                        STATE     READ WRITE CKSUM</span><br><span class="line">        tank                        DEGRADED     0     0     0</span><br><span class="line">          raidz2-0                  DEGRADED     0     0     0</span><br><span class="line">            scsi-35000c500212bff8b  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212bed8f  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212c24d7  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212c1bdb  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212b9a0b  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c50034d625f7  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500575f9a87  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212baaeb  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212bdcd3  UNAVAIL     33     0     0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ ls /dev/disk/by-id/scsi-35000c500212bdcd3</span><br><span class="line">ls: cannot access /dev/disk/by-id/scsi-35000c500212bdcd3: No such file or directory</span><br><span class="line"></span><br><span class="line">$ zpool replace tank scsi-35000c500212bdcd3</span><br><span class="line">cannot open <span class="string">'scsi-35000c500212bdcd3'</span>: no such device <span class="keyword">in</span> /dev</span><br><span class="line">must be a full path or shorthand device name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ dmesg</span><br><span class="line">.....</span><br><span class="line">Aug 19 01:32:40 xxxx-host kernel: sd 1:0:53:0: [sdk] Spinning up disk....................ready</span><br><span class="line">Aug 19 01:32:40 xxxx-host kernel: sd 1:0:53:0: [sdk] 3907029168 512-byte logical blocks: (2.00 TB/1.81 TiB)</span><br><span class="line">Aug 19 01:32:40 xxxx-host kernel: sd 1:0:53:0: [sdk] Write Protect is off</span><br><span class="line">Aug 19 01:32:40 xxxx-host kernel: sd 1:0:53:0: [sdk] Write cache: enabled, <span class="built_in">read</span> cache: enabled, supports DPO and FUA</span><br><span class="line">Aug 19 01:32:40 xxxx-host kernel: sdk: unknown partition table</span><br><span class="line">Aug 19 01:32:40 xxxx-host kernel: sd 1:0:53:0: [sdk] Attached SCSI disk</span><br><span class="line"></span><br><span class="line"><span class="comment">#new hdd is sdk</span></span><br><span class="line">$ zpool add tank spare sdk</span><br><span class="line">        spares</span><br><span class="line">          scsi-35000c50021387d97    AVAIL</span><br><span class="line">          sdak                      AVAIL</span><br><span class="line">          sdaw                      AVAIL</span><br><span class="line">          sdk                       AVAIL</span><br><span class="line"></span><br><span class="line">$ zpool replace tank scsi-35000c500212bdcd3 sdk</span><br><span class="line">  scan: resilver <span class="keyword">in</span> progress since Wed Aug 19 01:57:53 2015</span><br><span class="line">    141M scanned out of 66.9T at 7.83M/s, (scan is slow, no estimated time)</span><br><span class="line">    8.72M resilvered, 0.00% <span class="keyword">done</span></span><br><span class="line">config:</span><br><span class="line"></span><br><span class="line">        NAME                          STATE     READ WRITE CKSUM</span><br><span class="line">        tank                          DEGRADED     0     0     0</span><br><span class="line">          raidz2-0                    DEGRADED     0     0     0</span><br><span class="line">            scsi-35000c500212bff8b    ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212bed8f    ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212c24d7    ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212c1bdb    ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212b9a0b    ONLINE       0     0     0</span><br><span class="line">            scsi-35000c50034d625f7    ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500575f9a87    ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212baaeb    ONLINE       0     0     0</span><br><span class="line">            spare-8                   UNAVAIL      0     0     0</span><br><span class="line">              scsi-35000c500212bdcd3  UNAVAIL     33     0     0</span><br><span class="line">              sdk                     ONLINE       0     0     0  (resilvering)</span><br></pre></td></tr></table></figure>
<p>Well done, it’s worked.</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Openzfs tips]]></title>
      <url>http://yoursite.com/2015/12/04/Openzfs-tips/</url>
      <content type="html"><![CDATA[<h3 id="Compression"><a href="#Compression" class="headerlink" title="Compression"></a>Compression</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> compression=lz4 tank</span><br><span class="line">zfs <span class="built_in">set</span> compression=gzip-9 tank</span><br></pre></td></tr></table></figure>
<h3 id="Xattr"><a href="#Xattr" class="headerlink" title="Xattr"></a>Xattr</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> xattr=sa tank</span><br></pre></td></tr></table></figure>
<h3 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> acltype=posixacl tank/gentoo/home</span><br><span class="line">zfs get acltype tank/gentoo/home</span><br></pre></td></tr></table></figure>
<h3 id="Rmount"><a href="#Rmount" class="headerlink" title="Rmount"></a>Rmount</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> mountpoint=/var/lib/mysql tank/mysql</span><br><span class="line">zfs umount tank/mysql</span><br><span class="line">zfs mount tank/mysql</span><br></pre></td></tr></table></figure>
<h3 id="Zpool-rename"><a href="#Zpool-rename" class="headerlink" title="Zpool rename"></a>Zpool rename</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zpool <span class="built_in">export</span> app</span><br><span class="line">zpool import app apps</span><br></pre></td></tr></table></figure>
<h3 id="Detach-hdd-from-mirror"><a href="#Detach-hdd-from-mirror" class="headerlink" title="Detach hdd from mirror"></a>Detach hdd from mirror</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">zpool detach tank sdz <span class="comment">#detach zda from mirror-17</span></span><br><span class="line">only sdal <span class="keyword">in</span> mirror-17, and mirror-17 is missing</span><br><span class="line"></span><br><span class="line">          mirror-16  ONLINE       0     0     0</span><br><span class="line">            sdai     ONLINE       0     0     0</span><br><span class="line">            sdaj     ONLINE       0     0     0</span><br><span class="line">          sdal       ONLINE       0     0     0</span><br><span class="line">          mirror-18  ONLINE       0     0     0</span><br><span class="line">            sdam     ONLINE       0     0     0</span><br><span class="line">            sdan     ONLINE       0     0     0</span><br></pre></td></tr></table></figure>
<h3 id="Attach-one-hdd-to-mirror"><a href="#Attach-one-hdd-to-mirror" class="headerlink" title="Attach one hdd to mirror"></a>Attach one hdd to mirror</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">zpool attach tank sdal sdz</span><br><span class="line">          mirror-17  ONLINE       0     0     0</span><br><span class="line">            sdal     ONLINE       0     0     0</span><br><span class="line">            sdz      ONLINE       0     0     0  (resilvering)</span><br></pre></td></tr></table></figure>
<h3 id="dir"><a href="#dir" class="headerlink" title="dir"></a>dir</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zfs create tank/<span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<h3 id="Quota"><a href="#Quota" class="headerlink" title="Quota"></a>Quota</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> quota=1024G tank/<span class="built_in">test</span></span><br><span class="line"><span class="comment"># disable</span></span><br><span class="line">zfs <span class="built_in">set</span> quota=none tank</span><br></pre></td></tr></table></figure>
<h3 id="user-quota"><a href="#user-quota" class="headerlink" title="user quota"></a>user quota</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> userquota@nagios=2G tank</span><br><span class="line">dd <span class="keyword">if</span>=/dev/zero of=/tank01/<span class="built_in">test</span>/nagios bs=1M</span><br><span class="line">dd: writing /tank/<span class="built_in">test</span>/nagios:Disk quota exceeded</span><br><span class="line"></span><br><span class="line"><span class="comment"># zfs get userquota@nagios </span></span><br><span class="line">NAME            PROPERTY          VALUE             SOURCE</span><br><span class="line">tank01          userquota@nagios  2G                <span class="built_in">local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># group</span></span><br><span class="line">zfs <span class="built_in">set</span> groupquota@staff=10G tank/staff/admins</span><br></pre></td></tr></table></figure>
<h3 id="Limit-memory-usage"><a href="#Limit-memory-usage" class="headerlink" title="Limit memory usage"></a>Limit memory usage</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> xxx &gt; /sys/module/zfs/parameters/zfs_arc_max</span><br><span class="line">cat xxx &gt; /sys/module/zfs/parameters/zfs_arc_min</span><br><span class="line"></span><br><span class="line">cat /etc/modprobe.d/zfs.conf <span class="comment"># Min 4096MB / Max 8192MB limit</span></span><br><span class="line">options zfs zfs_arc_min=4294967296</span><br><span class="line">options zfs zfs_arc_max=8589934592</span><br><span class="line"><span class="comment">#ZFS Device I/O Queue Depth</span></span><br><span class="line">options zfs zfs_vdev_max_pending=24</span><br><span class="line"></span><br><span class="line">modprobe zfs zfs_arc_min=4294967296</span><br></pre></td></tr></table></figure>
<h3 id="Custome-mount-path"><a href="#Custome-mount-path" class="headerlink" title="Custome mount path"></a>Custome mount path</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">zpool import  -R / tank-1 <span class="comment">#mount to /tank-1</span></span><br><span class="line"></span><br><span class="line">or </span><br><span class="line"></span><br><span class="line">zfs <span class="built_in">set</span> mountpoint=/zfs tank</span><br><span class="line">zfs get mountpoint tank</span><br></pre></td></tr></table></figure>
<h3 id="Add-and-remove-hotspare"><a href="#Add-and-remove-hotspare" class="headerlink" title="Add and remove hotspare"></a>Add and remove hotspare</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zpool add tank spare c1t4d0 c1t5d0</span><br><span class="line">zpool remove tank c1t5d0</span><br></pre></td></tr></table></figure>
<h3 id="Clear-zfs-label"><a href="#Clear-zfs-label" class="headerlink" title="Clear zfs label"></a>Clear zfs label</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zpool labelclear /dev/sdxxx</span><br></pre></td></tr></table></figure>
<h3 id="Lz4-Compression-ratio"><a href="#Lz4-Compression-ratio" class="headerlink" title="Lz4 Compression ratio"></a>Lz4 Compression ratio</h3><p>backup 5TB<br>zfs lz4: 3.5TB</p>
<p>home 582G<br>zfs lz4: 337G</p>
<p>project 3TB<br>zfs lz4: 1.7TB </p>
<h3 id="Auto-rebuild"><a href="#Auto-rebuild" class="headerlink" title="Auto rebuild"></a>Auto rebuild</h3><p><a href="https://github.com/zfsonlinux/zfs/issues/2449" target="_blank" rel="external">Autoreplace not working</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zpool <span class="built_in">set</span> autoreplace=on tank</span><br></pre></td></tr></table></figure></p>
<h3 id="Show-performance"><a href="#Show-performance" class="headerlink" title="Show performance"></a>Show performance</h3><p>Mapping /dev/shm/zil_cache to loop0p1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=/dev/shm/zil_cache bs=1M count=4096</span><br><span class="line">$ losetup -v <span class="_">-f</span> /dev/shm/zil_cache</span><br><span class="line">$ losetup <span class="_">-a</span></span><br><span class="line">/dev/loop0: [0018]:55156303 (/dev/shm/zil_cache)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add zil by mirror</span></span><br><span class="line"><span class="comment"># zpool add tank log mirror /dev/loop0p1 /dev/loop0p2, because it 's test file from /dev/shm</span></span><br><span class="line">$ zpool add tank <span class="built_in">log</span> /dev/loop0p1</span><br><span class="line">$ zpool iostat -v 2</span><br><span class="line"></span><br><span class="line">pool                                            alloc   free   <span class="built_in">read</span>  write   <span class="built_in">read</span>  write</span><br><span class="line">----------------------------------------------  -----  -----  -----  -----  -----  -----</span><br><span class="line">tank                                            24.4G  1.30T      0  8.74K      0   575M</span><br><span class="line">  scsi-3600605b005811bf01db36f957f619f26-part1  24.4G  1.30T      0  5.50K      0   448M</span><br><span class="line">logs                                                -      -      -      -      -      -</span><br><span class="line">  loop0p1                                        102M  3.87G      0  3.23K      0   127M</span><br><span class="line">----------------------------------------------  -----  -----  -----  -----  -----  -----</span><br><span class="line"></span><br><span class="line">                                                   capacity     operations    bandwidth</span><br><span class="line">pool                                            alloc   free   <span class="built_in">read</span>  write   <span class="built_in">read</span>  write</span><br><span class="line">----------------------------------------------  -----  -----  -----  -----  -----  -----</span><br><span class="line">tank                                            24.4G  1.30T      0  8.69K      0   581M</span><br><span class="line">  scsi-3600605b005811bf01db36f957f619f26-part1  24.4G  1.30T      0  5.52K      0   455M</span><br><span class="line">logs                                                -      -      -      -      -      -</span><br><span class="line">  loop0p1                                        108M  3.86G      0  3.17K      0   126M</span><br><span class="line">----------------------------------------------  -----  -----  -----  -----  -----  -----</span><br><span class="line"></span><br><span class="line">$ zpool remove tank loop0p1</span><br><span class="line">$ losetup <span class="_">-d</span> /dev/loop0</span><br></pre></td></tr></table></figure>
<h3 id="Tuning-for-Scrubs-and-Resilvers"><a href="#Tuning-for-Scrubs-and-Resilvers" class="headerlink" title="Tuning for Scrubs and Resilvers"></a><a href="http://broken.net/uncategorized/zfs-performance-tuning-for-scrubs-and-resilvers/" target="_blank" rel="external">Tuning for Scrubs and Resilvers</a></h3><p>Prioritize resilvering by setting the delay to zero</p>
<ul>
<li>set zfs:zfs_resilver_delay = 0</li>
</ul>
<p>Prioritize scrubs by setting the delay to zero</p>
<ul>
<li>set zfs:zfs_scrub_delay = 0</li>
</ul>
<p>set maximum number of inflight IOs to a reasonable value - this number will vary for your environment</p>
<ul>
<li>set zfs:zfs_top_maxinflight = 128</li>
</ul>
<p>resilver for five seconds per TXG</p>
<ul>
<li>set zfs:zfs_resilver_min_time_ms = 5000</li>
</ul>
<p><a href="http://zfsonlinux.org/docs.html" target="_blank" rel="external">http://zfsonlinux.org/docs.html</a><br><a href="http://ispire.me/if-zfs-is-eating-your-memory/" target="_blank" rel="external">http://ispire.me/if-zfs-is-eating-your-memory/</a><br><a href="https://bbs.archlinux.org/viewtopic.php?id=171559" target="_blank" rel="external">https://bbs.archlinux.org/viewtopic.php?id=171559</a><br><a href="http://broken.net/uncategorized/zfs-performance-tuning-for-scrubs-and-resilvers/" target="_blank" rel="external">http://broken.net/uncategorized/zfs-performance-tuning-for-scrubs-and-resilvers/</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Online dropbox with socks5 proxy (command line)]]></title>
      <url>http://yoursite.com/2015/12/01/Online-dropbox-with-socks5-proxy-command-line/</url>
      <content type="html"><![CDATA[<p><a href="https://www.dropboxforum.com/hc/en-us/community/posts/204324076-Drop-manual-proxy-setting-not-working-" target="_blank" rel="external">Manual proxy setting not working</a><br>I have the same problem. </p>
<p>Linux Distribution: <a href="http://pinguyos.com" target="_blank" rel="external">PinguyOS</a> base ubuntu 14.04.3 LTS</p>
<p>Try<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> http_proxy=socks5://username:passwd@socks5_proxy_ip:port</span><br></pre></td></tr></table></figure></p>
<p>It’s not work too.</p>
<p>Forward socks proxy to http<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo aptitude install privoxy</span><br><span class="line"></span><br><span class="line">$ cat /etc/privoxy/config</span><br><span class="line">...</span><br><span class="line">listen-address 127.0.0.1:1081</span><br><span class="line">forward-socks5 / 127.0.0.1:1080 .</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ sudo /etc/init.d/privoxy start</span><br></pre></td></tr></table></figure></p>
<p>Try again<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> http_proxy=<span class="string">"http://127.0.0.1:1081"</span></span><br><span class="line">$ ~/.dropbox-dist/dropboxd</span><br><span class="line">or </span><br><span class="line">$ dropbox start -i</span><br></pre></td></tr></table></figure></p>
<p>Nice, It’s worked<br><img src="/img/dropbox_online.png" alt=""> </p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Recover openzfs partition table]]></title>
      <url>http://yoursite.com/2015/11/20/Recover%20openzfs%20partition%20table/</url>
      <content type="html"><![CDATA[<h3 id="backup-partition-table"><a href="#backup-partition-table" class="headerlink" title="backup partition table"></a>backup partition table</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MBR</span></span><br><span class="line">sfdisk <span class="_">-d</span> /dev/sda &gt; /tmp/sda.bak</span><br><span class="line">sfdisk /dev/sda &lt; /tmp/sda.bak</span><br><span class="line"></span><br><span class="line">dd <span class="keyword">if</span>=/dev/sda of=/dev/sdb bs=512 count=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># GPT</span></span><br><span class="line">sgdisk --backup=table /dev/sda</span><br><span class="line">sgdisk --load-backup=table /dev/sdb</span><br><span class="line">sgdisk -G /dev/sdb</span><br><span class="line"></span><br><span class="line">B=$(parted -ms /dev/sda <span class="built_in">print</span> |tail -1|cut -b1)</span><br><span class="line">A=$((128*B)+1024)</span><br><span class="line"></span><br><span class="line">dd <span class="keyword">if</span>=/dev/sda of=GPT_TABLE bs=1 count=<span class="variable">$A</span></span><br><span class="line">dd <span class="keyword">if</span>=GPT_TABLE of=/dev/sdb</span><br><span class="line">partprobe /dev/sdb</span><br></pre></td></tr></table></figure>
<p>Backup is very important</p>
<h3 id="Damage-command"><a href="#Damage-command" class="headerlink" title="Damage command"></a>Damage command</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">950  parted /dev/sdb rm 1</span><br><span class="line">951  df -h</span><br><span class="line">952  zpool status</span><br><span class="line">953  zpool destroy tank</span><br><span class="line">954  yum remove $(rpm -qa | grepzfs)</span><br><span class="line">955 parted <span class="_">-a</span> cylinder /dev/sdb mkpart primary 0 100%</span><br><span class="line"><span class="comment"># same parted commmand with created</span></span><br></pre></td></tr></table></figure>
<p>zpool -D improt failed, </p>
<h3 id="Found-uberblock-tag-label"><a href="#Found-uberblock-tag-label" class="headerlink" title="Found uberblock tag label"></a>Found uberblock tag label</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dd if=/dev/sdb1 of=label-2m bs=1M count=2</span></span><br></pre></td></tr></table></figure>
<p>The begin address is 011bc00-128KB, and after 256KB is the uberblock<br>You can use zdb -l 256KB-file, you could get zpool info<br><img src="/img/uberblock_tag.png" alt=""></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># awk 'BEGIN&#123;printf "%x",0x011bc00-0x0020000"\n"&#125;'</span></span><br><span class="line">fbc00</span><br><span class="line"><span class="comment"># awk 'BEGIN&#123;printf "%x",0x011bc00+0x0020000"\n"&#125;'</span></span><br><span class="line">13bc00</span><br></pre></td></tr></table></figure>
<p>The address is from fbc00 to 13bc00</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'BEGIN&#123;print (strtonum("0xfbc00"))/1024&#125;'</span></span><br><span class="line">1007</span><br></pre></td></tr></table></figure>
<p>The begin address in 1007K of the disk (sdb1)</p>
<h3 id="Create-a-new-zpool-in-another-disk"><a href="#Create-a-new-zpool-in-another-disk" class="headerlink" title="Create a new zpool in another disk"></a>Create a new zpool in another disk</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># parted -a cylinder /dev/sdd mkpart primary 0 100%a</span></span><br><span class="line"><span class="comment"># zpool create tank /dev/sdd1</span></span><br><span class="line"><span class="comment"># dd if=/dev/sdd1 of=label-sdd bs=1M count=2</span></span><br></pre></td></tr></table></figure>
<p><img src="/img/uberblock_tag2.png" alt=""><br>The tag at 0021000, and there are nothing in previous part except zero</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dd if=/dev/zero of=/dev/sdc1 bs=4k count=1</span></span><br><span class="line"><span class="comment"># dd if=/dev/sdb1 of=/dev/sdc1 bs=512 skip=2014 #offset 1007KB</span></span><br></pre></td></tr></table></figure>
<p>You can use zdb get infomation from sdc1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">version: 5000</span><br><span class="line">name: <span class="string">'tank'</span></span><br><span class="line">state: 2</span><br><span class="line">txg: 1256237</span><br><span class="line">pool_guid: 10281825564445304044</span><br><span class="line">errata: 0</span><br><span class="line">hostname: <span class="string">'nas-56-11.local'</span></span><br><span class="line">top_guid: 8832263634429449792</span><br><span class="line">guid: 8832263634429449792</span><br><span class="line">vdev_children: 1</span><br><span class="line">vdev_tree:</span><br><span class="line">    <span class="built_in">type</span>: <span class="string">'disk'</span></span><br><span class="line">    id: 0</span><br><span class="line">    guid: 8832263634429449792</span><br><span class="line">    path: <span class="string">'/dev/sdb1'</span></span><br><span class="line">    whole_disk: 1</span><br><span class="line">    metaslab_array: 33</span><br><span class="line">    metaslab_<span class="built_in">shift</span>: 37</span><br><span class="line">    ashift: 12</span><br><span class="line">    asize: 17990975750144</span><br><span class="line">    is_<span class="built_in">log</span>: 0</span><br><span class="line">    create_txg: 4</span><br></pre></td></tr></table></figure>
<p>When you dd complete. Use “zpool -D import tank” import the loss pool.<br>The disk is a hardraid , There are 17TB important data in it. It really scared the heck out of me.<br>Really Thank Javen Wu very much, Because your help these data could be recovery.</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[CentOS 7 HA configuration (3 nodes and kvm stonith)]]></title>
      <url>http://yoursite.com/2015/11/12/CentOS7%20HA%20configuration/</url>
      <content type="html"><![CDATA[<h3 id="Just-for-test-not-in-my-production-environment-it-is-incomplete"><a href="#Just-for-test-not-in-my-production-environment-it-is-incomplete" class="headerlink" title="Just for test , not in my production environment, it is incomplete"></a>Just for test , not in my production environment, it is incomplete</h3><ul>
<li>3 nodes linux HA replace 2 nodes</li>
<li>fence kvm</li>
</ul>
<h3 id="Physical-node-OS"><a href="#Physical-node-OS" class="headerlink" title="Physical node OS"></a>Physical node OS</h3><ul>
<li>CentOS Linux release 7.1.1503 (Core) </li>
<li>3.10.0-229.14.1.el7.x86_64</li>
</ul>
<h3 id="Virtual-machine-OS"><a href="#Virtual-machine-OS" class="headerlink" title="Virtual machine OS"></a>Virtual machine OS</h3><ul>
<li>CentOS release 6.7 (Final)</li>
<li>2.6.32-504.30.3.el6_lustre.x86_64</li>
<li>Not support SR-IOV</li>
<li>Virtaul disk cache set to none</li>
</ul>
<h3 id="Create-linux-HA-3-x-physical-server"><a href="#Create-linux-HA-3-x-physical-server" class="headerlink" title="Create linux HA ,3 x physical server"></a>Create linux HA ,3 x physical server</h3><p>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<br>10.xx.xx.1 node01<br>10.xx.xx.2 node02<br>10.xx.xx.3 node03</p>
<h3 id="Share-strorages"><a href="#Share-strorages" class="headerlink" title="Share strorages"></a>Share strorages</h3><p>NFS/Lustre</p>
<h3 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum -y install pacemaker corosync fence-agents-all fence-agents-virsh \</span></span><br><span class="line">  fence-virt pacemaker-remote pcs fence-virtd resource-agents \</span><br><span class="line">  fence-virtd-libvirt fence-virtd-multicast</span><br></pre></td></tr></table></figure>
<h3 id="Setup-physical-server"><a href="#Setup-physical-server" class="headerlink" title="Setup physical server"></a>Setup physical server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># echo hacluster | passwd --stdin hacluster</span></span><br><span class="line"><span class="comment"># systemctl enable pcsd.service</span></span><br><span class="line"><span class="comment"># systemctl start pcsd.service</span></span><br><span class="line"><span class="comment"># systemctl is-active pcsd.service</span></span><br><span class="line"><span class="comment"># pcs cluster auth node01 node02 node03 ##input hacluster password for auth</span></span><br><span class="line"><span class="comment"># pcs cluster setup --start --name ha-kvm node01 node02 node03</span></span><br><span class="line"><span class="comment"># pcs property set no-quorum-policy=stop</span></span><br></pre></td></tr></table></figure>
<p>4.1.2 Option no-quorum-policy</p>
<p>This global option defines what to do when a cluster partition does not have quorum (no majority of nodes is part of the partition).</p>
<p>Allowed values are:</p>
<p>ignore<br>The quorum state does not influence the cluster behavior; resource management is continued.</p>
<p>This setting is useful for the following scenarios:</p>
<p>Two-node clusters: Since a single node failure would always result in a loss of majority, usually you want the cluster to carry on regardless. Resource integrity is ensured using fencing, which also prevents split brain scenarios.</p>
<p>Resource-driven clusters: For local clusters with redundant communication channels, a split brain scenario only has a certain probability. Thus, a loss of communication with a node most likely indicates that the node has crashed, and that the surviving nodes should recover and start serving the resources again.</p>
<p>If no-quorum-policy is set to ignore, a 4-node cluster can sustain concurrent failure of three nodes before service is lost. With the other settings, it would lose quorum after concurrent failure of two nodes.</p>
<p>freeze<br>If quorum is lost, the cluster partition freezes. Resource management is continued: running resources are not stopped (but possibly restarted in response to monitor events), but no further resources are started within the affected partition.</p>
<p>This setting is recommended for clusters where certain resources depend on communication with other nodes (for example, OCFS2 mounts). In this case, the default setting no-quorum-policy=stop is not useful, as it would lead to the following scenario: Stopping those resources would not be possible while the peer nodes are unreachable. Instead, an attempt to stop them would eventually time out and cause a stop failure, triggering escalated recovery and fencing.</p>
<p>stop (default value)<br>If quorum is lost, all resources in the affected cluster partition are stopped in an orderly fashion.</p>
<p>suicide<br>If quorum is lost, all nodes in the affected cluster partition are fenced.</p>
<h3 id="Setting-etc-corosync-corosync-conf-for-every-node"><a href="#Setting-etc-corosync-corosync-conf-for-every-node" class="headerlink" title="Setting /etc/corosync/corosync.conf for every node"></a>Setting /etc/corosync/corosync.conf for every node</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">totem &#123;</span><br><span class="line">    version: 2</span><br><span class="line">    secauth: off</span><br><span class="line">    rrp_mode:active</span><br><span class="line">    cluster_name: ha-kvm</span><br><span class="line">    transport: udpu</span><br><span class="line">    token: 17000</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nodelist &#123;</span><br><span class="line">  node &#123;</span><br><span class="line">	ring0_addr: 10.xx.xx.1</span><br><span class="line">        ring1_addr: 172.xx.xx.1</span><br><span class="line">        nodeid: 1</span><br><span class="line">       &#125;</span><br><span class="line">  node &#123;</span><br><span class="line">        ring0_addr: 10.xx.xx.3</span><br><span class="line">        ring1_addr: 172.xx.xx.3</span><br><span class="line">        nodeid: 2</span><br><span class="line">       &#125;</span><br><span class="line">  node &#123;</span><br><span class="line">        ring0_addr: 10.xx.xx.2</span><br><span class="line">        ring1_addr: 172.xx.xx.2</span><br><span class="line">        nodeid: 3</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">quorum &#123;</span><br><span class="line">    provider: corosync_votequorum</span><br><span class="line">    expected_votes: 3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line">        fileline: off</span><br><span class="line">        to_logfile: yes</span><br><span class="line">        to_syslog: yes</span><br><span class="line">        logfile: /var/<span class="built_in">log</span>/cluster/corosync.log</span><br><span class="line">        timestamp: on</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Restart-corosync-service-in-each-node"><a href="#Restart-corosync-service-in-each-node" class="headerlink" title="Restart corosync service in each node"></a>Restart corosync service in each node</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl restart corosync</span></span><br></pre></td></tr></table></figure>
<h3 id="Create-stonith-for-physical-server"><a href="#Create-stonith-for-physical-server" class="headerlink" title="Create stonith for physical server"></a>Create stonith for physical server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pcs stonith create node01-fencing fence_ipmilan pcmk_host_list="nod01 node02 node03" \</span></span><br><span class="line">ipaddr=<span class="string">"node1_ipmi_ipaddr"</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_<span class="built_in">wait</span>=4 \</span><br><span class="line">op monitor interval=60s</span><br><span class="line"><span class="comment"># pcs stonith create node02-fencing fence_ipmilan pcmk_host_list="nod01 node02 node03" \</span></span><br><span class="line"> ipaddr=<span class="string">"node2_ipmi_ipaddr"</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_<span class="built_in">wait</span>=4 \</span><br><span class="line">op monitor interval=60s</span><br><span class="line"><span class="comment"># pcs stonith create node03-fencing fence_ipmilan pcmk_host_list="nod01 node02 node03" \</span></span><br><span class="line">ipaddr=<span class="string">"node3_ipmi_ipaddr"</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_<span class="built_in">wait</span>=4 op \</span><br><span class="line">monitor interval=60s</span><br><span class="line"></span><br><span class="line"><span class="comment"># pcs property set stonith-enabled=true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pcs status</span></span><br><span class="line">Cluster name: ha-kvm</span><br><span class="line">Last updated: Wed Nov 11 16:42:46 2015</span><br><span class="line">Last change: Wed Nov 11 02:48:26 2015 by root via crm_resource on node01</span><br><span class="line">Stack: corosync</span><br><span class="line">Current DC: node01 (version 1.1.13<span class="_">-a</span>14efad) - partition with quorum</span><br><span class="line">3 nodes and 5 resources configured</span><br><span class="line"></span><br><span class="line">Online: [ node02 node03 node01 ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> node01-fencing	(stonith:fence_ipmilan):	Started node02</span><br><span class="line"> node03-fencing	(stonith:fence_ipmilan):	Started node01</span><br><span class="line"> node02-fencing	(stonith:fence_ipmilan):	Started node03</span><br><span class="line"></span><br><span class="line">PCSD Status:</span><br><span class="line">  node03: Online</span><br><span class="line">  node01: Online</span><br><span class="line">  node02: Online</span><br><span class="line"></span><br><span class="line">Daemon Status:</span><br><span class="line">  corosync: active/enabled</span><br><span class="line">  pacemaker: active/enabled</span><br><span class="line">  pcsd: active/enabled</span><br></pre></td></tr></table></figure>
<h3 id="Get-quorum-info"><a href="#Get-quorum-info" class="headerlink" title="Get quorum info"></a>Get quorum info</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># corosync-quorumtool -siH</span></span><br><span class="line">Quorum information</span><br><span class="line">------------------</span><br><span class="line">Date:             Thu Nov 12 04:49:31 2015</span><br><span class="line">Quorum provider:  corosync_votequorum</span><br><span class="line">Nodes:            3</span><br><span class="line">Node ID:          0x00000002</span><br><span class="line">Ring ID:          260</span><br><span class="line">Quorate:          Yes</span><br><span class="line"></span><br><span class="line">Votequorum information</span><br><span class="line">----------------------</span><br><span class="line">Expected votes:   3</span><br><span class="line">Highest expected: 3</span><br><span class="line">Total votes:      3</span><br><span class="line">Quorum:           2  </span><br><span class="line">Flags:            Quorate </span><br><span class="line"></span><br><span class="line">Membership information</span><br><span class="line">----------------------</span><br><span class="line">    Nodeid      Votes Name</span><br><span class="line">0x00000003          1 10.0.0.80</span><br><span class="line">0x00000001          1 10.0.10.97</span><br><span class="line">0x00000002          1 10.0.10.106 (<span class="built_in">local</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Install-kvm"><a href="#Install-kvm" class="headerlink" title="Install kvm"></a>Install kvm</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install qemu-kvm libcacard qemu-kvm-common libvirt</span></span><br></pre></td></tr></table></figure>
<h3 id="Create-HA-resource-for-kvm"><a href="#Create-HA-resource-for-kvm" class="headerlink" title="Create HA resource for kvm"></a>Create HA resource for kvm</h3><p>Delete cpu model in your xml file for prevent virsh start faild.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">'custom'</span> <span class="attr">match</span>=<span class="string">'exact'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">model</span> <span class="attr">fallback</span>=<span class="string">'allow'</span>&gt;</span>SandyBridge<span class="tag">&lt;/<span class="name">model</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cpu</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">'custom'</span> <span class="attr">match</span>=<span class="string">'exact'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">model</span> <span class="attr">fallback</span>=<span class="string">'allow'</span>&gt;</span>Westmere<span class="tag">&lt;/<span class="name">model</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cpu</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pcs resource create mds-01 VirtualDomain hypervisor="qemu:///system" \</span></span><br><span class="line">config=<span class="string">"/xxx/mds01.xml"</span>  meta remote-node=<span class="string">"mds-01"</span></span><br><span class="line"><span class="comment"># pcs resource create mds-02 VirtualDomain hypervisor="qemu:///system" \</span></span><br><span class="line">config=<span class="string">"/xxx/mds02.xml"</span>  meta remote-node=<span class="string">"mds-02"</span></span><br></pre></td></tr></table></figure>
<p>###Configure the pysical node for stonith<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install fence-virt fence-virtd fence-virtd-multicast fence-virtd-libvirt</span></span><br><span class="line"><span class="comment"># fence_virtd -c</span></span><br><span class="line">Accept all the defaults except <span class="keyword">for</span> the items listed below, and the multicast IP and TCP port <span class="keyword">if</span> you selected non-default ones:</span><br><span class="line">Setting a preferred interface causes fence_virtd to listen only</span><br><span class="line"> on that interface.  Normally, it listens on all interfaces.</span><br><span class="line"> In environments <span class="built_in">where</span> the virtual machines are using the host</span><br><span class="line"> machine as a gateway, this *must* be <span class="built_in">set</span> (typically to virbr0).</span><br><span class="line"> Set to <span class="string">'none'</span> <span class="keyword">for</span> no interface.</span><br><span class="line"> </span><br><span class="line"> Interface [none]: br1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">You can accept the default (none) <span class="keyword">if</span> the guests have IPs on the <span class="built_in">local</span> LAN. Here, we assume they <span class="keyword">do</span> not.</span><br><span class="line">Key File [none]: /etc/cluster/fence_xvm.key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">This ensures only machines with the same key can initiate fencing requests.</span><br><span class="line">At the end, it will ask</span><br><span class="line">Replace /etc/fence_virt.conf with the above [y/N]? y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Say yes.</span><br><span class="line">You should end up with a configuration like this <span class="keyword">in</span> /etc/fence_virt.conf:</span><br><span class="line">backends &#123;</span><br><span class="line">         libvirt &#123;</span><br><span class="line">                 uri = <span class="string">"qemu:///system"</span>;</span><br><span class="line">         &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> listeners &#123;</span><br><span class="line">         multicast &#123;</span><br><span class="line">                 key_file = <span class="string">"/etc/cluster/fence_xvm.key"</span>;</span><br><span class="line">                 interface = <span class="string">"virbr0"</span>;</span><br><span class="line">                 port = <span class="string">"1229"</span>;</span><br><span class="line">                 address = <span class="string">"225.0.0.12"</span>;</span><br><span class="line">                 family = <span class="string">"ipv4"</span>;</span><br><span class="line">         &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> fence_virtd &#123;</span><br><span class="line">         backend = <span class="string">"libvirt"</span>;</span><br><span class="line">         listener = <span class="string">"multicast"</span>;</span><br><span class="line">         module_path = <span class="string">"/usr/lib64/fence-virt"</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># mkdir -p /etc/cluster</span></span><br><span class="line"><span class="comment"># dd if=/dev/urandom bs=4k count=1 of=/etc/cluster/fence_xvm.key</span></span><br><span class="line"><span class="comment"># chmod 0600 /etc/cluster/fence_xvm.key</span></span><br></pre></td></tr></table></figure></p>
<p>Required changes to the “address” value on both nodes<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    (on node1)</span><br><span class="line">    address = <span class="string">"225.0.1.12"</span>;</span><br><span class="line"></span><br><span class="line">    (on node2)</span><br><span class="line">    address = <span class="string">"225.0.2.12"</span>;</span><br><span class="line"></span><br><span class="line">    (on node3)</span><br><span class="line">    address = <span class="string">"225.0.3.12"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># fence_virtd  #start the daemon</span></span><br><span class="line"><span class="comment"># fence_xvm -o list</span></span><br><span class="line">iml-01               e95b2343-7d31-410d-1398-25c98daaaabd on</span><br><span class="line">manager-kvm          24fa85e3-6cc0-4e1e-b8b5-cdd78aca1eff on</span><br><span class="line">mds-02               e95e6534-7a29-419b-9919-22d8cad8ef4d on</span><br></pre></td></tr></table></figure></p>
<h3 id="Configure-the-virtual-machine-for-stonith"><a href="#Configure-the-virtual-machine-for-stonith" class="headerlink" title="Configure the virtual machine for stonith"></a>Configure the virtual machine for stonith</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install fence-virt fence-virtd</span></span><br><span class="line"><span class="comment"># mkdir -p /etc/cluster</span></span><br><span class="line">Copy the shared key from the physical host to vm:/etc/cluster/fence_xvm.key</span><br></pre></td></tr></table></figure>
<h3 id="Create-stonith-resource-for-vm"><a href="#Create-stonith-resource-for-vm" class="headerlink" title="Create stonith resource for vm"></a>Create stonith resource for vm</h3><p>Because I do not know which vm would be running in one physical node. Because there are three physical server,<br>so I create three vm fencing for one vm.</p>
<p>I setup a corosync with pacemaker two node cluster for mds-01 and mds-02<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pcs stonith create xvmfence_mds-01-1 fence_xvm pcmk_host_list="mds-01 mds-02" action="reboot" \</span></span><br><span class="line">key_file=/etc/cluster/fence_xvm.key multicast_address=225.0.1.12</span><br><span class="line"><span class="comment"># pcs stonith create xvmfence_mds-01-2 fence_xvm pcmk_host_list="mds-01 mds-02" action="reboot" \</span></span><br><span class="line">key_file=/etc/cluster/fence_xvm.key multicast_address=225.0.2.12</span><br><span class="line"><span class="comment"># pcs stonith create xvmfence_mds-01-3 fence_xvm pcmk_host_list="mds-01 mds-02" action="reboot" \</span></span><br><span class="line">key_file=/etc/cluster/fence_xvm.key multicast_address=225.0.3.12</span><br><span class="line"><span class="comment"># pcs stonith create xvmfence_mds-02-1 fence_xvm pcmk_host_list="mds-01 mds-02" action="reboot" \</span></span><br><span class="line">key_file=/etc/cluster/fence_xvm.key multicast_address=225.0.1.12</span><br><span class="line"><span class="comment"># pcs stonith create xvmfence_mds-02-2 fence_xvm pcmk_host_list="mds-01 mds-02" action="reboot" \</span></span><br><span class="line">key_file=/etc/cluster/fence_xvm.key multicast_address=225.0.2.12</span><br><span class="line"><span class="comment"># pcs stonith create xvmfence_mds-02-3 fence_xvm pcmk_host_list="mds-01 mds-02" action="reboot" \</span></span><br><span class="line">key_file=/etc/cluster/fence_xvm.key multicast_address=225.0.3.12</span><br><span class="line"></span><br><span class="line"><span class="comment"># pcs status</span></span><br><span class="line">Cluster name: </span><br><span class="line">Last updated: Thu Nov 12 08:36:34 2015</span><br><span class="line">Last change: Thu Nov 12 08:34:47 2015</span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: mds-01 - partition with quorum</span><br><span class="line">Version: 1.1.11-97629de</span><br><span class="line">2 Nodes configured, 2 expected votes</span><br><span class="line">6 Resources configured</span><br><span class="line">Online: [ mds-01 mds-02 ]</span><br><span class="line">Full list of resources:</span><br><span class="line"> xvmfence_mds-01-1	(stonith:fence_xvm):	Started mds-01 </span><br><span class="line"> xvmfence_mds-01-2	(stonith:fence_xvm):	Started mds-02 </span><br><span class="line"> xvmfence_mds-01-3	(stonith:fence_xvm):	Started mds-01 </span><br><span class="line"> xvmfence_mds-02-1	(stonith:fence_xvm):	Started mds-02 </span><br><span class="line"> xvmfence_mds-02-2	(stonith:fence_xvm):	Started mds-01 </span><br><span class="line"> xvmfence_mds-02-3	(stonith:fence_xvm):	Started mds-02 </span><br><span class="line"></span><br><span class="line"><span class="comment"># Settting level for clsuter</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pcs stonith level add 1 mds-01 xvmfence_mds-01-1</span></span><br><span class="line"><span class="comment"># pcs stonith level add 2 mds-01 xvmfence_mds-01-2</span></span><br><span class="line"><span class="comment"># pcs stonith level add 3 mds-01 xvmfence_mds-01-3</span></span><br><span class="line"><span class="comment"># pcs stonith level add 1 mds-01 xvmfence_mds-02-1</span></span><br><span class="line"><span class="comment"># pcs stonith level add 2 mds-01 xvmfence_mds-02-2</span></span><br><span class="line"><span class="comment"># pcs stonith level add 3 mds-01 xvmfence_mds-02-3</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Test-vm-stonith"><a href="#Test-vm-stonith" class="headerlink" title="Test vm stonith"></a>Test vm stonith</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@mds-02 ~]<span class="comment"># fence_xvm -a 225.0.3.12 -k /etc/cluster/fence_xvm.key -H mds-01 -o status</span></span><br><span class="line">Status: ON  (It means mds-01 running <span class="keyword">in</span> node3)</span><br><span class="line">[root@mds-02 ~]<span class="comment"># fence_xvm -a 225.0.1.12 -k /etc/cluster/fence_xvm.key -H mds-01 -o status</span></span><br><span class="line">Status: OFF</span><br><span class="line">[root@mds-02 ~]<span class="comment"># fence_xvm -a 225.0.2.12 -k /etc/cluster/fence_xvm.key -H mds-01 -o status</span></span><br><span class="line">Status: OFF</span><br><span class="line"></span><br><span class="line">[root@mds-02 ~]<span class="comment"># fence_xvm -a 225.0.1.12 -k /etc/cluster/fence_xvm.key -H mds-02 -o status</span></span><br><span class="line">Status: ON  (It means mds-02 running <span class="keyword">in</span> node1)</span><br><span class="line">[root@mds-02 ~]<span class="comment"># fence_xvm -a 225.0.2.12 -k /etc/cluster/fence_xvm.key -H mds-02 -o status</span></span><br><span class="line">Status: OFF</span><br><span class="line">[root@mds-02 ~]<span class="comment"># fence_xvm -a 225.0.3.12 -k /etc/cluster/fence_xvm.key -H mds-02 -o status</span></span><br><span class="line">Status: OFF</span><br><span class="line"></span><br><span class="line">fence mds-02</span><br><span class="line">[root@mds-01 ~]<span class="comment"># pcs stonith fence mds-02</span></span><br><span class="line">Node: mds-02 fenced</span><br><span class="line">[root@mds-02 ~]<span class="comment"># Write failed: Broken pipe</span></span><br><span class="line"></span><br><span class="line">fence mds-01</span><br><span class="line">[root@mds-02 ~]<span class="comment"># pcs stonith fence mds-01</span></span><br><span class="line">Node: mds-01 fenced</span><br><span class="line">[root@mds-01 ~]<span class="comment"># Write failed: Broken pipe</span></span><br></pre></td></tr></table></figure>
<p>There is one Mellanox ConnectX-3 adapter could not work well in my test environment.<br>I checked config again and again until I upgrded the driver, it could work well.<br>Third time to waste my time in Mellanox ethernet adapter, until now I don’t think it’s a good choice.</p>
<p>Reference<br><a href="http://clusterlabs.org/wiki/Guest_Fencing" target="_blank" rel="external">http://clusterlabs.org/wiki/Guest_Fencing</a><br><a href="https://access.redhat.com/solutions/293183" target="_blank" rel="external">https://access.redhat.com/solutions/293183</a><br><a href="https://access.redhat.com/solutions/917833" target="_blank" rel="external">https://access.redhat.com/solutions/917833</a><br><a href="https://alteeve.ca/w/Fencing_KVM_Virtual_Servers#Configuring_fence_xvm" target="_blank" rel="external">https://alteeve.ca/w/Fencing_KVM_Virtual_Servers#Configuring_fence_xvm</a><br><a href="http://people.redhat.com/ccaulfie/docs/Votequorum_Intro.pdf" target="_blank" rel="external">http://people.redhat.com/ccaulfie/docs/Votequorum_Intro.pdf</a><br><a href="https://www.ibm.com/developerworks/community/blogs/mhhaque/entry/configure_two_node_highly_available_cluster_using_kvm_fencing_on_rhel7?lang=en" target="_blank" rel="external">https://www.ibm.com/developerworks/community/blogs/mhhaque/entry/configure_two_node_highly_available_cluster_using_kvm_fencing_on_rhel7?lang=en</a><br><a href="https://www.suse.com/documentation/sle_ha/book_sleha/data/sec_ha_config_basics_global.html?view=print" target="_blank" rel="external">https://www.suse.com/documentation/sle_ha/book_sleha/data/sec_ha_config_basics_global.html?view=print</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Tips-hard drive disk]]></title>
      <url>http://yoursite.com/2015/11/06/Tips-hard-drive-disk/</url>
      <content type="html"><![CDATA[<h3 id="Enable-Disable-SAS-HDD-write-cache"><a href="#Enable-Disable-SAS-HDD-write-cache" class="headerlink" title="Enable/Disable SAS HDD write cache"></a>Enable/Disable SAS HDD write cache</h3><p>Write Cache Enable<br>WCE=1 enable<br>WCE=0 disable</p>
<p>Read Cache Disable<br>RCD=0 disable<br>RCD=1 enable</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sdparm <span class="_">-s</span> WCE=1, RCD=0 -S /dev/sdxx</span><br><span class="line">sdparm <span class="_">-a</span> /dev/sdxx</span><br></pre></td></tr></table></figure>
<h3 id="SATA-HDD-write-cache"><a href="#SATA-HDD-write-cache" class="headerlink" title="SATA HDD write cache"></a>SATA HDD write cache</h3><p>W0 Off<br>W1 On<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hdparm -W0 /dev/sda</span><br><span class="line">hdparm -W /dev/sdx</span><br><span class="line"></span><br><span class="line">hdparm -W1 /dev/sda</span><br><span class="line">hdparm -W /dev/sdx</span><br></pre></td></tr></table></figure></p>
<h3 id="Check-HDD"><a href="#Check-HDD" class="headerlink" title="Check HDD"></a>Check HDD</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">smartctl -t long /dev/sdx</span><br><span class="line">smartctl -t short /dev/sdx</span><br></pre></td></tr></table></figure>
<h3 id="Delete-Rescan-block-scsi-device"><a href="#Delete-Rescan-block-scsi-device" class="headerlink" title="Delete/Rescan block scsi device"></a>Delete/Rescan block scsi device</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># echo 1 &gt; /sys/block/sdXX/device/delete</span></span><br><span class="line"><span class="comment"># echo "- - -" &gt; /sys/class/scsi_host/hostXX/scan</span></span><br></pre></td></tr></table></figure>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Some of Important HDD spec]]></title>
      <url>http://yoursite.com/2015/11/06/Some%20of%20Important%20HDD%20spec/</url>
      <content type="html"><![CDATA[<h2 id="Enterprise-HDD"><a href="#Enterprise-HDD" class="headerlink" title="Enterprise HDD"></a>Enterprise HDD</h2><h3 id="Rotational-Speed-10K～15K"><a href="#Rotational-Speed-10K～15K" class="headerlink" title="Rotational Speed 10K～15K"></a>Rotational Speed 10K～15K</h3><p>Error Rate (non-recoverable, bits read)  1 sector per 10E16<br> Mean Time Between Failures (MTBF, hours)   &lt;2M<br>Availability (hrs/day x days/wk)  24x7</p>
<h3 id="Rotational-Speed-7200"><a href="#Rotational-Speed-7200" class="headerlink" title="Rotational Speed 7200"></a>Rotational Speed 7200</h3><p>Error Rate (non-recoverable, bits read)  1 sector per 10E15<br>Mean Time Between Failures (MTBF, hours)  &gt;1.2M<br>Availability (hrs/day x days/wk)  24x7</p>
<p><img src="/img/hdd-spec.png" alt=""></p>
<p>there are 3 differents sector size in seagate product</p>
<p><img src="/img/sector-size.png" alt=""></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Deploy Lustre and OpenZFS]]></title>
      <url>http://yoursite.com/2015/11/06/Deploy%20Lustre%20and%20OpenZFS/</url>
      <content type="html"><![CDATA[<h2 id="Hardware"><a href="#Hardware" class="headerlink" title="Hardware"></a>Hardware</h2><h3 id="MDS"><a href="#MDS" class="headerlink" title="MDS"></a>MDS</h3><ul>
<li>2 x SuperMicro SSG-6028R-E1CR12N (Xeon 2650 v3 8*16G)</li>
<li>1 x 2U JBOD (216be26-r920lpb) 14 x ST600MP0005 + 2x ST200FM0002 </li>
<li>2 x LSI Syncro CS 9286-8e (installed in MDS)<br><del>test-test-test</del></li>
</ul>
<h3 id="OSS"><a href="#OSS" class="headerlink" title="OSS"></a>OSS</h3><ul>
<li>4 x SuperMicro SSG-6028R-E1CR12N (Xeon 2630v3 8*8G)</li>
<li>4 x JBOD (SC847DE26-R2K02JBOD, installed 74 x ST6000NM0034) </li>
<li>8 x LSI SAS2308 (installed in OSS)</li>
</ul>
<h2 id="Software"><a href="#Software" class="headerlink" title="Software"></a>Software</h2><ul>
<li>OS: CentOS 6.6 x64 2.6.32-504.30.3.el6_lustre.x86_64</li>
<li>Lustre: 2.5.37.7 (Intel ieel 2.3)</li>
<li>OpenZFS: 0.6.4-1</li>
</ul>
<h3 id="LSI-syncro-Architecture"><a href="#LSI-syncro-Architecture" class="headerlink" title="LSI syncro Architecture"></a>LSI syncro Architecture</h3><p><img src="/img/mds.png" alt=""></p>
<h3 id="MDS-Architecture"><a href="#MDS-Architecture" class="headerlink" title="MDS Architecture"></a>MDS Architecture</h3><p><img src="/img/mds-1.png" alt=""></p>
<h3 id="OSS-Architecture"><a href="#OSS-Architecture" class="headerlink" title="OSS Architecture"></a>OSS Architecture</h3><p><img src="/img/oss.png" alt=""></p>
<h2 id="The-Installation-Process"><a href="#The-Installation-Process" class="headerlink" title="The Installation Process"></a>The Installation Process</h2><h3 id="Configure-LSI-syncro-for-MDS"><a href="#Configure-LSI-syncro-for-MDS" class="headerlink" title="Configure LSI syncro for MDS"></a>Configure LSI syncro for MDS</h3><p><img src="/img/config_syncro.png" alt=""></p>
<p>/opt/MegaRAID/storcli/storcli64 /c1 show all</p>
<p>High Availability :</p>
<p>Topology Type = Server Storage Cluster<br>Domain Id = xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx<br>Peer Controller Status = Active<br>Maximum Controller Nodes = 2<br>Incompatible Details = None</p>
<h3 id="Install-rpms-for-MDS"><a href="#Install-rpms-for-MDS" class="headerlink" title="Install rpms for MDS"></a>Install rpms for MDS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh dracut-004-388.el6.noarch.rpm dracut-kernel-004-388.el6.noarch.rpm</span><br><span class="line">rpm -ivh e2fsprogs-1.42.12.wc1-7.el6.x86_64.rpm e2fsprogs-1.42.12.wc1-bundle.tar.gz e2fsprogs libs-1.42.12.wc1-7.el6.x86_64.rpm libcom_err-1.42.12.wc1-7.el6.x86_64.rpm libss-1.42.12.wc1-7.el6.x86_64.rpm</span><br><span class="line"></span><br><span class="line">rpm -ivh kernel-2.6.32-504.30.3.el6_lustre.x86_64.rpm kernel-devel-2.6.32-504.30.3.el6_lustre.x86_64.rpm kernel-firmware-2.6.32-504.30.3.el6_lustre.x86_64.rpm kernel-headers-2.6.32-504.30.3.el6_lustre.x86_64.rpm lustre-modules-2.5.37.7-2.6.32_504.30.3.el6_lustre.x86_64.x86_64.rpm lustre-2.5.37.7-2.6.32_504.30.3.el6_lustre.x86_64.x86_64.rpm lustre-osd-ldiskfs-2.5.37.7-2.6.32_504.30.3.el6_lustre.x86_64.x86_64.rpm lustre-osd-ldiskfs-mount-2.5.37.7-2.6.32_504.30.3.el6_lustre.x86_64.x86_64.rpm</span><br></pre></td></tr></table></figure>
<h3 id="Configuration-file-for-MDS"><a href="#Configuration-file-for-MDS" class="headerlink" title="Configuration file for MDS"></a>Configuration file for MDS</h3><p>disable selinux and iptables<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span>  <span class="string">"options lnet networks=tcp(bond0)"</span> &gt; /etc/modprobe.d/lnet.conf</span><br><span class="line">bond0 is data transfer network device</span><br><span class="line"></span><br><span class="line">pvcreate /dev/sdb</span><br><span class="line">vgcreate mds_data /dev/sdb</span><br><span class="line">lvcreate <span class="_">-l</span> 2%VG -n mgt_lv mds_data</span><br><span class="line">lvcreate <span class="_">-l</span> 98%VG -n mdt_lv mds_data</span><br></pre></td></tr></table></figure></p>
<p>If you want deactivate it , you can use “vgchange -cn volume group”</p>
<h3 id="Exclude-os-volume-group"><a href="#Exclude-os-volume-group" class="headerlink" title="Exclude os volume group"></a>Exclude os volume group</h3><p>edit /etc/lvm/lvm.conf in mds1<br><figure class="highlight apacheconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">volume_list</span> =<span class="meta"> [ "vg_mds1", "@MDS-11-1" ]</span></span><br><span class="line"><span class="attribute">locking_type</span> = 1</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dracut <span class="_">-f</span> </span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>
<h3 id="Create-Lustre-file-system-for-MDS"><a href="#Create-Lustre-file-system-for-MDS" class="headerlink" title="Create Lustre file system for MDS"></a>Create Lustre file system for MDS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkfs.lustre --reformat --mgs --servicenode=10.x.x.1@tcp --servicenode=10.x.x.2@tcp /dev/mapper/mds_data-mgt_lv</span><br><span class="line"></span><br><span class="line">mkfs.lustre --reformat --mdt --fsname=lustrewh --index=0 --mgsnode=10.xx.xx.1@tcp --mgsnode=10.xx.xx.2@tcp  --servicenode=10.x.x.1@tcp --servicenode=10.x.x.2@tcp  /dev/mapper/mds_data-mdt_lv</span><br></pre></td></tr></table></figure>
<p>You can mount the device where you want<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/dev/mapper/mds_data-mdt_lv  lustre  2.5T  328M  2.3T   1% /lustre/mdt</span><br><span class="line">/dev/mapper/mds_data-mgt_lv  lustre  66G   54M   63G   1% /lustre/mgt</span><br></pre></td></tr></table></figure></p>
<h3 id="Prepare-create-HA-cluster"><a href="#Prepare-create-HA-cluster" class="headerlink" title="Prepare create HA cluster"></a>Prepare create HA cluster</h3><p>MDS1  eth0 192.xx.xx.1 (ipmi)<br>      eth1 192.168.1.1 (heartbeat)<br>      eth4 10.xx.xx.1  (production data)</p>
<p>MDS2  eth0 192.xx.xx.2<br>      eth1 192.168.1.2<br>      eth4 10.xx.xx.2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y pacemaker corosync pcs fence-agents resource-agents</span><br></pre></td></tr></table></figure>
<p>config corosync.conf to /etc/corosync/</p>
<h3 id="corosync-conf-j2-ansible"><a href="#corosync-conf-j2-ansible" class="headerlink" title="corosync.conf.j2 (ansible)"></a>corosync.conf.j2 (ansible)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#Please read the corosync.conf.5 manual page</span></span><br><span class="line">compatibility: whitetank</span><br><span class="line"></span><br><span class="line">totem &#123;</span><br><span class="line">	version: <span class="number">2</span></span><br><span class="line">	secauth: off</span><br><span class="line">	interface &#123;</span><br><span class="line">		member &#123;</span><br><span class="line">			memberaddr: &#123;&#123; nicA1 &#125;&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		member &#123;</span><br><span class="line">			memberaddr: &#123;&#123; nicB1 &#125;&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		ringnumber: <span class="number">0</span></span><br><span class="line">		bindnetaddr: &#123;&#123; bind1 &#125;&#125;</span><br><span class="line">		mcastport: <span class="number">5406</span></span><br><span class="line">		ttl: <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	interface &#123;</span><br><span class="line">                member &#123;</span><br><span class="line">                        memberaddr: &#123;&#123; nicA2 &#125;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">                member &#123;</span><br><span class="line">                        memberaddr: &#123;&#123; nicB2 &#125;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">                ringnumber: <span class="number">1</span></span><br><span class="line">                bindnetaddr: &#123;&#123; bind2 &#125;&#125;</span><br><span class="line">                mcastport: <span class="number">5406</span></span><br><span class="line">                ttl: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">	transport: udpu</span><br><span class="line">	token: <span class="number">17000</span></span><br><span class="line">	rrp_mode: passive</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line">	fileline: off</span><br><span class="line">	to_logfile: yes</span><br><span class="line">	to_syslog: yes</span><br><span class="line">	debug: on</span><br><span class="line">	logfile: /var/<span class="built_in">log</span>/cluster/corosync.<span class="built_in">log</span></span><br><span class="line">	debug: off</span><br><span class="line">	timestamp: on</span><br><span class="line">	logger_subsys &#123;</span><br><span class="line">		subsys: AMF</span><br><span class="line">		debug: off</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="etc-corosync-service-d-pacemaker"><a href="#etc-corosync-service-d-pacemaker" class="headerlink" title="/etc/corosync/service.d/pacemaker"></a>/etc/corosync/service.d/pacemaker</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">service &#123;</span><br><span class="line">        <span class="meta"># Load the Pacemaker Cluster Resource Manager</span></span><br><span class="line">        name: pacemaker</span><br><span class="line">        ver:  <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="etc-hosts"><a href="#etc-hosts" class="headerlink" title="/etc/hosts"></a>/etc/hosts</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">:<span class="number">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line"><span class="number">10.</span>xx.xx<span class="number">.1</span>  MDS<span class="bullet">-11</span><span class="bullet">-1</span></span><br><span class="line"><span class="number">10.</span>xx.xx<span class="number">.2</span>  MDS<span class="bullet">-11</span><span class="bullet">-2</span></span><br><span class="line"><span class="number">10.</span>xx.xx<span class="number">.4</span>  OSS<span class="bullet">-11</span><span class="bullet">-4</span></span><br><span class="line"><span class="number">10.</span>xx.xx<span class="number">.5</span>  OSS<span class="bullet">-11</span><span class="bullet">-5</span></span><br><span class="line"><span class="number">10.</span>xx.xx<span class="number">.6</span>  OSS<span class="bullet">-11</span><span class="bullet">-6</span></span><br><span class="line"><span class="number">10.</span>xx.xx<span class="number">.7</span>  OSS<span class="bullet">-11</span><span class="bullet">-7</span></span><br><span class="line"><span class="number">192.</span>xx.xx<span class="number">.1</span> MDS<span class="bullet">-11</span><span class="bullet">-1.</span>ipmi</span><br><span class="line"><span class="number">192.</span>xx.xx<span class="number">.2</span> MDS<span class="bullet">-11</span><span class="bullet">-2.</span>ipmi</span><br><span class="line"><span class="number">192.</span>xx.xx<span class="number">.4</span> OSS<span class="bullet">-11</span><span class="bullet">-4.</span>ipmi</span><br><span class="line"><span class="number">192.</span>xx.xx<span class="number">.5</span> OSS<span class="bullet">-11</span><span class="bullet">-5.</span>ipmi</span><br><span class="line"><span class="number">192.</span>xx.xx<span class="number">.6</span> OSS<span class="bullet">-11</span><span class="bullet">-6.</span>ipmi</span><br><span class="line"><span class="number">192.</span>xx.xx<span class="number">.7</span> OSS<span class="bullet">-11</span><span class="bullet">-7.</span>ipmi</span><br></pre></td></tr></table></figure>
<p>If you need install IML, keep the same with your HOSTNAME environment variable and dns resolve.</p>
<h3 id="Synchronizing-time-for-each-server"><a href="#Synchronizing-time-for-each-server" class="headerlink" title="Synchronizing time for each server"></a>Synchronizing time for each server</h3><p>go to <a href="http://www.pool.ntp.org/en/#top" target="_blank" rel="external">http://www.pool.ntp.org/en/#top</a></p>
<h3 id="Enable-service"><a href="#Enable-service" class="headerlink" title="Enable service"></a>Enable service</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/corosync start</span><br><span class="line">/etc/init.d/pacemaker restart</span><br><span class="line">/etc/init.d/pcsd start</span><br><span class="line">chkconfig --level 35 corosync on</span><br><span class="line">chkconfig --level 35 pacemaker on</span><br><span class="line">chkconfig --level 35 pcsd on</span><br></pre></td></tr></table></figure>
<h3 id="Create-HA-cluster-for-MDS"><a href="#Create-HA-cluster-for-MDS" class="headerlink" title="Create HA cluster for MDS"></a>Create HA cluster for MDS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">pcs property <span class="built_in">set</span> no-quorum-policy=ignore</span><br><span class="line">pcs property <span class="built_in">set</span> stonith-enabled=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">pcs stonith create mds-11-1-fencing fence_ipmilan pcmk_host_list=<span class="string">"OSS-11-4.local"</span> ipaddr=<span class="string">"192.xx.xx.1"</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_<span class="built_in">wait</span>=4 op monitor interval=60s</span><br><span class="line">pcs stonith create mds-11-2-fencing fence_ipmilan pcmk_host_list=<span class="string">"OSS-11-4.local"</span> ipaddr=<span class="string">"192.xx.xx.2"</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_<span class="built_in">wait</span>=4 op monitor interval=60s</span><br><span class="line"></span><br><span class="line">pcs resource create Lustre_mgt ocf:heartbeat:Filesystem device=<span class="string">"/dev/mapper/mds_data-mgt_lv"</span> directory=<span class="string">"/lustre/mgt"</span> fstype=<span class="string">"lustre"</span></span><br><span class="line">pcs resource create Lustre_mdt ocf:heartbeat:Filesystem device=<span class="string">"/dev/mapper/mds_data-mdt_lv"</span> directory=<span class="string">"/lustre/mdt"</span> fstype=<span class="string">"lustre"</span></span><br><span class="line"></span><br><span class="line">pcs resource create mds_lv ocf:heartbeat:LVM volgrpname=mds_data exclusive=<span class="literal">true</span></span><br><span class="line">pcs constraint order mds_lv <span class="keyword">then</span> Lustre_mgt</span><br><span class="line">pcs constraint colocation add Lustre_mgt with mds_lv</span><br><span class="line">pcs constraint order mds_lv <span class="keyword">then</span> Lustre_mdt</span><br><span class="line">pcs constraint colocation add Lustre_mdt with mds_lv</span><br><span class="line"></span><br><span class="line">pcs resource update Lustre_mgt op start interval=0 timeout=300</span><br><span class="line">pcs resource update Lustre_mgt op stop interval=0 timeout=300</span><br><span class="line">pcs resource update Lustre_mgt op monitor interval=5</span><br><span class="line">pcs resource update mds_lv op start interval=0 timeout=300</span><br><span class="line">pcs resource update mds_lv op stop interval=0 timeout=300</span><br><span class="line">pcs resource update mds_lv op monitor interval=5</span><br><span class="line">pcs resource update Lustre_mdt op start interval=0 timeout=300</span><br><span class="line">pcs resource update Lustre_mdt op stop interval=0 timeout=300</span><br><span class="line">pcs resource update Lustre_mdt op monitor interval=5 timeout=60</span><br><span class="line">pcs resource meta Lustre_mgt migration-threshold=5</span><br><span class="line">pcs resource meta Lustre_mdt migration-threshold=5</span><br><span class="line">pcs resource meta mds_lv migration-threshold=5</span><br><span class="line">pcs resource meta Lustre_mdt failure-timeout=120</span><br><span class="line">pcs resource meta Lustre_mgt failure-timeout=120</span><br><span class="line">pcs resource meta mds_lv failure-timeout=120</span><br></pre></td></tr></table></figure>
<h4 id="pcs-default-setting"><a href="#pcs-default-setting" class="headerlink" title="pcs default setting"></a>pcs default setting</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pcs resource defaults migration-threshold=5</span><br><span class="line">pcs resource defaults failure-timeout=240s</span><br><span class="line">pcs resource defaults resource-stickiness=100</span><br><span class="line">pcs resource op defaults timeout=240s</span><br><span class="line">pcs property <span class="built_in">set</span> stonith-action=reboot</span><br></pre></td></tr></table></figure>
<h4 id="delete-default-value"><a href="#delete-default-value" class="headerlink" title="delete default value"></a>delete default value</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcs resource defaults timouts=    <span class="comment">#not set any value</span></span><br></pre></td></tr></table></figure>
<h4 id="pcs-status"><a href="#pcs-status" class="headerlink" title="pcs status"></a>pcs status</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Cluster name: </span><br><span class="line"><span class="attr">Stack:</span> classic openais (with plugin)</span><br><span class="line">Current DC: MDS<span class="bullet">-11</span><span class="bullet">-2.</span>local - partition with quorum</span><br><span class="line"><span class="attr">Version:</span> <span class="number">1.1</span><span class="number">.11</span><span class="bullet">-97629</span>de</span><br><span class="line"><span class="number">2</span> Nodes configured, <span class="number">2</span> expected votes</span><br><span class="line"><span class="number">4</span> Resources configured</span><br><span class="line"></span><br><span class="line"><span class="attr">Online:</span> [ MDS<span class="bullet">-11</span><span class="bullet">-1.</span>local MDS<span class="bullet">-11</span><span class="bullet">-2.</span>local ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> mds<span class="bullet">-11</span><span class="bullet">-1</span>-fencing (stonith:fence_ipmilan): Started MDS<span class="bullet">-11</span><span class="bullet">-2.</span>local </span><br><span class="line"> mds<span class="bullet">-11</span><span class="bullet">-2</span>-fencing (stonith:fence_ipmilan): Started MDS<span class="bullet">-11</span><span class="bullet">-2.</span>local </span><br><span class="line"> Lustre_mgt (ocf::heartbeat:Filesystem): Started MDS<span class="bullet">-11</span><span class="bullet">-2.</span>local </span><br><span class="line"> Lustre_mdt (ocf::heartbeat:Filesystem): Started MDS<span class="bullet">-11</span><span class="bullet">-1.</span>local</span><br></pre></td></tr></table></figure>
<h3 id="About-OSS"><a href="#About-OSS" class="headerlink" title="About OSS"></a>About OSS</h3><p>OSS don ‘t like MDS, it ‘s base openzfs not ldiskfs.<br>OSS need be do 5.1 ~ 5.5 like MDS except 5.2, here is different setting</p>
<h3 id="Initialization-OpenZFS"><a href="#Initialization-OpenZFS" class="headerlink" title="Initialization OpenZFS"></a>Initialization OpenZFS</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh e2fsprogs<span class="bullet">-1.42</span><span class="number">.12</span>.wc1<span class="bullet">-7.</span>el6.x86_64.rpm e2fsprogs<span class="bullet">-1.42</span><span class="number">.12</span>.wc1-bundle.tar.gz e2fsprogs libs<span class="bullet">-1.42</span><span class="number">.12</span>.wc1<span class="bullet">-7.</span>el6.x86_64.rpm libcom_err<span class="bullet">-1.42</span><span class="number">.12</span>.wc1<span class="bullet">-7.</span>el6.x86_64.rpm libss<span class="bullet">-1.42</span><span class="number">.12</span>.wc1<span class="bullet">-7.</span>el6.x86_64.rpm</span><br><span class="line"></span><br><span class="line">rpm -ivh dracut<span class="bullet">-004</span><span class="bullet">-388.</span>el6.noarch.rpm dracut-kernel<span class="bullet">-004</span><span class="bullet">-388.</span>el6.noarch.rpm</span><br><span class="line"></span><br><span class="line">rpm -ivh kernel<span class="bullet">-2.6</span><span class="number">.32</span><span class="bullet">-504.30</span><span class="number">.3</span>.el6_lustre.x86_64.rpm kernel-devel<span class="bullet">-2.6</span><span class="number">.32</span><span class="bullet">-504.30</span><span class="number">.3</span>.el6_lustre.x86_64.rpm kernel-firmware<span class="bullet">-2.6</span><span class="number">.32</span><span class="bullet">-504.30</span><span class="number">.3</span>.el6_lustre.x86_64.rpm kernel-headers<span class="bullet">-2.6</span><span class="number">.32</span><span class="bullet">-504.30</span><span class="number">.3</span>.el6_lustre.x86_64.rpm</span><br></pre></td></tr></table></figure>
<h3 id="Setting-lnet"><a href="#Setting-lnet" class="headerlink" title="Setting lnet"></a>Setting lnet</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span>  <span class="string">"options lnet networks=tcp(bond0)"</span> &gt; /etc/modprobe.d/lnet.conf</span><br></pre></td></tr></table></figure>
<h3 id="Limit-zfs-memory-useage-half-memory-to-avoid-OOM-killer"><a href="#Limit-zfs-memory-useage-half-memory-to-avoid-OOM-killer" class="headerlink" title="Limit zfs memory useage(half memory) ,to avoid OOM killer"></a>Limit zfs memory useage(half memory) ,to avoid OOM killer</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'$0~/MemTotal/ &#123;print "options zfs zfs_arc_max="$2*1024/2&#125;'</span> /proc/meminfo &gt; /etc/modprobe.d/zfs.conf</span><br></pre></td></tr></table></figure>
<p>33720700928 = 32GB</p>
<h3 id="Setting-multipath-SAS-HDD-JBOD"><a href="#Setting-multipath-SAS-HDD-JBOD" class="headerlink" title="Setting multipath (SAS HDD, JBOD)"></a>Setting multipath (SAS HDD, JBOD)</h3><h4 id="etc-multipath-conf"><a href="#etc-multipath-conf" class="headerlink" title="/etc/multipath.conf"></a>/etc/multipath.conf</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">defaults &#123;</span><br><span class="line">polling_interval  <span class="number">10</span></span><br><span class="line">path_selector  <span class="string">"round-robin 0"</span></span><br><span class="line">path_grouping_policy failover</span><br><span class="line">prio   const</span><br><span class="line">path_checker  directio</span><br><span class="line">rr_min_io  <span class="number">1000</span></span><br><span class="line">max_fds   <span class="number">10240</span></span><br><span class="line">rr_weight  priorities</span><br><span class="line">failback  immediate</span><br><span class="line">no_path_retry  fail</span><br><span class="line">user_friendly_names <span class="literal">no</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">blacklist &#123;</span><br><span class="line">        wwid <span class="number">3600304801</span>b1326001d0b4e480378fac8 <span class="comment">##root partition</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If you use Dell MD34xx/NetAPP E27xx,Some of LSI chip in your Raid controller<br>You should change some in multipath.conf</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">defaults &#123;</span><br><span class="line"> polling_interval  <span class="number">10</span></span><br><span class="line"> path_selector  <span class="string">"round-robin 0"</span></span><br><span class="line"> path_grouping_policy group_by_prio</span><br><span class="line"> prio   rdac</span><br><span class="line"> path_checker  rdac</span><br><span class="line"> rr_min_io  <span class="number">1000</span></span><br><span class="line"> max_fds    <span class="number">10240</span></span><br><span class="line"> rr_weight  priorities</span><br><span class="line"> failback  immediate</span><br><span class="line"> no_path_retry  <span class="number">30</span></span><br><span class="line"> user_friendly_names no</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="reboot"><a href="#reboot" class="headerlink" title="reboot"></a>reboot</h3><h3 id="Install-OpenZFS"><a href="#Install-OpenZFS" class="headerlink" title="Install OpenZFS"></a>Install OpenZFS</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh spl<span class="bullet">-0.6</span><span class="number">.4</span><span class="number">.1</span><span class="bullet">-1.</span>el6.src.rpm zfs<span class="bullet">-0.6</span><span class="number">.4</span><span class="number">.1</span><span class="bullet">-1.</span>el6.src.rpm</span><br><span class="line">rpmbuild -bb -v spl.spec</span><br><span class="line">rpmbuild -bb -v zfs.spec</span><br><span class="line">rpm -ivh spl<span class="bullet">-0.6</span><span class="number">.4</span><span class="number">.1</span><span class="bullet">-1.</span>el6.x86_64.rpm spl-dkms<span class="bullet">-0.6</span><span class="number">.4</span><span class="number">.1</span><span class="bullet">-1.</span>el6.noarch.rpm zfs-dkms<span class="bullet">-0.6</span><span class="number">.4</span><span class="number">.1</span><span class="bullet">-1.</span>el6.noarch.rpm zfs<span class="bullet">-0.6</span><span class="number">.4</span><span class="number">.1</span><span class="bullet">-1.</span>el6.x86_64.rpm libzpool2<span class="bullet">-0.6</span><span class="number">.4</span><span class="number">.1</span><span class="bullet">-1.</span>el6.x86_64.rpm libnvpair1<span class="bullet">-0.6</span><span class="number">.4</span><span class="number">.1</span><span class="bullet">-1.</span>el6.x86_64.rpm libuutil1<span class="bullet">-0.6</span><span class="number">.4</span><span class="number">.1</span><span class="bullet">-1.</span>el6.x86_64.rpm libzfs2<span class="bullet">-0.6</span><span class="number">.4</span><span class="number">.1</span><span class="bullet">-1.</span>el6.x86_64.rpm zfs-dracut<span class="bullet">-0.6</span><span class="number">.4</span><span class="number">.1</span><span class="bullet">-1.</span>el6.x86_64.rpm</span><br></pre></td></tr></table></figure>
<h4 id="Alias-HDD-name-etc-zfs-vdev-id-conf"><a href="#Alias-HDD-name-etc-zfs-vdev-id-conf" class="headerlink" title="Alias HDD name /etc/zfs/vdev_id.conf"></a>Alias HDD name /etc/zfs/vdev_id.conf</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">multipath <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">alias hdd<span class="bullet">-0</span><span class="bullet">-2</span><span class="bullet">-0</span> /dev/disk/by-id/dm-uuid-mpath<span class="bullet">-35000</span>c50062a54f23</span><br><span class="line">alias hdd<span class="bullet">-0</span><span class="bullet">-2</span><span class="bullet">-1</span> /dev/disk/by-id/dm-uuid-mpath<span class="bullet">-35000</span>c500630fde27</span><br><span class="line">alias hdd<span class="bullet">-0</span><span class="bullet">-2</span><span class="bullet">-2</span> /dev/disk/by-id/dm-uuid-mpath<span class="bullet">-35000</span>c50062d67aa7</span><br><span class="line">alias hdd<span class="bullet">-0</span><span class="bullet">-2</span><span class="bullet">-3</span> /dev/disk/by-id/dm-uuid-mpath<span class="bullet">-35000</span>c50062db08ff</span><br><span class="line">.......</span><br><span class="line">alias hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-15</span> /dev/disk/by-id/dm-uuid-mpath<span class="bullet">-35000</span>c50062fdd8cf</span><br></pre></td></tr></table></figure>
<h4 id="Create-zpool"><a href="#Create-zpool" class="headerlink" title="Create zpool"></a>Create zpool</h4><p>If you care performance ,don ‘t use ashift=9, In my case ,capacity is very important.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zpool create <span class="_">-f</span> ost-0 -o cachefile=none -o ashift=9 raidz3 hdd-0-2-0 hdd-0-2-1 hdd-0-2-2 hdd-0-2-3 hdd-0-2-4 hdd-0-2-5 hdd-0-2-6 hdd-0-2-7 hdd-0-2-8 hdd-0-2-9 hdd-2-10 hdd-2-11 spare hdd-0-3-15 hdd-0-5-15</span><br><span class="line">......</span><br></pre></td></tr></table></figure></p>
<h4 id="create-ost"><a href="#create-ost" class="headerlink" title="create ost"></a>create ost</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">zpool status ost<span class="bullet">-11</span></span><br><span class="line"><span class="attr">  pool:</span> ost<span class="bullet">-11</span></span><br><span class="line"><span class="attr"> state:</span> ONLINE</span><br><span class="line"><span class="attr">  scan:</span> resilvered <span class="number">710</span>K in <span class="number">0</span>h0m with <span class="number">0</span> errors on Thu Aug <span class="number">20</span> <span class="number">14</span>:<span class="number">12</span>:<span class="number">35</span> <span class="number">2015</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line"></span><br><span class="line">NAME            STATE     READ WRITE CKSUM</span><br><span class="line">ost<span class="bullet">-11</span>          ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">  raidz3<span class="bullet">-0</span>      ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-1</span>   ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-2</span>   ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-3</span>   ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-5</span>   ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-6</span>   ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-7</span>   ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-9</span>   ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-10</span>  ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-11</span>  ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-12</span>  ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-13</span>  ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-14</span>  ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">spares</span><br><span class="line">  hdd<span class="bullet">-1</span><span class="bullet">-3</span><span class="bullet">-15</span>    AVAIL   </span><br><span class="line">  hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-15</span>    AVAIL</span><br></pre></td></tr></table></figure>
<h4 id="Enable-ZFS-features"><a href="#Enable-ZFS-features" class="headerlink" title="Enable ZFS features"></a>Enable ZFS features</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..11&#125;</span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">    zfs <span class="built_in">set</span> acltype=posixacl ost-<span class="variable">$i</span>; </span><br><span class="line">    zfs <span class="built_in">set</span> compression=lz4 ost-<span class="variable">$i</span>; </span><br><span class="line">    zfs <span class="built_in">set</span> xattr=sa ost-<span class="variable">$i</span>; </span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h4 id="Format-zfs"><a href="#Format-zfs" class="headerlink" title="Format zfs"></a>Format zfs</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..11&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"mkfs.lustre --reformat --ost --backfstype=zfs --fsname=lustrewh --index=<span class="variable">$i</span> --mgsnode=10.xx.xx.1@tcp --mgsnode=10.xx.xx.2@tcp  --servicenode=10.x.x.4@tcp --servicenode=10.x.x.5@tcp</span><br><span class="line">ost-<span class="variable">$i</span>/ost-<span class="variable">$i</span>"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h4 id="Create-HA-cluster"><a href="#Create-HA-cluster" class="headerlink" title="Create HA cluster"></a>Create HA cluster</h4><p>/etc/corosync/corosync.conf<br>/etc/corosync/service.d/pacemaker<br>same with config MDS</p>
<p>Copy hearbeat script to all member of the cluster node<br>Get the file <a href="https://github.com/skiselkov/stmf-ha/blob/master/heartbeat/ZFS" target="_blank" rel="external">https://github.com/skiselkov/stmf-ha/blob/master/heartbeat/ZFS</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 755 /usr/lib/ocf/resource.d/heartbeat/ZFS </span><br><span class="line">chmod 755 /usr/lib/ocf/resource.d/heartbeat/Lustre-ZFS</span><br></pre></td></tr></table></figure></p>
<p>It ‘ s written by Paciucci Gabriele (intel)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Lustre-ZFS </span></span><br><span class="line"><span class="comment">#      Description: Manages a Lustre target on a shared storage medium.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># usage: ./Lustre-ZFS &#123;start|stop|status|monitor|validate-all|meta-data&#125;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#      OCF parameters are as below:</span></span><br><span class="line"><span class="comment">#        OCF_RESKEY_vdev</span></span><br><span class="line"><span class="comment">#	OCF_RESKEY_mountpoint</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># OCF_RESKEY_vdev : name of the target the script should operate on</span></span><br><span class="line"><span class="comment"># OCF_RESKEY_mountpoint : name of the target the script should operate on</span></span><br><span class="line"></span><br><span class="line">: <span class="variable">$&#123;OCF_FUNCTIONS_DIR=$&#123;OCF_ROOT&#125;</span>/resource.d/heartbeat&#125;</span><br><span class="line">. <span class="variable">$&#123;OCF_FUNCTIONS_DIR&#125;</span>/.ocf-shellfuncs</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">usage</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"usage: <span class="variable">$0</span> &#123;start|stop|status|monitor|meta-data&#125;"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">meta_data</span></span>() &#123;</span><br><span class="line">    cat &lt;&lt;END</span><br><span class="line">&lt;?xml version=<span class="string">"1.0"</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE resource-agent SYSTEM <span class="string">"ra-api-1.dtd"</span>&gt;</span><br><span class="line">&lt;resource-agent name=<span class="string">"Lustre-ZFS"</span>&gt;</span><br><span class="line">&lt;version&gt;1.0&lt;/version&gt;</span><br><span class="line"></span><br><span class="line">&lt;longdesc lang=<span class="string">"en"</span>&gt;</span><br><span class="line">Resource script <span class="keyword">for</span> a Lustre ZFS Target.</span><br><span class="line">&lt;/longdesc&gt;</span><br><span class="line"></span><br><span class="line">&lt;shortdesc lang=<span class="string">"en"</span>&gt;Manages Lustre ZFS Targets&lt;/shortdesc&gt;</span><br><span class="line"></span><br><span class="line">&lt;parameters&gt;</span><br><span class="line">&lt;parameter name=<span class="string">"vdev"</span> required=<span class="string">"1"</span>&gt;</span><br><span class="line">&lt;longdesc lang=<span class="string">"en"</span>&gt;</span><br><span class="line">The name of the ZFS vdev.</span><br><span class="line">&lt;/longdesc&gt;</span><br><span class="line">&lt;shortdesc lang=<span class="string">"en"</span>&gt;vdev&lt;/shortdesc&gt;</span><br><span class="line">&lt;content <span class="built_in">type</span>=<span class="string">"string"</span> default=<span class="string">""</span> /&gt;</span><br><span class="line">&lt;/parameter&gt;</span><br><span class="line"></span><br><span class="line">&lt;parameter name=<span class="string">"mountpoint"</span> required=<span class="string">"1"</span>&gt;</span><br><span class="line">&lt;longdesc lang=<span class="string">"en"</span>&gt;</span><br><span class="line">The mount point <span class="keyword">for</span> the target</span><br><span class="line">&lt;/longdesc&gt;</span><br><span class="line">&lt;shortdesc lang=<span class="string">"en"</span>&gt;mountpoint&lt;/shortdesc&gt;</span><br><span class="line">&lt;content <span class="built_in">type</span>=<span class="string">"string"</span> default=<span class="string">""</span> /&gt;</span><br><span class="line">&lt;/parameter&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/parameters&gt;</span><br><span class="line"></span><br><span class="line">&lt;actions&gt;</span><br><span class="line">&lt;action name=<span class="string">"start"</span> timeout=<span class="string">"60"</span> /&gt;</span><br><span class="line">&lt;action name=<span class="string">"stop"</span> timeout=<span class="string">"60"</span> /&gt;</span><br><span class="line">&lt;action name=<span class="string">"notify"</span> timeout=<span class="string">"60"</span> /&gt;</span><br><span class="line">&lt;action name=<span class="string">"monitor"</span> depth=<span class="string">"0"</span> timeout=<span class="string">"40"</span> interval=<span class="string">"20"</span> /&gt;</span><br><span class="line">&lt;action name=<span class="string">"validate-all"</span> timeout=<span class="string">"5"</span> /&gt;</span><br><span class="line">&lt;action name=<span class="string">"meta-data"</span> timeout=<span class="string">"5"</span> /&gt;</span><br><span class="line">&lt;/actions&gt;</span><br><span class="line">&lt;/resource-agent&gt;</span><br><span class="line">END</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">Target_start</span></span>() &#123;</span><br><span class="line">    <span class="comment"># See if the device is already mounted.</span></span><br><span class="line">    <span class="keyword">if</span> Target_status &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">        ocf_<span class="built_in">log</span> info <span class="string">"Target <span class="variable">$TARGET</span> is already started."</span></span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$OCF_SUCCESS</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># this is not necessary, mount should start modules </span></span><br><span class="line"><span class="comment">#    if ! grep -e 'lustre$' /proc/filesystems &gt;/dev/null; then</span></span><br><span class="line"><span class="comment">#        ocf_log err "Couldn't find the lustre module in /proc/filesystems"</span></span><br><span class="line"><span class="comment">#        return $OCF_ERR_ARGS</span></span><br><span class="line"><span class="comment">#    fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># start the target</span></span><br><span class="line"><span class="comment">#    if ! chroma-agent mount_target --uuid $TARGET; then</span></span><br><span class="line">    <span class="keyword">if</span> ! mount -t lustre <span class="variable">$TARGET</span> <span class="variable">$MOUNT_POINT</span>; <span class="keyword">then</span></span><br><span class="line">        ocf_<span class="built_in">log</span> err <span class="string">"Couldn't start target <span class="variable">$TARGET</span>"</span></span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$OCF_ERR_GENERIC</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$OCF_SUCCESS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">Target_notify</span></span>() &#123;</span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$OCF_SUCCESS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">Target_stop</span></span>() &#123;</span><br><span class="line">    <span class="comment"># started already?</span></span><br><span class="line">    Target_status &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">    <span class="keyword">if</span> [ $? <span class="_">-eq</span> <span class="variable">$OCF_NOT_RUNNING</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># woo!  nothing to do.</span></span><br><span class="line">        rc=<span class="variable">$OCF_SUCCESS</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line"><span class="comment">#        chroma-agent unmount_target --uuid $TARGET</span></span><br><span class="line">        umount <span class="variable">$MOUNT_POINT</span> </span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$rc</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">Target_status</span></span>() &#123;</span><br><span class="line">    <span class="comment"># call the agent to see if it's running</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#    if chroma-agent target_running --uuid $TARGET &gt;/dev/null 2&gt;&amp;1; then</span></span><br><span class="line">    <span class="keyword">if</span> cat /proc/mounts |grep <span class="variable">$MOUNT_POINT</span> &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">        rc=<span class="variable">$OCF_SUCCESS</span></span><br><span class="line">        msg=<span class="string">"<span class="variable">$TARGET</span> is started (running)"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        rc=<span class="variable">$OCF_NOT_RUNNING</span></span><br><span class="line">        msg=<span class="string">"<span class="variable">$TARGET</span> is stopped"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$OP</span>"</span> = <span class="string">"status"</span> ]; <span class="keyword">then</span></span><br><span class="line">        ocf_<span class="built_in">log</span> info <span class="string">"<span class="variable">$msg</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$rc</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">Target_validate_all</span></span>() &#123;</span><br><span class="line">	<span class="built_in">return</span> <span class="variable">$OCF_SUCCESS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> <span class="_">-ne</span> 1 ]; <span class="keyword">then</span></span><br><span class="line">    usage</span><br><span class="line">    <span class="built_in">exit</span> <span class="variable">$OCF_ERR_ARGS</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">TARGET=<span class="variable">$OCF_RESKEY_vdev</span></span><br><span class="line">MOUNT_POINT=<span class="variable">$OCF_RESKEY_mountpoint</span></span><br><span class="line">OP=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># These operations do not require instance parameters</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$OP</span> <span class="keyword">in</span></span><br><span class="line">meta-data)    meta_data</span><br><span class="line">              <span class="built_in">exit</span> <span class="variable">$OCF_SUCCESS</span></span><br><span class="line">              ;;</span><br><span class="line">usage)        usage</span><br><span class="line">              <span class="built_in">exit</span> <span class="variable">$OCF_SUCCESS</span></span><br><span class="line">              ;;</span><br><span class="line">status)       Target_status</span><br><span class="line">              <span class="built_in">exit</span> $?</span><br><span class="line">              ;;</span><br><span class="line">monitor)      Target_status</span><br><span class="line">              <span class="built_in">exit</span> $?</span><br><span class="line">              ;;</span><br><span class="line">validate-all) Target_validate_all</span><br><span class="line">              <span class="built_in">exit</span> $?</span><br><span class="line">              ;;</span><br><span class="line">stop)         Target_stop</span><br><span class="line">              <span class="built_in">exit</span> $?</span><br><span class="line">              ;;</span><br><span class="line">start)        Target_start</span><br><span class="line">              ;;</span><br><span class="line">*)            usage</span><br><span class="line">              <span class="built_in">exit</span> <span class="variable">$OCF_ERR_UNIMPLEMENTED</span></span><br><span class="line">              ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="built_in">exit</span> $?</span><br></pre></td></tr></table></figure>
<h4 id="Configuration-HA"><a href="#Configuration-HA" class="headerlink" title="Configuration HA"></a>Configuration HA</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pcs property <span class="built_in">set</span> no-quorum-policy=ignore</span><br><span class="line">pcs property <span class="built_in">set</span> stonith-enabled=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..11&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  pcs resource create ost-<span class="variable">$i</span> ocf:heartbeat:ZFS  pool=ost-<span class="variable">$i</span></span><br><span class="line"> pcs resource update ost-<span class="variable">$i</span> op start interval=0 timeout=360</span><br><span class="line"> pcs resource update ost-<span class="variable">$i</span> op stop interval=0 timeout=360</span><br><span class="line"> pcs resource update ost-<span class="variable">$i</span> op monitor interval=5 timeout=60</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..11&#125;</span><br><span class="line"> <span class="keyword">do</span></span><br><span class="line">    mkdir /lustre_ost<span class="variable">$i</span></span><br><span class="line">    pcs resource create lustre_ost<span class="variable">$i</span> ocf:heartbeat:Lustre-ZFS vdev=<span class="string">"ost-<span class="variable">$i</span>/ost-<span class="variable">$i</span>"</span> mountpoint=<span class="string">"/lustre_ost<span class="variable">$i</span>"</span></span><br><span class="line"> pcs resource update lustre_ost<span class="variable">$i</span> op start interval=0 timeout=360</span><br><span class="line"> pcs resource update lustre_ost<span class="variable">$i</span> op stop interval=0 timeout=360</span><br><span class="line"> pcs resource update lustre_ost<span class="variable">$i</span> op  monitor interval=5 timeout=60</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..11&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">pcs constraint order ost-<span class="variable">$i</span> <span class="keyword">then</span> lustre_ost<span class="variable">$i</span></span><br><span class="line">pcs constraint colocation add lustre_ost<span class="variable">$i</span> with ost-<span class="variable">$i</span></span><br><span class="line">pcs resource meta ost-<span class="variable">$i</span> migration-threshold=5</span><br><span class="line">pcs resource meta lustre_ost<span class="variable">$i</span> migration-threshold=5</span><br><span class="line">pcs resource meta ost-<span class="variable">$i</span> failure-timeout=360</span><br><span class="line">pcs resource meta lustre_ost<span class="variable">$i</span> failure-timeout=360</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">pcs stonith create oss-11-4-fencing fence_ipmilan pcmk_host_list=<span class="string">"OSS-11-4.local"</span> ipaddr=<span class="string">"192.xx.xx.4"</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_<span class="built_in">wait</span>=4 op monitor interval=60s</span><br><span class="line">pcs stonith create oss-11-5-fencing fence_ipmilan pcmk_host_list=<span class="string">"OSS-11-4.local"</span> ipaddr=<span class="string">"192.xx.xx.5"</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_<span class="built_in">wait</span>=4 op monitor interval=60s</span><br></pre></td></tr></table></figure>
<h3 id="pcs-status-1"><a href="#pcs-status-1" class="headerlink" title="pcs status"></a>pcs status</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Cluster <span class="symbol">name:</span> </span><br><span class="line">Last <span class="symbol">updated:</span> Tue Aug <span class="number">25</span> <span class="number">15</span><span class="symbol">:</span><span class="number">36</span><span class="symbol">:</span><span class="number">31</span> <span class="number">2015</span></span><br><span class="line">Last <span class="symbol">change:</span> Thu Aug <span class="number">20</span> <span class="number">15</span><span class="symbol">:</span><span class="number">44</span><span class="symbol">:</span><span class="number">16</span> <span class="number">2015</span></span><br><span class="line"><span class="symbol">Stack:</span> classic openais (with plugin)</span><br><span class="line">Current <span class="symbol">DC:</span> OSS-<span class="number">11</span>-<span class="number">4</span>.local - partition with quorum</span><br><span class="line"><span class="symbol">Version:</span> <span class="number">1.1</span>.<span class="number">11</span>-<span class="number">97629</span>de</span><br><span class="line"><span class="number">2</span> Nodes configured, <span class="number">2</span> expected votes</span><br><span class="line"><span class="number">26</span> Resources configured</span><br><span class="line"></span><br><span class="line"><span class="symbol">Online:</span> [ OSS-<span class="number">11</span>-<span class="number">4</span>.local OSS-<span class="number">11</span>-<span class="number">5</span>.local ]</span><br><span class="line"></span><br><span class="line">Full list of <span class="symbol">resources:</span></span><br><span class="line"></span><br><span class="line"> oss-<span class="number">11</span>-<span class="number">4</span>-fencing (<span class="symbol">stonith:</span>fence_ipmilan)<span class="symbol">:</span> Started OSS-<span class="number">11</span>-<span class="number">4</span>.local </span><br><span class="line"> oss-<span class="number">11</span>-<span class="number">5</span>-fencing (<span class="symbol">stonith:</span>fence_ipmilan)<span class="symbol">:</span> Started OSS-<span class="number">11</span>-<span class="number">5</span>.local </span><br><span class="line"> ost-<span class="number">0</span> (<span class="symbol">ocf:</span><span class="symbol">:heartbeat</span><span class="symbol">:ZFS</span>)<span class="symbol">:</span> Started OSS-<span class="number">11</span>-<span class="number">4</span>.local </span><br><span class="line"> ost-<span class="number">1</span> (<span class="symbol">ocf:</span><span class="symbol">:heartbeat</span><span class="symbol">:ZFS</span>)<span class="symbol">:</span> Started OSS-<span class="number">11</span>-<span class="number">5</span>.local </span><br><span class="line"> ost-<span class="number">2</span> (<span class="symbol">ocf:</span><span class="symbol">:heartbeat</span><span class="symbol">:ZFS</span>)<span class="symbol">:</span> Started OSS-<span class="number">11</span>-<span class="number">4</span>.local </span><br><span class="line"> ost-<span class="number">3</span> (<span class="symbol">ocf:</span><span class="symbol">:heartbeat</span><span class="symbol">:ZFS</span>)<span class="symbol">:</span> Started OSS-<span class="number">11</span>-<span class="number">5</span>.local </span><br><span class="line">………..</span><br><span class="line"> lustre_ost7 (<span class="symbol">ocf:</span><span class="symbol">:heartbeat</span><span class="symbol">:Lustre-ZFS</span>)<span class="symbol">:</span> Started OSS-<span class="number">11</span>-<span class="number">5</span>.local </span><br><span class="line"> lustre_ost8 (<span class="symbol">ocf:</span><span class="symbol">:heartbeat</span><span class="symbol">:Lustre-ZFS</span>)<span class="symbol">:</span> Started OSS-<span class="number">11</span>-<span class="number">4</span>.local </span><br><span class="line"> lustre_ost9 (<span class="symbol">ocf:</span><span class="symbol">:heartbeat</span><span class="symbol">:Lustre-ZFS</span>)<span class="symbol">:</span> Started OSS-<span class="number">11</span>-<span class="number">5</span>.local </span><br><span class="line"> lustre_ost1<span class="number">0</span> (<span class="symbol">ocf:</span><span class="symbol">:heartbeat</span><span class="symbol">:Lustre-ZFS</span>)<span class="symbol">:</span> Started OSS-<span class="number">11</span>-<span class="number">4</span>.local </span><br><span class="line"> lustre_ost11 (<span class="symbol">ocf:</span><span class="symbol">:heartbeat</span><span class="symbol">:Lustre-ZFS</span>)<span class="symbol">:</span> Started OSS-<span class="number">11</span>-<span class="number">5</span>.local</span><br></pre></td></tr></table></figure>
<p>Reference</p>
<p><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html-single/DM_Multipath/" target="_blank" rel="external">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html-single/DM_Multipath/</a><br><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Configuring_the_Red_Hat_High_Availability_Add-On_with_Pacemaker/index.html" target="_blank" rel="external">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Configuring_the_Red_Hat_High_Availability_Add-On_with_Pacemaker/index.html</a><br><a href="https://github.com/zfsonlinux/zfs/labels/Bug" target="_blank" rel="external">https://github.com/zfsonlinux/zfs/labels/Bug</a><br><a href="https://github.com/skiselkov/stmf-ha" target="_blank" rel="external">https://github.com/skiselkov/stmf-ha</a><br><a href="https://github.com/zfsonlinux/pkg-zfs/wiki/Ubuntu-ZFS-mountall-FAQ-and-troubleshooting" target="_blank" rel="external">https://github.com/zfsonlinux/pkg-zfs/wiki/Ubuntu-ZFS-mountall-FAQ-and-troubleshooting</a><br><a href="http://linux-ha.996297.n3.nabble.com/custom-script-status-td14629.html" target="_blank" rel="external">http://linux-ha.996297.n3.nabble.com/custom-script-status-td14629.html</a><br><a href="https://www.youtube.com/watch?v=2XQ3Kvtd-sw" target="_blank" rel="external">https://www.youtube.com/watch?v=2XQ3Kvtd-sw</a><br><a href="http://open-zfs.org/wiki/Main_Page" target="_blank" rel="external">http://open-zfs.org/wiki/Main_Page</a><br><a href="http://irvingpop.github.io/blog/2015/03/01/redhat7-clustering-experiments/" target="_blank" rel="external">http://irvingpop.github.io/blog/2015/03/01/redhat7-clustering-experiments/</a></p>
]]></content>
    </entry>
    
  
  
</search>
