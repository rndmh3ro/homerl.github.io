<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[Hotplug and disable hyper theading core in linux]]></title>
      <url>http://yoursite.com/2017/12/23/Hotplug-and-disable-hyper-theading-core-in-linux/</url>
      <content type="html"><![CDATA[<h3 id="Found-the-half-cores"><a href="#Found-the-half-cores" class="headerlink" title="Found the half cores"></a>Found the half cores</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ((i=0;i&lt;$(grep -c processor /proc/cpuinfo);i++)); </span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">  cat /sys/devices/system/cpu/cpu<span class="variable">$i</span>/cache/index2/shared_cpu_list; </span><br><span class="line"><span class="keyword">done</span> | awk -F, <span class="string">'&#123;a[$1]=$0&#125; END&#123;</span><br><span class="line">  count=0;</span><br><span class="line">  for (i in a) &#123;</span><br><span class="line">     if(count==0) &#123;</span><br><span class="line">       printf i</span><br><span class="line">     &#125; else &#123;</span><br><span class="line">       printf ","i</span><br><span class="line">     &#125;;</span><br><span class="line">       count++ </span><br><span class="line">  &#125; </span><br><span class="line">&#125;'</span></span><br><span class="line"></span><br><span class="line">17,4,18,5,19,6,7,8,9,10,11,12,13,0,14,1,15,2,16,3</span><br></pre></td></tr></table></figure>
<h3 id="Turn-off-the-core"><a href="#Turn-off-the-core" class="headerlink" title="Turn off the core"></a>Turn off the core</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 0 &gt; /sys/devices/system/cpu/cpu17/online</span><br></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> cpu </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[linux_errno]]></title>
      <url>http://yoursite.com/2017/11/21/linux-errno/</url>
      <content type="html"><![CDATA[<p>Get it from<br>/usr/include/asm-generic/errno.h<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ifndef _ASM_GENERIC_ERRNO_H</span></span><br><span class="line"><span class="comment">#define _ASM_GENERIC_ERRNO_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#include &lt;asm-generic/errno-base.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define	EDEADLK		35	/* Resource deadlock would occur */</span></span><br><span class="line"><span class="comment">#define	ENAMETOOLONG	36	/* File name too long */</span></span><br><span class="line"><span class="comment">#define	ENOLCK		37	/* No record locks available */</span></span><br><span class="line"><span class="comment">#define	ENOSYS		38	/* Function not implemented */</span></span><br><span class="line"><span class="comment">#define	ENOTEMPTY	39	/* Directory not empty */</span></span><br><span class="line"><span class="comment">#define	ELOOP		40	/* Too many symbolic links encountered */</span></span><br><span class="line"><span class="comment">#define	EWOULDBLOCK	EAGAIN	/* Operation would block */</span></span><br><span class="line"><span class="comment">#define	ENOMSG		42	/* No message of desired type */</span></span><br><span class="line"><span class="comment">#define	EIDRM		43	/* Identifier removed */</span></span><br><span class="line"><span class="comment">#define	ECHRNG		44	/* Channel number out of range */</span></span><br><span class="line"><span class="comment">#define	EL2NSYNC	45	/* Level 2 not synchronized */</span></span><br><span class="line"><span class="comment">#define	EL3HLT		46	/* Level 3 halted */</span></span><br><span class="line"><span class="comment">#define	EL3RST		47	/* Level 3 reset */</span></span><br><span class="line"><span class="comment">#define	ELNRNG		48	/* Link number out of range */</span></span><br><span class="line"><span class="comment">#define	EUNATCH		49	/* Protocol driver not attached */</span></span><br><span class="line"><span class="comment">#define	ENOCSI		50	/* No CSI structure available */</span></span><br><span class="line"><span class="comment">#define	EL2HLT		51	/* Level 2 halted */</span></span><br><span class="line"><span class="comment">#define	EBADE		52	/* Invalid exchange */</span></span><br><span class="line"><span class="comment">#define	EBADR		53	/* Invalid request descriptor */</span></span><br><span class="line"><span class="comment">#define	EXFULL		54	/* Exchange full */</span></span><br><span class="line"><span class="comment">#define	ENOANO		55	/* No anode */</span></span><br><span class="line"><span class="comment">#define	EBADRQC		56	/* Invalid request code */</span></span><br><span class="line"><span class="comment">#define	EBADSLT		57	/* Invalid slot */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define	EDEADLOCK	EDEADLK</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define	EBFONT		59	/* Bad font file format */</span></span><br><span class="line"><span class="comment">#define	ENOSTR		60	/* Device not a stream */</span></span><br><span class="line"><span class="comment">#define	ENODATA		61	/* No data available */</span></span><br><span class="line"><span class="comment">#define	ETIME		62	/* Timer expired */</span></span><br><span class="line"><span class="comment">#define	ENOSR		63	/* Out of streams resources */</span></span><br><span class="line"><span class="comment">#define	ENONET		64	/* Machine is not on the network */</span></span><br><span class="line"><span class="comment">#define	ENOPKG		65	/* Package not installed */</span></span><br><span class="line"><span class="comment">#define	EREMOTE		66	/* Object is remote */</span></span><br><span class="line"><span class="comment">#define	ENOLINK		67	/* Link has been severed */</span></span><br><span class="line"><span class="comment">#define	EADV		68	/* Advertise error */</span></span><br><span class="line"><span class="comment">#define	ESRMNT		69	/* Srmount error */</span></span><br><span class="line"><span class="comment">#define	ECOMM		70	/* Communication error on send */</span></span><br><span class="line"><span class="comment">#define	EPROTO		71	/* Protocol error */</span></span><br><span class="line"><span class="comment">#define	EMULTIHOP	72	/* Multihop attempted */</span></span><br><span class="line"><span class="comment">#define	EDOTDOT		73	/* RFS specific error */</span></span><br><span class="line"><span class="comment">#define	EBADMSG		74	/* Not a data message */</span></span><br><span class="line"><span class="comment">#define	EOVERFLOW	75	/* Value too large for defined data type */</span></span><br><span class="line"><span class="comment">#define	ENOTUNIQ	76	/* Name not unique on network */</span></span><br><span class="line"><span class="comment">#define	EBADFD		77	/* File descriptor in bad state */</span></span><br><span class="line"><span class="comment">#define	EREMCHG		78	/* Remote address changed */</span></span><br><span class="line"><span class="comment">#define	ELIBACC		79	/* Can not access a needed shared library */</span></span><br><span class="line"><span class="comment">#define	ELIBBAD		80	/* Accessing a corrupted shared library */</span></span><br><span class="line"><span class="comment">#define	ELIBSCN		81	/* .lib section in a.out corrupted */</span></span><br><span class="line"><span class="comment">#define	ELIBMAX		82	/* Attempting to link in too many shared libraries */</span></span><br><span class="line"><span class="comment">#define	ELIBEXEC	83	/* Cannot exec a shared library directly */</span></span><br><span class="line"><span class="comment">#define	EILSEQ		84	/* Illegal byte sequence */</span></span><br><span class="line"><span class="comment">#define	ERESTART	85	/* Interrupted system call should be restarted */</span></span><br><span class="line"><span class="comment">#define	ESTRPIPE	86	/* Streams pipe error */</span></span><br><span class="line"><span class="comment">#define	EUSERS		87	/* Too many users */</span></span><br><span class="line"><span class="comment">#define	ENOTSOCK	88	/* Socket operation on non-socket */</span></span><br><span class="line"><span class="comment">#define	EDESTADDRREQ	89	/* Destination address required */</span></span><br><span class="line"><span class="comment">#define	EMSGSIZE	90	/* Message too long */</span></span><br><span class="line"><span class="comment">#define	EPROTOTYPE	91	/* Protocol wrong type for socket */</span></span><br><span class="line"><span class="comment">#define	ENOPROTOOPT	92	/* Protocol not available */</span></span><br><span class="line"><span class="comment">#define	EPROTONOSUPPORT	93	/* Protocol not supported */</span></span><br><span class="line"><span class="comment">#define	ESOCKTNOSUPPORT	94	/* Socket type not supported */</span></span><br><span class="line"><span class="comment">#define	EOPNOTSUPP	95	/* Operation not supported on transport endpoint */</span></span><br><span class="line"><span class="comment">#define	EPFNOSUPPORT	96	/* Protocol family not supported */</span></span><br><span class="line"><span class="comment">#define	EAFNOSUPPORT	97	/* Address family not supported by protocol */</span></span><br><span class="line"><span class="comment">#define	EADDRINUSE	98	/* Address already in use */</span></span><br><span class="line"><span class="comment">#define	EADDRNOTAVAIL	99	/* Cannot assign requested address */</span></span><br><span class="line"><span class="comment">#define	ENETDOWN	100	/* Network is down */</span></span><br><span class="line"><span class="comment">#define	ENETUNREACH	101	/* Network is unreachable */</span></span><br><span class="line"><span class="comment">#define	ENETRESET	102	/* Network dropped connection because of reset */</span></span><br><span class="line"><span class="comment">#define	ECONNABORTED	103	/* Software caused connection abort */</span></span><br><span class="line"><span class="comment">#define	ECONNRESET	104	/* Connection reset by peer */</span></span><br><span class="line"><span class="comment">#define	ENOBUFS		105	/* No buffer space available */</span></span><br><span class="line"><span class="comment">#define	EISCONN		106	/* Transport endpoint is already connected */</span></span><br><span class="line"><span class="comment">#define	ENOTCONN	107	/* Transport endpoint is not connected */</span></span><br><span class="line"><span class="comment">#define	ESHUTDOWN	108	/* Cannot send after transport endpoint shutdown */</span></span><br><span class="line"><span class="comment">#define	ETOOMANYREFS	109	/* Too many references: cannot splice */</span></span><br><span class="line"><span class="comment">#define	ETIMEDOUT	110	/* Connection timed out */</span></span><br><span class="line"><span class="comment">#define	ECONNREFUSED	111	/* Connection refused */</span></span><br><span class="line"><span class="comment">#define	EHOSTDOWN	112	/* Host is down */</span></span><br><span class="line"><span class="comment">#define	EHOSTUNREACH	113	/* No route to host */</span></span><br><span class="line"><span class="comment">#define	EALREADY	114	/* Operation already in progress */</span></span><br><span class="line"><span class="comment">#define	EINPROGRESS	115	/* Operation now in progress */</span></span><br><span class="line"><span class="comment">#define	ESTALE		116	/* Stale file handle */</span></span><br><span class="line"><span class="comment">#define	EUCLEAN		117	/* Structure needs cleaning */</span></span><br><span class="line"><span class="comment">#define	ENOTNAM		118	/* Not a XENIX named type file */</span></span><br><span class="line"><span class="comment">#define	ENAVAIL		119	/* No XENIX semaphores available */</span></span><br><span class="line"><span class="comment">#define	EISNAM		120	/* Is a named type file */</span></span><br><span class="line"><span class="comment">#define	EREMOTEIO	121	/* Remote I/O error */</span></span><br><span class="line"><span class="comment">#define	EDQUOT		122	/* Quota exceeded */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define	ENOMEDIUM	123	/* No medium found */</span></span><br><span class="line"><span class="comment">#define	EMEDIUMTYPE	124	/* Wrong medium type */</span></span><br><span class="line"><span class="comment">#define	ECANCELED	125	/* Operation Canceled */</span></span><br><span class="line"><span class="comment">#define	ENOKEY		126	/* Required key not available */</span></span><br><span class="line"><span class="comment">#define	EKEYEXPIRED	127	/* Key has expired */</span></span><br><span class="line"><span class="comment">#define	EKEYREVOKED	128	/* Key has been revoked */</span></span><br><span class="line"><span class="comment">#define	EKEYREJECTED	129	/* Key was rejected by service */</span></span><br><span class="line"></span><br><span class="line">/* <span class="keyword">for</span> robust mutexes */</span><br><span class="line"><span class="comment">#define	EOWNERDEAD	130	/* Owner died */</span></span><br><span class="line"><span class="comment">#define	ENOTRECOVERABLE	131	/* State not recoverable */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define ERFKILL		132	/* Operation not possible due to RF-kill */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define EHWPOISON	133	/* Memory page has hardware error */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#endif</span></span><br></pre></td></tr></table></figure></p>
<p>/usr/include/asm-generic/errno-base.h<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ifndef _ASM_GENERIC_ERRNO_BASE_H</span></span><br><span class="line"><span class="comment">#define _ASM_GENERIC_ERRNO_BASE_H</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#define	EPERM		 1	/* Operation not permitted */</span></span><br><span class="line"><span class="comment">#define	ENOENT		 2	/* No such file or directory */</span></span><br><span class="line"><span class="comment">#define	ESRCH		 3	/* No such process */</span></span><br><span class="line"><span class="comment">#define	EINTR		 4	/* Interrupted system call */</span></span><br><span class="line"><span class="comment">#define	EIO		 5	/* I/O error */</span></span><br><span class="line"><span class="comment">#define	ENXIO		 6	/* No such device or address */</span></span><br><span class="line"><span class="comment">#define	E2BIG		 7	/* Argument list too long */</span></span><br><span class="line"><span class="comment">#define	ENOEXEC		 8	/* Exec format error */</span></span><br><span class="line"><span class="comment">#define	EBADF		 9	/* Bad file number */</span></span><br><span class="line"><span class="comment">#define	ECHILD		10	/* No child processes */</span></span><br><span class="line"><span class="comment">#define	EAGAIN		11	/* Try again */</span></span><br><span class="line"><span class="comment">#define	ENOMEM		12	/* Out of memory */</span></span><br><span class="line"><span class="comment">#define	EACCES		13	/* Permission denied */</span></span><br><span class="line"><span class="comment">#define	EFAULT		14	/* Bad address */</span></span><br><span class="line"><span class="comment">#define	ENOTBLK		15	/* Block device required */</span></span><br><span class="line"><span class="comment">#define	EBUSY		16	/* Device or resource busy */</span></span><br><span class="line"><span class="comment">#define	EEXIST		17	/* File exists */</span></span><br><span class="line"><span class="comment">#define	EXDEV		18	/* Cross-device link */</span></span><br><span class="line"><span class="comment">#define	ENODEV		19	/* No such device */</span></span><br><span class="line"><span class="comment">#define	ENOTDIR		20	/* Not a directory */</span></span><br><span class="line"><span class="comment">#define	EISDIR		21	/* Is a directory */</span></span><br><span class="line"><span class="comment">#define	EINVAL		22	/* Invalid argument */</span></span><br><span class="line"><span class="comment">#define	ENFILE		23	/* File table overflow */</span></span><br><span class="line"><span class="comment">#define	EMFILE		24	/* Too many open files */</span></span><br><span class="line"><span class="comment">#define	ENOTTY		25	/* Not a typewriter */</span></span><br><span class="line"><span class="comment">#define	ETXTBSY		26	/* Text file busy */</span></span><br><span class="line"><span class="comment">#define	EFBIG		27	/* File too large */</span></span><br><span class="line"><span class="comment">#define	ENOSPC		28	/* No space left on device */</span></span><br><span class="line"><span class="comment">#define	ESPIPE		29	/* Illegal seek */</span></span><br><span class="line"><span class="comment">#define	EROFS		30	/* Read-only file system */</span></span><br><span class="line"><span class="comment">#define	EMLINK		31	/* Too many links */</span></span><br><span class="line"><span class="comment">#define	EPIPE		32	/* Broken pipe */</span></span><br><span class="line"><span class="comment">#define	EDOM		33	/* Math argument out of domain of func */</span></span><br><span class="line"><span class="comment">#define	ERANGE		34	/* Math result not representable */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#endif</span></span><br></pre></td></tr></table></figure></p>
]]></content>
      
        <categories>
            
            <category> Linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> unix </tag>
            
            <tag> posix </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[system call]]></title>
      <url>http://yoursite.com/2017/11/09/system_call/</url>
      <content type="html"><![CDATA[<p><a href="https://www.ibm.com/developerworks/cn/linux/kernel/syscall/part1/appendix.html" target="_blank" rel="external">https://www.ibm.com/developerworks/cn/linux/kernel/syscall/part1/appendix.html</a><br><a href="https://www.ibm.com/developerworks/cn/linux/kernel/syscall/part2" target="_blank" rel="external">https://www.ibm.com/developerworks/cn/linux/kernel/syscall/part2</a><br><a href="https://www.ibm.com/developerworks/cn/linux/kernel/syscall/part3" target="_blank" rel="external">https://www.ibm.com/developerworks/cn/linux/kernel/syscall/part3</a><br><a href="https://www.ibm.com/developerworks/cn/linux/kernel/syscall/part4" target="_blank" rel="external">https://www.ibm.com/developerworks/cn/linux/kernel/syscall/part4</a></p>
<p>一、进程控制：<br>fork    创建一个新进程<br>clone    按指定条件创建子进程<br>execve    运行可执行文件<br>exit    中止进程<br>_exit    立即中止当前进程<br>getdtablesize    进程所能打开的最大文件数<br>getpgid    获取指定进程组标识号<br>setpgid    设置指定进程组标志号<br>getpgrp    获取当前进程组标识号<br>setpgrp    设置当前进程组标志号<br>getpid    获取进程标识号<br>getppid    获取父进程标识号<br>getpriority    获取调度优先级<br>setpriority    设置调度优先级<br>modify_ldt    读写进程的本地描述表<br>nanosleep    使进程睡眠指定的时间<br>nice    改变分时进程的优先级<br>pause    挂起进程，等待信号<br>personality    设置进程运行域<br>prctl    对进程进行特定操作<br>ptrace    进程跟踪<br>sched_get_priority_max    取得静态优先级的上限<br>sched_get_priority_min    取得静态优先级的下限<br>sched_getparam    取得进程的调度参数<br>sched_getscheduler    取得指定进程的调度策略<br>sched_rr_get_interval    取得按RR算法调度的实时进程的时间片长度<br>sched_setparam    设置进程的调度参数<br>sched_setscheduler    设置指定进程的调度策略和参数<br>sched_yield    进程主动让出处理器,并将自己等候调度队列队尾<br>vfork    创建一个子进程，以供执行新程序，常与execve等同时使用<br>wait    等待子进程终止<br>wait3    参见wait<br>waitpid    等待指定子进程终止<br>wait4    参见waitpid<br>capget    获取进程权限<br>capset    设置进程权限<br>getsid    获取会晤标识号<br>setsid    设置会晤标识号<br>二、文件系统控制<br>1、文件读写操作<br>fcntl    文件控制<br>open    打开文件<br>creat    创建新文件<br>close    关闭文件描述字<br>read    读文件<br>write    写文件<br>readv    从文件读入数据到缓冲数组中<br>writev    将缓冲数组里的数据写入文件<br>pread    对文件随机读<br>pwrite    对文件随机写<br>lseek    移动文件指针<br>_llseek    在64位地址空间里移动文件指针<br>dup    复制已打开的文件描述字<br>dup2    按指定条件复制文件描述字<br>flock    文件加/解锁<br>poll    I/O多路转换<br>truncate    截断文件<br>ftruncate    参见truncate<br>umask    设置文件权限掩码<br>fsync    把文件在内存中的部分写回磁盘<br>2、文件系统操作<br>access    确定文件的可存取性<br>chdir    改变当前工作目录<br>fchdir    参见chdir<br>chmod    改变文件方式<br>fchmod    参见chmod<br>chown    改变文件的属主或用户组<br>fchown    参见chown<br>lchown    参见chown<br>chroot    改变根目录<br>stat    取文件状态信息<br>lstat    参见stat<br>fstat    参见stat<br>statfs    取文件系统信息<br>fstatfs    参见statfs<br>readdir    读取目录项<br>getdents    读取目录项<br>mkdir    创建目录<br>mknod    创建索引节点<br>rmdir    删除目录<br>rename    文件改名<br>link    创建链接<br>symlink    创建符号链接<br>unlink    删除链接<br>readlink    读符号链接的值<br>mount    安装文件系统<br>umount    卸下文件系统<br>ustat    取文件系统信息<br>utime    改变文件的访问修改时间<br>utimes    参见utime<br>quotactl    控制磁盘配额<br>三、系统控制<br>ioctl    I/O总控制函数<br>_sysctl    读/写系统参数<br>acct    启用或禁止进程记账<br>getrlimit    获取系统资源上限<br>setrlimit    设置系统资源上限<br>getrusage    获取系统资源使用情况<br>uselib    选择要使用的二进制函数库<br>ioperm    设置端口I/O权限<br>iopl    改变进程I/O权限级别<br>outb    低级端口操作<br>reboot    重新启动<br>swapon    打开交换文件和设备<br>swapoff    关闭交换文件和设备<br>bdflush    控制bdflush守护进程<br>sysfs    取核心支持的文件系统类型<br>sysinfo    取得系统信息<br>adjtimex    调整系统时钟<br>alarm    设置进程的闹钟<br>getitimer    获取计时器值<br>setitimer    设置计时器值<br>gettimeofday    取时间和时区<br>settimeofday    设置时间和时区<br>stime    设置系统日期和时间<br>time    取得系统时间<br>times    取进程运行时间<br>uname    获取当前UNIX系统的名称、版本和主机等信息<br>vhangup    挂起当前终端<br>nfsservctl    对NFS守护进程进行控制<br>vm86    进入模拟8086模式<br>create_module    创建可装载的模块项<br>delete_module    删除可装载的模块项<br>init_module    初始化模块<br>query_module    查询模块信息<br><em>get_kernel_syms    取得核心符号,已被query_module代替<br>四、内存管理<br>brk    改变数据段空间的分配<br>sbrk    参见brk<br>mlock    内存页面加锁<br>munlock    内存页面解锁<br>mlockall    调用进程所有内存页面加锁<br>munlockall    调用进程所有内存页面解锁<br>mmap    映射虚拟内存页<br>munmap    去除内存页映射<br>mremap    重新映射虚拟内存地址<br>msync    将映射内存中的数据写回磁盘<br>mprotect    设置内存映像保护<br>getpagesize    获取页面大小<br>sync    将内存缓冲区数据写回硬盘<br>cacheflush    将指定缓冲区中的内容写回磁盘<br>五、网络管理<br>getdomainname    取域名<br>setdomainname    设置域名<br>gethostid    获取主机标识号<br>sethostid    设置主机标识号<br>gethostname    获取本主机名称<br>sethostname    设置主机名称<br>六、socket控制<br>socketcall    socket系统调用<br>socket    建立socket<br>bind    绑定socket到端口<br>connect    连接远程主机<br>accept    响应socket连接请求<br>send    通过socket发送信息<br>sendto    发送UDP信息<br>sendmsg    参见send<br>recv    通过socket接收信息<br>recvfrom    接收UDP信息<br>recvmsg    参见recv<br>listen    监听socket端口<br>select    对多路同步I/O进行轮询<br>shutdown    关闭socket上的连接<br>getsockname    取得本地socket名字<br>getpeername    获取通信对方的socket名字<br>getsockopt    取端口设置<br>setsockopt    设置端口参数<br>sendfile    在文件或端口间传输数据<br>socketpair    创建一对已联接的无名socket<br>七、用户管理<br>getuid    获取用户标识号<br>setuid    设置用户标志号<br>getgid    获取组标识号<br>setgid    设置组标志号<br>getegid    获取有效组标识号<br>setegid    设置有效组标识号<br>geteuid    获取有效用户标识号<br>seteuid    设置有效用户标识号<br>setregid    分别设置真实和有效的的组标识号<br>setreuid    分别设置真实和有效的用户标识号<br>getresgid    分别获取真实的,有效的和保存过的组标识号<br>setresgid    分别设置真实的,有效的和保存过的组标识号<br>getresuid    分别获取真实的,有效的和保存过的用户标识号<br>setresuid    分别设置真实的,有效的和保存过的用户标识号<br>setfsgid    设置文件系统检查时使用的组标识号<br>setfsuid    设置文件系统检查时使用的用户标识号<br>getgroups    获取后补组标志清单<br>setgroups    设置后补组标志清单<br>八、进程间通信<br>ipc    进程间通信总控制调用<br>1、信号<br>sigaction    设置对指定信号的处理方法<br>sigprocmask    根据参数对信号集中的信号执行阻塞/解除阻塞等操作<br>sigpending    为指定的被阻塞信号设置队列<br>sigsuspend    挂起进程等待特定信号<br>signal    参见signal<br>kill    向进程或进程组发信号
</em>sigblock    向被阻塞信号掩码中添加信号,已被sigprocmask代替<br><em>siggetmask    取得现有阻塞信号掩码,已被sigprocmask代替
</em>sigsetmask    用给定信号掩码替换现有阻塞信号掩码,已被sigprocmask代替<br><em>sigmask    将给定的信号转化为掩码,已被sigprocmask代替
</em>sigpause    作用同sigsuspend,已被sigsuspend代替<br>sigvec    为兼容BSD而设的信号处理函数,作用类似sigaction<br>ssetmask    ANSI C的信号处理函数,作用类似sigaction<br>2、消息<br>msgctl    消息控制操作<br>msgget    获取消息队列<br>msgsnd    发消息<br>msgrcv    取消息<br>3、管道<br>pipe    创建管道<br>4、信号量<br>semctl    信号量控制<br>semget    获取一组信号量<br>semop    信号量操作<br>5、共享内存<br>shmctl    控制共享内存<br>shmget    获取共享内存<br>shmat    连接共享内存<br>shmdt    拆卸共享内存</p>
]]></content>
      
        <categories>
            
            <category> Linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> unix </tag>
            
            <tag> posix </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[mdadm tips]]></title>
      <url>http://yoursite.com/2017/11/09/mdadm/</url>
      <content type="html"><![CDATA[<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mdadm --create /dev/md/imsm0 -n2  <span class="_">-e</span> imsm /dev/nvme&#123;0..1&#125;n1</span><br><span class="line">mdadm -C /dev/md1 /dev/md/imsm0 -n 2 <span class="_">-l</span> 1 --bitmap=none</span><br><span class="line"><span class="built_in">echo</span> 2000000 &gt; /proc/sys/dev/raid/speed_<span class="built_in">limit</span>_max</span><br><span class="line">mdadm -Ds &gt; /etc/mdadm.conf</span><br></pre></td></tr></table></figure>
<p>If you ‘re running 2 x NVME SSD in a mirror. you’d better set bitmap=none to avoid cpu core 100%<br>Because enterprise SSD has the capacitance</p>
<h4 id="Bitmap"><a href="#Bitmap" class="headerlink" title="Bitmap"></a>Bitmap</h4><p>Bitmaps optimize rebuild time after a crash, or after removing and re-adding a device.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mdadm --grow --bitmap=internal /dev/md0</span><br><span class="line">mdadm --grow --bitmap=none /dev/md0</span><br></pre></td></tr></table></figure></p>
<h4 id="SCAN"><a href="#SCAN" class="headerlink" title="SCAN"></a>SCAN</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mdadm --assemble --scan</span><br><span class="line">mdadm --assemble /dev/md1 --scan --force</span><br><span class="line">mdadm --assemble /dev/md1 /dev/sd[abc]2 --force</span><br><span class="line"></span><br><span class="line"><span class="comment">####Dangerours</span></span><br><span class="line">mdadm --create /dev/md1 --assume-clean <span class="_">-l</span>5 -n4 -c64 /dev/sd[abc]2 missing</span><br></pre></td></tr></table></figure>
<h4 id="Set-readahead"><a href="#Set-readahead" class="headerlink" title="Set readahead"></a>Set readahead</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">blockdev --setra 65536 /dev/mdX</span><br></pre></td></tr></table></figure>
<h4 id="Set-stripe-cache"><a href="#Set-stripe-cache" class="headerlink" title="Set stripe-cache"></a>Set stripe-cache</h4><p>memory_consumed = system_page_size <em> nr_disks </em> stripe_cache_size<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set 16MB for /dev/md0</span></span><br><span class="line"><span class="built_in">echo</span> 16384 &gt; /sys/block/md0/md/stripe_cache_size</span><br></pre></td></tr></table></figure></p>
<h4 id="Disable-NCQ"><a href="#Disable-NCQ" class="headerlink" title="Disable NCQ"></a>Disable NCQ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> sd[abcde]</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> 1 &gt; /sys/block/<span class="variable">$i</span>/device/queue_depth</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h4 id="Clear-mdadm-infomation"><a href="#Clear-mdadm-infomation" class="headerlink" title="Clear mdadm infomation"></a>Clear mdadm infomation</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mdadm --stop /dev/md0</span><br><span class="line">mdadm --zero-superblock /dev/sdla</span><br></pre></td></tr></table></figure>
<h4 id="Replace-device"><a href="#Replace-device" class="headerlink" title="Replace device"></a>Replace device</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># check info</span></span><br><span class="line">mdadm --detail /dev/mdx</span><br><span class="line"></span><br><span class="line"><span class="comment"># mark the fail dev</span></span><br><span class="line">mdadm /dev/md0 <span class="_">-f</span> /dev/sdx  <span class="comment"># "F" in /proc/mdstat</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># remove the dev</span></span><br><span class="line">mdadm /dev/md0 -r /dev/sdx</span><br><span class="line"></span><br><span class="line"><span class="comment"># re-add it</span></span><br><span class="line">mdadm /dev/md0 <span class="_">-a</span> /dev/sdx</span><br></pre></td></tr></table></figure>
<h4 id="Device-detail"><a href="#Device-detail" class="headerlink" title="Device detail"></a>Device detail</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mdadm -E /dev/sdaa</span></span><br><span class="line">/dev/sdaa:</span><br><span class="line">          Magic : a92b4efc</span><br><span class="line">        Version : 1.2</span><br><span class="line">    Feature Map : 0x1</span><br><span class="line">     Array UUID : c82f3470:5eed5058:083fb704:62315597</span><br><span class="line">           Name : 3</span><br><span class="line">  Creation Time : Mon Jan  3 01:09:30 2011</span><br><span class="line">     Raid Level : raid6</span><br><span class="line">   Raid Devices : 44</span><br><span class="line"></span><br><span class="line"> Avail Dev Size : 976772896 (465.76 GiB 500.11 GB)</span><br><span class="line">     Array Size : 41024460288 (19561.99 GiB 21004.52 GB)</span><br><span class="line">  Used Dev Size : 976772864 (465.76 GiB 500.11 GB)</span><br><span class="line">    Data Offset : 272 sectors</span><br><span class="line">   Super Offset : 8 sectors</span><br><span class="line">          State : active</span><br><span class="line">    Device UUID : 788aa9<span class="built_in">cd</span>:3ed46a21:4bf3433d:74823b69</span><br><span class="line"></span><br><span class="line">Internal Bitmap : 8 sectors from superblock</span><br><span class="line">    Update Time : Mon Jan  3 01:09:30 2011</span><br><span class="line">       Checksum : b3e6d7a9 - correct</span><br><span class="line">         Events : 0</span><br><span class="line"></span><br><span class="line">     Chunk Size : 128K</span><br><span class="line"></span><br><span class="line">    Array Slot : 25 (0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43)</span><br><span class="line">   Array State : uuuuuuuuuuuuuuuuuuuuuuuuuUuuuuuuuuuuuuuuuuuu</span><br></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> mdadm </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[scsi tips]]></title>
      <url>http://yoursite.com/2017/10/26/scsi_tips/</url>
      <content type="html"><![CDATA[<h3 id="Enable-read-write-cache"><a href="#Enable-read-write-cache" class="headerlink" title="Enable read write cache"></a>Enable read write cache</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##SATA</span></span><br><span class="line">hdparm -W 0 /dev/sdX --&gt; <span class="built_in">disable</span> write caching</span><br><span class="line">hdparm -W 1 /dev/sdX --&gt; <span class="built_in">enable</span> write caching</span><br><span class="line">hdparm -i /dev/sdX</span><br><span class="line"></span><br><span class="line"><span class="comment">##SAS</span></span><br><span class="line">sdparm /dev/sdX</span><br><span class="line">WCE 0 [cha: y, def: 1, sav: 0] --&gt; write caching is disabled</span><br><span class="line"></span><br><span class="line">sdparm --inquiry /dev/sdX</span><br><span class="line">sdparm --page=ca /dev/sdX</span><br><span class="line">sdparm --set=WCE /dev/sdX --&gt; this enables write caching</span><br><span class="line">sdparm –g WCE /dev/sdX  --&gt; get the WCE current value</span><br><span class="line">sdparm –s WCE –S /dev/sdX --&gt; To <span class="built_in">set</span> the WCE current and saved values (WCE=1)</span><br><span class="line">sdparm –c WCE /dev/sdX --&gt; To clear (<span class="built_in">disable</span>) the WCE current value (WCE=0)</span><br><span class="line">sdparm –c WCE –S /dev/sdX --&gt; To clear (<span class="built_in">disable</span>) the WCE current and saved values (WCE=0)</span><br></pre></td></tr></table></figure>
<h3 id="smart"><a href="#smart" class="headerlink" title="smart"></a><a href="https://www.computerworld.com/article/2846009/the-5-smart-stats-that-actually-predict-hard-drive-failure.html" target="_blank" rel="external">smart</a></h3><p>SMART 5 - Reallocated_Sector_Count.<br>SMART 187 - Reported_Uncorrectable_Errors.<br>SMART 188 - Command_Timeout.<br>SMART 197 - Current_Pending_Sector_Count.<br>SMART 198 - Offline_Uncorrectable</p>
<h3 id="sg3-utils"><a href="#sg3-utils" class="headerlink" title="sg3_utils"></a>sg3_utils</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sg_ses /dev/sg129 -p0x2 -I2,1 -j</span><br><span class="line">这个命令的I后面是2就是风扇，1是电源，3是温度</span><br><span class="line">然后命令的倒数第2个参数，例如上面命令的1， 就代表第1个风扇，是0，就代表第0个风扇，3就代表第3个风扇</span><br></pre></td></tr></table></figure>
<h4 id="Smart-check"><a href="#Smart-check" class="headerlink" title="Smart check"></a>Smart check</h4><p>Phy reset problem</p>
<p>Running disparity error count<br>A binary value indicating the cumulative encoded signal imbalance between the one and zero signal state of all characters since dword synchronization has been achieved.<br><a href="https://www.seagate.com/staticfiles/support/disc/manuals/Interface%20manuals/100293071c.pdf" target="_blank" rel="external">for more scsi info</a></p>
<p>loss of DWORD synchroization<br>These errors mean that there is a problem in the link between the drive and the upstream port, if you have a cable in there the cable may be bad, if not it means one of the port is bad. Ofcourse even if you have a cable it can still mean one of the ports is bad.<br>The way to diagnose it is to use a different disk in the same slot and see if the error goes away or not, if it went away the disk is bad. If the error stayed the original disk is fine but the port on the server/chassis is bad and the server/chassis needs to be replaced.<br>The issue with loss of dword synchronization is that it means additional retries for some sent IOs and it will increase the latency of IOs by way of waiting more for data transmission due to these retransmits.</p>
<p>SCSI errors in messages<br>“scsi data underrun”<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mpt3sas_cm0:   handle(0x002d), ioc_status(scsi data underrun)(0x0045), smid(222)</span><br><span class="line">mpt3sas_cm0:   scsi_status(check condition)(0x02), scsi_state(autosense valid )(0x01)</span><br><span class="line">mpt3sas_cm0:   [sense_key,asc,ascq]: [0x06,0x2a,0x01], count(96)</span><br></pre></td></tr></table></figure></p>
<p>“REPORT_LUNS handle retries”<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mpt2sas0: REPORT_LUNS: handle(0x000a), retries(0)</span><br></pre></td></tr></table></figure></p>
<p><a href="https://gist.github.com/jaseywang/3786679" target="_blank" rel="external">Replace HDDs</a><br>(SAS Serial SCSI Protocol) SSP handle<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Sep 26 15:03:03 wtf kernel: [5640834.981956] mpt2sas0: removing handle(0x000c), sas_addr(0x50014ee30011c706)</span><br><span class="line">Sep 26 15:04:48 wtf kernel: [5640939.604300] scsi 0:0:13:0: Direct-Access     SEAGATE  ST2000NM0001     PS06 PQ: 0 ANSI: 6</span><br><span class="line">Sep 26 15:04:48 wtf kernel: [5640939.604308] scsi 0:0:13:0: SSP: handle(0x0018), sas_addr(0x5000c50041f753c5), device_name(0x0000000000000000)</span><br><span class="line">Sep 26 15:04:48 wtf kernel: [5640939.604312] scsi 0:0:13:0: SSP: enclosure_logical_id(0x500065b37689abff), slot(4)</span><br><span class="line">Sep 26 15:04:48 wtf kernel: [5640939.604316] scsi 0:0:13:0: qdepth(254), tagged(1), simple(1), ordered(0), scsi_level(7), cmd_que(1)</span><br><span class="line">Sep 26 15:04:48 wtf kernel: [5640939.604766] sd 0:0:13:0: Attached scsi generic sg1 <span class="built_in">type</span> 0</span><br><span class="line">Sep 26 15:04:48 wtf kernel: [5640939.605237] sd 0:0:13:0: [sdb] 3907029168 512-byte logical blocks: (2.00 TB/1.81 TiB)</span><br><span class="line">Sep 26 15:04:48 wtf kernel: [5640939.606128] sd 0:0:13:0: [sdb] Write Protect is off</span><br><span class="line">Sep 26 15:04:48 wtf kernel: [5640939.606567] sd 0:0:13:0: [sdb] Write cache: enabled, <span class="built_in">read</span> cache: enabled, supports DPO and FUA</span><br><span class="line">Sep 26 15:04:48 wtf kernel: [5640939.607915]  sdb: unknown partition table</span><br><span class="line">Sep 26 15:04:48 wtf kernel: [5640939.635779] sd 0:0:13:0: [sdb] Attached SCSI disk</span><br><span class="line">Sep 26 15:05:46 wtf kernel: [5640997.134363]  sdb: sdb1</span><br></pre></td></tr></table></figure></p>
<p>You can enable SCSI logging using echo 0x010401cd &gt; /proc/sys/dev/scsi/logging_level</p>
<p>显示当前级别：</p>
<h1 id="sysctl-dev-scsi-logging-level"><a href="#sysctl-dev-scsi-logging-level" class="headerlink" title="sysctl dev.scsi.logging_level"></a>sysctl dev.scsi.logging_level</h1><p>dev.scsi.logging_level = 0<br>如果不是级别 128，请启用级别 128：</p>
<h1 id="sysctl-w-dev-scsi-logging-level-128"><a href="#sysctl-w-dev-scsi-logging-level-128" class="headerlink" title="sysctl -w dev.scsi.logging_level=128"></a>sysctl -w dev.scsi.logging_level=128</h1><p>dev.scsi.logging_level = 128<br>要获取短时间内的非常详细的 scsi 日志记录，请启用级别 -1：</p>
<h1 id="sysctl-w-dev-scsi-logging-level-1"><a href="#sysctl-w-dev-scsi-logging-level-1" class="headerlink" title="sysctl -w dev.scsi.logging_level=-1"></a>sysctl -w dev.scsi.logging_level=-1</h1><p>dev.scsi.logging_level = -1<br>日志输出将位于 /var/log/messages 中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">scsi debug</span><br><span class="line">scsi_logging_level syntax</span><br><span class="line">Read syntax diagramSkip visual syntax diagram</span><br><span class="line">                       .- ---------------------------.             </span><br><span class="line">                       V                             |             </span><br><span class="line">&gt;&gt;-scsi_logging_level----+-------------------------+-+--+- -s -+-&gt;&lt;</span><br><span class="line">                         +- -a-- &lt;level&gt;-----------+    +- -g -+   </span><br><span class="line">                         +- -E-- &lt;level&gt;-----------+    &apos;- -c -&apos;   </span><br><span class="line">                         +- -T-- &lt;level&gt;-----------+               </span><br><span class="line">                         +- -S-- &lt;level&gt;-----------+               </span><br><span class="line">                         +- -M-- &lt;level&gt;-----------+               </span><br><span class="line">                         +- --mlqueue-- &lt;level&gt;----+               </span><br><span class="line">                         +- --mlcomplete-- &lt;level&gt;-+               </span><br><span class="line">                         +- -L-- &lt;level&gt;-----------+               </span><br><span class="line">                         +- --llqueue-- &lt;level&gt;----+               </span><br><span class="line">                         +- --llcomplete-- &lt;level&gt;-+               </span><br><span class="line">                         +- -H-- &lt;level&gt;-----------+               </span><br><span class="line">                         +- --hlqueue-- &lt;level&gt;----+               </span><br><span class="line">                         +- --hlcomplete-- &lt;level&gt;-+               </span><br><span class="line">                         &apos;- -I-- &lt;level&gt;-----------&apos;</span><br><span class="line"></span><br><span class="line">scsi_logging_level -g</span><br><span class="line">Current scsi logging level:</span><br><span class="line">dev.scsi.logging_level = 0</span><br><span class="line">SCSI_LOG_ERROR=0</span><br><span class="line">SCSI_LOG_TIMEOUT=0</span><br><span class="line">SCSI_LOG_SCAN=0</span><br><span class="line">SCSI_LOG_MLQUEUE=0</span><br><span class="line">SCSI_LOG_MLCOMPLETE=0</span><br><span class="line">SCSI_LOG_LLQUEUE=0</span><br><span class="line">SCSI_LOG_LLCOMPLETE=0</span><br><span class="line">SCSI_LOG_HLQUEUE=0</span><br><span class="line">SCSI_LOG_HLCOMPLETE=0</span><br><span class="line">SCSI_LOG_IOCTL=0</span><br><span class="line"></span><br><span class="line">scsi_logging_level --hlqueue 3 --highlevel 2 --all 1 -s</span><br><span class="line">New scsi logging level:</span><br><span class="line">dev.scsi.logging_level = 174363209</span><br><span class="line">SCSI_LOG_ERROR=1</span><br><span class="line">SCSI_LOG_TIMEOUT=1</span><br><span class="line">SCSI_LOG_SCAN=1</span><br><span class="line">SCSI_LOG_MLQUEUE=1</span><br><span class="line">SCSI_LOG_MLCOMPLETE=1</span><br><span class="line">SCSI_LOG_LLQUEUE=1</span><br><span class="line">SCSI_LOG_LLCOMPLETE=1</span><br><span class="line">SCSI_LOG_HLQUEUE=3</span><br><span class="line">SCSI_LOG_HLCOMPLETE=2</span><br><span class="line">SCSI_LOG_IOCTL=1</span><br><span class="line">https://www.ibm.com/support/knowledgecenter/en/linuxonibm/com.ibm.linux.z.lgdd/lgdd_r_scsilog_cmd.html</span><br><span class="line"></span><br><span class="line">The definitions can be found in</span><br><span class="line">https://en.opensuse.org/SDB:SCSI_debugging_hints</span><br><span class="line"></span><br><span class="line">drivers/scsi/scsi_logging.h</span><br><span class="line">The possible areas are:</span><br><span class="line"></span><br><span class="line">ERROR</span><br><span class="line">Used by any command which has to be retried/recovered via the SCSI error handling mechanism</span><br><span class="line">TIMEOUT</span><br><span class="line">Used by drivers/scsi/sg.c</span><br><span class="line">SCAN</span><br><span class="line">Used during device scan, ie whenever a new device / HBA is initialized</span><br><span class="line">MLQUEUE</span><br><span class="line">Mid-layer queue; requests are being pulled from the block-layer queue and submitted to the HBA</span><br><span class="line">MLCOMPLETE</span><br><span class="line">Mid-layer queue; requests are being completed by the HBA and results are being pushed back to the block-layer</span><br><span class="line">LLQUEUE</span><br><span class="line">Low-layer queue; Not used</span><br><span class="line">LLCOMPLETE</span><br><span class="line">Low-layer queue; Not used</span><br><span class="line">HLQUEUE</span><br><span class="line">High-layer queue; command preparation in drivers/scsi/sd.c</span><br><span class="line">HLCOMPLETE</span><br><span class="line">High-layer queue; command completion in drivers/scsi/sd.c</span><br><span class="line">IOCTL</span><br><span class="line">SCSI IOCTL logging</span><br><span class="line">The detailed error level description:</span><br><span class="line"></span><br><span class="line">ERROR</span><br><span class="line"></span><br><span class="line">Error logging when a command is recovered via the SCSI error handling mechanism. The following levels are uses:</span><br><span class="line"></span><br><span class="line">Error handler thread statistics</span><br><span class="line">Error handler command statistics</span><br><span class="line">Error handler command logging</span><br><span class="line">Not used</span><br><span class="line">Error handler command details</span><br><span class="line">and higher: not used</span><br><span class="line">SCAN</span><br><span class="line"></span><br><span class="line">Logging during HBA / target scanning. The following levels are used:</span><br><span class="line"></span><br><span class="line">Logging of unusual devices where LUN 0 has a pqual of 3</span><br><span class="line">Logging of devices with pqual 3</span><br><span class="line">Logging of SCSI commands sent during scanning</span><br><span class="line">and higher: not used.</span><br><span class="line">MLQUEUE</span><br><span class="line"></span><br><span class="line">The MLQUEUE area is used when a command is being pulled from the block-layer queue and send to the HBA. It has the following levels:</span><br><span class="line"></span><br><span class="line">nothing (match completion)</span><br><span class="line">log opcode + command of all commands</span><br><span class="line">same as 2 plus dump cmd address</span><br><span class="line">same as 3 plus dump extra junk</span><br><span class="line">and higher: not used</span><br><span class="line">MLCOMPLETE</span><br><span class="line"></span><br><span class="line">Logging of command completion from the HBA, before the completion is being called for the block-layer request. It has the following levels:</span><br><span class="line"></span><br><span class="line">log disposition, result, opcode + command, and conditionally sense data for failures or non SUCCESS dispositions.</span><br><span class="line">same as 1 but for all command completions.</span><br><span class="line">same as 2 plus dump cmd address</span><br><span class="line">same as 3 plus dump extra junk</span><br><span class="line">and higher: not used</span><br><span class="line">Starting with SLES10 SP2 there is a command &apos;scsi_logging_level&apos; which allows you to set the areas and levels without having to calculate the bit offsets by hand, very convenient if you want to enable a logging level other than 0xffffffff.</span><br><span class="line"></span><br><span class="line">A useful setting of the logging level without being buried in logging details is ERROR=3, SCAN=3, MLQUEUE=2, MLCOMPLETE=2, which evaluates to</span><br><span class="line"></span><br><span class="line">echo 9411 &gt; /proc/sys/dev/scsi/logging_level</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scsi errors</span><br><span class="line"></span><br><span class="line">LogSense Data</span><br><span class="line">LogSense 0x00 00 Log Sense Pages Supported</span><br><span class="line">LogSense 0x02 00 Write Errors</span><br><span class="line">LogSense 0x03 00 Read Errors</span><br><span class="line">LogSense 0x05 00 Verify Errors</span><br><span class="line">LogSense 0x06 00 Non-medium Errors</span><br><span class="line">LogSense 0x0D 00 Current temperature</span><br><span class="line">LogSense 0x0E 00 Mfg Date, Start/Stop,Load/Unload Counters</span><br><span class="line">LogSense 0x0F 00 Application Client Log (64 entries)</span><br><span class="line">LogSense 0x10 00 Self-Test Results</span><br><span class="line">LogSense 0x15 00 Background Media Scan Results</span><br><span class="line">LogSense 0x18 00 Protocol Specific Log Parameters</span><br><span class="line">LogSense 0x1A 00 Power State Transitiions</span><br><span class="line">LogSense 0x2F 00 SMART Status and Temperature Reading</span><br><span class="line">LogSense 0x30 00 Performance Counter Information</span><br><span class="line">LogSense 0x37 00 Performance Statistics</span><br><span class="line">LogSense 0x38 00 Voltage Monitoring Log</span><br><span class="line">LogSense 0x3C 00 Helium Status Log (0 entries)</span><br><span class="line"></span><br><span class="line">From the SBC-4 document, here is a list of Log Pages</span><br><span class="line">Table 180 — Log page codes and subpage codes for direct access block devices</span><br><span class="line">Log page name Page code a Subpage code a Reference</span><br><span class="line">Application Client 0Fh 00h SPC-5</span><br><span class="line">ATA PASS-THROUGH Results 16h 00h SAT-3</span><br><span class="line">Background Scan Results 15h 00h 6.4.2</span><br><span class="line">Background Operation 15h 02h 6.4.3</span><br><span class="line">Buffer Over-Run/Under-Run 01h 00h SPC-5</span><br><span class="line">Cache Memory Statistics 19h 20h SPC-5</span><br><span class="line">Environmental Limits 0Dh 02h SPC-5</span><br><span class="line">Environmental Reporting 0Dh 01h SPC-5</span><br><span class="line">Format Status 08h 00h 6.4.4</span><br><span class="line">General Statistics and Performance 19h 00h SPC-5</span><br><span class="line">Group Statistics and Performance (1 to 31) 19h 01h to 1Fh SPC-5</span><br><span class="line">Informational Exceptions 2Fh 00h SPC-5</span><br><span class="line">Last n Deferred Errors Or Asynchronous Events 0Bh 00h SPC-5</span><br><span class="line">Last n Error Events 07h 00h SPC-5</span><br><span class="line">Logical Block Provisioning 0Ch 00h 6.4.5</span><br><span class="line">LPS Misalignment 15h 03h 6.4.6</span><br><span class="line">Non-Medium Error 06h 00h SPC-5</span><br><span class="line">Non-volatile Cache 17h 00h 6.4.7</span><br><span class="line">Pending Defects 15h 01h 6.4.8</span><br><span class="line">Power Condition Transitions 1Ah 00h SPC-5</span><br><span class="line">Protocol-Specific Ports 18h 00h to FEh SPC-5</span><br><span class="line">Read Error Counters 03h 00h SPC-5</span><br><span class="line">Self-Test Results 10h 00h SPC-5</span><br><span class="line">Solid State Media 11h 00h 6.4.9</span><br><span class="line">Start-Stop Cycle Counter 0Eh 00h SPC-5</span><br><span class="line">Supported Log Pages 00h 00h SPC-5</span><br><span class="line">Supported Log Pages and Subpages 00h FFh SPC-5</span><br><span class="line">Supported Subpages 01h to 3Fh FFh SPC-5</span><br><span class="line">Temperature 0Dh 00h SPC-5</span><br><span class="line">Utilization 0Eh 01h 6.4.10</span><br><span class="line">Verify Error Counters 05h 00h SPC-5</span><br><span class="line">Write Error Counters 02h 00h SPC-5</span><br><span class="line">Vendor specific 30h to 3Eh 00h to FEh n/a</span><br><span class="line"></span><br><span class="line">### [scsi errors](https://www.ibm.com/support/knowledgecenter/en/linuxonibm/com.ibm.linux.z.lgdd/lgdd_t_fcp_wrk_actinfo.html)</span><br><span class="line">/sys/class/scsi_device/&lt;device_name&gt;/device/&lt;attribute&gt;</span><br><span class="line"></span><br><span class="line">access_denied	Flag that indicates whether access to the device is restricted by the FCP channel.The value is 1 if access is denied and 0 if access is permitted.If access is denied to your Linux instance, confirm that your SCSI devices are configured as intended. Also, be sure that you really want to share a SCSI device. For shared access to a SCSI device, preferably use NPIV). You might also use different FCP channels or target ports.</span><br><span class="line"></span><br><span class="line">access_shared	This attribute is obsolete. The value is always 0.</span><br><span class="line"></span><br><span class="line">access_readonly	This attribute is obsolete. The value is always 0.</span><br><span class="line"></span><br><span class="line">ked	Flag that indicates whether the device is in blocked state (0 or 1).</span><br><span class="line"></span><br><span class="line">iocounterbits	The number of bits used for I/O counters.</span><br><span class="line"></span><br><span class="line">iodone_cnt	The number of completed or rejected SCSI commands.</span><br><span class="line"></span><br><span class="line">ioerr_cnt	The number of SCSI commands that completed with an error.</span><br><span class="line"></span><br><span class="line">iorequest_cnt	The number of issued SCSI commands.</span><br><span class="line"></span><br><span class="line">queue_type	The type of queue for the SCSI device. The value can be one of the following:</span><br><span class="line">                none</span><br><span class="line">                simple</span><br><span class="line">                ordered</span><br><span class="line"></span><br><span class="line">model	The model of the SCSI device, received from inquiry data.</span><br><span class="line"></span><br><span class="line">rev	The revision of the SCSI device, received from inquiry data.</span><br><span class="line"></span><br><span class="line">scsi_level	The SCSI revision level, received from inquiry data.</span><br><span class="line"></span><br><span class="line">type	The type of the SCSI device, received from inquiry data.</span><br><span class="line"></span><br><span class="line">vendor	The vendor of the SCSI device, received from inquiry data.</span><br><span class="line"></span><br><span class="line">fcp_lun	The LUN of the SCSI device in 64-bit format.</span><br><span class="line"></span><br><span class="line">hba_id	The bus ID of the SCSI device.</span><br><span class="line"></span><br><span class="line">wwpn	The WWPN of the remote port.</span><br><span class="line">zfcp_access_denied	Flag that indicates whether access to the device is restricted by the FCP channel.The value is 1 if access is denied and 0 if access is permitted. If access is denied to your Linux instance, confirm that your SCSI devices are configured as intended. Also, be sure that you really want to share a SCSI device. For shared access to a SCSI device, preferably use NPIV). You might also use different FCP channels or target ports.</span><br><span class="line"></span><br><span class="line">zfcp_in_recovery	Shows if unit is in recovery (0 or 1).Shows if unit is in recovery (2 or 1)</span><br><span class="line"></span><br><span class="line">```bash</span><br><span class="line">$ lsscsi -dLsv</span><br><span class="line">[14:0:93:0]  disk    HGST     HUH721010AL5200  A21D  /dev/sdi [8:128]  10.0TB</span><br><span class="line">  device_blocked=0</span><br><span class="line">  iocounterbits=32</span><br><span class="line">  iodone_cnt=0xa066</span><br><span class="line">  ioerr_cnt=0x3</span><br><span class="line">  iorequest_cnt=0xa066</span><br><span class="line">  queue_depth=254</span><br><span class="line">  queue_type=none</span><br><span class="line">  scsi_level=7</span><br><span class="line">  state=running</span><br><span class="line">  timeout=60</span><br><span class="line">  type=0</span><br><span class="line">  dir: /sys/bus/scsi/devices/14:0:93:0  [/sys/devices/pci0000:80/0000:80:03.0/0000:85:00.0/host14/port-14:0/expander-14:0/port-14:0:15/end_device-14:0:15/target14:0:93/14:0:93:0]</span><br></pre></td></tr></table></figure></p>
]]></content>
      
        <categories>
            
            <category> Linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> scsi </tag>
            
            <tag> jbod </tag>
            
            <tag> monitor </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Bash tips]]></title>
      <url>http://yoursite.com/2017/10/18/Bash-tips/</url>
      <content type="html"><![CDATA[<h3 id="Termination-Signals-https-www-gnu-org-software-libc-manual-html-node-Termination-Signals-html"><a href="#Termination-Signals-https-www-gnu-org-software-libc-manual-html-node-Termination-Signals-html" class="headerlink" title="[Termination Signals] (https://www.gnu.org/software/libc/manual/html_node/Termination-Signals.html)"></a>[Termination Signals] (<a href="https://www.gnu.org/software/libc/manual/html_node/Termination-Signals.html" target="_blank" rel="external">https://www.gnu.org/software/libc/manual/html_node/Termination-Signals.html</a>)</h3><ul>
<li>1 SIGHUP The SIGHUP (“hang-up”) signal is used to report that the user’s terminal is disconnected, perhaps because a network or telephone connection was broken.</li>
<li>2 SIGINT The SIGINT (program interrupt) signal is sent when the user types the INTR character (normally C-c).</li>
<li>3 The SIGQUIT signal is similar to SIGINT, except that it’s controlled by a different key-the QUIT character, usually C--and produces a core dump when it terminates the process, just like a program error signal. You can think of this as a program error condition “detected” by the user</li>
<li>9 The SIGKILL signal is used to cause immediate program termination. It cannot be handled or ignored, and is therefore always fatal. It is also not possible to block this signal</li>
<li>15 The SIGTERM signal is a generic signal used to cause program termination. Unlike SIGKILL, this signal can be blocked, handled, and ignored. It is the normal way to politely ask a program to terminate.<h3 id="Trap"><a href="#Trap" class="headerlink" title="Trap"></a>Trap</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="function"><span class="title">mytrap</span></span> () &#123;</span><br><span class="line">  <span class="built_in">echo</span> hahahahaha</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">trap</span> mytrap SIGHUP SIGINT SIGQUIT SIGTERM ERR EXIT</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">myfunc</span></span> () &#123;</span><br><span class="line"> <span class="built_in">trap</span>  mytrap RETURN</span><br><span class="line"> <span class="comment">#trap  mytrap EXIT #no output</span></span><br><span class="line"> <span class="built_in">echo</span> <span class="string">"I've got a bad feeling about this..."</span></span><br><span class="line">&#125;</span><br><span class="line">myfunc | cat</span><br><span class="line">sleep 10</span><br></pre></td></tr></table></figure>
</li>
</ul>
]]></content>
      
        <categories>
            
            <category> linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> bash </tag>
            
            <tag> shell </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[About_nfs]]></title>
      <url>http://yoursite.com/2017/08/25/About-nfs/</url>
      <content type="html"><![CDATA[<h3 id="nolock"><a href="#nolock" class="headerlink" title="nolock"></a><a href="https://linux.die.net/man/5/nfs" target="_blank" rel="external">nolock</a></h3><p>NLM locking is used for this mount point. When using the nolock option, applications can lock files, but such locks provide exclusion only against other applications running on the same client. Remote applications are not affected by these locks.</p>
<h3 id="file-lock"><a href="#file-lock" class="headerlink" title="file lock"></a><a href="https://docstore.mik.ua/orelly/networking_2ndEd/nfs/ch11_02.htm" target="_blank" rel="external">file lock</a></h3><p>The NFS (Versions 2 and 3) protocol does not support file locking, but the NFS environment supports an ancillary protocol called NLM, which originally stood for “Network Lock Manager.” When an NFS filesystem on an NFS client gets a request to lock a file, instead of an NFS remote procedure call, it generates an NLM remote procedure call.</p>
<p>The NLM protocol consists of remote procedure calls that pattern fcntl arguments and results. Because blocking locks are supported (a process blocks waiting for a lock that conflicts with another holder), the NLM protocol has the notion of callbacks, from the file server to the NLM client to notify that a lock is available. In this way, the NLM client sometimes acts as an RPC server in order to receive delayed results from lock calls.</p>
]]></content>
      
        <categories>
            
            <category> nfs </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> nfs </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[NIC issues]]></title>
      <url>http://yoursite.com/2017/08/14/NIC-issues/</url>
      <content type="html"><![CDATA[<h4 id="Resolve-process"><a href="#Resolve-process" class="headerlink" title="Resolve process"></a>Resolve process</h4><ul>
<li>Upgrade firmware/driver<ul>
<li>Driver parameter</li>
</ul>
</li>
<li>Disable iptables</li>
<li>Improve ring buffer</li>
<li>Modify kernel network parameter sysctl.conf</li>
<li>Disable irqbalance, set the device irq affinity in local numa node</li>
<li>Enable RPS/RFS/XPS</li>
<li>Enable performance mode</li>
</ul>
<h4 id="About-RSS"><a href="#About-RSS" class="headerlink" title="About RSS"></a><a href="http://blog.csdn.net/vah101/article/details/40077937" target="_blank" rel="external">About RSS</a></h4><p>For unsupport optical module<br>modprobe ixgbe allow_unsupported_sfp=1,1</p>
<p>Setting RSS queue<br>MQ:Disable or enable Multiple Queues, default 1 (array of int)<br>RSS:Number of Receive-Side Scaling Descriptor Queues, default 0=number of cpus (array of int)<br>modprobe ixgbe MQ=1,1 RSS=8,8</p>
<p>$ cat /etc/modprobe.d/ixgbe.conf<br>options ixgbe allow_unsupported_sfp=1,1<br>options ixgbe MQ=1,1 RSS=8,8<br>options ixgbe LRO=1<br>options ixgbe InterruptThrottleRate=20000,20000</p>
<p>InterruptThrottleRate:Maximum interrupts per second, per vector, (0,1,956-488281), default 1 (array of int)<br>LRO:Large Receive Offload (0,1), default 0 = off (array of int)</p>
<h4 id="Ethernet-Flow-Director"><a href="#Ethernet-Flow-Director" class="headerlink" title="Ethernet Flow Director"></a>Ethernet Flow Director</h4><p>ethtool -K eth2 ntuple on<br>ethtool –config-ntuple eth2 flow-type ip4 src-ip 192.168.100.1  action -1<br>ethtool –config-ntuple eth2 flow-type tcp4 src-port 80  action 2<br>ethtool –config-ntuple eth2 flow-type udp4 src-port 80  action 2</p>
<h4 id="Offload"><a href="#Offload" class="headerlink" title="Offload"></a>Offload</h4><p>ethtool -K ethX rx on  ## rx-checksuming tcp offload<br>ethtool -K ethX sg  ## tcp-sgmentation offloading<br><a href="https://www.mellanox.com/related-docs/prod_software/Performance_Tuning_Guide_for_Mellanox_Network_Adapters_Archive.pdf" target="_blank" rel="external">For 100GbE</a><br>In case “tx-nocache-copy” is enabled, (this is the case for some kernels, e.g. kernel 3.10,<br>which is the default for RH7.0) “tx-nocache-copy” should be disabled.<br>ethtool -K <interface> tx-nocache-copy off</interface></p>
<h4 id="Performance-mode"><a href="#Performance-mode" class="headerlink" title="Performance mode"></a>Performance mode</h4><h5 id="Get-numa-node"><a href="#Get-numa-node" class="headerlink" title="Get numa node"></a>Get numa node</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/class/net/[interface]/device/numa_node</span><br><span class="line">cat /sys/devices/[PCI root]/[PCIe <span class="keyword">function</span>]/numa_node</span><br></pre></td></tr></table></figure>
<h5 id="Enable-CPU-performance-mode"><a href="#Enable-CPU-performance-mode" class="headerlink" title="Enable CPU performance mode"></a>Enable CPU performance mode</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">grub parameter: intel_idle.max_cstate=0 processor.max_cstate=1</span><br><span class="line"></span><br><span class="line">cpupower idle-set <span class="_">-d</span> 4</span><br><span class="line">cpupower idle-set <span class="_">-d</span> 3</span><br><span class="line">cpupower idle-set <span class="_">-d</span> 2</span><br><span class="line">cpupower  frequency-set -g performance</span><br><span class="line">tuned-adm profile throughput-performance</span><br><span class="line">tuned-adm active</span><br><span class="line">or </span><br><span class="line"><span class="built_in">echo</span> performance &gt; /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor</span><br><span class="line"></span><br><span class="line">cat /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_max_freq</span><br><span class="line">cat /sys/devices/system/cpu/cpu*/cpufreq/cpuinfo_cur_freq</span><br></pre></td></tr></table></figure>
<h4 id="Sysctl-conf"><a href="#Sysctl-conf" class="headerlink" title="Sysctl.conf"></a><a href="https://www.mellanox.com/related-docs/prod_software/Performance_Tuning_Guide_for_Mellanox_Network_Adapters_Archive.pdf" target="_blank" rel="external">Sysctl.conf</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">The following changes are recommended <span class="keyword">for</span> improving IPv4 traffic performance:</span><br><span class="line">Disable the TCP timestamps option <span class="keyword">for</span> better CPU utilization:</span><br><span class="line">sysctl -w net.ipv4.tcp_timestamps=0</span><br><span class="line"></span><br><span class="line">Enable the TCP selective acks option <span class="keyword">for</span> better throughput:</span><br><span class="line">With selective acknowledgments, the data receiver can inform the sender about all segments that have arrived successfully, so the sender need retransmit only the segments that have actually been lost.</span><br><span class="line">sysctl -w net.ipv4.tcp_sack=1</span><br><span class="line"></span><br><span class="line">Increase the maximum length of processor input queues:</span><br><span class="line">sysctl -w net.core.netdev_max_backlog=250000</span><br><span class="line"></span><br><span class="line">Increase the TCP maximum and default buffer sizes using setsockopt():</span><br><span class="line">sysctl -w net.core.rmem_max=4194304</span><br><span class="line">sysctl -w net.core.wmem_max=4194304</span><br><span class="line">sysctl -w net.core.rmem_default=4194304</span><br><span class="line">sysctl -w net.core.wmem_default=4194304</span><br><span class="line">sysctl -w net.core.optmem_max=4194304</span><br><span class="line"></span><br><span class="line">Increase memory thresholds to prevent packet dropping:</span><br><span class="line">sysctl -w net.ipv4.tcp_rmem=<span class="string">"4096 87380 4194304"</span></span><br><span class="line">sysctl -w net.ipv4.tcp_wmem=<span class="string">"4096 65536 4194304"</span></span><br><span class="line"></span><br><span class="line">Enable low latency mode <span class="keyword">for</span> TCP:</span><br><span class="line">sysctl -w net.ipv4.tcp_low_latency=1</span><br><span class="line"></span><br><span class="line">sysctl -w net.ipv4.tcp_adv_win_scale=1</span><br><span class="line">The following variable is used to tell the kernel how much of the socket buffer space should be used <span class="keyword">for</span> TCP window size, and how much to save <span class="keyword">for</span> an application buffer.</span><br><span class="line">A value of 1 means the socket buffer will be divided evenly between TCP windows size and application.</span><br></pre></td></tr></table></figure>
<h5 id="nic-interrupt-rates"><a href="#nic-interrupt-rates" class="headerlink" title="nic interrupt rates"></a><a href="https://www.ibm.com/support/knowledgecenter/en/SSQPD3_2.6.0/com.ibm.wllm.doc/usingethtoolrates.html" target="_blank" rel="external">nic interrupt rates</a></h5><ul>
<li>adaptive-rx Dynamic control to decrease RX latency at low packet rates and increase throughput at high packet rates</li>
<li>rx-usecs This is the number of microseconds to wait before raising an RX interrupt after a packet has been received. When rx-usecs is set to 0 rx-frames is used</li>
<li>rx-frames    This is the number of frames to queue up before raising an RX interrupt.</li>
<li>adaptive-tx Dynamic control to decrease TX latency at low packet rates and increase throughput at high packet rates</li>
<li>tx-usecs This is the number of microseconds to wait before raising an TX interrupt after a packet has been sent. When tx-usecs is set to 0 tx-frames is used</li>
<li>tx-frames This is the number of frames to queue up before raising an TX interrupt</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#10GbE 82599 setting</span></span><br><span class="line">ls /sys/class/net | egrep <span class="string">'(eth|en|p|em|br|bond)'</span> | <span class="keyword">while</span> <span class="built_in">read</span> nic</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  ethtool -C <span class="variable">$nic</span> rx-usecs 0 tx-usecs 0 adaptive-rx off adaptive-tx off <span class="comment">## there are some compatibility with a vendor 25GbE</span></span><br><span class="line">  ethtool -G <span class="variable">$nic</span> rx 4096/8192 tx 4096/8192 <span class="comment">#for latency, you could reduce the value,rx-ring,tx-ring #10GbE 82599, 25GbE , 50GbE has more</span></span><br><span class="line">  ethtool -N <span class="variable">$nic</span> rx-flow-hash udp4 sdfn</span><br><span class="line">  ifconfig <span class="variable">$nic</span> mtu 9000</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h4 id="Check-command"><a href="#Check-command" class="headerlink" title="Check command"></a>Check command</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ip <span class="_">-s</span> <span class="_">-s</span> link/ifconfig</span><br><span class="line">ethttool -S dev | grep -Ei <span class="string">'err|miss|dis|drop|crc'</span></span><br><span class="line">sar -n DEV,ETCP 2</span><br><span class="line"></span><br><span class="line"><span class="comment"># get firbe module detail</span></span><br><span class="line">ethttool -m dev </span><br><span class="line"></span><br><span class="line"><span class="comment">##Get them from</span></span><br><span class="line">/sys/class/net/em2/statistics/</span><br><span class="line">/proc/net/dev</span><br></pre></td></tr></table></figure>
<h4 id="RPS-RFS-for-not-support-RSS-ethernet-network-apapter"><a href="#RPS-RFS-for-not-support-RSS-ethernet-network-apapter" class="headerlink" title="RPS/RFS for not support RSS ethernet network apapter"></a>RPS/RFS for not support RSS ethernet network apapter</h4><h5 id="Check-the-device-support-RSS"><a href="#Check-the-device-support-RSS" class="headerlink" title="Check the device support RSS"></a>Check the device support RSS</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lspci -v <span class="_">-s</span> 83:00.0 | grep <span class="string">"MSI-X: Enable+"</span></span><br><span class="line">83:00.0 Ethernet controller: Intel Corporation 82599ES 10-Gigabit SFI/SFP+ Network Connection (rev 01)</span><br><span class="line">	Flags: bus master, fast devsel, latency 0, IRQ 247, NUMA node 1</span><br><span class="line">	I/O ports at d020 [size=32]</span><br><span class="line">	Capabilities: [50] MSI: Enable- Count=1/1 Maskable+ 64bit+</span><br><span class="line">	Capabilities: [70] MSI-X: Enable+ Count=64 Masked-</span><br></pre></td></tr></table></figure>
<p>I don’t know why there are some network adapter could not work well in 4 x numa node and in these server, all 25GbE adapter support RSS, some of vendor 4 x numa node is OK, there are the same network chip in each server, except they are the different OEM adapter<br>So I have to enabe RPS to get good performance, I guess it server design problem<br>There are about 10000~30000/s tcp retrans.</p>
<p>Here is the script for 4 x numa</p>
<p><a href="https://community.mellanox.com/docs/DOC-2820" target="_blank" rel="external">For interfaces that have a single queue or its number of queues is less than the number of NUMA node cores, it is recommended to configure the rps_cpus mask to the device NUMA node core list to gain the better parallelism of multi queue interfaces.</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/class/net/eth7/device/<span class="built_in">local</span>_cpus</span><br><span class="line">0000,000fffc0,00000000,0fffc000</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">bond=bond0</span><br><span class="line">rfc=16392</span><br><span class="line">cc=$(grep -c processor /proc/cpuinfo)</span><br><span class="line">rsfe=$((<span class="variable">$cc</span>*<span class="variable">$rfc</span>))</span><br><span class="line"></span><br><span class="line">sysctl -w net.core.rps_sock_flow_entries=<span class="variable">$rsfe</span></span><br><span class="line">dmidecode -t system | grep -i huawei &amp;&amp; cat /proc/net/bonding/<span class="variable">$bond</span>  | awk <span class="string">'$0~/Slave Interface:/ &#123;print $NF&#125;'</span> | <span class="keyword">while</span> <span class="built_in">read</span> nic</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    node=$(cat /sys/class/net/<span class="variable">$nic</span>/device/numa_node)</span><br><span class="line">    [[ -z <span class="variable">$node</span> ]] &amp;&amp; <span class="built_in">echo</span> not found numa &amp;&amp; <span class="built_in">exit</span> 1</span><br><span class="line">    [[ -z <span class="variable">$nic</span> ]] &amp;&amp; <span class="built_in">echo</span> not found bond &amp;&amp; <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"the nic is <span class="variable">$nic</span> in the node-<span class="variable">$node</span>"</span></span><br><span class="line">    service iptables stop</span><br><span class="line">    ethtool -G <span class="variable">$nic</span> rx 8192 tx 1024</span><br><span class="line">    ethtool -G <span class="variable">$nic</span> rx 8192 tx 1024</span><br><span class="line">    ethtool -K <span class="variable">$nic</span> lro on</span><br><span class="line">    ethtool -K <span class="variable">$bond</span> lro on</span><br><span class="line">    service irqbalance stop</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ -n <span class="variable">$node</span> ];<span class="keyword">then</span></span><br><span class="line">          <span class="built_in">echo</span> <span class="string">"bind int to node <span class="variable">$node</span>"</span></span><br><span class="line">          <span class="built_in">set</span>_irq_affinity_bynode.sh <span class="variable">$node</span> <span class="variable">$nic</span> <span class="comment">##### mlnx driver script</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> fileRps <span class="keyword">in</span> $(ls /sys/class/net/<span class="variable">$&#123;nic&#125;</span>/queues/rx-*/rps_cpus)</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">           [[ <span class="variable">$node</span> <span class="_">-eq</span> 1 ]] &amp;&amp; <span class="built_in">echo</span> 0000,00000000,00000000,0ff00000 &gt;<span class="variable">$fileRps</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> fileR<span class="built_in">fc</span> <span class="keyword">in</span> $(ls /sys/class/net/<span class="variable">$&#123;nic&#125;</span>/queues/rx-*/rps_flow_cnt)</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">           <span class="built_in">echo</span> <span class="variable">$rfc</span> &gt;<span class="variable">$fileRfc</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> fileRps <span class="keyword">in</span> $(ls /sys/class/net/<span class="variable">$&#123;nic&#125;</span>/queues/tx-*/xps_cpus)</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">           [[ <span class="variable">$node</span> <span class="_">-eq</span> 1 ]] &amp;&amp; <span class="built_in">echo</span> 0000,00000000,00000000,000<span class="built_in">fc</span>000 &gt;<span class="variable">$fileRps</span></span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p><a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/performance_tuning_guide/network-rfs" target="_blank" rel="external">RFS</a> is disabled by default. To enable RFS, you must edit two files:<br>/proc/sys/net/core/rps_sock_flow_entries<br>Set the value of this file to the maximum expected number of concurrently active connections. We recommend a value of 32768 for moderate server loads. All values entered are rounded up to the nearest power of 2 in practice.<br>/sys/class/net/device/queues/rx-queue/rps_flow_cnt<br>Replace device with the name of the network device you wish to configure (for example, eth0), and rx-queue with the receive queue you wish to configure (for example, rx-0).<br>Set the value of this file to the value of rps_sock_flow_entries divided by N, where N is the number of receive queues on a device. For example, if rps_flow_entries is set to 32768 and there are 16 configured receive queues, rps_flow_cnt should be set to 2048. For single-queue devices, the value of rps_flow_cnt is the same as the value of rps_sock_flow_entries.<br>Data received from a single sender is not sent to more than one CPU. If the amount of data received from a single sender is greater than a single CPU can handle, configure a larger frame size to reduce the number of interrupts and therefore the amount of processing work for the CPU. Alternatively, consider NIC offload options or faster CPUs.</p>
<p><a href="http://www.simlinux.com/2017/02/28/net-softirq.html#RPS-RFS" target="_blank" rel="external">RPS</a>: 网卡驱动对每一个数据库包根据四元组(SIP,SPORT,DIP,DPORT)生成HASH值,通过HASH值将每个连接和CPU 绑定<br>RFS： 由于RPS只是单纯的把数据包均衡到不同的CPU上，此时如果应用程序所在CPU和中断处理的CPU不在同一个核，将会对CPU Cache影响很大，RFS的作用就是将应用程序和软中断处理分配到同一个CPU<br>XPS: 负载均衡选择网卡多队列发包<br>Data received from a single sender is not sent to more than one CPU. If the amount of data received from a single sender is greater than a single CPU can handle, configure a larger frame size to reduce the number of interrupts and therefore the amount of processing work for the CPU. Alternatively, consider NIC offload options or faster CPUs.<br>(Consider using numactl or taskset in conjunction with RFS to pin applications to specific cores, sockets, or NUMA nodes. This can help prevent packets from being processed out of order)[<a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/performance_tuning_guide/network-rfs" target="_blank" rel="external">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/performance_tuning_guide/network-rfs</a>)</p>
<h4 id="RHEL-solutions"><a href="#RHEL-solutions" class="headerlink" title="RHEL solutions"></a><a href="https://access.redhat.com/solutions/21301" target="_blank" rel="external">RHEL solutions</a></h4><p>System dropping network packets</p>
<ul>
<li>High number of drop counters like drop, discard, err or error, fifo, buf or buffer, fail, miss, OOB, full counters in ethtool -S</li>
<li>High number of dropped, error, overrun, or frame counters in ifconfig</li>
<li>What is the first thing to try when I see my network interfaces dropping packets?<br>Root Cause<br>Counters like “discard” or “drop” in the output of ethtool -S ethX are caused by the exhaustion of the receive ring buffer.</li>
</ul>
<p>The ring buffer is a block of physical memory on the NIC.</p>
<p>Each packet received by the NIC is stored in this memory while an interrupt is sent to the kernel to fetch the packet into kernel memory.</p>
<p>If the available buffer is filling up faster than the kernel can take the packets, there will be discarded packets.</p>
<p>Verify packet loss with:<br>[root@host]# ip -s -s link<br>Verify discards/drops/etc with:<br>[root@host]# ethtool -S ethX<br>Verify RX ring buffer current and maximum settings with:<br>[root@host]# ethtool -g ethX</p>
<h5 id="0-05-packet-drop-rate"><a href="#0-05-packet-drop-rate" class="headerlink" title="0.05% packet drop rate"></a><a href="https://access.redhat.com/solutions/742043" target="_blank" rel="external">0.05% packet drop rate</a></h5><p>One of TCP’s main functions is to preserve a reliable data stream for applications by identifying and retrying any lost packets. It is normal operation for an underlying network to lose packets, for many different reasons, and for TCP be used and to hide this fact from application layers. Applications using unreliable transports (the major one being UDP) are expected to not care about the unreliability of the network. Applications which do care should use a reliable transport, eg. TCP (or more recently, SCTP) or implement their own reliability mechanisms.</p>
<p>The only impact of packet loss in the underlying network (which includes the device-drivers and lower network layer code which is counting the drops you are seeing) is a reduction in performance from the peak network speed. The reduction is dependent, non-linearly, on the packet drop ratio, and also on the traffic type. For bulk transfers (such as file-transfer) over TCP a drop ratio of under 0.1% results in a very small reduction in throughput – assuming that the Select Acknowledgement (SACK) TCP option is enabled on both systems. If SACK is disabled on either system there will be a measurable reduction in throughput if the drop rate exceeds 0.001%. On the other hand, thin stream traffic, where there is often no outstanding data for the transmitter to send, will be affected more as the need to retry lost packets will only be noticed after a time out rather than being detectable when data arrives out-of-order. Examples of thin-stream traffic include request-response and interactive connections.</p>
<h4 id="ifconfig-ip"><a href="#ifconfig-ip" class="headerlink" title="ifconfig/ip"></a><a href="https://unix.stackexchange.com/questions/184604/whats-the-difference-between-errors-dropped-overruns-and-frame-fiel" target="_blank" rel="external">ifconfig/ip</a></h4><ul>
<li><p>RX</p>
<ul>
<li><p>frame/length counts only misaligned frames, it means frames with a length not divisible by 8. Because of that length is not a valid frame and it is simply discarded (too-short frames and too-long frames)</p>
</li>
<li><p>overruns/fifo counts that times when there is fifo overruns, caused by the rate at which the buffer gets full and the kernel isn’t able to reclaim the buffer</p>
<ul>
<li>No cpu resource, interrupt not balance and not affinity, eg: all nic interrupt in core0</li>
</ul>
</li>
<li><p><a href="https://serverfault.com/questions/528290/ifconfig-eth0-rx-dropped-packets/601186" target="_blank" rel="external">dropped(normal) counts</a></p>
<ul>
<li>Softnet backlog full</li>
<li>Bad / Unintended VLAN tags</li>
<li>Unknown / Unregistered protocols</li>
<li>IPv6 frames when the server is not configured for IPv6</li>
</ul>
</li>
<li><p>dropped (in my opinion)</p>
<ul>
<li>Overloading</li>
<li>Hardware issue<ul>
<li>NIC ring buffer too slower</li>
<li>NIC/optical module issue</li>
<li>PCIE issue</li>
<li>Bad cable</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p><a href="http://blog.hyfather.com/blog/2013/03/04/ifconfig/" target="_blank" rel="external">TX</a></p>
<ul>
<li>aborted transmission</li>
<li>errors due to carrirer</li>
<li>fifo err</li>
<li>heartbeat erros</li>
<li>window err</li>
<li>collisions is the number of transmissions terminated due to CSMA/CD (Carrier Sense Multiple Access with Collision Detection).</li>
</ul>
</li>
</ul>
<p>If NIC driver loss packages, linux don ‘t know, you can’t count it in linux<br>Some overrun(ifconfig) has the same means with dropped(ethtool)</p>
<ul>
<li><a href="https://lp007819.wordpress.com/2013/05/23/intel%E7%BD%91%E5%8D%A1%E7%8A%B6%E6%80%81%E7%BB%9F%E8%AE%A1%E7%96%91%E9%97%AE/" target="_blank" rel="external">rx_missed_errors</a><ul>
<li>real drop = rx_dropped(kernel drop) + rx_missed_errors<ul>
<li>To reduce DMA skb(socket buffer) to test, eg: ethtool -G eth1 rx 48, ethtool -G eth1 tx 48, there are a lot of rx_missed_err </li>
<li>这样看来rx_no_buffer_count 指的是在网卡通过DMA将设备FIFO中的skb-&gt;data传送到rx_buffer_info时，发现对应的rx_buffer_info还没有unmap，也就无法送到主存。说到底，这其实和软中断处理的速度有关。<br>猜测rx_missed_errors可能与硬中断有关。也就是在DMA传送完，发送硬中断之前，网卡的FIFO缓冲已经满了，导致接收的数据要立即丢掉。这个也可以验证：<br>首先卸载igb模块，然后insmod igb InterruptThrottleRate=10, 只让网卡每秒产生10个中断。关闭流控ethtool -A eth1 autoneg off , ethtool -A eth1 rx off , ethtool -A eth1 tx off ，再把DMA缓冲区调至最大ethtool -G eth1 rx 4096 , ethtool -G eth1 tx 4096。可以发现原来不增长或几乎不增长的rx_missed_errors 开始大幅增长，果然这个就是和网卡硬件的FIFO缓冲区有关。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="About-MPC-and-RNBC"><a href="#About-MPC-and-RNBC" class="headerlink" title="About MPC and RNBC"></a>About MPC and RNBC</h4><p>7.19.5 Missed Packets Count – MPC (0x4010; RC)<br>Counts the number of missed packets. Packets are missed when the receive FIFO has insufficient space<br>to store the incoming packet. This can be caused because of too few buffers allocated, or because there<br>is insufficient bandwidth on the PCI bus. Events setting this counter causes ICR.Rx Miss, the Receiver<br>Overrun Interrupt, to be set. This register does not increment if receives are not enabled.<br>These packets are also counted in the Total Packets Received register as well as in Total Octets<br>Received.</p>
<p>7.19.34 Receive No Buffers Count – RNBC (0x40A0; RC)<br>This register counts the number of times that frames were received when there were no available<br>buffers in host memory to store those frames (receive descriptor head and tail pointers were equal).<br>The packet is still received if there is space in the FIFO. This register only increments if receives are enabled (RCTL.RXEN is set).<br>This register does not increment when flow control packets are received.</p>
<h4 id="Tools"><a href="#Tools" class="headerlink" title="Tools"></a>Tools</h4><p><a href="http://jaseywang.me/2014/08/16/ifconfig-%E4%B8%8B%E9%9D%A2%E7%9A%84%E4%B8%80%E4%BA%9B%E5%AD%97%E6%AE%B5errors-dropped-overruns/" target="_blank" rel="external">ethtool</a></p>
<ul>
<li>Physical layer<ul>
<li>Speed</li>
<li>Duplex</li>
<li>CRC</li>
</ul>
</li>
</ul>
<p><a href="http://techblog.netflix.com/2015/11/linux-performance-analysis-in-60s.html" target="_blank" rel="external">sar</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sar -n TCP,ETCP 2</span><br><span class="line">02:47:30 AM  active/s passive/s    iseg/s    oseg/s</span><br><span class="line">02:47:31 AM      0.00      0.00      8.51      6.38</span><br><span class="line"></span><br><span class="line">02:47:30 AM  atmptf/s  estres/s retrans/s isegerr/s   orsts/s</span><br><span class="line">02:47:31 AM      0.00      0.00      0.00      0.00      0.00</span><br></pre></td></tr></table></figure></p>
<p>active/s: Number of locally-initiated TCP connections per second (e.g., via connect()).<br>passive/s: Number of remotely-initiated TCP connections per second (e.g., via accept()).<br>retrans/s: Number of TCP retransmits per second.<br>The active and passive counts are often useful as a rough measure of server load: number of new accepted connections (passive), and number of downstream connections (active). It might help to think of active as outbound, and passive as inbound, but this isn’t strictly true (e.g., consider a localhost to localhost connection). </p>
<p>Retransmits are a sign of a network or server issue; it may be an unreliable network (e.g., the public Internet), or it may be due a server being overloaded and dropping packets. The example above shows just one new TCP connection per-second. </p>
<ul>
<li><a href="https://stackoverflow.com/questions/21113846/why-packet-drop-is-not-captured-under-ifconfig" target="_blank" rel="external">About iptables</a><ul>
<li>This is because iptables and ifconfig statistics refer to different layers in the protocol stack. ifconfig statistics are for the NIC (Physical and MAC layers) while iptables rules execute once frames are received by the NIC and delivered to the kernel (INPUT) or before the packet is delivered to layer 2 in the protocol stack (for OUTPUT)</li>
</ul>
</li>
</ul>
<h4 id="About-irqbalance"><a href="#About-irqbalance" class="headerlink" title="About irqbalance"></a><a href="https://community.mellanox.com/docs/DOC-2123" target="_blank" rel="external">About irqbalance</a></h4><p>Irqbalance is a Linux daemon that help to balance the CPU load generated by interrupts across all CPUs. Irqbalance identifies the highest volume interrupt sources, and isolates them to a single CPU, so that load is spread as much as possible over an entire processor set, while minimizing cache hit rates for irq handlers<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#debug irqbalance</span></span><br><span class="line">irqbalance <span class="_">-d</span> <span class="_">-f</span></span><br></pre></td></tr></table></figure></p>
<p><a href="https://access.redhat.com/sites/default/files/attachments/201501-perf-brief-low-latency-tuning-rhel7-v1.1.pdf" target="_blank" rel="external">perf-brief-low-latency-tuning-rhel7</a><br>The irqbalance service continues to be enabled by default in Red Hat Enterprise Linux 7. It<br>remains an important service that helps spread IRQ-processing load across multiple processors dynamically.</p>
<p>For more performance<br>here could be specific workloads or configuration where stopping irqbalance and using mlnx_tune is more optimal and recommended.</p>
<h4 id="About-interruptthrottlerate"><a href="#About-interruptthrottlerate" class="headerlink" title="About interruptthrottlerate"></a><a href="https://www.kernel.org/doc/Documentation/networking/e1000.txt" target="_blank" rel="external">About interruptthrottlerate</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Setting InterruptThrottleRate to a value greater or equal to 100</span><br><span class="line">will program the adapter to send out a maximum of that many interrupts</span><br><span class="line">per second, even <span class="keyword">if</span> more packets have come in. This reduces interrupt</span><br><span class="line">load on the system and can lower CPU utilization under heavy load,</span><br><span class="line">but will increase latency as packets are not processed as quickly.</span><br><span class="line"></span><br><span class="line">The default behaviour of the driver previously assumed a static</span><br><span class="line">InterruptThrottleRate value of 8000</span><br></pre></td></tr></table></figure>
<h4 id="About-LRO"><a href="#About-LRO" class="headerlink" title="About LRO"></a><a href="https://downloadmirror.intel.com/22919/eng/README.txt" target="_blank" rel="external">About LRO</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">LRO</span><br><span class="line">---</span><br><span class="line">Large Receive Offload (LRO) is a technique <span class="keyword">for</span> increasing inbound throughput</span><br><span class="line">of high-bandwidth network connections by reducing CPU overhead. It works by</span><br><span class="line">aggregating multiple incoming packets from a single stream into a larger </span><br><span class="line">buffer before they are passed higher up the networking stack, thus reducing</span><br><span class="line">the number of packets that have to be processed. LRO combines multiple </span><br><span class="line">Ethernet frames into a single receive <span class="keyword">in</span> the stack, thereby potentially </span><br><span class="line">decreasing CPU utilization <span class="keyword">for</span> receives.</span><br></pre></td></tr></table></figure>
<h4 id="Support-for-UDP-RSS"><a href="#Support-for-UDP-RSS" class="headerlink" title="Support for UDP RSS"></a><a href="https://downloadmirror.intel.com/22919/eng/README.txt" target="_blank" rel="external">Support for UDP RSS</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">   rx-flow-hash tcp4|udp4|ah4|esp4|sctp4|tcp6|udp6|ah6|esp6|sctp6</span><br><span class="line">     Retrieves the <span class="built_in">hash</span> options <span class="keyword">for</span> the specified network traffic type.</span><br><span class="line"></span><br><span class="line">  -N --config-nfc</span><br><span class="line">     Configures the receive network flow classification.</span><br><span class="line"></span><br><span class="line">   rx-flow-hash tcp4|udp4|ah4|esp4|sctp4|tcp6|udp6|ah6|esp6|sctp6 </span><br><span class="line">   m|v|t|s|d|f|n|r...</span><br><span class="line">     Configures the <span class="built_in">hash</span> options <span class="keyword">for</span> the specified network traffic type.</span><br><span class="line"></span><br><span class="line">     udp4    UDP over IPv4</span><br><span class="line">     udp6    UDP over IPv6</span><br><span class="line"></span><br><span class="line">     f   Hash on bytes 0 and 1 of the Layer 4 header of the rx packet.</span><br><span class="line">     n   Hash on bytes 2 and 3 of the Layer 4 header of the rx packet.</span><br><span class="line"></span><br><span class="line">The following is an example using udp4 (UDP over IPv4):</span><br><span class="line"></span><br><span class="line">  To include UDP port numbers <span class="keyword">in</span> RSS hashing run:</span><br><span class="line">     ethtool -N ethX rx-flow-hash udp4 sdfn</span><br><span class="line"></span><br><span class="line">  To exclude UDP port numbers from RSS hashing run:</span><br><span class="line">     ethtool -N ethX rx-flow-hash udp4 sd</span><br><span class="line"></span><br><span class="line">  To display UDP hashing current configuration run:</span><br><span class="line">     ethtool -n ethX rx-flow-hash udp4</span><br></pre></td></tr></table></figure>
<h3 id="Ethool-S"><a href="#Ethool-S" class="headerlink" title="Ethool -S"></a>Ethool -S</h3><h4 id="rx-tx-ring"><a href="#rx-tx-ring" class="headerlink" title="rx,tx-ring"></a>rx,tx-ring</h4><p>ethtool -G $nic rx 4096 tx 4096</p>
<p>rx_no_buffer_count,there was nowhere to DMA the packet<br>DMA skb-data to rx-buffer-info(linux RAM, soft-interrupt). </p>
<p>RNBC is a warning sign of a slow drain from the MAC and can be treated by adding more buffers.<br>There will be times when the RNBC will go up, but it will look like the stack and driver have a ton of buffers but work is not being done.  If you have a task that is eating up the CPU, the ISR or polling routines won’t refill the buffers fast enough and RNBC will happen.</p>
<p>Imagine we have a slow CPU, but a wicked fastbus.  The software is very slow to process the descriptors and return them, but once the descriptors are given to the hardware, it empties the backlog (read the FIFO) faster than the incoming frames are filling the FIFO.  Returning to our kitchen sink analogy, the water is coming in at a fairly constant rate.  But imagine the stopper is down, making the sink fill up.  Just before it over flows, the drain is opened and down it goes.  Once the water doesn’t go down the drain would be the same moment our RNBC would be incremented.  The kitchen sink itself becomes our FIFO and if the FIFO is big enough, it can save frame for quiet some time.  This is 1 Gigabit (or faster) that we’re talking about, so with a good sized FIFO (24K RX for example) that’s only 375 frames at 64 bytes, or 267microseconds of data.  That’s not very much time.  But in a world full of 2 and 3 Gigahertz CPUs that’s long enough.  </p>
<p>rx_missed_error,rx_no_buffer_count happened enough times that packets were dropped<br>MPC is a failure condition leading to dropped packets and can be treated with more buffers and faster interconnect buses</p>
<p>Thank goodness things like TCP/IP will tell the applications data has been dropped, but if using a lossy frame type like UDP its just too bad, your frame is lost to the ether. </p>
<p>Imagine if you will, an interconnect bus that is slow.  Very slow.  Like a PCI 33hz bus.  Now attach that to a full line rate 1 Gigabit 64 byte packet data stream.  At one descriptor per packet, that’s about 1.4 million descriptors per second.  In this case the software is very fast, faster than the bus.  So the number of available descriptors is always kept a level that keeps the buffers available to the hardware to conduct a DMA.  But because the bus is so slow, data backs up into the FIFO.  Now that is what the FIFO is for.  By buffering the packet, it tries to give the packet the best chance at making into host memory alive.  In our slow case, the buffering isn’t enough and the FIFO fills up.  It is draining slower than its filling, its just a like a slow draining kitchen sink.  Eventually it overflows and makes a big mess.  Thank goodness things like TCP/IP will tell the applications data has been dropped, but if using a lossy frame type like UDP its just too bad, your frame is lost to the ether.  If you need to keep track, but need to use UDP, you’ll need to monitor the MPC count and decide what you want to do when it goes up.</p>
<p>[猜测rx_missed_errors可能与硬中断有关。也就是在DMA传送完，发送硬中断之前，网卡的FIFO缓冲已经满了，导致接收的数据要立即丢掉。这个也可以验证：首先卸载igb模块，然后insmod igb InterruptThrottleRate=10, 只让网卡每秒产生10个中断。关闭流控ethtool -A eth1 autoneg off , ethtool -A eth1 rx off , ethtool -A eth1 tx off ，再把DMA缓冲区调至最大ethtool -G eth1 rx 4096 , ethtool -G eth1 tx 4096。可以发现原来不增长或几乎不增长的rx_missed_errors 开始大幅增长]<br>(<a href="https://lp007819.wordpress.com/2013/05/23/intel%E7%BD%91%E5%8D%A1%E7%8A%B6%E6%80%81%E7%BB%9F%E8%AE%A1%E7%96%91%E9%97%AE/" target="_blank" rel="external">https://lp007819.wordpress.com/2013/05/23/intel%E7%BD%91%E5%8D%A1%E7%8A%B6%E6%80%81%E7%BB%9F%E8%AE%A1%E7%96%91%E9%97%AE/</a>)</p>
<p>rx_fifo_errors,<br>rx_over_errors</p>
<h3 id="ifconfig"><a href="#ifconfig" class="headerlink" title="ifconfig"></a>ifconfig</h3><p>frame counts only misaligned frames, it means frames with a length not divisible by 8. Because of that length is not a valid frame and it is simply discarded.</p>
<p>Meanwhile errors counts CRC errors, too-short frames and too-long frames.</p>
<p>overruns counts that times when there is fifo overruns, caused by the rate at which the buffer gets full and the kernel isn’t able to empty it.</p>
<p>overruns<br>overruns，表示这个数据包还没有被进入到网卡的接收缓存fifo队列就被丢掉，因此此时网卡的fifo是满的。为什么fifo会是满的？因为系统繁忙，来不及响应网卡中断，导致网卡里的数据包没有及时的拷贝到系统内存，fifo是满的就导致后面的数据包进不来，即这个数据包被网卡硬件丢掉。所以，个人觉得遇到overruns非0，需要检测cpu负载与cpu中断情况。</p>
<p><a href="https://www.cisco.com/c/en/us/support/docs/dial-access/asynchronous-connections/15286-serial-overruns.html" target="_blank" rel="external">Q. What are overruns on a serial interface?</a></p>
<p>A. Overruns appear in the output of the show interface Serial 0 command when the serial receiver hardware is unable to hand received data to a hardware buffer because the input rate exceeds the receiver’s ability to handle the data.<br>This occurs due to a limitation of the hardware. Overruns occur when the internal First In, First Out (FIFO) buffer of the chip is full, but is still tries to handle incoming traffic. The serial controller chip has limited internal FIFO.<br>Some chips, for example, have only 256 bytes of buffer space. Data from the network is received into the buffer, whereupon the chip attempts to move the data from the buffer to the router’s shared memory for the CPU to process. If the chip is not able to move the data from its internal FIFO buffer into shared memory faster than the rate at which data is received on the interface, then the internal FIFO buffer is full, incoming data is dropped, and the overrun counter is incremented.</p>
<p>droppeds<br>dropped，表示这个数据包已经进入到网卡的接收缓存fifo队列，并且开始被系统中断处理准备进行数据包拷贝（从网卡缓存fifo队列拷贝到系统内存），但由于此时的系统原因（比如内存不够等）导致这个数据包被丢掉，即这个数据包被Linux系统丢掉。</p>
<h4 id="NFS-hangs"><a href="#NFS-hangs" class="headerlink" title="NFS hangs"></a>NFS hangs</h4><p>NFS server tcp zero window problem</p>
<p>Zero Window is something to investigate. TCP Zero Window is when the Window size in a machine remains at zero for a specified amount of time. This means that a client is not able to receive further information at the moment, and the TCP transmission is halted until it can process the information in its receive buffer.</p>
<h4 id="About-FEC"><a href="#About-FEC" class="headerlink" title="About FEC"></a><a href="http://www.qlogic.com/Resources/Documents/WhitePapers/Adapters/Localized/White_Paper-25Gb_Ethernet_SN0530917-05_CN.pdf" target="_blank" rel="external">About FEC</a></h4><p>IEEE 标准指定了两个底板和铜接口。这些接口的目标不同，因<br>此接口存在不同。–S 短距离接口旨在支持无需转发纠错（FEC）<br>的高质量电缆，以最大限度地降低延迟。全距离接口旨在实现<br>尽可能低的电缆或背板成本以及尽可能长的距离，这需要使用<br>FEC。FEC 选项包括 BASE-R FEC（也称为 Fire Code）和 RS-FEC（也<br>称为 Reed-Solomon）。RS-FEC 已用于一系列应用，包括数据存<br>储卫星传播。BASE-R FEC 是一种新型技术，特别适合纠正背板<br>通道中由于接收均衡器的错误传播而导致的突发错误。</p>
]]></content>
      
        <categories>
            
            <category> network </category>
            
        </categories>
        
        
        <tags>
            
            <tag> nic </tag>
            
            <tag> ethtool </tag>
            
            <tag> driver </tag>
            
            <tag> irqbalance </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[upgrade hgst JBOD]]></title>
      <url>http://yoursite.com/2017/07/31/upgrade-hgst-JBOD/</url>
      <content type="html"><![CDATA[<p>get JBOD encolsure firmware version<br>sg_scan  -i | grep -i 1ES0059  -B 1<br>/dev/sg65: scsi14 channel=0 id=58 lun=0<br>HGST 4U60_STOR_ENCL 0210 [rmb=0 cmdq=1 pqual=0 pdev=0xd]</p>
<p>upgrade firmware<br>[root@testhost1 fw]# ./hgst_upg_tool -d /dev/sg65 -f eros_4.2.5.0_CombinedImage.bin –m 7</p>
<p>upgrade hdd firmware version<br>rpm -ivh hugo-6.1.2-1.x86_64.rpm<br>HUS726060AL5210 is HDD model</p>
<p>update -f ./APGNAD05.bin -m HUS726060AL5210 </p>
]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[grubby]]></title>
      <url>http://yoursite.com/2017/07/12/grub/</url>
      <content type="html"><![CDATA[<p>CentOS 7 add kernel parameter<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grubby --remove-args=<span class="string">"argX argY"</span> --args=<span class="string">"argA argB"</span> --update-kernel /boot/kernel</span><br><span class="line">grubby --update-kernel=ALL --args=<span class="string">'scsi_mod.use_blk_mq=y dm_mod.use_blk_mq=y'</span></span><br></pre></td></tr></table></figure></p>
<p>set default boot<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">grubby --info=ALL</span><br><span class="line">index=0</span><br><span class="line">kernel=/boot/vmlinuz-3.10.0-514.6.1.el7.x86_64</span><br><span class="line">args=<span class="string">"ro crashkernel=auto rd.md.uuid=cc0432b3:6f6f54bf:c2f2b91b:2978ff6a rhgb quiet "</span></span><br><span class="line">root=UUID=5b0e60cf-adf9-42a0-b6e3-0304b919dc33</span><br><span class="line">initrd=/boot/initramfs-3.10.0-514.6.1.el7.x86_64.img</span><br><span class="line">title=CentOS Linux (3.10.0-514.6.1.el7.x86_64) 7 (Core)</span><br><span class="line">index=1</span><br><span class="line">kernel=/boot/vmlinuz-3.10.0-327.el7.x86_64</span><br><span class="line">args=<span class="string">"ro crashkernel=auto rd.md.uuid=cc0432b3:6f6f54bf:c2f2b91b:2978ff6a rhgb quiet "</span></span><br><span class="line">root=UUID=5b0e60cf-adf9-42a0-b6e3-0304b919dc33</span><br><span class="line">initrd=/boot/initramfs-3.10.0-327.el7.x86_64.img</span><br><span class="line">title=CentOS Linux (3.10.0-327.el7.x86_64) 7 (Core)</span><br><span class="line">index=2</span><br><span class="line">kernel=/boot/vmlinuz-0-rescue<span class="_">-f</span>614a3c482eb4b21add5ae750b3871bb</span><br><span class="line">args=<span class="string">"ro crashkernel=auto rd.md.uuid=cc0432b3:6f6f54bf:c2f2b91b:2978ff6a rhgb quiet "</span></span><br><span class="line">root=UUID=5b0e60cf-adf9-42a0-b6e3-0304b919dc33</span><br><span class="line">initrd=/boot/initramfs-0-rescue<span class="_">-f</span>614a3c482eb4b21add5ae750b3871bb.img</span><br><span class="line">title=CentOS Linux (0-rescue<span class="_">-f</span>614a3c482eb4b21add5ae750b3871bb) 7 (Core)</span><br><span class="line">index=3</span><br><span class="line">non linux entry</span><br><span class="line"></span><br><span class="line">grubby --set-default /boot/vmlinuz-3.10.0-229.4.2.el7.x86_64</span><br><span class="line">grubby --info /boot/vmlinuz-3.10.0-229.4.2.el7.x86_64</span><br></pre></td></tr></table></figure></p>
<p><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/System_Administrators_Guide/sec-Making_Persistent_Changes_to_a_GRUB_2_Menu_Using_the_grubby_Tool.html" target="_blank" rel="external">reference</a></p>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> grub </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Enable blk-mq in centos 7.3]]></title>
      <url>http://yoursite.com/2017/07/12/Enable-blk-mq-in-centos-7-3/</url>
      <content type="html"><![CDATA[<h4 id="Does-it-mean-brute-force-I-found-the-answer-in-a-slide-that-resolve-the-most-important-issue"><a href="#Does-it-mean-brute-force-I-found-the-answer-in-a-slide-that-resolve-the-most-important-issue" class="headerlink" title="Does it mean brute force, I found the answer in a slide that resolve the most important issue"></a>Does it mean brute force, I found the answer in a slide that resolve the most important issue</h4><p><a href="http://events.linuxfoundation.org/sites/events/files/slides/scsi.pdf" target="_blank" rel="external">scsi-mq</a><br><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/7.2_Release_Notes/storage.html" target="_blank" rel="external">RHEL7.2 release note</a><br>To enable scsi-mq, specify scsi_mod.use_blk_mq=y on the kernel command line<br>can also be configured to use the blk-mq infrastructure if the dm_mod.use_blk_mq=y kernel option is specified, The default value is n (disabled).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/default/grub </span><br><span class="line">GRUB_TIMEOUT=5</span><br><span class="line">GRUB_DISTRIBUTOR=<span class="string">"<span class="variable">$(sed 's, release .*$,,g' /etc/system-release)</span>"</span></span><br><span class="line">GRUB_DEFAULT=saved</span><br><span class="line">GRUB_DISABLE_SUBMENU=<span class="literal">true</span></span><br><span class="line">GRUB_TERMINAL_OUTPUT=<span class="string">"console"</span></span><br><span class="line">GRUB_CMDLINE_LINUX=<span class="string">"crashkernel=auto rd.md.uuid=c13f982e:9af61476:91e4a31e:1bc18c08 scsi_mod.use_blk_mq=y dm_mod.use_blk_mq=y rhgb quiet"</span></span><br><span class="line">GRUB_DISABLE_RECOVERY=<span class="string">"true"</span></span><br><span class="line"></span><br><span class="line">$ grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg</span><br><span class="line">$ reboot</span><br></pre></td></tr></table></figure>
<h4 id="Make-sure-enable-it"><a href="#Make-sure-enable-it" class="headerlink" title="Make sure enable it"></a>Make sure enable it</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tree /sys/class/block/sdl/mq /sys/class/block/dm-0/mq</span><br></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Performance </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> scsi </tag>
            
            <tag> io </tag>
            
            <tag> performance </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Hot-plugin scan/rescan scsi]]></title>
      <url>http://yoursite.com/2017/07/12/Hot-plugin-scan-rescan-scsi/</url>
      <content type="html"><![CDATA[<h5 id="What-is-h-c-t-l"><a href="#What-is-h-c-t-l" class="headerlink" title="What is h c t l"></a>What is h c t l</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">          h == hostadapter id (first one being 0)</span><br><span class="line">          c == SCSI channel on hostadapter (first one being 0)</span><br><span class="line">          t == ID (target)</span><br><span class="line">          l == LUN (first one being 0)</span><br><span class="line"></span><br><span class="line"><span class="comment"># lsscsi man page</span></span><br><span class="line">       Generic SCSI devices can also be accessed via the bsg driver <span class="keyword">in</span> Linux.  By default, the bsg driver<span class="string">'s device node names  are  of  the  form</span><br><span class="line">       '</span>/dev/bsg/H:C:T:L<span class="string">'.  So,  for example, the SCSI device shown by this utility on a line starting with the tuple '</span>6:0:1:2<span class="string">' could be accessed</span><br><span class="line">       via the bsg driver with the '</span>/dev/bsg/6:0:1:2<span class="string">' device node name.</span></span><br></pre></td></tr></table></figure>
<h5 id="Add-the-scsi-device"><a href="#Add-the-scsi-device" class="headerlink" title="Add the scsi device"></a>Add the scsi device</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"- - -"</span> &gt; /sys/class/scsi_host/host&lt;h&gt;/scan</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"c t l"</span> &gt;  /sys/class/scsi_host/host&lt;h&gt;/scan</span><br></pre></td></tr></table></figure>
<h5 id="Refresh-the-scsi-device"><a href="#Refresh-the-scsi-device" class="headerlink" title="Refresh the scsi device"></a>Refresh the scsi device</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/block/sdau/device/rescan </span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/class/scsi_device/h:c:t:l/device/rescan</span><br></pre></td></tr></table></figure>
<h5 id="Remove-the-scsi-device"><a href="#Remove-the-scsi-device" class="headerlink" title="Remove the scsi device"></a>Remove the scsi device</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/class/scsi_device/h:c:t:l/device/delete</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/block/&lt;dev&gt;/device/delete</span><br></pre></td></tr></table></figure>
<p><a href="http://fibrevillage.com/storage/279-hot-add-remove-rescan-of-scsi-devices-on-linux" target="_blank" rel="external">reference</a></p>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> mem </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Memory_linux]]></title>
      <url>http://yoursite.com/2017/07/08/Memory-linux/</url>
      <content type="html"><![CDATA[<h3 id="Process-memory"><a href="#Process-memory" class="headerlink" title="Process memory"></a>Process memory</h3><pre><code>/proc/[pid]/statm
       Provides information about memory usage, measured in pages.
       The columns are:

           size       (1) total program size
                      (same as VmSize in /proc/[pid]/status)
           resident   (2) resident set size
                      (same as VmRSS in /proc/[pid]/status)
           shared     (3) number of resident shared pages (i.e., backed by a file)
                      (same as RssFile+RssShmem in /proc/[pid]/status)
           text       (4) text (code)
           lib        (5) library (unused since Linux 2.6; always 0)
           data       (6) data + stack
           dt         (7) dirty pages (unused since Linux 2.6; always 0)
</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/3760/statm </span><br><span class="line">400865 96456 37653 27355 0 157019 0</span><br></pre></td></tr></table></figure>
<p>Second field means res (resident)<br>pmap $(pgrep bash)</p>
<p>There are some of share library in each resident</p>
<p>If you want get share library memory consumption.<br>/proc/[pid]/smaps (since Linux 2.6.14)<br>              This file shows memory consumption for each of the process’s<br>              mappings.  (The pmap(1) command displays similar information,<br>              in a form that may be easier for parsing.)</p>
<h4 id="Slab"><a href="#Slab" class="headerlink" title="Slab"></a>Slab</h4><p>In-kernel data structures cache.</p>
<p>Cache pool for often userd dupulication objects<br>you could found these objects from slabtop</p>
<p>Get all slabsize<br>awk ‘BEGIN{sum=0;}{sum=sum+$3*$4;}END{print sum/1024/1024}’ /proc/slabinfo MB</p>
<h4 id="Page-table"><a href="#Page-table" class="headerlink" title="Page table"></a>Page table</h4><p>awk ‘$0~/PageTables/ {print $2}’ /proc/meminfo KB</p>
<h4 id="Struct-page"><a href="#Struct-page" class="headerlink" title="Struct page"></a>Struct page</h4><p>page frame minimum unit. every page frame has a struct page to point<br><a href="https://stackoverflow.com/questions/34836806/how-to-get-physical-address-from-struct-page-in-linux-kernel" target="_blank" rel="external">struct page could mapping page frame to physical address</a><br>all page frame in the LUR list.<br>There are 2.3%(96/4096) usage in linux 2.6.32</p>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> mem </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Performance Tuning in centos7]]></title>
      <url>http://yoursite.com/2017/05/24/Performance-Tuning-in-centos7/</url>
      <content type="html"><![CDATA[<h5 id="High-availability-cluster"><a href="#High-availability-cluster" class="headerlink" title="High availability cluster"></a>High availability cluster</h5><p>2 x 2U Sever SAS3 connect 4 x 90 bay JBOD<br><img src="/img/supermicro-arch17.png" alt=""></p>
<h5 id="Top-sas-throughput-base-32-x-Raidz2-9-2"><a href="#Top-sas-throughput-base-32-x-Raidz2-9-2" class="headerlink" title="Top sas throughput base 32 x Raidz2 (9+2)"></a>Top sas throughput base 32 x Raidz2 (9+2)</h5><p>Sinle x86 server thgroughput could be 23GB/s<br>Average throughput about 15~17GB/s<br><img src="/img/Single-server-sas-throughput2017-5.png" alt=""></p>
<h5 id="BIOS-setting"><a href="#BIOS-setting" class="headerlink" title="BIOS setting"></a>BIOS setting</h5><p>Enable X2APIC</p>
<h5 id="cpu-setting"><a href="#cpu-setting" class="headerlink" title="cpu setting"></a>cpu setting</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tuned-adm profile throughput-performance</span><br><span class="line">tuned-adm active</span><br><span class="line">cpupower idle-set <span class="_">-d</span> 4</span><br><span class="line">cpupower idle-set <span class="_">-d</span> 3</span><br><span class="line">cpupower idle-set <span class="_">-d</span> 2</span><br><span class="line">cpupower  frequency-set -g performance</span><br><span class="line"><span class="comment"># for more info /usr/lib/tuned/throughput-performance/tuned.conf</span></span><br></pre></td></tr></table></figure>
<h5 id="sysctl"><a href="#sysctl" class="headerlink" title="sysctl"></a>sysctl</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">kernel.numa_balancing=0</span><br><span class="line"></span><br><span class="line">net.core.netdev_max_backlog = 300000</span><br><span class="line">net.ipv4.tcp_sack = 0</span><br><span class="line">net.core.netdev_budget=600</span><br><span class="line">net.ipv4.tcp_timestamps=1</span><br><span class="line">net.ipv4.tcp_low_latency=1</span><br><span class="line">net.ipv4.tcp_rmem=16384 349520 16777216</span><br><span class="line">net.ipv4.tcp_wmem=16384 349520 16777216</span><br><span class="line">net.ipv4.tcp_mem = 2314209      3085613 4628418</span><br><span class="line">net.core.rmem_max=16777216</span><br><span class="line">net.core.wmem_max=16777216</span><br><span class="line">net.core.somaxconn=2048</span><br><span class="line">net.ipv4.tcp_adv_win_scale=1</span><br><span class="line">net.ipv4.tcp_window_scaling = 1</span><br><span class="line"><span class="comment">#UDP buffer</span></span><br><span class="line">net.core.rmem_max=16777216</span><br></pre></td></tr></table></figure>
<h5 id="Dual-port-25GbE"><a href="#Dual-port-25GbE" class="headerlink" title="Dual port 25GbE"></a>Dual port 25GbE</h5><h6 id="NIC-settting"><a href="#NIC-settting" class="headerlink" title="NIC settting"></a>NIC settting</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ethtool -C enp131s0f0 adaptive-rx off rx-usecs 0 rx-frames 0</span><br><span class="line">ethtool -G enp131s0f0 rx 8192 tx 8192</span><br><span class="line">ethtool -G enp131s0f0 rx 8192 tx 8192</span><br><span class="line">ethtool -N enp131s0f0 rx-flow-hash udp4 sdfn</span><br><span class="line">ip link <span class="built_in">set</span> dev enp131s0f0 txqueuelen 1500</span><br><span class="line">ip link <span class="built_in">set</span> dev enp131s0f1 txqueuelen 1500</span><br><span class="line">ip link <span class="built_in">set</span> dev bond0 txqueuelen 3000</span><br><span class="line">MTU=9000</span><br></pre></td></tr></table></figure>
<h6 id="Bond-info"><a href="#Bond-info" class="headerlink" title="Bond info"></a>Bond info</h6><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">Ethernet Channel Bonding Driver: v3.7.1 (April 27, 2011)</span><br><span class="line"></span><br><span class="line">Bonding Mode: IEEE 802.3ad Dynamic link aggregation</span><br><span class="line">Transmit Hash Policy: layer2 (0)</span><br><span class="line">MII Status: up</span><br><span class="line">MII Polling Interval (ms): 100</span><br><span class="line">Up Delay (ms): 0</span><br><span class="line">Down Delay (ms): 0</span><br><span class="line"></span><br><span class="line">802.3ad info</span><br><span class="line">LACP rate: slow</span><br><span class="line">M<span class="keyword">in</span> links: 0</span><br><span class="line">Aggregator selection policy (ad_select): stable</span><br><span class="line">System priority: 65535</span><br><span class="line">System MAC address: 7c:fe:90:de:08:38</span><br><span class="line">Active Aggregator Info:</span><br><span class="line">	Aggregator ID: 1</span><br><span class="line">	Number of ports: 2</span><br><span class="line">	Actor Key: 1</span><br><span class="line">	Partner Key: 449</span><br><span class="line">	Partner Mac Address: 38:bc:01:79:33:51</span><br><span class="line"></span><br><span class="line">Slave Interface: enp131s0f0</span><br><span class="line">MII Status: up</span><br><span class="line">Speed: 25000 Mbps</span><br><span class="line">Duplex: full</span><br><span class="line">Link Failure Count: 0</span><br><span class="line">Permanent HW addr: 7c:fe:90:de:08:38</span><br><span class="line">Slave queue ID: 0</span><br><span class="line">Aggregator ID: 1</span><br><span class="line">Actor Churn State: none</span><br><span class="line">Partner Churn State: none</span><br><span class="line">Actor Churned Count: 0</span><br><span class="line">Partner Churned Count: 0</span><br><span class="line">details actor lacp pdu:</span><br><span class="line">    system priority: 65535</span><br><span class="line">    system mac address: 7c:fe:90:de:08:38</span><br><span class="line">    port key: 1</span><br><span class="line">    port priority: 255</span><br><span class="line">    port number: 1</span><br><span class="line">    port state: 61</span><br><span class="line">details partner lacp pdu:</span><br><span class="line">    system priority: 32768</span><br><span class="line">    system mac address: 38:bc:01:79:33:51</span><br><span class="line">    oper key: 449</span><br><span class="line">    port priority: 32768</span><br><span class="line">    port number: 1</span><br><span class="line">    port state: 61</span><br><span class="line"></span><br><span class="line">Slave Interface: enp131s0f1</span><br><span class="line">MII Status: up</span><br><span class="line">Speed: 25000 Mbps</span><br><span class="line">Duplex: full</span><br><span class="line">Link Failure Count: 0</span><br><span class="line">Permanent HW addr: 7c:fe:90:de:08:39</span><br><span class="line">Slave queue ID: 0</span><br><span class="line">Aggregator ID: 1</span><br><span class="line">Actor Churn State: none</span><br><span class="line">Partner Churn State: none</span><br><span class="line">Actor Churned Count: 0</span><br><span class="line">Partner Churned Count: 0</span><br><span class="line">details actor lacp pdu:</span><br><span class="line">    system priority: 65535</span><br><span class="line">    system mac address: 7c:fe:90:de:08:38</span><br><span class="line">    port key: 1</span><br><span class="line">    port priority: 255</span><br><span class="line">    port number: 2</span><br><span class="line">    port state: 61</span><br><span class="line">details partner lacp pdu:</span><br><span class="line">    system priority: 32768</span><br><span class="line">    system mac address: 38:bc:01:79:33:51</span><br><span class="line">    oper key: 449</span><br><span class="line">    port priority: 32768</span><br><span class="line">    port number: 97</span><br><span class="line">    port state: 61</span><br></pre></td></tr></table></figure>
<h6 id="Get-CPU-and-PCIE-adapter-topology"><a href="#Get-CPU-and-PCIE-adapter-topology" class="headerlink" title="Get CPU and PCIE adapter topology"></a>Get CPU and PCIE adapter topology</h6><p>Pin different cpu cores to different adapter<br>Disable irqbalance<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Enable HT</span><br><span class="line">0,1,10,11,2,24,25,26,27,28,29,3,30,31,32,33,34,35,4,5,6,7,8,9,</span><br><span class="line">12,13,14,15,16,17,18,19,20,21,22,23,36,37,38,39,40,41,42,43,44,45,46,47,</span><br><span class="line">cpu numa node number is: 2</span><br><span class="line">cpu-hex cpu-hex numa_node</span><br><span class="line">200 200000000 0</span><br><span class="line">40 40000000 0</span><br><span class="line">8 8000000 0</span><br><span class="line">1 1000000 0</span><br><span class="line">10 10000000 0</span><br><span class="line">2 2000000 0</span><br><span class="line">20 20000000 0</span><br><span class="line">80 80000000 0</span><br><span class="line">400 400000000 0</span><br><span class="line">100 100000000 0</span><br><span class="line">4 4000000 0</span><br><span class="line">800 800000000 0</span><br><span class="line">400000 400000000000 1</span><br><span class="line">8000 8000000000 1</span><br><span class="line">800000 800000000000 1</span><br><span class="line">20000 20000000000 1</span><br><span class="line">40000 40000000000 1</span><br><span class="line">1000 1000000000 1</span><br><span class="line">100000 100000000000 1</span><br><span class="line">80000 80000000000 1</span><br><span class="line">10000 10000000000 1</span><br><span class="line">2000 2000000000 1</span><br><span class="line">200000 200000000000 1</span><br><span class="line">4000 4000000000 1</span><br></pre></td></tr></table></figure></p>
<h5 id="Numa-node0"><a href="#Numa-node0" class="headerlink" title="Numa node0"></a>Numa node0</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">02:00.0 Non-Volatile memory controller: Intel Corporation Device 0a53 (rev 02)</span><br><span class="line">03:00.0 Non-Volatile memory controller: Intel Corporation Device 0a53 (rev 02)</span><br><span class="line">04:00.0 Serial Attached SCSI controller: LSI Logic / Symbios Logic SAS3008 PCI-Express Fusion-MPT SAS-3</span><br></pre></td></tr></table></figure>
<h5 id="Numa-node1"><a href="#Numa-node1" class="headerlink" title="Numa node1"></a>Numa node1</h5><p>Next time , I will change etheret adapter to numa 0<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">83:00.0 Ethernet controller: Mellanox Technologies MT27710 Family [ConnectX-4 Lx]</span><br><span class="line">83:00.1 Ethernet controller: Mellanox Technologies MT27710 Family [ConnectX-4 Lx]</span><br><span class="line">81:00.0 Serial Attached SCSI controller: LSI Logic / Symbios Logic SAS3008 PCI-Express Fusion-MPT SAS-3 (rev 02)</span><br><span class="line">82:00.0 Serial Attached SCSI controller: LSI Logic / Symbios Logic SAS3008 PCI-Express Fusion-MPT SAS-3 (rev 02)</span><br><span class="line">84:00.0 Serial Attached SCSI controller: LSI Logic / Symbios Logic SAS3008 PCI-Express Fusion-MPT SAS-3 (rev 02)</span><br></pre></td></tr></table></figure></p>
<h5 id="mpt3sas"><a href="#mpt3sas" class="headerlink" title="mpt3sas"></a>mpt3sas</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/modprobe.d/mpt3sas.conf</span><br><span class="line">options mpt3sas max_msix_vectors=6</span><br></pre></td></tr></table></figure>
<h5 id="storage-device-setting"><a href="#storage-device-setting" class="headerlink" title="storage device setting"></a>storage device setting</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HDD /sys/block/*/queue/scheduler deadline</span><br><span class="line">SSD /sys/block/*/queue/scheduler noop</span><br><span class="line">/sys/block/*/queue/nr_requests 1024</span><br><span class="line">/sys/block/*/device/queue_depth 256 <span class="comment">#For Throughput, for latency you could reduece it</span></span><br><span class="line">/sys/block/*/device/scsi_disk/*/cache_<span class="built_in">type</span> write back <span class="comment">#For throughput</span></span><br><span class="line"></span><br><span class="line">/sys/block/*/device/scsi_disk/*/cache_<span class="built_in">type</span> write through <span class="comment">#For latency</span></span><br><span class="line">rr_min_io_rq /etc/multipath.conf 1 <span class="comment">#For latency</span></span><br><span class="line">/sys/block/*/queue/nomerges 1 <span class="comment">#For latency</span></span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/homerl/pin_affinity/blob/master/pin_affinity.sh" target="_blank" rel="external">my scripts</a><br>./pin_cpu.sh SAS3008 Mellanox Non-Volatile</p>
<h5 id="Trigger-raw-spin-lock"><a href="#Trigger-raw-spin-lock" class="headerlink" title="Trigger raw_spin_lock"></a>Trigger raw_spin_lock</h5><p>Reconnect SAS cable, no multipath, 10GB/s zfs throughput<br><img src="/img/supermicro-arch18.png" alt=""></p>
<p>Glusterfs/Lustre could get performance 5~6GB/s in 2x25GbE</p>
<h5 id="ZFS-for-all-SAS-SSD-JBOD"><a href="#ZFS-for-all-SAS-SSD-JBOD" class="headerlink" title="ZFS for all SAS SSD JBOD"></a>ZFS for all SAS SSD JBOD</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> logbias=troughput tank</span><br></pre></td></tr></table></figure>
<h5 id="The-others"><a href="#The-others" class="headerlink" title="The others"></a>The others</h5><p>running your app by numactl in single numa node<br>libvma to bypass kernel</p>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> benchmark </tag>
            
            <tag> centos </tag>
            
            <tag> performance </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[SMcli monitor raid controller]]></title>
      <url>http://yoursite.com/2017/04/13/SMcli-monitor-raid-controller/</url>
      <content type="html"><![CDATA[<h3 id="Discovery-devices"><a href="#Discovery-devices" class="headerlink" title="Discovery devices"></a>Discovery devices</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SMcli -A</span><br></pre></td></tr></table></figure>
<h3 id="Get-storage-system-name"><a href="#Get-storage-system-name" class="headerlink" title="Get storage-system-name"></a>Get storage-system-name</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-n means storage-system-name</span><br><span class="line">SMcli localhost</span><br></pre></td></tr></table></figure>
<h3 id="Get-storage-system-status"><a href="#Get-storage-system-status" class="headerlink" title="Get storage system status"></a>Get storage system status</h3><p>show ip address (ipaddr)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SMcli  -n ControllerA  -c <span class="string">" show storagearray healthstatus;"</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Show-all-info"><a href="#Show-all-info" class="headerlink" title="Show all info"></a>Show all info</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SMcli  -n ControllerA  -c <span class="string">"show allControllers  summary;"</span></span><br><span class="line">SMcli -n ControllerA -c <span class="string">"Show allVirtualDisks;"</span></span><br><span class="line">SMcli -n ControllerA -c <span class="string">"show AllPhysicalDisks summary;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### If no summary , it will output all details for each devices.</span></span><br><span class="line">SMcli -n ControllerA -c <span class="string">"show allcontrollers;"</span> <span class="comment">##NVRAM status, cache mirror</span></span><br><span class="line">SMcli  -n ControllerA  -c <span class="string">"Show allphysicalDisks ;"</span></span><br></pre></td></tr></table></figure>
<h3 id="Output-controller-log"><a href="#Output-controller-log" class="headerlink" title="Output controller log"></a>Output controller log</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SMcli  -n ControllerA  -c <span class="string">"save storageArray supportdata file=\"/tmp/controller.log\" force=true;"</span></span><br></pre></td></tr></table></figure>
<h3 id="Reset-controller"><a href="#Reset-controller" class="headerlink" title="Reset controller"></a>Reset controller</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SMcli -n  ControllerA -c <span class="string">"reset controller 0;"</span></span><br><span class="line">SMcli -n  ControllerA -c <span class="string">"reset controller 1;"</span></span><br></pre></td></tr></table></figure>
<h3 id="Blink-the-device"><a href="#Blink-the-device" class="headerlink" title="Blink the device"></a>Blink the device</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SMcli -n ControllerA -c <span class="string">"start physicalDisk [1,0,11] blink;"</span></span><br><span class="line">SMcli -n ControllerA -c <span class="string">"stop physicalDisk blink;"</span></span><br></pre></td></tr></table></figure>
<h3 id="Get-battery-status"><a href="#Get-battery-status" class="headerlink" title="Get battery status"></a>Get battery status</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SMcli -n ControllerA -c <span class="string">"show storageArray batteryage;"</span></span><br></pre></td></tr></table></figure>
<h3 id="Get-battery-status-1"><a href="#Get-battery-status-1" class="headerlink" title="Get battery status"></a>Get battery status</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SMcli -n ControllerA -c <span class="string">"show storageArray powerInfo;"</span></span><br></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Hardware </category>
            
        </categories>
        
        
        <tags>
            
            <tag> raid </tag>
            
            <tag> lsi </tag>
            
            <tag> smcli </tag>
            
            <tag> san </tag>
            
            <tag> monitor </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Test linux SCSI-Persistent-Reservation (SPC-3)]]></title>
      <url>http://yoursite.com/2017/03/21/SCSI-Persistent-Reservations/</url>
      <content type="html"><![CDATA[<h3 id="Does-devices-support"><a href="#Does-devices-support" class="headerlink" title="Does devices support ?"></a>Does devices support ?</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sg_persist -n -i -r <span class="_">-d</span> /dev/sdz</span><br><span class="line">PR generation=0x0, there is NO reservation held</span><br></pre></td></tr></table></figure>
<h3 id="Because-brain-split-zfs-will-corrupt"><a href="#Because-brain-split-zfs-will-corrupt" class="headerlink" title="Because brain-split, zfs will corrupt"></a>Because brain-split, zfs will corrupt</h3><p>process<br>register -&gt; reserve -&gt; preempt-abort -&gt; re-register another node</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">which</span> genhostid</span><br><span class="line">/usr/sbin/genhostid</span><br><span class="line">$ rpm -qf /usr/sbin/genhostid</span><br><span class="line">initscripts-9.49.37-1.el7.x86_64</span><br><span class="line"></span><br><span class="line">A $ genhostid</span><br><span class="line">B $ genhostid</span><br><span class="line">A $ sg_persist --out --register --param-sark=$(hostid) <span class="_">-d</span> /dev/mapper/35000cca2515f34c4</span><br><span class="line">  HGST      HUH721010AL5200   A21D</span><br><span class="line">  Peripheral device <span class="built_in">type</span>: disk</span><br><span class="line"></span><br><span class="line">B $ sg_persist --out --register --param-sark=$(hostid) <span class="_">-d</span> /dev/mapper/35000cca2515f34c4</span><br><span class="line"><span class="comment"># reserve operate</span></span><br><span class="line"></span><br><span class="line">B $ sg_persist --out --reserve --param-rk=0x$(hostid) --prout-type=1 /dev/mapper/35000cca2515f34c4</span><br><span class="line"></span><br><span class="line">B $ sg_persist --in -r --no-inquiry <span class="_">-d</span> /dev/mapper/35000cca2515f34c4</span><br><span class="line">    PR generation=0x5c, Reservation follows:</span><br><span class="line">    Key=0x7819de15</span><br><span class="line">    scope: LU_SCOPE,  <span class="built_in">type</span>: Write Exclusive</span><br><span class="line"></span><br><span class="line">A $ dd <span class="keyword">if</span>=/dev/zero of=/dev/mapper/35000cca2515f34c4 bs=1M count=10 oflag=sync</span><br><span class="line">dd: error writing ‘/dev/mapper/35000cca2515f34c4’: Input/output error</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes (0 B) copied, 0.0273762 s, 0.0 kB/s</span><br><span class="line"></span><br><span class="line">B $ dd <span class="keyword">if</span>=/dev/zero of=/dev/mapper/35000cca2515f34c4 bs=1M count=10 oflag=sync</span><br><span class="line">10+0 records <span class="keyword">in</span></span><br><span class="line">10+0 records out</span><br><span class="line">10485760 bytes (10 MB) copied, 0.145223 s, 72.2 MB/s</span><br><span class="line"></span><br><span class="line"><span class="comment"># get the reservation</span></span><br><span class="line">A $ sg_persist -n -o -A <span class="_">-d</span> /dev/mapper/35000cca2515f34c4 -K $(hostid) -S 0x7819de15  -T 1 -v</span><br><span class="line">    Persistent Reservation Out cmd: 5f 05 01 00 00 00 00 00 18 00 </span><br><span class="line">PR out: <span class="built_in">command</span> (Preempt and abort) successful</span><br><span class="line"></span><br><span class="line">A $ sg_persist --in -r --no-inquiry <span class="_">-d</span> /dev/mapper/35000cca2515f34c4</span><br><span class="line">    PR generation=0x5d, Reservation follows:</span><br><span class="line">    Key=0x77f7c343</span><br><span class="line">    scope: LU_SCOPE,  <span class="built_in">type</span>: Write Exclusivea</span><br><span class="line"></span><br><span class="line">A $ dd <span class="keyword">if</span>=/dev/zero of=/dev/mapper/35000cca2515f34c4 bs=1M count=10 oflag=sync</span><br><span class="line">10+0 records <span class="keyword">in</span></span><br><span class="line">10+0 records out</span><br><span class="line">10485760 bytes (10 MB) copied, 0.142939 s, 73.4 MB/s</span><br><span class="line"></span><br><span class="line">B $ dd <span class="keyword">if</span>=/dev/zero of=/dev/mapper/35000cca2515f34c4 bs=1M count=10 oflag=sync</span><br><span class="line">dd: error writing ‘/dev/mapper/35000cca2515f34c4’: Input/output error</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes (0 B) copied, 0.0139251 s, 0.0 kB/s</span><br><span class="line"></span><br><span class="line">B $ sg_persist -n -o -A <span class="_">-d</span> /dev/mapper/35000cca2515f34c4 -K $(hostid) -S 0x77f7c343 -T 1 -v</span><br><span class="line">    Persistent Reservation Out cmd: 5f 05 01 00 00 00 00 00 18 00 </span><br><span class="line">PR out: <span class="built_in">command</span> (Preempt and abort) successful</span><br><span class="line"></span><br><span class="line">B $ dd <span class="keyword">if</span>=/dev/zero of=/dev/mapper/35000cca2515f34c4 bs=1M count=10 oflag=sync</span><br><span class="line">10+0 records <span class="keyword">in</span></span><br><span class="line">10+0 records out</span><br><span class="line">10485760 bytes (10 MB) copied, 0.149629 s, 70.1 MB/s</span><br><span class="line"></span><br><span class="line">A $ dd <span class="keyword">if</span>=/dev/zero of=/dev/mapper/35000cca2515f34c4 bs=1M count=10 oflag=sync</span><br><span class="line">dd: error writing ‘/dev/mapper/35000cca2515f34c4’: Input/output error</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes (0 B) copied, 0.0207658 s, 0.0 kB/s</span><br></pre></td></tr></table></figure>
<h3 id="Prout-type"><a href="#Prout-type" class="headerlink" title="Prout-type"></a>Prout-type</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1-&gt; write exclusive</span><br><span class="line">3-&gt; exclusive access</span><br><span class="line">5-&gt; write exclusive - registrants only</span><br><span class="line">6-&gt; exclusive access - registrants only</span><br><span class="line">7-&gt; write exclusive - all registrants</span><br><span class="line">8-&gt; exclusive access - all registrants</span><br></pre></td></tr></table></figure>
<h3 id="Release-reservation"><a href="#Release-reservation" class="headerlink" title="Release reservation"></a>Release reservation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sg_persist --out --release -K $(hostid) --prout-type=1 /dev/mapper/35000cca2515f34c4</span><br><span class="line">  HGST      HUH721010AL5200   A21D</span><br><span class="line">  Peripheral device <span class="built_in">type</span>: disk</span><br><span class="line">$ sg_persist --in -r --no-inquiry <span class="_">-d</span> /dev/mapper/35000cca2515f34c4</span><br><span class="line">  PR generation=0x5f, there is NO reservation held</span><br></pre></td></tr></table></figure>
<h3 id="Unregister-key"><a href="#Unregister-key" class="headerlink" title="Unregister key"></a>Unregister key</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ sg_persist --out --register -K $(hostid) <span class="_">-d</span> /dev/mapper/35000cca2515f34c4</span><br><span class="line">  HGST      HUH721010AL5200   A21D</span><br><span class="line">  Peripheral device <span class="built_in">type</span>: disk</span><br><span class="line">$ sg_persist --in -k --no-inquiry <span class="_">-d</span> /dev/mapper/35000cca2515f34c4</span><br><span class="line">  PR generation=0x60, there are NO registered reservation keys</span><br></pre></td></tr></table></figure>
<h3 id="Force-mode"><a href="#Force-mode" class="headerlink" title="Force mode ?"></a>Force mode ?</h3><p>It releases the persistent reservation (if any) and clears all registrations from the device<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sg_persist --out --clear -K $(hostid) /dev/mapper/35000cca2515f34c4</span><br></pre></td></tr></table></figure></p>
<h3 id="About-multipath"><a href="#About-multipath" class="headerlink" title="About multipath"></a>About multipath</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">no_path_retry queue</span><br><span class="line">features <span class="string">"0"</span></span><br></pre></td></tr></table></figure>
<p><a href="https://dhelios.blogspot.com/2015/04/how-can-i-view-create-and-remove-scsi.html" target="_blank" rel="external">How can I view create and remove scsi</a><br><a href="http://lkml.iu.edu/hypermail/linux/kernel/0903.3/02074.html" target="_blank" rel="external">Target_Core_Mod</a><br><a href="https://lists.wpkg.org/pipermail/stgt/2010-October/017304.html" target="_blank" rel="external">Support for persistent reservations</a><br><a href="https://assets.cdn.sap.com/sapcom/docs/2016/06/84ea994f-767c-0010-82c7-eda71af511fa.pdf" target="_blank" rel="external">SAP HANA Fiber Channel Storage Connector Admin Guide</a></p>
]]></content>
      
        <categories>
            
            <category> Hardware </category>
            
        </categories>
        
        
        <tags>
            
            <tag> hdd </tag>
            
            <tag> ssd </tag>
            
            <tag> sas </tag>
            
            <tag> scsi </tag>
            
            <tag> spc </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[HA centos 7 configuration]]></title>
      <url>http://yoursite.com/2017/03/13/HA-centos7-3-nodes-configuration/</url>
      <content type="html"><![CDATA[<h3 id="Physical-node-OS"><a href="#Physical-node-OS" class="headerlink" title="Physical node OS"></a>Physical node OS</h3><ul>
<li>CentOS Linux release 7.3<br><img src="/img/test-arch.png" alt=""></li>
</ul>
<h2 id="Create-linux-HA-3-x-physical-server"><a href="#Create-linux-HA-3-x-physical-server" class="headerlink" title="Create linux HA ,3 x physical server"></a>Create linux HA ,3 x physical server</h2><p>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<br>192.xx.xx.130 node01<br>192.xx.xx.131 node02<br>192.xx.xx.132 node03</p>
<h3 id="Share-strorages"><a href="#Share-strorages" class="headerlink" title="Share strorages"></a>Share strorages</h3><p>NFS/Lustre</p>
<h3 id="Setup-HA-cluster"><a href="#Setup-HA-cluster" class="headerlink" title="Setup HA cluster"></a>Setup HA cluster</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum -y install pacemaker corosync fence-agents-all fence-agents-virsh \</span></span><br><span class="line">  fence-virt pacemaker-remote pcs fence-virtd resource-agents \</span><br><span class="line">  fence-virtd-libvirt fence-virtd-multicast</span><br></pre></td></tr></table></figure>
<h3 id="3-nodes-glusterfs-config"><a href="#3-nodes-glusterfs-config" class="headerlink" title="3 nodes glusterfs config"></a>3 nodes glusterfs config</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ zpool create tank -O canmount=on -o ashift=9 -o cachefile=none -O xattr=sa -O compression=lz4 -O acltype=posixacl raidz2 /dev/sd&#123;c..h&#125;</span><br><span class="line">$ zpool add tank cache /dev/sda4 /dev/sdb4</span><br><span class="line">$ zpool add tank <span class="built_in">log</span> mirror /dev/sda3 /dev/sdb3</span><br><span class="line">$ gluster volume create ec-test disperse-data 2 redundancy 1  transport tcp node1:/tank/glusterfs node2:/tank/glusterfs node3:/tank/glusterfs force</span><br></pre></td></tr></table></figure>
<h4 id="Setup-physical-server"><a href="#Setup-physical-server" class="headerlink" title="Setup physical server"></a>Setup physical server</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> hacluster | passwd --stdin hacluster</span><br><span class="line">$ systemctl <span class="built_in">enable</span> pcsd.service</span><br><span class="line">$ systemctl <span class="built_in">disable</span> corosync.service pcaemaker.service</span><br><span class="line">$ systemctl stop corosync.service pcaemaker.service</span><br><span class="line">$ systemctl start pcsd.service</span><br><span class="line">$ systemctl is-active pcsd.service</span><br><span class="line">$ pcs cluster auth node01 node02 node03 <span class="comment">##input hacluster password for auth</span></span><br><span class="line">$ pcs cluster setup --name ha-cluster node01,172.29.xx.xx node02,172.92.xx.xx node03,172.29.xx.xx --transport udpu --rrpmode passive --token 17000 --addr0 172.29.xx.0 --addr1 192.168.101.0 </span><br><span class="line">$ pcs cluster setup --start --name ha-cluster node01 node02 node03</span><br><span class="line"><span class="comment">## pcs property set no-quorum-policy=stop #don't need to stop</span></span><br></pre></td></tr></table></figure>
<p>4.1.2 Option no-quorum-policy</p>
<p>This global option defines what to do when a cluster partition does not have quorum (no majority of nodes is part of the partition).</p>
<p>Allowed values are:</p>
<p>ignore<br>The quorum state does not influence the cluster behavior; resource management is continued.</p>
<p>This setting is useful for the following scenarios:</p>
<p>Two-node clusters: Since a single node failure would always result in a loss of majority, usually you want the cluster to carry on regardless. Resource integrity is ensured using fencing, which also prevents split brain scenarios.</p>
<p>Resource-driven clusters: For local clusters with redundant communication channels, a split brain scenario only has a certain probability. Thus, a loss of communication with a node most likely indicates that the node has crashed, and that the surviving nodes should recover and start serving the resources again.</p>
<p>If no-quorum-policy is set to ignore, a 4-node cluster can sustain concurrent failure of three nodes before service is lost. With the other settings, it would lose quorum after concurrent failure of two nodes.</p>
<p>freeze<br>If quorum is lost, the cluster partition freezes. Resource management is continued: running resources are not stopped (but possibly restarted in response to monitor events), but no further resources are started within the affected partition.</p>
<p>This setting is recommended for clusters where certain resources depend on communication with other nodes (for example, OCFS2 mounts). In this case, the default setting no-quorum-policy=stop is not useful, as it would lead to the following scenario: Stopping those resources would not be possible while the peer nodes are unreachable. Instead, an attempt to stop them would eventually time out and cause a stop failure, triggering escalated recovery and fencing.</p>
<p>stop (default value)<br>If quorum is lost, all resources in the affected cluster partition are stopped in an orderly fashion.</p>
<p>suicide<br>If quorum is lost, all nodes in the affected cluster partition are fenced.</p>
<h4 id="Setting-etc-corosync-corosync-conf-for-every-node"><a href="#Setting-etc-corosync-corosync-conf-for-every-node" class="headerlink" title="Setting /etc/corosync/corosync.conf for every node"></a>Setting /etc/corosync/corosync.conf for every node</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">totem &#123;</span><br><span class="line">    version: 2</span><br><span class="line">    secauth: off</span><br><span class="line">    cluster_name: homer-test</span><br><span class="line">    transport: udpu</span><br><span class="line">    rrp_mode: passive</span><br><span class="line">    token: 17000</span><br><span class="line"></span><br><span class="line">    interface &#123;</span><br><span class="line">        ringnumber: 0</span><br><span class="line">        bindnetaddr: 192.168.xx.0</span><br><span class="line">        mcastaddr: 239.255.1.1</span><br><span class="line">        mcastport: 5405</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    interface &#123;</span><br><span class="line">        ringnumber: 1</span><br><span class="line">        bindnetaddr: 172.29.xx.0</span><br><span class="line">        mcastaddr: 239.255.2.1</span><br><span class="line">        mcastport: 5405</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nodelist &#123;</span><br><span class="line">    node &#123;</span><br><span class="line">        ring0_addr: bgi-sz1-homer-test73</span><br><span class="line">        ring1_addr: 172.29.xx.xx</span><br><span class="line">        nodeid: 1</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    node &#123;</span><br><span class="line">        ring0_addr: bgi-sz1-homer-test74</span><br><span class="line">        ring1_addr: 172.29.xx.xx</span><br><span class="line">        nodeid: 2</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    node &#123;</span><br><span class="line">        ring0_addr: bgi-sz1-homer-test76</span><br><span class="line">        ring1_addr: 172.29.xx.xx</span><br><span class="line">        nodeid: 3</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">quorum &#123;</span><br><span class="line">    provider: corosync_votequorum</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line">    to_logfile: yes</span><br><span class="line">    logfile: /var/<span class="built_in">log</span>/cluster/corosync.log</span><br><span class="line">    to_syslog: yes</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Start-cluster"><a href="#Start-cluster" class="headerlink" title="Start cluster"></a>Start cluster</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ pcs cluster start --all</span><br><span class="line">$ corosync-cfgtool <span class="_">-s</span></span><br><span class="line">Printing ring status.</span><br><span class="line">Local node ID 1</span><br><span class="line">RING ID 0</span><br><span class="line">	id	= 192.168.xx.130</span><br><span class="line">	status	= ring 0 active with no faults</span><br><span class="line">RING ID 1</span><br><span class="line">	id	= 172.29.xx.73</span><br><span class="line">	status	= ring 1 active with no faults</span><br></pre></td></tr></table></figure>
<h4 id="Create-stonith-for-physical-server"><a href="#Create-stonith-for-physical-server" class="headerlink" title="Create stonith for physical server"></a>Create stonith for physical server</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pcs stonith create node01-fencing fence_ipmilan pcmk_host_list="nod01" \</span></span><br><span class="line">ipaddr=<span class="string">"node1_ipmi_ipaddr"</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_<span class="built_in">wait</span>=4 \</span><br><span class="line">op monitor interval=60s</span><br><span class="line"><span class="comment"># pcs stonith create node02-fencing fence_ipmilan pcmk_host_list="node02" \</span></span><br><span class="line"> ipaddr=<span class="string">"node2_ipmi_ipaddr"</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_<span class="built_in">wait</span>=4 \</span><br><span class="line">op monitor interval=60s</span><br><span class="line"><span class="comment"># pcs stonith create node03-fencing fence_ipmilan pcmk_host_list="node03" \</span></span><br><span class="line">ipaddr=<span class="string">"node3_ipmi_ipaddr"</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_<span class="built_in">wait</span>=4 op \</span><br><span class="line">monitor interval=60s</span><br><span class="line"></span><br><span class="line"><span class="comment"># pcs property set stonith-enabled=true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pcs status</span></span><br><span class="line">Cluster name: ha-cluster</span><br><span class="line">...</span><br><span class="line">Online: [ node02 node03 node01 ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> node01-fencing	(stonith:fence_ipmilan):	Started node02</span><br><span class="line"> node03-fencing	(stonith:fence_ipmilan):	Started node01</span><br><span class="line"> node02-fencing	(stonith:fence_ipmilan):	Started node03</span><br><span class="line"></span><br><span class="line">PCSD Status:</span><br><span class="line">  node03: Online</span><br><span class="line">  node01: Online</span><br><span class="line">  node02: Online</span><br><span class="line"></span><br><span class="line">Daemon Status:</span><br><span class="line">  corosync: active/disabled</span><br><span class="line">  pacemaker: active/disabled</span><br><span class="line">  pcsd: active/enabled</span><br></pre></td></tr></table></figure>
<h4 id="Get-quorum-info"><a href="#Get-quorum-info" class="headerlink" title="Get quorum info"></a>Get quorum info</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">$ corosync-quorumtool</span><br><span class="line">Quorum information</span><br><span class="line">------------------</span><br><span class="line">Date:             Mon Mar 13 22:08:01 2017</span><br><span class="line">Quorum provider:  corosync_votequorum</span><br><span class="line">Nodes:            3</span><br><span class="line">Node ID:          0x00000001</span><br><span class="line">Ring ID:          1/568</span><br><span class="line">Quorate:          Yes</span><br><span class="line"></span><br><span class="line">Votequorum information</span><br><span class="line">----------------------</span><br><span class="line">Expected votes:   3</span><br><span class="line">Highest expected: 3</span><br><span class="line">Total votes:      3</span><br><span class="line">Quorum:           2  </span><br><span class="line">Flags:            Quorate </span><br><span class="line"></span><br><span class="line">Membership information</span><br><span class="line">----------------------</span><br><span class="line">    Nodeid      Votes Name</span><br><span class="line">0x00000001          1 192.168.xx.130 (<span class="built_in">local</span>)</span><br><span class="line">0x00000002          1 192.168.xx.131</span><br><span class="line">0x00000003          1 192.168.xx.132</span><br><span class="line"></span><br><span class="line">$ </span><br><span class="line"></span><br><span class="line">$  corosync-cmapctl|grep members</span><br><span class="line">runtime.totem.pg.mrp.srp.members.1.config_version (u64) = 0</span><br><span class="line">runtime.totem.pg.mrp.srp.members.1.ip (str) = r(0) ip(192.168.xx.130) r(1) ip(172.29.xx.73) </span><br><span class="line">runtime.totem.pg.mrp.srp.members.1.join_count (u32) = 1</span><br><span class="line">runtime.totem.pg.mrp.srp.members.1.status (str) = joined</span><br><span class="line">runtime.totem.pg.mrp.srp.members.2.config_version (u64) = 0</span><br><span class="line">runtime.totem.pg.mrp.srp.members.2.ip (str) = r(0) ip(192.168.xx.131) r(1) ip(172.29.xx.74) </span><br><span class="line">runtime.totem.pg.mrp.srp.members.2.join_count (u32) = 1</span><br><span class="line">runtime.totem.pg.mrp.srp.members.2.status (str) = joined</span><br><span class="line">runtime.totem.pg.mrp.srp.members.3.config_version (u64) = 0</span><br><span class="line">runtime.totem.pg.mrp.srp.members.3.ip (str) = r(0) ip(192.168.xx.132) r(1) ip(172.29.xx.76) </span><br><span class="line">runtime.totem.pg.mrp.srp.members.3.join_count (u32) = 1</span><br><span class="line">runtime.totem.pg.mrp.srp.members.3.status (str) = joined</span><br></pre></td></tr></table></figure>
<h4 id="backup-and-restore-configuration"><a href="#backup-and-restore-configuration" class="headerlink" title="backup and restore configuration"></a>backup and restore configuration</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ pcs cluster cib &gt; xx.xml</span><br><span class="line">$ pcs cluster cib-push xx.xml</span><br><span class="line"></span><br><span class="line">$ pcs config</span><br></pre></td></tr></table></figure>
<h4 id="Create-resources"><a href="#Create-resources" class="headerlink" title="Create resources"></a>Create resources</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ pcs resource create VirtualIP1 ocf:heartbeat:IPaddr2 ip=10.0.0.77 cidr_netmask=8 nic=br0 op monitor interval=60s</span><br><span class="line">$ pcs constraint location VirtualIP prefers bgi-sz1-homer-test73=0</span><br><span class="line"></span><br><span class="line">$ pcs resource create ansible-kvm VirtualDomain hypervisor=<span class="string">"qemu:///system"</span> config=<span class="string">"/export/glusterfs/vms/kvm/xml/ansible-kvm.xml"</span> migration_transport=ssh op start timeout=<span class="string">"60s"</span> op stop timeout=<span class="string">"60s"</span> op monitor  timeout=<span class="string">"30"</span> interval=<span class="string">"20"</span>  meta allow-migrate=<span class="string">"true"</span> op migrate_from interval=<span class="string">"0"</span> timeout=<span class="string">"120s"</span> op migrate_to interval=<span class="string">"0"</span> timeout=<span class="string">"120"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if you want add to group, add --group xxx</span></span><br><span class="line">$ pcs resource create ansible-kvm VirtualDomain hypervisor=<span class="string">"qemu:///system"</span> config=<span class="string">"/export/glusterfs/vms/kvm/xml/ansible-kvm.xml"</span> migration_transport=ssh op start timeout=<span class="string">"60s"</span> op stop timeout=<span class="string">"60s"</span> op monitor  timeout=<span class="string">"30"</span> interval=<span class="string">"20"</span>  meta allow-migrate=<span class="string">"true"</span> op migrate_from interval=<span class="string">"0"</span> timeout=<span class="string">"120s"</span> op migrate_to interval=<span class="string">"0"</span> timeout=<span class="string">"120"</span> --group GROUP-A</span><br><span class="line"></span><br><span class="line"><span class="comment"># http</span></span><br><span class="line"><span class="comment"># pcs resource create webres apache configfile="/etc/httpd/conf/httpd.conf" statusurl="http://127.0.0.1/server-status"</span></span><br></pre></td></tr></table></figure>
<h4 id="Create-the-resource-group"><a href="#Create-the-resource-group" class="headerlink" title="Create the resource group"></a>Create the resource group</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcs resource group add GROUP-A resource-1 resource-2 resource-3</span><br></pre></td></tr></table></figure>
<h4 id="monitor"><a href="#monitor" class="headerlink" title="monitor"></a>monitor</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">crm_mon</span><br><span class="line">pcs status nodes</span><br></pre></td></tr></table></figure>
<h4 id="Standby-and-maintance"><a href="#Standby-and-maintance" class="headerlink" title="Standby and maintance"></a>Standby and maintance</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pcs cluster standby</span><br><span class="line">pcs cluster unstandby</span><br><span class="line">pcs cluster stop</span><br><span class="line">pcs cluster stop --all</span><br><span class="line"></span><br><span class="line"><span class="comment">#BAN" the resource group  in which you would like to stop the cluster services</span></span><br><span class="line">pcs resource ban resource-name node-name</span><br><span class="line"></span><br><span class="line"><span class="comment">#maintenance</span></span><br><span class="line">pcs property <span class="built_in">set</span> maintenance-mode=<span class="literal">true</span></span><br><span class="line">pcs property <span class="built_in">set</span> maintenance-mode=flase</span><br></pre></td></tr></table></figure>
<h4 id="Resource-constraint"><a href="#Resource-constraint" class="headerlink" title="Resource constraint"></a>Resource constraint</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ pcs constraint</span><br><span class="line">Location Constraints:</span><br><span class="line">  Resource: VirtualIP</span><br><span class="line">    Enabled on: bgi-sz1-homer-test73 (score:0)</span><br><span class="line">  Resource: VirtualIP2</span><br><span class="line">    Enabled on: bgi-sz1-homer-test74 (score:0)</span><br><span class="line">  Resource: VirtualIP3</span><br><span class="line">    Enabled on: bgi-sz1-homer-test76 (score:0)</span><br><span class="line">Ordering Constraints:</span><br><span class="line">Colocation Constraints:</span><br><span class="line">Ticket Constraints:</span><br><span class="line"></span><br><span class="line">$ pcs constraint location resource-name prefers nodename=50</span><br><span class="line"></span><br><span class="line"><span class="comment"># Using location constraint, you can also avoid specific node to run a particular resource</span></span><br><span class="line">$ pcs constraint location resource-name avoids nodename=50</span><br></pre></td></tr></table></figure>
<h4 id="Resource-order"><a href="#Resource-order" class="headerlink" title="Resource order"></a>Resource order</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create</span></span><br><span class="line">$ pcs constraint order resource1 <span class="keyword">then</span> resource2</span><br><span class="line">$ pcs constraint order resource2 <span class="keyword">then</span> resource3</span><br><span class="line">$ pcs constraint</span><br><span class="line"></span><br><span class="line"><span class="comment"># remove</span></span><br><span class="line">$ pcs constraint order --full</span><br><span class="line">$ pcs constraint order remove resource1 id_output</span><br><span class="line"></span><br><span class="line"><span class="comment"># example</span></span><br><span class="line"></span><br><span class="line">$ pcs constraint order VirtualIP1 <span class="keyword">then</span> manager-kvm</span><br><span class="line">Adding VirtualIP1 manager-kvm (kind: Mandatory) (Options: first-action=start <span class="keyword">then</span>-action=start)</span><br><span class="line">$ pcs constraint</span><br><span class="line">Location Constraints:</span><br><span class="line">  Resource: VirtualIP</span><br><span class="line">    Enabled on: bgi-sz1-homer-test73 (score:0)</span><br><span class="line">  Resource: VirtualIP2</span><br><span class="line">    Enabled on: bgi-sz1-homer-test74 (score:0)</span><br><span class="line">  Resource: VirtualIP3</span><br><span class="line">    Enabled on: bgi-sz1-homer-test76 (score:0)</span><br><span class="line">Ordering Constraints:</span><br><span class="line">  start VirtualIP1 <span class="keyword">then</span> start manager-kvm (kind:Mandatory)</span><br><span class="line">Colocation Constraints:</span><br><span class="line">Ticket Constraints:</span><br><span class="line"></span><br><span class="line">$ pcs constraint order --full</span><br><span class="line">Ordering Constraints:</span><br><span class="line">  start VirtualIP1 <span class="keyword">then</span> start manager-kvm (kind:Mandatory) (id:order-VirtualIP1-manager-kvm-mandatory)</span><br><span class="line"></span><br><span class="line"><span class="comment">#input id</span></span><br><span class="line">$ pcs constraint order remove VirtualIP1 order-VirtualIP1-manager-kvm-mandatory</span><br><span class="line">$ pcs constraint order --full</span><br><span class="line">Ordering Constraints:</span><br></pre></td></tr></table></figure>
<h4 id="Resource-migration"><a href="#Resource-migration" class="headerlink" title="Resource migration"></a>Resource migration</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ pcs resource update resource-name meta migration-threshold=<span class="string">"2"</span></span><br><span class="line">or </span><br><span class="line">$ pcs resource defaults migration-threshold=2</span><br><span class="line"></span><br><span class="line">$ pcs resource update resource-name meta failure-timeout=60s</span><br><span class="line">$ pcs resource show resource-name</span><br><span class="line"><span class="comment"># show fail-count</span></span><br><span class="line">$ pcs resource failcount show</span><br><span class="line">or</span><br><span class="line">$ crm_failcount -r resource-name</span><br><span class="line"></span><br><span class="line"><span class="comment"># reset the fail-counts </span></span><br><span class="line">$ pcs resource failcount reset resource-name node-name</span><br><span class="line">or </span><br><span class="line">$ pcs resource cleanup resource-name</span><br><span class="line">$ pcs resource failcount show  resource-name</span><br></pre></td></tr></table></figure>
<h4 id="Not-move-resource-back"><a href="#Not-move-resource-back" class="headerlink" title="Not move resource back"></a>Not move resource back</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ pcs resource defaults resource-stickiness=100</span><br><span class="line">$ pcs resource defaults</span><br></pre></td></tr></table></figure>
<h4 id="Colocation-constraint"><a href="#Colocation-constraint" class="headerlink" title="Colocation constraint"></a>Colocation constraint</h4><p>A colocation constraint determines that the location of one resource depends on the location of another resource<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ pcs constraint colocation add resource1 resource2 INFINITY</span><br><span class="line">$ pcs constraint colocation add resource1 with resource2 INFINITY</span><br><span class="line"><span class="comment">#remove</span></span><br><span class="line">$ pcs constraint --full</span><br><span class="line"></span><br><span class="line">$ pcs constraint colocation remove resource1</span><br></pre></td></tr></table></figure></p>
<h4 id="Resource-location"><a href="#Resource-location" class="headerlink" title="Resource location"></a>Resource location</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ pcs constraint location resource-name prefers node1</span><br><span class="line">$ pcs constraint location resource-name avoids node1</span><br><span class="line">$ pcs constraint --full</span><br><span class="line">$ pcs constraint location remove location-resource-name</span><br><span class="line">$ pcs constraint location resource-name prefers node1=INFINITY</span><br><span class="line">$ crm_simulate <span class="_">-s</span>L <span class="comment"># get resource score</span></span><br><span class="line"><span class="comment"># Resource pefer node1,node2,node3</span></span><br><span class="line">pcs constraint location resource-name prefers node1=200</span><br><span class="line">pcs constraint location resource-name prefers node2=100</span><br><span class="line">pcs constraint location resource-name prefers node3=0</span><br></pre></td></tr></table></figure>
<h4 id="Update-resource-config"><a href="#Update-resource-config" class="headerlink" title="Update resource config"></a>Update resource config</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pcs resource update ansible-kvm config=/opt/lustresz/DAS_NFS/vms/HA-kvm/homerl/config/ansible-kvm.xml</span><br></pre></td></tr></table></figure>
<h4 id="Manage-resource"><a href="#Manage-resource" class="headerlink" title="Manage resource"></a>Manage resource</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ pcs resource <span class="built_in">disable</span> resource-name    </span><br><span class="line">$ pcs resource <span class="built_in">enable</span> resource-name    </span><br><span class="line">$ pcs resource failcount show resource-name </span><br><span class="line">$ pcs resource failcount reset resource-name</span><br><span class="line">$ pcs resource cleanup resource-name</span><br></pre></td></tr></table></figure>
<h4 id="Clear-error-output"><a href="#Clear-error-output" class="headerlink" title="Clear error output"></a>Clear error output</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcs resource cleanup</span><br></pre></td></tr></table></figure>
<h4 id="Check-cluster-status"><a href="#Check-cluster-status" class="headerlink" title="Check cluster status"></a>Check cluster status</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ crm_verify -L -V</span><br></pre></td></tr></table></figure>
<h3 id="Destroy-cluster"><a href="#Destroy-cluster" class="headerlink" title="Destroy cluster"></a>Destroy cluster</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pcs cluster destroy --all</span><br><span class="line"></span><br><span class="line">#or </span><br><span class="line">systemctl stop pacemaker corosync</span><br><span class="line">rm -f /var/lib/pacemaker/cib/*</span><br></pre></td></tr></table></figure>
<p>Reference<br><a href="http://www.unixarena.com/2016/01/rhel-7-pacemaker-define-the-resource-behaviour.html" target="_blank" rel="external">RHEL 7 – Pacemaker</a><br><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/High_Availability_Add-On_Reference/s1-multistateresource-HAAR.html" target="_blank" rel="external">High_Availability_Add-On_Reference</a></p>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> centos </tag>
            
            <tag> ha </tag>
            
            <tag> cluster </tag>
            
            <tag> 3 nodes </tag>
            
            <tag> corosync </tag>
            
            <tag> pacemaker </tag>
            
            <tag> kvm </tag>
            
            <tag> virtualization </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[kvm_tips]]></title>
      <url>http://yoursite.com/2017/03/09/kvm-tips/</url>
      <content type="html"><![CDATA[<h3 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install qemu-kvm libvirt virt-install bridge-utils</span><br></pre></td></tr></table></figure>
<h3 id="KVM-Multipath"><a href="#KVM-Multipath" class="headerlink" title="KVM Multipath"></a>KVM Multipath</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">'file'</span> <span class="attr">device</span>=<span class="string">'disk'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">'qemu'</span> <span class="attr">type</span>=<span class="string">'qcow2'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">'/kvm/fileA.qcow2'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">'sda'</span> <span class="attr">bus</span>=<span class="string">'scsi'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">serial</span>&gt;</span>0002<span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">'drive'</span> <span class="attr">controller</span>=<span class="string">'0'</span> <span class="attr">bus</span>=<span class="string">'0'</span> <span class="attr">target</span>=<span class="string">'0'</span> <span class="attr">unit</span>=<span class="string">'0'</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">disk</span> <span class="attr">type</span>=<span class="string">'file'</span> <span class="attr">device</span>=<span class="string">'disk'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">driver</span> <span class="attr">name</span>=<span class="string">'qemu'</span> <span class="attr">type</span>=<span class="string">'qcow2'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">source</span> <span class="attr">file</span>=<span class="string">'/kvm/fileA.qcow2'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">target</span> <span class="attr">dev</span>=<span class="string">'sdb'</span> <span class="attr">bus</span>=<span class="string">'scsi'</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">serial</span>&gt;</span>0002<span class="tag">&lt;/<span class="name">serial</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">address</span> <span class="attr">type</span>=<span class="string">'drive'</span> <span class="attr">controller</span>=<span class="string">'0'</span> <span class="attr">bus</span>=<span class="string">'0'</span> <span class="attr">target</span>=<span class="string">'0'</span> <span class="attr">unit</span>=<span class="string">'1'</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">disk</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="Snapshot"><a href="#Snapshot" class="headerlink" title="Snapshot"></a>Snapshot</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># list</span></span><br><span class="line">qemu-img snapshot <span class="_">-l</span> /kvm/fileA.qcow2</span><br><span class="line">ID ...</span><br><span class="line">1 ...  </span><br><span class="line"></span><br><span class="line"><span class="comment"># create</span></span><br><span class="line">qemu-img snapshot -c first /kvm/fileA.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment"># recovery</span></span><br><span class="line">qemu-img snapshot <span class="_">-a</span> 1 /kvm/fileA.qcow2</span><br><span class="line"></span><br><span class="line"><span class="comment"># Delete</span></span><br><span class="line">qemu-img snapshot <span class="_">-d</span> 1 /kvm/fileA.qcow2</span><br></pre></td></tr></table></figure>
<h3 id="Create-convert-base-image"><a href="#Create-convert-base-image" class="headerlink" title="Create convert base image"></a>Create convert base image</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">qemu-img create <span class="_">-f</span> qed vm1.qed 80G</span><br><span class="line">qemu-img convert <span class="_">-f</span> vmdk -O raw centos7.vmdk centos7.img</span><br><span class="line"><span class="comment">#Base images</span></span><br><span class="line">qemu-img create -b centos6-base.qed <span class="_">-f</span>  qed  centos6-tmp.qed</span><br><span class="line">qemu-img rebase  -u -b centos-6.qed ./kvm1.qed</span><br></pre></td></tr></table></figure>
<h3 id="Virt-manager-show-unreadable-code"><a href="#Virt-manager-show-unreadable-code" class="headerlink" title="Virt-manager show unreadable code"></a>Virt-manager show unreadable code</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install dejavu-sans-fonts</span><br><span class="line"><span class="comment"># if you need Chinese</span></span><br><span class="line">yum -y install ghostscript-chinese-zh_CN</span><br></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> virtualization </category>
            
        </categories>
        
        
        <tags>
            
            <tag> centos </tag>
            
            <tag> kvm </tag>
            
            <tag> virtualization </tag>
            
            <tag> multipath </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Ext filesystem recovery]]></title>
      <url>http://yoursite.com/2017/01/11/Ext_filesystem_recovery/</url>
      <content type="html"><![CDATA[<h3 id="Exclude-packages"><a href="#Exclude-packages" class="headerlink" title="Exclude packages"></a>Exclude packages</h3><h4 id="Cli"><a href="#Cli" class="headerlink" title="Cli"></a>Cli</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=/dev/shm/<span class="built_in">test</span> bs=1M count=512</span><br><span class="line">$ mfks.ext3 -b 4096 /dev/shm/<span class="built_in">test</span></span><br><span class="line">$ mount /dev/shm/<span class="built_in">test</span> /mnt</span><br><span class="line"></span><br><span class="line">$ rm <span class="_">-f</span> <span class="built_in">test</span>;<span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..10000&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span>-<span class="variable">$i</span>-<span class="variable">$i</span> &gt;&gt; <span class="built_in">test</span>; <span class="keyword">done</span> </span><br><span class="line">$ filefrag -v <span class="built_in">test</span> </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">Filesystem cylinder groups approximately 4</span><br><span class="line">File size of <span class="built_in">test</span> is 146688 (36 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:        0..      15:       2576..      2591:     16:             merged</span><br><span class="line">   1:       16..      16:      33424..     33424:      1:       2592: merged</span><br><span class="line">   2:       17..      17:      33457..     33457:      1:      33425: merged</span><br><span class="line">   3:       18..      18:      33490..     33490:      1:      33458: merged</span><br><span class="line">   4:       19..      19:      33523..     33523:      1:      33491: merged</span><br><span class="line">   5:       20..      20:      33556..     33556:      1:      33524: merged</span><br><span class="line">   6:       21..      21:      33589..     33589:      1:      33557: merged</span><br><span class="line">   7:       22..      22:      33622..     33622:      1:      33590: merged</span><br><span class="line">   8:       23..      23:      33655..     33655:      1:      33623: merged</span><br><span class="line">   9:       24..      24:      33688..     33688:      1:      33656: merged</span><br><span class="line">  10:       25..      25:      33721..     33721:      1:      33689: merged</span><br><span class="line">  11:       26..      26:      33754..     33754:      1:      33722: merged</span><br><span class="line">  12:       27..      27:      33787..     33787:      1:      33755: merged</span><br><span class="line">  13:       28..      28:      33820..     33820:      1:      33788: merged</span><br><span class="line">  14:       29..      29:      33853..     33853:      1:      33821: merged</span><br><span class="line">  15:       30..      30:      33886..     33886:      1:      33854: merged</span><br><span class="line">  16:       31..      31:      33919..     33919:      1:      33887: merged</span><br><span class="line">  17:       32..      32:      33952..     33952:      1:      33920: merged</span><br><span class="line">  18:       33..      33:      34017..     34017:      1:      33953: merged</span><br><span class="line">  19:       34..      34:      34082..     34082:      1:      34018: merged</span><br><span class="line">  20:       35..      35:      34147..     34147:      1:      34083: last,merged,eof</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">debugfs /dev/shm/<span class="built_in">test</span> </span><br><span class="line">debugfs 1.42.13 (17-May-2015)</span><br><span class="line">debugfs: <span class="built_in">stat</span> &lt;14&gt; </span><br><span class="line"></span><br><span class="line">Inode: 14   Type: regular    Mode:  0644   Flags: 0x0</span><br><span class="line">Generation: 3749441442    Version: 0x00000000:00000001</span><br><span class="line">User:     0   Group:     0   Size: 146688</span><br><span class="line">File ACL: 0    Directory ACL: 0</span><br><span class="line">Links: 1   Blockcount: 296</span><br><span class="line">Fragment:  Address: 0    Number: 0    Size: 0</span><br><span class="line"> ctime: 0x58763a68:1f1d1ee4 -- Wed Jan 11 22:00:08 2017</span><br><span class="line"> atime: 0x58763a67:e66e9d44 -- Wed Jan 11 22:00:07 2017</span><br><span class="line"> mtime: 0x58763a68:1f1d1ee4 -- Wed Jan 11 22:00:08 2017</span><br><span class="line">crtime: 0x58763a67:e66e9d44 -- Wed Jan 11 22:00:07 2017</span><br><span class="line">Size of extra inode fields: 32</span><br><span class="line">BLOCKS:</span><br><span class="line">(0-11):2576-2587, (IND):1538, (12-15):2588-2591, (16):33424, (17):33457, (18):33490, (19):33523, (20):33556, (21):33589, (22):33622, (23):33655, (24):33688, (25):33721, (26):33754, (27):33787, (28):33820, (29):33853, (30):33886, (31):33919, (32):33952, (33):34017, (34):34082, (35):34147</span><br><span class="line">TOTAL: 37</span><br><span class="line"></span><br><span class="line">dd <span class="keyword">if</span>=/dev/shm/<span class="built_in">test</span> of=<span class="built_in">test</span>-1 bs=4K skip=2576 count=$((2591-2576+1))</span><br><span class="line">head <span class="built_in">test</span>-1 ; wc <span class="_">-l</span> <span class="built_in">test</span>-1 ;tail <span class="built_in">test</span>-1</span><br><span class="line">0-0-0</span><br><span class="line">1-1-1</span><br><span class="line">2-2-2</span><br><span class="line">3-3-3</span><br><span class="line">4-4-4</span><br><span class="line">5-5-5</span><br><span class="line">6-6-6</span><br><span class="line">7-7-7</span><br><span class="line">8-8-8</span><br><span class="line">9-9-9</span><br><span class="line">4591 <span class="built_in">test</span>-1</span><br><span class="line">4582-4582-4582</span><br><span class="line">4583-4583-4583</span><br><span class="line">4584-4584-4584</span><br><span class="line">4585-4585-4585</span><br><span class="line">4586-4586-4586</span><br><span class="line">4587-4587-4587</span><br><span class="line">4588-4588-4588</span><br><span class="line">4589-4589-4589</span><br><span class="line">4590-4590-4590</span><br><span class="line">4</span><br><span class="line"></span><br><span class="line">dd <span class="keyword">if</span>=/dev/shm/<span class="built_in">test</span> of=<span class="built_in">test</span>-2 bs=4K skip=33424 count=1</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB, 4.0 KiB) copied, 0.000193943 s, 21.1 MB/s</span><br><span class="line">root@homerl-System-Product-Name:/mnt<span class="comment"># head test-2 ; wc -l test-2 ;tail test-2</span></span><br><span class="line">591-4591-4591</span><br><span class="line">4592-4592-4592</span><br><span class="line">4593-4593-4593</span><br><span class="line">4594-4594-4594</span><br><span class="line">4595-4595-4595</span><br><span class="line">4596-4596-4596</span><br><span class="line">4597-4597-4597</span><br><span class="line">4598-4598-4598</span><br><span class="line">4599-4599-4599</span><br><span class="line">4600-4600-4600</span><br><span class="line">273 <span class="built_in">test</span>-2</span><br><span class="line">4855-4855-4855</span><br><span class="line">4856-4856-4856</span><br><span class="line">4857-4857-4857</span><br><span class="line">4858-4858-4858</span><br><span class="line">4859-4859-4859</span><br><span class="line">4860-4860-4860</span><br><span class="line">4861-4861-4861</span><br><span class="line">4862-4862-4862</span><br><span class="line">4863-4863-4863</span><br><span class="line">48</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">root@homerl-System-Product-Name:/mnt<span class="comment"># dd if=/dev/shm/test of=test-3 bs=4K skip=33457 count=1</span></span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB, 4.0 KiB) copied, 0.000193132 s, 21.2 MB/s</span><br><span class="line">root@homerl-System-Product-Name:/mnt<span class="comment"># head test-3 ; wc -l test-3 ;tail test-3</span></span><br><span class="line">64-4864-4864</span><br><span class="line">4865-4865-4865</span><br><span class="line">4866-4866-4866</span><br><span class="line">4867-4867-4867</span><br><span class="line">4868-4868-4868</span><br><span class="line">4869-4869-4869</span><br><span class="line">4870-4870-4870</span><br><span class="line">4871-4871-4871</span><br><span class="line">4872-4872-4872</span><br><span class="line">4873-4873-4873</span><br><span class="line">273 <span class="built_in">test</span>-3</span><br><span class="line">5128-5128-5128</span><br><span class="line">5129-5129-5129</span><br><span class="line">5130-5130-5130</span><br><span class="line">5131-5131-5131</span><br><span class="line">5132-5132-5132</span><br><span class="line">5133-5133-5133</span><br><span class="line">5134-5134-5134</span><br><span class="line">5135-5135-5135</span><br><span class="line">5136-5136-5136</span><br><span class="line">513</span><br></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> filesystem </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> ext4 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Learn openzfs]]></title>
      <url>http://yoursite.com/2017/01/03/Learn-openzfs/</url>
      <content type="html"><![CDATA[<p>###</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">00000000  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">00003fd0  00 00 00 00 00 00 00 00  11 7a 0c b1 7a da 10 02  |.........z..z...|</span><br><span class="line">...</span><br><span class="line">000043c0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">0001ffd0  00 00 00 00 00 00 00 00  11 7a 0c b1 7a da 10 02  |.........z..z...|</span><br><span class="line">...</span><br><span class="line">00020010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">00021000  0c b1 ba 00 00 00 00 00  88 13 00 00 00 00 00 00  |................|</span><br><span class="line">...</span><br><span class="line">000210b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">000213d0  00 00 00 00 00 00 00 00  11 7a 0c b1 7a da 10 02  |.........z..z...|</span><br><span class="line">...</span><br><span class="line">000214b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">000217d0  00 00 00 00 00 00 00 00  11 7a 0c b1 7a da 10 02  |.........z..z...|</span><br><span class="line">000217e0  51 c5 e5 d7 3c d9 79 66  b2 6d 81 67 56 bd 92 df  |Q...&lt;.yf.m.gV...|</span><br><span class="line">000217f0  f7 c7 03 02 fa fb 73 8c  2b 8c 9c 74 8a 9e a3 b2  |......s.+..t....|</span><br><span class="line">00021800  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">0003ffd0  00 00 00 00 00 00 00 00  11 7a 0c b1 7a da 10 02  |.........z..z...|</span><br><span class="line">0003ffe0  4a 12 20 c9 20 33 d9 75  a4 0b 73 a6 7f 7e 7f 06  |J. . 3.u..s..~..|</span><br><span class="line">0003fff0  da 88 65 39 62 62 86 01  75 68 a3 f8 be a3 bf fd  |..e9bb..uh......|</span><br><span class="line">00040000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">0x3fd0=12240</span><br><span class="line">0x1ffd0=131024</span><br><span class="line">0x20010=131088</span><br><span class="line">0x213d0=136144</span><br><span class="line">0x217d0=137168</span><br><span class="line">0x3ffd0=262096</span><br><span class="line">0x40000=262144</span><br><span class="line"></span><br><span class="line">awk <span class="string">'BEGIN&#123;print 12240/1024&#125;'</span></span><br><span class="line">11.9531</span><br><span class="line">awk <span class="string">'BEGIN&#123;print 131024/1024&#125;'</span></span><br><span class="line">127.953</span><br><span class="line">awk <span class="string">'BEGIN&#123;print 131088/1024&#125;'</span></span><br><span class="line">128.016</span><br><span class="line">awk <span class="string">'BEGIN&#123;print 136144/1024&#125;'</span></span><br><span class="line">132.953</span><br><span class="line">awk <span class="string">'BEGIN&#123;print 137168/1024&#125;'</span></span><br><span class="line">133.953</span><br><span class="line">awk <span class="string">'BEGIN&#123;print 262096/1024&#125;'</span></span><br><span class="line">255.953</span><br><span class="line">awk <span class="string">'BEGIN&#123;print 262144/1024&#125;'</span></span><br><span class="line">256</span><br><span class="line"></span><br><span class="line">dd <span class="keyword">if</span>=/mnt/disk0 of=<span class="built_in">test</span> bs=1K count=256</span><br><span class="line">dd <span class="keyword">if</span>=/mnt/disk0 of=<span class="built_in">test</span>1 bs=1K count=256 skip=256</span><br><span class="line">hexdump -C <span class="built_in">test</span>1  | grep <span class="string">"11 7a 0c b1"</span></span><br><span class="line">00003fd0  00 00 00 00 00 00 00 00  11 7a 0c b1 7a da 10 02  |.........z..z...|</span><br><span class="line">0001ffd0  00 00 00 00 00 00 00 00  11 7a 0c b1 7a da 10 02  |.........z..z...|</span><br><span class="line">000213d0  00 00 00 00 00 00 00 00  11 7a 0c b1 7a da 10 02  |.........z..z...|</span><br><span class="line">000217d0  00 00 00 00 00 00 00 00  11 7a 0c b1 7a da 10 02  |.........z..z...|</span><br><span class="line">0003ffd0  00 00 00 00 00 00 00 00  11 7a 0c b1 7a da 10 02  |.........z..z...|</span><br><span class="line"></span><br><span class="line">hexdump -C <span class="built_in">test</span>  | grep <span class="string">"11 7a 0c b1"</span></span><br><span class="line">00003fd0  00 00 00 00 00 00 00 00  11 7a 0c b1 7a da 10 02  |.........z..z...|</span><br><span class="line">0001ffd0  00 00 00 00 00 00 00 00  11 7a 0c b1 7a da 10 02  |.........z..z...|</span><br><span class="line">000213d0  00 00 00 00 00 00 00 00  11 7a 0c b1 7a da 10 02  |.........z..z...|</span><br><span class="line">000217d0  00 00 00 00 00 00 00 00  11 7a 0c b1 7a da 10 02  |.........z..z...|</span><br><span class="line">0003ffd0  00 00 00 00 00 00 00 00  11 7a 0c b1 7a da 10 02  |.........z..z...|</span><br></pre></td></tr></table></figure>
<p>zbt_magic: ZIO block tail magic number. The value is<br>0x210da7ab10c7a11 (zio-data-bloc-tail).<br>Why reverse order ?</p>
<h4 id="Uberblock"><a href="#Uberblock" class="headerlink" title="Uberblock"></a>Uberblock</h4><p>ub_magic<br>The uberblock magic number is a 64 bit integer used to identify a device as containing ZFS data.<br>Big Endian: 0x00bab10c<br>Little Endian: 0x0cb1ba00</p>
<p>0x21000=135168<br>awk ‘BEGIN{print 135168/1024-128}’<br>4</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">hexdump -C disk0 | grep <span class="string">"0c b1 ba 00"</span> -i</span><br><span class="line">00021000  0c b1 ba 00 00 00 00 00  88 13 00 00 00 00 00 00  |................|</span><br><span class="line">00021400  0c b1 ba 00 00 00 00 00  88 13 00 00 00 00 00 00  |................|</span><br><span class="line">00061000  0c b1 ba 00 00 00 00 00  88 13 00 00 00 00 00 00  |................|</span><br><span class="line">00061400  0c b1 ba 00 00 00 00 00  88 13 00 00 00 00 00 00  |................|</span><br><span class="line">3ffa1000  0c b1 ba 00 00 00 00 00  88 13 00 00 00 00 00 00  |................|</span><br><span class="line">3ffa1400  0c b1 ba 00 00 00 00 00  88 13 00 00 00 00 00 00  |................|</span><br><span class="line">3ffe1000  0c b1 ba 00 00 00 00 00  88 13 00 00 00 00 00 00  |................|</span><br><span class="line">3ffe1400  0c b1 ba 00 00 00 00 00  88 13 00 00 00 00 00 00  |................|</span><br></pre></td></tr></table></figure>
]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[A copy about ZFS Internals(p1-p5)]]></title>
      <url>http://yoursite.com/2016/12/28/Learn-ZFS-Internals-p1-p5/</url>
      <content type="html"><![CDATA[<h3 id="ZFS-Internals-It-‘s-dangerous-operations"><a href="#ZFS-Internals-It-‘s-dangerous-operations" class="headerlink" title="ZFS Internals It ‘s dangerous operations"></a><a href="http://www.eall.com.br/blog/?p=312" target="_blank" rel="external">ZFS Internals</a> It ‘s dangerous operations</h3><p>After 8 years, I ‘m try to study openzfs</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=disk0 bs=1M count=100</span><br><span class="line">104857600 bytes (105 MB) copied, 0.0582985 s, 1.8 GB/s</span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=disk1 bs=1M count=100</span><br><span class="line">104857600 bytes (105 MB) copied, 0.0587067 s, 1.8 GB/s</span><br><span class="line">$ zpool create <span class="built_in">test</span>-pool /tank/<span class="built_in">test</span>/disk0  /tank/<span class="built_in">test</span>/disk1 </span><br><span class="line"></span><br><span class="line"><span class="comment"># I don 't know why only 128M could be used. loss a lot of capacity</span></span><br><span class="line">$ zpool list <span class="built_in">test</span>-pool</span><br><span class="line">NAME        SIZE  ALLOC   FREE  EXPANDSZ   FRAG    CAP  DEDUP  HEALTH  ALTROOT</span><br><span class="line"><span class="built_in">test</span>-pool   160M   244K   160M         -     1%     0%  1.00x  ONLINE  -</span><br><span class="line"></span><br><span class="line">$ zfs get compression <span class="built_in">test</span>-pool</span><br><span class="line">NAME       PROPERTY     VALUE     SOURCE</span><br><span class="line"><span class="built_in">test</span>-pool  compression  off       default</span><br><span class="line">$ zfs get recordsize <span class="built_in">test</span>-pool</span><br><span class="line">NAME       PROPERTY    VALUE    SOURCE</span><br><span class="line"><span class="built_in">test</span>-pool  recordsize  128K     default</span><br><span class="line"></span><br><span class="line">$ touch /<span class="built_in">test</span>-pool/empty </span><br><span class="line">$ du -hs /<span class="built_in">test</span>-pool/empty</span><br><span class="line">512	/<span class="built_in">test</span>-pool/empty</span><br><span class="line"></span><br><span class="line"><span class="comment"># ashift=0 ?</span></span><br><span class="line"><span class="built_in">test</span>-pool  ashift    0       default</span><br><span class="line"></span><br><span class="line">$ rm <span class="_">-f</span> testfile ;<span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..65535&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span> &gt;&gt; testfile; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">$ ls -li</span><br><span class="line">7 -rw-r--r-- 1 root root 382106 12月 28 12:45 testfile</span><br><span class="line"></span><br><span class="line">$ zdb -dddddddd <span class="built_in">test</span>-pool/ 7</span><br><span class="line">Dataset <span class="built_in">test</span>-pool [ZPL], ID 21, cr_txg 1, 404K, 7 objects, rootbp DVA[0]=&lt;0:16600:200&gt; DVA[1]=&lt;1:89200:200&gt; [L0 DMU objset] fletcher4 lz4 LE contiguous unique double size=800L/200P birth=77L/77P fill=7 cksum=b706a1be7:479be3ec2c2:e63cf120702c:1fa949c8882cfd</span><br><span class="line"></span><br><span class="line">    Object  lvl   iblk   dblk  dsize  lsize   %full  <span class="built_in">type</span></span><br><span class="line">         7    2    16K   128K   385K   384K  100.00  ZFS plain file (K=inherit) (Z=inherit)</span><br><span class="line">                                        168   bonus  System attributes</span><br><span class="line">	dnode flags: USED_BYTES USERUSED_ACCOUNTED </span><br><span class="line">	dnode maxblkid: 2</span><br><span class="line">	path	/testfile</span><br><span class="line">	uid     0</span><br><span class="line">	gid     0</span><br><span class="line">	atime	Wed Dec 28 12:45:10 2016</span><br><span class="line">	mtime	Wed Dec 28 12:45:12 2016</span><br><span class="line">	ctime	Wed Dec 28 12:45:12 2016</span><br><span class="line">	crtime	Wed Dec 28 12:45:10 2016</span><br><span class="line">	gen	77</span><br><span class="line">	mode	100644</span><br><span class="line">	size	382106</span><br><span class="line">	parent	4</span><br><span class="line">	links	1</span><br><span class="line">	pflags	40800000004</span><br><span class="line">Indirect blocks:</span><br><span class="line">               0 L1  0:2400:200 1:2400:200 4000L/200P F=3 B=77/77</span><br><span class="line">               0  L0 1:28000:20000 20000L/20000P F=1 B=77/77</span><br><span class="line">           20000  L0 1:48000:20000 20000L/20000P F=1 B=77/77</span><br><span class="line">           40000  L0 1:68000:20000 20000L/20000P F=1 B=77/77</span><br><span class="line"></span><br><span class="line">		segment [0000000000000000, 0000000000060000) size  384K</span><br><span class="line"></span><br><span class="line">$ awk <span class="string">'BEGIN&#123;print strtonum("0x"20000)&#125;'</span></span><br><span class="line">131072</span><br></pre></td></tr></table></figure>
<ul>
<li><p>0 0 L1  0:2400:200 1:2400:200 4000L/200P F=3 B=77/77</p>
<ul>
<li>L1 means two levels of indirection (number of block pointers which need to be traversed to arrive at this data)</li>
<li>0:2400:200 = disk0 , first raidz volume ?</li>
<li>the offset from the begining of the disk (2400)</li>
<li>and the size of the block (0x200 = 512 bytes)</li>
<li>0:2400 is the Data virtual Address 1 (dva1, Data virtual address )</li>
<li>F=3  is the fill count, and describes the number of non-zero block pointers under this block pointer</li>
<li>B=77/77 is the birth time, what is the same as the txg number, or some body said it ‘s a transaction number ?</li>
</ul>
</li>
<li><p>0  L0 1:28000:20000 20000L/20000P F=1 B=77/77</p>
<ul>
<li>L0 is the block level that holds data (we can have up to six levels)</li>
<li>the fill count has a little different interpretation. Here the F= means if the block has data or not (0 or 1), what is different from the levels 1 and above, where it means “how many” non-zero block pointers under this block pointer. </li>
</ul>
</li>
</ul>
<p>Output first 128K of our file<br>16 bytes per line</p>
<p>-R poolname vdev:offset:size[:flags]</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'BEGIN&#123;print strtonum("0x"20000)&#125;'</span></span><br><span class="line">131072</span><br><span class="line"></span><br><span class="line">$ zdb -R <span class="built_in">test</span>-pool/ 1:28000:20000 | head</span><br><span class="line">1:28000:20000</span><br><span class="line">          0 1 2 3 4 5 6 7   8 9 a b c d e f  0123456789abcdef</span><br><span class="line">000000:  0a330a320a310a30  0a370a360a350a34  0.1.2.3.4.5.6.7.</span><br><span class="line">000010:  310a30310a390a38  0a33310a32310a31  8.9.10.11.12.13.</span><br><span class="line">000020:  36310a35310a3431  310a38310a37310a  14.15.16.17.18.1</span><br><span class="line">000030:  0a31320a30320a39  34320a33320a3232  9.20.21.22.23.24</span><br><span class="line">000040:  320a36320a35320a  0a39320a38320a37  .25.26.27.28.29.</span><br><span class="line">000050:  32330a31330a3033  330a34330a33330a  30.31.32.33.34.3</span><br><span class="line">000060:  0a37330a36330a35  30340a39330a3833  5.36.37.38.39.40</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">$ zdb -R tank/<span class="built_in">test</span> 1:28000:20000:r | head</span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line"></span><br><span class="line">$ zdb -R <span class="built_in">test</span>-pool/ 1:28000:20000:r &gt; file1</span><br><span class="line">Found vdev: /tank/<span class="built_in">test</span>/disk1</span><br><span class="line">$ zdb -R <span class="built_in">test</span>-pool/ 1:48000:20000:r &gt; file2</span><br><span class="line">Found vdev: /tank/<span class="built_in">test</span>/disk1</span><br><span class="line">$ zdb -R <span class="built_in">test</span>-pool/ 1:68000:20000:r &gt; file3</span><br><span class="line">Found vdev: /tank/<span class="built_in">test</span>/disk1</span><br><span class="line"></span><br><span class="line">$ ls -lh</span><br><span class="line">-rw-r--r-- 1 root root 128K 12月 28 12:51 file1</span><br><span class="line">-rw-r--r-- 1 root root 128K 12月 28 12:53 file2</span><br><span class="line">-rw-r--r-- 1 root root 128K 12月 28 12:53 file3</span><br><span class="line">-rw-r--r-- 1 root root 374K 12月 28 12:45 testfile</span><br><span class="line"></span><br><span class="line">$ head -n 2 file1 </span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">$ head -n 2 testfile </span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">$ tail -n 2 file1</span><br><span class="line">23695</span><br><span class="line">23696</span><br><span class="line">$ head -n 2 file2</span><br><span class="line">23697</span><br><span class="line">23698</span><br><span class="line">$ tail -n 2 file2</span><br><span class="line">45541</span><br><span class="line">45$ head -n 2 file3</span><br><span class="line">542</span><br><span class="line">45543</span><br><span class="line">$ tail -n 2 file3</span><br><span class="line">65535</span><br><span class="line"></span><br><span class="line"><span class="comment"># why output single line ?</span></span><br><span class="line">$ tail -n 2 file3 | hexdump -C</span><br><span class="line">00000000  36 35 35 33 35 0a 00 00  00 00 00 00 00 00 00 00  |65535...........|</span><br><span class="line">00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">00002b60  00 00 00 00 00 00 00 00  00 00 00 00              |............|</span><br><span class="line">00002b6c</span><br><span class="line">$ tail -n 2 testfile | hexdump -C</span><br><span class="line">00000000  36 35 35 33 34 0a 36 35  35 33 35 0a              |65534.65535.|</span><br><span class="line">0000000c</span><br><span class="line"></span><br><span class="line"><span class="comment">#delete zero last line in file3, you could get same md5sum</span></span><br><span class="line"></span><br><span class="line">$ md5sum  testfile </span><br><span class="line">43a1b3e2e25c9410daefdaa1d78678bf  testfile</span><br><span class="line">$ cat file1 file2 file3 | md5sum </span><br><span class="line">43a1b3e2e25c9410daefdaa1d78678bf  -</span><br></pre></td></tr></table></figure>
<h1 id="Test-copy-on-write"><a href="#Test-copy-on-write" class="headerlink" title="Test copy on write"></a>Test copy on write</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">$ cp testfile testfile-1</span><br><span class="line">$ ls -i testfile-1 </span><br><span class="line">22 testfile-1</span><br><span class="line">$ zdb -dddddddd <span class="built_in">test</span>-pool/ 22</span><br><span class="line">Dataset <span class="built_in">test</span>-pool [ZPL], ID 21, cr_txg 1, 1.14M, 11 objects, rootbp DVA[0]=&lt;0:8e00:200&gt; DVA[1]=&lt;1:14e00:200&gt; [L0 DMU objset] fletcher4 lz4 LE contiguous unique double size=800L/200P birth=631L/631P fill=11 cksum=b211ccbf0:3ff67b6c728:bddd89c4f0bb:183789ced23226</span><br><span class="line"></span><br><span class="line">    Object  lvl   iblk   dblk  dsize  lsize   %full  <span class="built_in">type</span></span><br><span class="line">        22    2    16K   128K   385K   384K  100.00  ZFS plain file (K=inherit) (Z=inherit)</span><br><span class="line">                                        168   bonus  System attributes</span><br><span class="line">	dnode flags: USED_BYTES USERUSED_ACCOUNTED </span><br><span class="line">	dnode maxblkid: 2</span><br><span class="line">	path	/testfile-1</span><br><span class="line">	uid     0</span><br><span class="line">	gid     0</span><br><span class="line">	atime	Wed Dec 28 13:31:22 2016</span><br><span class="line">	mtime	Wed Dec 28 13:31:22 2016</span><br><span class="line">	ctime	Wed Dec 28 13:31:22 2016</span><br><span class="line">	crtime	Wed Dec 28 13:31:22 2016</span><br><span class="line">	gen	631</span><br><span class="line">	mode	100644</span><br><span class="line">	size	382106</span><br><span class="line">	parent	4</span><br><span class="line">	links	1</span><br><span class="line">	pflags	40800000004</span><br><span class="line">Indirect blocks:</span><br><span class="line">               0 L1  0:2600:200 1:2600:200 4000L/200P F=3 B=631/631</span><br><span class="line">               0  L0 1:adc00:20000 20000L/20000P F=1 B=631/631</span><br><span class="line">           20000  L0 1:cdc00:20000 20000L/20000P F=1 B=631/631</span><br><span class="line">           40000  L0 1:edc00:20000 20000L/20000P F=1 B=631/631</span><br><span class="line"></span><br><span class="line">		segment [0000000000000000, 0000000000060000) size  384K</span><br><span class="line"></span><br><span class="line">$ </span><br><span class="line">$ <span class="built_in">echo</span> haha &gt;&gt; testfile-1 </span><br><span class="line">$ zdb -dddddddd <span class="built_in">test</span>-pool/ 22</span><br><span class="line">Dataset <span class="built_in">test</span>-pool [ZPL], ID 21, cr_txg 1, 1.14M, 11 objects, rootbp DVA[0]=&lt;0:5e00:200&gt; DVA[1]=&lt;1:6a00:200&gt; [L0 DMU objset] fletcher4 lz4 LE contiguous unique double size=800L/200P birth=637L/637P fill=11 cksum=bcaba3f58:44283babf90:cb3dd715909e:1a01d96e52<span class="built_in">cd</span>6b</span><br><span class="line"></span><br><span class="line">    Object  lvl   iblk   dblk  dsize  lsize   %full  <span class="built_in">type</span></span><br><span class="line">        22    2    16K   128K   385K   384K  100.00  ZFS plain file (K=inherit) (Z=inherit)</span><br><span class="line">                                        168   bonus  System attributes</span><br><span class="line">	dnode flags: USED_BYTES USERUSED_ACCOUNTED </span><br><span class="line">	dnode maxblkid: 2</span><br><span class="line">	path	/testfile-1</span><br><span class="line">	uid     0</span><br><span class="line">	gid     0</span><br><span class="line">	atime	Wed Dec 28 13:31:22 2016</span><br><span class="line">	mtime	Wed Dec 28 13:31:49 2016</span><br><span class="line">	ctime	Wed Dec 28 13:31:49 2016</span><br><span class="line">	crtime	Wed Dec 28 13:31:22 2016</span><br><span class="line">	gen	631</span><br><span class="line">	mode	100644</span><br><span class="line">	size	382111</span><br><span class="line">	parent	4</span><br><span class="line">	links	1</span><br><span class="line">	pflags	40800000004</span><br><span class="line">Indirect blocks:</span><br><span class="line">               0 L1  0:5800:200 1:15400:200 4000L/200P F=3 B=637/637</span><br><span class="line">               0  L0 1:adc00:20000 20000L/20000P F=1 B=631/631</span><br><span class="line">           20000  L0 1:cdc00:20000 20000L/20000P F=1 B=631/631</span><br><span class="line">           40000  L0 0:7ca00:20000 20000L/20000P F=1 B=637/637 <span class="comment">### copy on write</span></span><br><span class="line"></span><br><span class="line">		segment [0000000000000000, 0000000000060000) size  384K</span><br></pre></td></tr></table></figure>
<h3 id="Find-the-physical-address"><a href="#Find-the-physical-address" class="headerlink" title="Find the physical address"></a>Find the physical address</h3><p>Because there are some different with solaris zfs, it ‘s not 4MiB in header.<br>I dd first 5MiB data from disk0.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=/tank/<span class="built_in">test</span>/disk0  of=/tmp/<span class="built_in">test</span> bs=1M count=5</span><br><span class="line"></span><br><span class="line"><span class="comment"># Found the data in disk0</span></span><br><span class="line">$ hexdump -C /tmp/<span class="built_in">test</span> | more</span><br><span class="line">00418<span class="built_in">fc</span>0  13 00 00 00 00 00 00 80  00 00 00 00 00 00 2e 66  |...............f|</span><br><span class="line">00418fd0  69 6c 65 33 2e 73 77 70  00 00 00 00 00 00 00 00  |ile3.swp........|</span><br><span class="line">00418fe0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">00419000  30 0a 31 0a 32 0a 33 0a  34 0a 35 0a 36 0a 37 0a  |0.1.2.3.4.5.6.7.|</span><br><span class="line">00419010  38 0a 39 0a 31 30 0a 31  31 0a 31 32 0a 31 33 0a  |8.9.10.11.12.13.|</span><br><span class="line">00419020  31 34 0a 31 35 0a 31 36  0a 31 37 0a 31 38 0a 31  |14.15.16.17.18.1|</span><br><span class="line">00419030  39 0a 32 30 0a 32 31 0a  32 32 0a 32 33 0a 32 34  |9.20.21.22.23.24|</span><br><span class="line">00419040  0a 32 35 0a 32 36 0a 32  37 0a 32 38 0a 32 39 0a  |.25.26.27.28.29.|</span><br><span class="line"></span><br><span class="line">$ awk <span class="string">'BEGIN&#123;print strtonum("0x"419000)&#125;'</span></span><br><span class="line">4296704</span><br><span class="line">$ $ awk <span class="string">'BEGIN&#123;print strtonum("0x"419000)/1024&#125;'</span></span><br><span class="line">4196</span><br><span class="line"></span><br><span class="line">$ awk <span class="string">'BEGIN&#123;print strtonum("0x"28000)&#125;'</span></span><br><span class="line">163840</span><br><span class="line">$ awk <span class="string">'BEGIN&#123;print strtonum("0x"20000)&#125;'</span></span><br><span class="line">131072</span><br><span class="line">$ awk <span class="string">'BEGIN&#123;print (4296704-163840)/1024&#125;'</span></span><br><span class="line">4036</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/tank/<span class="built_in">test</span>/disk0 of=/tmp/<span class="built_in">test</span>-1 bs=1k skip=4196 count=1</span><br><span class="line">$ head -n 2 /tmp/<span class="built_in">test</span>-1 </span><br><span class="line">0</span><br><span class="line">1</span><br></pre></td></tr></table></figure>
<p>which means the offset from the begining of the physical vdev (starting after the vdev labels, plus the boot block), 4036KiB total in openzfs on linux<br>4132864 = 3f100 ?</p>
<h3 id="Compare-with-ext3"><a href="#Compare-with-ext3" class="headerlink" title="Compare with ext3"></a>Compare with ext3</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tank/<span class="built_in">test</span></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=disk2 bs=1M count=100</span><br><span class="line">104857600 bytes (105 MB) copied, 0.0600031 s, 1.7 GB/s</span><br><span class="line"></span><br><span class="line">$ mkfs.ext3 -b 4096 /tank/<span class="built_in">test</span>/disk2</span><br><span class="line">mke2fs 1.41.12 (17-May-2010)</span><br><span class="line">/tank/<span class="built_in">test</span>/disk2 is not a block special device.</span><br><span class="line">Proceed anyway? (y,n) y</span><br><span class="line">Filesystem label=</span><br><span class="line">OS <span class="built_in">type</span>: Linux</span><br><span class="line">Block size=4096 (<span class="built_in">log</span>=2)</span><br><span class="line">Fragment size=4096 (<span class="built_in">log</span>=2)</span><br><span class="line">Stride=0 blocks, Stripe width=0 blocks</span><br><span class="line">25600 inodes, 25600 blocks</span><br><span class="line">1280 blocks (5.00%) reserved <span class="keyword">for</span> the super user</span><br><span class="line">First data block=0</span><br><span class="line">Maximum filesystem blocks=29360128</span><br><span class="line">1 block group</span><br><span class="line">32768 blocks per group, 32768 fragments per group</span><br><span class="line">25600 inodes per group</span><br><span class="line"></span><br><span class="line">Writing inode tables: <span class="keyword">done</span>                            </span><br><span class="line">Creating journal (1024 blocks): <span class="keyword">done</span></span><br><span class="line">Writing superblocks and filesystem accounting information: <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">This filesystem will be automatically checked every 24 mounts or</span><br><span class="line">180 days, whichever comes first.  Use tune2fs -c or -i to override.</span><br><span class="line"></span><br><span class="line">$ mount disk2 /mnt -o loop</span><br><span class="line">$ df -h</span><br><span class="line">Filesystem        Size  Used Avail Use% Mounted on</span><br><span class="line">/tank/<span class="built_in">test</span>/disk2   97M  4.5M   88M   5% /mnt</span><br><span class="line"></span><br><span class="line">$ cp <span class="_">-a</span> /<span class="built_in">test</span>-pool/testfile ./</span><br><span class="line">$ filefrag -v /mnt/testfile </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">Filesystem cylinder groups is approximately 1</span><br><span class="line">File size of /mnt/testfile is 382109 (94 blocks, blocksize 4096)</span><br><span class="line"> ext logical physical expected length flags</span><br><span class="line">   0       0     1841              12 merged</span><br><span class="line">   1      12     1854     1853     82 merged,eof</span><br><span class="line">/mnt/testfile: 2 extents found, perfection would be 1 extent</span><br><span class="line"></span><br><span class="line">$ umount /mnt</span><br><span class="line">$ debugfs /tank/<span class="built_in">test</span>/disk2 </span><br><span class="line"> 1.41.12 (17-May-2010)</span><br><span class="line">debugfs:  stats</span><br><span class="line">Filesystem volume name:   &lt;none&gt;</span><br><span class="line">Last mounted on:          &lt;not available&gt;</span><br><span class="line">Filesystem UUID:          d6f9c3d7<span class="_">-e</span>56b-433d-9830-69b15553029b</span><br><span class="line">Filesystem magic number:  0xEF53</span><br><span class="line">Filesystem revision <span class="comment">#:    1 (dynamic)</span></span><br><span class="line">Filesystem features:      has_journal ext_attr resize_inode dir_index filetype sparse_super large_file</span><br><span class="line">Filesystem flags:         signed_directory_<span class="built_in">hash</span> </span><br><span class="line">Default mount options:    (none)</span><br><span class="line">Filesystem state:         clean</span><br><span class="line">Errors behavior:          Continue</span><br><span class="line">Filesystem OS <span class="built_in">type</span>:       Linux</span><br><span class="line">Inode count:              25600</span><br><span class="line">Block count:              25600</span><br><span class="line">Reserved block count:     1280</span><br><span class="line">Free blocks:              23664</span><br><span class="line">Free inodes:              25588</span><br><span class="line">First block:              0</span><br><span class="line">Block size:               4096</span><br><span class="line">Fragment size:            4096</span><br><span class="line">Reserved GDT blocks:      6</span><br><span class="line">Blocks per group:         32768</span><br><span class="line">Fragments per group:      32768</span><br><span class="line">Inodes per group:         25600</span><br><span class="line">Inode blocks per group:   800</span><br><span class="line">Filesystem created:       Wed Dec 28 16:03:47 2016</span><br><span class="line">Last mount time:          Wed Dec 28 16:04:10 2016</span><br><span class="line">Last write time:          Wed Dec 28 16:04:52 2016</span><br><span class="line">Mount count:              1</span><br><span class="line">Maximum mount count:      24</span><br><span class="line">Last checked:             Wed Dec 28 16:03:47 2016</span><br><span class="line">Check interval:           15552000 (6 months)</span><br><span class="line">Next check after:         Mon Jun 26 16:03:47 2017</span><br><span class="line">Reserved blocks uid:      0 (user root)</span><br><span class="line">Reserved blocks gid:      0 (group root)</span><br><span class="line">First inode:              11</span><br><span class="line">Inode size:	          128</span><br><span class="line">Journal inode:            8</span><br><span class="line">Default directory <span class="built_in">hash</span>:   half_md4</span><br><span class="line">Directory Hash Seed:      58b4c828-2e74-4add-91bb-4007efd5187f</span><br><span class="line">Journal backup:           inode blocks</span><br><span class="line">Directories:              2</span><br><span class="line"> Group  0: block bitmap at 8, inode bitmap at 9, inode table at 10</span><br><span class="line">           23664 free blocks, 25588 free inodes, 2 used directories</span><br><span class="line"></span><br><span class="line">debugfs:  ls</span><br><span class="line"> 2  (12) .    2  (12) ..    11  (20) lost+found    12  (4052) testfile  </span><br><span class="line"></span><br><span class="line">debugfs:  show_inode_info testfile</span><br><span class="line">Inode: 12   Type: regular    Mode:  0644   Flags: 0x0</span><br><span class="line">Generation: 933995507    Version: 0x00000000</span><br><span class="line">User:     0   Group:     0   Size: 382109</span><br><span class="line">File ACL: 0    Directory ACL: 0</span><br><span class="line">Links: 1   Blockcount: 760</span><br><span class="line">Fragment:  Address: 0    Number: 0    Size: 0</span><br><span class="line">ctime: 0x58637206 -- Wed Dec 28 16:04:22 2016</span><br><span class="line">atime: 0x58637206 -- Wed Dec 28 16:04:22 2016</span><br><span class="line">mtime: 0x58637206 -- Wed Dec 28 16:04:22 2016</span><br><span class="line">BLOCKS:</span><br><span class="line">(0-11):1841-1852, (IND):1853, (12-93):1854-1935</span><br><span class="line">TOTAL: 95</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/tank/<span class="built_in">test</span>/disk2 of=/tmp/file-1 bs=4K count=12 skip=1841</span><br><span class="line"></span><br><span class="line">$ head -n 2 /tmp/file-1 </span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line">$ tail -n 2 /tmp/file-1 </span><br><span class="line">10042</span><br><span class="line">1004</span><br><span class="line"></span><br><span class="line"><span class="variable">$if</span>=/tank/<span class="built_in">test</span>/disk2 of=/tmp/file-2 bs=4K count=82 skip=1854</span><br><span class="line">$ head -n 2 /tmp/file-2</span><br><span class="line">3</span><br><span class="line">10044</span><br><span class="line">$ tail -n 2 /tmp/file-2 </span><br><span class="line">12</span><br><span class="line">$ tail -n 3 /tmp/file-2 </span><br><span class="line">65535</span><br><span class="line">12 <span class="comment"># I have echo 12 &gt;&gt; to testfile.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># delete zero line(last line) in file2</span></span><br><span class="line">$ cat /tmp/file-1 /tmp/file-2 | md5sum </span><br><span class="line">48688f1bef04b9b59905409e9226ba65  -</span><br><span class="line">$ md5sum /mnt/testfile </span><br><span class="line">48688f1bef04b9b59905409e9226ba65  /mnt/testfile</span><br><span class="line"></span><br><span class="line"><span class="comment">#Modify file</span></span><br><span class="line"></span><br><span class="line">$ filefrag -v /mnt/testfile </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">Filesystem cylinder groups is approximately 1</span><br><span class="line">File size of /mnt/testfile is 382109 (94 blocks, blocksize 4096)</span><br><span class="line"> ext logical physical expected length flags</span><br><span class="line">   0       0     4104              12 merged</span><br><span class="line">   1      12     4117     4116     82 merged,eof</span><br><span class="line">/mnt/testfile: 2 extents found, perfection would be 1 extent</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/tank/<span class="built_in">test</span>/disk2 of=/tmp/disk-2-1 bs=4k count=4105</span><br><span class="line">4105+0 records <span class="keyword">in</span></span><br><span class="line">4105+0 records out</span><br><span class="line">16814080 bytes (17 MB) copied, 0.161878 s, 104 MB/s</span><br><span class="line">You have new mail <span class="keyword">in</span> /var/spool/mail/root</span><br><span class="line">$ tail /tmp/disk-2-1 </span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line"></span><br><span class="line">1<span class="variable">$dd</span> <span class="keyword">if</span>=/tank/<span class="built_in">test</span>/disk2 of=/tmp/disk-2-2 bs=4k skip=4105 </span><br><span class="line">21495+0 records <span class="keyword">in</span></span><br><span class="line">21495+0 records out</span><br><span class="line">88043520 bytes (88 MB) copied, 0.66258 s, 133 MB/s</span><br><span class="line">$ head /tmp/disk-2-2 </span><br><span class="line">041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> 1111111111 &gt;&gt; /tmp/disk-2-1</span><br><span class="line"></span><br><span class="line">$ cat /tmp/disk-2-1 &gt; /tank/<span class="built_in">test</span>/disk2</span><br><span class="line">$ du -hs /tank/<span class="built_in">test</span>/disk2</span><br><span class="line">17M	/tank/<span class="built_in">test</span>/disk2</span><br><span class="line">$ cat /tmp/disk-2-2 &gt;&gt; /tank/<span class="built_in">test</span>/disk2</span><br><span class="line">$ du -hs /tank/<span class="built_in">test</span>/disk2 </span><br><span class="line">100M	/tank/<span class="built_in">test</span>/disk2</span><br><span class="line">$ fsck /tank/<span class="built_in">test</span>/disk2</span><br><span class="line">fsck from util-linux-ng 2.17.2</span><br><span class="line">e2fsck 1.41.12 (17-May-2010)</span><br><span class="line">/tank/<span class="built_in">test</span>/disk2: clean, 12/25600 files, 1936/25600 blocks</span><br><span class="line"></span><br><span class="line">$ mount /tank/<span class="built_in">test</span>/disk2 /mnt -o loop</span><br><span class="line"></span><br><span class="line">$ head -n 1042 /mnt/testfile | tail -n 2</span><br><span class="line">1040</span><br><span class="line">11111111111</span><br><span class="line"><span class="comment"># got it , file has changed.</span></span><br></pre></td></tr></table></figure>
<h3 id="Same-with-openzfs"><a href="#Same-with-openzfs" class="headerlink" title="Same with openzfs"></a>Same with openzfs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">-bash-4.1<span class="comment"># zpool destroy test-pool</span></span><br><span class="line">$ zpool create <span class="built_in">test</span>-pool /tank/<span class="built_in">test</span>/disk0</span><br><span class="line">$ zpool create <span class="built_in">test</span>-pool -o ashift=9 /tank/<span class="built_in">test</span>/disk0</span><br><span class="line">$ rm <span class="_">-f</span> testfile ;<span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..65535&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span> &gt;&gt; testfile; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">0040f6a0  ff ff ff a6 50 00 00 00  00 00 00 00 00 00 00 00  |....P...........|</span><br><span class="line">0040f6b0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|</span><br><span class="line">*</span><br><span class="line">0040f800  30 0a 31 0a 32 0a 33 0a  34 0a 35 0a 36 0a 37 0a  |0.1.2.3.4.5.6.7.|</span><br><span class="line">0040f810  38 0a 39 0a 31 30 0a 31  31 0a 31 32 0a 31 33 0a  |8.9.10.11.12.13.|</span><br><span class="line">0040f820  31 34 0a 31 35 0a 31 36  0a 31 37 0a 31 38 0a 31  |14.15.16.17.18.1|</span><br><span class="line">0040f830  39 0a 32 30 0a 32 31 0a  32 32 0a 32 33 0a 32 34  |9.20.21.22.23.24|</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ ls -li /<span class="built_in">test</span>-pool/testfile </span><br><span class="line">7 -rw-r--r-- 1 root root 382106 12月 28 17:31 /<span class="built_in">test</span>-pool/testfile</span><br><span class="line"></span><br><span class="line">$ zdb -dddddd <span class="built_in">test</span>-pool/ 7</span><br><span class="line">Dataset <span class="built_in">test</span>-pool [ZPL], ID 21, cr_txg 1, 404K, 7 objects, rootbp DVA[0]=&lt;0:71c00:200&gt; DVA[1]=&lt;0:71e00:200&gt; [L0 DMU objset] fletcher4 lz4 LE contiguous unique double size=800L/200P birth=7L/7P fill=7 cksum=d25a82905:4fd05e01a15:f9b25d4668de:21890ed460fd11</span><br><span class="line"></span><br><span class="line">    Object  lvl   iblk   dblk  dsize  lsize   %full  <span class="built_in">type</span></span><br><span class="line">         7    2    16K   128K   385K   384K  100.00  ZFS plain file (K=inherit) (Z=inherit)</span><br><span class="line">                                        168   bonus  System attributes</span><br><span class="line">	dnode flags: USED_BYTES USERUSED_ACCOUNTED </span><br><span class="line">	dnode maxblkid: 2</span><br><span class="line">	path	/testfile</span><br><span class="line">	uid     0</span><br><span class="line">	gid     0</span><br><span class="line">	atime	Wed Dec 28 17:31:11 2016</span><br><span class="line">	mtime	Wed Dec 28 17:31:13 2016</span><br><span class="line">	ctime	Wed Dec 28 17:31:13 2016</span><br><span class="line">	crtime	Wed Dec 28 17:31:11 2016</span><br><span class="line">	gen	7</span><br><span class="line">	mode	100644</span><br><span class="line">	size	382106</span><br><span class="line">	parent	4</span><br><span class="line">	links	1</span><br><span class="line">	pflags	40800000004</span><br><span class="line">Indirect blocks:</span><br><span class="line">               0 L1  0:4800:200 0:4a00:200 4000L/200P F=3 B=7/7</span><br><span class="line">               0  L0 0:f800:20000 20000L/20000P F=1 B=7/7</span><br><span class="line">           20000  L0 0:2f800:20000 20000L/20000P F=1 B=7/7</span><br><span class="line">           40000  L0 0:4f800:20000 20000L/20000P F=1 B=7/7</span><br><span class="line"></span><br><span class="line">		segment [0000000000000000, 0000000000060000) size  384K</span><br><span class="line"></span><br><span class="line">$ 40f800=4257792</span><br><span class="line">$ f800=63488</span><br><span class="line">$ awk <span class="string">'BEGIN&#123;print (4257792-63488)/1024&#125;'</span></span><br><span class="line">4096</span><br></pre></td></tr></table></figure>
<p>Header is 4MiB, and offset 63488 begin to write real data</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'BEGIN&#123;print strtonum("0x40f800")/1024&#125;'</span></span><br><span class="line">4158</span><br><span class="line"></span><br><span class="line">$ zdb -R <span class="built_in">test</span>-pool 0:f800:20000:r &gt; /tmp/file1</span><br><span class="line">-bash-4.1<span class="comment"># head /tmp/file1 </span></span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line"></span><br><span class="line"><span class="comment"># modify /tmp/file1</span></span><br><span class="line">$ head -n 4 /tmp/file1</span><br><span class="line"><span class="comment">#0</span></span><br><span class="line"><span class="comment">#1</span></span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/tank/<span class="built_in">test</span>/disk0 of=/tmp/disk0-1 bs=1k count=4158</span><br><span class="line">$ dd <span class="keyword">if</span>=/tank/<span class="built_in">test</span>/disk0 of=/tmp/disk0-2 bs=1k skip=4158 count=1</span><br><span class="line">$ dd <span class="keyword">if</span>=/tank/<span class="built_in">test</span>/disk0 of=/tmp/disk0-3 bs=1k skip=4159</span><br><span class="line"></span><br><span class="line">$ head /tmp/disk0-2 </span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line"></span><br><span class="line">-bash-4.1<span class="comment"># tail /tmp/disk0-2 </span></span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">28</span><br><span class="line"></span><br><span class="line">$ ls <span class="_">-l</span> /tmp/disk0-*</span><br><span class="line">-rw-r--r-- 1 root root   4257792 12月 28 19:59 /tmp/disk0-1</span><br><span class="line">-rw-r--r-- 1 root root      1024 12月 28 19:59 /tmp/disk0-2</span><br><span class="line">-rw-r--r-- 1 root root 100598784 12月 28 20:03 /tmp/disk0-3</span><br><span class="line"></span><br><span class="line"><span class="comment"># modify disk0-2</span></span><br><span class="line">$ vi /tmp/disk0-2 </span><br><span class="line">-bash-4.1<span class="comment"># head -n 2 /tmp/disk0-2 </span></span><br><span class="line"><span class="comment">#0</span></span><br><span class="line"><span class="comment">#1</span></span><br><span class="line"></span><br><span class="line">$ cp /tmp/disk0-1 /tank/<span class="built_in">test</span>/disk0</span><br><span class="line">$ cat /tmp/disk0-2 &gt;&gt; /tank/<span class="built_in">test</span>/disk0</span><br><span class="line">$ cat /tmp/disk0-3 &gt;&gt; /tank/<span class="built_in">test</span>/disk0</span><br><span class="line">$ zpool import <span class="_">-d</span> /tank/<span class="built_in">test</span>/ <span class="built_in">test</span>-pool</span><br><span class="line">cannot import <span class="string">'test-pool'</span>: I/O error</span><br><span class="line">	Destroy and re-create the pool from</span><br><span class="line">	a backup source.</span><br><span class="line"></span><br><span class="line">$ zdb <span class="_">-l</span> /tank/<span class="built_in">test</span>/disk0 </span><br><span class="line">zdb <span class="_">-l</span> /tank/<span class="built_in">test</span>/disk0</span><br><span class="line">--------------------------------------------</span><br><span class="line">LABEL 0</span><br><span class="line">--------------------------------------------</span><br><span class="line">    version: 5000</span><br><span class="line">    name: <span class="string">'test-pool'</span></span><br><span class="line">    state: 0</span><br><span class="line">    txg: 1277</span><br><span class="line">    pool_guid: 2913619627256210242</span><br><span class="line">    errata: 0</span><br><span class="line">    hostname: <span class="string">'nas-57-11.local'</span></span><br><span class="line">    top_guid: 14729225611287826913</span><br><span class="line">    guid: 14729225611287826913</span><br><span class="line">    vdev_children: 1</span><br><span class="line">    vdev_tree:</span><br><span class="line">        <span class="built_in">type</span>: <span class="string">'file'</span></span><br><span class="line">        id: 0</span><br><span class="line">        guid: 14729225611287826913</span><br><span class="line">        path: <span class="string">'/tank/test/disk0'</span></span><br><span class="line">        metaslab_array: 35</span><br><span class="line">        metaslab_<span class="built_in">shift</span>: 24</span><br><span class="line">        ashift: 9</span><br><span class="line">        asize: 100139008</span><br><span class="line">        is_<span class="built_in">log</span>: 0</span><br><span class="line">        create_txg: 4</span><br><span class="line">    features_<span class="keyword">for</span>_<span class="built_in">read</span>:</span><br><span class="line">        com.delphix:hole_birth</span><br><span class="line">        com.delphix:embedded_data</span><br><span class="line">--------------------------------------------</span><br><span class="line">LABEL 1</span><br><span class="line">--------------------------------------------</span><br><span class="line">    version: 5000</span><br><span class="line">    name: <span class="string">'test-pool'</span></span><br><span class="line">    state: 0</span><br><span class="line">    txg: 1277</span><br><span class="line">    pool_guid: 2913619627256210242</span><br><span class="line">    errata: 0</span><br><span class="line">    hostname: <span class="string">'nas-57-11.local'</span></span><br><span class="line">    top_guid: 14729225611287826913</span><br><span class="line">    guid: 14729225611287826913</span><br><span class="line">    vdev_children: 1</span><br><span class="line">    vdev_tree:</span><br><span class="line">        <span class="built_in">type</span>: <span class="string">'file'</span></span><br><span class="line">        id: 0</span><br><span class="line">        guid: 14729225611287826913</span><br><span class="line">        path: <span class="string">'/tank/test/disk0'</span></span><br><span class="line">        metaslab_array: 35</span><br><span class="line">        metaslab_<span class="built_in">shift</span>: 24</span><br><span class="line">        ashift: 9</span><br><span class="line">        asize: 100139008</span><br><span class="line">        is_<span class="built_in">log</span>: 0</span><br><span class="line">        create_txg: 4</span><br><span class="line">    features_<span class="keyword">for</span>_<span class="built_in">read</span>:</span><br><span class="line">        com.delphix:hole_birth</span><br><span class="line">        com.delphix:embedded_data</span><br><span class="line">--------------------------------------------</span><br><span class="line">LABEL 2</span><br><span class="line">--------------------------------------------</span><br><span class="line">failed to unpack label 2</span><br><span class="line">--------------------------------------------</span><br><span class="line">LABEL 3</span><br><span class="line">--------------------------------------------</span><br><span class="line">failed to unpack label 3</span><br><span class="line"></span><br><span class="line">$ zpool import -N -o <span class="built_in">readonly</span>=on <span class="_">-f</span> <span class="_">-d</span> /tank/<span class="built_in">test</span>/ -F -T 1277</span><br><span class="line">   pool: <span class="built_in">test</span>-pool</span><br><span class="line">     id: 2913619627256210242</span><br><span class="line">  state: FAULTED</span><br><span class="line"> status: The pool metadata is corrupted.</span><br><span class="line"> action: The pool cannot be imported due to damaged devices or data.</span><br><span class="line">	The pool may be active on another system, but can be imported using</span><br><span class="line">	the <span class="string">'-f'</span> flag.</span><br><span class="line">   see: http://zfsonlinux.org/msg/ZFS-8000-72</span><br><span class="line"> config:</span><br><span class="line"></span><br><span class="line">	<span class="built_in">test</span>-pool           FAULTED  corrupted data</span><br><span class="line">	  /tank/<span class="built_in">test</span>/disk0  ONLINE</span><br></pre></td></tr></table></figure>
<h3 id="Raidz-size"><a href="#Raidz-size" class="headerlink" title="Raidz size"></a><a href="http://blog.gjpvanwesten.nl/2014/08/part-iv-how-much-space-do-you-lose-with.html" target="_blank" rel="external">Raidz size</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'BEGIN&#123;print 128/7&#125;'</span></span><br><span class="line">18.2857</span><br><span class="line">awk <span class="string">'BEGIN&#123;print 18.2857/20&#125;'</span></span><br><span class="line">0.914285</span><br><span class="line">awk <span class="string">'BEGIN&#123;print 18.2857/18.5&#125;'</span></span><br><span class="line">0.988416</span><br></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> filesystem </category>
            
        </categories>
        
        
        <tags>
            
            <tag> zfs </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[blk-mq with SAS SSD]]></title>
      <url>http://yoursite.com/2016/12/23/blk-mq-with-SAS-SSD/</url>
      <content type="html"><![CDATA[<h3 id="blk-mq-in-RHEL-7-2"><a href="#blk-mq-in-RHEL-7-2" class="headerlink" title="blk-mq in RHEL 7.2"></a><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/7/html/7.2_Release_Notes/storage.html" target="_blank" rel="external">blk-mq in RHEL 7.2</a></h3><p>It can improve performance by allowing certain device drivers to map I/O requests to multiple hardware or software queues.<br>If the dm_mod.use_blk_mq=y kernel option is specified. The default value is n (disabled).<br>It may be beneficial to set dm_mod.use_blk_mq=y if the underlying SCSI devices are also using blk-mq, as doing so reduces locking overhead at the DM layer.<br>To determine whether DM multipath is using blk-mq on a system, cat the file /sys/block/dm-X/dm/use_blk_mq, where dm-X is replaced by the DM multipath device of interest. This file is read-only and reflects what the global value in /sys/module/dm_mod/parameters/use_blk_mq was at the time the request-based DM multipath device was created.</p>
<p><a href="http://events.linuxfoundation.org/sites/events/files/slides/scsi.pdf" target="_blank" rel="external">High Performance Storage with blk-mq and scsi-mq</a><br><a href="http://events.linuxfoundation.org/sites/events/files/slides/Vault%20-%20scsi-mq%20v2.pdf" target="_blank" rel="external">Increasing SCSI LLD Driver Performance by Using the SCSI Multiqueue Approach</a><br><a href="https://www.thomas-krenn.com/en/wiki/Linux_Multi-Queue_Block_IO_Queueing_Mechanism_(blk-mq" target="_blank" rel="external">Linux Multi-Queue Block IO Queueing Mechanism</a>)<br><a href="http://chuansong.me/n/362178648541" target="_blank" rel="external">blk-mq SCSI performance</a></p>
]]></content>
      
        <categories>
            
            <category> Linux </category>
            
        </categories>
        
        
        <tags>
            
            <tag> blk-mq </tag>
            
            <tag> queue </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Hardware index]]></title>
      <url>http://yoursite.com/2016/12/22/Hardware-index/</url>
      <content type="html"><![CDATA[<h3 id="DAS"><a href="#DAS" class="headerlink" title="DAS"></a>DAS</h3><h4 id="Dual-nodes-redundance-SAS-link"><a href="#Dual-nodes-redundance-SAS-link" class="headerlink" title="Dual nodes, redundance SAS link"></a>Dual nodes, redundance SAS link</h4><h5 id="2U"><a href="#2U" class="headerlink" title="2U"></a>2U</h5><p><a href="https://www.supermicro.com/solutions/Lustre.cfm" target="_blank" rel="external">SSG-927R-E2CJB</a>, Lustre+openzfs 2U 24 2.5” Drive JBOD with shared redundant expander</p>
<table>
<thead>
<tr>
<th>Model</th>
<th>MEM</th>
<th>PCIE</th>
<th>socks</th>
<th>2.5HDD</th>
<th>3.5HDD</th>
<th>chip</th>
<th>io</th>
</tr>
</thead>
<tbody>
<tr>
<td>2028R-DE2CR24L</td>
<td>2x8</td>
<td>2x3</td>
<td>2</td>
<td>24</td>
<td>0</td>
<td>c612</td>
<td>X540+LSI 3008</td>
</tr>
<tr>
<td>SG-2028R-DE2CR24</td>
<td>2x8</td>
<td>2x3</td>
<td>2</td>
<td>24</td>
<td>0</td>
<td>c612</td>
<td>X540+LSI 3108</td>
</tr>
<tr>
<td>Inventec U90G3</td>
<td>16x2</td>
<td>2x3</td>
<td>2x2</td>
<td>4</td>
<td>70</td>
<td>c612</td>
<td>dual</td>
</tr>
<tr>
<td>HPE 4520</td>
<td>16x2</td>
<td>2x4</td>
<td>2x2</td>
<td>4</td>
<td>46</td>
<td>c612</td>
<td>dual</td>
</tr>
</tbody>
</table>
<h6 id="Supermicro-2028R-DE2CR24L"><a href="#Supermicro-2028R-DE2CR24L" class="headerlink" title="Supermicro 2028R-DE2CR24L"></a>Supermicro 2028R-DE2CR24L</h6><p><img src="https://www.supermicro.com/a_images/products/SuperServer/2U/SSG-2028R-DE2CR24L.jpg" alt=""></p>
<h5 id="4U-SBB"><a href="#4U-SBB" class="headerlink" title="4U (SBB)"></a>4U (SBB)</h5><table>
<thead>
<tr>
<th>Model</th>
<th>MEM</th>
<th>PCIE</th>
<th>socks</th>
<th>2.5HDD</th>
<th>3.5HDD</th>
<th>chip</th>
<th>io</th>
</tr>
</thead>
<tbody>
<tr>
<td>6048R-DE2CR24L</td>
<td>8x2</td>
<td>2x3</td>
<td>2x2</td>
<td>0</td>
<td>24</td>
<td>c612</td>
<td>dual+LSI3008</td>
</tr>
</tbody>
</table>
<h4 id="Single-node"><a href="#Single-node" class="headerlink" title="Single node"></a>Single node</h4><h5 id="1U"><a href="#1U" class="headerlink" title="1U"></a>1U</h5><table>
<thead>
<tr>
<th>Model</th>
<th>MEM</th>
<th>PCIE</th>
<th>socks</th>
<th>2.5HDD</th>
<th>3.5HDD</th>
<th>chip</th>
<th>io</th>
</tr>
</thead>
<tbody>
<tr>
<td>6017R-73HDP+</td>
<td>16</td>
<td>2</td>
<td>2</td>
<td>2(os)</td>
<td>12</td>
<td>c602</td>
<td>dual</td>
</tr>
<tr>
<td>1028R-WTR</td>
<td>16</td>
<td>2</td>
<td>2</td>
<td>10</td>
<td>0</td>
<td>c612</td>
<td>dual+Mezzanine HAB</td>
</tr>
<tr>
<td>SYS-1028U-E1CRTP+</td>
<td>24</td>
<td>3</td>
<td>2</td>
<td>10</td>
<td>0</td>
<td>c612</td>
<td>10GbE SFP and 1xinternal PCIE</td>
</tr>
<tr>
<td>Dell R630</td>
<td>24</td>
<td>3</td>
<td>2</td>
<td>10</td>
<td>0</td>
<td>c612</td>
<td>dual+Daughter card</td>
</tr>
</tbody>
</table>
<h6 id="Supermicro-6017R-73HDP"><a href="#Supermicro-6017R-73HDP" class="headerlink" title="Supermicro 6017R-73HDP+"></a>Supermicro 6017R-73HDP+</h6><p><img src="http://www.supermicro.com/a_images/products/SuperServer/1U/SYS-6017R-73THDP__Spec.jpg" alt=""></p>
<h5 id="2U-1"><a href="#2U-1" class="headerlink" title="2U"></a>2U</h5><p>6xPCI-Express 3+1xPCI-Express 2.0 x4 </p>
<ul>
<li><p>6028R-E1CR12N</p>
<ul>
<li>6xPCI-Express 3</li>
<li>1xPCI-Express 2</li>
<li>Lustre OSS</li>
</ul>
</li>
<li><p>6028R-E1CR24N</p>
<ul>
<li>24 x 3.5 inch</li>
<li>2 x 2.5 inch</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th>Model</th>
<th>MEM</th>
<th>PCIE</th>
<th>socks</th>
<th>2.5HDD</th>
<th>3.5HDD</th>
<th>chip</th>
<th>io</th>
</tr>
</thead>
<tbody>
<tr>
<td>6028R-E1CR12N</td>
<td>24</td>
<td>6+1</td>
<td>2</td>
<td>2</td>
<td>12</td>
<td>c612</td>
<td>4x10GbE BT+LSI 3108</td>
</tr>
<tr>
<td>6028R-E1CR16T</td>
<td>16</td>
<td>7</td>
<td>2</td>
<td>2</td>
<td>16</td>
<td>c612</td>
<td>2x10GbE+LSI 3108</td>
</tr>
<tr>
<td>6028R-E1CR24N</td>
<td>24</td>
<td>3</td>
<td>2</td>
<td>2</td>
<td>24</td>
<td>c612</td>
<td>SIOM flexible+LSI 3108</td>
</tr>
<tr>
<td>6028R-E1CR12L</td>
<td>16</td>
<td>7</td>
<td>2</td>
<td>2</td>
<td>12</td>
<td>c612</td>
<td>2xX540+LSI 3008</td>
</tr>
<tr>
<td>2028R-E1CR48N</td>
<td>24</td>
<td>3</td>
<td>2</td>
<td>48+2</td>
<td>0</td>
<td>c612</td>
<td>SIOM flexible+LSI 3108</td>
</tr>
<tr>
<td>2028R-E1CR48L</td>
<td>24</td>
<td>3</td>
<td>2</td>
<td>48+2</td>
<td>0</td>
<td>c612</td>
<td>SIOM flexible+LSI 3008</td>
</tr>
<tr>
<td>Dell R730xd</td>
<td>24</td>
<td>6</td>
<td>2</td>
<td>2</td>
<td>16</td>
<td>c610</td>
<td>daughter card+LSI 3008/3108</td>
</tr>
<tr>
<td>HP DL180G9</td>
<td>16</td>
<td>6</td>
<td>2</td>
<td>0</td>
<td>12</td>
<td>c610</td>
<td>flexible card</td>
</tr>
<tr>
<td>HP 4200 G9</td>
<td>16</td>
<td>6</td>
<td>2</td>
<td>54</td>
<td>28</td>
<td>c610</td>
<td>flexible card</td>
</tr>
</tbody>
</table>
<h5 id="Supermicro-6028R-E1CR12N-lustre-OSS"><a href="#Supermicro-6028R-E1CR12N-lustre-OSS" class="headerlink" title="Supermicro 6028R-E1CR12N (lustre OSS)"></a>Supermicro 6028R-E1CR12N (lustre OSS)</h5><p><img src="https://www.supermicro.com/a_images/products/superserver/2U/SSG-6028R-E1CR12N.jpg" alt=""></p>
<h5 id="Supermicro-6028R-E1CR16T"><a href="#Supermicro-6028R-E1CR16T" class="headerlink" title="Supermicro 6028R-E1CR16T"></a>Supermicro 6028R-E1CR16T</h5><p><img src="https://www.supermicro.com/a_images/products/superserver/2U/SSG-6028R-E1CR16T.jpg" alt=""></p>
<h5 id="Supermicro-6028R-E1CR24N"><a href="#Supermicro-6028R-E1CR24N" class="headerlink" title="Supermicro 6028R-E1CR24N"></a>Supermicro 6028R-E1CR24N</h5><p><img src="http://www.supermicro.com/a_images/products/superserver/2U/SSG-6028R-E1CR24N.jpg" alt=""></p>
<h5 id="4U"><a href="#4U" class="headerlink" title="4U"></a>4U</h5><h6 id="2-socket"><a href="#2-socket" class="headerlink" title="2 socket"></a>2 socket</h6><table>
<thead>
<tr>
<th>Model</th>
<th>MEM</th>
<th>PCIE</th>
<th>socks</th>
<th>2.5HDD</th>
<th>3.5HDD</th>
<th>chip</th>
<th>IO</th>
</tr>
</thead>
<tbody>
<tr>
<td>6048R-E1CR36L</td>
<td>8</td>
<td>4+2(2.0)</td>
<td>1</td>
<td>2</td>
<td>36</td>
<td>c612</td>
<td>4xi350+LSI 3008</td>
</tr>
<tr>
<td>6048R-E1CR36L</td>
<td>16</td>
<td>7</td>
<td>2</td>
<td>2</td>
<td>36</td>
<td>c612</td>
<td>x540+LSI 3008</td>
</tr>
<tr>
<td>6048R-E1CR36H</td>
<td>16</td>
<td>7</td>
<td>2</td>
<td>2</td>
<td>36</td>
<td>c612</td>
<td>x540+LSI 3108</td>
</tr>
<tr>
<td>6048R-E1CR60L</td>
<td>24</td>
<td>3</td>
<td>2</td>
<td>2</td>
<td>60</td>
<td>c612</td>
<td>1xLSI 3008</td>
</tr>
<tr>
<td>6048R-E1CR90L</td>
<td>8</td>
<td>1</td>
<td>2</td>
<td>2</td>
<td>90</td>
<td>c612</td>
<td>4x10GbE+2xLSI 3008</td>
</tr>
</tbody>
</table>
<h6 id="4-socket"><a href="#4-socket" class="headerlink" title="4 socket"></a>4 socket</h6><p>8048B-TR4FT 96 x 128G<br>8048B-TRFT 96 x 64G</p>
<table>
<thead>
<tr>
<th>Model</th>
<th>MEM</th>
<th>PCIE</th>
<th>socks</th>
<th>2.5HDD</th>
<th>3.5HDD</th>
<th>chip</th>
<th>IO</th>
</tr>
</thead>
<tbody>
<tr>
<td>8048B-TRFT</td>
<td>96</td>
<td>11</td>
<td>4</td>
<td>AHCI 2xSATA3</td>
<td>24</td>
<td>c602J</td>
<td>x540</td>
</tr>
<tr>
<td>4048B-TRFT</td>
<td>96</td>
<td>11</td>
<td>4</td>
<td>48 +AHCI 2xSATA3</td>
<td>0</td>
<td>c602J</td>
<td>x540</td>
</tr>
</tbody>
</table>
<h5 id="Supermicro-8048B-TRFT"><a href="#Supermicro-8048B-TRFT" class="headerlink" title="Supermicro 8048B-TRFT"></a>Supermicro 8048B-TRFT</h5><p><img src="https://www.supermicro.com/a_images/products/SuperServer/4U/SYS-8048B-TRFT.jpg" alt=""></p>
<h5 id="AHCI-SATA-DOM-x10-6Gb-SATA3"><a href="#AHCI-SATA-DOM-x10-6Gb-SATA3" class="headerlink" title="AHCI SATA DOM x10 6Gb SATA3"></a>AHCI SATA DOM x10 6Gb SATA3</h5><p><img src="https://www.supermicro.com/a_images/products/nfo/SATADOM_x10_connect.jpg" alt=""></p>
<h3 id="JBOD"><a href="#JBOD" class="headerlink" title="JBOD"></a>JBOD</h3><p>SSG-927R-E2CJB is a 2U JBOD</p>
<table>
<thead>
<tr>
<th>Model</th>
<th>H</th>
<th>H(mm)</th>
<th>W</th>
<th>Depth</th>
<th>Fans</th>
<th>3.5 slot</th>
<th>power(w)</th>
<th>Weight(max)</th>
<th>Interface</th>
</tr>
</thead>
<tbody>
<tr>
<td>946ED-R2KJBOD</td>
<td>4U</td>
<td>178</td>
<td>447</td>
<td>906</td>
<td>4+1</td>
<td>90</td>
<td>4x1000</td>
<td>102.06kg</td>
<td>SAS3 SFF-8644</td>
</tr>
<tr>
<td>HGST JBOD 4U60</td>
<td>4U</td>
<td>175</td>
<td>424</td>
<td>938</td>
<td>N+1</td>
<td>60</td>
<td>2x1650</td>
<td>89.81 kg</td>
<td>SAS3 SFF-8436</td>
</tr>
<tr>
<td>Dell MD1280</td>
<td>5U</td>
<td>223</td>
<td>483</td>
<td>915</td>
<td>N+1</td>
<td>84</td>
<td>2x2800</td>
<td>130.1 kg</td>
<td>SAS2 SFF-8088</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Model</th>
<th>Humidity</th>
<th>Random Vibration</th>
<th>Sinusoidal Vibration</th>
<th>Temperature Range</th>
</tr>
</thead>
<tbody>
<tr>
<td>946ED-R2KJBOD</td>
<td>8%-90%</td>
<td></td>
<td></td>
<td>5°C-35°C(air)40°C (helium)       </td>
</tr>
<tr>
<td>HGST JBOD 4U60</td>
<td>8%-80%</td>
<td>0.25Grms 5-10Hz</td>
<td>0.05 g, 10-300Hz</td>
<td>5°C-35°C(air)40°C (helium)</td>
</tr>
<tr>
<td>Dell MD1280</td>
<td>10%-80%</td>
<td></td>
<td>1.04 g,2-200Hz(max)</td>
<td>5°C-35°C(air)40°C (helium)</td>
</tr>
</tbody>
</table>
<h4 id="Supermicro-946ED-R2KJBOD"><a href="#Supermicro-946ED-R2KJBOD" class="headerlink" title="Supermicro 946ED-R2KJBOD"></a>Supermicro 946ED-R2KJBOD</h4><p><img src="https://cdn.shopify.com/s/files/1/1040/6656/files/CSE-946ED-R2KJBOD_large.jpg?12087391912493687778" alt=""></p>
<h4 id="SFF-8644"><a href="#SFF-8644" class="headerlink" title="SFF-8644"></a>SFF-8644</h4><p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/0e/SFF-8644.jpg/200px-SFF-8644.jpg" alt=""></p>
<h4 id="SFF-8436"><a href="#SFF-8436" class="headerlink" title="SFF-8436"></a>SFF-8436</h4><p><img src="http://img.thuexeminhanh.com/pic/z29cc701-200x200-1/40g_qsfp_sff_8436_to_qsfp_passive_copper_cable.jpg" alt=""></p>
<h4 id="SFF-8088"><a href="#SFF-8088" class="headerlink" title="SFF-8088"></a>SFF-8088</h4><p><img src="https://encrypted-tbn3.gstatic.com/images?q=tbn:ANd9GcSCbG7orrSXih0_w2CbkBAkXnk0tUwaojoyWQ9wltVwhIt0pUR9" alt=""></p>
<h3 id="SAS-HBA-and-Raid"><a href="#SAS-HBA-and-Raid" class="headerlink" title="SAS HBA and Raid"></a>SAS HBA and Raid</h3><h4 id="Raid"><a href="#Raid" class="headerlink" title="Raid"></a>Raid</h4><table>
<thead>
<tr>
<th>RAID</th>
<th>SAS chip</th>
<th>dell</th>
<th>Cache</th>
<th>SAS</th>
<th>SAS port</th>
</tr>
</thead>
<tbody>
<tr>
<td>9380-8e</td>
<td>LSI 3108</td>
<td>H830</td>
<td>2GB</td>
<td>2x4x12G</td>
<td>SFF-8644</td>
</tr>
<tr>
<td>9361-8i</td>
<td>LSI 3108</td>
<td>H730</td>
<td>1-2G</td>
<td>2x4x12G</td>
<td>SFF-8643</td>
</tr>
<tr>
<td>9341-8i</td>
<td>LSI 3008</td>
<td>H330</td>
<td>1GB</td>
<td>2x4x12G</td>
<td>SFF-8643</td>
</tr>
<tr>
<td>9260-8i</td>
<td>LSI 2108</td>
<td>none</td>
<td>0.5G</td>
<td>2x4x6G</td>
<td>SFF-8087</td>
</tr>
<tr>
<td>9260-8i</td>
<td>LSI 2208</td>
<td>H710</td>
<td>1GB</td>
<td>2x4x6G</td>
<td>SFF-8087</td>
</tr>
<tr>
<td>9286-8e</td>
<td>LSI 2208</td>
<td>H810</td>
<td>1GB</td>
<td>2x4x6G</td>
<td>SFF-8088</td>
</tr>
<tr>
<td>HP P244br</td>
<td>PMC</td>
<td></td>
<td>1GB</td>
<td>2x1x12G</td>
<td>SFF-8643</td>
</tr>
<tr>
<td>HP P440ar</td>
<td>PMC</td>
<td></td>
<td>2GB</td>
<td>2x4x12G</td>
<td>SFF-8643</td>
</tr>
<tr>
<td>HP P440</td>
<td>PMC</td>
<td></td>
<td>2GB</td>
<td>1x8x12G</td>
<td>SFF-8643</td>
</tr>
<tr>
<td>P431-8e</td>
<td>PMC</td>
<td></td>
<td>4GB</td>
<td>2x4x12G</td>
<td>SFF-8644</td>
</tr>
<tr>
<td>HP P441</td>
<td>PMC</td>
<td></td>
<td>4GB</td>
<td>2x4x12G</td>
<td>SFF-8643</td>
</tr>
<tr>
<td>P741m-8e</td>
<td>PMC</td>
<td></td>
<td>4GB</td>
<td>2x4x12G</td>
<td>SFF-8644</td>
</tr>
<tr>
<td>P841-8e</td>
<td>PMC</td>
<td></td>
<td>4GB</td>
<td>4x4x12G</td>
<td>SFF-8644</td>
</tr>
</tbody>
</table>
<h4 id="LSI-Fusion-MPT"><a href="#LSI-Fusion-MPT" class="headerlink" title="LSI Fusion-MPT"></a>LSI Fusion-MPT</h4><table>
<thead>
<tr>
<th>SAS chip</th>
<th>dell</th>
<th>LSI</th>
<th>SAS</th>
<th>SAS port</th>
<th>Power</th>
</tr>
</thead>
<tbody>
<tr>
<td>LSI 3008</td>
<td>HBA12i</td>
<td>9311-8i</td>
<td>3</td>
<td>SFF8643</td>
<td>14.5W</td>
</tr>
<tr>
<td>LSI 3008</td>
<td>HBA12e</td>
<td>9300-8e</td>
<td>3</td>
<td>SFF8644</td>
<td>14.5W</td>
</tr>
<tr>
<td>LSI 3216</td>
<td></td>
<td>9305-16e</td>
<td>3</td>
<td>SFF8644</td>
<td>13w</td>
</tr>
<tr>
<td>LSI3008x2</td>
<td></td>
<td>9302-16e</td>
<td>3</td>
<td>SFF8644</td>
<td>30W</td>
</tr>
<tr>
<td>LSI 3224</td>
<td></td>
<td>9305-24i</td>
<td>3</td>
<td>SFF8643</td>
<td>16.2w</td>
</tr>
<tr>
<td>LSI 3224</td>
<td></td>
<td>9305-24i</td>
<td>3</td>
<td>SFF8643</td>
<td>16.2w</td>
</tr>
<tr>
<td>LSI 2008</td>
<td>HBA6i</td>
<td>9211-8i</td>
<td>2</td>
<td>SFF8087</td>
<td>7w</td>
</tr>
<tr>
<td>LSI 2308</td>
<td>none</td>
<td>9207-8e</td>
<td>2</td>
<td>SFF8088</td>
<td>9.8w</td>
</tr>
<tr>
<td>LSI2008x2</td>
<td>none</td>
<td>9202-16e</td>
<td>2</td>
<td>SFF8088</td>
<td>9.8w</td>
</tr>
<tr>
<td>LSI2008x2</td>
<td>HBA6e</td>
<td>9200-8e</td>
<td>2</td>
<td>SFF8088</td>
</tr>
<tr>
<td>PMC</td>
<td></td>
<td>HP H220-8i</td>
<td>2</td>
<td>SFF8087</td>
</tr>
<tr>
<td>PMC</td>
<td></td>
<td>HP H221-8e</td>
<td>2</td>
<td>SFF8087</td>
</tr>
<tr>
<td>PMC</td>
<td></td>
<td>HP H240-8i</td>
<td>3</td>
<td>SFF8643</td>
</tr>
<tr>
<td>PMC</td>
<td></td>
<td>H240br-8i</td>
<td>3</td>
<td>SFF8643</td>
</tr>
<tr>
<td>PMC</td>
<td></td>
<td>H240br-8i</td>
<td>3</td>
<td>SFF8643</td>
</tr>
<tr>
<td>PMC</td>
<td></td>
<td>H241-8e</td>
<td>3</td>
<td>SFF8644</td>
</tr>
</tbody>
</table>
<h5 id="LSI-ARM-arch-SAS-SATA-NVME"><a href="#LSI-ARM-arch-SAS-SATA-NVME" class="headerlink" title="LSI ARM arch, SAS, SATA, NVME"></a>LSI ARM arch, SAS, SATA, NVME</h5><table>
<thead>
<tr>
<th>SAS chip</th>
<th>PCIE lanes</th>
<th>PCIE BW</th>
<th>SAS BW</th>
<th>CPU</th>
<th>DA</th>
<th>DA</th>
<th>PCIE devices</th>
</tr>
</thead>
<tbody>
<tr>
<td>LSI 3416</td>
<td>x8 G3</td>
<td>16GBps</td>
<td>19.2GBps</td>
<td>ARM A15 1.2G</td>
<td>2xSFF-8639</td>
<td>4xSFF-8680</td>
<td>16          </td>
</tr>
<tr>
<td>LSI 3408</td>
<td>x8 G3</td>
<td>8GBps</td>
<td>9.6GBps</td>
<td>ARM A15 1.2G</td>
<td>2xSFF-8639</td>
<td>4xSFF-8680</td>
<td>16          </td>
</tr>
</tbody>
</table>
<p>Why 3416 and 3408 have the same PCIE lanes (x8 ?)</p>
<ul>
<li>SFF-8639<ul>
<li>PCIE Gen3 1,2,4 lanes<ul>
<li>3.938 GB/s (if full-duplex, x2)</li>
</ul>
</li>
<li>SAS3 1,2,4 lanes<ul>
<li>4.8GB/s</li>
</ul>
</li>
</ul>
</li>
<li>SFF-8680<ul>
<li>SAS3 1,2 lanes<ul>
<li>2.4GB/s</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><a href="http://www.snia.org/sites/default/education/tutorials/2012/fall/solid/AnilVasudeva_NVMe_NextGen_SSD%20Interface-r1-nc1.pdf" target="_blank" rel="external">NVME interface</a></p>
<h4 id="LSI-SAS-Chip"><a href="#LSI-SAS-Chip" class="headerlink" title="LSI SAS Chip"></a>LSI SAS Chip</h4><ul>
<li>Fd (Full duplex)</li>
<li>BW (bandwidth)</li>
</ul>
<table>
<thead>
<tr>
<th>SAS chip</th>
<th>Power CPU</th>
<th>16xPCIE3 BW</th>
<th>SAS3 BW</th>
</tr>
</thead>
<tbody>
<tr>
<td>LSI 3008</td>
<td>PPC476 1.2G</td>
<td>16GB/s Fd</td>
<td>9.6GB/s Fd 8p</td>
</tr>
<tr>
<td>LSI 3108</td>
<td>Dual PPC476 1.2G</td>
<td>16GB/s Fd</td>
<td>9.6GB/s Fd 8p</td>
</tr>
<tr>
<td>LSI 3216</td>
<td>PPC476 1.2G</td>
<td>16GB/s Fd</td>
<td>19.2GB/s Fd 16p</td>
</tr>
<tr>
<td>LSI 3224</td>
<td>PPC476 1.2G</td>
<td>16GB/s Fd</td>
<td>28.8GB/s Fd 24p</td>
</tr>
<tr>
<td>LSI 2108</td>
<td>PPC440 800MHz</td>
<td>16GB/s Fd</td>
<td>4.8GB/s Fd 8p</td>
</tr>
<tr>
<td>LSI 2008</td>
<td>PPC440 533M</td>
<td>16GB/s Fd</td>
<td>4.8GB/s Fd 8p</td>
</tr>
<tr>
<td>LSI 2308</td>
<td>PPC440 800M</td>
<td>16GB/s Fd</td>
<td>4.8GB/s Fd 8p</td>
</tr>
<tr>
<td>LSI 2208</td>
<td>Dual PPC440 800M</td>
<td>16GB/s Fd</td>
<td>4.8GB/s Fd 8p</td>
</tr>
</tbody>
</table>
<h3 id="SSD"><a href="#SSD" class="headerlink" title="SSD"></a>SSD</h3><h4 id="SAS"><a href="#SAS" class="headerlink" title="SAS"></a>SAS</h4><table>
<thead>
<tr>
<th>Model</th>
<th>SIZE(TB)</th>
<th>DWPD (5y)</th>
<th>Nand</th>
<th>R/W(GB/s)</th>
<th>ios(k)</th>
<th>interface</th>
<th>UBER</th>
<th>MTBF</th>
</tr>
</thead>
<tbody>
<tr>
<td>SanDisk Optimus MAX</td>
<td>4</td>
<td>0.5</td>
<td>19nm emlc</td>
<td>0.4/0.4</td>
<td>85/11</td>
<td>6Gbps SAS</td>
<td>10^17</td>
<td>2.5M</td>
</tr>
<tr>
<td>SD Lightning Eco GenII</td>
<td>1.6</td>
<td>3</td>
<td>15nm emlc</td>
<td>0.98/0.6</td>
<td>195/81</td>
<td>12Gbps SAS</td>
<td>10^18</td>
<td>2.5M</td>
</tr>
<tr>
<td>SD Lightning Ultra GenII</td>
<td>0.8</td>
<td>25</td>
<td>15nm emlc</td>
<td>0.98/0.74</td>
<td>199/115</td>
<td>12Gbps SAS</td>
<td>10^19</td>
<td>2.5M</td>
</tr>
<tr>
<td>HGST Ultrastar SSD1600MR</td>
<td>1.9</td>
<td>2.6</td>
<td>emlc</td>
<td>1/0.7</td>
<td>130/30</td>
<td>12Gbps SAS</td>
<td>10^17</td>
<td>2.5M</td>
</tr>
<tr>
<td>HGST Ultrastar SS200</td>
<td>0.48-7.6</td>
<td>1</td>
<td>15nm emlc</td>
<td>1.8/1</td>
<td>250/37</td>
<td>12Gbps SAS</td>
<td>10^17</td>
<td>2.5M</td>
</tr>
<tr>
<td>HGST Ultrastar SS200</td>
<td>0.4-6.4</td>
<td>3</td>
<td>15nm emlc</td>
<td>1.8/1</td>
<td>250/86</td>
<td>12Gbps SAS</td>
<td>10^17</td>
<td>2.5M</td>
</tr>
<tr>
<td>HGST s842</td>
<td>2</td>
<td>14~40</td>
<td>emlc</td>
<td>0.53/0.38</td>
<td>84/28</td>
<td>6Gbps SAS</td>
<td></td>
<td>2M</td>
</tr>
<tr>
<td>1200.2 ST3840FM0003</td>
<td>3.8</td>
<td>3</td>
<td>15nm emlc</td>
<td>1.1/0.77</td>
<td>180/30</td>
<td>12Gbps SAS</td>
<td>10^17</td>
<td>2M</td>
</tr>
<tr>
<td>Samsung PM1635</td>
<td>1.6</td>
<td>3</td>
<td>TLC ?</td>
<td>0.94/0.79</td>
<td>190/50</td>
<td>12Gbps SAS</td>
<td>10^17</td>
<td>2.5M</td>
</tr>
</tbody>
</table>
<h4 id="SATA"><a href="#SATA" class="headerlink" title="SATA"></a>SATA</h4><p>Intel DC S3100 is good choice to install operating system</p>
<table>
<thead>
<tr>
<th>Model</th>
<th>SIZE(TB)</th>
<th>DWPD (5y)</th>
<th>Nand</th>
<th>R/W(GB/s)</th>
<th>ios(k)</th>
<th>interface</th>
<th>UBER</th>
<th>MTBF</th>
</tr>
</thead>
<tbody>
<tr>
<td>SD CloudSpeed Eco GenII</td>
<td>1.92</td>
<td>0.6</td>
<td>15nm emlc</td>
<td>0.53,0.46</td>
<td>75,14</td>
<td>6Gbps</td>
<td>10^18</td>
<td>2M</td>
</tr>
<tr>
<td>SD CloudSpeed Ultra GenII</td>
<td>1.6</td>
<td>1.8</td>
<td>15nm emlc</td>
<td>0.53,0.46</td>
<td>76,32</td>
<td>6Gbps</td>
<td>10^18</td>
<td>2M</td>
</tr>
<tr>
<td>Intel DC s3100</td>
<td>1</td>
<td>0.06</td>
<td>16nm tlc</td>
<td>0.50,0.11</td>
<td>59,3.9</td>
<td>6Gbps</td>
<td>10^16</td>
<td>1.6M</td>
</tr>
<tr>
<td>Intel DC s3100</td>
<td>0.48</td>
<td>0.84</td>
<td>16nm tlc</td>
<td>0.50,0.11</td>
<td>55,4.7</td>
<td>6Gbps</td>
<td>10^16</td>
<td>1.6M</td>
</tr>
<tr>
<td>Intel DC s3510</td>
<td>1.6</td>
<td>0.35</td>
<td>16nm emlc</td>
<td>0.50,0.43</td>
<td>65,15</td>
<td>6Gbps</td>
<td>10^17</td>
<td>2M</td>
</tr>
<tr>
<td>Intel DC s3520</td>
<td>1.6</td>
<td>0.35</td>
<td>16 3d emlc</td>
<td>0.45,0.38</td>
<td>67,17</td>
<td>6Gbps</td>
<td>10^17</td>
<td>2M</td>
</tr>
<tr>
<td>Intel DC s3610</td>
<td>1.6</td>
<td>3</td>
<td>20nm emlc</td>
<td>0.55,0.5</td>
<td>84,27</td>
<td>6Gbps</td>
<td>10^17</td>
<td>2M</td>
</tr>
<tr>
<td>Samsung PM863</td>
<td>3.8</td>
<td>0.78</td>
<td>3d TLC</td>
<td>0.55,0.5</td>
<td>99,18</td>
<td>6Gbps</td>
<td></td>
</tr>
<tr>
<td>Samsung SM863</td>
<td>3.8</td>
<td>3.5</td>
<td>3d MLC</td>
<td>0.52,0.48</td>
<td>97,29</td>
<td>6Gbps</td>
</tr>
</tbody>
</table>
<h3 id="Compute-node"><a href="#Compute-node" class="headerlink" title="Compute node"></a>Compute node</h3><p>SYS-4048B-TR4FT-EC028</p>
]]></content>
      
        <categories>
            
            <category> Hardware </category>
            
        </categories>
        
        
        <tags>
            
            <tag> raid </tag>
            
            <tag> hardware </tag>
            
            <tag> jbod </tag>
            
            <tag> das </tag>
            
            <tag> server </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Dump sparse file data segment]]></title>
      <url>http://yoursite.com/2016/12/18/dump-sparse-file-data-segment/</url>
      <content type="html"><![CDATA[<h3 id="Test-file"><a href="#Test-file" class="headerlink" title="Test file"></a>Test file</h3><p>ubuntu 16.04<br>ext4 file system<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ rm data-A</span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..1500&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span> &gt;&gt; data-A ; <span class="keyword">done</span></span><br><span class="line">$ filefrag -v data-A </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of data-A is 6394 (2 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:        0..       0:    3464588..   3464588:      1:            </span><br><span class="line">   1:        1..       1:          0..         0:      1:    3464589: last,unknown_loc,delalloc,eof</span><br><span class="line">$ dd <span class="keyword">if</span>=data-A of=data-A-1 bs=4096 count=1</span><br><span class="line">$ dd <span class="keyword">if</span>=data-A of=data-A-2 bs=4096 count=1 skip=1</span><br><span class="line">$ head data-A-2</span><br><span class="line">1</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ cat data-A-1 data-A-2 | md5sum</span><br><span class="line">30ef7f11d29b8ad47542e97ed9d2a398  -</span><br><span class="line">$ cat data-A | md5sum</span><br><span class="line">30ef7f11d29b8ad47542e97ed9d2a398  -</span><br></pre></td></tr></table></figure></p>
<h3 id="Test-sparse-file"><a href="#Test-sparse-file" class="headerlink" title="Test sparse file"></a>Test sparse file</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">$ rm ./data-A;<span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..1500&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span> &gt;&gt; data-A ; <span class="keyword">done</span></span><br><span class="line">$ filefrag -v data-A </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of data-A is 6393 (2 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:        0..       1:          0..         1:      2:             last,unknown_loc,delalloc,eof</span><br><span class="line">data-A: 1 extent found</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=<span class="built_in">test</span> bs=4096 count=0 seek=25 <span class="comment">#write 100K sparse file</span></span><br><span class="line">$ cat data-A &gt;&gt; <span class="built_in">test</span></span><br><span class="line">$ ls -lhs </span><br><span class="line">total 16K</span><br><span class="line">8.0K -rw-rw-r-- 1 homerl homerl 6.3K 12月 19 14:04 data-A</span><br><span class="line">8.0K -rw-rw-r-- 1 homerl homerl 107K 12月 19 14:06 <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">$ df -h / </span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda2       101G   35G   61G  37% /</span><br><span class="line"></span><br><span class="line">$ sudo dumpe2fs /dev/sda2 | grep -i <span class="string">"Block size"</span></span><br><span class="line">dumpe2fs 1.42.13 (17-May-2015)</span><br><span class="line">Block size:               4096</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ filefrag -v data-A </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of data-A is 6393 (2 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:        0..       1:    3713508..   3713509:      2:             last,eof</span><br><span class="line">data-A: 1 extent found</span><br><span class="line"></span><br><span class="line">$ sudo dd <span class="keyword">if</span>=/dev/sda2 of=<span class="built_in">test</span>-1 bs=4096 count=1 skip=3713508</span><br><span class="line">$ head <span class="built_in">test</span>-1 </span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line"></span><br><span class="line">$ tail <span class="built_in">test</span>-1</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">104</span><br><span class="line"></span><br><span class="line">$ cat <span class="built_in">test</span>-1 | md5sum</span><br><span class="line">27260c41d34d5a01f5fba073f9059a90  -</span><br><span class="line"></span><br><span class="line">$ filefrag -v <span class="built_in">test</span></span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of <span class="built_in">test</span> is 108793 (27 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:       25..      26:    3713510..   3713511:      2:             last,eof</span><br><span class="line"><span class="built_in">test</span>: 1 extent found</span><br><span class="line"></span><br><span class="line">$ sudo dd <span class="keyword">if</span>=/dev/sda2 of=<span class="built_in">test</span><span class="_">-s</span>-1 bs=4096 count=1 skip=3713510</span><br><span class="line"></span><br><span class="line">$ md5sum <span class="built_in">test</span>-*</span><br><span class="line">27260c41d34d5a01f5fba073f9059a90  <span class="built_in">test</span>-1</span><br><span class="line">27260c41d34d5a01f5fba073f9059a90  <span class="built_in">test</span><span class="_">-s</span>-1</span><br><span class="line"></span><br><span class="line">$ sudo dd <span class="keyword">if</span>=/dev/sda2 of=<span class="built_in">test</span><span class="_">-s</span>-2 bs=4096 count=1 skip=3713511</span><br><span class="line"></span><br><span class="line"><span class="comment"># the checksum difference between test-s-2 and test</span></span><br><span class="line">$ hexdump <span class="built_in">test</span><span class="_">-s</span>-2 | tail</span><br><span class="line">0000890 3431 3038 310a 3834 0a31 3431 3238 310a</span><br><span class="line">00008a0 3834 0a33 3431 3438 310a 3834 0a35 3431</span><br><span class="line">00008b0 3638 310a 3834 0a37 3431 3838 310a 3834</span><br><span class="line">00008c0 0a39 3431 3039 310a 3934 0a31 3431 3239</span><br><span class="line">00008d0 310a 3934 0a33 3431 3439 310a 3934 0a35</span><br><span class="line">00008e0 3431 3639 310a 3934 0a37 3431 3839 310a</span><br><span class="line">00008f0 3934 0a39 3531 3030 000a 0000 0000 0000</span><br><span class="line">0000900 0000 0000 0000 0000 0000 0000 0000 0000</span><br><span class="line">*</span><br><span class="line">0001000</span><br><span class="line"></span><br><span class="line">$ hexdump <span class="built_in">test</span> | tail</span><br><span class="line">001a870 0a33 3431 3437 310a 3734 0a35 3431 3637</span><br><span class="line">001a880 310a 3734 0a37 3431 3837 310a 3734 0a39</span><br><span class="line">001a890 3431 3038 310a 3834 0a31 3431 3238 310a</span><br><span class="line">001a8a0 3834 0a33 3431 3438 310a 3834 0a35 3431</span><br><span class="line">001a8b0 3638 310a 3834 0a37 3431 3838 310a 3834</span><br><span class="line">001a8c0 0a39 3431 3039 310a 3934 0a31 3431 3239</span><br><span class="line">001a8d0 310a 3934 0a33 3431 3439 310a 3934 0a35</span><br><span class="line">001a8e0 3431 3639 310a 3934 0a37 3431 3839 310a</span><br><span class="line">001a8f0 3934 0a39 3531 3030 000a               </span><br><span class="line">001a8f9</span><br></pre></td></tr></table></figure>
<p>There are some of zero fill in the file bottom.<br>astersik (*) !(means same as the line above)[<a href="http://superuser.com/questions/494245/what-does-an-asterisk-mean-in-hexdump-output" target="_blank" rel="external">http://superuser.com/questions/494245/what-does-an-asterisk-mean-in-hexdump-output</a>]</p>
<h3 id="dd-update"><a href="#dd-update" class="headerlink" title="dd update"></a>dd update</h3><p>operate single byte<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=data-A of=data-A-1Byte bs=1  count=1 ibs=1 obs=1</span><br><span class="line">$ dd <span class="keyword">if</span>=data-A of=data-A-skip-1byte bs=1  skip=2 count=1 ibs=1 obs=1 iflag=count_bytes iflag=skip_bytes</span><br><span class="line"></span><br><span class="line">$ ls -ls | grep -i by</span><br><span class="line"></span><br><span class="line"><span class="comment">#first column is KiB , 4 is 4KiB</span></span><br><span class="line"><span class="comment">#sixth column is byte , 1 byte</span></span><br><span class="line"></span><br><span class="line">  4 -rw-rw-r-- 1 homerl homerl      1 12月 19 15:23 data-A-1Byte</span><br><span class="line">  4 -rw-rw-r-- 1 homerl homerl      1 12月 19 15:22 data-A-skip-1byte</span><br><span class="line"></span><br><span class="line">$ cat data-A-1Byte</span><br><span class="line">1 $ cat data-A-skip-1byte</span><br><span class="line">2</span><br><span class="line"></span><br><span class="line">$ ls -ls <span class="built_in">test</span> data-A </span><br><span class="line">8 -rw-rw-r-- 1 homerl homerl   6393 12月 19 14:54 data-A</span><br><span class="line">8 -rw-rw-r-- 1 homerl homerl 108793 12月 19 15:30 <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">$  dd <span class="keyword">if</span>=<span class="built_in">test</span> of=<span class="built_in">test</span>-data bs=1 count=6393 skip=102400 iflag=skip_bytes ibs=1 obs=1</span><br><span class="line">$ $ sha1sum   data-A <span class="built_in">test</span>-data <span class="built_in">test</span></span><br><span class="line">8f8374832cb6536f580eef3b316ad08293a47617  data-A</span><br><span class="line">8f8374832cb6536f580eef3b316ad08293a47617  <span class="built_in">test</span>-data</span><br><span class="line">03e31af4c89c9003ee0f43e49a65ad2e24367024  <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line">$ hexdump data-A | tail</span><br><span class="line">0001870 0a33 3431 3437 310a 3734 0a35 3431 3637</span><br><span class="line">0001880 310a 3734 0a37 3431 3837 310a 3734 0a39</span><br><span class="line">0001890 3431 3038 310a 3834 0a31 3431 3238 310a</span><br><span class="line">00018a0 3834 0a33 3431 3438 310a 3834 0a35 3431</span><br><span class="line">00018b0 3638 310a 3834 0a37 3431 3838 310a 3834</span><br><span class="line">00018c0 0a39 3431 3039 310a 3934 0a31 3431 3239</span><br><span class="line">00018d0 310a 3934 0a33 3431 3439 310a 3934 0a35</span><br><span class="line">00018e0 3431 3639 310a 3934 0a37 3431 3839 310a</span><br><span class="line">00018f0 3934 0a39 3531 3030 000a               </span><br><span class="line">00018f9</span><br><span class="line">$ hexdump <span class="built_in">test</span>-data | tail</span><br><span class="line">0001870 0a33 3431 3437 310a 3734 0a35 3431 3637</span><br><span class="line">0001880 310a 3734 0a37 3431 3837 310a 3734 0a39</span><br><span class="line">0001890 3431 3038 310a 3834 0a31 3431 3238 310a</span><br><span class="line">00018a0 3834 0a33 3431 3438 310a 3834 0a35 3431</span><br><span class="line">00018b0 3638 310a 3834 0a37 3431 3838 310a 3834</span><br><span class="line">00018c0 0a39 3431 3039 310a 3934 0a31 3431 3239</span><br><span class="line">00018d0 310a 3934 0a33 3431 3439 310a 3934 0a35</span><br><span class="line">00018e0 3431 3639 310a 3934 0a37 3431 3839 310a</span><br><span class="line">00018f0 3934 0a39 3531 3030 000a               </span><br><span class="line">00018f9</span><br><span class="line">$ hexdump <span class="built_in">test</span> | tail</span><br><span class="line">001a870 0a33 3431 3437 310a 3734 0a35 3431 3637</span><br><span class="line">001a880 310a 3734 0a37 3431 3837 310a 3734 0a39</span><br><span class="line">001a890 3431 3038 310a 3834 0a31 3431 3238 310a</span><br><span class="line">001a8a0 3834 0a33 3431 3438 310a 3834 0a35 3431</span><br><span class="line">001a8b0 3638 310a 3834 0a37 3431 3838 310a 3834</span><br><span class="line">001a8c0 0a39 3431 3039 310a 3934 0a31 3431 3239</span><br><span class="line">001a8d0 310a 3934 0a33 3431 3439 310a 3934 0a35</span><br><span class="line">001a8e0 3431 3639 310a 3934 0a37 3431 3839 310a</span><br><span class="line">001a8f0 3934 0a39 3531 3030 000a               </span><br><span class="line">001a8f9</span><br></pre></td></tr></table></figure></p>
<h3 id="Expand-sparse-file"><a href="#Expand-sparse-file" class="headerlink" title="Expand sparse file"></a>Expand sparse file</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ truncate <span class="_">-s</span> +256 <span class="built_in">test</span>_bak</span><br><span class="line">$ ls -ls  <span class="built_in">test</span>_bak </span><br><span class="line">108 -rw-rw-r-- 1 homerl homerl 109049 12月 19 16:36 <span class="built_in">test</span>_bak</span><br><span class="line">$ ls -ls  <span class="built_in">test</span></span><br><span class="line">8 -rw-rw-r-- 1 homerl homerl 108793 12月 19 15:30 <span class="built_in">test</span></span><br><span class="line">$ <span class="built_in">echo</span> $((109049-108793))</span><br><span class="line">256</span><br><span class="line"></span><br><span class="line"><span class="comment"># not sparse</span></span><br><span class="line"><span class="variable">$fallocate</span> -o 1M <span class="_">-l</span> 1M 1M-file</span><br></pre></td></tr></table></figure>
<h3 id="About-fallocate"><a href="#About-fallocate" class="headerlink" title="About fallocate"></a>About <a href="https://pelican.craoc.fr/sparse-file.html" target="_blank" rel="external">fallocate</a></h3><h4 id="collapse-range"><a href="#collapse-range" class="headerlink" title="collapse-range"></a>collapse-range</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">$ rm <span class="built_in">test</span>;<span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..60000&#125;; <span class="keyword">do</span> <span class="built_in">echo</span> <span class="variable">$i</span> &gt;&gt; <span class="built_in">test</span>; <span class="keyword">done</span></span><br><span class="line">$ ls -ls <span class="built_in">test</span></span><br><span class="line">344 -rw-rw-r-- 1 homerl homerl 348896 12月 19 17:03 <span class="built_in">test</span></span><br><span class="line">$ cp <span class="built_in">test</span> <span class="built_in">test</span>2</span><br><span class="line">$ fallocate --collapse-range --offset 4096 --length 8192  <span class="built_in">test</span>2 <span class="comment"># From 4096, delete length from 4096 delete 8192 length bytes</span></span><br><span class="line">$ dd <span class="keyword">if</span>=<span class="built_in">test</span> of=<span class="built_in">test</span>-dd-4096-8192 bs=4096 count=2 skip=4096 iflag=skip_bytes <span class="comment"># make sure delete length</span></span><br><span class="line"></span><br><span class="line">head <span class="built_in">test</span>-dd-4096-8192 </span><br><span class="line">041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line"></span><br><span class="line">$ tail <span class="built_in">test</span>-dd-4096-8192</span><br><span class="line">2670</span><br><span class="line">2671</span><br><span class="line">2672</span><br><span class="line">2673</span><br><span class="line">2674</span><br><span class="line">2675</span><br><span class="line">2676</span><br><span class="line">2677</span><br><span class="line">2678</span><br><span class="line">267</span><br><span class="line"></span><br><span class="line">$ head -n 1045 <span class="built_in">test</span>2 | tail</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">19   <span class="comment"># 1 041 and 267 9</span></span><br><span class="line">2680</span><br><span class="line">2681</span><br><span class="line">2682</span><br><span class="line"></span><br><span class="line"><span class="comment"># test in sparse file</span></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=<span class="built_in">test</span>-sparse bs=1M count=0 seek=1</span><br><span class="line">$ ls -lsh</span><br><span class="line">total 344K</span><br><span class="line">344K -rw-rw-r-- 1 homerl homerl 341K 12月 19 17:03 <span class="built_in">test</span></span><br><span class="line">   0 -rw-rw-r-- 1 homerl homerl 1.0M 12月 19 17:23 <span class="built_in">test</span>-sparse</span><br><span class="line">$ cat <span class="built_in">test</span> &gt;&gt; <span class="built_in">test</span>-sparse</span><br><span class="line">$ ls -ls</span><br><span class="line">total 688</span><br><span class="line">344 -rw-rw-r-- 1 homerl homerl  348896 12月 19 17:03 <span class="built_in">test</span></span><br><span class="line">344 -rw-rw-r-- 1 homerl homerl 1397472 12月 19 17:23 <span class="built_in">test</span>-sparse</span><br><span class="line"></span><br><span class="line">$ fallocate --collapse-range --offset 4096 --length 8192 <span class="built_in">test</span>-sparse </span><br><span class="line">$ ls -ls</span><br><span class="line">total 688</span><br><span class="line">344 -rw-rw-r-- 1 homerl homerl  348896 12月 19 17:03 <span class="built_in">test</span></span><br><span class="line">344 -rw-rw-r-- 1 homerl homerl 1389280 12月 19 17:24 <span class="built_in">test</span>-sparse</span><br><span class="line"></span><br><span class="line">$ filefrag -v <span class="built_in">test</span>-sparse </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of <span class="built_in">test</span>-sparse is 1397472 (342 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:      254..     341:    3803866..   3803953:     88:             last,eof</span><br><span class="line"></span><br><span class="line">$ filefrag -v <span class="built_in">test</span>-sparse </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of <span class="built_in">test</span>-sparse is 1389280 (340 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:      252..     339:    3803866..   3803953:     88:             last,eof</span><br><span class="line"><span class="built_in">test</span>-sparse: 1 extent found</span><br></pre></td></tr></table></figure>
<h4 id="zero-range"><a href="#zero-range" class="headerlink" title="zero-range"></a>zero-range</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">$ cp  <span class="built_in">test</span> <span class="built_in">test</span>-sparse </span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=<span class="built_in">test</span>-sparse bs=1M count=0 seek=1</span><br><span class="line">0+0 records <span class="keyword">in</span></span><br><span class="line">0+0 records out</span><br><span class="line">0 bytes copied, 0.000132755 s, 0.0 kB/s</span><br><span class="line">1d [homerl:/tmp/<span class="built_in">test</span>/<span class="built_in">test</span>2] 130 $ filefrag -v <span class="built_in">test</span>-sparse </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of <span class="built_in">test</span>-sparse is 1048576 (256 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:        0..       2:     589896..    589898:      3:             last,unwritten</span><br><span class="line"><span class="built_in">test</span>-sparse: 1 extent found</span><br><span class="line">1d [homerl:/tmp/<span class="built_in">test</span>/<span class="built_in">test</span>2] $ cat <span class="built_in">test</span> &gt;&gt; <span class="built_in">test</span>-sparse </span><br><span class="line">1d [homerl:/tmp/<span class="built_in">test</span>/<span class="built_in">test</span>2] $ filefrag -v <span class="built_in">test</span>-sparse </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of <span class="built_in">test</span>-sparse is 1397472 (342 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:        0..       2:     589896..    589898:      3:             unwritten</span><br><span class="line">   1:      256..     341:          0..        85:     86:     589899: last,unknown_loc,delalloc,eof</span><br><span class="line"><span class="built_in">test</span>-sparse: 2 extents found</span><br><span class="line">$  head <span class="built_in">test</span>-sparse </span><br><span class="line">0</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line"></span><br><span class="line">$ fallocate --zero-range --offset 1048576 --length 128 <span class="built_in">test</span>-sparse </span><br><span class="line">$ head <span class="built_in">test</span>-sparse </span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line"></span><br><span class="line">$ fallocate --zero-range --offset 1048576 --length 348896  <span class="built_in">test</span>-sparse</span><br><span class="line"><span class="comment"># clear all</span></span><br></pre></td></tr></table></figure>
<h4 id="punch-hole"><a href="#punch-hole" class="headerlink" title="punch-hole"></a>punch-hole</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ cat <span class="built_in">test</span> &gt;&gt; <span class="built_in">test</span>-sparse </span><br><span class="line">$ filefrag -v <span class="built_in">test</span>-sparse </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of <span class="built_in">test</span>-sparse is 1397472 (342 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:      256..     341:          0..        85:     86:             last,unknown_loc,delalloc,eof</span><br><span class="line"><span class="built_in">test</span>-sparse: 1 extent found</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="variable">$cat</span> <span class="built_in">test</span> &gt;&gt; <span class="built_in">test</span>-sparse </span><br><span class="line">1d [homerl:/tmp/<span class="built_in">test</span>/<span class="built_in">test</span>2] $ ls -ls</span><br><span class="line">total 688</span><br><span class="line">344 -rw-rw-r-- 1 homerl homerl  348896 12月 19 17:29 <span class="built_in">test</span></span><br><span class="line">344 -rw-rw-r-- 1 homerl homerl 1397472 12月 19 17:53 <span class="built_in">test</span>-sparse</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">echo</span> ((4096*256)=1048576 ;((4096*84))=344064</span><br><span class="line"></span><br><span class="line"><span class="variable">$fallocate</span> --punch-hole --offset 1048576 --length 344064  <span class="built_in">test</span>-sparse </span><br><span class="line">1d [homerl:/tmp/<span class="built_in">test</span>/<span class="built_in">test</span>2] $ filefrag -v <span class="built_in">test</span>-sparse </span><br><span class="line">Filesystem <span class="built_in">type</span> is: ef53</span><br><span class="line">File size of <span class="built_in">test</span>-sparse is 1397472 (342 blocks of 4096 bytes)</span><br><span class="line"> ext:     logical_offset:        physical_offset: length:   expected: flags:</span><br><span class="line">   0:      340..     341:    3802396..   3802397:      2:             last,eof</span><br><span class="line"><span class="built_in">test</span>-sparse: 1 extent found</span><br><span class="line"></span><br><span class="line">1d [homerl:/tmp/<span class="built_in">test</span>/<span class="built_in">test</span>2] $ ls -ls <span class="built_in">test</span>-sparse </span><br><span class="line">8 -rw-rw-r-- 1 homerl homerl 1397472 12月 19 17:54 <span class="built_in">test</span>-sparse</span><br><span class="line"></span><br><span class="line"><span class="comment"># space has recycled</span></span><br></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> file </category>
            
        </categories>
        
        
        <tags>
            
            <tag> sparse file </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Ping test in serial link]]></title>
      <url>http://yoursite.com/2016/12/05/Ping-test-in-serial-link/</url>
      <content type="html"><![CDATA[<h3 id="Calculate-upload-download-speed-by-ping"><a href="#Calculate-upload-download-speed-by-ping" class="headerlink" title="Calculate upload/download speed by ping"></a><a href="http://stackoverflow.com/questions/4575537/calculate-upload-download-speed-by-ping" target="_blank" rel="external">Calculate upload/download speed by ping</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ping <span class="_">-f</span> -c 10000 <span class="_">-s</span> 1472 10.100.100.100</span><br></pre></td></tr></table></figure>
<p>At the end of the result i get: round-trip min/avg/max/stddev = 0.174/0.219/2.078/0.020 ms<br>so in average it takes 0.219 ms to send 1500 bytes and receive 1500 bytes, that’s 24 kb. 24 kb / 0.219 ms = 110 Mb/s<br>If you want to use that to a server on the internet, you need to lower the packet size to something like 1464 (for MTU 1492), drop the -f option and lower the count so it won’t take too long to finish.</p>
<p>1500 TX Bytes + 1500 RX Bytes= 3000 Bytes = 3000 * 8 = 24000 bits<br>24000 / 0.219 = 109.589 Mb/s</p>
<p>It ‘s not represent full throughput. just test single link in your ethernet adapter. not parallel.</p>
<h3 id="MTU-problem-check"><a href="#MTU-problem-check" class="headerlink" title="MTU problem check"></a>MTU problem check</h3><p>Level 3 network, between 2 nodes pass through gateway<br>Tcpdump show some packets loss, nmap show 10.xx.xx.clent port is “open”.<br>There are some packages return, some will not. Does it MTU problem ? ping could check it.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ traceroute 10.xx.xx.client</span><br><span class="line">traceroute to 10.xx.xx.client (10.xx.xx.client), 30 hops max, 60 byte packets</span><br><span class="line"> 1  10.10.xx.gateway (10.10.xx.gateway)  2.239 ms  1.901 ms  2.080 ms</span><br><span class="line"> 2  10.xx.xx.client (10.xx.xx.client)  0.606 ms  0.584 ms  0.592 ms</span><br><span class="line">$ traceroute 10.xx.xx.client</span><br><span class="line">traceroute to 10.xx.xx.client (10.xx.xx.client), 30 hops max, 60 byte packets</span><br><span class="line"> 1  10.10.xx.gateway (10.10.xx.gateway)  1.881 ms  2.085 ms  2.245 ms</span><br><span class="line"> 2  10.xx.xx.client (10.xx.xx.client)  0.563 ms * *</span><br><span class="line"></span><br><span class="line">$ ping <span class="_">-f</span> -c 20000 -M <span class="keyword">do</span> <span class="_">-s</span> 8972 10.xx.xx.client</span><br><span class="line">PING 10.xx.xx.client (10.xx.xx.client) 8972(9000) bytes of data.</span><br><span class="line">...................................................................^C</span><br><span class="line">--- 10.xx.xx.client ping statistics ---</span><br><span class="line">67 packets transmitted, 0 received, 100% packet loss, time 1076ms</span><br></pre></td></tr></table></figure></p>
<p>You can got the issue from tcpdump, all larger than 1500 packets are loss.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">client <span class="comment"># tcpdump -v host 10.53.19.52 and greater 1500</span></span><br><span class="line">tcpdump: listening on bond0, link-type EN10MB (Ethernet), capture size 65535 bytes</span><br><span class="line">11:23:58.134708 IP (tos 0x0, ttl 63, id 27071, offset 0, flags [DF], proto TCP (6), length 8532)</span><br><span class="line">    10.53.19.52.988 &gt; <span class="built_in">test</span>-57-21.exp2: Flags [P.], cksum 0x496d (incorrect -&gt; 0x5fe6), seq 2359537411:2359545891, ack 3804990367, win 53, options [nop,nop,TS val 1203816317 ecr 81802289], length 8480</span><br><span class="line">11:23:58.136045 IP (tos 0x0, ttl 63, id 27077, offset 0, flags [DF], proto TCP (6), length 7292)</span><br><span class="line">    10.53.19.52.988 &gt; <span class="built_in">test</span>-57-21.exp2: Flags [.], cksum 0x4495 (incorrect -&gt; 0xe386), seq 8480:15720, ack 1, win 53, options [nop,nop,TS val 1203816318 ecr 81802294], length 7240</span><br><span class="line">11:23:58.148023 IP (tos 0x0, ttl 63, id 27083, offset 0, flags [DF], proto TCP (6), length 8588)</span><br><span class="line">    10.53.19.52.988 &gt; <span class="built_in">test</span>-57-21.exp2: Flags [P.], cksum 0x49a5 (incorrect -&gt; 0x4006), seq 17016:25552, ack 1, win 53, options [nop,nop,TS val 1203816330 ecr 81802295], length 8536</span><br></pre></td></tr></table></figure>
<p>If client MTU is 1500, tcpdump(client) will not receive any large packages. they are loss in switch.</p>
]]></content>
      
        <categories>
            
            <category> network </category>
            
        </categories>
        
        
        <tags>
            
            <tag> net </tag>
            
            <tag> ethernet </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Record and Replay Linux Terminal]]></title>
      <url>http://yoursite.com/2016/12/01/Record-and-Replay-Linux-Terminal/</url>
      <content type="html"><![CDATA[<h3 id="script-and-scriptreplay"><a href="#script-and-scriptreplay" class="headerlink" title="script and scriptreplay"></a>script and scriptreplay</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ script --timing=time.txt script.log</span><br><span class="line"><span class="comment"># record what you do</span></span><br><span class="line">$ <span class="built_in">exit</span></span><br><span class="line">$ scriptreplay --timing=time.txt script.log</span><br><span class="line"><span class="comment"># replay</span></span><br></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Tools </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> terminal </tag>
            
            <tag> record </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[kcptun_and_shadowsocks]]></title>
      <url>http://yoursite.com/2016/09/04/kcptun-and-shadowsocks/</url>
      <content type="html"><![CDATA[<h3 id="Server-Parameters"><a href="#Server-Parameters" class="headerlink" title="Server Parameters"></a>Server Parameters</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su <span class="_">-s</span> /bin/bash nobody -c <span class="string">'./server_linux_amd64 -l "vps_ip:kcptun_port" -t "serer_ip:shadowsocks_port" -key yourkeyfile -mode fast2 --crypt aes-128 --datashard 10 --parityshard 3'</span></span><br></pre></td></tr></table></figure>
<h3 id="Client-Parameters"><a href="#Client-Parameters" class="headerlink" title="Client Parameters"></a>Client Parameters</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./client_linux_amd64 -r <span class="string">"vps_ip:kcptun_port"</span> <span class="_">-l</span> <span class="string">":kcptun_client_port"</span> -key yourkeyfile -mode fast2 --crypt aes-128 --datashard 10 --parityshard 3</span><br></pre></td></tr></table></figure>
<h3 id="Modify-shadowsocks-config"><a href="#Modify-shadowsocks-config" class="headerlink" title="Modify shadowsocks config"></a>Modify shadowsocks config</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">"server":"127.0.0.1",</span><br><span class="line">"server_port":kcptun_client_port,</span><br></pre></td></tr></table></figure>
<p>Browser proxy setting no changed (local port of shadowsocks client)</p>
<h3 id="Some-of-issues"><a href="#Some-of-issues" class="headerlink" title="Some of issues"></a>Some of issues</h3><p>There is no “localhost/127.0.0.1” in openvz envirnoment, you need replace it by ip address</p>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> shadowsocks </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Advance reformat 4Kn HDD to 512 Bytes]]></title>
      <url>http://yoursite.com/2016/08/10/Advance-reformat-4Kn-HDD-to-512-Bytes/</url>
      <content type="html"><![CDATA[<h3 id="4Kn-HDD-to-512-Bytes-sectora"><a href="#4Kn-HDD-to-512-Bytes-sectora" class="headerlink" title="4Kn HDD to 512 Bytes sectora"></a>4Kn HDD to 512 Bytes sectora</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ smartctl <span class="_">-a</span> <span class="_">-d</span> scsi /dev/sdd</span><br><span class="line">smartctl 5.43 2012-06-30 r3573 [x86_64-linux-2.6.32-504.30.3.el6_lustre.x86_64] (<span class="built_in">local</span> build)</span><br><span class="line">Copyright (C) 2002-12 by Bruce Allen, http://smartmontools.sourceforge.net</span><br><span class="line"></span><br><span class="line">Vendor:               HGST    </span><br><span class="line">Product:              HUH728080AL4200 </span><br><span class="line">Revision:             A7J0</span><br><span class="line">User Capacity:        8,001,563,222,016 bytes [8.00 TB]</span><br><span class="line">Logical block size:   4096 bytes</span><br><span class="line"></span><br><span class="line">$ smartctl <span class="_">-a</span> <span class="_">-d</span> scsi /dev/sdc</span><br><span class="line">smartctl 5.43 2012-06-30 r3573 [x86_64-linux-2.6.32-504.30.3.el6_lustre.x86_64] (<span class="built_in">local</span> build)</span><br><span class="line">Copyright (C) 2002-12 by Bruce Allen, http://smartmontools.sourceforge.net</span><br><span class="line"></span><br><span class="line">Vendor:               HGST    </span><br><span class="line">Product:              HUH728080AL4200 </span><br><span class="line">Revision:             A7J0</span><br><span class="line">User Capacity:        8,001,563,222,016 bytes [8.00 TB]</span><br><span class="line">Logical block size:   512 bytes</span><br></pre></td></tr></table></figure>
<h4 id="sg3-utils-format"><a href="#sg3-utils-format" class="headerlink" title="sg3_utils format"></a>sg3_utils format</h4><p>Update: If you have a lot of drives to format, it may take a long time with sg_format as it wait until it finished before doing the next one (with a while loop I mean). Useful tip is to use the “-e” flag with sg_format then monitor operations with sg_turs -p but it may hang you tty as well.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ sg_format --format --size=512 /dev/sdc</span><br><span class="line">HGST      HUH728080AL4200   A7J0   peripheral_<span class="built_in">type</span>: disk [0x0]</span><br><span class="line">&lt;&lt; supports protection information&gt;&gt;</span><br><span class="line">Mode Sense (block descriptor) data, prior to changes:</span><br><span class="line">  Number of blocks=1953506646 [0x74702556]</span><br><span class="line">  Block size=4096 [0x1000]</span><br><span class="line"></span><br><span class="line">A FORMAT will commence <span class="keyword">in</span> 10 seconds</span><br><span class="line">    ALL data on /dev/sdc will be DESTROYED</span><br><span class="line">        Press control-C to abort</span><br><span class="line">A FORMAT will commence <span class="keyword">in</span> 5 seconds</span><br><span class="line">    ALL data on /dev/sdc will be DESTROYED</span><br><span class="line">        Press control-C to abort</span><br><span class="line"></span><br><span class="line">Format has started</span><br><span class="line">FORMAT Complete</span><br></pre></td></tr></table></figure>
<p>It ‘s not complete,  just backend operate<br>sdparm ,smartctl, /sys could not access the device, when format complete, it’s ok.</p>
<h4 id="Read-cap"><a href="#Read-cap" class="headerlink" title="Read cap"></a>Read cap</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ sg_readcap <span class="_">-l</span> /dev/sdc</span><br><span class="line">Read Capacity results:</span><br><span class="line">   Protection: prot_en=0, p_<span class="built_in">type</span>=0, p_i_exponent=0</span><br><span class="line">   Thin provisioning: tpe=0, tprz=0</span><br><span class="line">   Last logical block address=15628053167 (0x3a3812aaf), Number of logical blocks=15628053168</span><br><span class="line">   Logical block length=512 bytes</span><br><span class="line">   Logical blocks per physical block exponent=3</span><br><span class="line">   Lowest aligned logical block address=0</span><br><span class="line">Hence:</span><br><span class="line">   Device size: 8001563222016 bytes, 7630885.3 MiB, 8001.56 GB</span><br></pre></td></tr></table></figure>
<h4 id="Get-HDD-status"><a href="#Get-HDD-status" class="headerlink" title="Get HDD status"></a>Get HDD status</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sg_turs -v /dev/sdb</span><br><span class="line">   <span class="built_in">test</span> unit ready cdb: 00 00 00 00 00 00 </span><br><span class="line">   <span class="built_in">test</span> unit ready:  Descriptor format, current;  Sense key: Not Ready Additional sense: Logical unit not ready, format <span class="keyword">in</span> progress  </span><br><span class="line">   Descriptor <span class="built_in">type</span>: Information    00 00 00 00 00 00 00 00 00 00</span><br><span class="line">   Descriptor <span class="built_in">type</span>: Command specific    0x0000000000000000</span><br><span class="line">   device not ready</span><br></pre></td></tr></table></figure>
<p>After 18 hours, format finish , I ‘m not sure what time it complete.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ cat /sys/class/block/sdc/queue/hw_sector_size </span><br><span class="line">512</span><br><span class="line"></span><br><span class="line">$ cat /sys/class/block/sdd/queue/hw_sector_size </span><br><span class="line">4096</span><br></pre></td></tr></table></figure>
<h4 id="Security-erasing-SAS-SATA-SSD"><a href="#Security-erasing-SAS-SATA-SSD" class="headerlink" title="Security erasing SAS/SATA SSD"></a>Security erasing SAS/SATA SSD</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sg_format --format /dev/sdx</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdparm --user-master u --security-set-pass password /dev/sdx</span><br></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Hardware </category>
            
        </categories>
        
        
        <tags>
            
            <tag> hdd </tag>
            
            <tag> ssd </tag>
            
            <tag> sas </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Calculate HDD SSD fault ratio]]></title>
      <url>http://yoursite.com/2016/07/20/Calculate_HDD_SSD_fault_ratio/</url>
      <content type="html"><![CDATA[<h3 id="2017-update"><a href="#2017-update" class="headerlink" title="2017 update"></a>2017 update</h3><p>First year failure four HDD at the same time,single HDD fault rate 0.01<br>Third year failure four HDD at the same time,single HDD fault rate 0.03<br>Fifth year failure four HDD at the same time,single HDD fault rate 0.05</p>
<p>In third year, Raidz3 broken four HDD at the same time<br>$ awk ‘BEGIN{printf “%.12f\n”, 1-(480/(365*24/0.03)+0.03)^4}’<br>0.999998997334</p>
<p>Real MTBF<br>$ awk ‘BEGIN{printf “%.10f\n”, 365*24/0.03}’<br>292000.0000000000</p>
<p><a href="http://wintelguy.com/raidmttdl.pl" target="_blank" rel="external">RAID Reliability Calculator</a></p>
<p><a href="http://evadman.blogspot.com/2010/08/raid-array-failure-probabilities.html?showComment=1337533818123#c7465506102422346169" target="_blank" rel="external">The article</a><br>It ‘s said<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">You&apos;ve got your probabilities wrong. Probability of failure of RAID 0, 5 and 6 is easily calculated using the binomial probability distribution. Note that because URE during rebuild may be perceived as a disk failure by some hardware/software RAIDs, the probability of an array failing is even higher. So the following probabilities assume no UREs, implying that they are the lowest possible probabilities of failure for a given array. </span><br><span class="line"></span><br><span class="line">If the probability of any single drive failing = p, array size (i.e. no. of disks) = n, and number of drives that fail simultaneously = X, then:</span><br><span class="line">Pr(X) = (n&quot;COMBINATION&quot;X) * (p)^X * (1-p)^(n-X)</span><br><span class="line">For p=0.03, n=4 we have</span><br><span class="line">Pr(X) = (4&quot;COMBINATION&quot;X) * 0.03^X * 0.97^(4-X)</span><br><span class="line">So: X 0 1 2 3 4</span><br><span class="line">Pr(X) 0.88529281 0.10952076 0.00508086 0.00010476 0.00000081</span><br><span class="line">For RAID 0, the array fails when X&gt;=1, so Pr(RAID0 failure) = 0.10952076 + 0.00508086 + 0.00010476 + 0.00000081 = 0.11470719 ~ 1 in 9.</span><br><span class="line">For RAID 5, the array fails when X&gt;=2, so Pr(RAID5 failure) = 0.00508086 + 0.00010476 + 0.00000081 = 0.00518643 ~ 1 in 193.</span><br><span class="line">For RAID 6, the array fails when X&gt;=3, so Pr(RAID6 failure) = 0.00010476 + 0.00000081 = 0.00010557 ~ 1 in 9472.</span><br><span class="line">So for an array 4 disks in size, 1/9 RAID 0 arrays fail, 1/193 RAID 5 arrays fail, and 1/9472 RAID 6 arrays fail. </span><br><span class="line">Similarly, for an array 6 disks in size, 1/6 RAID 0 arrays fail, 1/80 RAID 5 arrays fail, and 1/1982 RAID 6 arrays fail.</span><br><span class="line">Also, for an array 24 disks in size, 1/2 RAID 0 arrays fail, 1/6 RAID 5 arrays fail, and 1/29 RAID 6 arrays fail.</span><br><span class="line"></span><br><span class="line">Every year %3 failure rate, 0.03 ,I think it &apos;s contains URE ratio.</span><br><span class="line">2 HDD</span><br><span class="line">$ awk &apos;BEGIN&#123;printf &quot;%.20f\n&quot;, 11*0.03^2*0.97^(9)&#125;&apos;</span><br><span class="line">0.00752628748068019399</span><br><span class="line"></span><br><span class="line">3 HDD</span><br><span class="line">$ awk &apos;BEGIN&#123;printf &quot;%.20f\n&quot;, 11*0.03^3*0.97^(8)&#125;&apos;</span><br><span class="line">0.00023277177775299571</span><br><span class="line"></span><br><span class="line">4 HDD</span><br><span class="line">$ awk &apos;BEGIN&#123;printf &quot;%.20f\n&quot;, 11*0.03^4*0.97^(7)&#125;&apos;</span><br><span class="line">0.00000719912714699987</span><br><span class="line"></span><br><span class="line">$ awk &apos;BEGIN&#123;printf &quot;%.20f\n&quot;,0.00752628748068019399+0.00023277177775299571+0.00000719912714699987&#125;&apos;</span><br><span class="line">0.00776625838558018915</span><br><span class="line"></span><br><span class="line">Raidz3</span><br><span class="line">$ awk &apos;BEGIN&#123;printf &quot;%.20f\n&quot;,0.00023277177775299571+0.00000719912714699987&#125;&apos;</span><br><span class="line">0.00023997090489999559</span><br><span class="line"></span><br><span class="line">2M MTBF, 0.44% </span><br><span class="line">1M MTBF, 0.88%</span><br></pre></td></tr></table></figure></p>
<h3 id="AFR"><a href="#AFR" class="headerlink" title="AFR"></a>AFR</h3><p><a href="https://www.hgst.com/sites/default/files/resources/Ultrastar-He8-DS.pdf" target="_blank" rel="external">https://www.hgst.com/sites/default/files/resources/Ultrastar-He8-DS.pdf</a><br>2.5M hours MTBF2 and 0.35% AFR, I think real AFR=0.03<br>356x24=8760<br>$ awk ‘BEGIN{printf “%.2f\n”, 8760/0.004}’<br>2190000.00<br>$ awk ‘BEGIN{printf “%.2f\n”, 8760/0.035}’<br>2502857.14</p>
<h3 id="Nonrecoverable-Read-Errors-URE-per-Bits-Read"><a href="#Nonrecoverable-Read-Errors-URE-per-Bits-Read" class="headerlink" title="Nonrecoverable Read Errors(URE) per Bits Read"></a>Nonrecoverable Read Errors(URE) per Bits Read</h3><p>1 byte per 10E15 (Enterprise 7.2k HDD 10E15=1000000000000000)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1e12*8 bytes = 1 (TB)</span><br><span class="line">(1e15)/(1e12*8)=125 (TB)</span><br></pre></td></tr></table></figure></p>
<p>1 byte per 10E14 (Desktop 5.9k/7.2k HDD)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(1e14)/(1e12*8)=12.5 (TB)</span><br></pre></td></tr></table></figure></p>
<p>1 byte per 10E17 (Enterprise SSD)<br>1 byte per 10E16 (Desktop SSD/SAS 15k HDD)</p>
<h4 id="Calculate-failt-ratio-of-unrecoverable-read-error"><a href="#Calculate-failt-ratio-of-unrecoverable-read-error" class="headerlink" title="Calculate failt ratio of unrecoverable read error"></a><a href="https://www.high-rely.com/blog/why-raid-5-stops-working-in-2009-not/" target="_blank" rel="external">Calculate failt ratio of unrecoverable read error</a></h4><p>The probability equation they use for a successful read of all bits on a drive is<br>(1-1/b)^a<br>“b” = the Bit Error Rate (BER) also known as Unrecoverable Read Error(URE) rate<br>“a” = Number of Bits read (the amount of data on an entire volume or drive)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">6e12*8=6TB (raidz 5/6 rebuild is that raid of each HDD full scan 6TB data for XOR)</span><br><span class="line">I think each device has the same fault ratio,there is no any connection with raid disk number, it &apos;s just talk about &quot;Nonrecoverable Read Errors&quot;.</span><br><span class="line"></span><br><span class="line">rebuild device fault ratio cause by URE:</span><br><span class="line"></span><br><span class="line">6TB (if this byte has read 6TB)</span><br><span class="line">1-(1-1e-15)^(6e12*8)=0.046829644</span><br><span class="line"></span><br><span class="line">8TB </span><br><span class="line">0.06194</span><br><span class="line"></span><br><span class="line">10TB</span><br><span class="line">0.07682</span><br><span class="line"></span><br><span class="line">12TB</span><br><span class="line">0.09147</span><br><span class="line"></span><br><span class="line">20TB</span><br><span class="line">0.14775</span><br></pre></td></tr></table></figure>
<h4 id="rebuild-device-error-ratio-by-MTBF"><a href="#rebuild-device-error-ratio-by-MTBF" class="headerlink" title="rebuild device error ratio by MTBF"></a>rebuild device error ratio by MTBF</h4><p>Mean Time Between Failures (MTBF) (hours) = 1M<br>You could get running time from smartctl<br>I assumed the raid device had running 1,3,5 years<br>365<em>1</em>24/1000000=0.00876 in each HDD<br>365<em>3</em>24/1000000=0.02628 in each HDD<br>365<em>5</em>24/1000000=0.04380 in each HDD</p>
<h4 id="Production-environment-data-read-size"><a href="#Production-environment-data-read-size" class="headerlink" title="Production environment data read size"></a>Production environment data read size</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">smartctl <span class="_">-a</span> <span class="_">-d</span> scsi /dev/sdz</span><br><span class="line">number of hours powered up = 9919.17</span><br><span class="line">       Gigabytes</span><br><span class="line">       processed</span><br><span class="line">       [10^9 bytes]</span><br><span class="line"><span class="built_in">read</span>:  366268.989</span><br><span class="line"></span><br><span class="line">Read data:</span><br><span class="line">366274.390/9921.3*24*356*3/8/1000=118.285 (TB)</span><br><span class="line">Sort each byte <span class="built_in">read</span> capacity of HDD and get the maximum <span class="built_in">read</span> capacity of the byte ? I don <span class="string">'t know how to do.</span><br><span class="line">If the maximum byte of HDD has been read 23.657 TB (20% hot data)</span><br><span class="line"></span><br><span class="line">1-(1-1e-15)^(7.88568*8)=0.061089 (1y)</span><br><span class="line"></span><br><span class="line">1-(1-1e-15)^(23.657e12*8)=0.1723 (3y)</span><br><span class="line"></span><br><span class="line">1-(1-1e-15)^(39.4284*8)=0.270339 (5y)</span></span><br></pre></td></tr></table></figure>
<h5 id="Ratio-of-2-devices-damaged-simultaneously-some-case-could-be-cause-data-loss"><a href="#Ratio-of-2-devices-damaged-simultaneously-some-case-could-be-cause-data-loss" class="headerlink" title="Ratio of 2 devices damaged simultaneously (some case could be cause data loss)"></a>Ratio of 2 devices damaged simultaneously (some case could be cause data loss)</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(0.00876+0.061089)^2=0.004879 (1 years, 20% hot)</span><br><span class="line">(0.02628+0.1723)^2=0.039434 (3 years, 20% hot)</span><br><span class="line">(0.04380+0.270339)^2=0.0986833 (5 years, 20% hot)</span><br><span class="line"></span><br><span class="line">Rebuild speed about 1TB/day</span><br><span class="line">6TB = 144 hours</span><br><span class="line">8TB = 192 hours</span><br><span class="line">10TB = 240 hours</span><br><span class="line">12TB = 288 hours</span><br></pre></td></tr></table></figure>
<h3 id="HDD-DWPD"><a href="#HDD-DWPD" class="headerlink" title="HDD DWPD"></a>HDD DWPD</h3><p>ST10000VN0004 10TB<br>Workload Rate Limit (WRL) (TB/year) = 180<br>Warranty, Limited (years) = 3<br>DWPD(5y)=540/365/5=0.29589</p>
<p><a href="http://superuser.com/questions/516949/formula-to-calculate-probability-of-unrecoverable-read-error-during-raid-rebuild" target="_blank" rel="external">Formula to calculate probability of unrecoverable read error during RAID rebuild</a><br><a href="http://queue.acm.org/detail.cfm?id=1670144" target="_blank" rel="external">Triple-Parity RAID and Beyond</a><br><a href="http://www.seagate.com/www-content/product-content/ironwolf/files/ironwolf-ds-1904-1-1606us.pdf" target="_blank" rel="external">seagate ironwolf spec</a><br><a href="http://math.stackexchange.com/questions/853643/how-to-convert-1e11-into-number" target="_blank" rel="external">how to convert 1e11 into number</a></p>
]]></content>
      
        <categories>
            
            <category> tips </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> hdd </tag>
            
            <tag> ssd </tag>
            
            <tag> raid </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Install blasr in CentOS6]]></title>
      <url>http://yoursite.com/2016/07/05/Install-blasr-in-CentOS6/</url>
      <content type="html"><![CDATA[<h3 id="Install-GCC-5-2-0"><a href="#Install-GCC-5-2-0" class="headerlink" title="Install GCC 5.2.0"></a><a href="http://en.librehat.com/blog/build-gcc-5-dot-2-on-rhel-6/" target="_blank" rel="external">Install GCC 5.2.0</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">wget http://ftpmirror.gnu.org/gcc/gcc-5.2.0/gcc-5.2.0.tar.bz2</span><br><span class="line">tar xf gcc-5.2.0.tar.bz2</span><br><span class="line">wget https://gmplib.org/download/gmp/gmp-6.0.0a.tar.xz</span><br><span class="line">tar xf gmp-6.0.0a.tar.xz</span><br><span class="line">mv gmp-6.0.0 gcc-5.2.0/gmp </span><br><span class="line">wget ftp://ftp.gnu.org/gnu/mpc/mpc-1.0.3.tar.gz</span><br><span class="line">tar xf mpc-1.0.3.tar.gz</span><br><span class="line">mv mpc-1.0.3 gcc-5.2.0/mpc</span><br><span class="line">wget http://www.mpfr.org/mpfr-current/mpfr-3.1.4.tar.xz</span><br><span class="line">tar xf mpfr-3.1.3.tar.xz</span><br><span class="line">mv mpfr-3.1.3 gcc-5.2.0/mpfr</span><br><span class="line">mkdir gcc-5.2.0/gcc-build &amp;&amp; <span class="built_in">cd</span> gcc-5.2.0/gcc-build</span><br><span class="line">../configure --prefix=<span class="variable">$HOME</span>/gcc5 </span><br><span class="line">            --disable-multilib </span><br><span class="line">            --enable-languages=c,c++ </span><br><span class="line">            --enable-libstdcxx-threads </span><br><span class="line">            --enable-libstdcxx-time </span><br><span class="line">            --enable-shared </span><br><span class="line">            --enable-__cxa_atexit </span><br><span class="line">            --disable-libunwind-exceptions </span><br><span class="line">            --disable-libada </span><br><span class="line">            --host x86_64-redhat-linux-gnu </span><br><span class="line">            --build x86_64-redhat-linux-gnu </span><br><span class="line">            --with-default-libstdcxx-abi=gcc4-compatible</span><br><span class="line"></span><br><span class="line">make -j 40</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<h3 id="Check-C-11-support"><a href="#Check-C-11-support" class="headerlink" title="Check C++11 support"></a>Check C++11 support</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cat test.cpp</span><br><span class="line">#include &lt;iostream&gt;</span><br><span class="line"></span><br><span class="line">int main()&#123;</span><br><span class="line">        #if __cplusplus==201402L</span><br><span class="line">        std::cout &lt;&lt; &quot;C++14&quot; &lt;&lt; std::endl;</span><br><span class="line">        #elif __cplusplus==201103L</span><br><span class="line">        std::cout &lt;&lt; &quot;C++11&quot; &lt;&lt; std::endl;</span><br><span class="line">        #else</span><br><span class="line">        std::cout &lt;&lt; &quot;C++&quot; &lt;&lt; std::endl;</span><br><span class="line">        #endif</span><br><span class="line"></span><br><span class="line">        return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">g++ -std=c++11 test.cpp -o test</span><br></pre></td></tr></table></figure>
<p>./test<br>C++11</p>
<h3 id="Install-blasr"><a href="#Install-blasr" class="headerlink" title="Install blasr"></a>Install blasr</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">blasrpath=/xxxxxx/BLASR/blasr_el6</span><br><span class="line">HDF5=/xxxxxx/BLASR/hdf5-1.8.16-linux-centos6-x86_64-gcc447-shared</span><br><span class="line">LD_LIBRARY_PATH=<span class="variable">$blasrpath</span>/libcpp/alignment:<span class="variable">$blasrpath</span>/libcpp/hdf:<span class="variable">$blasrpath</span>/libcpp/pbdata:<span class="variable">$HDF5</span>/lib/:/xxxxxx/BLASR/blasr_el6/gcc/gcc5_el6/lib64:LD_LIBRARY</span><br><span class="line">PATH=/xxxxxx/BLASR/blasr_el6/gcc/gcc5_el6/bin:<span class="variable">$PATH</span></span><br><span class="line">./configure.py --shared --sub --no-pbbam HDF5_INCLUDE=<span class="variable">$HDF5</span>/include/ HDF5_LIB=<span class="variable">$HDF5</span>/lib</span><br><span class="line">make configure-submodule</span><br><span class="line">make build-submodule</span><br><span class="line">make blasr</span><br><span class="line">./blasr --version</span><br><span class="line">5.2</span><br><span class="line"></span><br><span class="line"><span class="comment">#benchamrk cpu</span></span><br><span class="line">time ./blasr /xxxxxx/BLASR/error_corrected_reads_7.fa /xxxxxx/BLASR/platypus.v2.fa.gapfilled.fa --sa /xxxxxx/BLASR/platypus.v2.fa.gapfilled.fa.blasr_sa --minMatch 11 --maxAnchorsPerPosition 500 --nproc $(cat /proc/cpuinfo | grep MHz -c) &gt; /dev/zero</span><br></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> bio </tag>
            
            <tag> software </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Monitor ssd device]]></title>
      <url>http://yoursite.com/2016/07/04/Monitor-ssd-device/</url>
      <content type="html"><![CDATA[<h3 id="Monitor-Intel-SATA-SSD"><a href="#Monitor-Intel-SATA-SSD" class="headerlink" title="Monitor Intel SATA SSD"></a>Monitor Intel SATA SSD</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">smartctl <span class="_">-a</span> /dev/sdaa</span><br><span class="line">233 Media_Wearout_Indicator 0x0032   097   097   000    Old_age   Always       -       0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">241 Host_Writes_32MiB       0x0032   100   100   000    Old_age   Always       -       24439</span><br><span class="line">242 Host_Reads_32MiB        0x0032   100   100   000    Old_age   Always       -       4275</span><br><span class="line">243 NAND_Writes_32MiB       0x0032   100   100   000    Old_age   Always       -       40857</span><br><span class="line"></span><br><span class="line">dd <span class="keyword">if</span>=/dev/zero of=<span class="built_in">test</span> bs=1M count=1024</span><br><span class="line"></span><br><span class="line">241 Host_Writes_32MiB       0x0032   100   100   000    Old_age   Always       -       24471</span><br><span class="line">242 Host_Reads_32MiB        0x0032   100   100   000    Old_age   Always       -       4275</span><br><span class="line">243 NAND_Writes_32MiB       0x0032   100   100   000    Old_age   Always       -       40857</span><br></pre></td></tr></table></figure>
<p>You can see write 32*32=1024M write to ssd. the value is “MB”.</p>
<h3 id="Samsung-SATA-SSD"><a href="#Samsung-SATA-SSD" class="headerlink" title="Samsung SATA SSD"></a><a href="https://www.smartmontools.org/ticket/661" target="_blank" rel="external">Samsung SATA SSD</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">251 NAND_Writes             -O--CK   100   100   000    -    7546253904</span><br><span class="line">                            ||||||_ K auto-keep</span><br><span class="line">                            |||||__ C event count</span><br><span class="line">                            ||||___ R error rate</span><br><span class="line">                            |||____ S speed/performance</span><br><span class="line">                            ||_____ O updated online</span><br><span class="line">                            |______ P prefailure warning</span><br></pre></td></tr></table></figure>
<h3 id="NVME-Intel-SSD"><a href="#NVME-Intel-SSD" class="headerlink" title="NVME Intel SSD"></a>NVME Intel SSD</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">isdct  show -smart -intelssd 0</span><br><span class="line">Description : NAND Bytes Written</span><br><span class="line">ID : F4</span><br><span class="line">Normalized : 100</span><br><span class="line">Raw : 6142760</span><br><span class="line"></span><br><span class="line">- F5 -</span><br><span class="line"></span><br><span class="line">Description : Host Bytes Written</span><br><span class="line">ID : F5</span><br><span class="line">Normalized : 100</span><br><span class="line">Raw : 2790072</span><br><span class="line"></span><br><span class="line">dd <span class="keyword">if</span>=/dev/zero of=<span class="built_in">test</span> bs=1M count=1024</span><br><span class="line"></span><br><span class="line">Description : NAND Bytes Written</span><br><span class="line">ID : F4</span><br><span class="line">Normalized : 100</span><br><span class="line">Raw : 6142930</span><br><span class="line"></span><br><span class="line">- F5 -</span><br><span class="line"></span><br><span class="line">Description : Host Bytes Written</span><br><span class="line">ID : F5</span><br><span class="line">Normalized : 100</span><br><span class="line">Raw : 2790104</span><br></pre></td></tr></table></figure>
<p>Raw value of Host Bytes Written improved 32</p>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> ssd </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Main board SATA port bottle neck]]></title>
      <url>http://yoursite.com/2016/06/16/Main-board-SATA-bottle-neck/</url>
      <content type="html"><![CDATA[<p><img src="/img/Dt9p6.jpg" alt=""><br>DMI 2.0 2 GB/s<br>DMI 3.0 3.93 GB/s<br>SATA SSD 500MB/s x 4/8 = 2000/4000MB/s<br><a href="http://electronics.stackexchange.com/questions/219440/why-do-cpus-typically-connect-to-only-one-bus/219446" target="_blank" rel="external">reference</a></p>
]]></content>
      
        <categories>
            
            <category> Architecture </category>
            
        </categories>
        
        
        <tags>
            
            <tag> hardware </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Benchmark ConnectX®-3 Pro VMA]]></title>
      <url>http://yoursite.com/2016/06/03/Benchmark_ConnectX%C2%AE_3_Pro/</url>
      <content type="html"><![CDATA[<h3 id="RDMA-support"><a href="#RDMA-support" class="headerlink" title="RDMA support"></a>RDMA support</h3><p>RDMA allows for communication between systems but can bypass the overhead associated with the operating system kernel, so applications have reduced latency and much lower CPU utilization.</p>
<p><a href="https://github.com/Mellanox/libvma" target="_blank" rel="external">libvma</a><br>Linux user space library for network socket acceleration based on RDMA compatible network adaptors</p>
<p>socket ip layer ?</p>
<h3 id="Update-driver"><a href="#Update-driver" class="headerlink" title="Update driver"></a>Update driver</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apt install module-init-tools dkms</span><br><span class="line">modprobe -r mlx4_en</span><br><span class="line">modprobe -r mlx4_core</span><br><span class="line">modprobe mlx4_en mlx4_core</span><br><span class="line">modinfo mlx4_core</span><br><span class="line">filename:       /lib/modules/4.4.0-22-generic/updates/dkms/mlx4_core.ko</span><br><span class="line">version:        3.3-1.0.0</span><br><span class="line">license:        Dual BSD/GPL</span><br><span class="line">description:    Mellanox ConnectX HCA low-level driver</span><br><span class="line">author:         Roland Dreier</span><br><span class="line">srcversion:     E63C21909524B057DF41E97</span><br></pre></td></tr></table></figure>
<h3 id="NIC-info"><a href="#NIC-info" class="headerlink" title="NIC info"></a>NIC info</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ethtool -i enp5s0</span><br><span class="line">driver: mlx4_en</span><br><span class="line">version: 3.3-1.0.0 (31 May 2016)</span><br><span class="line">firmware-version: 2.36.5000</span><br><span class="line">expansion-rom-version: </span><br><span class="line">bus-info: 0000:05:00.0</span><br><span class="line">supports-statistics: yes</span><br><span class="line">supports-test: yes</span><br><span class="line">supports-eeprom-access: no</span><br><span class="line">supports-register-dump: no</span><br><span class="line">supports-priv-flags: yes</span><br></pre></td></tr></table></figure>
<h3 id="NIC-offload"><a href="#NIC-offload" class="headerlink" title="NIC offload"></a>NIC offload</h3><table>
<thead>
<tr>
<th>Features</th>
</tr>
</thead>
<tbody>
<tr>
<td>TSO (TCP Segmentation Offload)</td>
<td>on</td>
</tr>
<tr>
<td>GSO (Generic Segmentation Offload)</td>
<td>on</td>
</tr>
<tr>
<td>GRO (Generic Receive Offload)</td>
<td>on</td>
</tr>
<tr>
<td>rx-checksumming</td>
<td>on</td>
</tr>
<tr>
<td>tx-checksumming</td>
<td>on</td>
</tr>
<tr>
<td>scatter-gather</td>
<td>on</td>
</tr>
</tbody>
</table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool --offload enp5s0 rx on tx on</span><br><span class="line">Actual changes:</span><br><span class="line">rx-checksumming: on</span><br><span class="line">tx-checksumming: on</span><br><span class="line">	tx-checksum-ipv4: on</span><br><span class="line">	tx-checksum-ipv6: on</span><br><span class="line">tcp-segmentation-offload: on</span><br><span class="line">	tx-tcp-segmentation: on</span><br><span class="line">	tx-tcp6-segmentation: on</span><br><span class="line"></span><br><span class="line">$ ethtool -k enp4s0d1 | grep -v fixed</span><br><span class="line">Features <span class="keyword">for</span> enp4s0d1:</span><br><span class="line">rx-checksumming: on</span><br><span class="line">tx-checksumming: on</span><br><span class="line">	tx-checksum-ipv4: on</span><br><span class="line">	tx-checksum-ipv6: on</span><br><span class="line">scatter-gather: on</span><br><span class="line">	tx-scatter-gather: on</span><br><span class="line">tcp-segmentation-offload: on</span><br><span class="line">	tx-tcp-segmentation: on</span><br><span class="line">	tx-tcp6-segmentation: on</span><br><span class="line">generic-segmentation-offload: on</span><br><span class="line">generic-receive-offload: on</span><br><span class="line">rx-vlan-offload: on</span><br><span class="line">tx-vlan-offload: on</span><br><span class="line">ntuple-filters: on</span><br><span class="line">receive-hashing: on</span><br><span class="line">tx-nocache-copy: off</span><br><span class="line">loopback: off</span><br><span class="line">rx-fcs: off</span><br><span class="line">tx-vlan-stag-hw-insert: off</span><br><span class="line">rx-vlan-stag-hw-parse: on</span><br><span class="line"></span><br><span class="line"><span class="comment">#enable TSO</span></span><br><span class="line">$ ethtool -K enp4s0 tso on</span><br><span class="line">$ ethtool -K enp4s0 gso off</span><br></pre></td></tr></table></figure>
<p>Transmit:</p>
<ul>
<li>TSO</li>
<li>GSO  (software ?)</li>
</ul>
<p>Receive:</p>
<ul>
<li>GRO</li>
</ul>
<p>Interrupt mitigation or interrupt coalescing</p>
<p>rx-frames[-irq] rx-usecs[-irq] tx-frames[-irq] tx-usecs[-irq]</p>
<p><a href="http://serverfault.com/questions/278756/interpreting-ethtool-coalesce-output" target="_blank" rel="external">The frames parameters specify how many packets are received/transmitted before generating an interrupt. The usecs parameters specify how many microseconds after at least 1 packet is received/transmitted before generating an interrupt. The [-irq] parameters are the corresponding delays in updating the status when the interrupt is disabled.</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -c enp4s0d1</span><br><span class="line">Coalesce parameters <span class="keyword">for</span> enp4s0d1:</span><br><span class="line">Adaptive RX: off  TX: off</span><br><span class="line">stats-block-usecs: 0</span><br><span class="line">sample-interval: 0</span><br><span class="line">pkt-rate-low: 400000</span><br><span class="line">pkt-rate-high: 450000</span><br><span class="line"></span><br><span class="line">rx-usecs: 0</span><br><span class="line">rx-frames: 0</span><br><span class="line">rx-usecs-irq: 0</span><br><span class="line">rx-frames-irq: 0</span><br><span class="line"></span><br><span class="line">tx-usecs: 8</span><br><span class="line">tx-frames: 16</span><br><span class="line">tx-usecs-irq: 0</span><br><span class="line">tx-frames-irq: 256</span><br><span class="line"></span><br><span class="line">rx-usecs-low: 0</span><br><span class="line">rx-frame-low: 0</span><br><span class="line">tx-usecs-low: 0</span><br><span class="line">tx-frame-low: 0</span><br><span class="line"></span><br><span class="line">rx-usecs-high: 128</span><br><span class="line">rx-frame-high: 0</span><br><span class="line">tx-usecs-high: 0</span><br><span class="line">tx-frame-high: 0</span><br><span class="line"></span><br><span class="line"><span class="comment">#reduce lantency,improve cpu usage</span></span><br><span class="line">$ ethtool -C enp5s0 adaptive-rx off rx-usecs 0 rx-frames 0</span><br><span class="line">$ ethtool -C enp5s0d1 adaptive-rx off rx-usecs 0 rx-frames 0</span><br></pre></td></tr></table></figure>
<p>if you need to improve value of rx-usecs, improve latency and througput, and suggestion improve<br>net.ipv4.tcp_tso_win_divisor = 30 (default 3) too.</p>
<p><a href="http://digital.ni.com/public.nsf/allkb/65B0708FE161D8C0852563DA00620887" target="_blank" rel="external">What is Scatter-Gather DMA</a><br><a href="https://lwn.net/Articles/358910/" target="_blank" rel="external">Replace LRO with GRO</a><br><a href="https://en.wikipedia.org/wiki/Direct_memory_access" target="_blank" rel="external">Scatter-gather or vectored I/O DMA allows the transfer of data to and from multiple memory areas in a single DMA transaction. It is equivalent to the chaining together of multiple simple DMA requests. The motivation is to off-load multiple input/output interrupt and data copy tasks from the CPU</a></p>
<h5 id="About-GSO"><a href="#About-GSO" class="headerlink" title="About GSO"></a>About GSO</h5><p><a href="https://lwn.net/Articles/188489/" target="_blank" rel="external">Many people have observed that a lot of the savings in TSO come from traversing the networking stack once rather than many times for each super-packet.  These savings can be obtained without hardware support.</a><br>[GSO like TSO is only effective if the MTU is significantly less than the<br>maximum value of 64K.  So only the case where the MTU was set to 1500 is<br>of interest.</p>
<p>TSO 是使得网络协议栈能够将大块 buffer 推送至网卡，然后网卡执行分片工作，这样减轻了 CPU 的负荷，但 TSO 需要硬件来实现分片功能；而性能上的提高，主要是因为延缓分片而减轻了 CPU 的负载，因此，可以考虑将 TSO 技术一般化，因为其本质实际是延缓分片，这种技术，在 Linux 中被叫做 GSO(Generic Segmentation Offload)，它比 TSO 更通用，原因在于它不需要硬件的支持分片就可使用，对于支持 TSO 功能的硬件，则先经过 GSO 功能，然后使用网卡的硬件分片能力执行分片；而对于不支持 TSO 功能的网卡，将分片的执行，放在了将数据推送的网卡的前一刻，也就是在调用驱动的 xmit 函数前。(<a href="https://www.ibm.com/developerworks/cn/linux/l-cn-network-pt/#icomments" target="_blank" rel="external">https://www.ibm.com/developerworks/cn/linux/l-cn-network-pt/#icomments</a>)</p>
<p>if mtu 1500, kernel will split large data to 1448 bytes per packages , after enable gso (hardware), There are some 2896 bytes packages in tcpdump, and split operation in nic device.</p>
<p><a href="https://en.wikipedia.org/wiki/Goodput" target="_blank" rel="external">20 bytes of IPv4 header information and 20 bytes of TCP header information,Linux and Mac OS are further limited to 1448 bytes as they also carry a 12-byte time stamp</a><br>1500-20-20-12=1448</p>
<p><img src="http://sandilands.info/sgordon/images/wireshark-capture-1.png" alt=""><br><img src="http://sandilands.info/sgordon/images/wireshark-capture-2.png" alt=""><br><a href="http://sandilands.info/sgordon/segmentation-offloading-with-wireshark-and-ethtool" target="_blank" rel="external">Segmentation and Checksum Offloading: Turning Off with ethtool</a></p>
<h4 id="DMA-Ring-Buffer-Sizes-and-statistics"><a href="#DMA-Ring-Buffer-Sizes-and-statistics" class="headerlink" title="DMA Ring Buffer Sizes and statistics"></a>DMA Ring Buffer Sizes and statistics</h4><p>The pre-set maximum is 8192 packets. The default is 256 packets. For purposes of LAN testing, using the smallest possible ring size provides the best results<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">ethtool -S enp5s0</span><br><span class="line"></span><br><span class="line"><span class="comment"># ethtool -S eth0 | grep rx_no_buffer_count</span></span><br><span class="line">     rx_no_buffer_count: 100590</span><br><span class="line"><span class="comment"># ethtool -S eth0 | grep rx_missed_errors  </span></span><br><span class="line">     rx_missed_errors: 9188</span><br><span class="line"></span><br><span class="line">reduce buffer,<span class="keyword">in</span> this old machine, 4096 is maxinum</span><br><span class="line"></span><br><span class="line"><span class="comment">#1GbE</span></span><br><span class="line">$ ethtool -G eth0 rx 2048 tx 2048</span><br><span class="line"></span><br><span class="line">$ ethtool -g eth0</span><br><span class="line">Ring parameters <span class="keyword">for</span> eth0:</span><br><span class="line">Pre-set maximums:</span><br><span class="line">RX:		4096</span><br><span class="line">RX Mini:	0</span><br><span class="line">RX Jumbo:	0</span><br><span class="line">TX:		4096</span><br><span class="line">Current hardware settings:</span><br><span class="line">RX:		2048</span><br><span class="line">RX Mini:	0</span><br><span class="line">RX Jumbo:	0</span><br><span class="line">TX:		2048</span><br><span class="line"></span><br><span class="line"><span class="comment">#10GbE</span></span><br><span class="line">$ ethtool -g enp4s0</span><br><span class="line">Ring parameters <span class="keyword">for</span> enp4s0:</span><br><span class="line">Pre-set maximums:</span><br><span class="line">RX:		8192</span><br><span class="line">RX Mini:	0</span><br><span class="line">RX Jumbo:	0</span><br><span class="line">TX:		8192</span><br><span class="line">Current hardware settings:</span><br><span class="line">RX:		1024</span><br><span class="line">RX Mini:	0</span><br><span class="line">RX Jumbo:	0</span><br><span class="line">TX:		512</span><br></pre></td></tr></table></figure></p>
<h4 id="Enable-RSS-RFS"><a href="#Enable-RSS-RFS" class="headerlink" title="Enable RSS/RFS"></a>Enable RSS/RFS</h4><p>RSS Contemporary NICs support multiple receive and transmit descriptor queues (multi-queue). you can show it from /etc/interrupt</p>
<p><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Performance_Tuning_Guide/network-rfs.html" target="_blank" rel="external">Receive Flow Steering (RFS) extends RPS behavior to increase the CPU cache hit rate and thereby reduce network latency</a><br><a href="http://www.mellanox.com/related-docs/prod_software/Mellanox_OFED_Linux_User_Manual_v2.2-1.0.1.pdf" target="_blank" rel="external">Enabling the RFS requires enabling the ‘ntuple’ flag via the ethtool,RFS requires the kernel to be compiled with the CONFIG_RFS_ACCEL option. This options is available in kernels 2.6.39 and above. Furthermore, RFS requires Device Managed Flow Steering support.</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ethtool -K enp5s0 ntuple on</span><br><span class="line">ethtool -K enp5s0d1 ntuple on</span><br></pre></td></tr></table></figure>
<h4 id="RSS-RFS-XPS"><a href="#RSS-RFS-XPS" class="headerlink" title="RSS RFS XPS"></a>RSS RFS XPS</h4><p><a href="http://www.mellanox.com/related-docs/prod_software/Mellanox_OFED_Linux_Release_Notes_3_1-1_0_3.pdf" target="_blank" rel="external">Added Transmit Packet Steering (XPS) support</a><br><a href="http://www.mellanox.com/related-docs/prod_software/Mellanox_OFED_Linux_Release_Notes_3_1-1_0_3.pdf" target="_blank" rel="external">RFS does not support UDP</a><br><a href="http://www.mellanox.com/related-docs/prod_software/Mellanox_OFED_Linux_Release_Notes_3_1-1_0_3.pdf" target="_blank" rel="external">RSS support of fragmented IP datagram</a><br><a href="http://www.mellanox.com/related-docs/prod_software/Mellanox_OFED_Linux_User_Manual_v2.2-1.0.1.pdf" target="_blank" rel="external">XOR RSS Hash Function</a></p>
<h4 id="Enable-Receive-Packet-Steering"><a href="#Enable-Receive-Packet-Steering" class="headerlink" title="Enable Receive Packet Steering"></a>Enable Receive Packet Steering</h4><p>Maybe mellanox not support hardware acceleration<br>Receive Packet Steering (RPS) is logically a software implementation of RSS</p>
<p>RPS has some advantages over RSS: </p>
<ul>
<li>it can be used with any NIC,</li>
<li>software filters can easily be added to hash over new protocols,</li>
<li>it does not increase hardware device interrupt rate (although it doesintroduce inter-processor interrupts (IPIs)).<br><a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt" target="_blank" rel="external">kernel networking scaling</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span> <span class="string">'%x\n'</span> <span class="string">"<span class="variable">$((2#10101)</span>)"</span> <span class="comment"># core 0,2,4</span></span><br><span class="line">15</span><br><span class="line"><span class="built_in">printf</span> <span class="string">'%x\n'</span> <span class="string">"<span class="variable">$((2#10101000000)</span>)"</span> core 6,8,10</span><br><span class="line">540</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(ls /sys/class/net/enp5s0/queues/ | grep rx-);</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> 15 &gt; /sys/class/net/enp5s0/queues/<span class="variable">$i</span>/rps_cpus;</span><br><span class="line">        cat /sys/class/net/enp5s0/queues/<span class="variable">$i</span>/rps_cpus;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(ls /sys/class/net/enp5s0d1/queues/ | grep rx-);</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> 540 &gt; /sys/class/net/enp5s0/queues/<span class="variable">$i</span>/rps_cpus;</span><br><span class="line">        cat /sys/class/net/enp5s0/queues/<span class="variable">$i</span>/rps_cpus;</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h4 id="Enable-autonegotiation"><a href="#Enable-autonegotiation" class="headerlink" title="Enable autonegotiation"></a>Enable autonegotiation</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ethtool -A enp5s0 autoneg on <span class="comment">#could not work for mellanox</span></span><br><span class="line">Cannot <span class="built_in">set</span> device pause parameters: Invalid argument</span><br><span class="line"></span><br><span class="line">ethtool -A enp5s0 rx on</span><br><span class="line">ethtool -A enp5s0 tx on</span><br><span class="line"></span><br><span class="line">ethtool <span class="_">-a</span>  <span class="variable">$nic0</span></span><br><span class="line">Pause parameters <span class="keyword">for</span> enp5s0:</span><br><span class="line">Autonegotiate:  off</span><br><span class="line">RX:             on</span><br><span class="line">TX:             on</span><br></pre></td></tr></table></figure>
<h3 id="CPU-info"><a href="#CPU-info" class="headerlink" title="CPU info"></a>CPU info</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-16:/sys/class/net/enp5s0/device<span class="comment"># cat /sys/class/net/enp5s0/device/numa_node </span></span><br><span class="line">0</span><br><span class="line">root@ubuntu-16:/sys/class/net/enp5s0d1/device<span class="comment"># cat /sys/class/net/enp5s0d1/device/numa_node </span></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">cat /sys/class/net/enp5s0/device/<span class="built_in">local</span>_cpus</span><br><span class="line">0000,00000000,00000000,00000000,00000555</span><br><span class="line"></span><br><span class="line"><span class="comment">#same with</span></span><br><span class="line"><span class="built_in">printf</span> <span class="string">'%x\n'</span> <span class="string">"<span class="variable">$((2#10101010101)</span>)"</span></span><br><span class="line">555</span><br><span class="line"></span><br><span class="line"><span class="comment"># CPU Tubro mode</span></span><br><span class="line">```bash</span><br><span class="line">cat /sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_max_freq</span><br><span class="line">3200000</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disable cstate in grub.conf</span></span><br><span class="line">intel_idle.max_cstate=0 processor.max_cstate=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># disable irqbalance</span></span><br><span class="line">/etc/init.d/irqbalance stop</span><br><span class="line">[ ok ] Stopping irqbalance (via systemctl): irqbalance.service.</span><br><span class="line"></span><br><span class="line"><span class="comment"># install numactl collectl irqstat</span></span><br><span class="line">apt install numactl collectl</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/lanceshelton/irqstat</span><br><span class="line"></span><br><span class="line"><span class="comment">#lscpu</span></span><br><span class="line">Architecture:          x86_64</span><br><span class="line">CPU op-mode(s):        32-bit, 64-bit</span><br><span class="line">Byte Order:            Little Endian</span><br><span class="line">CPU(s):                12</span><br><span class="line">On-line CPU(s) list:   0-11</span><br><span class="line">Thread(s) per core:    1</span><br><span class="line">Core(s) per socket:    6</span><br><span class="line">Socket(s):             2</span><br><span class="line">NUMA node(s):          2</span><br><span class="line">Vendor ID:             GenuineIntel</span><br><span class="line">CPU family:            6</span><br><span class="line">Model:                 63</span><br><span class="line">Model name:            Intel(R) Xeon(R) CPU E5-2620 v3 @ 2.40GHz</span><br><span class="line">Stepping:              2</span><br><span class="line">CPU MHz:               1200.187</span><br><span class="line">CPU max MHz:           3200.0000</span><br><span class="line">CPU min MHz:           1200.0000</span><br><span class="line">BogoMIPS:              4795.72</span><br><span class="line">Virtualization:        VT-x</span><br><span class="line">L1d cache:             32K</span><br><span class="line">L1i cache:             32K</span><br><span class="line">L2 cache:              256K</span><br><span class="line">L3 cache:              15360K</span><br><span class="line">NUMA node0 CPU(s):     0,2,4,6,8,10</span><br><span class="line">NUMA node1 CPU(s):     1,3,5,7,9,11</span><br></pre></td></tr></table></figure>
<p>That means you ‘d better use cpus in numa node0, I guess, if numa node1 read/write data to the PCIE device, the data has to pass through QPI(Intel QuickPath Interconnect)<br>In my benchmark ,numactl will bind all applications on numa node0.</p>
<h3 id="OPS"><a href="#OPS" class="headerlink" title="OPS"></a>OPS</h3><ul>
<li>Disabled hyper thread    </li>
<li>Enable turbo mode</li>
<li>Enable numa, preferred each node</li>
<li>Disabled irqbalance</li>
</ul>
<h4 id="CPU-Affinity"><a href="#CPU-Affinity" class="headerlink" title="CPU Affinity"></a>CPU Affinity</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span> <span class="string">'%x\n'</span> <span class="string">"<span class="variable">$((2#10101010101)</span>)"</span></span><br><span class="line">555 <span class="comment">#numa_node0</span></span><br><span class="line"></span><br><span class="line">awk -F: <span class="string">'$0~/enp5/ || $0~/mlx4/ &#123;print $1&#125;'</span> /proc/interrupts | <span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">        <span class="built_in">echo</span> 555 &gt; /proc/irq/<span class="variable">$line</span>/smp_affinity </span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h4 id="sysctl-conf-for-ipv4"><a href="#sysctl-conf-for-ipv4" class="headerlink" title="sysctl.conf for ipv4"></a>sysctl.conf for ipv4</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_sack = 0 <span class="comment">#Disable the TCP timestamps option for better CPU utilization</span></span><br><span class="line">net.core.netdev_budget = 300 </span><br><span class="line">net.ipv4.tcp_timestamps=0 <span class="comment">#Disable the TCP timestamps option for better CPU utilization</span></span><br><span class="line">net.core.netdev_max_backlog=250000 <span class="comment">#Increase the maximum length of processor input queues</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Increase the TCP maximum and default buffer sizes </span></span><br><span class="line">net.core.rmem_max=4194304</span><br><span class="line">net.core.wmem_max=4194304</span><br><span class="line">net.core.rmem_default=4194304</span><br><span class="line">net.core.wmem_default=4194304</span><br><span class="line">net.core.optmem_max=4194304</span><br><span class="line"></span><br><span class="line"><span class="comment">#Increase memory thresholds to prevent packet dropping</span></span><br><span class="line">net.ipv4.tcp_rmem=<span class="string">"4096 87380 4194304"</span></span><br><span class="line">net.ipv4.tcp_wmem=<span class="string">"4096 65536 4194304"</span></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_low_latency=1 <span class="comment">#Enable low latency mode for TCP</span></span><br><span class="line">net.ipv4.tcp_adv_win_scale=1  <span class="comment">#A value of 1 means the socket buffer will be divided evenly between TCP windows size and application.</span></span><br></pre></td></tr></table></figure>
<h4 id="txqueueleng"><a href="#txqueueleng" class="headerlink" title="txqueueleng"></a>txqueueleng</h4><p><a href="https://www.nas.nasa.gov/assets/pdf/papers/NAS_Technical_Report_NAS-2014-01.pdf" target="_blank" rel="external">This queue parameter is mostly applicable for high-speed WAN transfers. For low-latency networks, the default setting of 1000 is sufficient. The receiving end is configured with the sysctl setting net.core.netdev_max_backlog. The default for this setting is also 1000 and does not need to be modified unless there is significant latency.</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ip link <span class="built_in">set</span> dev enp5s0 txqueuelen 1000</span><br><span class="line">ip link <span class="built_in">set</span> dev enp5s0d1 txqueuelen 1000</span><br><span class="line">ip link <span class="built_in">set</span> dev bond0 txqueuelen 2000</span><br></pre></td></tr></table></figure></p>
<h4 id="Enable-jumbo-frames"><a href="#Enable-jumbo-frames" class="headerlink" title="Enable jumbo frames"></a><a href="http://ehealth-aussie.blogspot.com/2011/11/in-depth-look-into-path-mtu-discovery.html" target="_blank" rel="external">Enable jumbo frames</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_mtu_probing = 1</span><br><span class="line">net.ipv4.tcp_base_mss = 512</span><br><span class="line">net.ipv4.ip_no_pmtu_disc = 0</span><br></pre></td></tr></table></figure>
<p><img src="https://dl.dropboxusercontent.com/u/4919408/tec/blog/net/net_kernel/tcp_packet_reception.png" alt=""><br><img src="https://dl.dropboxusercontent.com/u/4919408/tec/blog/net/net_kernel/tcp_packet_transmission.png" alt=""></p>
<h3 id="Configure-libvma"><a href="#Configure-libvma" class="headerlink" title="Configure libvma"></a>Configure libvma</h3><p><a href="https://github.com/Mellanox/libvma/wiki/Build-Instruction" target="_blank" rel="external">Install libvma in linux</a><br><a href="https://github.com/Mellanox/libvma/blob/master/src/vma/util/libvma.conf#L22" target="_blank" rel="external">libvma.conf</a><br><a href="https://community.mellanox.com/docs/DOC-2431" target="_blank" rel="external">Using ConnectX-3 Pro with VMA over Ubuntu 16.04 Inbox Driver</a><br><a href="http://www.mellanox.com/page/products_dyn?product_family=26" target="_blank" rel="external">Mellanox OpenFabrics Enterprise Distribution for Linux MLNX_OFED</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> apt-get install dkms infiniband-diags libibverbs* ibacm librdmacm* libmlx4* libmlx5* mstflint libibcm.* libibmad.* libibumad* opensm srptools libmlx4-dev librdmacm-dev rdmacm-utils ibverbs-utils perftest vlan ibutils</span><br><span class="line"> apt-get install libnl-3-200 libnl-route-3-200 libnl-route-3-dev libnl-utils</span><br><span class="line"> git <span class="built_in">clone</span> https://github.com/Mellanox/libvma.git $ <span class="built_in">cd</span> libvma </span><br><span class="line"> ./autogen.sh</span><br><span class="line"> ./configure --prefix=/usr</span><br><span class="line"> make -j 12</span><br><span class="line"> make install</span><br><span class="line"> ldconfig</span><br><span class="line"> <span class="built_in">echo</span> options mlx4_core <span class="built_in">log</span>_num_mgm_entry_size=-1 &gt; /etc/modprobe.d/mlnx.conf</span><br><span class="line"> <span class="built_in">echo</span> 1000000000 &gt; /proc/sys/kernel/shmmax</span><br><span class="line"> <span class="built_in">echo</span> 800 &gt; /proc/sys/vm/nr_hugepage</span><br><span class="line"> <span class="built_in">ulimit</span> <span class="_">-l</span> unlimited</span><br><span class="line"> LD_PRELOAD=libvma.so &lt;<span class="built_in">test</span>_app&gt;</span><br><span class="line"></span><br><span class="line">$ cat /etc/modprobe.d/mlx4.conf </span><br><span class="line"><span class="comment"># mlx4_core gets automatically loaded, load mlx4_en also (LP: #1115710)</span></span><br><span class="line">softdep mlx4_core post: mlx4_en</span><br><span class="line"><span class="comment">#options mlx4_en inline_thold=0</span></span><br><span class="line">options mlx4_core port_<span class="built_in">type</span>_array=2,2 num_vfs=2 probe_vf=0 <span class="built_in">enable</span>_64b_cqe_eqe=0  <span class="built_in">log</span>_num_mgm_entry_size=-1</span><br></pre></td></tr></table></figure></p>
<h3 id="Benchmark"><a href="#Benchmark" class="headerlink" title="Benchmark"></a>Benchmark</h3><h4 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h4><p><img src="/img/mellanox_network.jpg" alt="Network_Arch"><br>CPU is not bottle neck, 2620 was enough for quad/dual 10GbE</p>
<h4 id="sockperf"><a href="#sockperf" class="headerlink" title="sockperf"></a>sockperf</h4><p>sockperf: == version #2.7-53.git6f0f32c1fb02 ==<br>MTU 1500<br>single core server/client, single port</p>
<p>./sockperf server –tcp -p 11111<br>./sockperf server -p 11111 #udp<br>numactl -C 2 /opt/sockperf/bin/sockperf tp -m 256  -i 192.168.12.201 -p 11111 -t 20<br>numactl -C 2 /opt/sockperf/bin/sockperf pp -m 256  -i 192.168.12.201 -p 11111 -t 20</p>
<p>Throughput (MBps)</p>
<table>
<thead>
<tr>
<th>msg size bytes</th>
<th>TCP TP MBps</th>
<th>TCP TP VMA</th>
<th>UDP TP</th>
<th>UDP TP VMA</th>
</tr>
</thead>
<tbody>
<tr>
<td>256</td>
<td>289.160</td>
<td>695.808</td>
<td>78.632</td>
<td>766.952</td>
</tr>
<tr>
<td>512</td>
<td>420.863</td>
<td>1125.157</td>
<td>154.019</td>
<td>1055.240</td>
</tr>
<tr>
<td>1024</td>
<td>1129.297</td>
<td>1130.277</td>
<td>301.421</td>
<td>1119.500</td>
</tr>
<tr>
<td>2048</td>
<td>1131.170</td>
<td>1130.346</td>
<td>381.049</td>
<td>1123.660</td>
</tr>
<tr>
<td>4096</td>
<td>1131.160</td>
<td>1130.387</td>
<td>564.496</td>
<td>1141.008</td>
</tr>
</tbody>
</table>
<p>Package num (msg/s)<br>msg/s=(send+rec msg) per second</p>
<table>
<thead>
<tr>
<th>msg size bytes</th>
<th>TCP PP</th>
<th>TCP PP VMA</th>
<th>TCP PP 3x</th>
<th>TCP PP 3x VMA</th>
<th>Intel X540</th>
<th>ConnectX-3</th>
<th>ConnectX-3 VMA</th>
</tr>
</thead>
<tbody>
<tr>
<td>256</td>
<td>61813</td>
<td>261712</td>
<td>181845</td>
<td>702355</td>
<td>53663</td>
<td>63698</td>
<td>258556</td>
</tr>
<tr>
<td>512</td>
<td>65832</td>
<td>225369</td>
<td>154585</td>
<td>615563</td>
<td>53414</td>
<td>52425</td>
<td>223479</td>
</tr>
<tr>
<td>1024</td>
<td>51411</td>
<td>182045</td>
<td>158244</td>
<td>503944</td>
<td>53067</td>
<td>56812</td>
<td>179406</td>
</tr>
<tr>
<td>2048</td>
<td>40918</td>
<td>130620</td>
<td>130946</td>
<td>353721</td>
<td>36214</td>
<td>35772</td>
<td>127449</td>
</tr>
</tbody>
</table>
<p>AVG Latency(us)                                                                                                       </p>
<table>
<thead>
<tr>
<th>msg size bytes</th>
<th>TCP PP</th>
<th>TCP PP VMA</th>
<th>TCP PP 3x</th>
<th>TCP PP 3x VMA</th>
<th>Intel X540</th>
<th>ConnectX-3</th>
<th>ConnectX-3 VMA</th>
</tr>
</thead>
<tbody>
<tr>
<td>256</td>
<td>14.611</td>
<td>3.798</td>
<td>16.7707</td>
<td>4.268</td>
<td>17.072</td>
<td>15.644</td>
<td>3.845</td>
</tr>
<tr>
<td>512</td>
<td>16.162</td>
<td>4.434</td>
<td>19.8913</td>
<td>4.866</td>
<td>18.667</td>
<td>19.013</td>
<td>4.456</td>
</tr>
<tr>
<td>1024</td>
<td>17.433</td>
<td>5.455</td>
<td>30.7607</td>
<td>5.9526</td>
<td>18.789</td>
<td>17.547</td>
<td>5.576</td>
</tr>
<tr>
<td>2048</td>
<td>24.768</td>
<td>7.849</td>
<td>28.7957</td>
<td>8.49</td>
<td>27.556</td>
<td>27.347</td>
<td>7.857</td>
</tr>
</tbody>
</table>
<h4 id="UDP-performance"><a href="#UDP-performance" class="headerlink" title="UDP performance"></a>UDP performance</h4><table>
<thead>
<tr>
<th>msg size bytes</th>
<th>UDP PP</th>
<th>UDP PP VMA </th>
</tr>
</thead>
<tbody>
<tr>
<td>256</td>
<td>65921</td>
<td>311823     </td>
</tr>
<tr>
<td>512</td>
<td>68160</td>
<td>261528     </td>
</tr>
<tr>
<td>1024</td>
<td>62480</td>
<td>203539     </td>
</tr>
<tr>
<td>1472</td>
<td>62233</td>
<td>171311     </td>
</tr>
<tr>
<td>2048</td>
<td>49457</td>
<td>46734      </td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>msg size bytes</th>
<th>UDP PP</th>
<th>UDP PP VMA </th>
</tr>
</thead>
<tbody>
<tr>
<td>256</td>
<td>9.474</td>
<td>3.201       </td>
</tr>
<tr>
<td>512</td>
<td>9.635</td>
<td>3.757       </td>
</tr>
<tr>
<td>1024</td>
<td>10.800</td>
<td>4.822       </td>
</tr>
<tr>
<td>1472</td>
<td>16.016</td>
<td>5.815           </td>
</tr>
<tr>
<td>2048</td>
<td>20.161</td>
<td>19.953      </td>
</tr>
</tbody>
</table>
<h4 id="netperf"><a href="#netperf" class="headerlink" title="netperf"></a>netperf</h4><p>numactl -C 2 netserver -D  -4 -v 2 -p 5000 -f -L 192.168.12.201<br>numactl -N 0 ./netperf -n 6 -p 5000 -H 192.168.12.201 -c -C -t TCP_STREAM -l 15 -T 2,2 – -m $((2<strong>$i))<br>numactl -N 0 ./netperf -n 6 -p 5000 -H 192.168.12.201 -c -C -t TCP_RR -l 20 -T 2,2 – -m $((2</strong>$i))<br>numactl -N 0 ./netperf -n 6 -p 5000 -H 192.168.12.201 -c -C -t UDP_RR -l 20 -T 2,2 – -m $((2**$i))</p>
<table>
<thead>
<tr>
<th>msg size bytes</th>
<th>TCP RR</th>
<th>TCP RR VMA</th>
<th>UDP RR</th>
<th>UDP RR VMA </th>
</tr>
</thead>
<tbody>
<tr>
<td>256</td>
<td>43428.69</td>
<td>129390.97</td>
<td>49805.09</td>
<td>146545.15  </td>
</tr>
<tr>
<td>512</td>
<td>37705.07</td>
<td>107808.85</td>
<td>46393.12</td>
<td>125839.11  </td>
</tr>
<tr>
<td>1024</td>
<td>35005.28</td>
<td>90787.06</td>
<td>39591.57</td>
<td>98669.99   </td>
</tr>
<tr>
<td>2048</td>
<td>23688.22</td>
<td>63992.85</td>
<td>22633.36</td>
<td>19961.70   </td>
</tr>
<tr>
<td>4096</td>
<td>22933.14</td>
<td>51851.17</td>
<td>20772.47</td>
<td>18604.53   </td>
</tr>
</tbody>
</table>
<h4 id="redis-benchmark"><a href="#redis-benchmark" class="headerlink" title="redis-benchmark"></a>redis-benchmark</h4><p>LD_PRELOAD=libvma.so VMA_STATS_FD_NUM=500 redis-server –port 7777  –protected-mode no –maxmemory 12000mb –maxmemory-samples 10 –maxmemory-policy allkeys-lru<br>numactl -C 2 redis-benchmark -r 10000000 -n 20000000 -t get,set,lpush,lpop -P 16 -q -h 192.168.12.201 -p 7777 -d 16</p>
<p>set/get/lpush/lpop records/s</p>
<table>
<thead>
<tr>
<th>size bytes</th>
<th>set</th>
<th>get</th>
<th>lpush</th>
<th>lpop</th>
<th>set vma</th>
<th>get vma</th>
<th>lpush vma</th>
<th>lpop vma   </th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>909628.44</td>
<td>995668.88</td>
<td>1125492.38</td>
<td>1092836.38</td>
<td>1051801.25</td>
<td>1383604.25</td>
<td>1427857.50</td>
<td>1412230.00 </td>
</tr>
<tr>
<td>16</td>
<td>877077.62</td>
<td>975181.56</td>
<td>1126506.75</td>
<td>1058537.12</td>
<td>960937.88</td>
<td>1332001.25</td>
<td>1403213.38</td>
<td>1408054.00 </td>
</tr>
<tr>
<td>64</td>
<td>765814.06</td>
<td>963205.56</td>
<td>881834.19</td>
<td>1040203.94</td>
<td>785360.88</td>
<td>1114082.00</td>
<td>1179384.38</td>
<td>1258890.88 </td>
</tr>
<tr>
<td>256</td>
<td>596801.12</td>
<td>714030.69</td>
<td>787928.94</td>
<td>864416.31</td>
<td>614420.50</td>
<td>943129.31</td>
<td>868847.50</td>
<td>970167.38  </td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>size bytes</th>
<th>set x4</th>
<th>get x4</th>
<th>lpush x4</th>
<th>lpop x4</th>
<th>set x4 vma</th>
<th>get x4</th>
<th>lpush x4</th>
<th>lpop x4   </th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>1179965.09</td>
<td>1580834.26</td>
<td>2055718.79</td>
<td>2001333.44</td>
<td>2432077.24</td>
<td>3466123.12</td>
<td>3255039.99</td>
<td>3349659.25</td>
</tr>
<tr>
<td>16</td>
<td>1205777.63</td>
<td>1656787.75</td>
<td>1685172.72</td>
<td>2167017.68</td>
<td>2212556.32</td>
<td>3204048.56</td>
<td>3243653</td>
<td>3355042</td>
</tr>
<tr>
<td>64</td>
<td>1125920.34</td>
<td>1491794.08</td>
<td>1603009.35</td>
<td>2040705.93</td>
<td>2004204.13</td>
<td>3079092.74</td>
<td>2744756.94</td>
<td>3079859.44</td>
</tr>
<tr>
<td>256</td>
<td>1172390.68</td>
<td>1236795.19</td>
<td>1024634.36</td>
<td>1474094.21</td>
<td>1717803</td>
<td>2521588</td>
<td>1659403.82</td>
<td>2402496.31</td>
</tr>
</tbody>
</table>
<p>Intel X540</p>
<table>
<thead>
<tr>
<th>size bytes</th>
<th>set x4</th>
<th>get x4</th>
<th>lpush x4</th>
<th>lpop x4   </th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>1512821.64</td>
<td>2118883.93</td>
<td>1834559.35</td>
<td>1960360.28</td>
</tr>
<tr>
<td>16</td>
<td>1449761.53</td>
<td>1851285.18</td>
<td>1910151.44</td>
<td>2017602.97</td>
</tr>
<tr>
<td>64</td>
<td>1199011.03</td>
<td>1773449.28</td>
<td>1612987.21</td>
<td>1806331.65</td>
</tr>
<tr>
<td>256</td>
<td>1097519.72</td>
<td>1121691.17</td>
<td>1145548.86</td>
<td>1398369.94</td>
</tr>
</tbody>
</table>
<p>ConnectX-3 </p>
<table>
<thead>
<tr>
<th>size bytes</th>
<th>set x4 VMA</th>
<th>get x4 VMA</th>
<th>lpush x4 VMA</th>
<th>lpop x4 VMA</th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>2455271.19</td>
<td>3476625.19</td>
<td>3360328.38</td>
<td>3401881.00</td>
</tr>
<tr>
<td>16</td>
<td>2461504.31</td>
<td>3309726.63</td>
<td>3224818.00</td>
<td>3322884.63</td>
</tr>
<tr>
<td>64</td>
<td>1954063.35</td>
<td>2876987.38</td>
<td>2729820.24</td>
<td>3035352.45</td>
</tr>
<tr>
<td>256</td>
<td>1498470.37</td>
<td>2356658.57</td>
<td>1650766.50</td>
<td>2362893.44</td>
</tr>
</tbody>
</table>
<p>Because not enough memory in single node, so I can’ t benchamrk 6xredis-server benchmark with 6xredis-benchmark<br>echo 1024 &gt; /proc/sys/net/core/somaxconn<br>vm.overcommit_memory = 1<br>echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled (reduce performance when you enable VMA, cancel)<br>13562:M 10 Jun 01:02:39.054 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.<br>13562:M 10 Jun 01:02:39.054 # Server started, Redis version 3.2.0<br>13562:M 10 Jun 01:02:39.054 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add ‘vm.overcommit_memory = 1’ to /etc/sysctl.conf and then reboot or run the command ‘sysctl vm.overcommit_memory=1’ for this to take effect.<br>13562:M 10 Jun 01:02:39.054 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command ‘echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled’ as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</p>
<ul>
<li>In VMA environment, if you disable Transparent Huge Pages, redis performance will decreased.</li>
</ul>
<h4 id="qperf"><a href="#qperf" class="headerlink" title="qperf"></a>qperf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> VMA PANIC: ib_ctx_handler73:ib_ctx_handler() ibv device 0x1523ee0 pd allocation failure (ibv context 0x15266d0) (errno=13 Permission denied)</span><br><span class="line">terminate called without an active exception</span><br><span class="line"> VMA PANIC: ib_ctx_handler73:ib_ctx_handler() ibv device 0x1523ee0 pd allocation failure (ibv context 0x15266d0) (errno=13 Permission denied)</span><br><span class="line">terminate called without an active exception</span><br><span class="line"> VMA PANIC: ib_ctx_handler73:ib_ctx_handler() ibv device 0x1523ee0 pd allocation failure (ibv context 0x15266d0) (errno=13 Permission denied)</span><br><span class="line">terminate called without an active exception</span><br></pre></td></tr></table></figure>
<p>###Another function<br><a href="http://www.intel.com/content/dam/www/public/us/en/documents/product-briefs/ethernet-x710-brief.pdf" target="_blank" rel="external">ethernet brief</a></p>
<p><a href="https://www.nas.nasa.gov/assets/pdf/papers/NAS_Technical_Report_NAS-2014-01.pdf" target="_blank" rel="external">Comparison of 40G RDMA and Traditional Ethernet Technologies</a><br><a href="http://www.mellanox.com/related-docs/prod_software/Performance_Tuning_Guide_for_Mellanox_Network_Adapters.pdf" target="_blank" rel="external">Performance Tuning Guidelines for Mellanox Network Adapters</a><br><a href="http://jaseywang.me/2013/11/02/10g82599eb-%E7%BD%91%E5%8D%A1%E6%B5%8B%E8%AF%95%E4%BC%98%E5%8C%96ethtool/" target="_blank" rel="external">10G 82599EB 网卡测试优化</a></p>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> nic </tag>
            
            <tag> Ethernet </tag>
            
            <tag> benchmark </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[About SSD power loss]]></title>
      <url>http://yoursite.com/2016/06/02/About-SSD-power-loss/</url>
      <content type="html"><![CDATA[<h3 id="Risks-of-unexpected-power-loss-on-solid-state-drives"><a href="#Risks-of-unexpected-power-loss-on-solid-state-drives" class="headerlink" title="Risks of unexpected power loss on solid state drives"></a><a href="http://www8.hp.com/h20195/v2/GetPDF.aspx/4AA6-1470ENW.pdf" target="_blank" rel="external">Risks of unexpected power loss on solid state drives</a></h3><p>Each time data is accessed or modified on the SSD, metadata is modified pertaining to the state of the data. This information allows for the storage controller to choose what data should be in the drive’s volatile cache at any given moment as well as the ability to implement techniques which increase performance and endurance</p>
<p>The drive then translates the LBA to the Physical Block Address (PBA) by way a flash translation table (FTL). The FTL is stored in cache and it is the responsibility of the controller to flush this table to non-volatile memory at times it deems appropriate or during a clean shutdown. The metadata associated with each page of data written also has information that can be used to rebuild the FTL if it is lost, but this rebuild takes time at the next power-on. If both the FTL and metadata are corrupted due to a sudden power loss event, the data stored on the SSD can become lost or even worse, the SSD, as a whole, can become inaccessible</p>
<p>Turning drive cache off<br>Pros: Data integrity is preserved in the event of a sudden power loss.<br>Cons: Dramatic decrease in read and write performance.<br>Increased writes to NAND resulting in lower write endurance and decreased drive life. FTL data is still stored in the volatile cache, which leaves it at risk</p>
<p>Capacitor hold-up circuitry<br>Pros: Data integrity is preserved in the event of a sudden power loss.<br>Cons: Increased cost due to inclusion of additional circuitry including capacitors. Additional board space is required.</p>
<h3 id="Dell-Solid-State-Drive-FAQ"><a href="#Dell-Solid-State-Drive-FAQ" class="headerlink" title="Dell Solid-State-Drive-FAQ"></a><a href="http://www.dell.com/downloads/global/products/pvaul/en/Solid-State-Drive-FAQ-us.pdf" target="_blank" rel="external">Dell Solid-State-Drive-FAQ</a></h3>]]></content>
      
        <categories>
            
            <category> Hardware </category>
            
        </categories>
        
        
        <tags>
            
            <tag> ssd </tag>
            
            <tag> power </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Trim (discard) support]]></title>
      <url>http://yoursite.com/2016/05/06/Trim-discard-support/</url>
      <content type="html"><![CDATA[<h3 id="Why-Trim"><a href="#Why-Trim" class="headerlink" title="Why Trim"></a><a href="https://en.wikipedia.org/wiki/Trim_(computing)" target="_blank" rel="external">Why Trim</a></h3><p>The Trim command is designed to enable the operating system to notify the SSD which pages no longer contain valid data due to erases either by the user or operating system itself. During a delete operation, the OS will mark the sectors as free for new data and send a Trim command to the SSD to mark them as not containing valid data. After that the SSD knows not to preserve the contents of the block when writing a page, resulting in less write amplification with fewer writes to the flash, higher write speed, and increased drive life.<br>Different SSDs implement the Trim command somewhat differently, so performance can vary.<br><img src="http://images.anandtech.com/reviews/storage/Intel/34nmSSD/Review/garbagecollection.png" alt=""></p>
<h3 id="SoftRaid"><a href="#SoftRaid" class="headerlink" title="SoftRaid"></a>SoftRaid</h3><h4 id="Openzfs-on-linux"><a href="#Openzfs-on-linux" class="headerlink" title="Openzfs on linux"></a>Openzfs on linux</h4><p><a href="https://github.com/zfsonlinux/zfs/pull/1016" target="_blank" rel="external">not support trim funtion</a><br><a href="http://list.zfsonlinux.org/pipermail/zfs-discuss/2016-January/024437.html" target="_blank" rel="external">expect to get a upgrade this year that will add TRIM support</a></p>
<h4 id="Trim-patch-for-ZOL"><a href="#Trim-patch-for-ZOL" class="headerlink" title="Trim patch for ZOL"></a>Trim patch for ZOL</h4><p><a href="https://github.com/zfsonlinux/zfs/pull/924" target="_blank" rel="external">DO NOT APPLY THIS PATCH IF YOU CARE ABOUT YOUR DATA</a></p>
<h4 id="Mdadm"><a href="#Mdadm" class="headerlink" title="Mdadm"></a>Mdadm</h4><p><a href="http://kernelnewbies.org/Linux_3.7#head-2fd9b183a4623d96e69ed24f88e0eb83217fa8df" target="_blank" rel="external">Since version 3.7 of the Linux kernel mainline, md supports TRIM operations for the underlying solid-state drives (SSDs), for linear, RAID 0, RAID 1, RAID 5 and RAID 10 layouts</a><br><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html-single/6.5_Release_Notes/" target="_blank" rel="external">CentOS 6.5 The mdadm tool now supports the TRIM commands for RAID0, RAID1, and RAID10.</a></p>
<h3 id="Hardware-Raid"><a href="#Hardware-Raid" class="headerlink" title="Hardware Raid"></a>Hardware Raid</h3><h4 id="LSI-Check-Interoperability-and-Compatibility"><a href="#LSI-Check-Interoperability-and-Compatibility" class="headerlink" title="LSI Check Interoperability and Compatibility"></a><a href="http://www.avagotech.com/support/interop-compatibility" target="_blank" rel="external">LSI Check Interoperability and Compatibility</a></h4><p><a href="http://docs.avagotech.com/docs-and-downloads/raid-controllers/MegaRAID_SAS_Gen3CompatibilityList.pdf" target="_blank" rel="external">MegaRAID SAS Gen3 Compatibility List</a><br><a href="http://docs.avagotech.com/docs-and-downloads/raid-controllers/raid-controllers-common-files/iMR_SAS_Gen3CompatibilityList.pdf" target="_blank" rel="external">iMR SAS Gen3 Compatibility List</a><br><a href="http://www.media-clone.net/v/vspfiles/downloads/LSI_6Gb_SAS_SATA_HBA_Compatibility_List.pdf" target="_blank" rel="external">LSI_6Gb_SAS_SATA_HBA Compatibility List</a><br>Just Compatibility, trim support not clean</p>
<h4 id="HP-Raid-support"><a href="#HP-Raid-support" class="headerlink" title="HP Raid support"></a>HP Raid support</h4><p><a href="http://h20195.www2.hp.com/V2/GetPDF.aspx/4AA5-8637ENW" target="_blank" rel="external">Is TRIM supported when using RAID with SSDs?</a><br><img src="/img/hp-trim-support.png" alt=""><br>Raid 1,10,0 could be support<br>Raid 1E,5,6 has not support</p>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> ssd </tag>
            
            <tag> raid </tag>
            
            <tag> zfs </tag>
            
            <tag> trim </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Raid in SSD]]></title>
      <url>http://yoursite.com/2016/04/25/Raid-in-SSD/</url>
      <content type="html"><![CDATA[<h3 id="Chipset-Bottlenecks-can-occur-SSDs-in-a-RAID"><a href="#Chipset-Bottlenecks-can-occur-SSDs-in-a-RAID" class="headerlink" title="Chipset Bottlenecks can occur SSDs in a RAID"></a>Chipset Bottlenecks can occur SSDs in a RAID</h3><p>Evaluate the I/O topology of the used machine and eliminate bottlenecks<br>e.g., distribute SSDs to multiple controllers</p>
<p>Where is your ssd connectted ?<br>Some sata/M.2 ports through DMI conencetted.<br><img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Intel_5_Series_architecture.png" alt=""></p>
<p>DMI bandwidth<br>DMI 2.0, introduced in 2011, doubles the data transfer rate to 2 GB/s with a ×4 link. It is used to link an Intel CPU with the Intel Platform Controller Hub (PCH), which supersedes the historic implementation of a separate northbridge and southbridge.</p>
<p>DMI 3.0, released in August 2015, allows the 8 GT/s transfer rate per lane, for a total of four lanes and <font color="green">3.93 GB/s</font> for the CPU–PCH link. It is used by two-chip variants of the Intel Skylake microprocessors, which are used in conjunction with Intel 100 Series chipsets</p>
<p>Popular server only DMI 2.0 shipset at 2016-04<br>For example<br><a href="http://www.supermicro.com/products/system/1U/1028/SYS-1028U-E1CR4_.cfm" target="_blank" rel="external">Supermicro 1028U-E1CR4+</a><br><a href="http://www.supermicro.com/products/system/1U/1028/SYS-1028U-TN10RT_.cfm" target="_blank" rel="external">Same with 1028U-TN10RT+</a><br><a href="http://ark.intel.com/products/81759/Intel-DH82029-PCH" target="_blank" rel="external">Intel C612 chipset</a></p>
<h3 id="Enterprise-class-hardware-RAID-controllers-IOPS-bottlenecks"><a href="#Enterprise-class-hardware-RAID-controllers-IOPS-bottlenecks" class="headerlink" title="Enterprise-class hardware RAID controllers IOPS bottlenecks"></a>Enterprise-class hardware RAID controllers IOPS bottlenecks</h3><ul>
<li>Use software RAID to overcome the performance limitations of hardware RAID</li>
<li>Bottlenecks in software RAID implementations can still occur though at higher performance level</li>
</ul>
<h3 id="Asymmetry-between-Read-Write-Speed"><a href="#Asymmetry-between-Read-Write-Speed" class="headerlink" title="Asymmetry between Read/Write Speed"></a>Asymmetry between Read/Write Speed</h3><ul>
<li>Reading flash pages faster than writing</li>
<li>Writes in parity-based RAIDs slower than reads due to Read-Modify-Write operations</li>
<li>Effects can accumulate Even faster reads and slower writes</li>
</ul>
<h3 id="Synchronous-SSD-Aging"><a href="#Synchronous-SSD-Aging" class="headerlink" title="Synchronous SSD Aging"></a>Synchronous SSD Aging</h3><ul>
<li>SSDs have limited number of erase cycles<ul>
<li>Lifespan of SSD depends on write workload</li>
</ul>
</li>
<li>In RAIDs writes often distributed equally to all drives<ul>
<li>Multiple drives may wear out at the same time </li>
</ul>
</li>
</ul>
<p>If broken ssd just read only ,that is fine<br>Until 2016, I think write endurance is not problem.</p>
<h3 id="Workload-History-Dependency"><a href="#Workload-History-Dependency" class="headerlink" title="Workload History Dependency"></a>Workload History Dependency</h3><ul>
<li>Increase spare capacity to ensure that enough free flash blocks will be available anytime</li>
<li>Garbage collector</li>
<li>Write amplification</li>
</ul>
<p>OP (Over Provisioning) is very important for Garbage collector and write amplification</p>
<p>More OP, More perforamnce, Lower fragments(Lower write amplification), More write endurance….</p>
<p><a href="http://www.anandtech.com/show/8954/intel-launches-ssd-dc-s3610-s3710-enterprise-ssds" target="_blank" rel="external">There’s a difference in over-provisioning levels too as the S3710 features a higher 30-40% over-provisioning with the S3610 having only 10-20%, in both models the exact over-provisioning depends on the capacity</a></p>
<p><a href="http://www.anandtech.com/show/9455/samsung-releases-pm863-sm863-enterprise-sata-ssds-up-to-384tb-with-3d-vnand" target="_blank" rel="external">The SM863 actually provides lower random write performance than the 845DC PRO, which is due to the reduced default over-provisioning as the SM863 only has 12% compared to 28% in the 845DC PRO</a></p>
<p><img src="http://www.ssdfans.com/wp-content/uploads/2016/04/041316_0813_FTLOP12.png" alt=""></p>
<h3 id="Benchmark"><a href="#Benchmark" class="headerlink" title="Benchmark"></a>Benchmark</h3><p><a href="http://www.tomshardware.com/reviews/ssd-dc-s3500-raid-performance,3613-7.html" target="_blank" rel="external">6x dc s3500 raid performance</a><br><a href="http://www.phoronix.com/scan.php?page=article&amp;item=linux_raid_fs4&amp;num=1" target="_blank" rel="external">4x intel 530 raid performance</a></p>
<p>In intel’ s <a href="http://www.intel.com/content/dam/www/public/us/en/documents/white-papers/ssd-server-storage-applications-paper.pdf" target="_blank" rel="external">ssd-server-storage-applications-paper</a><br>The document said “With SSDs, RAID level selection criteria are similar to HDDs. However, because of shorter rebuild times under load and lower performance cost of reads during Read-Modify-Write operations, RAID 5/6/50/60 may be more effective in some applications that traditionally would require the use of RAID 10 with HDDs.”</p>
<p>Does it means you could run SSDs in raid 50/60 (intel hardware) ?</p>
<h3 id="Congfiguration"><a href="#Congfiguration" class="headerlink" title="Congfiguration"></a>Congfiguration</h3><h4 id="Posix-file-system"><a href="#Posix-file-system" class="headerlink" title="Posix file system"></a>Posix file system</h4><p>kernel version &gt; 3.7 (ext4,btrfs,xfs,jfs)<br>add “discard” tag on each partition of the SSD<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/dev/sda1 / ext4 defaults,noatime,discard 0 1</span><br></pre></td></tr></table></figure></p>
<h4 id="Secure-Erase"><a href="#Secure-Erase" class="headerlink" title="Secure Erase"></a>Secure Erase</h4><p>wiping out all fragmentation and physically erasing all NAND blocks<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hdparm --user-master master --security-set-pass password /dev/sdX</span><br><span class="line">hdparm --user-master master --security-erase password /dev/sdX</span><br><span class="line">hdparm -Np468862128 /dev/sdX <span class="comment">#PIO mode</span></span><br><span class="line">&lt;Power cycle the drive&gt;</span><br></pre></td></tr></table></figure></p>
<p>ATA defines two classes of transfer mode, called PIO Mode (Programmed I/O Mode) and DMA Mode (Direct Memory Access Mode). PIO mode transfers are much slower and require the processor to arbitrate transfers between the device and memory. DMA mode transfers are much faster and occur without processor intervention</p>
<h4 id="Enable-HPA-not-Recommended"><a href="#Enable-HPA-not-Recommended" class="headerlink" title="Enable HPA (not Recommended)"></a>Enable HPA (not Recommended)</h4><p>(Recommended) Create partition(s) that occupy only the desired usable capacity and leave the<br>remaining capacity unused</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">User Capacity:    900,184,411,136 bytes [900 GB]</span><br><span class="line">awk <span class="string">'BEGIN&#123;print 900184411136/1024/1024/1024&#125;'</span></span><br><span class="line">838.362</span><br><span class="line">hdparm -N /dev/sdb</span><br><span class="line">max sectors = 1953525168/1953525168, HPA is disabled</span><br><span class="line">awk <span class="string">'BEGIN&#123;print 1953525168*512/1024/1024/1024&#125;'</span></span><br><span class="line">931.513</span><br><span class="line"><span class="comment"># Setting 80% could be used, improve OP capacity</span></span><br><span class="line">awk <span class="string">'BEGIN&#123;printf "%0.2f",1953525168*0.8&#125;'</span></span><br><span class="line">1562820134.40</span><br><span class="line">hdparm -Np1562820134 --yes-i-know-what-i-am-doing /dev/sdb</span><br><span class="line"> setting max visible sectors to 1562820134 (permanent)</span><br><span class="line"> max sectors   = 1562820134/1953525168, HPA is enabled</span><br><span class="line"></span><br><span class="line"><span class="comment">#Available space</span></span><br><span class="line">awk <span class="string">'BEGIN&#123;print 1562820134*512/1024/1024/1024&#125;'</span></span><br><span class="line">745.211</span><br></pre></td></tr></table></figure>
<h4 id="Enable-HPA-in-Kernel-Boot-Parameters"><a href="#Enable-HPA-in-Kernel-Boot-Parameters" class="headerlink" title="Enable HPA in Kernel Boot Parameters"></a><a href="http://redsymbol.net/linux-kernel-boot-parameters/" target="_blank" rel="external">Enable HPA in Kernel Boot Parameters</a></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">libata.ignore_hpa=      [LIBATA] Ignore HPA limit</span><br><span class="line">                        libata.ignore_hpa=0       keep BIOS limits (default)</span><br><span class="line">                        libata.ignore_hpa=1       ignore limits, using full disk</span><br></pre></td></tr></table></figure>
<p>or<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 1 &gt; /sys/module/libata/parameters/ignore_hpa</span><br><span class="line"><span class="built_in">echo</span> options libata ignore_hpa=1 &gt; /etc/modprobe.d/libata.conf</span><br></pre></td></tr></table></figure></p>
<p><a href="https://www.thomas-krenn.com/en/wiki/SSD_Over-provisioning_using_hdparm" target="_blank" rel="external">HPA reference</a></p>
<h4 id="Use-Direct-IO"><a href="#Use-Direct-IO" class="headerlink" title="Use Direct IO"></a>Use Direct IO</h4><p>With SSDs in Linux* using direct IO instead of buffered IO is recommended, when possible. The Linux<br>IO subsystem provides read and write buffering at the block device level. In most cases, buffering is<br>undesirable with SSDs for the following reasons:</p>
<ul>
<li>SSDs have lower latencies than HDDs, therefore the benefits of buffering are reduced.</li>
<li>Buffering read IOs consumes extra CPU cycles for memory copy operations. At IO rates typical for<br>SSDs, this extra CPU consumption may be high and create a read performance bottleneck.<br>To use direct IO and bypass the buffer, software can set O_DIRECT flag when opening a file. Many<br>applications and test tools have configurable options that allow selecting direct or buffered IO, for<br>example:</li>
<li>FIO* utility: use ‘–direct=1’ option</li>
<li>MySQL InnoDB*: use ‘–innodb_flush_method=O_DIRECT’ option</li>
<li>Oracle* 10g/11g: use ‘filesystemio_options = SETALL’ or<br>‘filesystemio_options = DIRECTIO’</li>
</ul>
<h4 id="echo-noop-gt-sys-block-sdX-queue-scheduler"><a href="#echo-noop-gt-sys-block-sdX-queue-scheduler" class="headerlink" title="echo noop &gt; /sys/block/sdX/queue/scheduler"></a>echo noop &gt; /sys/block/sdX/queue/scheduler</h4><h4 id="Raid-setting"><a href="#Raid-setting" class="headerlink" title="Raid setting"></a>Raid setting</h4><p>To optimize the speed of random IOPS, stripe unit size should be at least 2X of the typical transfer size used by the application. This minimizes the frequency of transfers crossing the stripe boundaries and writing to more than one drive at a time. If the files and transfers are aligned on the stripe boundaries, the stripe size can be set to be equal to the typical transfer size.</p>
<p>In large RAID sets, you must verify that your stripe size is large enough so that the stripe per drive is<br>not less than 4KB. To calculate the smallest stripe:<br>4096 X Number_of_Striped_Drives = Smallest_Stripe_Size<br>For higher sequential bandwidth with applications that cannot use IO queuing, the following stripe unit<br>size or smaller should be used:<br>0.5 x Transfer_size / Number_of_striped_drives</p>
<h4 id="How-small-files-save-to-Raid-stripe"><a href="#How-small-files-save-to-Raid-stripe" class="headerlink" title="How small files save to Raid stripe"></a><a href="https://communities.intel.com/thread/17622?tstart=0" target="_blank" rel="external">How small files save to Raid stripe</a></h4><p>That same with what I guess. I ‘m so glad :)</p>
<p>Again please remember that you can write multiple data blocks into one strip. Strip is not the smallest storage unit size on the disk.</p>
<p>Let’s take your example. we have a 32KB file and a 96KB file. On the file system they’re stored in a total of 4 clusters, if you have a 32KB cluster. Let’s say you have a 64KB strip size on RAID controller, and let’s assume it’s a sequential write. The first file will be written on the first 32KB of the strip on the first disk. Then the first 32KB of the 2nd file will be written to the rest 32KB of the strip on the first disk. The remaining 64KB goes to the strip on the second disk.</p>
<p>Now let’s change the example a little bit, with multiple (let’s say eight) 8KB files, 32KB cluster size and 64KB strip size. because of the 32KB cluster size, each 8KB file will use 32KB on your file system. Each 64KB strip can still take two 32KB clusters, so you’re using four strips in total, two on each drive. But you’re wasting 24KB * 8 = 192KB drive space here.</p>
<p>What if your cluster size is 4KB? Each 8KB file will take two clusters, and all 8 files can be stored in one 64KB strip.</p>
<p>What about a 1KB file? If you have a 4KB cluster size and 64KB strip size, you still have 60KB on the strip left for other files, wasting 3KB here, which is inevitable. But if you have a 32KB cluster size, you’ll have only 32KB on the strip left for other files, wasting 31KB.</p>
<p>Using RAID Write-Back Caching (BBU)<br>Disabling RAID Read Ahead, except sequential read bandwidth with single threaded applications<br>Disabling RAID Read Cache, read caching consumes RAID memory that could be used by write-back caching.<br><a href="http://www.intel.com/content/dam/www/public/us/en/documents/white-papers/ssd-server-storage-applications-paper.pdf" target="_blank" rel="external">For more info</a></p>
<h4 id="How-stripe-size"><a href="#How-stripe-size" class="headerlink" title="How stripe size"></a>How stripe size</h4><p><a href="http://www.research.ibm.com/haifa/conferences/systor2011/present/session5_talk2_systor2011.pdf" target="_blank" rel="external">Reference</a><br><a href="https://en.wikipedia.org/wiki/Direct_Media_Interface" target="_blank" rel="external">Reference</a><br><a href="http://www.ssdfans.com/?p=1840" target="_blank" rel="external">Garbage collector  Reference</a><br><a href="https://en.wikipedia.org/wiki/Write_amplification#BG-GC" target="_blank" rel="external">Garbage collector  Reference</a></p>
]]></content>
      
        <categories>
            
            <category> Hardware </category>
            
        </categories>
        
        
        <tags>
            
            <tag> ssd </tag>
            
            <tag> raid </tag>
            
            <tag> interface </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Partition alignment]]></title>
      <url>http://yoursite.com/2016/04/20/SSD-partition-alignment/</url>
      <content type="html"><![CDATA[<h3 id="Intel-Reference"><a href="#Intel-Reference" class="headerlink" title="Intel Reference"></a><a href="http://www.intel.com/content/dam/www/public/us/en/documents/technology-briefs/ssd-partition-alignment-tech-brief.pdf" target="_blank" rel="external">Intel Reference</a></h3><p>The default file system for Windows Server 2003, NTFS, uses 4 KB clusters by default.<br>Traditionally,these 4KB clusters take up 8 – 512 Byte sectors. With Intel SSDs, 1 - NTFS cluster takes up less than one NAND page when alignment is correct.<br>When the alignment is not correct, some of the 4 KB clusters will write across 2 NAND pages. </p>
<p>This is illustrated in Figure 1 using 4 KB pages for clarity:</p>
<p>With an offset of 63 sectors, the first 31.5 KB of drive space is left blank. Then Windows begins to<br>write clusters, but the physical page of the SSD ends at 32 KB.<br>Therefore, the cluster is split across 2 pages: 512 Bytes written on the first, 3.5 KB written on the next. </p>
<p>This has a cumulative effect as each subsequent page boundary that is written will have a cluster split across it. Figure 2–1 shows a misaligned partition, figure 2–2 shows a partition properly aligned at 1MB.</p>
<p><img src="/img/ssd-alignment.png" alt=""></p>
<h3 id="Linux-cmd"><a href="#Linux-cmd" class="headerlink" title="Linux cmd"></a>Linux cmd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 2048s = 1MB</span></span><br><span class="line"></span><br><span class="line">$ parted /dev/sda unit s <span class="built_in">print</span></span><br><span class="line">Model: ATA INTEL SSDSC2BW12 (scsi)</span><br><span class="line">Disk /dev/sda: 234441648s</span><br><span class="line">Sector size (logical/physical): 512B/512B</span><br><span class="line">Partition Table: msdos</span><br><span class="line">Disk Flags: </span><br><span class="line"></span><br><span class="line">Number  Start       End         Size        Type     File system  Flags</span><br><span class="line"> 1      2048s       148072447s  148070400s  primary  ntfs         boot</span><br><span class="line"> 2      148072448s  189673471s  41601024s   primary  ext4</span><br><span class="line"> 3      189673472s  234441647s  44768176s   primary  ext4</span><br><span class="line"></span><br><span class="line">parted /dev/sdxx</span><br><span class="line">(parted) <span class="built_in">set</span> 1 boot on</span><br><span class="line"></span><br><span class="line"><span class="comment">#or you can </span></span><br><span class="line">$ parted <span class="_">-a</span> optimal /dev/sdxx mkpart primary 2048s 100%</span><br></pre></td></tr></table></figure>
<h3 id="mkfs-HDD-raid"><a href="#mkfs-HDD-raid" class="headerlink" title="mkfs HDD raid"></a>mkfs HDD raid</h3><h4 id="ext4"><a href="#ext4" class="headerlink" title="ext4"></a>ext4</h4><p>11 HDD + 1HDD HS Raid6 stripe-size=128K, 11-2p=9, if you stride=9<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ parted <span class="_">-a</span> optimal /dev/sdxx mkpart primary 2048s 100%</span><br></pre></td></tr></table></figure></p>
<p>Warning: RAID stripe-width 128 not an even multiple of stride 9. 128%9=2 128%8=0 ??</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mkfs.ext4 -E stride=8,stripe-width=128,lazy_itable_init=0,lazy_journal_init=0 /dev/sdxx1</span><br></pre></td></tr></table></figure>
<h4 id="xfs"><a href="#xfs" class="headerlink" title="xfs"></a>xfs</h4><p>Raid 60  24 HDD ，12HDD/per raid6   （12-2）× 2 ， Raid stripe size 64KB<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkfs.xfs <span class="_">-f</span> <span class="_">-d</span> sunit=64,swidth=$((64*20)) /dev/sdxx1</span><br></pre></td></tr></table></figure></p>
<h4 id="Kernel-io-schdule-Read-ahead"><a href="#Kernel-io-schdule-Read-ahead" class="headerlink" title="Kernel io schdule Read ahead"></a>Kernel io schdule Read ahead</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 1024 &gt; /sys/block/sdb/queue/<span class="built_in">read</span>_ahead_kb</span><br></pre></td></tr></table></figure>
<h4 id="increasing-the-maximal-I-O-queue-size-nr-requests"><a href="#increasing-the-maximal-I-O-queue-size-nr-requests" class="headerlink" title="increasing the maximal I/O queue size (nr_requests)"></a>increasing the maximal I/O queue size (nr_requests)</h4><p>Improve raid volume bandwidth (raid 6, 11x15k HDDs + 1HS)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 2048 &gt; /sys/block/sdb/queue/nr_requests</span><br></pre></td></tr></table></figure></p>
]]></content>
      
        <categories>
            
            <category> Hardware </category>
            
        </categories>
        
        
        <tags>
            
            <tag> ssd </tag>
            
            <tag> parted </tag>
            
            <tag> mkfs </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[golang io.reader to string]]></title>
      <url>http://yoursite.com/2016/04/12/golang-io-reader-to-string/</url>
      <content type="html"><![CDATA[<p>###Reader to string<br><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">buf := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">buf.ReadFrom(yourReader)</span><br><span class="line">s := buf.String() <span class="comment">// Does a complete copy of the bytes in the buffer.</span></span><br><span class="line"></span><br><span class="line">buf := <span class="built_in">new</span>(bytes.Buffer)</span><br><span class="line">buf.ReadFrom(yourReader)</span><br><span class="line">b := buf.Bytes()</span><br><span class="line">s := *(*<span class="keyword">string</span>)(unsafe.Pointer(&amp;b))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> b, err := ioutil.ReadAll(rc); err == <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">string</span>(b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">or gzip the buffer</span><br><span class="line">   raw := bytes.NewBuffer(data)</span><br><span class="line">   unz, err := gzip.NewReader(raw)</span><br><span class="line">   buf, err := ioutil.ReadAll(unz)</span><br><span class="line">   <span class="keyword">return</span> json.Unmarshal(buf, &amp;v)</span><br></pre></td></tr></table></figure></p>
<h3 id="string-to-reader"><a href="#string-to-reader" class="headerlink" title="string to reader"></a>string to reader</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">	r:=strings.NewReader(<span class="string">"(1,2,34,55,666)"</span>)</span><br><span class="line">	<span class="keyword">var</span> d [<span class="number">5</span>]<span class="keyword">int</span></span><br><span class="line">	fmt.Fscanf(r,<span class="string">"(%d,%d,%d,%d,%d)"</span>,&amp;d[<span class="number">0</span>],&amp;d[<span class="number">1</span>],&amp;d[<span class="number">2</span>],&amp;d[<span class="number">3</span>],&amp;d[<span class="number">4</span>])</span><br><span class="line">	fmt.Println(d)</span><br><span class="line">or </span><br><span class="line"></span><br><span class="line">	buf := bytes.NewBufferString(<span class="string">"R29waGVycyBydWxlIQ=="</span>)</span><br><span class="line">	dec := base64.NewDecoder(base64.StdEncoding, buf)</span><br><span class="line">	io.Copy(os.Stdout, dec)</span><br></pre></td></tr></table></figure>
<h3 id="Ouput-to-stdout"><a href="#Ouput-to-stdout" class="headerlink" title="Ouput to stdout"></a>Ouput to stdout</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">reader := bufio.NewReader(os.Stdin)</span><br><span class="line">fmt.Print(<span class="string">"What is your name:"</span>)</span><br><span class="line">data, _, _ := reader.ReadLine()</span><br><span class="line">fmt.Printf(<span class="string">"Your name is %s.\r\n"</span>, data)</span><br></pre></td></tr></table></figure>
<p><a href="http://stackoverflow.com/questions/9644139/from-io-reader-to-string-in-go" target="_blank" rel="external">reference</a><br><a href="https://www.datadoghq.com/blog/crossing-streams-love-letter-gos-io-reader/" target="_blank" rel="external">reference</a></p>
]]></content>
      
        <categories>
            
            <category> golang </category>
            
        </categories>
        
        
        <tags>
            
            <tag> golang </tag>
            
            <tag> string </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[SFP+ VS 10GBaseT]]></title>
      <url>http://yoursite.com/2016/04/08/SFP-VS-10GBaseT/</url>
      <content type="html"><![CDATA[<h3 id="reference"><a href="#reference" class="headerlink" title="reference"></a><a href="http://www.missioncriticalmagazine.com/ext/resources/MC/Home/Files/PDFs/WP_Blade_Ethernet_Cabling.pdf" target="_blank" rel="external">reference</a></h3><p><img src="/img/sfp-10bt-1.png" alt=""><br><img src="/img/sfp-10bt-2.png" alt=""></p>
]]></content>
      
        <categories>
            
            <category> Hardware </category>
            
        </categories>
        
        
        <tags>
            
            <tag> network </tag>
            
            <tag> interface </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[SSD Interface]]></title>
      <url>http://yoursite.com/2016/04/08/SSD-interface/</url>
      <content type="html"><![CDATA[<h3 id="Interface-reference"><a href="#Interface-reference" class="headerlink" title="Interface reference"></a><a href="http://www.nvmexpress.org/wp-content/uploads/NVMe_Infrastructure_final1.pdf" target="_blank" rel="external">Interface reference</a></h3><p><img src="/img/nvme-1.png" alt=""><br><img src="/img/nvme-2.png" alt=""><br><img src="/img/nvme-3.png" alt=""><br><img src="/img/nvme-4.png" alt=""><br><img src="/img/nvme-5.png" alt=""><br><img src="/img/nvme-6.png" alt=""><br><img src="/img/nvme-7.png" alt=""><br><img src="/img/nvme-8.png" alt=""><br><img src="/img/nvme-9.png" alt=""><br><img src="/img/nvme-10.png" alt=""><br><img src="/img/nvme-11.png" alt=""></p>
<h3 id="supermicro-benchmark"><a href="#supermicro-benchmark" class="headerlink" title="supermicro benchmark"></a><a href="https://www.supermicro.com/white_paper/white_paper_NVMe.pdf" target="_blank" rel="external">supermicro benchmark</a></h3><p><img src="/img/nvme-12.png" alt=""></p>
]]></content>
      
        <categories>
            
            <category> Hardware </category>
            
        </categories>
        
        
        <tags>
            
            <tag> ssd </tag>
            
            <tag> interface </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Lustre operations]]></title>
      <url>http://yoursite.com/2016/04/06/Lustre-operations/</url>
      <content type="html"><![CDATA[<h3 id="Dump-log"><a href="#Dump-log" class="headerlink" title="Dump log"></a>Dump log</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">lctl <span class="built_in">set</span>_param printk=+neterror</span><br><span class="line"></span><br><span class="line">lctl get_param panic_on_lbug</span><br><span class="line">panic_on_lbug=1</span><br><span class="line"><span class="comment">#if not =1</span></span><br><span class="line">lctl <span class="built_in">set</span>_param panic_on_lbug=1</span><br><span class="line"></span><br><span class="line">lctl <span class="built_in">set</span>_param debug=-1</span><br><span class="line">lctl clear</span><br><span class="line">lctl mark <span class="string">"start mount"</span></span><br><span class="line">mount -t lustre xx.xx.xx.xx@tcp:/fsname /fsname <span class="comment"># or the other operate  </span></span><br><span class="line">lctl mark <span class="string">"Finish mount"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">lctl <span class="built_in">set</span>_param debug_mb=50</span><br><span class="line">lctl <span class="built_in">set</span>_param debug=+trace</span><br><span class="line">lctl dk &gt;/dev/null</span><br><span class="line">ls /opt/lustrewh/pmo</span><br><span class="line">lctl dk&gt; [filename]</span><br><span class="line"></span><br><span class="line"><span class="comment"># MDS, OSS, Client</span></span><br><span class="line">lctl dk filename</span><br><span class="line"></span><br><span class="line"><span class="comment"># in MDS</span></span><br><span class="line">mount -t lustre /dev/sdb1 /mnt/mds;</span><br><span class="line">mount -t ldiskfs /dev/sdb1 /mnt/ldiskfs;</span><br><span class="line">llog_reader /mnt/ldiskfs/CONFIGS/lustre2T-MDT0000 | grep pool</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example of using debug_daemon and interactive lctl to dump debug files to a 40 MB file:</span></span><br><span class="line">lctl</span><br><span class="line">lctl &gt; debug_daemon start /var/<span class="built_in">log</span>/lustre.40.bin 40</span><br><span class="line">&lt;run filesystem operation(s) to debug (outside of the lctl session)&gt;</span><br><span class="line">lctl &gt; debug_daemon stop</span><br><span class="line">lctl &gt; debug_file /var/<span class="built_in">log</span>/lustre.40.bin /var/<span class="built_in">log</span>/lustre.log</span><br><span class="line"></span><br><span class="line">dmesg -C </span><br><span class="line"><span class="built_in">echo</span> t &gt; /proc/sysrq-trigger</span><br><span class="line">dmesg &gt; dmesg-t-sysrq.mds</span><br><span class="line"></span><br><span class="line">cat /proc/D_state_pid/wchan</span><br><span class="line">cat /proc/D_state_pid/stack</span><br><span class="line"></span><br><span class="line">lctl --device MGS llog_<span class="built_in">print</span> \$<span class="variable">$fsname</span>-client</span><br></pre></td></tr></table></figure>
<h3 id="OST-rpc-info"><a href="#OST-rpc-info" class="headerlink" title="OST rpc info"></a>OST rpc info</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/fs/lustre/osc/lustre-OST0031-osc-ffff88103a993000/import</span><br></pre></td></tr></table></figure>
<h3 id="Changelog"><a href="#Changelog" class="headerlink" title="Changelog"></a>Changelog</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Disable changelog</span></span><br><span class="line">lctl <span class="built_in">set</span>_param mdd.<span class="variable">$fsname</span>-MDT0000.changelog_mask=-all</span><br><span class="line"><span class="comment">#Create user</span></span><br><span class="line">lctl --device zfsz3-MDT0000 changelog_register</span><br><span class="line"><span class="comment">#Del user</span></span><br><span class="line">lctl --device zfsz3-MDT0000 changelog_deregister cl1</span><br><span class="line"><span class="comment">#Get size</span></span><br><span class="line">lctl get_param mdd.zfsz3-MDT0000.changelog_users mdd.zfsz3-MDT0000.changelog_size</span><br><span class="line"><span class="comment">#changelog type</span></span><br><span class="line">lctl <span class="built_in">set</span>_param mdd.lustrefs-MDT*.changelog_mask <span class="string">"MARK CREAT MKDIR HLINK SLINK MKNOD UNLNK RMDIR RENME RNMTO OPEN LYOUT TRUNC SATTR XATTR HSM MTIME CTIME"</span></span><br><span class="line">lctl get_param mdd.lustrefs-MDT*.changelog_mask </span><br><span class="line">MARK CREAT MKDIR HLINK SLINK MKNOD UNLNK RMDIR RENME RNMTO OPEN LYOUT TRUNC SATTR XATTR HSM MTIME CTIME</span><br></pre></td></tr></table></figure>
<h3 id="Set-timeout"><a href="#Set-timeout" class="headerlink" title="Set timeout"></a>Set timeout</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lctl conf_param -P timeout=300</span><br></pre></td></tr></table></figure>
<h3 id="Get-timeout-and-state"><a href="#Get-timeout-and-state" class="headerlink" title="Get timeout and state"></a>Get timeout and state</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ lctl get_param osc.*OST0012*.&#123;state,timeouts&#125;</span><br><span class="line">$ lctl get_param at_* timeout</span><br></pre></td></tr></table></figure>
<h3 id="Kdump"><a href="#Kdump" class="headerlink" title="Kdump"></a>Kdump</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">yum -y install kexec-tools</span><br><span class="line">cat /etc/kdump.conf</span><br><span class="line">nfs my.nfsserver.example.org:/path/to/expor</span><br><span class="line">core_collector makedumpfile <span class="_">-d</span> 16 -c</span><br><span class="line"><span class="comment">#-c Compress dump data by each page</span></span><br><span class="line"><span class="comment">#core_collector makedumpfile -d 16 -c message_level 16</span></span><br><span class="line"><span class="comment"># 1 Zero Pages 2 Cache Pages 4 Cache Private 8 User Pages 16 Free Pages</span></span><br><span class="line"><span class="comment"># 1 Progress Indicators 2 Common Messages 4 Error Messages 8 Debug Messages 16 Report Messages</span></span><br><span class="line"><span class="comment">#ssh user@my.server.example.org:/dest/path</span></span><br><span class="line"><span class="comment">#By default, uses ssh key at /root/.ssh/kdump_id_rsa</span></span><br><span class="line"><span class="comment">#core_collector makedumpfile &lt;options&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="Enable-changlog"><a href="#Enable-changlog" class="headerlink" title="Enable changlog"></a>Enable changlog</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lctl <span class="built_in">set</span>_param mdt.<span class="variable">$FSNAME</span>-MDT0000.hsm_control=enabled</span><br><span class="line">lctl <span class="built_in">set</span>_param -P  mdt.lustresz-MDT0000.hsm_control=enabled</span><br><span class="line"> lctl <span class="built_in">set</span>_param mdt.<span class="variable">$FSNAME</span>-MDT0000.hsm.max_requests=64</span><br></pre></td></tr></table></figure>
<h3 id="Fsck-ldiskfs-file-system-corruption"><a href="#Fsck-ldiskfs-file-system-corruption" class="headerlink" title="Fsck ldiskfs file system corruption"></a>Fsck ldiskfs file system corruption</h3><h4 id="Errors"><a href="#Errors" class="headerlink" title="Errors"></a>Errors</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Dec <span class="number">29</span> <span class="number">14</span>:<span class="number">11</span>:<span class="number">32</span> mookie kernel: LDISKFS-fs error (device sdz): ldiskfs_lookup: unlinked inode <span class="number">5384166</span> in dir <span class="comment">#145170469</span></span><br><span class="line">Dec <span class="number">29</span> <span class="number">14</span>:<span class="number">11</span>:<span class="number">32</span> mookie kernel: Remounting filesystem read-only</span><br></pre></td></tr></table></figure>
<h4 id="Flush-the-journal"><a href="#Flush-the-journal" class="headerlink" title="Flush the journal"></a>Flush the journal</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ umount /ostxx</span><br><span class="line">$ mount -t ldiskfs /dev/sdx /mnt/ost</span><br><span class="line">$ umount /mnt/ost</span><br></pre></td></tr></table></figure>
<h4 id="Caution"><a href="#Caution" class="headerlink" title="Caution"></a>Caution</h4><ul>
<li><p>Ensure e2fsprogs version ,it ‘s not default linux version ,it ‘s lustre version</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa | grep e2fsprogs</span><br><span class="line">e2fsprogs-1.42.12.wc1-7.el6.x86_64</span><br><span class="line">e2fsprogs-libs-1.42.12.wc1-7.el6.x86_64</span><br></pre></td></tr></table></figure>
</li>
<li><p>Before fsck，make sure the mount point has been <font color="red">umount</font></p>
</li>
<li>Can check multiple MDT/OSTs in parallel</li>
</ul>
<h4 id="Check-only-mode"><a href="#Check-only-mode" class="headerlink" title="Check only mode"></a>Check only mode</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ e2fsck -fn /dev/sdx</span><br></pre></td></tr></table></figure>
<h4 id="Prudent-mode"><a href="#Prudent-mode" class="headerlink" title="Prudent mode"></a>Prudent mode</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ e2fsck -fp /dev/sdx</span><br></pre></td></tr></table></figure>
<h4 id="Answer-yes"><a href="#Answer-yes" class="headerlink" title="Answer yes"></a>Answer yes</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ e2fsck -fy /dev/sdx</span><br></pre></td></tr></table></figure>
<h3 id="Storage-target-could-not-mount-mount-lustre-failed"><a href="#Storage-target-could-not-mount-mount-lustre-failed" class="headerlink" title="Storage target could not mount (mount.lustre failed)"></a>Storage target could not mount (mount.lustre failed)</h3><h4 id="Caution-1"><a href="#Caution-1" class="headerlink" title="Caution"></a>Caution</h4><ul>
<li><font color="red">umount</font> all clients</li>
<li><font color="red">umount</font> all MGS,MDT,OSTs</li>
<li>ensure Lustre backing file systems are healthy ( fsck )</li>
</ul>
<h4 id="Writeconf"><a href="#Writeconf" class="headerlink" title="Writeconf"></a>Writeconf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mds<span class="comment"># tunefs.lustre --writeconf /dev/sdx</span></span><br><span class="line">oss<span class="comment"># tunefs.lustre --writeconf /dev/ost0</span></span><br><span class="line">oss<span class="comment"># tunefs.lustre --writeconf /dev/ost1</span></span><br><span class="line">oss<span class="comment"># tunefs.lustre --writeconf /dev/ost2</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<h4 id="Mount"><a href="#Mount" class="headerlink" title="Mount"></a>Mount</h4><ul>
<li>When you writeconf operation complete, mount MGS,MDT,OSTs,clients<ul>
<li>If MGS and MDT in single block device, you can add “-o nosvc” to avoid mount MDT</li>
</ul>
</li>
</ul>
<h3 id="Flush-all-of-the-metadata-client-mdc-locks-on-this-node"><a href="#Flush-all-of-the-metadata-client-mdc-locks-on-this-node" class="headerlink" title="Flush all of the metadata client (mdc) locks on this node"></a>Flush all of the metadata client (mdc) locks on this node</h3><p>If the client files info are not consistent , you could run the comand in the client</p>
<p><a href="http://wiki.old.lustre.org/manual/LustreManual20_HTML/LustreProc.html" target="_blank" rel="external">The lru_size parameter is used to control the number of client-side locks in an LRU queue. LRU size is dynamic, based on load. This optimizes the number of locks available to nodes that have different workloads</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ lctl <span class="built_in">set</span>_param ldlm.namespaces.*mdc*.lru_size=clear</span><br></pre></td></tr></table></figure></p>
<h3 id="Lustre-quota-ldiskfs"><a href="#Lustre-quota-ldiskfs" class="headerlink" title="Lustre quota (ldiskfs)"></a>Lustre quota (ldiskfs)</h3><h4 id="MDS"><a href="#MDS" class="headerlink" title="MDS"></a>MDS</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/fs/lustre/osd-ldiskfs/lfstest-MDT0000/quota_slave/info </span><br><span class="line">target name:    lfstest-MDT0000</span><br><span class="line">pool ID:        0</span><br><span class="line"><span class="built_in">type</span>:           md</span><br><span class="line">quota enabled:  <span class="string">"none"</span></span><br><span class="line">conn to master: setup</span><br><span class="line">space acct:     ug</span><br><span class="line">user uptodate:  glb[0],slv[0],reint[0]</span><br><span class="line">group uptodate: glb[0],slv[0],reint[0]</span><br><span class="line"></span><br><span class="line">mds$ lctl conf_param lfstest.quota.mdt=ug</span><br><span class="line"></span><br><span class="line">mds$ cat /proc/fs/lustre/osd-ldiskfs/lfstest-MDT0000/quota_slave/info </span><br><span class="line">target name:    lfstest-MDT0000</span><br><span class="line">pool ID:        0</span><br><span class="line"><span class="built_in">type</span>:           md</span><br><span class="line">quota enabled:  <span class="string">"ug"</span></span><br><span class="line">conn to master: setup</span><br><span class="line">space acct:     ug</span><br><span class="line">user uptodate:  glb[1],slv[1],reint[0]</span><br><span class="line">group uptodate: glb[1],slv[1],reint[0]</span><br><span class="line"></span><br><span class="line">mds$ lctl conf_param lfstest.quota.ost=ug</span><br></pre></td></tr></table></figure>
<h4 id="Clear-pool"><a href="#Clear-pool" class="headerlink" title="Clear pool"></a>Clear pool</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ lfs setstripe <span class="variable">$line</span></span><br></pre></td></tr></table></figure>
<h4 id="Add-pool"><a href="#Add-pool" class="headerlink" title="Add pool"></a>Add pool</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#MDT</span></span><br><span class="line">lctl pool_new lustre.pool1</span><br><span class="line">lctl pool_add lustre.pool1 OST[0-10/2]</span><br><span class="line"></span><br><span class="line"><span class="comment">#Client, set all files</span></span><br><span class="line">find /mnt/lustre/<span class="built_in">test</span> -type d | <span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    lctl setstripe -p lustre.pool1 <span class="variable">$line</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h4 id="OSS"><a href="#OSS" class="headerlink" title="OSS"></a>OSS</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/fs/lustre/osd-ldiskfs/lfstest-OST0001/quota_slave/info </span><br><span class="line">target name:    lfstest-OST0001</span><br><span class="line">pool ID:        0</span><br><span class="line"><span class="built_in">type</span>:           dt</span><br><span class="line">quota enabled:  <span class="string">"ug"</span></span><br><span class="line">conn to master: setup</span><br><span class="line">space acct:     ug</span><br><span class="line">user uptodate:  glb[1],slv[1],reint[0]</span><br><span class="line">group uptodate: glb[1],slv[1],reint[0]</span><br></pre></td></tr></table></figure>
<h4 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h4><h5 id="User-group-Quota"><a href="#User-group-Quota" class="headerlink" title="User/group Quota"></a>User/group Quota</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># No soft limit, Hard limit of 1GB block space, 10000 files</span></span><br><span class="line">$ lfs setquota -u <span class="built_in">test</span> -b 0 -B 1024000 -i 0 -I 10000 /mnt/</span><br><span class="line"></span><br><span class="line"><span class="comment"># Soft limit 1G and 5000 files, Hard limit 2G and 10000 files</span></span><br><span class="line">$ lfs setquota -g <span class="built_in">test</span>1 -b 1G -B 2G -i 5000 -I 10000 /mnt/</span><br><span class="line"></span><br><span class="line">user$ cp: writing <span class="built_in">test</span>1_bak: Disk quota exceeded</span><br><span class="line">user$ touch: cannot touch 10000: Disk quota exceeded</span><br><span class="line">$ lfs setquota -u user_data -B 350T /mnt/user_data</span><br><span class="line">$ lfs quota -u user_data /mnt/user_data</span><br><span class="line">Disk quotas <span class="keyword">for</span> user user_data (uid 36081):</span><br><span class="line">     Filesystem  kbytes   quota   <span class="built_in">limit</span>   grace   files   quota   <span class="built_in">limit</span>   grace</span><br><span class="line">  /mnt/user_data 299994427159       0 375809638400       -  707604       0       0       -</span><br></pre></td></tr></table></figure>
<h5 id="lfs-migrate-data-to-another-OST"><a href="#lfs-migrate-data-to-another-OST" class="headerlink" title="lfs migrate data to another OST"></a>lfs migrate data to another OST</h5><p>There are some of data loss report when lustre to migrate data.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lfs find /opt/lustrewh -obd lustrewh-OST000c_UUID -size +4G | lfs_migrate -y</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># move filename to OST0000 and stripe number equal 1</span></span><br><span class="line">lfs migrate -c 1 -i 0 filename</span><br></pre></td></tr></table></figure>
<h3 id="Abort-tgt-reocv"><a href="#Abort-tgt-reocv" class="headerlink" title="Abort tgt_reocv"></a>Abort tgt_reocv</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ mds lctl dl | grep osc</span><br><span class="line">8 UP osp lustre-OST0000-osc-MDT0000 lustre-MDT0000-mdtlov_UUID 5</span><br><span class="line"></span><br><span class="line">$ lctl --device 8 deactivate</span><br><span class="line">$ lctl --device 8 activate</span><br></pre></td></tr></table></figure>
<p>or mount.lustre xxx xxx -o abort_recov</p>
<h3 id="Get-lustre-version"><a href="#Get-lustre-version" class="headerlink" title="Get lustre version"></a>Get lustre version</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ lctl get_param version</span><br></pre></td></tr></table></figure>
<h3 id="Lustre-status"><a href="#Lustre-status" class="headerlink" title="Lustre status"></a>Lustre status</h3><p>list nids<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lctl list_nids</span><br><span class="line">lctl which_nid 10.xxx@tcp</span><br><span class="line">lctl ping 10.xxx@tcp</span><br></pre></td></tr></table></figure></p>
<h3 id="check-ost-status"><a href="#check-ost-status" class="headerlink" title="check ost status"></a>check ost status</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">client $ lfs osts</span><br><span class="line">client $ cat /proc/fs/lustre/lov/<span class="variable">$fsname</span>-clilov-ffff882037467800/target_obd</span><br><span class="line">mds $ cat /proc/fs/lustre/lov/<span class="variable">$fsname</span>-MDT0000-mdtlov/target_obd</span><br><span class="line">client $ lctl get_param osc.*-OST*.active</span><br></pre></td></tr></table></figure>
<h5 id="show-ost-and-ip-addr-relationship"><a href="#show-ost-and-ip-addr-relationship" class="headerlink" title="show ost and ip addr relationship"></a>show ost and ip addr relationship</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">client $ lctl dl -t</span><br></pre></td></tr></table></figure>
<h5 id="OST-threads"><a href="#OST-threads" class="headerlink" title="OST threads"></a>OST threads</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lctl <span class="built_in">set</span>_param ost.OSS.ost_io.threads_max=128</span><br></pre></td></tr></table></figure>
<h3 id="No-roots-quash"><a href="#No-roots-quash" class="headerlink" title="No roots quash"></a>No roots quash</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ fsname=lustre</span><br><span class="line">$ lctl conf_param <span class="variable">$fsname</span>.mdt.root_squash=99:99</span><br><span class="line">$ lctl conf_param <span class="variable">$fsname</span>.mdt.nosquash_nids=<span class="string">"10.xx.xx.xx@tcp 10.xx.xx.xx@tcp"</span></span><br><span class="line">$ cat /proc/fs/lustre/mdt/<span class="variable">$fsname</span>-MDT0000/nosquash_nids</span><br><span class="line">10.xx.xx.xx@tcp 10.xx.xx.xx@tcp</span><br></pre></td></tr></table></figure>
<h3 id="Readonly-OST"><a href="#Readonly-OST" class="headerlink" title="Readonly OST"></a>Readonly OST</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lctl <span class="built_in">set</span>_param obdfilter.lustrewh-OST00XX.degraded=1</span><br></pre></td></tr></table></figure>
<h3 id="Rebalance-OST"><a href="#Rebalance-OST" class="headerlink" title="Rebalance OST"></a>Rebalance OST</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lfs find /opt/lustrewh -obd lustrewh-OST000c_UUID -size +4G | lfs_migrate -y</span><br></pre></td></tr></table></figure>
<h3 id="Move-data-to-one-OST"><a href="#Move-data-to-one-OST" class="headerlink" title="Move data to one OST"></a>Move data to one OST</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lfs migrate -c 1  -i 4  filepath <span class="comment">#to index 4</span></span><br></pre></td></tr></table></figure>
<h3 id="Enable-job-status"><a href="#Enable-job-status" class="headerlink" title="Enable job status"></a><a href="https://jira.hpdd.intel.com/browse/LU-694" target="_blank" rel="external">Enable job status</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">client $  lctl get_param jobid_var</span><br><span class="line">client $  jobid_var=<span class="built_in">disable</span></span><br><span class="line"></span><br><span class="line">SLURM: jobid_var=SLURM_JOB_ID</span><br><span class="line">SGE: jobid_var=JOB_ID</span><br><span class="line">LSF: jobid_var=LSB_JOBID</span><br><span class="line">Loadleveler: jobid_var=LOADL_STEP_ID</span><br><span class="line">PBS: jobid_var=PBS_JOBID</span><br><span class="line">Maui/MOAB: jobid_var=PBS_JOBID</span><br><span class="line"><span class="comment">### Enable for sge</span></span><br><span class="line">mds $ lctl conf_param testfs.sys.jobid_var=JOB_ID</span><br><span class="line"></span><br><span class="line"><span class="comment">### disable</span></span><br><span class="line">mds $ lctl conf_param testfs.sys.jobid_var=<span class="built_in">disable</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### If there isn't any job scheduler is running over the system, or user just want to collect the stats for process &amp; uid:</span></span><br><span class="line">mds $ lctl conf_param testfs.sys.jobid_var=procname_uid</span><br><span class="line"></span><br><span class="line"><span class="comment">### Check Job status</span></span><br><span class="line">oss $ lctl get_param obdfilter.testfs5-OST0004.job_stats</span><br><span class="line">job_stats:</span><br><span class="line">- job_id:          9158530</span><br><span class="line">  snapshot_time:   1503038800</span><br><span class="line">  <span class="built_in">read</span>_bytes:      &#123; samples:           0, unit: bytes, min:       0, max:       0, sum:               0 &#125;</span><br><span class="line">  write_bytes:     &#123; samples:       32452, unit: bytes, min:  262144, max: 1048576, sum:     34009513984 &#125;</span><br><span class="line">  getattr:         &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line">  setattr:         &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">### get mdt ops</span></span><br><span class="line">mds $ lctl get_param mdt.*.job_stats</span><br><span class="line">mds $ lctl get_param  mdt.testfs5-MDT0000.job_stats</span><br><span class="line">mdt.testfs5-MDT0000.job_stats=</span><br><span class="line">job_stats:</span><br><span class="line">- job_id:          278685</span><br><span class="line">  snapshot_time:   1503068243</span><br><span class="line">  open:            &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line">  close:           &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line">  mknod:           &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line">  link:            &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line">  unlink:          &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line">  mkdir:           &#123; samples:           0, unit:  reqs &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">### clear stats for all job on testfs-OST0001</span></span><br><span class="line">oss $ lctl <span class="built_in">set</span>_param obdfilter.testfs-OST0001.job_stats=clear</span><br><span class="line"></span><br><span class="line"><span class="comment">### Clear stats for job "dd.0" on lustre-MDT0000</span></span><br><span class="line">mds $ lctl <span class="built_in">set</span>_param mdt.lustre-MDT0000.job_stats=dd.0</span><br><span class="line"></span><br><span class="line"><span class="comment">### cleanup interval (seconds)</span></span><br><span class="line">lctl conf_param testfs5.mdt.job_cleanup_interval=604800</span><br><span class="line">[root@cngb-mds-m22-1 lustre]<span class="comment">#  cat /proc/fs/lustre/mdt/testfs5-MDT0000/job_cleanup_interval</span></span><br><span class="line">604800</span><br></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Lustre </category>
            
        </categories>
        
        
        <tags>
            
            <tag> lustre </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Cut file by byte]]></title>
      <url>http://yoursite.com/2016/04/05/Cut-file-by-byte/</url>
      <content type="html"><![CDATA[<h3 id="By-KB"><a href="#By-KB" class="headerlink" title="By KB"></a>By KB</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> &gt; <span class="built_in">test</span>1;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..100000&#125;; </span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">	<span class="built_in">echo</span> <span class="variable">$i</span> &gt;&gt; <span class="built_in">test</span>1; </span><br><span class="line">	<span class="built_in">echo</span> ------------ &gt;&gt; <span class="built_in">test</span>1; </span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h4 id="Read-10th-KB-data"><a href="#Read-10th-KB-data" class="headerlink" title="Read 10th KB data"></a>Read 10th KB data</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">head -c 10k <span class="built_in">test</span>1 | tail -c 1k </span><br><span class="line">dd <span class="keyword">if</span>=<span class="built_in">test</span>1 of=<span class="built_in">test</span>2 bs=1k skip=9 count=1</span><br></pre></td></tr></table></figure>
<h4 id="Read-by-Byte"><a href="#Read-by-Byte" class="headerlink" title="Read by Byte"></a>Read by Byte</h4><pre><code class="bash">
</code></pre>
]]></content>
      
        <categories>
            
            <category> bash </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> bash </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Sort array with GAWK4]]></title>
      <url>http://yoursite.com/2016/04/04/Sort-array-with-GAWK4/</url>
      <content type="html"><![CDATA[<h3 id="Sort-array-by-awk"><a href="#Sort-array-by-awk" class="headerlink" title="Sort array by awk"></a>Sort array by awk</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ cat file</span><br><span class="line">port <span class="number">12</span></span><br><span class="line">zest <span class="number">2</span></span><br><span class="line">status <span class="number">4</span></span><br><span class="line">flash <span class="number">4</span></span><br><span class="line">hero <span class="number">3</span></span><br><span class="line">awk <span class="number">3</span></span><br><span class="line">innovation <span class="number">10</span></span><br><span class="line">test <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h4 id="Sort-index-descend"><a href="#Sort-index-descend" class="headerlink" title="Sort index (descend)"></a>Sort index (descend)</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/awk -f</span><br><span class="line">&#123; </span><br><span class="line">	a[$<span class="number">1</span>]=$<span class="number">2</span>; </span><br><span class="line">        PROCINFO[<span class="string">"sorted_in"</span>] = <span class="string">"@ind_str_desc"</span></span><br><span class="line">&#125; </span><br><span class="line">END &#123;</span><br><span class="line">	<span class="keyword">for</span> (i in a) &#123;</span><br><span class="line">		<span class="built_in">print</span> i, a[i]</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>output<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/tmp/awkscript file</span><br><span class="line">zest <span class="number">2</span></span><br><span class="line">test <span class="number">1</span></span><br><span class="line">status <span class="number">4</span></span><br><span class="line">port <span class="number">12</span></span><br><span class="line">innovation <span class="number">10</span></span><br><span class="line">hero <span class="number">3</span></span><br><span class="line">flash <span class="number">4</span></span><br><span class="line">awk <span class="number">3</span></span><br></pre></td></tr></table></figure></p>
<h4 id="Sort-value-ascend"><a href="#Sort-value-ascend" class="headerlink" title="Sort value (ascend)"></a>Sort value (ascend)</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/awk -f</span><br><span class="line">&#123; </span><br><span class="line">	a[$<span class="number">1</span>]=$<span class="number">2</span></span><br><span class="line">	PROCINFO[<span class="string">"sorted_in"</span>] = <span class="string">"@val_num_asc"</span></span><br><span class="line">&#125; </span><br><span class="line">END &#123;</span><br><span class="line">	<span class="keyword">for</span> (i in a) &#123;</span><br><span class="line">		<span class="built_in">print</span> i, a[i]</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>output<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/tmp/awkscript file</span><br><span class="line">test <span class="number">1</span></span><br><span class="line">zest <span class="number">2</span></span><br><span class="line">hero <span class="number">3</span></span><br><span class="line">awk <span class="number">3</span></span><br><span class="line">flash <span class="number">4</span></span><br><span class="line">status <span class="number">4</span></span><br><span class="line">innovation <span class="number">10</span></span><br><span class="line">port <span class="number">12</span></span><br></pre></td></tr></table></figure></p>
<p><a href="https://www.gnu.org/software/gawk/manual/html_node/Controlling-Scanning.html" target="_blank" rel="external">gawk reference</a><br><a href="http://stackoverflow.com/questions/5342782/sort-associative-array-with-awk" target="_blank" rel="external">stackoverflow reference</a></p>
]]></content>
      
        <categories>
            
            <category> awk </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> awk </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Blktrace]]></title>
      <url>http://yoursite.com/2016/04/01/blktrace/</url>
      <content type="html"><![CDATA[<p>OS version :CentOS 7.2<br>It ‘s a good tool for trace hot block in your block device</p>
<h3 id="Trace-your-IO-operation"><a href="#Trace-your-IO-operation" class="headerlink" title="Trace your IO operation"></a>Trace your IO operation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">$ yum -y install blktrace</span><br><span class="line">$ mount -t debugfs debugfs /sys/kernel/debug</span><br><span class="line"></span><br><span class="line">$ mount  | grep sdb1</span><br><span class="line">/dev/sdb1 on /<span class="built_in">local</span>/sdb <span class="built_in">type</span> ext4 (rw,noatime,stripe=128,data=ordered)</span><br><span class="line"></span><br><span class="line"><span class="comment"># With Ordered Mode, journal commits are deferred until the data blocks get written to disk. This guarantees that any blocks in the file will be data written by the application, avoiding a possibility of a security breach</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The path mapping to /dev/sdb1</span></span><br><span class="line">$ <span class="built_in">echo</span> 234 &gt; 234</span><br><span class="line"></span><br><span class="line">Sometimes ,the data is not write to block first</span><br><span class="line">$  cat /tmp/tmp  | grep A</span><br><span class="line">  8,16   6        1     0.000000000  3487  A   W 276480 + 8 &lt;- (8,17) <span class="string">"274432"</span></span><br><span class="line">  8,16   6       10     0.000224890 21268  A FWFS 1422142464 + 8 &lt;- (8,17) 1422140416</span><br><span class="line">  8,16   8        1     0.000070650 21268  A  WS 1422142416 + 8 &lt;- (8,17) 1422140368</span><br><span class="line">  8,16   8        5     0.000075917 21268  A  WS 1422142424 + 8 &lt;- (8,17) 1422140376</span><br><span class="line">  8,16   8        8     0.000078252 21268  A  WS 1422142432 + 8 &lt;- (8,17) 1422140384</span><br><span class="line">  8,16   8       11     0.000079337 21268  A  WS 1422142440 + 8 &lt;- (8,17) 1422140392</span><br><span class="line">  8,16   8       14     0.000080280 21268  A  WS 1422142448 + 8 &lt;- (8,17) 1422140400</span><br><span class="line">  8,16   8       17     0.000081320 21268  A  WS 1422142456 + 8 &lt;- (8,17) 1422140408</span><br><span class="line">  8,16   8       23     5.007945786  3487  A  WM 2056 + 8 &lt;- (8,17) 8</span><br><span class="line">  8,16   8       27     5.007958153  3487  A  WM 11616 + 8 &lt;- (8,17) 9568</span><br><span class="line">  8,16   8       30     5.007961458  3487  A  WM 11736 + 8 &lt;- (8,17) 9688</span><br><span class="line">  8,16   8       33     5.007964866  3487  A  WM 11864 + 8 &lt;- (8,17) 9816</span><br><span class="line">  8,16   8       36     5.007967773  3487  A  WM 77400 + 8 &lt;- (8,17) 75352</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ debugfs -R <span class="string">"icheck <span class="variable">$((274432/8)</span>)"</span> /dev/sdb1</span><br><span class="line">debugfs 1.42.9 (28-Dec-2013)</span><br><span class="line">Block	Inode number</span><br><span class="line">34304	15</span><br><span class="line"></span><br><span class="line">$ ls -li</span><br><span class="line">15 -rw-r--r-- 1 root root     4 Apr 1 04:44 234</span><br><span class="line"></span><br><span class="line">$ debugfs -R <span class="string">"ncheck 15"</span> /dev/sdb1</span><br><span class="line">debugfs 1.42.9 (28-Dec-2013)</span><br><span class="line">Inode	Pathname</span><br><span class="line">15	//234</span><br><span class="line"></span><br><span class="line">$ debugfs -R <span class="string">"icheck <span class="variable">$((1422140416/8)</span>)"</span> /dev/sdb1</span><br><span class="line">debugfs 1.42.9 (28-Dec-2013)</span><br><span class="line">Block	Inode number</span><br><span class="line">177767552	8</span><br><span class="line"></span><br><span class="line">$ debugfs -R <span class="string">"ncheck 8"</span> /dev/sdb1</span><br><span class="line">debugfs 1.42.9 (28-Dec-2013)</span><br><span class="line">Inode	Pathname</span><br></pre></td></tr></table></figure>
<p><a href="https://ext4.wiki.kernel.org/index.php/Ext4_Disk_Layout#Journal_.28jbd2.29" target="_blank" rel="external">The journal inode is typically inode 8. The first 68 bytes of the journal inode are replicated in the ext4 superblock. The journal itself is normal (but hidden) file within the filesystem. The file usually consumes an entire block group, though mke2fs tries to put it in the middle of the disk</a></p>
<h3 id="Another-example-full-ouput"><a href="#Another-example-full-ouput" class="headerlink" title="Another example full ouput"></a>Another example full ouput</h3><p>Here is output of my home PC (ubuntu 15.10)<br>Only write small file (dd if=/dev/zero of=/mnt/test bs=512 count=2)</p>
<h4 id="oflag-sync"><a href="#oflag-sync" class="headerlink" title="oflag=sync"></a>oflag=sync</h4><p>write journal, and then write data, hdd return, not wait a second<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>      <span class="number">159</span>   <span class="number">689.878265367</span>  <span class="number">8177</span>  A  WS <span class="number">155454552</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452504</span></span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">160</span>   <span class="number">689.878266393</span>  <span class="number">8177</span>  Q  WS <span class="number">155454552</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">161</span>   <span class="number">689.878268169</span>  <span class="number">8177</span>  G  WS <span class="number">155454552</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">162</span>   <span class="number">689.878268655</span>  <span class="number">8177</span>  P   N [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>      <span class="number">163</span>   <span class="number">689.878269447</span>  <span class="number">8177</span>  A  WS <span class="number">155454560</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452512</span></span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">164</span>   <span class="number">689.878269657</span>  <span class="number">8177</span>  Q  WS <span class="number">155454560</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">165</span>   <span class="number">689.878270524</span>  <span class="number">8177</span>  M  WS <span class="number">155454560</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>      <span class="number">166</span>   <span class="number">689.878271142</span>  <span class="number">8177</span>  A  WS <span class="number">155454568</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452520</span></span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">167</span>   <span class="number">689.878271349</span>  <span class="number">8177</span>  Q  WS <span class="number">155454568</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">168</span>   <span class="number">689.878271577</span>  <span class="number">8177</span>  M  WS <span class="number">155454568</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>      <span class="number">169</span>   <span class="number">689.878272006</span>  <span class="number">8177</span>  A  WS <span class="number">155454576</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452528</span></span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">170</span>   <span class="number">689.878272213</span>  <span class="number">8177</span>  Q  WS <span class="number">155454576</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">171</span>   <span class="number">689.878272441</span>  <span class="number">8177</span>  M  WS <span class="number">155454576</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>      <span class="number">172</span>   <span class="number">689.878272828</span>  <span class="number">8177</span>  A  WS <span class="number">155454584</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452536</span></span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">173</span>   <span class="number">689.878273026</span>  <span class="number">8177</span>  Q  WS <span class="number">155454584</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">174</span>   <span class="number">689.878273248</span>  <span class="number">8177</span>  M  WS <span class="number">155454584</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>      <span class="number">175</span>   <span class="number">689.878273587</span>  <span class="number">8177</span>  A  WS <span class="number">155454592</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452544</span></span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">176</span>   <span class="number">689.878273791</span>  <span class="number">8177</span>  Q  WS <span class="number">155454592</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">177</span>   <span class="number">689.878274019</span>  <span class="number">8177</span>  M  WS <span class="number">155454592</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">178</span>   <span class="number">689.878274829</span>  <span class="number">8177</span>  I  WS <span class="number">155454552</span> + <span class="number">48</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">179</span>   <span class="number">689.878275333</span>  <span class="number">8177</span>  U   N [jbd2/sdc1<span class="bullet">-8</span>] <span class="number">1</span></span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">180</span>   <span class="number">689.878275999</span>  <span class="number">8177</span>  D  WS <span class="number">155454552</span> + <span class="number">48</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">181</span>   <span class="number">689.878535778</span>     <span class="number">0</span>  C  WS <span class="number">155454552</span> + <span class="number">48</span> [<span class="number">0</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>      <span class="number">182</span>   <span class="number">689.878551480</span>  <span class="number">8177</span>  A FWFS <span class="number">155454600</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452552</span></span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">183</span>   <span class="number">689.878551816</span>  <span class="number">8177</span>  Q FWFS <span class="number">155454600</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">184</span>   <span class="number">689.878552509</span>  <span class="number">8177</span>  G FWFS <span class="number">155454600</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">185</span>   <span class="number">689.878553118</span>  <span class="number">8177</span>  I FWFS <span class="number">155454600</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">32</span>   <span class="number">3</span>      <span class="number">194</span>   <span class="number">689.878014170</span>  <span class="number">9030</span>  A  WS <span class="number">276520</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">274472</span></span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>      <span class="number">195</span>   <span class="number">689.878016897</span>  <span class="number">9030</span>  Q  WS <span class="number">276520</span> + <span class="number">8</span> [dd]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>      <span class="number">196</span>   <span class="number">689.878020143</span>  <span class="number">9030</span>  G  WS <span class="number">276520</span> + <span class="number">8</span> [dd]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>      <span class="number">197</span>   <span class="number">689.878021181</span>  <span class="number">9030</span>  P   N [dd]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>      <span class="number">198</span>   <span class="number">689.878022921</span>  <span class="number">9030</span>  I  WS <span class="number">276520</span> + <span class="number">8</span> [dd]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>      <span class="number">199</span>   <span class="number">689.878023761</span>  <span class="number">9030</span>  U   N [dd] <span class="number">1</span></span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>      <span class="number">200</span>   <span class="number">689.878025114</span>  <span class="number">9030</span>  D  WS <span class="number">276520</span> + <span class="number">8</span> [dd]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>      <span class="number">201</span>   <span class="number">689.878227087</span>     <span class="number">0</span>  C  WS <span class="number">276520</span> + <span class="number">8</span> [<span class="number">0</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">235</span>   <span class="number">689.929054795</span>     <span class="number">0</span>  D  WS <span class="number">155454600</span> + <span class="number">8</span> [swapper/<span class="number">2</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">236</span>   <span class="number">689.953664402</span>     <span class="number">0</span>  C  WS <span class="number">155454600</span> [<span class="number">0</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>      <span class="number">186</span>   <span class="number">689.929232481</span>     <span class="number">0</span>  C  WS <span class="number">155454600</span> + <span class="number">8</span> [<span class="number">0</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">42</span>   <span class="number">716.440898596</span>  <span class="number">7824</span>  G   N [kworker/u8:<span class="number">0</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">43</span>   <span class="number">716.440899622</span>  <span class="number">7824</span>  I   N <span class="number">0</span> (<span class="number">00</span> ..) [kworker/u8:<span class="number">0</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">44</span>   <span class="number">716.440900483</span>  <span class="number">7824</span>  D   N <span class="number">0</span> (<span class="number">00</span> ..) [kworker/u8:<span class="number">0</span>]</span><br><span class="line"><span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">45</span>   <span class="number">716.440915785</span>     <span class="number">3</span>  C   N (<span class="number">00</span> ..) [<span class="number">0</span>]</span><br></pre></td></tr></table></figure></p>
<h4 id="oflag-direct"><a href="#oflag-direct" class="headerlink" title="oflag=direct"></a>oflag=direct</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">write data first <span class="string">"278560"</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">0</span>       <span class="number">71</span>   <span class="number">924.643982410</span>  <span class="number">9092</span>  A  WS <span class="number">280608</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="string">"278560"</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">72</span>   <span class="number">924.643984999</span>  <span class="number">9092</span>  Q  WS <span class="number">280608</span> + <span class="number">8</span> [dd]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">73</span>   <span class="number">924.643988437</span>  <span class="number">9092</span>  G  WS <span class="number">280608</span> + <span class="number">8</span> [dd]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">74</span>   <span class="number">924.643989544</span>  <span class="number">9092</span>  P   N [dd]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">75</span>   <span class="number">924.643991242</span>  <span class="number">9092</span>  I  WS <span class="number">280608</span> + <span class="number">8</span> [dd]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">76</span>   <span class="number">924.643992202</span>  <span class="number">9092</span> UT   N [dd] <span class="number">1</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">77</span>   <span class="number">924.644003671</span>   <span class="number">113</span>  D  WS <span class="number">280608</span> + <span class="number">8</span> [kworker/<span class="number">0</span>:<span class="number">1</span>H]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">78</span>   <span class="number">924.644187239</span>     <span class="number">0</span>  C  WS <span class="number">280608</span> + <span class="number">8</span> [<span class="number">0</span>]</span><br><span class="line">wait <span class="number">5</span> seconds ... because commit = <span class="number">5</span> (default value)</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>      <span class="number">216</span>   <span class="number">929.750636556</span>     <span class="number">0</span>  D  WS <span class="number">155454648</span> + <span class="number">8</span> [swapper/<span class="number">2</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">1</span>      <span class="number">300</span>   <span class="number">929.725647290</span>  <span class="number">8177</span>  A  WS <span class="number">155454608</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452560</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">301</span>   <span class="number">929.725648586</span>  <span class="number">8177</span>  Q  WS <span class="number">155454608</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">302</span>   <span class="number">929.725651343</span>  <span class="number">8177</span>  G  WS <span class="number">155454608</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">303</span>   <span class="number">929.725651976</span>  <span class="number">8177</span>  P   N [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">1</span>      <span class="number">304</span>   <span class="number">929.725653017</span>  <span class="number">8177</span>  A  WS <span class="number">155454616</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452568</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">305</span>   <span class="number">929.725653281</span>  <span class="number">8177</span>  Q  WS <span class="number">155454616</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">306</span>   <span class="number">929.725654121</span>  <span class="number">8177</span>  M  WS <span class="number">155454616</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">1</span>      <span class="number">307</span>   <span class="number">929.725655039</span>  <span class="number">8177</span>  A  WS <span class="number">155454624</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452576</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">308</span>   <span class="number">929.725655246</span>  <span class="number">8177</span>  Q  WS <span class="number">155454624</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">309</span>   <span class="number">929.725655474</span>  <span class="number">8177</span>  M  WS <span class="number">155454624</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">1</span>      <span class="number">310</span>   <span class="number">929.725655948</span>  <span class="number">8177</span>  A  WS <span class="number">155454632</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452584</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">311</span>   <span class="number">929.725656326</span>  <span class="number">8177</span>  Q  WS <span class="number">155454632</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">312</span>   <span class="number">929.725656644</span>  <span class="number">8177</span>  M  WS <span class="number">155454632</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">1</span>      <span class="number">313</span>   <span class="number">929.725657046</span>  <span class="number">8177</span>  A  WS <span class="number">155454640</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452592</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">314</span>   <span class="number">929.725657247</span>  <span class="number">8177</span>  Q  WS <span class="number">155454640</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">315</span>   <span class="number">929.725657469</span>  <span class="number">8177</span>  M  WS <span class="number">155454640</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">316</span>   <span class="number">929.725658477</span>  <span class="number">8177</span>  I  WS <span class="number">155454608</span> + <span class="number">40</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">317</span>   <span class="number">929.725659326</span>  <span class="number">8177</span>  U   N [jbd2/sdc1<span class="bullet">-8</span>] <span class="number">1</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">318</span>   <span class="number">929.725660286</span>  <span class="number">8177</span>  D  WS <span class="number">155454608</span> + <span class="number">40</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">319</span>   <span class="number">929.725919352</span>     <span class="number">0</span>  C  WS <span class="number">155454608</span> + <span class="number">40</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">1</span>      <span class="number">320</span>   <span class="number">929.725936739</span>  <span class="number">8177</span>  A FWFS <span class="number">155454648</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155452600</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">321</span>   <span class="number">929.725937087</span>  <span class="number">8177</span>  Q FWFS <span class="number">155454648</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">322</span>   <span class="number">929.725937786</span>  <span class="number">8177</span>  G FWFS <span class="number">155454648</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">323</span>   <span class="number">929.725938398</span>  <span class="number">8177</span>  I FWFS <span class="number">155454648</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>      <span class="number">324</span>   <span class="number">929.750809777</span>     <span class="number">0</span>  C  WS <span class="number">155454648</span> + <span class="number">8</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>      <span class="number">217</span>   <span class="number">929.759034117</span>     <span class="number">0</span>  C  WS <span class="number">155454648</span> [<span class="number">0</span>]</span><br><span class="line">wait <span class="number">15</span>s or <span class="number">20</span>s ... Does it dirty_expire_centisecs = <span class="number">1500</span> ?</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">0</span>       <span class="number">79</span>   <span class="number">954.641636276</span>  <span class="number">8780</span>  A   W <span class="number">2048</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">0</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">80</span>   <span class="number">954.641637644</span>  <span class="number">8780</span>  Q   W <span class="number">2048</span> + <span class="number">8</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">81</span>   <span class="number">954.641641085</span>  <span class="number">8780</span>  G   W <span class="number">2048</span> + <span class="number">8</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">82</span>   <span class="number">954.641642087</span>  <span class="number">8780</span>  P   N [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">0</span>       <span class="number">83</span>   <span class="number">954.641644262</span>  <span class="number">8780</span>  A  WM <span class="number">2056</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">8</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">84</span>   <span class="number">954.641644472</span>  <span class="number">8780</span>  Q  WM <span class="number">2056</span> + <span class="number">8</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">85</span>   <span class="number">954.641645486</span>  <span class="number">8780</span>  M  WM <span class="number">2056</span> + <span class="number">8</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">0</span>       <span class="number">86</span>   <span class="number">954.641647064</span>  <span class="number">8780</span>  A  WM <span class="number">10256</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">8208</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">87</span>   <span class="number">954.641647274</span>  <span class="number">8780</span>  Q  WM <span class="number">10256</span> + <span class="number">8</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">88</span>   <span class="number">954.641648009</span>  <span class="number">8780</span>  G  WM <span class="number">10256</span> + <span class="number">8</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">0</span>       <span class="number">89</span>   <span class="number">954.641649608</span>  <span class="number">8780</span>  A  WM <span class="number">10504</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">8456</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">90</span>   <span class="number">954.641649809</span>  <span class="number">8780</span>  Q  WM <span class="number">10504</span> + <span class="number">8</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">91</span>   <span class="number">954.641650430</span>  <span class="number">8780</span>  G  WM <span class="number">10504</span> + <span class="number">8</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">92</span>   <span class="number">954.641652170</span>  <span class="number">8780</span>  I   W <span class="number">2048</span> + <span class="number">16</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">93</span>   <span class="number">954.641652974</span>  <span class="number">8780</span>  I  WM <span class="number">10256</span> + <span class="number">8</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">94</span>   <span class="number">954.641653406</span>  <span class="number">8780</span>  I  WM <span class="number">10504</span> + <span class="number">8</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">95</span>   <span class="number">954.641653775</span>  <span class="number">8780</span>  U   N [kworker/u8:<span class="number">1</span>] <span class="number">3</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">96</span>   <span class="number">954.641655053</span>  <span class="number">8780</span>  D   W <span class="number">2048</span> + <span class="number">16</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">97</span>   <span class="number">954.641708392</span>  <span class="number">8780</span>  D  WM <span class="number">10256</span> + <span class="number">8</span> [kworker/u8:<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">98</span>   <span class="number">954.641895755</span>     <span class="number">0</span>  C   W <span class="number">2048</span> + <span class="number">16</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>       <span class="number">99</span>   <span class="number">954.641947709</span>     <span class="number">0</span>  D  WM <span class="number">10504</span> + <span class="number">8</span> [swapper/<span class="number">2</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>      <span class="number">100</span>   <span class="number">954.642066976</span>     <span class="number">0</span>  C  WM <span class="number">10256</span> + <span class="number">8</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>      <span class="number">101</span>   <span class="number">954.642239705</span>     <span class="number">0</span>  C  WM <span class="number">10504</span> + <span class="number">8</span> [<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<h4 id="no-oflag"><a href="#no-oflag" class="headerlink" title="no oflag"></a>no oflag</h4><p>There are a lot of different wait time in this situation<br>Because this situation is the most complex<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">wait <span class="number">5</span>s..</span><br><span class="line"> <span class="number">8</span>,<span class="number">33</span>   <span class="number">1</span>       <span class="number">29</span>    <span class="number">82.996414180</span>     <span class="number">0</span>  D  WS <span class="number">155453784</span> + <span class="number">8</span> [swapper/<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">3</span>       <span class="number">51</span>    <span class="number">82.975991741</span>  <span class="number">9859</span>  A  WS <span class="number">155453736</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451688</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">52</span>    <span class="number">82.975993076</span>  <span class="number">9859</span>  Q  WS <span class="number">155453736</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">53</span>    <span class="number">82.975997048</span>  <span class="number">9859</span>  G  WS <span class="number">155453736</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">54</span>    <span class="number">82.975998182</span>  <span class="number">9859</span>  P   N [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">3</span>       <span class="number">55</span>    <span class="number">82.975999169</span>  <span class="number">9859</span>  A  WS <span class="number">155453744</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451696</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">56</span>    <span class="number">82.975999367</span>  <span class="number">9859</span>  Q  WS <span class="number">155453744</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">57</span>    <span class="number">82.976000324</span>  <span class="number">9859</span>  M  WS <span class="number">155453744</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">3</span>       <span class="number">58</span>    <span class="number">82.976000804</span>  <span class="number">9859</span>  A  WS <span class="number">155453752</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451704</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">59</span>    <span class="number">82.976001005</span>  <span class="number">9859</span>  Q  WS <span class="number">155453752</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">60</span>    <span class="number">82.976001239</span>  <span class="number">9859</span>  M  WS <span class="number">155453752</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">3</span>       <span class="number">61</span>    <span class="number">82.976001674</span>  <span class="number">9859</span>  A  WS <span class="number">155453760</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451712</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">62</span>    <span class="number">82.976001872</span>  <span class="number">9859</span>  Q  WS <span class="number">155453760</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">63</span>    <span class="number">82.976002097</span>  <span class="number">9859</span>  M  WS <span class="number">155453760</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">3</span>       <span class="number">64</span>    <span class="number">82.976002487</span>  <span class="number">9859</span>  A  WS <span class="number">155453768</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451720</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">65</span>    <span class="number">82.976002688</span>  <span class="number">9859</span>  Q  WS <span class="number">155453768</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">66</span>    <span class="number">82.976002913</span>  <span class="number">9859</span>  M  WS <span class="number">155453768</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">3</span>       <span class="number">67</span>    <span class="number">82.976003279</span>  <span class="number">9859</span>  A  WS <span class="number">155453776</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451728</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">68</span>    <span class="number">82.976003474</span>  <span class="number">9859</span>  Q  WS <span class="number">155453776</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">69</span>    <span class="number">82.976003696</span>  <span class="number">9859</span>  M  WS <span class="number">155453776</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">70</span>    <span class="number">82.976004914</span>  <span class="number">9859</span>  I  WS <span class="number">155453736</span> + <span class="number">48</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">71</span>    <span class="number">82.976005793</span>  <span class="number">9859</span>  U   N [jbd2/sdc1<span class="bullet">-8</span>] <span class="number">1</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">72</span>    <span class="number">82.976006999</span>  <span class="number">9859</span>  D  WS <span class="number">155453736</span> + <span class="number">48</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">73</span>    <span class="number">82.976309138</span>     <span class="number">0</span>  C  WS <span class="number">155453736</span> + <span class="number">48</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">3</span>       <span class="number">74</span>    <span class="number">82.976328284</span>  <span class="number">9859</span>  A FWFS <span class="number">155453784</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451736</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">75</span>    <span class="number">82.976328662</span>  <span class="number">9859</span>  Q FWFS <span class="number">155453784</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">76</span>    <span class="number">82.976329421</span>  <span class="number">9859</span>  G FWFS <span class="number">155453784</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">77</span>    <span class="number">82.976330021</span>  <span class="number">9859</span>  I FWFS <span class="number">155453784</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">78</span>    <span class="number">82.996586831</span>     <span class="number">0</span>  C  WS <span class="number">155453784</span> + <span class="number">8</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>        <span class="number">3</span>    <span class="number">83.004773614</span>     <span class="number">0</span>  C  WS <span class="number">155453784</span> [<span class="number">0</span>]</span><br><span class="line">wait <span class="number">8</span>s</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">3</span>       <span class="number">79</span>    <span class="number">92.668012660</span>  <span class="number">9646</span>  A   W <span class="number">272424</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">270376</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">80</span>    <span class="number">92.668014142</span>  <span class="number">9646</span>  Q   W <span class="number">272424</span> + <span class="number">8</span> [kworker/u8:<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">81</span>    <span class="number">92.668017571</span>  <span class="number">9646</span>  G   W <span class="number">272424</span> + <span class="number">8</span> [kworker/u8:<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">82</span>    <span class="number">92.668018489</span>  <span class="number">9646</span>  P   N [kworker/u8:<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">83</span>    <span class="number">92.668021330</span>  <span class="number">9646</span>  I   W <span class="number">272424</span> + <span class="number">8</span> [kworker/u8:<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">84</span>    <span class="number">92.668022206</span>  <span class="number">9646</span>  U   N [kworker/u8:<span class="number">0</span>] <span class="number">1</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">85</span>    <span class="number">92.668023601</span>  <span class="number">9646</span>  D   W <span class="number">272424</span> + <span class="number">8</span> [kworker/u8:<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">3</span>       <span class="number">86</span>    <span class="number">92.668207032</span>     <span class="number">0</span>  C   W <span class="number">272424</span> + <span class="number">8</span> [<span class="number">0</span>]</span><br><span class="line">wait <span class="number">5</span>s</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>       <span class="number">23</span>    <span class="number">97.967994525</span>  <span class="number">9859</span>  A  WS <span class="number">155453792</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451744</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">24</span>    <span class="number">97.967996184</span>  <span class="number">9859</span>  Q  WS <span class="number">155453792</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">25</span>    <span class="number">97.967999937</span>  <span class="number">9859</span>  G  WS <span class="number">155453792</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">26</span>    <span class="number">97.968001062</span>  <span class="number">9859</span>  P   N [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>       <span class="number">27</span>    <span class="number">97.968002124</span>  <span class="number">9859</span>  A  WS <span class="number">155453800</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451752</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">28</span>    <span class="number">97.968002415</span>  <span class="number">9859</span>  Q  WS <span class="number">155453800</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">29</span>    <span class="number">97.968003315</span>  <span class="number">9859</span>  M  WS <span class="number">155453800</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>       <span class="number">30</span>    <span class="number">97.968003888</span>  <span class="number">9859</span>  A  WS <span class="number">155453808</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451760</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">31</span>    <span class="number">97.968004092</span>  <span class="number">9859</span>  Q  WS <span class="number">155453808</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">32</span>    <span class="number">97.968004323</span>  <span class="number">9859</span>  M  WS <span class="number">155453808</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>       <span class="number">33</span>    <span class="number">97.968004722</span>  <span class="number">9859</span>  A  WS <span class="number">155453816</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451768</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">34</span>    <span class="number">97.968004923</span>  <span class="number">9859</span>  Q  WS <span class="number">155453816</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">35</span>    <span class="number">97.968005148</span>  <span class="number">9859</span>  M  WS <span class="number">155453816</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">36</span>    <span class="number">97.968006597</span>  <span class="number">9859</span>  I  WS <span class="number">155453792</span> + <span class="number">32</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">37</span>    <span class="number">97.968007347</span>  <span class="number">9859</span>  U   N [jbd2/sdc1<span class="bullet">-8</span>] <span class="number">1</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">38</span>    <span class="number">97.968008571</span>  <span class="number">9859</span>  D  WS <span class="number">155453792</span> + <span class="number">32</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">39</span>    <span class="number">97.968260397</span>     <span class="number">0</span>  C  WS <span class="number">155453792</span> + <span class="number">32</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">32</span>   <span class="number">2</span>       <span class="number">40</span>    <span class="number">97.968278433</span>  <span class="number">9859</span>  A FWFS <span class="number">155453824</span> + <span class="number">8</span> &lt;- (<span class="number">8</span>,<span class="number">33</span>) <span class="number">155451776</span></span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">41</span>    <span class="number">97.968278814</span>  <span class="number">9859</span>  Q FWFS <span class="number">155453824</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">42</span>    <span class="number">97.968279507</span>  <span class="number">9859</span>  G FWFS <span class="number">155453824</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">43</span>    <span class="number">97.968280119</span>  <span class="number">9859</span>  I FWFS <span class="number">155453824</span> + <span class="number">8</span> [jbd2/sdc1<span class="bullet">-8</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>        <span class="number">4</span>    <span class="number">97.987635609</span>     <span class="number">0</span>  D  WS <span class="number">155453824</span> + <span class="number">8</span> [swapper/<span class="number">1</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">0</span>        <span class="number">5</span>    <span class="number">97.996024470</span>     <span class="number">0</span>  C  WS <span class="number">155453824</span> [<span class="number">0</span>]</span><br><span class="line">  <span class="number">8</span>,<span class="number">33</span>   <span class="number">2</span>       <span class="number">44</span>    <span class="number">97.987810139</span>     <span class="number">0</span>  C  WS <span class="number">155453824</span> + <span class="number">8</span> [<span class="number">0</span>]</span><br></pre></td></tr></table></figure></p>
<p><a href="https://ext4.wiki.kernel.org/index.php/Ext3_Data%3DOrdered_vs_Data%3DWriteback_mode" target="_blank" rel="external">ext4 reference</a><br><a href="http://rick_stone.leanote.com/post/ext4%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%EF%BC%881%EF%BC%89%E5%8A%9F%E8%83%BD%E7%AE%80%E4%BB%8B" target="_blank" rel="external">ext4 reference</a></p>
]]></content>
      
        <categories>
            
            <category> IO </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> io </tag>
            
            <tag> trace </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[golang bitwise operators]]></title>
      <url>http://yoursite.com/2016/03/29/golang-bitwise-operators/</url>
      <content type="html"><![CDATA[<h3 id="bitwise-operators-example"><a href="#bitwise-operators-example" class="headerlink" title="bitwise operators example"></a>bitwise operators example</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">func</span> main() &#123;</span><br><span class="line">    <span class="comment">// Use bitwise OR | to get the bits that are in 1 OR 2</span></span><br><span class="line">    <span class="comment">// 1     = 00000001</span></span><br><span class="line">    <span class="comment">// 2     = 00000010</span></span><br><span class="line">    <span class="comment">// 1 | 2 = 00000011 = 3</span></span><br><span class="line">    fmt.Println(<span class="number">1</span> | <span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use bitwise OR | to get the bits that are in 1 OR 5</span></span><br><span class="line">    <span class="comment">// 1     = 00000001</span></span><br><span class="line">    <span class="comment">// 5     = 00000101</span></span><br><span class="line">    <span class="comment">// 1 | 5 = 00000101 = 5</span></span><br><span class="line">    fmt.Println(<span class="number">1</span> | <span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use bitwise XOR ^ to get the bits that are in 3 OR 6 BUT NOT BOTH</span></span><br><span class="line">    <span class="comment">// 3     = 00000011</span></span><br><span class="line">    <span class="comment">// 6     = 00000110</span></span><br><span class="line">    <span class="comment">// 3 ^ 6 = 00000101 = 5</span></span><br><span class="line">    fmt.Println(<span class="number">3</span> ^ <span class="number">6</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use bitwise AND &amp; to get the bits that are in 3 AND 6</span></span><br><span class="line">    <span class="comment">// 3     = 00000011</span></span><br><span class="line">    <span class="comment">// 6     = 00000110</span></span><br><span class="line">    <span class="comment">// 3 &amp; 6 = 00000010 = 2</span></span><br><span class="line">    fmt.Println(<span class="number">3</span> &amp; <span class="number">6</span>)  </span><br><span class="line"></span><br><span class="line">    <span class="comment">// Use bit clear AND NOT &amp;^ to get the bits that are in 3 AND NOT 6 (order matters)</span></span><br><span class="line">    <span class="comment">// 26     = 00011010</span></span><br><span class="line">    <span class="comment">// 6      = 00000110</span></span><br><span class="line">    <span class="comment">// turn          11111001</span></span><br><span class="line">    <span class="comment">// 3 &amp;^ 6 = 00011000 = 1</span></span><br><span class="line">    fmt.Println(<span class="number">26</span> &amp;^ <span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5  00000101</span></span><br><span class="line"><span class="comment">//-5  11111010+1=1111011 (two's complement of 5, the value was -5)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 6  00000110</span></span><br><span class="line"><span class="comment">//-6  11111001+1=11111010</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 5  00000101</span></span><br><span class="line"><span class="comment">//-6  11111010 (one's complement of 5, the value was -6)</span></span><br><span class="line"></span><br><span class="line">     fmt.Println(^<span class="number">5</span>) </span><br><span class="line"></span><br><span class="line">     a := <span class="number">1</span></span><br><span class="line">     a |= <span class="number">1</span> &lt;&lt; <span class="number">2</span> </span><br><span class="line">     <span class="comment">// 0000100 | 00000001 = 0000101 =5 </span></span><br><span class="line">     </span><br><span class="line">     fmt.Println(a)</span><br><span class="line">     a |= <span class="number">1</span> &lt;&lt; <span class="number">6</span> </span><br><span class="line">     <span class="comment">// 0000101 | 0100000 = 0100101 =69</span></span><br><span class="line">     </span><br><span class="line">     fmt.Println(a)</span><br><span class="line">     fmt.Println(<span class="number">1</span>&lt;&lt;<span class="number">6</span>) </span><br><span class="line">     <span class="comment">//0000001 &lt;&lt;6 = 1000000 = 64</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">24</span></span><br><span class="line"><span class="number">-6</span></span><br><span class="line"><span class="number">5</span></span><br><span class="line"><span class="number">69</span></span><br><span class="line"><span class="number">64</span></span><br></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> golang </category>
            
        </categories>
        
        
        <tags>
            
            <tag> golang </tag>
            
            <tag> bitwise </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[XFS regularly truncating files after crash]]></title>
      <url>http://yoursite.com/2016/03/23/XFS-regularly-truncating-files-after-crash/</url>
      <content type="html"><![CDATA[<p>There are some CentOS 6.2 server loss xxGB data, write a script to recovery</p>
<h3 id="Recover-file"><a href="#Recover-file" class="headerlink" title="Recover file"></a>Recover file</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ ls -ih</span><br><span class="line">70179 -r-xr-xr-x 1 solexa solexa    0 Jan 10  2013 report.htm</span><br><span class="line"></span><br><span class="line">$ xfs_db -r /dev/sdb -c <span class="string">"inode 70179"</span> -c <span class="string">"bmap"</span></span><br><span class="line">data offset 0 startblock 2459337662 (9/43418558) count 1 flag 0a</span><br><span class="line"></span><br><span class="line">$ agblocks=$(xfs_db -r /dev/sdb -c sb -c p | grep ^agblocks | sed <span class="string">'s/.* = //'</span>)</span><br><span class="line">$ <span class="built_in">echo</span> <span class="variable">$agblocks</span></span><br><span class="line">268435455</span><br><span class="line">$ agcount=9</span><br><span class="line">$ b=43418558</span><br><span class="line">$ c=1</span><br><span class="line">$ <span class="built_in">echo</span> $((<span class="variable">$agblocks</span>*<span class="variable">$agcount</span>+<span class="variable">$b</span>)) </span><br><span class="line">2459337653</span><br><span class="line">$ <span class="built_in">echo</span> $((2459337662-9))</span><br><span class="line">2459337653</span><br><span class="line"></span><br><span class="line">$ dd <span class="keyword">if</span>=/dev/sdb bs=4096 skip=$((<span class="variable">$agblocks</span>*<span class="variable">$agcount</span>+<span class="variable">$b</span>)) count=<span class="variable">$c</span> of=/tmp/report.htm</span><br><span class="line">1+0 records <span class="keyword">in</span></span><br><span class="line">1+0 records out</span><br><span class="line">4096 bytes (4.1 kB) copied, 4.6345e-05 s, 88.4 MB/s</span><br><span class="line"></span><br><span class="line">$ cat /tmp/report.htm   <span class="comment"># file come back</span></span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=gbk"</span>/&gt;</span><br><span class="line">&lt;style&gt;</span><br></pre></td></tr></table></figure>
<p><a href="https://bugzilla.redhat.com/show_bug.cgi?id=845233" target="_blank" rel="external">redhat reference</a><br><a href="http://oss.sgi.com/archives/xfs/2012-02/msg00561.html" target="_blank" rel="external">sgi reference</a></p>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> xfs </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Yum tips]]></title>
      <url>http://yoursite.com/2016/03/22/Yum-tips/</url>
      <content type="html"><![CDATA[<h3 id="Exclude-packages"><a href="#Exclude-packages" class="headerlink" title="Exclude packages"></a>Exclude packages</h3><h4 id="Cli"><a href="#Cli" class="headerlink" title="Cli"></a>Cli</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum update --exclude=kernel*</span><br></pre></td></tr></table></figure>
<h4 id="yum-conf"><a href="#yum-conf" class="headerlink" title="yum.conf"></a>yum.conf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[main]</span><br><span class="line">cachedir=/var/cache/yum/<span class="variable">$basearch</span>/<span class="variable">$releasever</span></span><br><span class="line">keepcache=0</span><br><span class="line">debuglevel=2</span><br><span class="line">logfile=/var/<span class="built_in">log</span>/yum.log</span><br><span class="line">exclude=kernel* redhat-release* *.i?86</span><br></pre></td></tr></table></figure>
<p><a href="https://access.redhat.com/solutions/10185" target="_blank" rel="external">reference</a></p>
<h3 id="Switch-version"><a href="#Switch-version" class="headerlink" title="Switch version"></a>Switch version</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$ yum --showduplicates list kernel</span><br><span class="line">Installed Packages</span><br><span class="line">Installed Packages</span><br><span class="line">kernel.x86_64       2.6.32-573.el6       @anaconda-CentOS-201508042137.x86_64/6.7</span><br><span class="line">kernel.x86_64       2.6.32-573.8.1.el6   @update                                 </span><br><span class="line">Available Packages</span><br><span class="line">kernel.x86_64       2.6.32-573.el6       base                                    </span><br><span class="line">kernel.x86_64       2.6.32-573.1.1.el6   update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.3.1.el6   update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.7.1.el6   update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.8.1.el6   update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.12.1.el6  update                                  </span><br><span class="line">kernel.x86_64       2.6.32-573.18.1.el6  update  </span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"><span class="comment">### Save rpms to local</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#### Yum.conf</span></span><br><span class="line">```apacheconf</span><br><span class="line">keepcache = 1</span><br></pre></td></tr></table></figure>
<h4 id="Cli-1"><a href="#Cli-1" class="headerlink" title="Cli"></a>Cli</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ yum -y install yum-plugin-downloadonly</span><br><span class="line">$ yum install --downloadonly --downloaddir=&lt;directory&gt; &lt;package<span class="string">&gt;</span></span><br></pre></td></tr></table></figure>
<p><a href="https://access.redhat.com/solutions/10154" target="_blank" rel="external">reference</a></p>
<h3 id="Resolve-dependency-resolution-errors"><a href="#Resolve-dependency-resolution-errors" class="headerlink" title="Resolve dependency resolution errors"></a>Resolve dependency resolution errors</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum update</span></span><br><span class="line">** Found 5 pre-existing rpmdb problem(s), <span class="string">'yum check'</span> output follows:</span><br><span class="line">MegaCli-8.04.10-1.noarch is a duplicate with MegaCli-8.04.07-1.noarch</span><br><span class="line">kernel-2.6.32-279.5.1.el6_lustre.gb16fe80.x86_64 has missing requires of kernel-firmware &gt;= (<span class="string">'0'</span>, <span class="string">'2.6.32'</span>, <span class="string">'279.5.1.el6_lustre.gb16fe80'</span>)</span><br><span class="line">kernel-firmware-2.6.32-279.5.1.el6.noarch is a duplicate with kernel-firmware-2.6.32-279.el6.noarch</span><br><span class="line">kernel-headers-2.6.32-279.5.1.el6.x86_64 is a duplicate with kernel-headers-2.6.32-279.el6.x86_64</span><br><span class="line">libcom_err-1.42.3.wc3-7.el6.x86_64 is a duplicate with libcom_err-1.41.12-12.el6.i686</span><br><span class="line">......</span><br><span class="line">You could try using --skip-broken to work around the problem</span><br><span class="line">You could try running: rpm -Va --nofiles --nodigest</span><br></pre></td></tr></table></figure>
<h4 id="Uninstall-rpm-packages-from-rpmdb"><a href="#Uninstall-rpm-packages-from-rpmdb" class="headerlink" title="Uninstall rpm packages from rpmdb"></a>Uninstall rpm packages from rpmdb</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ rpm <span class="_">-e</span> --justdb --nodeps <span class="string">"bad rpm packages"</span></span><br><span class="line">$ rpm -ivh --force <span class="string">"replace normal rpm packages"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rebuild rpmdb</span></span><br><span class="line">$ <span class="built_in">cd</span> /var/lib/rpm</span><br><span class="line">$ rm  <span class="_">-f</span> __db*</span><br><span class="line">$ rpm --rebuilddb </span><br><span class="line"></span><br><span class="line">$ yum clean all</span><br><span class="line">$ yum -y update</span><br></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> tips </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> cli </tag>
            
            <tag> yum </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[High availability cluster in linux]]></title>
      <url>http://yoursite.com/2016/03/22/High-availability-cluster-in-linux/</url>
      <content type="html"><![CDATA[<h3 id="pcs"><a href="#pcs" class="headerlink" title="pcs"></a>pcs</h3><h4 id="CentOS-7-Initialization"><a href="#CentOS-7-Initialization" class="headerlink" title="CentOS 7 Initialization"></a>CentOS 7 Initialization</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ scp /etc/hosts nodeA:/etc/ </span><br><span class="line">$ scp /etc/hosts nodeB:/etc/ </span><br><span class="line"></span><br><span class="line">$ yum -y install pacemaker corosync fence-agents-all fence-agents-virsh fence-virt  pacemaker-remote pcs</span><br><span class="line">$ <span class="built_in">echo</span> hacluster | passwd --stdin hacluster</span><br><span class="line">$ systemctl <span class="built_in">enable</span> pcsd.service</span><br><span class="line">$ systemctl start pcsd.service</span><br><span class="line">$ systemctl is-active pcsd.service</span><br><span class="line">$ pcs cluster auth node01 node02 ….</span><br><span class="line">$ pcs cluster setup --start --name ha-kvm node01 node02 …</span><br><span class="line">$ pcs cluster <span class="built_in">enable</span> --all</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2 nodes cluster need to disable quorum</span></span><br><span class="line">$ pcs property <span class="built_in">set</span> stonith-enabled=ture</span><br><span class="line">$ pcs property <span class="built_in">set</span> no-quorum-policy=ignore</span><br></pre></td></tr></table></figure>
<h4 id="Create-fence"><a href="#Create-fence" class="headerlink" title="Create fence"></a>Create fence</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ pcs stonith create NodeB-fencing fence_ipmilan pcmk_host_list=<span class="string">"NodeB"</span> ipaddr=<span class="string">"192.xx.xx.xx"</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_<span class="built_in">wait</span>=4 op monitor interval=60s</span><br><span class="line"></span><br><span class="line"><span class="comment"># search fence device metadata</span></span><br><span class="line">$ stonith_admin -M <span class="_">-a</span> fence_ipmilan</span><br><span class="line"></span><br><span class="line"><span class="comment"># Fence the node</span></span><br><span class="line">$ stonith_admin --reboot nodename</span><br></pre></td></tr></table></figure>
<p><a href="http://clusterlabs.org/wiki/Configure_Multiple_Fencing_Devices_Using_pcs" target="_blank" rel="external">config fence level</a></p>
<h4 id="Create-resource"><a href="#Create-resource" class="headerlink" title="Create resource"></a>Create resource</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># VIP</span></span><br><span class="line">$ pcs resource create ClusterIP ocf:heartbeat:IPaddr2 ip=<span class="string">"192.xx.xx.xx"</span> cidr_netmask=32 nic=eth0 op monitor interval=30s</span><br><span class="line"></span><br><span class="line"><span class="comment"># kvm</span></span><br><span class="line">$ pcs resource create vm01 VirtualDomain hypervisor=<span class="string">"qemu:///system"</span> config=<span class="string">"/xx/xx/vm01.xml"</span>  meta remote-node=<span class="string">"vm01"</span>a</span><br><span class="line"></span><br><span class="line"><span class="comment"># filesystem</span></span><br><span class="line">$ pcs resource create Lustre-mgs ocf:heartbeat:Filesystem device=<span class="string">"/dev/sdb1"</span> directory=<span class="string">"/mnt"</span> fstype=<span class="string">"ext4"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># NFS</span></span><br><span class="line">$ pcs resource create WebFS ocf:heartbeat:Filesystem device=<span class="string">"192.xx.xx.xx:/mysqldata"</span> directory=<span class="string">"/var/lib/mysql"</span> fstype=<span class="string">"nfs"</span> options=<span class="string">"-o username=your_name,password=your_password"</span> op start timeout=60s op stop timeout=60s op monitor interval=20s timeout=60s</span><br><span class="line"></span><br><span class="line"><span class="comment"># iscsi</span></span><br><span class="line">$ pcs resource create WebData ocf:heartbeat:iscsi portal=<span class="string">"ip.xx.xx.xx"</span> target=<span class="string">"iqn.2008-08.com.starwindsoftware:"</span> op monitor depth=<span class="string">"0"</span> timeout=<span class="string">"30"</span> interval=<span class="string">"120"</span></span><br></pre></td></tr></table></figure>
<h4 id="Resource-group"><a href="#Resource-group" class="headerlink" title="Resource group"></a>Resource group</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">$  pcs resource group add group_name resource_01 resource_02 ...</span><br><span class="line">$  pcs resource group remove group_name resource_01 resource_02 ...</span><br><span class="line"></span><br><span class="line"><span class="comment"># resource1 run on the same machine as resource2</span></span><br><span class="line">$ pcs constraint colocation add myresource1 with myresource2 score=INFINITY</span><br><span class="line"><span class="comment"># myresource1 cannot run on the same machine as myresource2</span></span><br><span class="line">$ pcs constraint colocation add myresource1 with myresource2 score=-INFINITY</span><br><span class="line"><span class="comment"># Remove colocation constraints</span></span><br><span class="line">$  pcs constraint colocation remove &lt;<span class="built_in">source</span> resource id&gt; &lt;target resource id&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Resource priorities</span></span><br><span class="line">$ pcs constraint order resource1 <span class="keyword">then</span> resource2</span><br><span class="line">$ pcs constraint order remove  resource1</span><br><span class="line"></span><br><span class="line"><span class="comment"># Node priorities, the resource prefers run on ServerA , the resource could fail over to ServerB</span></span><br><span class="line">$ pcs constraint location resource_id prefers ServerA=200</span><br><span class="line">$ pcs constraint location resource_id prefers ServerB=0</span><br><span class="line"></span><br><span class="line"><span class="comment"># List all current location, order and colocation constraints</span></span><br><span class="line">$ pcs constraint --full</span><br></pre></td></tr></table></figure>
<h4 id="Backup-Restore-config"><a href="#Backup-Restore-config" class="headerlink" title="Backup/Restore config"></a>Backup/Restore config</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># exprot config</span></span><br><span class="line">$ pcs cluster cib filename</span><br><span class="line"></span><br><span class="line"><span class="comment"># import config</span></span><br><span class="line">$ pcs cluster cib-push filename</span><br></pre></td></tr></table></figure>
<h4 id="Show-config"><a href="#Show-config" class="headerlink" title="Show config"></a>Show config</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ pcs config show</span><br><span class="line">$ pcs stonith show stonith-name</span><br><span class="line">$ pcs resource show resource-name</span><br></pre></td></tr></table></figure>
<h4 id="get-default-value"><a href="#get-default-value" class="headerlink" title="get default value"></a>get default value</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ pcs resource defaults</span><br><span class="line"></span><br><span class="line">$ pcs resource defaults migration-threshold=5</span><br><span class="line">$ pcs resource defaults failure-timeout=240s</span><br><span class="line"></span><br><span class="line"><span class="comment"># not switch resource</span></span><br><span class="line">$ pcs resource defaults resource-stickiness=100</span><br><span class="line"></span><br><span class="line"><span class="comment"># resource timeout</span></span><br><span class="line">$ pcs resource op defaults timeout=240s</span><br><span class="line"></span><br><span class="line">$ pcs property <span class="built_in">set</span> stonith-action=reboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># delete</span></span><br><span class="line">$ pcs resource defaults timeouts=</span><br></pre></td></tr></table></figure>
<h4 id="Switch-and-delete-resource"><a href="#Switch-and-delete-resource" class="headerlink" title="Switch and delete resource"></a>Switch and delete resource</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ pcs resource move resource_name HostnameB</span><br><span class="line">$ pcs resource delete resource_name</span><br></pre></td></tr></table></figure>
<h4 id="Get-status"><a href="#Get-status" class="headerlink" title="Get status"></a>Get status</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ pcs status  	</span><br><span class="line">$ pcs status cluster</span><br><span class="line">$ pcs status corosync</span><br><span class="line">$ pcs cluster stop [nodename]  </span><br><span class="line">$ pcs cluster start --all</span><br><span class="line">$ pcs cluster standby nodename</span><br></pre></td></tr></table></figure>
<h4 id="Clean-info"><a href="#Clean-info" class="headerlink" title="Clean info"></a>Clean info</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># clean all error messages and error counts</span></span><br><span class="line">$ pcs resource cleanup resource_id</span><br><span class="line">$ pcs stonith cleanup fence_name</span><br></pre></td></tr></table></figure>
<p><a href="http://clusterlabs.org/wiki/Configure_Multiple_Fencing_Devices_Using_pcs" target="_blank" rel="external">reference</a></p>
<p>#### </p>
<h3 id="pacemaker"><a href="#pacemaker" class="headerlink" title="pacemaker"></a>pacemaker</h3><h4 id="clear-all-pacemaker-config"><a href="#clear-all-pacemaker-config" class="headerlink" title="clear all pacemaker config"></a>clear all pacemaker config</h4><p>Delete conf files from all nodes and restart services.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ rm <span class="_">-f</span> /var/lib/pacemaker/cib/*</span><br><span class="line">$ systemctl stop pacemaker</span><br><span class="line">$ systemctl stop corosync</span><br><span class="line">$ systemctl start corosync</span><br><span class="line">$ systemctl start pacemaker</span><br></pre></td></tr></table></figure></p>
<h3 id="corosync"><a href="#corosync" class="headerlink" title="corosync"></a>corosync</h3><p>####<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">$ corosync-cfgtool <span class="_">-s</span>  </span><br><span class="line">Printing ring status.</span><br><span class="line">Local node ID 2</span><br><span class="line">RING ID 0</span><br><span class="line">	id	= 10.xx.xx.xx</span><br><span class="line">	status	= ring 0 active with no faults</span><br><span class="line">RING ID 1</span><br><span class="line">	id	= 172.xx.xx.xx</span><br><span class="line">	status	= ring 1 active with no faults</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ corosync-quorumtool -siH</span><br><span class="line">Quorum information</span><br><span class="line">------------------</span><br><span class="line">Date:             Tue Mar 22 04:07:15 2016</span><br><span class="line">Quorum provider:  corosync_votequorum</span><br><span class="line">Nodes:            3</span><br><span class="line">Node ID:          0x00000002</span><br><span class="line">Ring ID:          656</span><br><span class="line">Quorate:          Yes</span><br><span class="line"></span><br><span class="line">Votequorum information</span><br><span class="line">----------------------</span><br><span class="line">Expected votes:   3</span><br><span class="line">Highest expected: 3</span><br><span class="line">Total votes:      3</span><br><span class="line">Quorum:           2</span><br><span class="line">Flags:            Quorate </span><br><span class="line"></span><br><span class="line">Membership information</span><br><span class="line">----------------------</span><br><span class="line">    Nodeid      Votes Name</span><br><span class="line">0x00000001          1 10.x.x.x</span><br><span class="line">0x00000003          1 10.x.x.x</span><br><span class="line">0x00000002          1 10.x.x.x (<span class="built_in">local</span>)</span><br></pre></td></tr></table></figure></p>
<h4 id="3-x-CentOS-7-corosync-conf"><a href="#3-x-CentOS-7-corosync-conf" class="headerlink" title="3 x CentOS 7 corosync.conf"></a>3 x CentOS 7 corosync.conf</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">totem &#123;</span><br><span class="line"><span class="attr">    version:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">    secauth:</span> off</span><br><span class="line"><span class="attr">    rrp_mode:</span>active</span><br><span class="line"><span class="attr">    cluster_name:</span> ha-kvm</span><br><span class="line"><span class="attr">    transport:</span> udpu</span><br><span class="line"><span class="attr">    token:</span> <span class="number">17000</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nodelist &#123;</span><br><span class="line">  node &#123;</span><br><span class="line"><span class="attr">        ring0_addr:</span> nic0.serverA.xx.xx</span><br><span class="line"><span class="attr">        ring1_addr:</span> nic1.serverA.xx.xx</span><br><span class="line"><span class="attr">        nodeid:</span> <span class="number">1</span></span><br><span class="line">       &#125;</span><br><span class="line">  node &#123;</span><br><span class="line"><span class="attr">        ring0_addr:</span> nic0.serverB.xx.xx</span><br><span class="line"><span class="attr">        ring1_addr:</span> nic1.serverB.xx.xx</span><br><span class="line"><span class="attr">        nodeid:</span> <span class="number">2</span></span><br><span class="line">       &#125;</span><br><span class="line">  node &#123;</span><br><span class="line"><span class="attr">        ring0_addr:</span> nic0.serverC.xx.xx</span><br><span class="line"><span class="attr">        ring1_addr:</span> nic1.serverC.xx.xx</span><br><span class="line"><span class="attr">        nodeid:</span> <span class="number">3</span></span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">quorum &#123;</span><br><span class="line"><span class="attr">    provider:</span> corosync_votequorum</span><br><span class="line"><span class="attr">    expected_votes:</span> <span class="number">3</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line"><span class="attr">        fileline:</span> off</span><br><span class="line"><span class="attr">        to_logfile:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">        to_syslog:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">        logfile:</span> /var/log/cluster/corosync.log</span><br><span class="line"><span class="attr">        timestamp:</span> on</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-x-CentOS6-corosync-conf"><a href="#2-x-CentOS6-corosync-conf" class="headerlink" title="2 x CentOS6 corosync.conf"></a>2 x CentOS6 corosync.conf</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"># Please read the corosync.conf.5 manual page</span><br><span class="line">compatibility: xxxx</span><br><span class="line"></span><br><span class="line">totem &#123;</span><br><span class="line">	version: 2</span><br><span class="line">	secauth: off</span><br><span class="line">	interface &#123;</span><br><span class="line">		member &#123;</span><br><span class="line">			memberaddr: nic0.serverA.xx.xx</span><br><span class="line">		&#125;</span><br><span class="line">		member &#123;</span><br><span class="line">			memberaddr: nic0.serverB.xx.xx</span><br><span class="line">		&#125;</span><br><span class="line">		ringnumber: 0</span><br><span class="line">		bindnetaddr: nic0.xx.xx.xx</span><br><span class="line">		mcastport: 5406</span><br><span class="line">		ttl: 1</span><br><span class="line">	&#125;</span><br><span class="line">	interface &#123;</span><br><span class="line">                member &#123;</span><br><span class="line">                        memberaddr: nic1.serverA.xx.xx</span><br><span class="line">                &#125;</span><br><span class="line">                member &#123;</span><br><span class="line">                        memberaddr: nic1.serverB.xx.xx</span><br><span class="line">                &#125;</span><br><span class="line">                ringnumber: 1</span><br><span class="line">                bindnetaddr: nic1.xx.xx.xx</span><br><span class="line">                mcastport: 5406</span><br><span class="line">                ttl: 1</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">	transport: udpu</span><br><span class="line">	token: 17000</span><br><span class="line">	rrp_mode: passive</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line">	fileline: off</span><br><span class="line">	to_logfile: yes</span><br><span class="line">	to_syslog: yes</span><br><span class="line">	debug: on</span><br><span class="line">	logfile: /var/log/cluster/corosync.log</span><br><span class="line">	debug: off</span><br><span class="line">	timestamp: on</span><br><span class="line">	logger_subsys &#123;</span><br><span class="line">		subsys: AMF</span><br><span class="line">		debug: off</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="http://qiita.com/tukiyo3/items/3f8b99be73798df857fd" target="_blank" rel="external">config refence</a></p>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> ha </tag>
            
            <tag> corosync </tag>
            
            <tag> pacemaker </tag>
            
            <tag> pcs </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Software install at centos 5/6]]></title>
      <url>http://yoursite.com/2016/03/22/Software-install-at-centos-5-6/</url>
      <content type="html"><![CDATA[<h3 id="Install-python-matplotlib"><a href="#Install-python-matplotlib" class="headerlink" title="Install python matplotlib"></a>Install python matplotlib</h3><h4 id="version-1-5"><a href="#version-1-5" class="headerlink" title="version 1.5"></a>version 1.5</h4><h4 id="freetype-2-3-or-later"><a href="#freetype-2-3-or-later" class="headerlink" title="freetype 2.3 or later"></a>freetype 2.3 or later</h4><h4 id="CentOS-5"><a href="#CentOS-5" class="headerlink" title="CentOS 5"></a>CentOS 5</h4><p>free type &lt; 2.3<br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ rpm -qa | grep freetype</span><br><span class="line">freetype-devel-2.2.1-32.el5_9.1</span><br><span class="line">$ sudo yum -y install freetype freetype-devel libpng-devel lapack-devel</span><br><span class="line">$ pip install numpy==1.8</span><br><span class="line">$ pip install matplotlib==1.3.1</span><br></pre></td></tr></table></figure></p>
<p>Because matplotlib dependencies numpy version, if you installed higher numpy version, There are some errors in the installation process.</p>
<p><a href="http://stackoverflow.com/questions/22076553/matplotlib-install-issues-pip-centos-freetype-missing-when-it-is-installed" target="_blank" rel="external">reference</a></p>
]]></content>
      
        <categories>
            
            <category> Software install </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> software </tag>
            
            <tag> dependencies </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Mariadb benchmark iops]]></title>
      <url>http://yoursite.com/2016/03/01/Mariadb-benchmark-iops/</url>
      <content type="html"><![CDATA[<h3 id="Install-sysbench-0-5"><a href="#Install-sysbench-0-5" class="headerlink" title="Install sysbench 0.5"></a>Install sysbench 0.5</h3><p>OS version: CentOS 7</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mkdir /var/lib/mysql &amp;&amp; mount /dev/sdb1 /var/lib/mysql</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"deadline"</span> &gt; /sys/class/block/sdb/queue/scheduler</span><br><span class="line">yum install git automake libtool</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/hgxl64/sysbench-mariadb.git</span><br><span class="line"><span class="built_in">cd</span> sysbench-mariadb</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line"><span class="built_in">cd</span> sysbech/</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:$(<span class="built_in">pwd</span>)/</span><br><span class="line">sysbench --version</span><br><span class="line">sysbench 0.5</span><br></pre></td></tr></table></figure>
<h3 id="Install-mariadb"><a href="#Install-mariadb" class="headerlink" title="Install mariadb"></a>Install mariadb</h3><p><a href="https://downloads.mariadb.org/mariadb/repositories/#mirror=syringa&amp;distro=CentOS&amp;distro_release=centos7-amd64--centos7&amp;version=10.1" target="_blank" rel="external">MariaDB.repo</a></p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MariaDB 10.1 CentOS repository list - created 2016-03-02 02:05 UTC</span></span><br><span class="line"><span class="comment"># http://mariadb.org/mariadb/repositories/</span></span><br><span class="line">[mariadb]</span><br><span class="line">name = MariaDB</span><br><span class="line">baseurl = <span class="symbol">http:</span>/<span class="regexp">/yum.mariadb.org/</span><span class="number">10.1</span>/centos7-amd64</span><br><span class="line">gpgkey=<span class="symbol">https:</span>/<span class="regexp">/yum.mariadb.org/</span>RPM-GPG-KEY-MariaDB</span><br><span class="line">gpgcheck=<span class="number">1</span></span><br><span class="line"></span><br><span class="line">yum install mariadb-server mariadb-client mariadb-devel</span><br></pre></td></tr></table></figure>
<h3 id="limit-conf"><a href="#limit-conf" class="headerlink" title="limit.conf"></a>limit.conf</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*               soft    nofile           <span class="number">20000</span></span><br><span class="line">*               hard    nofile           <span class="number">20000</span></span><br><span class="line">*               soft    nproc            <span class="number">20000</span></span><br><span class="line">*               hard    nproc            <span class="number">20000</span></span><br></pre></td></tr></table></figure>
<h3 id="my-cnf-ubuntu-16-04-mariadb-10-1"><a href="#my-cnf-ubuntu-16-04-mariadb-10-1" class="headerlink" title="my.cnf (ubuntu 16.04, mariadb 10.1)"></a>my.cnf (ubuntu 16.04, mariadb 10.1)</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"> cat /etc/mysql/my.cnf | grep -v \#</span><br><span class="line"></span><br><span class="line">[client]</span><br><span class="line">port		= 3306</span><br><span class="line">socket		= /var/run/mysqld/mysqld.sock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line">socket		= /var/run/mysqld/mysqld.sock</span><br><span class="line">nice		= 0</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">user		= mysql</span><br><span class="line">pid-file	= /var/run/mysqld/mysqld.pid</span><br><span class="line">socket		= /var/run/mysqld/mysqld.sock</span><br><span class="line">port		= 3306</span><br><span class="line">basedir		= /usr</span><br><span class="line">datadir		= /var/lib/mysql</span><br><span class="line">tmpdir		= /tmp</span><br><span class="line">lc_messages_dir	= /usr/share/mysql</span><br><span class="line">lc_messages	= en_US</span><br><span class="line">skip-external-locking</span><br><span class="line">bind-address		= 127.0.0.1</span><br><span class="line">max_connections		= 1024</span><br><span class="line">connect_timeout		= 60</span><br><span class="line">wait_timeout		= 600</span><br><span class="line">max_allowed_packet	= 16M</span><br><span class="line">thread_cache_size       = 128</span><br><span class="line">sort_buffer_size	= 4M</span><br><span class="line">bulk_insert_buffer_size	= 16M</span><br><span class="line">tmp_table_size		= 32M</span><br><span class="line">max_heap_table_size	= 32M</span><br><span class="line">myisam_recover_options = BACKUP</span><br><span class="line">key_buffer_size		= 8M</span><br><span class="line">table_open_cache	= 800</span><br><span class="line">myisam_sort_buffer_size	= 512M</span><br><span class="line">concurrent_insert	= 2</span><br><span class="line">general_log             = 0</span><br><span class="line">log_warnings		= 2</span><br><span class="line">slow_query_log_file	= /var/log/mysql/mariadb-slow.log</span><br><span class="line">long_query_time = 60</span><br><span class="line">log_slow_verbosity	= query_plan</span><br><span class="line"></span><br><span class="line">#log_bin			= /var/log/mysql/mariadb-bin</span><br><span class="line">#log_bin_index		= /var/log/mysql/mariadb-bin.index</span><br><span class="line">#expire_logs_days	= 10</span><br><span class="line">#max_binlog_size         = 100M</span><br><span class="line">#diable /var/log/mysql bin-logs</span><br><span class="line">skip-log-bin</span><br><span class="line">default_storage_engine	= InnoDB</span><br><span class="line">innodb_log_file_size	= 50M</span><br><span class="line">innodb_buffer_pool_size	= 256M</span><br><span class="line">innodb_log_buffer_size	= 16M</span><br><span class="line">innodb_file_per_table	= true</span><br><span class="line">innodb_open_files	= 4000</span><br><span class="line">innodb_io_capacity	= 4000</span><br><span class="line">innodb_lru_scan_depth   = 4000</span><br><span class="line">innodb_flush_method	= O_DIRECT</span><br><span class="line">innodb_use_trim=ON</span><br><span class="line">innodb_use_fallocate=ON</span><br><span class="line">innodb_page_size=16k</span><br><span class="line">innodb_thread_concurrency=0</span><br><span class="line">innodb_write_io_threads=24</span><br><span class="line">innodb_read_io_threads=24</span><br><span class="line">innodb_buffer_pool_instances=16</span><br><span class="line">innodb_mtflush_threads=16</span><br><span class="line">innodb_doublewrite=0</span><br><span class="line"></span><br><span class="line">[galera]</span><br><span class="line"></span><br><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">quote-names</span><br><span class="line">max_allowed_packet	= 16M</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line"></span><br><span class="line">[isamchk]</span><br><span class="line">key_buffer		= 16M</span><br><span class="line"></span><br><span class="line">!includedir /etc/mysql/conf.d/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ulimit -n 20000</span><br><span class="line">mysqld_safe --defaults-file=/etc/my.cnf</span><br><span class="line">mysql -u root -e "create database sbtest"</span><br></pre></td></tr></table></figure>
<h3 id="Run-benchmark"><a href="#Run-benchmark" class="headerlink" title="Run benchmark"></a>Run benchmark</h3><p>If you have password, please add “–mysql-password=yourpass”</p>
<h3 id="prepare"><a href="#prepare" class="headerlink" title="prepare"></a>prepare</h3><p>Could not use prepare, run means parallel.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=tests/db/parallel_prepare.lua --mysql-host=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> --mysql-port=<span class="number">3306</span> --mysql-user=root --oltp-tables-count=<span class="number">128</span> --oltp-table-size=<span class="number">500000</span> --num-threads=<span class="number">128</span> --max-time=<span class="number">300</span> run</span><br></pre></td></tr></table></figure></p>
<h3 id="read"><a href="#read" class="headerlink" title="read"></a>read</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=tests/db/oltp.lua --mysql-host=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> --mysql-port=<span class="number">3306</span> --mysql-user=root --mysql-db=sbtest --oltp_tables_count=<span class="number">128</span> --oltp-table-size=<span class="number">500000</span>  --rand-type=uniform --oltp-read-only=on --num-threads=<span class="number">128</span> --max-requests=<span class="number">0</span> --max-time=<span class="number">300</span> --report-interval=<span class="number">3</span> run</span><br></pre></td></tr></table></figure>
<h3 id="rw"><a href="#rw" class="headerlink" title="rw"></a>rw</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=tests/db/oltp.lua --mysql-host=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> --mysql-port=<span class="number">3306</span> --mysql-user=root --mysql-db=sbtest --oltp_tables_count=<span class="number">128</span> --oltp-table-size=<span class="number">500000</span>  --rand-type=uniform --oltp-read-only=off --num-threads=<span class="number">128</span> --max-requests=<span class="number">0</span> --max-time=<span class="number">300</span> --report-interval=<span class="number">3</span> run</span><br></pre></td></tr></table></figure>
<h3 id="update"><a href="#update" class="headerlink" title="update"></a>update</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=tests/db/update_non_index.lua --mysql-host=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> --mysql-port=<span class="number">3306</span> --mysql-user=root --mysql-db=sbtest --oltp_tables_count=<span class="number">128</span> --oltp-table-size=<span class="number">500000</span>  --rand-type=uniform --oltp-read-only=off --num-threads=<span class="number">128</span> --max-requests=<span class="number">0</span> --max-time=<span class="number">300</span> --report-interval=<span class="number">3</span> run</span><br></pre></td></tr></table></figure>
<h3 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysbench --test=tests/db/<span class="keyword">delete</span>.lua --mysql-host=<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> --mysql-port=<span class="number">3306</span> --mysql-user=root --mysql-db=sbtest --oltp_tables_count=<span class="number">128</span> --oltp-table-size=<span class="number">500000</span>  --rand-type=uniform --oltp-read-only=off --num-threads=<span class="number">128</span> --max-requests=<span class="number">0</span> --max-time=<span class="number">300</span> --report-interval=<span class="number">3</span> run</span><br></pre></td></tr></table></figure>
<h3 id="result"><a href="#result" class="headerlink" title="result"></a>result</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">OLTP test statistics:</span><br><span class="line">    queries performed:</span><br><span class="line"><span class="attr">        read:</span>                            <span class="number">492604</span></span><br><span class="line"><span class="attr">        write:</span>                           <span class="number">140744</span></span><br><span class="line"><span class="attr">        other:</span>                           <span class="number">70372</span></span><br><span class="line"><span class="attr">        total:</span>                           <span class="number">703720</span></span><br><span class="line"><span class="attr">    transactions:</span>                        <span class="number">35186</span>  (<span class="number">117.12</span> per sec.)</span><br><span class="line">    read/write requests:                 <span class="number">633348</span> (<span class="number">2108.17</span> per sec.)</span><br><span class="line">    other operations:                    <span class="number">70372</span>  (<span class="number">234.24</span> per sec.)</span><br><span class="line">    ignored errors:                      <span class="number">0</span>      (<span class="number">0.00</span> per sec.)</span><br><span class="line"><span class="attr">    reconnects:</span>                          <span class="number">0</span>      (<span class="number">0.00</span> per sec.)</span><br><span class="line"></span><br><span class="line">General statistics:</span><br><span class="line">    total time:                          <span class="number">300.4258</span>s</span><br><span class="line">    total number of events:              <span class="number">35186</span></span><br><span class="line">    total time taken by event execution: <span class="number">9603.6924</span>s</span><br><span class="line">    response time:</span><br><span class="line"><span class="attr">         min:</span>                                 <span class="number">53.39</span>ms</span><br><span class="line"><span class="attr">         avg:</span>                                <span class="number">272.94</span>ms</span><br><span class="line"><span class="attr">         max:</span>                               <span class="number">1713.77</span>ms</span><br><span class="line">         approx.  <span class="number">95</span> percentile:             <span class="number">496.65</span>ms</span><br><span class="line"></span><br><span class="line">Threads fairness:</span><br><span class="line">    events (avg/stddev):           <span class="number">1099.5625</span>/<span class="number">11.17</span></span><br><span class="line">    execution time (avg/stddev):   <span class="number">300.1154</span>/<span class="number">0.12</span></span><br></pre></td></tr></table></figure>
<h3 id="About-performance-in-openzfs"><a href="#About-performance-in-openzfs" class="headerlink" title="About performance in openzfs"></a>About performance in openzfs</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ zpool  create <span class="_">-f</span> tank -m /var/lib/mysql /dev/sdc  -o ashift=12</span><br><span class="line">$ zfs <span class="built_in">set</span> recordsize=16K tank</span><br><span class="line">$ zfs <span class="built_in">set</span> primarycache=metadata tank</span><br></pre></td></tr></table></figure>
<p>“zfs set logbias=throughput” has no good effect.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; SHOW VARIABLES LIKE <span class="string">"innodb_page_size"</span>;</span><br><span class="line">+------------------+-------+</span><br><span class="line">| Variable_name    | Value <span class="string">|</span><br><span class="line">+------------------+-------+</span><br><span class="line">| innodb_page_size | 16384 |</span><br><span class="line">+------------------+-------+</span><br><span class="line">1 row in set (0.00 sec)</span></span><br></pre></td></tr></table></figure>
<p><a href="https://wiki.archlinux.org/index.php/ZFS#Database" target="_blank" rel="external">zfs db</a><br><a href="https://www-304.ibm.com/partnerworld/wps/servlet/download/DownloadServlet?id=YxooL$U5GZkiPCA$cnt&amp;attachmentName=primer_to_run_sysbench_and_mariadb_benchmarks_on_lop.pdf&amp;token=MTQ1NjgyMjIzMTcyNA==&amp;locale=en_ALL_ZZ" target="_blank" rel="external">reference</a><br><a href="https://mariadb.org/using-lua-enabled-sysbench/" target="_blank" rel="external">reference2</a></p>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> iops </tag>
            
            <tag> mariadb </tag>
            
            <tag> sysbench </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[VLC not show media title]]></title>
      <url>http://yoursite.com/2016/03/01/VLC-not-show-media-title/</url>
      <content type="html"><![CDATA[<h4 id="Not-show-media-title"><a href="#Not-show-media-title" class="headerlink" title="Not show media title"></a>Not show media title</h4><p><a href="https://forum.videolan.org/viewtopic.php?t=50202" target="_blank" rel="external">Same question</a><br>Tools–&gt;Preferences–&gt;Subtitles / OSD–&gt; Show media title on media start (disable it)<br>Tools–&gt;Preferences–&gt;Subtitles / OSD–&gt; Enable on screen display (disable it)</p>
<h4 id="Not-resize-interface"><a href="#Not-resize-interface" class="headerlink" title="Not resize interface"></a>Not resize interface</h4><p><img src="/img/vlc-set1.png" alt=""></p>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> vlc </tag>
            
            <tag> desktop </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Install robinhood]]></title>
      <url>http://yoursite.com/2016/02/18/Install-robinhood/</url>
      <content type="html"><![CDATA[<p>Just analyse lustre data, not remove or move any file and directory.<br>And I created zfs pool in /var/lib/mysql, and enable lz4 compression.<br>Now here is compressratio<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># zfs get compressratio tank</span></span><br><span class="line">NAME  PROPERTY       VALUE  SOURCE</span><br><span class="line">tank  compressratio  2.50x  -</span><br></pre></td></tr></table></figure></p>
<p>CentOS 7.2 and Robinhood 2.5.5<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum -y install mariadb-devel libuuid-devel mailx glib2-devel libattr-devel mariadb-server attr</span></span><br><span class="line"><span class="comment"># tar xzvf robinhood-2.5.5.tar.gz</span></span><br><span class="line"><span class="comment"># cd robinhood</span></span><br><span class="line"><span class="comment"># ./configure --with-purpose=TMPFS</span></span><br><span class="line">or</span><br><span class="line"><span class="comment"># ./configure --with-purpose=LUSTRE_HSM</span></span><br><span class="line"><span class="comment"># make rpm</span></span><br><span class="line"><span class="comment"># rpm -ivh robinhood-tmpfs-2.5.5-4.lustre2.5.el7.centos.x86_64 robinhood-adm-2.5.5-4.noarch.x86_64</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Init-mariadb"><a href="#Init-mariadb" class="headerlink" title="Init mariadb"></a>Init mariadb</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl enable mariadb</span></span><br><span class="line"><span class="comment"># systemctl start mariadb</span></span><br><span class="line"><span class="comment"># mysqladmin -u root password "your root password";</span></span><br><span class="line"><span class="comment"># rbh-config create_db</span></span><br></pre></td></tr></table></figure>
<p>Modify /etc/robinhood.d/tmpfs/templates/tmpfs_detailed.conf as your wish, and save it to /etc/robinhood.d/tmpfs/tmpfs.conf.</p>
<h3 id="Enable-lustre-changelog"><a href="#Enable-lustre-changelog" class="headerlink" title="Enable lustre changelog"></a>Enable lustre changelog</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ChangeLog</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"># 1 MDT block for each MDT :</span></span><br><span class="line">    MDT</span><br><span class="line">    &#123;</span><br><span class="line">        mdt_name = <span class="string">"MDT0000"</span> ;</span><br><span class="line">        reader_id = <span class="string">"cl1"</span> ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># clear changelog every 1024 records:</span></span><br><span class="line">    batch_ack_count = 1024 ;</span><br><span class="line"></span><br><span class="line">    force_polling    = ON ;</span><br><span class="line">    polling_interval = 1s ;</span><br><span class="line">    queue_max_size   = 1000 ;</span><br><span class="line">    queue_max_age    = 5s ;</span><br><span class="line">    queue_check_interval = 1s ;</span><br><span class="line">    dump_file = <span class="string">"/var/lib/mysql/robinhood/changelog_dump.log"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># lctl --device lustrefs-MDT0000 changelog_register</span></span><br><span class="line">lustrefs-MDT0000: Registered changlog userid <span class="string">'cl1'</span></span><br><span class="line"><span class="comment"># lctl set_param mdd.lustrefs-MDT*.changelog_mask "MARK CREAT MKDIR HLINK SLINK MKNOD UNLNK RMDIR RENME RNMTO OPEN LYOUT TRUNC SATTR XATTR HSM MTIME CTIME"</span></span><br><span class="line"><span class="comment"># lctl get_param mdd.lustrefs-MDT*.changelog_mask </span></span><br><span class="line">MARK CREAT MKDIR HLINK SLINK MKNOD UNLNK RMDIR RENME RNMTO OPEN LYOUT TRUNC SATTR XATTR HSM MTIME CTIME</span><br></pre></td></tr></table></figure>
<h3 id="Run-robinhood"><a href="#Run-robinhood" class="headerlink" title="Run robinhood"></a>Run robinhood</h3><p>write IOPS peak about 9000~10000 in single 10GbE SR SFP+ port.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">robinhood <span class="_">-f</span> /etc/robinhood.d/tmpfs/tmpfs.conf --read-log -C --dry-run --scan</span><br></pre></td></tr></table></figure></p>
<h3 id="Show-data"><a href="#Show-data" class="headerlink" title="Show data"></a>Show data</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rbh-report --top-users -U 10000</span></span><br><span class="line">Using config file <span class="string">'/etc/robinhood.d/tmpfs/tmpfs.conf'</span>.</span><br><span class="line">rank, user      ,   spc_used,      count,   avg_size</span><br><span class="line">   1, 501       ,  142.80 TB,     593083,  252.58 MB</span><br><span class="line">   2, 35061     ,   33.82 TB,      50912,  696.54 MB</span><br><span class="line">   3, 35623     ,   29.91 TB,      42304,  741.30 MB</span><br><span class="line">   4, 666666    ,   26.17 TB,     300038,   91.44 MB</span><br><span class="line">   5, 35939     ,   16.26 TB,    1616106,   10.54 MB</span><br><span class="line">   6, 31344     ,   15.63 TB,     801339,   20.45 MB</span><br><span class="line">   7, 30428     ,   13.54 TB,     272051,   52.19 MB</span><br><span class="line"></span><br><span class="line"><span class="comment"># rbh-report --top-users --by-count</span></span><br><span class="line">Using config file <span class="string">'/etc/robinhood.d/tmpfs/tmpfs.conf'</span>.</span><br><span class="line">rank, user      ,   spc_used,      count,   avg_size</span><br><span class="line">   1, 28904     ,  778.50 GB,    4493723,  179.10 KB</span><br><span class="line">   2, 504       ,    4.14 TB,    2514345,    1.73 MB</span><br><span class="line">   3, 29637     ,    2.81 TB,    2152429,    1.37 MB</span><br><span class="line">   4, 29563     ,  873.35 GB,    1935333,  470.53 KB</span><br><span class="line">   5, 30185     ,  508.22 GB,    1695768,  310.95 KB</span><br><span class="line">   6, 35939     ,   16.26 TB,    1616106,   10.54 MB</span><br><span class="line"></span><br><span class="line"><span class="comment"># rbh-du -sH /lustrefs/share_backup/ -u 30319 --details</span></span><br><span class="line">Using config file <span class="string">'/etc/robinhood.d/tmpfs/tmpfs.conf'</span>.</span><br><span class="line">ls </span><br><span class="line">total</span><br><span class="line">	symlink count:895, size:46.3K, spc_used:1.4M</span><br><span class="line">	dir count:9877, size:42.7M, spc_used:42.7M</span><br><span class="line">	file count:128990, size:5.2T, spc_used:5.2T</span><br><span class="line"></span><br><span class="line"><span class="comment"># rbh-du -H -u 30319</span></span><br><span class="line">Using config file <span class="string">'/etc/robinhood.d/tmpfs/tmpfs.conf'</span>.</span><br><span class="line">5.2T	/lustrefs</span><br><span class="line"></span><br><span class="line"><span class="comment"># rbh-report -u 30319 -S</span></span><br><span class="line">Using config file <span class="string">'/etc/robinhood.d/tmpfs/tmpfs.conf'</span>.</span><br><span class="line">user      ,      group,     <span class="built_in">type</span>,      count,   spc_used,   avg_size</span><br><span class="line">30319     ,        725,  symlink,          5,    4.00 KB,         36</span><br><span class="line">30319     ,        725,      dir,        811,    3.22 MB,    4.07 KB</span><br><span class="line">30319     ,        725,     file,       4388,    5.00 TB,    1.17 GB</span><br><span class="line">30319     ,        820,  symlink,         13,          0,         35</span><br><span class="line">30319     ,        820,      dir,         23,   92.00 KB,    4.00 KB</span><br><span class="line">30319     ,        820,     file,        287,    7.78 GB,   27.77 MB</span><br><span class="line">30319     ,        859,  symlink,        881,    1.38 MB,         53</span><br><span class="line">30319     ,        859,      dir,       9066,   39.48 MB,    4.45 KB</span><br><span class="line">30319     ,        859,     file,     124457,  208.88 GB,    1.72 MB</span><br><span class="line">30319     ,       root,      dir,          1,    4.00 KB,    4.00 KB</span><br><span class="line"></span><br><span class="line"><span class="comment"># rbh-report -u 30319 --szprof</span></span><br><span class="line">Using config file <span class="string">'/etc/robinhood.d/tmpfs/tmpfs.conf'</span>.</span><br><span class="line">user      ,     <span class="built_in">type</span>,      count,   spc_used,   avg_size,        0,     1~31,   32~1K-,   1K~31K,  32K~1M-,   1M~31M,  32M~1G-,   1G~31G,  32G~1T-,      +1T</span><br><span class="line">30319     ,  symlink,        899,    1.39 MB,         53,        0,      357,      542,        0,        0,        0,        0,        0,        0,        0</span><br><span class="line">30319     ,      dir,       9902,   42.80 MB,    4.42 KB,        0,        0,        0,     9875,       27,        0,        0,        0,        0,        0</span><br><span class="line">30319     ,     file,     129132,    5.21 TB,   42.31 MB,     2288,     2300,    31102,    75173,    14854,     2366,      863,      100,       86,        0</span><br><span class="line"></span><br><span class="line">Total: 139933 entries, 5728992747520 bytes used (5.21 TB)</span><br><span class="line"></span><br><span class="line"><span class="comment"># rbh-report --top-users --by-szratio=1G..31G</span></span><br><span class="line">Using config file <span class="string">'/etc/robinhood.d/tmpfs/tmpfs.conf'</span>.</span><br><span class="line">rank, user      ,   spc_used,      count,   avg_size,        0,     1~31,   32~1K-,   1K~31K,  32K~1M-,   1M~31M,  32M~1G-,   1G~31G,  32G~1T-,      +1T, ratio(1G..31G)</span><br><span class="line">   1, 29862     ,    8.96 TB,      10238,  918.14 MB,        9,        2,     1729,     2795,      466,      355,      679,     4185,       18,        0, 40.88%</span><br><span class="line">   2, 35590     ,   37.44 GB,         39,  983.16 MB,        2,        8,       10,        5,        0,        1,        0,       13,        0,        0, 33.33%</span><br><span class="line">   3, 35591     ,   17.47 GB,         22,  812.97 MB,        0,        0,       10,        3,        0,        1,        2,        6,        0,        0, 27.27%</span><br><span class="line">   4, qemu      ,  647.41 GB,        127,    5.27 GB,        0,        0,        5,       39,        3,       39,        6,       31,        4,        0, 24.41%</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rbh-report --top-dirs --by-count</span></span><br><span class="line">Using config file <span class="string">'/etc/robinhood.d/tmpfs/tmpfs.conf'</span>.</span><br><span class="line">rank,                                     path, dircount,    avgsize,       user,      group,             last_mod</span><br><span class="line">   1, /lustrefs/cm/net,  1365749,   56.84 KB,      35697,        904,  2016/02/01 03:58:45</span><br><span class="line">   2, /lustrefs/tte/net,   443993,   54.27 KB,      35697,        904,  2016/01/25 12:24:21</span><br><span class="line">   3, /lustrefs/tte/crf/crf-net,   443993,   39.71 KB,      35697,        904,  2016/01/26 03:04:40</span><br><span class="line">   4, /lustrefs/LabelFree/net,   387909,   82.25 KB,      35697,        904,  2016/01/26 02:36:44</span><br><span class="line">   5, /lustrefs/LabelFree/crf/crf-net,   387909,   50.98 KB,      35697,        904,  2016/01/26 06:02:10</span><br><span class="line"></span><br><span class="line"><span class="comment"># rbh-find /lustrefs/test/ -user 501 -size +1G –ost 4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># rbh-find -user 501 -print</span></span><br><span class="line">/lustrefs/xxxx</span><br><span class="line">/lustrefs/xxx/xxx</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rbh-report -a</span></span><br><span class="line">Using config file <span class="string">'/etc/robinhood.d/tmpfs/tmpfs.conf'</span>.</span><br><span class="line"></span><br><span class="line">Filesystem scan activity:</span><br><span class="line"></span><br><span class="line">    Current scan interval:   7.0d</span><br><span class="line"></span><br><span class="line">    Previous filesystem scan:</span><br><span class="line">            start:           2016/02/17 21:30:40</span><br><span class="line">            duration:        02s</span><br><span class="line"></span><br><span class="line">    Last filesystem scan:</span><br><span class="line">            status:          <span class="keyword">done</span></span><br><span class="line">            start:           2016/02/17 21:30:43</span><br><span class="line">            end:             2016/02/18 09:32:36</span><br><span class="line">            duration:        12h 01min 53s</span><br><span class="line"></span><br><span class="line">         Statistics:</span><br><span class="line">            entries scanned: 58038696</span><br><span class="line">            errors:          1</span><br><span class="line">            timeouts:        0</span><br><span class="line">            <span class="comment"># threads:       24</span></span><br><span class="line">            average speed:   1450.15 entries/sec</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Changelog stats:</span><br><span class="line"></span><br><span class="line">        Last <span class="built_in">read</span> record id:      5151588</span><br><span class="line">        Last <span class="built_in">read</span> record time:    2016/02/19 01:29:42.783530</span><br><span class="line">        Last receive time:        2016/02/19 01:28:56</span><br><span class="line">        Last committed record id: 5151588</span><br><span class="line">        Changelog stats:</span><br><span class="line">                 <span class="built_in">type</span>            total 	(diff)	(rate)</span><br><span class="line">                 MARK:               0</span><br><span class="line">                CREAT:         2363800 	(+30)	(0.03/sec)</span><br><span class="line">                MKDIR:           48696</span><br><span class="line">                HLINK:             110</span><br><span class="line">                SLINK:            1740 	(+2)	(0.00/sec)</span><br><span class="line">                MKNOD:               0</span><br><span class="line">                UNLNK:          137955 	(+161)	(0.13/sec)</span><br><span class="line">                RMDIR:            5993 	(+1)	(0.00/sec)</span><br><span class="line">                RENME:            3798 	(+5)	(0.00/sec)</span><br><span class="line">                RNMTO:               0</span><br><span class="line">                 OPEN:               0</span><br><span class="line">                CLOSE:               0</span><br><span class="line">                LYOUT:               0</span><br><span class="line">                TRUNC:          236843</span><br><span class="line">                SATTR:         2164457 	(+19)	(0.02/sec)</span><br><span class="line">                XATTR:           16732</span><br><span class="line">                  HSM:               0</span><br><span class="line">                MTIME:             284</span><br><span class="line">                CTIME:               0</span><br><span class="line">                ATIME:               0</span><br><span class="line"></span><br><span class="line">Storage usage has never been checked</span><br><span class="line"></span><br><span class="line">No purge was performed on this filesystem</span><br></pre></td></tr></table></figure>
<h3 id="Install-web-interface"><a href="#Install-web-interface" class="headerlink" title="Install web interface"></a>Install web interface</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rpm -ivh robinhood-webgui-2.5.5-4.noarch.x86_64.rpm</span></span><br><span class="line"><span class="comment"># yum -y install php php-mysql php-xml php-pdo php-gd httpd</span></span><br><span class="line"><span class="comment"># chown -R apache.apache /var/www/html/robinhood</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## Modify httpd.conf</span></span><br><span class="line">&lt;Directory <span class="string">"/var/www/html"</span>&gt;</span><br><span class="line">    AllowOverride All</span><br></pre></td></tr></table></figure>
<p>Start httpd<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> httpd</span><br><span class="line">systemctl start httpd</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">```mysql</span><br><span class="line">[mysqld]</span><br><span class="line">user		= mysql</span><br><span class="line">pid-file	= /var/run/mysqld/mysqld.pid</span><br><span class="line">socket		= /var/run/mysqld/mysqld.sock</span><br><span class="line">port		= 3306</span><br><span class="line">basedir		= /usr</span><br><span class="line">datadir		= /var/lib/mysql</span><br><span class="line">tmpdir		= /tmp</span><br><span class="line"></span><br><span class="line">skip-external-locking</span><br><span class="line"></span><br><span class="line">performance_schema</span><br><span class="line">table_open_cache=2028</span><br><span class="line">max_connections=1024</span><br><span class="line">thread_cache_size=512</span><br><span class="line">table_cache=2048</span><br><span class="line">connect_timeout=60</span><br><span class="line">key_buffer_size=512M</span><br><span class="line">query_cache_size=512M</span><br><span class="line">query_cache_<span class="built_in">limit</span>=512M</span><br><span class="line">sort_buffer_size=512M</span><br><span class="line"><span class="built_in">read</span>_rnd_buffer_size=1G</span><br><span class="line">tmp_table_size=1G</span><br><span class="line">max_heap_table_size=1G</span><br><span class="line"></span><br><span class="line">innodb_buffer_pool_size = 16G</span><br><span class="line">innodb_additional_mem_pool_size = 16M</span><br><span class="line">innodb_max_dirty_pages_pct = 20</span><br><span class="line"><span class="comment">#innodb_data_file_path = ibdata1:100M:autoextend</span></span><br><span class="line">innodb_io_capacity=100000</span><br><span class="line">innodb_autoinc_lock_mode = 2</span><br><span class="line">innodb_thread_concurrency = 0</span><br><span class="line">innodb_<span class="built_in">log</span>_buffer_size = 256M</span><br><span class="line">innodb_<span class="built_in">log</span>_file_size = 900M</span><br><span class="line">innodb_<span class="built_in">log</span>_files_<span class="keyword">in</span>_group = 4</span><br><span class="line">innodb_lock_<span class="built_in">wait</span>_timeout = 120</span><br><span class="line"></span><br><span class="line"><span class="built_in">bind</span>-address		= 127.0.0.1</span><br><span class="line">max_connections		= 1024</span><br><span class="line">connect_timeout		= 30</span><br><span class="line"><span class="built_in">wait</span>_timeout		= 60</span><br><span class="line">sort_buffer_size	= 4M</span><br><span class="line">bulk_insert_buffer_size	= 16M</span><br><span class="line">tmp_table_size		= 32M</span><br><span class="line">max_heap_table_size	= 32M</span><br><span class="line">key_buffer_size		= 8M</span><br><span class="line">table_open_cache	= 800</span><br><span class="line">myisam_sort_buffer_size	= 512M</span><br><span class="line">concurrent_insert	= 2</span><br><span class="line">general_<span class="built_in">log</span>             = 0</span><br><span class="line"><span class="built_in">log</span>_warnings		= 2</span><br><span class="line">slow_query_<span class="built_in">log</span>_file	= /var/<span class="built_in">log</span>/mysql/mariadb-slow.log</span><br><span class="line">long_query_time = 60</span><br><span class="line"><span class="built_in">log</span>_slow_verbosity	= query_plan</span><br><span class="line"></span><br><span class="line">skip-log-bin</span><br><span class="line">default_storage_engine	= InnoDB</span><br><span class="line">innodb_<span class="built_in">log</span>_file_size	= 50M</span><br><span class="line">innodb_<span class="built_in">log</span>_buffer_size	= 16M</span><br><span class="line">innodb_file_per_table	= <span class="literal">true</span></span><br><span class="line">innodb_open_files	= 4000</span><br><span class="line">innodb_lru_scan_depth   = 4000</span><br><span class="line">innodb_use_trim=ON</span><br><span class="line">innodb_use_fallocate=ON</span><br><span class="line">innodb_page_size=16k</span><br><span class="line">innodb_write_io_threads=24</span><br><span class="line">innodb_<span class="built_in">read</span>_io_threads=24</span><br><span class="line">innodb_buffer_pool_instances=16</span><br><span class="line">innodb_mtflush_threads=16</span><br><span class="line">innodb_doublewrite=0</span><br></pre></td></tr></table></figure></p>
<p><img src="/img/robinhood_size.png" alt=""></p>
<h3 id="Enable-changelog-in-robinhood-3-0"><a href="#Enable-changelog-in-robinhood-3-0" class="headerlink" title="Enable changelog in robinhood 3.0"></a>Enable changelog in robinhood 3.0</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ lctl <span class="built_in">set</span>_param mdt.<span class="variable">$FSNAME</span>-MDT0000.hsm_control=enabled</span><br><span class="line">mdt.lustre-MDT0000.hsm_control=enabled</span><br><span class="line">$ lctl <span class="built_in">set</span>_param mdt.<span class="variable">$FSNAME</span>-MDT0000.hsm.max_requests=64</span><br><span class="line">mdt.lustre-MDT0000.hsm.max_requests=64</span><br></pre></td></tr></table></figure>
<h3 id="Start-lhsmtool-cmd"><a href="#Start-lhsmtool-cmd" class="headerlink" title="Start lhsmtool_cmd"></a>Start lhsmtool_cmd</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/lhsm_cmd.conf</span><br><span class="line">[commands]</span><br><span class="line">archive = /sbin/aliclient -action=push -fd=&#123;fd&#125; -fid=&#123;fid&#125; -lustre_root=/opt/lustresz -objdomain=10.50.192.73 -objkeyid=iiiiiiiiiiiiidddddddddd -objkey=kkkkkkkkeeeeeeeeeeyyyyyyyyyy -objbucket=bucket-name</span><br><span class="line">restore = /sbin/aliclient -action=pull -fd=&#123;fd&#125; -fid=&#123;fid&#125; -lustre_root=/opt/lustresz -objdomain=10.50.192.73 -objkeyid=iiiiiiiiiiiiidddddddddd -objkey=kkkkkkkkeeeeeeeeeeyyyyyyyyyy -objbucket=bucket-name</span><br></pre></td></tr></table></figure>
<h4 id="Start-process"><a href="#Start-process" class="headerlink" title="Start process"></a>Start process</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ lhsmtool_cmd --abort-on-error --fanout 16 -vv /lustre/ |&amp; tee <span class="_">-a</span> /var/<span class="built_in">log</span>/lhsmtool_cmd.log</span><br></pre></td></tr></table></figure>
<h3 id="Robinhood-configuration"><a href="#Robinhood-configuration" class="headerlink" title="Robinhood configuration"></a>Robinhood configuration</h3><p>Please reference source code lhsm.conf</p>
<h3 id="Manually-test"><a href="#Manually-test" class="headerlink" title="Manually test"></a>Manually test</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ du -sh ./<span class="built_in">test</span>1.fasta</span><br><span class="line">68M     ./<span class="built_in">test</span>1.fasta</span><br><span class="line">$ lfs hsm_state <span class="built_in">test</span>1.fasta</span><br><span class="line"><span class="built_in">test</span>1.fasta: (0x00000000)</span><br><span class="line">$ lfs hsm_archive <span class="built_in">test</span>1.fasta</span><br><span class="line">$ lfs hsm_state <span class="built_in">test</span>1.fasta</span><br><span class="line"><span class="built_in">test</span>1.fasta: (0x00000009) exists archived, archive_id:1</span><br><span class="line">$ du -hs <span class="built_in">test</span>1.fasta</span><br><span class="line">68M     <span class="built_in">test</span>1.fasta</span><br><span class="line">$ lfs hsm_release <span class="built_in">test</span>1.fasta</span><br><span class="line">$ du -hs <span class="built_in">test</span>1.fasta</span><br><span class="line">512     <span class="built_in">test</span>1.fasta</span><br><span class="line">$ head <span class="built_in">test</span>1.fasta</span><br><span class="line">&gt;m140928_184123_42139_c100719602550000001823155305141590_s1_p0/54498/0_10184</span><br><span class="line">$ du -hs <span class="built_in">test</span>1.fasta</span><br><span class="line">68M     <span class="built_in">test</span>1.fasta</span><br></pre></td></tr></table></figure>
<h4 id="lhsmtool-cmd-log-file"><a href="#lhsmtool-cmd-log-file" class="headerlink" title="lhsmtool_cmd log file"></a>lhsmtool_cmd log file</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ tail <span class="_">-f</span> /var/<span class="built_in">log</span>/lhsmtool_cmd.log</span><br><span class="line">1482217383.283695 lhsmtool_cmd[6020]: waiting <span class="keyword">for</span> message from kernel</span><br><span class="line">1482227311.130852 lhsmtool_cmd[6020]: copytool fs=lustresz archive<span class="comment">#=1 item_count=1</span></span><br><span class="line">1482227311.130919 lhsmtool_cmd[6020]: waiting <span class="keyword">for</span> message from kernel</span><br><span class="line">1482227311.133001 lhsmtool_cmd[6025]: Running ARCHIVE <span class="built_in">command</span>: <span class="string">'/sbin/aliclient -action=push -fd=72 -fid=[0x200017990:0x29:0x0] -lustre_root=/opt/lustresz -objdomain=10.50.192.73 -objkeyid=zNWouvp5yGJWV9BB -objkey=9AKDku9VYhlovI1MO6OVCZWcIzMdnp -objbucket=bucket-dxjfbq-9'</span></span><br><span class="line">--syscmd output: /opt/lustresz/alioss/<span class="built_in">test</span>1.fasta</span><br><span class="line"></span><br><span class="line">--begin upload</span><br><span class="line">--The file size 70848886 Bytes</span><br><span class="line">--uploadfile fid fd filepath: [0x200017990:0x29:0x0] 72 /opt/lustresz/alioss/<span class="built_in">test</span>1.fasta</span><br><span class="line">1482227323.543305 lhsmtool_cmd[6025]: Action completed, notifying coordinator cookie=0x5858d7a9, FID=[0x200017990:0x29:0x0], hp_flags=0 err=0</span><br><span class="line">1482227323.548908 lhsmtool_cmd[6025]: llapi_hsm_action_end on <span class="string">'/opt/lustresz/.lustre/fid/0x200017990:0x29:0x0'</span> ok (rc=0)</span><br><span class="line">1482227667.051083 lhsmtool_cmd[6061]: Running RESTORE <span class="built_in">command</span>: <span class="string">'/sbin/aliclient -action=pull -fd=74 -fid=[0x200017990:0x29:0x0] -lustre_root=/opt/lustresz -objdomain=10.50.192.73 -objkeyid=zNWouvp5yGJWV9BB -objkey=9AKDku9VYhlovI1MO6OVCZWcIzMdnp -objbucket=bucket-dxjfbq-9'</span></span><br><span class="line">--syscmd output: /opt/lustresz/alioss/<span class="built_in">test</span>1.fasta</span><br><span class="line">--begin download</span><br><span class="line">1482227668.728724 lhsmtool_cmd[6061]: Action completed, notifying coordinator cookie=0x5858d7aa, FID=[0x200017990:0x29:0x0], hp_flags=0 err=0</span><br><span class="line">1482227668.776502 lhsmtool_cmd[6061]: llapi_hsm_action_end on <span class="string">'/opt/lustresz/.lustre/fid/0x200017990:0x29:0x0'</span> ok (rc=0)</span><br></pre></td></tr></table></figure>
<p>reference:<br><a href="https://github.com/cea-hpc/robinhood/wiki/Documentation" target="_blank" rel="external">https://github.com/cea-hpc/robinhood/wiki/Documentation</a><br><a href="http://cdn.opensfs.org/wp-content/uploads/2013/04/lug13-robinhood.pdf" target="_blank" rel="external">http://cdn.opensfs.org/wp-content/uploads/2013/04/lug13-robinhood.pdf</a></p>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> zfs </tag>
            
            <tag> robinhood </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Reinstall grub2]]></title>
      <url>http://yoursite.com/2016/02/17/Reinstall-grub2/</url>
      <content type="html"><![CDATA[<h3 id="Boot-livecd-from-your-usb-device-or-network"><a href="#Boot-livecd-from-your-usb-device-or-network" class="headerlink" title="Boot livecd from your usb device or network"></a>Boot livecd from your usb device or network</h3><p>/dev/sdd2 is my linux root partition, OS is pinguyos(ubuntu)</p>
<h3 id="LVM-partition"><a href="#LVM-partition" class="headerlink" title="LVM partition"></a>LVM partition</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ vgscan</span><br><span class="line">$ lvscan</span><br><span class="line">$ lvchange <span class="_">-a</span> y /dev/centos_vg/lv_root</span><br></pre></td></tr></table></figure>
<h3 id="Test-in-ubuntu"><a href="#Test-in-ubuntu" class="headerlink" title="Test in ubuntu"></a>Test in ubuntu</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mount /dev/sdd2 /opt</span><br><span class="line">mount --bind /dev/ /opt/dev</span><br><span class="line">mount --bind /sys/ /opt/sys</span><br><span class="line">mount --bind /proc /opt/proc</span><br><span class="line">chroot /opt</span><br><span class="line">grub-install /dev/sdd</span><br><span class="line">grub-install --root-directory=/mnt/sysimages/boot/efi /dev/sdd</span><br><span class="line">grub-mkconfig -o /boot/grub/grub.cfg</span><br></pre></td></tr></table></figure>
<h3 id="Test-in-CentOS-7-set-boot-menu"><a href="#Test-in-CentOS-7-set-boot-menu" class="headerlink" title="Test in CentOS 7, set boot menu"></a>Test in CentOS 7, set boot menu</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat   /boot/grub2/grub.cfg | grep Windows</span><br><span class="line">menuentry <span class="string">"Windows 7 (loader) (on /dev/sda1)"</span></span><br><span class="line">grub2-set-default  <span class="string">"Windows 7 (loader) (on /dev/sda1)"</span></span><br><span class="line">grub2-editenv list</span><br><span class="line">saved_entry=Windows 7 (loader) (on /dev/sda1)</span><br><span class="line">or </span><br><span class="line">grub2-set-default <span class="string">"windows"</span></span><br><span class="line"></span><br><span class="line">grub2-mkconfig -o /boot/grub2/grub.conf</span><br></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> grub </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[rdesktop to windows10]]></title>
      <url>http://yoursite.com/2016/01/25/rdesktop-to-windows10/</url>
      <content type="html"><![CDATA[<h3 id="Enable-remote-desktop"><a href="#Enable-remote-desktop" class="headerlink" title="Enable remote desktop"></a>Enable remote desktop</h3><p><img src="/img/e_desktop.png" alt=""><br><img src="/img/e_firewall.png" alt=""></p>
<h3 id="Modify-registry"><a href="#Modify-registry" class="headerlink" title="Modify registry"></a>Modify registry</h3><p>\HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp\SecurityLayer<br>from DWORD Hex ‘2’ to a value of ‘1’</p>
<p>reference:<br><a href="http://ubuntuforums.org/showthread.php?t=2287213" target="_blank" rel="external">http://ubuntuforums.org/showthread.php?t=2287213</a></p>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> rdesktop </tag>
            
            <tag> windows </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Encrypt block device]]></title>
      <url>http://yoursite.com/2016/01/08/Encrypt-block-device/</url>
      <content type="html"><![CDATA[<h3 id="Input-password"><a href="#Input-password" class="headerlink" title="Input password"></a><em>Input password</em></h3><p>or you can not use openssl<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cryptsetup luksFormat --cipher aes-xts-plain64 --key-size 512 --hash sha256 /dev/vdb     </span><br><span class="line">WARNING!     </span><br><span class="line">========     </span><br><span class="line">This will overwrite data on /dev/vdb irrevocably.     </span><br><span class="line">     </span><br><span class="line">Are you sure? (Type uppercase yes): YES      </span><br><span class="line">Enter passphrase:      </span><br><span class="line">Verify passphrase:</span><br></pre></td></tr></table></figure></p>
<h3 id="mapper-test-device"><a href="#mapper-test-device" class="headerlink" title="mapper test device"></a><em>mapper test device</em></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cryptsetup luksOpen /dev/vdb <span class="built_in">test</span>     </span><br><span class="line">Enter passphrase <span class="keyword">for</span> /dev/vdb:     </span><br><span class="line">``` </span><br><span class="line"><span class="comment">###     </span></span><br><span class="line">or     </span><br><span class="line"><span class="comment">###     </span></span><br><span class="line">``` bash</span><br><span class="line"><span class="built_in">cd</span> /dev/shm     </span><br><span class="line">openssl rand 128 -hex -out ./key     </span><br><span class="line">openssl aes-256-cbc -in ./key -out key.enc     </span><br><span class="line"></span><br><span class="line">Verifying - enter aes-256-cbc encryption password:</span><br><span class="line">openssl aes-256-cbc <span class="_">-d</span> -in ./key.enc | cryptsetup [--allow-discards] --key-file=- luksOpen /dev/vdb <span class="built_in">test</span>     </span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line">If you have a SSD, you may want to use --allow-discards. It creates an information leak but it enhances your SSD’s lifetime.     </span><br><span class="line"></span><br><span class="line">``` bash</span><br><span class="line">mkfs.ext4 /dev/mapper/<span class="built_in">test</span>     </span><br><span class="line">cryptsetup luksDump /dev/vdb     </span><br><span class="line">     </span><br><span class="line">``` bash     </span><br><span class="line">LUKS header information <span class="keyword">for</span> /dev/vdb     </span><br><span class="line">Key Slot 0: ENABLED     </span><br><span class="line">	Iterations:         	80604     </span><br><span class="line">	Salt:               	c4 c0 08 9c 77 ef 57 a5 d2 62 f4 94 03 56 24 7a      </span><br><span class="line">	                      	86 0c f4 c6 06 6f 9e 01 80 <span class="built_in">fc</span> 0f 1d 3b a9 59 87      </span><br><span class="line">	Key material offset:	8     </span><br><span class="line">	AF stripes:            	4000     </span><br><span class="line">Key Slot 1: DISABLED</span><br></pre></td></tr></table></figure>
<h3 id="Add-remove-key"><a href="#Add-remove-key" class="headerlink" title="Add/remove key"></a><em>Add/remove key</em></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cryptsetup luksAddKey --key-slot 1 /dev/vdb     </span><br><span class="line">cryptsetup luksRemoveKey /dev/vdb</span><br></pre></td></tr></table></figure>
<h3 id="Back-restore-header"><a href="#Back-restore-header" class="headerlink" title="Back/restore header"></a><em>Back/restore header</em></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cryptsetup luksHeaderBackup /dev/vdb --header-backup-file /root/vdb-header-backup     </span><br><span class="line">cryptsetup luksHeaderRestore /dev/vdb --header-backup-file /root/vdb-header-backup</span><br></pre></td></tr></table></figure>
<h3 id="is-luks-partition"><a href="#is-luks-partition" class="headerlink" title="is luks partition"></a><em>is luks partition</em></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cryptsetup -v isLuks /dev/vdb</span><br></pre></td></tr></table></figure>
<h3 id="Clean-luks-partition"><a href="#Clean-luks-partition" class="headerlink" title="Clean luks partition"></a><em>Clean luks partition</em></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">head -c 3145728 /dev/zero &gt; /dev/vdb;sync</span><br></pre></td></tr></table></figure>
<p>The default LUKS header (with only one key-slot enabled) takes 1052672 bytes, what is slightly more than 1 MiB. Having 2 key-slots enabled this would extend the header almost twice (key-slots <em> stripes </em> keysize + offset bytes). Therefore overwriting the first 3 MiB would do the job for us </p>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> centos </tag>
            
            <tag> encrypt </tag>
            
            <tag> block device </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Replace HDD for openzfs]]></title>
      <url>http://yoursite.com/2015/12/04/Replace-HDD-for-openzfs/</url>
      <content type="html"><![CDATA[<h3 id="Replace-HDD-when-raidz-has-degraded"><a href="#Replace-HDD-when-raidz-has-degraded" class="headerlink" title="Replace HDD when raidz has degraded"></a>Replace HDD when raidz has degraded</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$  zpool replace tank <span class="_">-f</span> sdar</span><br><span class="line">$  zpool status</span><br><span class="line">  pool: tank</span><br><span class="line"> state: DEGRADED</span><br><span class="line">status: One or more devices is currently being resilvered.  The pool will</span><br><span class="line">        <span class="built_in">continue</span> to <span class="keyword">function</span>, possibly <span class="keyword">in</span> a degraded state.</span><br><span class="line">action: Wait <span class="keyword">for</span> the resilver to complete.</span><br><span class="line">  scan: resilver <span class="keyword">in</span> progress since Wed Aug 19 01:45:26 2015</span><br><span class="line">    91.6M scanned out of 66.9T at 9.16M/s, (scan is slow, no estimated time)</span><br><span class="line">    3.94M resilvered, 0.00% <span class="keyword">done</span></span><br><span class="line">......</span><br><span class="line">          raidz2-3                  DEGRADED     0     0     0</span><br><span class="line">            sdal                    ONLINE       0     0     0</span><br><span class="line">            sdam                    ONLINE       1    90     0</span><br><span class="line">            sdan                    ONLINE       0     0     0</span><br><span class="line">            sdao                    ONLINE       0     0     0</span><br><span class="line">            sdap                    ONLINE       0     0     0</span><br><span class="line">            sdaq                    ONLINE       0     0     0</span><br><span class="line">            replacing-6             UNAVAIL      0     0     0</span><br><span class="line">              old                   UNAVAIL    101     0     0</span><br><span class="line">              sdar                  ONLINE       0     0     0  (resilvering)</span><br><span class="line">            sdas                    ONLINE       0     0     0</span><br><span class="line">            sdat                    ONLINE       0     0     0</span><br><span class="line">            sdau                    ONLINE       0     0     0</span><br><span class="line">            sdav                    ONLINE       0     0     0</span><br><span class="line">        spares</span><br><span class="line">          scsi-35000c50021387d97    AVAIL</span><br><span class="line">          sdak                      AVAIL</span><br><span class="line">          sdaw                      AVAIL</span><br></pre></td></tr></table></figure>
<h3 id="Replace-broken-HDD-and-insert-a-new-HDD-to-JBOD-enclosure"><a href="#Replace-broken-HDD-and-insert-a-new-HDD-to-JBOD-enclosure" class="headerlink" title="Replace broken HDD, and insert a new HDD to JBOD enclosure"></a>Replace broken HDD, and insert a new HDD to JBOD enclosure</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">$ zpool status</span><br><span class="line">  pool: tank</span><br><span class="line"> state: DEGRADED</span><br><span class="line">status: One or more devices is currently being resilvered.  The pool will</span><br><span class="line">        <span class="built_in">continue</span> to <span class="keyword">function</span>, possibly <span class="keyword">in</span> a degraded state.</span><br><span class="line">action: Wait <span class="keyword">for</span> the resilver to complete.</span><br><span class="line">  scan: resilver <span class="keyword">in</span> progress since Wed Aug 19 01:45:26 2015</span><br><span class="line">    90.5G scanned out of 66.9T at 232M/s, 83h45m to go</span><br><span class="line">    4.09G resilvered, 0.13% <span class="keyword">done</span></span><br><span class="line">config:</span><br><span class="line"></span><br><span class="line">        NAME                        STATE     READ WRITE CKSUM</span><br><span class="line">        tank                        DEGRADED     0     0     0</span><br><span class="line">          raidz2-0                  DEGRADED     0     0     0</span><br><span class="line">            scsi-35000c500212bff8b  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212bed8f  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212c24d7  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212c1bdb  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212b9a0b  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c50034d625f7  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500575f9a87  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212baaeb  ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212bdcd3  UNAVAIL     33     0     0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ ls /dev/disk/by-id/scsi-35000c500212bdcd3</span><br><span class="line">ls: cannot access /dev/disk/by-id/scsi-35000c500212bdcd3: No such file or directory</span><br><span class="line"></span><br><span class="line">$ zpool replace tank scsi-35000c500212bdcd3</span><br><span class="line">cannot open <span class="string">'scsi-35000c500212bdcd3'</span>: no such device <span class="keyword">in</span> /dev</span><br><span class="line">must be a full path or shorthand device name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ dmesg</span><br><span class="line">.....</span><br><span class="line">Aug 19 01:32:40 xxxx-host kernel: sd 1:0:53:0: [sdk] Spinning up disk....................ready</span><br><span class="line">Aug 19 01:32:40 xxxx-host kernel: sd 1:0:53:0: [sdk] 3907029168 512-byte logical blocks: (2.00 TB/1.81 TiB)</span><br><span class="line">Aug 19 01:32:40 xxxx-host kernel: sd 1:0:53:0: [sdk] Write Protect is off</span><br><span class="line">Aug 19 01:32:40 xxxx-host kernel: sd 1:0:53:0: [sdk] Write cache: enabled, <span class="built_in">read</span> cache: enabled, supports DPO and FUA</span><br><span class="line">Aug 19 01:32:40 xxxx-host kernel: sdk: unknown partition table</span><br><span class="line">Aug 19 01:32:40 xxxx-host kernel: sd 1:0:53:0: [sdk] Attached SCSI disk</span><br><span class="line"></span><br><span class="line"><span class="comment">#new hdd is sdk</span></span><br><span class="line">$ zpool add tank spare sdk</span><br><span class="line">        spares</span><br><span class="line">          scsi-35000c50021387d97    AVAIL</span><br><span class="line">          sdak                      AVAIL</span><br><span class="line">          sdaw                      AVAIL</span><br><span class="line">          sdk                       AVAIL</span><br><span class="line"></span><br><span class="line">$ zpool replace tank scsi-35000c500212bdcd3 sdk</span><br><span class="line">  scan: resilver <span class="keyword">in</span> progress since Wed Aug 19 01:57:53 2015</span><br><span class="line">    141M scanned out of 66.9T at 7.83M/s, (scan is slow, no estimated time)</span><br><span class="line">    8.72M resilvered, 0.00% <span class="keyword">done</span></span><br><span class="line">config:</span><br><span class="line"></span><br><span class="line">        NAME                          STATE     READ WRITE CKSUM</span><br><span class="line">        tank                          DEGRADED     0     0     0</span><br><span class="line">          raidz2-0                    DEGRADED     0     0     0</span><br><span class="line">            scsi-35000c500212bff8b    ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212bed8f    ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212c24d7    ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212c1bdb    ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212b9a0b    ONLINE       0     0     0</span><br><span class="line">            scsi-35000c50034d625f7    ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500575f9a87    ONLINE       0     0     0</span><br><span class="line">            scsi-35000c500212baaeb    ONLINE       0     0     0</span><br><span class="line">            spare-8                   UNAVAIL      0     0     0</span><br><span class="line">              scsi-35000c500212bdcd3  UNAVAIL     33     0     0</span><br><span class="line">              sdk                     ONLINE       0     0     0  (resilvering)</span><br></pre></td></tr></table></figure>
<p>Well done, it’s worked.</p>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> centos </tag>
            
            <tag> zfs </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Openzfs tips]]></title>
      <url>http://yoursite.com/2015/12/04/Openzfs-tips/</url>
      <content type="html"><![CDATA[<h3 id="6x-Intel-P3520"><a href="#6x-Intel-P3520" class="headerlink" title="[6x Intel P3520]"></a>[6x Intel P3520]</h3><p>Before modify default parameter. there are only 1.xGB/s read or write. too slow…….<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">parted /dev/nvme0n1 p</span><br><span class="line">Model: Unknown (unknown)</span><br><span class="line">Disk /dev/nvme0n1: 2000GB</span><br><span class="line">Sector size (logical/physical): 512B/512B</span><br><span class="line">Partition Table: gpt</span><br><span class="line">Disk Flags:</span><br><span class="line"></span><br><span class="line">Number  Start   End     Size    File system  Name  Flags</span><br><span class="line"> 1      1049kB  1900GB  1900GB               disk1</span><br><span class="line"></span><br><span class="line">zpool destroy tank01</span><br><span class="line">zpool create tank01 -o ashift=13 -O recordsize=1M /dev/nvme&#123;0..5&#125;n1p1</span><br><span class="line">zfs <span class="built_in">set</span> primarycache=metadata tank01</span><br><span class="line">zfs <span class="built_in">set</span> secondarycache=none tank01</span><br><span class="line">zfs <span class="built_in">set</span> logbias=throughput tank01</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">              capacity     operations     bandwidth</span><br><span class="line">pool        alloc   free   <span class="built_in">read</span>  write   <span class="built_in">read</span>  write</span><br><span class="line">----------  -----  -----  -----  -----  -----  -----</span><br><span class="line">tank01       132G  10.2T      0  16.7K      0  5.79G</span><br><span class="line">tank01       146G  10.2T      0  12.4K      0  7.22G</span><br><span class="line">tank01       161G  10.2T      0  10.9K      0  7.41G</span><br><span class="line">tank01       174G  10.1T      0  12.1K      0  7.18G</span><br><span class="line">...</span><br><span class="line">tank01       512G  9.81T  8.75K      0  8.75G      0</span><br><span class="line">tank01       512G  9.81T  8.78K     44  8.78G   864K</span><br><span class="line">tank01       512G  9.81T  8.85K      0  8.85G      0</span><br><span class="line">tank01       512G  9.81T  8.76K     53  8.76G   876K</span><br><span class="line">tank01       512G  9.81T  8.80K      0  8.80G      0</span><br><span class="line">tank01       512G  9.81T  8.78K     40  8.78G   876K</span><br><span class="line">...</span><br><span class="line">tank01       779G  9.55T  3.94K  4.37K  3.94G  3.99G</span><br><span class="line">tank01       787G  9.54T  3.99K  4.31K  3.99G  3.91G</span><br><span class="line">tank01       793G  9.54T  3.96K  4.32K  3.96G  3.99G</span><br><span class="line">tank01       801G  9.53T  3.94K  4.40K  3.94G  3.94G</span><br><span class="line">tank01       809G  9.52T  3.90K  4.32K  3.90G  3.92G</span><br><span class="line">tank01       818G  9.51T  3.96K  4.36K  3.96G  3.96G</span><br><span class="line">tank01       826G  9.51T  3.90K  4.41K  3.91G  4.02G</span><br><span class="line">tank01       834G  9.50T  3.94K  4.31K  3.94G  3.89G</span><br></pre></td></tr></table></figure></p>
<h3 id="performance-tuning"><a href="#performance-tuning" class="headerlink" title="[performance tuning]"></a>[performance tuning]</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">zfsconf=<span class="string">"/etc/modprobe.d/zfs.conf"</span></span><br><span class="line">meminfo=<span class="string">"/proc/meminfo"</span></span><br><span class="line">mem50=$(awk <span class="string">'$0~/MemTotal/ &#123;printf "%d\n", $(NF-1)*1024*0.5&#125;'</span> <span class="variable">$meminfo</span>)</span><br><span class="line">mem60=$(awk <span class="string">'$0~/MemTotal/ &#123;printf "%d\n", $(NF-1)*1024*0.6&#125;'</span> <span class="variable">$meminfo</span>)</span><br><span class="line">mem10=$(awk <span class="string">'$0~/MemTotal/ &#123;printf "%d\n", $(NF-1)*1024*0.1&#125;'</span> <span class="variable">$meminfo</span>)</span><br><span class="line">zfs_modules=<span class="string">"/sys/module/zfs/parameters/"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### check /sys/modules/zfs/parameters</span></span><br><span class="line"></span><br><span class="line">hostname | grep -i mds &gt; /dev/zero &amp;&amp; cat &lt;&lt; EOF &gt; <span class="variable">$zfsconf</span></span><br><span class="line">options zfs metaslab_debug_unload=1</span><br><span class="line">options zfs zfs_arc_max=<span class="variable">$mem50</span></span><br><span class="line">options zfs zfs_arc_meta_<span class="built_in">limit</span>=<span class="variable">$mem50</span></span><br><span class="line">options zfs zfs_vdev_scheduler=none</span><br><span class="line">options zfs zfs_vdev_async_write_active_min_dirty_percent=10</span><br><span class="line">options zfs zfs_vdev_async_write_min_active=8</span><br><span class="line">options zfs zfs_vdev_async_write_max_active=32</span><br><span class="line">options zfs zfs_vdev_sync_write_min_active=16</span><br><span class="line">options zfs zfs_vdev_sync_write_max_active=32</span><br><span class="line">options zfs zfs_vdev_sync_<span class="built_in">read</span>_min_active=16</span><br><span class="line">options zfs zfs_vdev_sync_<span class="built_in">read</span>_max_active=32</span><br><span class="line">options zfs zfs_vdev_async_<span class="built_in">read</span>_min_active=16</span><br><span class="line">options zfs zfs_vdev_async_<span class="built_in">read</span>_max_active=32</span><br><span class="line">options zfs zfs_top_maxinflight=64</span><br><span class="line">options zfs zfs_dirty_data_max=16000000000</span><br><span class="line">options zfs zfs_vdev_scrub_min_active=3</span><br><span class="line">options zfs zfs_vdev_scrub_max_active=4</span><br><span class="line">options zfs zfs_prefetch_<span class="built_in">disable</span>=1</span><br><span class="line">options zfs zfs_vdev_cache_size=1310720 <span class="comment">#why 0.6.5.7 not work ?</span></span><br><span class="line">options zfs zfs_vdev_cache_max=131072</span><br><span class="line">options zfs zfs_vdev_cache_bshift=17</span><br><span class="line">options zfs zfs_<span class="built_in">read</span>_chunk_size=1310720</span><br><span class="line">options zfs zfs_txg_<span class="built_in">history</span>=2</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">hostname | grep -i <span class="string">'oss'</span> &gt; /dev/zero &amp;&amp; cat &lt;&lt; EOF &gt; <span class="variable">$zfsconf</span></span><br><span class="line">options zfs metaslab_debug_unload=1</span><br><span class="line">options zfs zfs_arc_max=<span class="variable">$mem60</span></span><br><span class="line">options zfs zfs_vdev_scheduler=deadline</span><br><span class="line">options zfs zfs_arc_meta_<span class="built_in">limit</span>=<span class="variable">$mem10</span></span><br><span class="line">options zfs zfs_vdev_async_write_active_min_dirty_percent=10</span><br><span class="line">options zfs zfs_vdev_async_<span class="built_in">read</span>_max_active=12</span><br><span class="line">options zfs zfs_vdev_async_<span class="built_in">read</span>_min_active=12</span><br><span class="line">options zfs zfs_vdev_async_write_max_active=12</span><br><span class="line">options zfs zfs_vdev_async_write_min_active=12</span><br><span class="line">options zfs zfs_vdev_sync_<span class="built_in">read</span>_max_active=12</span><br><span class="line">options zfs zfs_vdev_sync_<span class="built_in">read</span>_min_active=12</span><br><span class="line">options zfs zfs_vdev_sync_write_max_active=12</span><br><span class="line">options zfs zfs_vdev_sync_write_min_active=12</span><br><span class="line">options zfs zfs_dirty_data_max=8000000000</span><br><span class="line">options zfs zfs_prefetch_<span class="built_in">disable</span>=1</span><br><span class="line">options zfs zfs_vdev_cache_size=1310720 <span class="comment">#why 0.6.5.7 not work ?</span></span><br><span class="line">options zfs zfs_vdev_cache_max=131072</span><br><span class="line">options zfs zfs_vdev_cache_bshift=17</span><br><span class="line">options zfs zfs_<span class="built_in">read</span>_chunk_size=1310720</span><br><span class="line">options zfs zfs_txg_<span class="built_in">history</span>=2</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$zfs_modules</span></span><br><span class="line">awk -F <span class="string">'[ =]+'</span>  <span class="string">'&#123;print $3,$4&#125;'</span> <span class="variable">$zfsconf</span> | <span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> $(<span class="built_in">echo</span> <span class="variable">$line</span> | awk <span class="string">'&#123;print $2&#125;'</span>) &gt; $(<span class="built_in">echo</span> <span class="variable">$line</span> | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line">  <span class="built_in">echo</span> -n $(<span class="built_in">echo</span> <span class="variable">$line</span> | awk <span class="string">'&#123;print $1&#125;'</span>)<span class="string">" "</span> &amp;&amp; cat $(<span class="built_in">echo</span> <span class="variable">$line</span> | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h3 id="mirror-exspansion"><a href="#mirror-exspansion" class="headerlink" title="[mirror exspansion]"></a>[mirror exspansion]</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zpool add mds mirror S1P1E0106 S1P1E0107 mirror S1P1E0108 S1P1E0109</span><br></pre></td></tr></table></figure>
<h3 id="zpool-could-not-mount"><a href="#zpool-could-not-mount" class="headerlink" title="[zpool could not mount]"></a>[zpool could not mount]</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ zpool import -o <span class="built_in">readonly</span>=on -o cachefile=none tank</span><br><span class="line">$ zpool import -Nm tank</span><br></pre></td></tr></table></figure>
<h3 id="arc-status"><a href="#arc-status" class="headerlink" title="[arc status]"></a>[arc status]</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ cat /proc/spl/kstat/zfs/arcstats</span><br><span class="line">$ arcstat.py 2</span><br><span class="line">$ arc_summary.py | grep <span class="string">"L2 ARC Breakdown"</span> -A 2</span><br><span class="line">L2 ARC Breakdown:				846.25m</span><br><span class="line">	Hit Ratio:			0.47%	3.98m</span><br><span class="line">	Miss Ratio:			99.53%	842.27m</span><br></pre></td></tr></table></figure>
<h3 id="zfs-volume"><a href="#zfs-volume" class="headerlink" title="[zfs volume]"></a>[zfs volume]</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zfs create -V 40T -o volblocksize=128k tank/zvol</span><br><span class="line">ls <span class="_">-l</span> /dev/zvol/tank/zvol</span><br></pre></td></tr></table></figure>
<h3 id="mount-zfs"><a href="#mount-zfs" class="headerlink" title="[mount zfs]"></a>[mount zfs]</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pool=tank</span><br><span class="line">zfs <span class="built_in">set</span> canmount=on <span class="variable">$pool</span></span><br><span class="line">zfs <span class="built_in">set</span> mountpoint=/mnt <span class="variable">$pool</span></span><br><span class="line">zfs mount <span class="variable">$pool</span></span><br><span class="line">rm <span class="_">-f</span> /mnt/xxx/xxx/xxx</span><br><span class="line">zfs umount <span class="variable">$pool</span></span><br><span class="line">zfs <span class="built_in">set</span> canmount=off</span><br></pre></td></tr></table></figure>
<h3 id="zfs-event"><a href="#zfs-event" class="headerlink" title="[zfs event]"></a>[zfs event]</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ zpool events -c <span class="comment"># clean events</span></span><br><span class="line">$ zpool import tank</span><br><span class="line">$ zpool events -v</span><br><span class="line">$ zpool events -v &gt; zpool_import_tank</span><br></pre></td></tr></table></figure>
<h3 id="Replace-FX-parameter"><a href="#Replace-FX-parameter" class="headerlink" title="[Replace FX parameter]"></a>[Replace FX parameter]</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># very dangerours</span></span><br><span class="line">$ zpool import <span class="_">-f</span>FX -R /tmp/tank ost_11</span><br><span class="line"></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">### Just check, not take action</span></span><br><span class="line">pool=<span class="string">"your_pool_name"</span></span><br><span class="line"><span class="comment">#find a vdev of pool</span></span><br><span class="line">vdev=<span class="string">"/dev/mapper/35000cca2515fc6ac"</span></span><br><span class="line">zdb -lu <span class="variable">$vdev</span> |grep <span class="string">"txg "</span> |cut <span class="_">-d</span> <span class="string">" "</span> <span class="_">-f</span> 3 &gt; /tmp/txg</span><br><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> LINE;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">zdb <span class="_">-e</span> <span class="variable">$pool</span> <span class="_">-d</span> -t <span class="variable">$LINE</span></span><br><span class="line"><span class="keyword">done</span> &lt; /tmp/txg</span><br></pre></td></tr></table></figure>
<h3 id="All-flash-setting"><a href="#All-flash-setting" class="headerlink" title="All flash setting"></a><a href="http://docs.oracle.com/cd/E19253-01/819-5461/givdo/index.html" target="_blank" rel="external">All flash setting</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The logbias property – You can use this property to provide a hint to ZFS about handling synchronous requests <span class="keyword">for</span> a specific dataset. If logbias is <span class="built_in">set</span> to latency, ZFS uses the pool<span class="string">'s separate log devices, if any, to handle the requests at low latency. If logbias is set to throughput, ZFS does not use the pool'</span>s separate <span class="built_in">log</span> devices. Instead, ZFS optimizes synchronous operations <span class="keyword">for</span> global pool throughput and efficient use of resources.</span><br></pre></td></tr></table></figure>
<p>Does it mean in all flash env, you’d better set logbias=throughput</p>
<h3 id="Optimize-with-lustre"><a href="#Optimize-with-lustre" class="headerlink" title="Optimize with lustre"></a><a href="http://wiki.lustre.org/images/4/48/ZFS-As-Backend-File-System_Paciucci.pdf" target="_blank" rel="external">Optimize with lustre</a></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ cat /etc/modprobe.d/zfs.conf</span><br><span class="line">options zfs zfs_prefetch_<span class="built_in">disable</span>=1</span><br><span class="line">options zfs metaslab_debug_unload=1</span><br><span class="line">options zfs zfs_arc_max=$(awk <span class="string">'$0~/MemTotal/&#123;printf "%.0f \n", $2*1024*0.6&#125;'</span> /proc/meminfo) <span class="comment">#60%, 3/5</span></span><br><span class="line">options zfs zfs_arc_meta_<span class="built_in">limit</span>=$(awk <span class="string">'$0~/MemTotal/&#123;printf "%.0f \n", $2*1024*0.75&#125;'</span> /proc/meminfo) <span class="comment">#MDS only,75%</span></span><br><span class="line">options zfs zfs_dirty_data_max=$(awk <span class="string">'$0~/MemTotal/&#123;printf "%.0f \n", $2*1024*0.15&#125;'</span> /proc/meminfo) <span class="comment">#15%</span></span><br><span class="line">options zfs zfs_vdev_async_write_min_active=5 <span class="comment"># depends your hdd number of your volume ,SSD could be higher</span></span><br><span class="line">options zfs zfs_vdev_async_write_max_active=15</span><br><span class="line">options zfs zfs_vdev_sync_<span class="built_in">read</span>_min_active=16 <span class="comment"># depends your hdd number of your volume ,SSD could be higher</span></span><br><span class="line">options zfs zfs_vdev_sync_<span class="built_in">read</span>_max_active=16</span><br><span class="line">options zfs zfs_vdev_async_write_active_min_dirty_percent=20</span><br><span class="line">options zfs zfs_vdev_scheduler=deadline <span class="comment">#noop for SSD</span></span><br></pre></td></tr></table></figure>
<p><a href="http://lustre.ornl.gov/ecosystem-2016/documents/tutorials/Stearman-LLNL-ZFS.pdf" target="_blank" rel="external">Tutorial: How to install, tune and Monitor a ZFS based Lustre file system</a></p>
<h3 id="Readonly-mount"><a href="#Readonly-mount" class="headerlink" title="Readonly mount"></a>Readonly mount</h3><p>The /etc/zfs/zpool.cache file will be automatically updated when your pool configuration is changed.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">zpool <span class="built_in">set</span> cachefile=none tank</span><br><span class="line">zpool import -N -o cachefile=none <span class="_">-d</span> /dev/disk/by-id tank01</span><br><span class="line">zfs mount -o ro tank01</span><br><span class="line"><span class="comment">#deafult zfs mount -o rw,zfsutil tank01</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Compression"><a href="#Compression" class="headerlink" title="Compression"></a>Compression</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> compression=lz4 tank</span><br><span class="line">zfs <span class="built_in">set</span> compression=gzip-9 tank</span><br></pre></td></tr></table></figure>
<h3 id="Xattr"><a href="#Xattr" class="headerlink" title="Xattr"></a>Xattr</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> xattr=sa tank</span><br></pre></td></tr></table></figure>
<h3 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> acltype=posixacl tank/gentoo/home</span><br><span class="line">zfs get acltype tank/gentoo/home</span><br></pre></td></tr></table></figure>
<h3 id="Rmount"><a href="#Rmount" class="headerlink" title="Rmount"></a>Rmount</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> mountpoint=/var/lib/mysql tank/mysql</span><br><span class="line">zfs umount tank/mysql</span><br><span class="line">zfs mount tank/mysql</span><br></pre></td></tr></table></figure>
<h3 id="Zpool-rename"><a href="#Zpool-rename" class="headerlink" title="Zpool rename"></a>Zpool rename</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zpool <span class="built_in">export</span> app</span><br><span class="line">zpool import app apps</span><br></pre></td></tr></table></figure>
<h3 id="Detach-hdd-from-mirror"><a href="#Detach-hdd-from-mirror" class="headerlink" title="Detach hdd from mirror"></a>Detach hdd from mirror</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">zpool detach tank sdz <span class="comment">#detach zda from mirror-17</span></span><br><span class="line">only sdal <span class="keyword">in</span> mirror-17, and mirror-17 is missing</span><br><span class="line"></span><br><span class="line">          mirror-16  ONLINE       0     0     0</span><br><span class="line">            sdai     ONLINE       0     0     0</span><br><span class="line">            sdaj     ONLINE       0     0     0</span><br><span class="line">          sdal       ONLINE       0     0     0</span><br><span class="line">          mirror-18  ONLINE       0     0     0</span><br><span class="line">            sdam     ONLINE       0     0     0</span><br><span class="line">            sdan     ONLINE       0     0     0</span><br></pre></td></tr></table></figure>
<h3 id="Attach-one-hdd-to-mirror"><a href="#Attach-one-hdd-to-mirror" class="headerlink" title="Attach one hdd to mirror"></a>Attach one hdd to mirror</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">zpool attach tank sdal sdz</span><br><span class="line">          mirror-17  ONLINE       0     0     0</span><br><span class="line">            sdal     ONLINE       0     0     0</span><br><span class="line">            sdz      ONLINE       0     0     0  (resilvering)</span><br></pre></td></tr></table></figure>
<h3 id="dir"><a href="#dir" class="headerlink" title="dir"></a>dir</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zfs create tank/<span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<h3 id="Quota"><a href="#Quota" class="headerlink" title="Quota"></a>Quota</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> quota=1024G tank/<span class="built_in">test</span></span><br><span class="line"><span class="comment"># disable</span></span><br><span class="line">zfs <span class="built_in">set</span> quota=none tank</span><br></pre></td></tr></table></figure>
<h3 id="user-quota"><a href="#user-quota" class="headerlink" title="user quota"></a>user quota</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">zfs <span class="built_in">set</span> userquota@nagios=2G tank</span><br><span class="line">dd <span class="keyword">if</span>=/dev/zero of=/tank01/<span class="built_in">test</span>/nagios bs=1M</span><br><span class="line">dd: writing /tank/<span class="built_in">test</span>/nagios:Disk quota exceeded</span><br><span class="line"></span><br><span class="line"><span class="comment"># zfs get userquota@nagios </span></span><br><span class="line">NAME            PROPERTY          VALUE             SOURCE</span><br><span class="line">tank01          userquota@nagios  2G                <span class="built_in">local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># group</span></span><br><span class="line">zfs <span class="built_in">set</span> groupquota@staff=10G tank/staff/admins</span><br></pre></td></tr></table></figure>
<h3 id="Limit-memory-usage"><a href="#Limit-memory-usage" class="headerlink" title="Limit memory usage"></a>Limit memory usage</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> xxx &gt; /sys/module/zfs/parameters/zfs_arc_max</span><br><span class="line">cat xxx &gt; /sys/module/zfs/parameters/zfs_arc_min</span><br><span class="line"></span><br><span class="line">cat /etc/modprobe.d/zfs.conf <span class="comment"># Min 4096MB / Max 8192MB limit</span></span><br><span class="line">options zfs zfs_arc_min=4294967296</span><br><span class="line">options zfs zfs_arc_max=8589934592</span><br><span class="line"><span class="comment">#ZFS Device I/O Queue Depth</span></span><br><span class="line">options zfs zfs_vdev_max_pending=24</span><br><span class="line"></span><br><span class="line">modprobe zfs zfs_arc_min=4294967296</span><br></pre></td></tr></table></figure>
<h3 id="Custome-mount-path"><a href="#Custome-mount-path" class="headerlink" title="Custome mount path"></a>Custome mount path</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">zpool import  -R / tank-1 <span class="comment">#mount to /tank-1</span></span><br><span class="line"></span><br><span class="line">or </span><br><span class="line"></span><br><span class="line">zfs <span class="built_in">set</span> mountpoint=/zfs tank</span><br><span class="line">zfs get mountpoint tank</span><br></pre></td></tr></table></figure>
<h3 id="Add-and-remove-hotspare"><a href="#Add-and-remove-hotspare" class="headerlink" title="Add and remove hotspare"></a>Add and remove hotspare</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zpool add tank spare c1t4d0 c1t5d0</span><br><span class="line">zpool remove tank c1t5d0</span><br></pre></td></tr></table></figure>
<h3 id="Clear-zfs-label"><a href="#Clear-zfs-label" class="headerlink" title="Clear zfs label"></a>Clear zfs label</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zpool labelclear /dev/sdxxx</span><br></pre></td></tr></table></figure>
<h3 id="Lz4-Compression-ratio"><a href="#Lz4-Compression-ratio" class="headerlink" title="Lz4 Compression ratio"></a>Lz4 Compression ratio</h3><p>backup 5TB<br>zfs lz4: 3.5TB</p>
<p>home 582G<br>zfs lz4: 337G</p>
<p>project 3TB<br>zfs lz4: 1.7TB </p>
<h3 id="Auto-rebuild"><a href="#Auto-rebuild" class="headerlink" title="Auto rebuild"></a>Auto rebuild</h3><p><a href="https://github.com/zfsonlinux/zfs/issues/2449" target="_blank" rel="external">Autoreplace not working</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">zpool <span class="built_in">set</span> autoreplace=on tank</span><br></pre></td></tr></table></figure></p>
<h3 id="Show-performance"><a href="#Show-performance" class="headerlink" title="Show performance"></a>Show performance</h3><p>Mapping /dev/shm/zil_cache to loop0p1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ dd <span class="keyword">if</span>=/dev/zero of=/dev/shm/zil_cache bs=1M count=4096</span><br><span class="line">$ losetup -v <span class="_">-f</span> /dev/shm/zil_cache</span><br><span class="line">$ losetup <span class="_">-a</span></span><br><span class="line">/dev/loop0: [0018]:55156303 (/dev/shm/zil_cache)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Add zil by mirror</span></span><br><span class="line"><span class="comment"># zpool add tank log mirror /dev/loop0p1 /dev/loop0p2, because it 's test file from /dev/shm</span></span><br><span class="line">$ zpool add tank <span class="built_in">log</span> /dev/loop0p1</span><br><span class="line">$ zpool iostat -v 2</span><br><span class="line"></span><br><span class="line">pool                                            alloc   free   <span class="built_in">read</span>  write   <span class="built_in">read</span>  write</span><br><span class="line">----------------------------------------------  -----  -----  -----  -----  -----  -----</span><br><span class="line">tank                                            24.4G  1.30T      0  8.74K      0   575M</span><br><span class="line">  scsi-3600605b005811bf01db36f957f619f26-part1  24.4G  1.30T      0  5.50K      0   448M</span><br><span class="line">logs                                                -      -      -      -      -      -</span><br><span class="line">  loop0p1                                        102M  3.87G      0  3.23K      0   127M</span><br><span class="line">----------------------------------------------  -----  -----  -----  -----  -----  -----</span><br><span class="line"></span><br><span class="line">                                                   capacity     operations    bandwidth</span><br><span class="line">pool                                            alloc   free   <span class="built_in">read</span>  write   <span class="built_in">read</span>  write</span><br><span class="line">----------------------------------------------  -----  -----  -----  -----  -----  -----</span><br><span class="line">tank                                            24.4G  1.30T      0  8.69K      0   581M</span><br><span class="line">  scsi-3600605b005811bf01db36f957f619f26-part1  24.4G  1.30T      0  5.52K      0   455M</span><br><span class="line">logs                                                -      -      -      -      -      -</span><br><span class="line">  loop0p1                                        108M  3.86G      0  3.17K      0   126M</span><br><span class="line">----------------------------------------------  -----  -----  -----  -----  -----  -----</span><br><span class="line"></span><br><span class="line">$ zpool remove tank loop0p1</span><br><span class="line">$ losetup <span class="_">-d</span> /dev/loop0</span><br></pre></td></tr></table></figure>
<h3 id="Tuning-for-Scrubs-and-Resilvers"><a href="#Tuning-for-Scrubs-and-Resilvers" class="headerlink" title="Tuning for Scrubs and Resilvers"></a><a href="http://broken.net/uncategorized/zfs-performance-tuning-for-scrubs-and-resilvers/" target="_blank" rel="external">Tuning for Scrubs and Resilvers</a></h3><p>Prioritize resilvering by setting the delay to zero</p>
<ul>
<li>set zfs:zfs_resilver_delay = 0</li>
</ul>
<p>Prioritize scrubs by setting the delay to zero</p>
<ul>
<li>set zfs:zfs_scrub_delay = 0</li>
</ul>
<p>set maximum number of inflight IOs to a reasonable value - this number will vary for your environment</p>
<ul>
<li>set zfs:zfs_top_maxinflight = 128</li>
</ul>
<p>resilver for five seconds per TXG</p>
<ul>
<li>set zfs:zfs_resilver_min_time_ms = 5000</li>
</ul>
<p><a href="http://zfsonlinux.org/docs.html" target="_blank" rel="external">http://zfsonlinux.org/docs.html</a><br><a href="http://ispire.me/if-zfs-is-eating-your-memory/" target="_blank" rel="external">http://ispire.me/if-zfs-is-eating-your-memory/</a><br><a href="https://bbs.archlinux.org/viewtopic.php?id=171559" target="_blank" rel="external">https://bbs.archlinux.org/viewtopic.php?id=171559</a><br><a href="http://broken.net/uncategorized/zfs-performance-tuning-for-scrubs-and-resilvers/" target="_blank" rel="external">http://broken.net/uncategorized/zfs-performance-tuning-for-scrubs-and-resilvers/</a><br><a href="http://lustre.ornl.gov/ecosystem-2016/documents/tutorials/Stearman-LLNL-ZFS.pdf" target="_blank" rel="external">Stearman-LLNL-ZFS</a><br><a href="http://fibrevillage.com/storage/171-zfs-on-linux-performance-tuning" target="_blank" rel="external">171-zfs-on-linux-performance</a></p>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> centos </tag>
            
            <tag> zfs </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Online dropbox with socks5 proxy (command line)]]></title>
      <url>http://yoursite.com/2015/12/01/Online-dropbox-with-socks5-proxy-command-line/</url>
      <content type="html"><![CDATA[<p><a href="https://www.dropboxforum.com/hc/en-us/community/posts/204324076-Drop-manual-proxy-setting-not-working-" target="_blank" rel="external">Manual proxy setting not working</a><br>I have the same problem. </p>
<p>Linux Distribution: <a href="http://pinguyos.com" target="_blank" rel="external">PinguyOS</a> base ubuntu 14.04.3 LTS</p>
<p>Try<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> http_proxy=socks5://username:passwd@socks5_proxy_ip:port</span><br></pre></td></tr></table></figure></p>
<p>It’s not work too. Maybe need to Add “</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> http_proxy=<span class="string">"socks5://username:passwd@socks5_proxy_ip:port"</span></span><br></pre></td></tr></table></figure>
<p>Forward socks proxy to http<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ sudo aptitude install privoxy</span><br><span class="line"></span><br><span class="line">$ cat /etc/privoxy/config</span><br><span class="line">...</span><br><span class="line">listen-address 127.0.0.1:1081</span><br><span class="line">forward-socks5 / 127.0.0.1:1080 .</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">$ sudo /etc/init.d/privoxy start</span><br></pre></td></tr></table></figure></p>
<p>Try again<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">export</span> http_proxy=<span class="string">"http://127.0.0.1:1081"</span></span><br><span class="line">$ ~/.dropbox-dist/dropboxd</span><br><span class="line">or </span><br><span class="line">$ dropbox start -i</span><br></pre></td></tr></table></figure></p>
<p>Nice, It’s worked<br><img src="/img/dropbox_online.png" alt=""> </p>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> pinguyos </tag>
            
            <tag> dropbox </tag>
            
            <tag> proxy </tag>
            
            <tag> socks5 </tag>
            
            <tag> privoxy </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Recover openzfs partition table]]></title>
      <url>http://yoursite.com/2015/11/20/Recover%20openzfs%20partition%20table/</url>
      <content type="html"><![CDATA[<h3 id="backup-partition-table"><a href="#backup-partition-table" class="headerlink" title="backup partition table"></a>backup partition table</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MBR</span></span><br><span class="line">sfdisk <span class="_">-d</span> /dev/sda &gt; /tmp/sda.bak</span><br><span class="line">sfdisk /dev/sda &lt; /tmp/sda.bak</span><br><span class="line"></span><br><span class="line">dd <span class="keyword">if</span>=/dev/sda of=/dev/sdb bs=512 count=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># GPT</span></span><br><span class="line">sgdisk --backup=table /dev/sda</span><br><span class="line">sgdisk --load-backup=table /dev/sdb</span><br><span class="line">sgdisk -G /dev/sdb</span><br><span class="line"></span><br><span class="line">B=$(parted -ms /dev/sda <span class="built_in">print</span> |tail -1|cut -b1)</span><br><span class="line">A=$((128*B)+1024)</span><br><span class="line"></span><br><span class="line">dd <span class="keyword">if</span>=/dev/sda of=GPT_TABLE bs=1 count=<span class="variable">$A</span></span><br><span class="line">dd <span class="keyword">if</span>=GPT_TABLE of=/dev/sdb</span><br><span class="line">partprobe /dev/sdb</span><br></pre></td></tr></table></figure>
<p>Backup is very important</p>
<h3 id="Damage-command"><a href="#Damage-command" class="headerlink" title="Damage command"></a>Damage command</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">950  parted /dev/sdb rm 1</span><br><span class="line">951  df -h</span><br><span class="line">952  zpool status</span><br><span class="line">953  zpool destroy tank</span><br><span class="line">954  yum remove $(rpm -qa | grepzfs)</span><br><span class="line">955 parted <span class="_">-a</span> cylinder /dev/sdb mkpart primary 0 100%</span><br><span class="line"><span class="comment"># same parted commmand with created</span></span><br></pre></td></tr></table></figure>
<p>zpool -D improt failed, </p>
<h3 id="Found-uberblock-tag-label"><a href="#Found-uberblock-tag-label" class="headerlink" title="Found uberblock tag label"></a>Found uberblock tag label</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dd if=/dev/sdb1 of=label-2m bs=1M count=2</span></span><br></pre></td></tr></table></figure>
<p>The begin address is 011bc00-128KB, and after 256KB is the uberblock<br>You can use zdb -l 256KB-file, you could get zpool info<br><img src="/img/uberblock_tag.png" alt=""></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># awk 'BEGIN&#123;printf "%x",0x011bc00-0x0020000"\n"&#125;'</span></span><br><span class="line">fbc00</span><br><span class="line"><span class="comment"># awk 'BEGIN&#123;printf "%x",0x011bc00+0x0020000"\n"&#125;'</span></span><br><span class="line">13bc00</span><br></pre></td></tr></table></figure>
<p>The address is from fbc00 to 13bc00</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'BEGIN&#123;print (strtonum("0xfbc00"))/1024&#125;'</span></span><br><span class="line">1007</span><br></pre></td></tr></table></figure>
<p>The begin address in 1007K of the disk (sdb1)</p>
<h3 id="Create-a-new-zpool-in-another-disk"><a href="#Create-a-new-zpool-in-another-disk" class="headerlink" title="Create a new zpool in another disk"></a>Create a new zpool in another disk</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># parted -a cylinder /dev/sdd mkpart primary 0 100%a</span></span><br><span class="line"><span class="comment"># zpool create tank /dev/sdd1</span></span><br><span class="line"><span class="comment"># dd if=/dev/sdd1 of=label-sdd bs=1M count=2</span></span><br></pre></td></tr></table></figure>
<p><img src="/img/uberblock_tag2.png" alt=""><br>The tag at 0021000, and there are nothing in previous part except zero</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># dd if=/dev/zero of=/dev/sdc1 bs=4k count=1</span></span><br><span class="line"><span class="comment"># dd if=/dev/sdb1 of=/dev/sdc1 bs=512 skip=2014 #offset 1007KB</span></span><br></pre></td></tr></table></figure>
<p>You can use zdb get infomation from sdc1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">version: 5000</span><br><span class="line">name: <span class="string">'tank'</span></span><br><span class="line">state: 2</span><br><span class="line">txg: 1256237</span><br><span class="line">pool_guid: 10281825564445304044</span><br><span class="line">errata: 0</span><br><span class="line">hostname: <span class="string">'nas-56-11.local'</span></span><br><span class="line">top_guid: 8832263634429449792</span><br><span class="line">guid: 8832263634429449792</span><br><span class="line">vdev_children: 1</span><br><span class="line">vdev_tree:</span><br><span class="line">    <span class="built_in">type</span>: <span class="string">'disk'</span></span><br><span class="line">    id: 0</span><br><span class="line">    guid: 8832263634429449792</span><br><span class="line">    path: <span class="string">'/dev/sdb1'</span></span><br><span class="line">    whole_disk: 1</span><br><span class="line">    metaslab_array: 33</span><br><span class="line">    metaslab_<span class="built_in">shift</span>: 37</span><br><span class="line">    ashift: 12</span><br><span class="line">    asize: 17990975750144</span><br><span class="line">    is_<span class="built_in">log</span>: 0</span><br><span class="line">    create_txg: 4</span><br></pre></td></tr></table></figure>
<p>When you dd complete. Use “zpool -D import tank” import the loss pool.<br>The disk is a hardraid , There are 17TB important data in it. It really scared the heck out of me.<br>Really Thank Javen Wu very much, Because your help these data could be recovery.</p>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> zfs </tag>
            
            <tag> data recovery </tag>
            
            <tag> partition </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[CentOS 7 HA configuration (3 nodes and kvm stonith)]]></title>
      <url>http://yoursite.com/2015/11/12/CentOS7%20HA%20configuration/</url>
      <content type="html"><![CDATA[<h3 id="Just-for-test-not-in-my-production-environment-it-is-incomplete"><a href="#Just-for-test-not-in-my-production-environment-it-is-incomplete" class="headerlink" title="Just for test , not in my production environment, it is incomplete"></a>Just for test , not in my production environment, it is incomplete</h3><ul>
<li>3 nodes linux HA replace 2 nodes</li>
<li>fence kvm</li>
</ul>
<h3 id="Physical-node-OS"><a href="#Physical-node-OS" class="headerlink" title="Physical node OS"></a>Physical node OS</h3><ul>
<li>CentOS Linux release 7.1.1503 (Core) </li>
<li>3.10.0-229.14.1.el7.x86_64</li>
</ul>
<h3 id="Virtual-machine-OS"><a href="#Virtual-machine-OS" class="headerlink" title="Virtual machine OS"></a>Virtual machine OS</h3><ul>
<li>CentOS release 6.7 (Final)</li>
<li>2.6.32-504.30.3.el6_lustre.x86_64</li>
<li>Not support SR-IOV</li>
<li>Virtaul disk cache set to none</li>
</ul>
<h3 id="Create-linux-HA-3-x-physical-server"><a href="#Create-linux-HA-3-x-physical-server" class="headerlink" title="Create linux HA ,3 x physical server"></a>Create linux HA ,3 x physical server</h3><p>127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4<br>::1         localhost localhost.localdomain localhost6 localhost6.localdomain6<br>10.xx.xx.1 node01<br>10.xx.xx.2 node02<br>10.xx.xx.3 node03</p>
<h3 id="Share-strorages"><a href="#Share-strorages" class="headerlink" title="Share strorages"></a>Share strorages</h3><p>NFS/Lustre</p>
<h3 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum -y install pacemaker corosync fence-agents-all fence-agents-virsh \</span></span><br><span class="line">  fence-virt pacemaker-remote pcs fence-virtd resource-agents \</span><br><span class="line">  fence-virtd-libvirt fence-virtd-multicast</span><br></pre></td></tr></table></figure>
<h3 id="Setup-physical-server"><a href="#Setup-physical-server" class="headerlink" title="Setup physical server"></a>Setup physical server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># echo hacluster | passwd --stdin hacluster</span></span><br><span class="line"><span class="comment"># systemctl enable pcsd.service</span></span><br><span class="line"><span class="comment"># systemctl start pcsd.service</span></span><br><span class="line"><span class="comment"># systemctl is-active pcsd.service</span></span><br><span class="line"><span class="comment"># pcs cluster auth node01 node02 node03 ##input hacluster password for auth</span></span><br><span class="line"><span class="comment"># pcs cluster setup --start --name ha-kvm node01 node02 node03</span></span><br><span class="line"><span class="comment"># pcs property set no-quorum-policy=stop</span></span><br></pre></td></tr></table></figure>
<p>4.1.2 Option no-quorum-policy</p>
<p>This global option defines what to do when a cluster partition does not have quorum (no majority of nodes is part of the partition).</p>
<p>Allowed values are:</p>
<p>ignore<br>The quorum state does not influence the cluster behavior; resource management is continued.</p>
<p>This setting is useful for the following scenarios:</p>
<p>Two-node clusters: Since a single node failure would always result in a loss of majority, usually you want the cluster to carry on regardless. Resource integrity is ensured using fencing, which also prevents split brain scenarios.</p>
<p>Resource-driven clusters: For local clusters with redundant communication channels, a split brain scenario only has a certain probability. Thus, a loss of communication with a node most likely indicates that the node has crashed, and that the surviving nodes should recover and start serving the resources again.</p>
<p>If no-quorum-policy is set to ignore, a 4-node cluster can sustain concurrent failure of three nodes before service is lost. With the other settings, it would lose quorum after concurrent failure of two nodes.</p>
<p>freeze<br>If quorum is lost, the cluster partition freezes. Resource management is continued: running resources are not stopped (but possibly restarted in response to monitor events), but no further resources are started within the affected partition.</p>
<p>This setting is recommended for clusters where certain resources depend on communication with other nodes (for example, OCFS2 mounts). In this case, the default setting no-quorum-policy=stop is not useful, as it would lead to the following scenario: Stopping those resources would not be possible while the peer nodes are unreachable. Instead, an attempt to stop them would eventually time out and cause a stop failure, triggering escalated recovery and fencing.</p>
<p>stop (default value)<br>If quorum is lost, all resources in the affected cluster partition are stopped in an orderly fashion.</p>
<p>suicide<br>If quorum is lost, all nodes in the affected cluster partition are fenced.</p>
<h3 id="Setting-etc-corosync-corosync-conf-for-every-node"><a href="#Setting-etc-corosync-corosync-conf-for-every-node" class="headerlink" title="Setting /etc/corosync/corosync.conf for every node"></a>Setting /etc/corosync/corosync.conf for every node</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">totem &#123;</span><br><span class="line">    version: 2</span><br><span class="line">    secauth: off</span><br><span class="line">    rrp_mode:active</span><br><span class="line">    cluster_name: ha-kvm</span><br><span class="line">    transport: udpu</span><br><span class="line">    token: 17000</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">nodelist &#123;</span><br><span class="line">  node &#123;</span><br><span class="line">	ring0_addr: 10.xx.xx.1</span><br><span class="line">        ring1_addr: 172.xx.xx.1</span><br><span class="line">        nodeid: 1</span><br><span class="line">       &#125;</span><br><span class="line">  node &#123;</span><br><span class="line">        ring0_addr: 10.xx.xx.3</span><br><span class="line">        ring1_addr: 172.xx.xx.3</span><br><span class="line">        nodeid: 2</span><br><span class="line">       &#125;</span><br><span class="line">  node &#123;</span><br><span class="line">        ring0_addr: 10.xx.xx.2</span><br><span class="line">        ring1_addr: 172.xx.xx.2</span><br><span class="line">        nodeid: 3</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">quorum &#123;</span><br><span class="line">    provider: corosync_votequorum</span><br><span class="line">    expected_votes: 3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line">        fileline: off</span><br><span class="line">        to_logfile: yes</span><br><span class="line">        to_syslog: yes</span><br><span class="line">        logfile: /var/<span class="built_in">log</span>/cluster/corosync.log</span><br><span class="line">        timestamp: on</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Restart-corosync-service-in-each-node"><a href="#Restart-corosync-service-in-each-node" class="headerlink" title="Restart corosync service in each node"></a>Restart corosync service in each node</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># systemctl restart corosync</span></span><br></pre></td></tr></table></figure>
<h3 id="Create-stonith-for-physical-server"><a href="#Create-stonith-for-physical-server" class="headerlink" title="Create stonith for physical server"></a>Create stonith for physical server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pcs stonith create node01-fencing fence_ipmilan pcmk_host_list="nod01 node02 node03" \</span></span><br><span class="line">ipaddr=<span class="string">"node1_ipmi_ipaddr"</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_<span class="built_in">wait</span>=4 \</span><br><span class="line">op monitor interval=60s</span><br><span class="line"><span class="comment"># pcs stonith create node02-fencing fence_ipmilan pcmk_host_list="nod01 node02 node03" \</span></span><br><span class="line"> ipaddr=<span class="string">"node2_ipmi_ipaddr"</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_<span class="built_in">wait</span>=4 \</span><br><span class="line">op monitor interval=60s</span><br><span class="line"><span class="comment"># pcs stonith create node03-fencing fence_ipmilan pcmk_host_list="nod01 node02 node03" \</span></span><br><span class="line">ipaddr=<span class="string">"node3_ipmi_ipaddr"</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_<span class="built_in">wait</span>=4 op \</span><br><span class="line">monitor interval=60s</span><br><span class="line"></span><br><span class="line"><span class="comment"># pcs property set stonith-enabled=true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pcs status</span></span><br><span class="line">Cluster name: ha-kvm</span><br><span class="line">Last updated: Wed Nov 11 16:42:46 2015</span><br><span class="line">Last change: Wed Nov 11 02:48:26 2015 by root via crm_resource on node01</span><br><span class="line">Stack: corosync</span><br><span class="line">Current DC: node01 (version 1.1.13<span class="_">-a</span>14efad) - partition with quorum</span><br><span class="line">3 nodes and 5 resources configured</span><br><span class="line"></span><br><span class="line">Online: [ node02 node03 node01 ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> node01-fencing	(stonith:fence_ipmilan):	Started node02</span><br><span class="line"> node03-fencing	(stonith:fence_ipmilan):	Started node01</span><br><span class="line"> node02-fencing	(stonith:fence_ipmilan):	Started node03</span><br><span class="line"></span><br><span class="line">PCSD Status:</span><br><span class="line">  node03: Online</span><br><span class="line">  node01: Online</span><br><span class="line">  node02: Online</span><br><span class="line"></span><br><span class="line">Daemon Status:</span><br><span class="line">  corosync: active/enabled</span><br><span class="line">  pacemaker: active/enabled</span><br><span class="line">  pcsd: active/enabled</span><br></pre></td></tr></table></figure>
<h3 id="Get-quorum-info"><a href="#Get-quorum-info" class="headerlink" title="Get quorum info"></a>Get quorum info</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># corosync-quorumtool -siH</span></span><br><span class="line">Quorum information</span><br><span class="line">------------------</span><br><span class="line">Date:             Thu Nov 12 04:49:31 2015</span><br><span class="line">Quorum provider:  corosync_votequorum</span><br><span class="line">Nodes:            3</span><br><span class="line">Node ID:          0x00000002</span><br><span class="line">Ring ID:          260</span><br><span class="line">Quorate:          Yes</span><br><span class="line"></span><br><span class="line">Votequorum information</span><br><span class="line">----------------------</span><br><span class="line">Expected votes:   3</span><br><span class="line">Highest expected: 3</span><br><span class="line">Total votes:      3</span><br><span class="line">Quorum:           2  </span><br><span class="line">Flags:            Quorate </span><br><span class="line"></span><br><span class="line">Membership information</span><br><span class="line">----------------------</span><br><span class="line">    Nodeid      Votes Name</span><br><span class="line">0x00000003          1 10.0.0.80</span><br><span class="line">0x00000001          1 10.0.10.97</span><br><span class="line">0x00000002          1 10.0.10.106 (<span class="built_in">local</span>)</span><br></pre></td></tr></table></figure>
<h3 id="Install-kvm"><a href="#Install-kvm" class="headerlink" title="Install kvm"></a>Install kvm</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install qemu-kvm libcacard qemu-kvm-common libvirt</span></span><br></pre></td></tr></table></figure>
<h3 id="Create-HA-resource-for-kvm"><a href="#Create-HA-resource-for-kvm" class="headerlink" title="Create HA resource for kvm"></a>Create HA resource for kvm</h3><p>Delete cpu model in your xml file for prevent virsh start faild.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">'custom'</span> <span class="attr">match</span>=<span class="string">'exact'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">model</span> <span class="attr">fallback</span>=<span class="string">'allow'</span>&gt;</span>SandyBridge<span class="tag">&lt;/<span class="name">model</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cpu</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cpu</span> <span class="attr">mode</span>=<span class="string">'custom'</span> <span class="attr">match</span>=<span class="string">'exact'</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">model</span> <span class="attr">fallback</span>=<span class="string">'allow'</span>&gt;</span>Westmere<span class="tag">&lt;/<span class="name">model</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">cpu</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pcs resource create mds-01 VirtualDomain hypervisor="qemu:///system" \</span></span><br><span class="line">config=<span class="string">"/xxx/mds01.xml"</span>  meta remote-node=<span class="string">"mds-01"</span></span><br><span class="line"><span class="comment"># pcs resource create mds-02 VirtualDomain hypervisor="qemu:///system" \</span></span><br><span class="line">config=<span class="string">"/xxx/mds02.xml"</span>  meta remote-node=<span class="string">"mds-02"</span></span><br></pre></td></tr></table></figure>
<p>###Configure the pysical node for stonith<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install fence-virt fence-virtd fence-virtd-multicast fence-virtd-libvirt</span></span><br><span class="line"><span class="comment"># fence_virtd -c</span></span><br><span class="line">Accept all the defaults except <span class="keyword">for</span> the items listed below, and the multicast IP and TCP port <span class="keyword">if</span> you selected non-default ones:</span><br><span class="line">Setting a preferred interface causes fence_virtd to listen only</span><br><span class="line"> on that interface.  Normally, it listens on all interfaces.</span><br><span class="line"> In environments <span class="built_in">where</span> the virtual machines are using the host</span><br><span class="line"> machine as a gateway, this *must* be <span class="built_in">set</span> (typically to virbr0).</span><br><span class="line"> Set to <span class="string">'none'</span> <span class="keyword">for</span> no interface.</span><br><span class="line"> </span><br><span class="line"> Interface [none]: br1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">You can accept the default (none) <span class="keyword">if</span> the guests have IPs on the <span class="built_in">local</span> LAN. Here, we assume they <span class="keyword">do</span> not.</span><br><span class="line">Key File [none]: /etc/cluster/fence_xvm.key</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">This ensures only machines with the same key can initiate fencing requests.</span><br><span class="line">At the end, it will ask</span><br><span class="line">Replace /etc/fence_virt.conf with the above [y/N]? y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Say yes.</span><br><span class="line">You should end up with a configuration like this <span class="keyword">in</span> /etc/fence_virt.conf:</span><br><span class="line">backends &#123;</span><br><span class="line">         libvirt &#123;</span><br><span class="line">                 uri = <span class="string">"qemu:///system"</span>;</span><br><span class="line">         &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> listeners &#123;</span><br><span class="line">         multicast &#123;</span><br><span class="line">                 key_file = <span class="string">"/etc/cluster/fence_xvm.key"</span>;</span><br><span class="line">                 interface = <span class="string">"virbr0"</span>;</span><br><span class="line">                 port = <span class="string">"1229"</span>;</span><br><span class="line">                 address = <span class="string">"225.0.0.12"</span>;</span><br><span class="line">                 family = <span class="string">"ipv4"</span>;</span><br><span class="line">         &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> fence_virtd &#123;</span><br><span class="line">         backend = <span class="string">"libvirt"</span>;</span><br><span class="line">         listener = <span class="string">"multicast"</span>;</span><br><span class="line">         module_path = <span class="string">"/usr/lib64/fence-virt"</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># mkdir -p /etc/cluster</span></span><br><span class="line"><span class="comment"># dd if=/dev/urandom bs=4k count=1 of=/etc/cluster/fence_xvm.key</span></span><br><span class="line"><span class="comment"># chmod 0600 /etc/cluster/fence_xvm.key</span></span><br></pre></td></tr></table></figure></p>
<p>Required changes to the “address” value on both nodes<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    (on node1)</span><br><span class="line">    address = <span class="string">"225.0.1.12"</span>;</span><br><span class="line"></span><br><span class="line">    (on node2)</span><br><span class="line">    address = <span class="string">"225.0.2.12"</span>;</span><br><span class="line"></span><br><span class="line">    (on node3)</span><br><span class="line">    address = <span class="string">"225.0.3.12"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># fence_virtd  #start the daemon</span></span><br><span class="line"><span class="comment"># fence_xvm -o list</span></span><br><span class="line">iml-01               e95b2343-7d31-410d-1398-25c98daaaabd on</span><br><span class="line">manager-kvm          24fa85e3-6cc0-4e1e-b8b5-cdd78aca1eff on</span><br><span class="line">mds-02               e95e6534-7a29-419b-9919-22d8cad8ef4d on</span><br></pre></td></tr></table></figure></p>
<h3 id="Configure-the-virtual-machine-for-stonith"><a href="#Configure-the-virtual-machine-for-stonith" class="headerlink" title="Configure the virtual machine for stonith"></a>Configure the virtual machine for stonith</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># yum install fence-virt fence-virtd</span></span><br><span class="line"><span class="comment"># mkdir -p /etc/cluster</span></span><br><span class="line">Copy the shared key from the physical host to vm:/etc/cluster/fence_xvm.key</span><br></pre></td></tr></table></figure>
<h3 id="Create-stonith-resource-for-vm"><a href="#Create-stonith-resource-for-vm" class="headerlink" title="Create stonith resource for vm"></a>Create stonith resource for vm</h3><p>Because I do not know which vm would be running in one physical node. Because there are three physical server,<br>so I create three vm fencing for one vm.</p>
<p>I setup a corosync with pacemaker two node cluster for mds-01 and mds-02<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pcs stonith create xvmfence_mds-01-1 fence_xvm pcmk_host_list="mds-01 mds-02" action="reboot" \</span></span><br><span class="line">key_file=/etc/cluster/fence_xvm.key multicast_address=225.0.1.12</span><br><span class="line"><span class="comment"># pcs stonith create xvmfence_mds-01-2 fence_xvm pcmk_host_list="mds-01 mds-02" action="reboot" \</span></span><br><span class="line">key_file=/etc/cluster/fence_xvm.key multicast_address=225.0.2.12</span><br><span class="line"><span class="comment"># pcs stonith create xvmfence_mds-01-3 fence_xvm pcmk_host_list="mds-01 mds-02" action="reboot" \</span></span><br><span class="line">key_file=/etc/cluster/fence_xvm.key multicast_address=225.0.3.12</span><br><span class="line"><span class="comment"># pcs stonith create xvmfence_mds-02-1 fence_xvm pcmk_host_list="mds-01 mds-02" action="reboot" \</span></span><br><span class="line">key_file=/etc/cluster/fence_xvm.key multicast_address=225.0.1.12</span><br><span class="line"><span class="comment"># pcs stonith create xvmfence_mds-02-2 fence_xvm pcmk_host_list="mds-01 mds-02" action="reboot" \</span></span><br><span class="line">key_file=/etc/cluster/fence_xvm.key multicast_address=225.0.2.12</span><br><span class="line"><span class="comment"># pcs stonith create xvmfence_mds-02-3 fence_xvm pcmk_host_list="mds-01 mds-02" action="reboot" \</span></span><br><span class="line">key_file=/etc/cluster/fence_xvm.key multicast_address=225.0.3.12</span><br><span class="line"></span><br><span class="line"><span class="comment"># pcs status</span></span><br><span class="line">Cluster name: </span><br><span class="line">Last updated: Thu Nov 12 08:36:34 2015</span><br><span class="line">Last change: Thu Nov 12 08:34:47 2015</span><br><span class="line">Stack: classic openais (with plugin)</span><br><span class="line">Current DC: mds-01 - partition with quorum</span><br><span class="line">Version: 1.1.11-97629de</span><br><span class="line">2 Nodes configured, 2 expected votes</span><br><span class="line">6 Resources configured</span><br><span class="line">Online: [ mds-01 mds-02 ]</span><br><span class="line">Full list of resources:</span><br><span class="line"> xvmfence_mds-01-1	(stonith:fence_xvm):	Started mds-01 </span><br><span class="line"> xvmfence_mds-01-2	(stonith:fence_xvm):	Started mds-02 </span><br><span class="line"> xvmfence_mds-01-3	(stonith:fence_xvm):	Started mds-01 </span><br><span class="line"> xvmfence_mds-02-1	(stonith:fence_xvm):	Started mds-02 </span><br><span class="line"> xvmfence_mds-02-2	(stonith:fence_xvm):	Started mds-01 </span><br><span class="line"> xvmfence_mds-02-3	(stonith:fence_xvm):	Started mds-02 </span><br><span class="line"></span><br><span class="line"><span class="comment"># Settting level for clsuter</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pcs stonith level add 1 mds-01 xvmfence_mds-01-1</span></span><br><span class="line"><span class="comment"># pcs stonith level add 2 mds-01 xvmfence_mds-01-2</span></span><br><span class="line"><span class="comment"># pcs stonith level add 3 mds-01 xvmfence_mds-01-3</span></span><br><span class="line"><span class="comment"># pcs stonith level add 1 mds-01 xvmfence_mds-02-1</span></span><br><span class="line"><span class="comment"># pcs stonith level add 2 mds-01 xvmfence_mds-02-2</span></span><br><span class="line"><span class="comment"># pcs stonith level add 3 mds-01 xvmfence_mds-02-3</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Test-vm-stonith"><a href="#Test-vm-stonith" class="headerlink" title="Test vm stonith"></a>Test vm stonith</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@mds-02 ~]<span class="comment"># fence_xvm -a 225.0.3.12 -k /etc/cluster/fence_xvm.key -H mds-01 -o status</span></span><br><span class="line">Status: ON  (It means mds-01 running <span class="keyword">in</span> node3)</span><br><span class="line">[root@mds-02 ~]<span class="comment"># fence_xvm -a 225.0.1.12 -k /etc/cluster/fence_xvm.key -H mds-01 -o status</span></span><br><span class="line">Status: OFF</span><br><span class="line">[root@mds-02 ~]<span class="comment"># fence_xvm -a 225.0.2.12 -k /etc/cluster/fence_xvm.key -H mds-01 -o status</span></span><br><span class="line">Status: OFF</span><br><span class="line"></span><br><span class="line">[root@mds-02 ~]<span class="comment"># fence_xvm -a 225.0.1.12 -k /etc/cluster/fence_xvm.key -H mds-02 -o status</span></span><br><span class="line">Status: ON  (It means mds-02 running <span class="keyword">in</span> node1)</span><br><span class="line">[root@mds-02 ~]<span class="comment"># fence_xvm -a 225.0.2.12 -k /etc/cluster/fence_xvm.key -H mds-02 -o status</span></span><br><span class="line">Status: OFF</span><br><span class="line">[root@mds-02 ~]<span class="comment"># fence_xvm -a 225.0.3.12 -k /etc/cluster/fence_xvm.key -H mds-02 -o status</span></span><br><span class="line">Status: OFF</span><br><span class="line"></span><br><span class="line">fence mds-02</span><br><span class="line">[root@mds-01 ~]<span class="comment"># pcs stonith fence mds-02</span></span><br><span class="line">Node: mds-02 fenced</span><br><span class="line">[root@mds-02 ~]<span class="comment"># Write failed: Broken pipe</span></span><br><span class="line"></span><br><span class="line">fence mds-01</span><br><span class="line">[root@mds-02 ~]<span class="comment"># pcs stonith fence mds-01</span></span><br><span class="line">Node: mds-01 fenced</span><br><span class="line">[root@mds-01 ~]<span class="comment"># Write failed: Broken pipe</span></span><br></pre></td></tr></table></figure>
<p>There is one Mellanox ConnectX-3 adapter could not work well in my test environment.<br>I checked config again and again until I upgrded the driver, it could work well.<br>Third time to waste my time in Mellanox ethernet adapter, until now I don’t think it’s a good choice.</p>
<p>Reference<br><a href="http://clusterlabs.org/wiki/Guest_Fencing" target="_blank" rel="external">http://clusterlabs.org/wiki/Guest_Fencing</a><br><a href="https://access.redhat.com/solutions/293183" target="_blank" rel="external">https://access.redhat.com/solutions/293183</a><br><a href="https://access.redhat.com/solutions/917833" target="_blank" rel="external">https://access.redhat.com/solutions/917833</a><br><a href="https://alteeve.ca/w/Fencing_KVM_Virtual_Servers#Configuring_fence_xvm" target="_blank" rel="external">https://alteeve.ca/w/Fencing_KVM_Virtual_Servers#Configuring_fence_xvm</a><br><a href="http://people.redhat.com/ccaulfie/docs/Votequorum_Intro.pdf" target="_blank" rel="external">http://people.redhat.com/ccaulfie/docs/Votequorum_Intro.pdf</a><br><a href="https://www.ibm.com/developerworks/community/blogs/mhhaque/entry/configure_two_node_highly_available_cluster_using_kvm_fencing_on_rhel7?lang=en" target="_blank" rel="external">https://www.ibm.com/developerworks/community/blogs/mhhaque/entry/configure_two_node_highly_available_cluster_using_kvm_fencing_on_rhel7?lang=en</a><br><a href="https://www.suse.com/documentation/sle_ha/book_sleha/data/sec_ha_config_basics_global.html?view=print" target="_blank" rel="external">https://www.suse.com/documentation/sle_ha/book_sleha/data/sec_ha_config_basics_global.html?view=print</a></p>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> centos </tag>
            
            <tag> ha </tag>
            
            <tag> cluster </tag>
            
            <tag> 3 nodes </tag>
            
            <tag> corosync </tag>
            
            <tag> pacemaker </tag>
            
            <tag> kvm </tag>
            
            <tag> virtualization </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Tips-hard drive disk]]></title>
      <url>http://yoursite.com/2015/11/06/Tips-hard-drive-disk/</url>
      <content type="html"><![CDATA[<h3 id="Enable-Disable-SAS-HDD-write-cache"><a href="#Enable-Disable-SAS-HDD-write-cache" class="headerlink" title="Enable/Disable SAS HDD write cache"></a>Enable/Disable SAS HDD write cache</h3><p>Write Cache Enable<br>WCE=1 enable<br>WCE=0 disable</p>
<p>Read Cache Disable<br>RCD=0 disable<br>RCD=1 enable</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sdparm <span class="_">-s</span> WCE=1, RCD=0 -S /dev/sdxx</span><br><span class="line">sdparm <span class="_">-a</span> /dev/sdxx</span><br></pre></td></tr></table></figure>
<h3 id="SATA-HDD-write-cache"><a href="#SATA-HDD-write-cache" class="headerlink" title="SATA HDD write cache"></a>SATA HDD write cache</h3><p>W0 Off<br>W1 On<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">hdparm -W0 /dev/sda</span><br><span class="line">hdparm -W /dev/sdx</span><br><span class="line"></span><br><span class="line">hdparm -W1 /dev/sda</span><br><span class="line">hdparm -W /dev/sdx</span><br></pre></td></tr></table></figure></p>
<h3 id="Check-HDD"><a href="#Check-HDD" class="headerlink" title="Check HDD"></a>Check HDD</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">smartctl -t long /dev/sdx</span><br><span class="line">smartctl -t short /dev/sdx</span><br></pre></td></tr></table></figure>
<h3 id="Delete-Rescan-block-scsi-device"><a href="#Delete-Rescan-block-scsi-device" class="headerlink" title="Delete/Rescan block scsi device"></a>Delete/Rescan block scsi device</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># echo 1 &gt; /sys/block/sdXX/device/delete</span></span><br><span class="line"><span class="comment"># echo "- - -" &gt; /sys/class/scsi_host/hostXX/scan</span></span><br></pre></td></tr></table></figure>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> smartctl </tag>
            
            <tag> hdparm </tag>
            
            <tag> sdparm </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Some of Important HDD spec]]></title>
      <url>http://yoursite.com/2015/11/06/Some%20of%20Important%20HDD%20spec/</url>
      <content type="html"><![CDATA[<h2 id="Enterprise-HDD"><a href="#Enterprise-HDD" class="headerlink" title="Enterprise HDD"></a>Enterprise HDD</h2><h3 id="Rotational-Speed-10K～15K"><a href="#Rotational-Speed-10K～15K" class="headerlink" title="Rotational Speed 10K～15K"></a>Rotational Speed 10K～15K</h3><p>Error Rate (non-recoverable, bits read)  1 sector per 10E16<br> Mean Time Between Failures (MTBF, hours)   &lt;2M<br>Availability (hrs/day x days/wk)  24x7</p>
<h3 id="Rotational-Speed-7200"><a href="#Rotational-Speed-7200" class="headerlink" title="Rotational Speed 7200"></a>Rotational Speed 7200</h3><p>Error Rate (non-recoverable, bits read)  1 sector per 10E15<br>Mean Time Between Failures (MTBF, hours)  &gt;1.2M<br>Availability (hrs/day x days/wk)  24x7</p>
<p><img src="/img/hdd-spec.png" alt=""></p>
<p>there are 3 differents sector size in seagate product</p>
<p><img src="/img/sector-size.png" alt=""></p>
]]></content>
      
        <categories>
            
            <category> Hardware </category>
            
        </categories>
        
        
        <tags>
            
            <tag> hdd </tag>
            
            <tag> hard disk </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Deploy Lustre and OpenZFS]]></title>
      <url>http://yoursite.com/2015/11/06/Deploy%20Lustre%20and%20OpenZFS/</url>
      <content type="html"><![CDATA[<h2 id="Hardware"><a href="#Hardware" class="headerlink" title="Hardware"></a>Hardware</h2><h3 id="MDS"><a href="#MDS" class="headerlink" title="MDS"></a>MDS</h3><ul>
<li>2 x SuperMicro SSG-6028R-E1CR12N (Xeon 2650 v3 8*16G)</li>
<li>1 x 2U JBOD (216be26-r920lpb) 14 x ST600MP0005 + 2x ST200FM0002 </li>
<li>2 x LSI Syncro CS 9286-8e (installed in MDS)<br><del>test-test-test</del></li>
</ul>
<h3 id="OSS"><a href="#OSS" class="headerlink" title="OSS"></a>OSS</h3><ul>
<li>4 x SuperMicro SSG-6028R-E1CR12N (Xeon 2630v3 8*8G)</li>
<li>4 x JBOD (SC847DE26-R2K02JBOD, installed 74 x ST6000NM0034) </li>
<li>8 x LSI SAS2308 (installed in OSS)</li>
</ul>
<h2 id="Software"><a href="#Software" class="headerlink" title="Software"></a>Software</h2><ul>
<li>OS: CentOS 6.6 x64 2.6.32-504.30.3.el6_lustre.x86_64</li>
<li>Lustre: 2.5.37.7 (Intel ieel 2.3)</li>
<li>OpenZFS: 0.6.4-1</li>
</ul>
<h3 id="LSI-syncro-Architecture"><a href="#LSI-syncro-Architecture" class="headerlink" title="LSI syncro Architecture"></a>LSI syncro Architecture</h3><p><img src="/img/mds.png" alt=""></p>
<h3 id="MDS-Architecture"><a href="#MDS-Architecture" class="headerlink" title="MDS Architecture"></a>MDS Architecture</h3><p><img src="/img/mds-1.png" alt=""></p>
<h3 id="OSS-Architecture"><a href="#OSS-Architecture" class="headerlink" title="OSS Architecture"></a>OSS Architecture</h3><p><img src="/img/oss.png" alt=""></p>
<h2 id="The-Installation-Process"><a href="#The-Installation-Process" class="headerlink" title="The Installation Process"></a>The Installation Process</h2><h3 id="Configure-LSI-syncro-for-MDS"><a href="#Configure-LSI-syncro-for-MDS" class="headerlink" title="Configure LSI syncro for MDS"></a>Configure LSI syncro for MDS</h3><p><img src="/img/config_syncro.png" alt=""></p>
<p>/opt/MegaRAID/storcli/storcli64 /c1 show all</p>
<p>High Availability :</p>
<p>Topology Type = Server Storage Cluster<br>Domain Id = xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx<br>Peer Controller Status = Active<br>Maximum Controller Nodes = 2<br>Incompatible Details = None</p>
<h3 id="Install-rpms-for-MDS"><a href="#Install-rpms-for-MDS" class="headerlink" title="Install rpms for MDS"></a>Install rpms for MDS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh dracut-004-388.el6.noarch.rpm dracut-kernel-004-388.el6.noarch.rpm</span><br><span class="line">rpm -ivh e2fsprogs-1.42.12.wc1-7.el6.x86_64.rpm e2fsprogs-1.42.12.wc1-bundle.tar.gz e2fsprogs libs-1.42.12.wc1-7.el6.x86_64.rpm libcom_err-1.42.12.wc1-7.el6.x86_64.rpm libss-1.42.12.wc1-7.el6.x86_64.rpm</span><br><span class="line"></span><br><span class="line">rpm -ivh kernel-2.6.32-504.30.3.el6_lustre.x86_64.rpm kernel-devel-2.6.32-504.30.3.el6_lustre.x86_64.rpm kernel-firmware-2.6.32-504.30.3.el6_lustre.x86_64.rpm kernel-headers-2.6.32-504.30.3.el6_lustre.x86_64.rpm lustre-modules-2.5.37.7-2.6.32_504.30.3.el6_lustre.x86_64.x86_64.rpm lustre-2.5.37.7-2.6.32_504.30.3.el6_lustre.x86_64.x86_64.rpm lustre-osd-ldiskfs-2.5.37.7-2.6.32_504.30.3.el6_lustre.x86_64.x86_64.rpm lustre-osd-ldiskfs-mount-2.5.37.7-2.6.32_504.30.3.el6_lustre.x86_64.x86_64.rpm</span><br></pre></td></tr></table></figure>
<h3 id="Configuration-file-for-MDS"><a href="#Configuration-file-for-MDS" class="headerlink" title="Configuration file for MDS"></a>Configuration file for MDS</h3><p>disable selinux and iptables<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span>  <span class="string">"options lnet networks=tcp(bond0)"</span> &gt; /etc/modprobe.d/lnet.conf</span><br><span class="line">bond0 is data transfer network device</span><br><span class="line"></span><br><span class="line">pvcreate /dev/sdb</span><br><span class="line">vgcreate mds_data /dev/sdb</span><br><span class="line">lvcreate <span class="_">-l</span> 2%VG -n mgt_lv mds_data</span><br><span class="line">lvcreate <span class="_">-l</span> 98%VG -n mdt_lv mds_data</span><br></pre></td></tr></table></figure></p>
<p>If you want deactivate it , you can use “vgchange -cn volume group”</p>
<h3 id="Exclude-os-volume-group"><a href="#Exclude-os-volume-group" class="headerlink" title="Exclude os volume group"></a>Exclude os volume group</h3><p>edit /etc/lvm/lvm.conf in mds1<br><figure class="highlight apacheconf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">volume_list</span> =<span class="meta"> [ "vg_mds1", "@MDS-11-1" ]</span></span><br><span class="line"><span class="attribute">locking_type</span> = 1</span><br></pre></td></tr></table></figure></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dracut <span class="_">-f</span> </span><br><span class="line">reboot</span><br></pre></td></tr></table></figure>
<h3 id="Create-Lustre-file-system-for-MDS"><a href="#Create-Lustre-file-system-for-MDS" class="headerlink" title="Create Lustre file system for MDS"></a>Create Lustre file system for MDS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkfs.lustre --reformat --mgs --servicenode=10.x.x.1@tcp --servicenode=10.x.x.2@tcp /dev/mapper/mds_data-mgt_lv</span><br><span class="line"></span><br><span class="line">mkfs.lustre --reformat --mdt --fsname=lustrewh --index=0 --mgsnode=10.xx.xx.1@tcp --mgsnode=10.xx.xx.2@tcp  --servicenode=10.x.x.1@tcp --servicenode=10.x.x.2@tcp  /dev/mapper/mds_data-mdt_lv</span><br></pre></td></tr></table></figure>
<p>You can mount the device where you want<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/dev/mapper/mds_data-mdt_lv  lustre  2.5T  328M  2.3T   1% /lustre/mdt</span><br><span class="line">/dev/mapper/mds_data-mgt_lv  lustre  66G   54M   63G   1% /lustre/mgt</span><br></pre></td></tr></table></figure></p>
<h3 id="Prepare-create-HA-cluster"><a href="#Prepare-create-HA-cluster" class="headerlink" title="Prepare create HA cluster"></a>Prepare create HA cluster</h3><p>MDS1  eth0 192.xx.xx.1 (ipmi)<br>      eth1 192.168.1.1 (heartbeat)<br>      eth4 10.xx.xx.1  (production data)</p>
<p>MDS2  eth0 192.xx.xx.2<br>      eth1 192.168.1.2<br>      eth4 10.xx.xx.2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y pacemaker corosync pcs fence-agents resource-agents</span><br></pre></td></tr></table></figure>
<p>config corosync.conf to /etc/corosync/</p>
<h3 id="corosync-conf-j2-ansible"><a href="#corosync-conf-j2-ansible" class="headerlink" title="corosync.conf.j2 (ansible)"></a>corosync.conf.j2 (ansible)</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#Please read the corosync.conf.5 manual page</span></span><br><span class="line">compatibility: whitetank</span><br><span class="line"></span><br><span class="line">totem &#123;</span><br><span class="line">	version: <span class="number">2</span></span><br><span class="line">	secauth: off</span><br><span class="line">	interface &#123;</span><br><span class="line">		member &#123;</span><br><span class="line">			memberaddr: &#123;&#123; nicA1 &#125;&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		member &#123;</span><br><span class="line">			memberaddr: &#123;&#123; nicB1 &#125;&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		ringnumber: <span class="number">0</span></span><br><span class="line">		bindnetaddr: &#123;&#123; bind1 &#125;&#125;</span><br><span class="line">		mcastport: <span class="number">5406</span></span><br><span class="line">		ttl: <span class="number">1</span></span><br><span class="line">	&#125;</span><br><span class="line">	interface &#123;</span><br><span class="line">                member &#123;</span><br><span class="line">                        memberaddr: &#123;&#123; nicA2 &#125;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">                member &#123;</span><br><span class="line">                        memberaddr: &#123;&#123; nicB2 &#125;&#125;</span><br><span class="line">                &#125;</span><br><span class="line">                ringnumber: <span class="number">1</span></span><br><span class="line">                bindnetaddr: &#123;&#123; bind2 &#125;&#125;</span><br><span class="line">                mcastport: <span class="number">5406</span></span><br><span class="line">                ttl: <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">	transport: udpu</span><br><span class="line">	token: <span class="number">17000</span></span><br><span class="line">	rrp_mode: passive</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logging &#123;</span><br><span class="line">	fileline: off</span><br><span class="line">	to_logfile: yes</span><br><span class="line">	to_syslog: yes</span><br><span class="line">	debug: on</span><br><span class="line">	logfile: /var/<span class="built_in">log</span>/cluster/corosync.<span class="built_in">log</span></span><br><span class="line">	debug: off</span><br><span class="line">	timestamp: on</span><br><span class="line">	logger_subsys &#123;</span><br><span class="line">		subsys: AMF</span><br><span class="line">		debug: off</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="etc-corosync-service-d-pacemaker"><a href="#etc-corosync-service-d-pacemaker" class="headerlink" title="/etc/corosync/service.d/pacemaker"></a>/etc/corosync/service.d/pacemaker</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">service &#123;</span><br><span class="line">        <span class="meta"># Load the Pacemaker Cluster Resource Manager</span></span><br><span class="line">        name: pacemaker</span><br><span class="line">        ver:  <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="etc-hosts"><a href="#etc-hosts" class="headerlink" title="/etc/hosts"></a>/etc/hosts</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">:<span class="number">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line"><span class="number">10.</span>xx.xx<span class="number">.1</span>  MDS<span class="bullet">-11</span><span class="bullet">-1</span></span><br><span class="line"><span class="number">10.</span>xx.xx<span class="number">.2</span>  MDS<span class="bullet">-11</span><span class="bullet">-2</span></span><br><span class="line"><span class="number">10.</span>xx.xx<span class="number">.4</span>  OSS<span class="bullet">-11</span><span class="bullet">-4</span></span><br><span class="line"><span class="number">10.</span>xx.xx<span class="number">.5</span>  OSS<span class="bullet">-11</span><span class="bullet">-5</span></span><br><span class="line"><span class="number">10.</span>xx.xx<span class="number">.6</span>  OSS<span class="bullet">-11</span><span class="bullet">-6</span></span><br><span class="line"><span class="number">10.</span>xx.xx<span class="number">.7</span>  OSS<span class="bullet">-11</span><span class="bullet">-7</span></span><br><span class="line"><span class="number">192.</span>xx.xx<span class="number">.1</span> MDS<span class="bullet">-11</span><span class="bullet">-1.</span>ipmi</span><br><span class="line"><span class="number">192.</span>xx.xx<span class="number">.2</span> MDS<span class="bullet">-11</span><span class="bullet">-2.</span>ipmi</span><br><span class="line"><span class="number">192.</span>xx.xx<span class="number">.4</span> OSS<span class="bullet">-11</span><span class="bullet">-4.</span>ipmi</span><br><span class="line"><span class="number">192.</span>xx.xx<span class="number">.5</span> OSS<span class="bullet">-11</span><span class="bullet">-5.</span>ipmi</span><br><span class="line"><span class="number">192.</span>xx.xx<span class="number">.6</span> OSS<span class="bullet">-11</span><span class="bullet">-6.</span>ipmi</span><br><span class="line"><span class="number">192.</span>xx.xx<span class="number">.7</span> OSS<span class="bullet">-11</span><span class="bullet">-7.</span>ipmi</span><br></pre></td></tr></table></figure>
<p>If you need install IML, keep the same with your HOSTNAME environment variable and dns resolve.</p>
<h3 id="Synchronizing-time-for-each-server"><a href="#Synchronizing-time-for-each-server" class="headerlink" title="Synchronizing time for each server"></a>Synchronizing time for each server</h3><p>go to <a href="http://www.pool.ntp.org/en/#top" target="_blank" rel="external">http://www.pool.ntp.org/en/#top</a></p>
<h3 id="Enable-service"><a href="#Enable-service" class="headerlink" title="Enable service"></a>Enable service</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/corosync start</span><br><span class="line">/etc/init.d/pacemaker restart</span><br><span class="line">/etc/init.d/pcsd start</span><br><span class="line">chkconfig --level 35 corosync on</span><br><span class="line">chkconfig --level 35 pacemaker on</span><br><span class="line">chkconfig --level 35 pcsd on</span><br></pre></td></tr></table></figure>
<h3 id="Create-HA-cluster-for-MDS"><a href="#Create-HA-cluster-for-MDS" class="headerlink" title="Create HA cluster for MDS"></a>Create HA cluster for MDS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">pcs property <span class="built_in">set</span> no-quorum-policy=ignore</span><br><span class="line">pcs property <span class="built_in">set</span> stonith-enabled=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">pcs stonith create mds-11-1-fencing fence_ipmilan pcmk_host_list=<span class="string">"OSS-11-4.local"</span> ipaddr=<span class="string">"192.xx.xx.1"</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_<span class="built_in">wait</span>=4 op monitor interval=60s</span><br><span class="line">pcs stonith create mds-11-2-fencing fence_ipmilan pcmk_host_list=<span class="string">"OSS-11-4.local"</span> ipaddr=<span class="string">"192.xx.xx.2"</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_<span class="built_in">wait</span>=4 op monitor interval=60s</span><br><span class="line"></span><br><span class="line">pcs resource create Lustre_mgt ocf:heartbeat:Filesystem device=<span class="string">"/dev/mapper/mds_data-mgt_lv"</span> directory=<span class="string">"/lustre/mgt"</span> fstype=<span class="string">"lustre"</span></span><br><span class="line">pcs resource create Lustre_mdt ocf:heartbeat:Filesystem device=<span class="string">"/dev/mapper/mds_data-mdt_lv"</span> directory=<span class="string">"/lustre/mdt"</span> fstype=<span class="string">"lustre"</span></span><br><span class="line"></span><br><span class="line">pcs resource create mds_lv ocf:heartbeat:LVM volgrpname=mds_data exclusive=<span class="literal">true</span></span><br><span class="line">pcs constraint order mds_lv <span class="keyword">then</span> Lustre_mgt</span><br><span class="line">pcs constraint colocation add Lustre_mgt with mds_lv</span><br><span class="line">pcs constraint order mds_lv <span class="keyword">then</span> Lustre_mdt</span><br><span class="line">pcs constraint colocation add Lustre_mdt with mds_lv</span><br><span class="line"></span><br><span class="line">pcs resource update Lustre_mgt op start interval=0 timeout=300</span><br><span class="line">pcs resource update Lustre_mgt op stop interval=0 timeout=300</span><br><span class="line">pcs resource update Lustre_mgt op monitor interval=5</span><br><span class="line">pcs resource update mds_lv op start interval=0 timeout=300</span><br><span class="line">pcs resource update mds_lv op stop interval=0 timeout=300</span><br><span class="line">pcs resource update mds_lv op monitor interval=5</span><br><span class="line">pcs resource update Lustre_mdt op start interval=0 timeout=300</span><br><span class="line">pcs resource update Lustre_mdt op stop interval=0 timeout=300</span><br><span class="line">pcs resource update Lustre_mdt op monitor interval=5 timeout=60</span><br><span class="line">pcs resource meta Lustre_mgt migration-threshold=5</span><br><span class="line">pcs resource meta Lustre_mdt migration-threshold=5</span><br><span class="line">pcs resource meta mds_lv migration-threshold=5</span><br><span class="line">pcs resource meta Lustre_mdt failure-timeout=120</span><br><span class="line">pcs resource meta Lustre_mgt failure-timeout=120</span><br><span class="line">pcs resource meta mds_lv failure-timeout=120</span><br></pre></td></tr></table></figure>
<h4 id="pcs-default-setting"><a href="#pcs-default-setting" class="headerlink" title="pcs default setting"></a>pcs default setting</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pcs resource defaults migration-threshold=5</span><br><span class="line"><span class="comment">#pcs resource defaults resource-stickiness=100 # 100means not switch service</span></span><br><span class="line">pcs resource op defaults timeout=360s</span><br><span class="line">pcs resource defaults failure-timeout=360s</span><br><span class="line">pcs property <span class="built_in">set</span> stonith-action=reboot</span><br></pre></td></tr></table></figure>
<h4 id="delete-default-value"><a href="#delete-default-value" class="headerlink" title="delete default value"></a>delete default value</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcs resource defaults timouts=    <span class="comment">#not set any value</span></span><br></pre></td></tr></table></figure>
<h4 id="pcs-status"><a href="#pcs-status" class="headerlink" title="pcs status"></a>pcs status</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Cluster name: </span><br><span class="line"><span class="attr">Stack:</span> classic openais (with plugin)</span><br><span class="line">Current DC: MDS<span class="bullet">-11</span><span class="bullet">-2.</span>local - partition with quorum</span><br><span class="line"><span class="attr">Version:</span> <span class="number">1.1</span><span class="number">.11</span><span class="bullet">-97629</span>de</span><br><span class="line"><span class="number">2</span> Nodes configured, <span class="number">2</span> expected votes</span><br><span class="line"><span class="number">4</span> Resources configured</span><br><span class="line"></span><br><span class="line"><span class="attr">Online:</span> [ MDS<span class="bullet">-11</span><span class="bullet">-1.</span>local MDS<span class="bullet">-11</span><span class="bullet">-2.</span>local ]</span><br><span class="line"></span><br><span class="line">Full list of resources:</span><br><span class="line"></span><br><span class="line"> mds<span class="bullet">-11</span><span class="bullet">-1</span>-fencing (stonith:fence_ipmilan): Started MDS<span class="bullet">-11</span><span class="bullet">-2.</span>local </span><br><span class="line"> mds<span class="bullet">-11</span><span class="bullet">-2</span>-fencing (stonith:fence_ipmilan): Started MDS<span class="bullet">-11</span><span class="bullet">-2.</span>local </span><br><span class="line"> Lustre_mgt (ocf::heartbeat:Filesystem): Started MDS<span class="bullet">-11</span><span class="bullet">-2.</span>local </span><br><span class="line"> Lustre_mdt (ocf::heartbeat:Filesystem): Started MDS<span class="bullet">-11</span><span class="bullet">-1.</span>local</span><br></pre></td></tr></table></figure>
<h3 id="About-OSS"><a href="#About-OSS" class="headerlink" title="About OSS"></a>About OSS</h3><p>OSS don ‘t like MDS, it ‘s base openzfs not ldiskfs.<br>OSS need be do 5.1 ~ 5.5 like MDS except 5.2, here is different setting</p>
<h3 id="Initialization-OpenZFS"><a href="#Initialization-OpenZFS" class="headerlink" title="Initialization OpenZFS"></a>Initialization OpenZFS</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh e2fsprogs<span class="bullet">-1.42</span><span class="number">.12</span>.wc1<span class="bullet">-7.</span>el6.x86_64.rpm e2fsprogs<span class="bullet">-1.42</span><span class="number">.12</span>.wc1-bundle.tar.gz e2fsprogs libs<span class="bullet">-1.42</span><span class="number">.12</span>.wc1<span class="bullet">-7.</span>el6.x86_64.rpm libcom_err<span class="bullet">-1.42</span><span class="number">.12</span>.wc1<span class="bullet">-7.</span>el6.x86_64.rpm libss<span class="bullet">-1.42</span><span class="number">.12</span>.wc1<span class="bullet">-7.</span>el6.x86_64.rpm</span><br><span class="line"></span><br><span class="line">rpm -ivh dracut<span class="bullet">-004</span><span class="bullet">-388.</span>el6.noarch.rpm dracut-kernel<span class="bullet">-004</span><span class="bullet">-388.</span>el6.noarch.rpm</span><br><span class="line"></span><br><span class="line">rpm -ivh kernel<span class="bullet">-2.6</span><span class="number">.32</span><span class="bullet">-504.30</span><span class="number">.3</span>.el6_lustre.x86_64.rpm kernel-devel<span class="bullet">-2.6</span><span class="number">.32</span><span class="bullet">-504.30</span><span class="number">.3</span>.el6_lustre.x86_64.rpm kernel-firmware<span class="bullet">-2.6</span><span class="number">.32</span><span class="bullet">-504.30</span><span class="number">.3</span>.el6_lustre.x86_64.rpm kernel-headers<span class="bullet">-2.6</span><span class="number">.32</span><span class="bullet">-504.30</span><span class="number">.3</span>.el6_lustre.x86_64.rpm</span><br></pre></td></tr></table></figure>
<h3 id="Setting-lnet"><a href="#Setting-lnet" class="headerlink" title="Setting lnet"></a>Setting lnet</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span>  <span class="string">"options lnet networks=tcp(bond0)"</span> &gt; /etc/modprobe.d/lnet.conf</span><br></pre></td></tr></table></figure>
<h3 id="Limit-zfs-memory-useage-half-memory-to-avoid-OOM-killer"><a href="#Limit-zfs-memory-useage-half-memory-to-avoid-OOM-killer" class="headerlink" title="Limit zfs memory useage(half memory) ,to avoid OOM killer"></a>Limit zfs memory useage(half memory) ,to avoid OOM killer</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk <span class="string">'$0~/MemTotal/ &#123;print "options zfs zfs_arc_max="$2*1024/2&#125;'</span> /proc/meminfo &gt; /etc/modprobe.d/zfs.conf</span><br></pre></td></tr></table></figure>
<p>33720700928 = 32GB</p>
<h3 id="Setting-multipath-SAS-HDD-JBOD"><a href="#Setting-multipath-SAS-HDD-JBOD" class="headerlink" title="Setting multipath (SAS HDD, JBOD)"></a>Setting multipath (SAS HDD, JBOD)</h3><h4 id="etc-multipath-conf"><a href="#etc-multipath-conf" class="headerlink" title="/etc/multipath.conf"></a>/etc/multipath.conf</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">defaults &#123;</span><br><span class="line">polling_interval  <span class="number">10</span></span><br><span class="line">path_selector  <span class="string">"round-robin 0"</span></span><br><span class="line">path_grouping_policy failover</span><br><span class="line">prio   const</span><br><span class="line">path_checker  directio</span><br><span class="line">rr_min_io  <span class="number">1000</span></span><br><span class="line">max_fds   <span class="number">10240</span></span><br><span class="line">rr_weight  priorities</span><br><span class="line">failback  immediate</span><br><span class="line">no_path_retry  fail</span><br><span class="line">user_friendly_names <span class="literal">no</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">blacklist &#123;</span><br><span class="line">        wwid <span class="number">3600304801</span>b1326001d0b4e480378fac8 <span class="comment">##root partition</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If you use Dell MD34xx/NetAPP E27xx,Some of LSI chip in your Raid controller<br>You should change some in multipath.conf</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">defaults &#123;</span><br><span class="line"> polling_interval  <span class="number">10</span></span><br><span class="line"> path_selector  <span class="string">"round-robin 0"</span></span><br><span class="line"> path_grouping_policy group_by_prio</span><br><span class="line"> prio   rdac</span><br><span class="line"> path_checker  rdac</span><br><span class="line"> rr_min_io  <span class="number">1000</span></span><br><span class="line"> max_fds    <span class="number">10240</span></span><br><span class="line"> rr_weight  priorities</span><br><span class="line"> failback  immediate</span><br><span class="line"> no_path_retry  <span class="number">30</span></span><br><span class="line"> user_friendly_names no</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="reboot"><a href="#reboot" class="headerlink" title="reboot"></a>reboot</h3><h3 id="Install-OpenZFS"><a href="#Install-OpenZFS" class="headerlink" title="Install OpenZFS"></a>Install OpenZFS</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh spl<span class="bullet">-0.6</span><span class="number">.4</span><span class="number">.1</span><span class="bullet">-1.</span>el6.src.rpm zfs<span class="bullet">-0.6</span><span class="number">.4</span><span class="number">.1</span><span class="bullet">-1.</span>el6.src.rpm</span><br><span class="line">rpmbuild -bb -v spl.spec</span><br><span class="line">rpmbuild -bb -v zfs.spec</span><br><span class="line">rpm -ivh spl<span class="bullet">-0.6</span><span class="number">.4</span><span class="number">.1</span><span class="bullet">-1.</span>el6.x86_64.rpm spl-dkms<span class="bullet">-0.6</span><span class="number">.4</span><span class="number">.1</span><span class="bullet">-1.</span>el6.noarch.rpm zfs-dkms<span class="bullet">-0.6</span><span class="number">.4</span><span class="number">.1</span><span class="bullet">-1.</span>el6.noarch.rpm zfs<span class="bullet">-0.6</span><span class="number">.4</span><span class="number">.1</span><span class="bullet">-1.</span>el6.x86_64.rpm libzpool2<span class="bullet">-0.6</span><span class="number">.4</span><span class="number">.1</span><span class="bullet">-1.</span>el6.x86_64.rpm libnvpair1<span class="bullet">-0.6</span><span class="number">.4</span><span class="number">.1</span><span class="bullet">-1.</span>el6.x86_64.rpm libuutil1<span class="bullet">-0.6</span><span class="number">.4</span><span class="number">.1</span><span class="bullet">-1.</span>el6.x86_64.rpm libzfs2<span class="bullet">-0.6</span><span class="number">.4</span><span class="number">.1</span><span class="bullet">-1.</span>el6.x86_64.rpm zfs-dracut<span class="bullet">-0.6</span><span class="number">.4</span><span class="number">.1</span><span class="bullet">-1.</span>el6.x86_64.rpm</span><br></pre></td></tr></table></figure>
<h4 id="Alias-HDD-name-etc-zfs-vdev-id-conf"><a href="#Alias-HDD-name-etc-zfs-vdev-id-conf" class="headerlink" title="Alias HDD name /etc/zfs/vdev_id.conf"></a>Alias HDD name /etc/zfs/vdev_id.conf</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">multipath <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">alias hdd<span class="bullet">-0</span><span class="bullet">-2</span><span class="bullet">-0</span> /dev/disk/by-id/dm-uuid-mpath<span class="bullet">-35000</span>c50062a54f23</span><br><span class="line">alias hdd<span class="bullet">-0</span><span class="bullet">-2</span><span class="bullet">-1</span> /dev/disk/by-id/dm-uuid-mpath<span class="bullet">-35000</span>c500630fde27</span><br><span class="line">alias hdd<span class="bullet">-0</span><span class="bullet">-2</span><span class="bullet">-2</span> /dev/disk/by-id/dm-uuid-mpath<span class="bullet">-35000</span>c50062d67aa7</span><br><span class="line">alias hdd<span class="bullet">-0</span><span class="bullet">-2</span><span class="bullet">-3</span> /dev/disk/by-id/dm-uuid-mpath<span class="bullet">-35000</span>c50062db08ff</span><br><span class="line">.......</span><br><span class="line">alias hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-15</span> /dev/disk/by-id/dm-uuid-mpath<span class="bullet">-35000</span>c50062fdd8cf</span><br></pre></td></tr></table></figure>
<h4 id="Create-zpool"><a href="#Create-zpool" class="headerlink" title="Create zpool"></a>Create zpool</h4><p>If you care performance ,don ‘t use ashift=9, In my case ,capacity is very important.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zpool create <span class="_">-f</span> ost-0 -o cachefile=none -o ashift=9 raidz3 hdd-0-2-0 hdd-0-2-1 hdd-0-2-2 hdd-0-2-3 hdd-0-2-4 hdd-0-2-5 hdd-0-2-6 hdd-0-2-7 hdd-0-2-8 hdd-0-2-9 hdd-2-10 hdd-2-11 spare hdd-0-3-15 hdd-0-5-15</span><br><span class="line">......</span><br></pre></td></tr></table></figure></p>
<h4 id="create-ost"><a href="#create-ost" class="headerlink" title="create ost"></a>create ost</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">zpool status ost<span class="bullet">-11</span></span><br><span class="line"><span class="attr">  pool:</span> ost<span class="bullet">-11</span></span><br><span class="line"><span class="attr"> state:</span> ONLINE</span><br><span class="line"><span class="attr">  scan:</span> resilvered <span class="number">710</span>K in <span class="number">0</span>h0m with <span class="number">0</span> errors on Thu Aug <span class="number">20</span> <span class="number">14</span>:<span class="number">12</span>:<span class="number">35</span> <span class="number">2015</span></span><br><span class="line"><span class="attr">config:</span></span><br><span class="line"></span><br><span class="line">NAME            STATE     READ WRITE CKSUM</span><br><span class="line">ost<span class="bullet">-11</span>          ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">  raidz3<span class="bullet">-0</span>      ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-1</span>   ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-2</span>   ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-3</span>   ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-5</span>   ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-6</span>   ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-7</span>   ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-9</span>   ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-10</span>  ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-11</span>  ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-12</span>  ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-13</span>  ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">    hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-14</span>  ONLINE       <span class="number">0</span>     <span class="number">0</span>     <span class="number">0</span></span><br><span class="line">spares</span><br><span class="line">  hdd<span class="bullet">-1</span><span class="bullet">-3</span><span class="bullet">-15</span>    AVAIL   </span><br><span class="line">  hdd<span class="bullet">-1</span><span class="bullet">-5</span><span class="bullet">-15</span>    AVAIL</span><br></pre></td></tr></table></figure>
<h4 id="Enable-ZFS-features"><a href="#Enable-ZFS-features" class="headerlink" title="Enable ZFS features"></a>Enable ZFS features</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..11&#125;</span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">    zfs <span class="built_in">set</span> acltype=posixacl ost-<span class="variable">$i</span>; </span><br><span class="line">    zfs <span class="built_in">set</span> compression=lz4 ost-<span class="variable">$i</span>; </span><br><span class="line">    zfs <span class="built_in">set</span> xattr=sa ost-<span class="variable">$i</span>; </span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h4 id="Format-zfs"><a href="#Format-zfs" class="headerlink" title="Format zfs"></a>Format zfs</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..11&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"mkfs.lustre --reformat --ost --backfstype=zfs --fsname=lustrewh --index=<span class="variable">$i</span> --mgsnode=10.xx.xx.1@tcp --mgsnode=10.xx.xx.2@tcp  --servicenode=10.x.x.4@tcp --servicenode=10.x.x.5@tcp</span><br><span class="line">ost-<span class="variable">$i</span>/ost-<span class="variable">$i</span>"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h4 id="Create-HA-cluster"><a href="#Create-HA-cluster" class="headerlink" title="Create HA cluster"></a>Create HA cluster</h4><p>/etc/corosync/corosync.conf<br>/etc/corosync/service.d/pacemaker<br>same with config MDS</p>
<p>Copy hearbeat script to all member of the cluster node<br>Get the file <a href="https://github.com/skiselkov/stmf-ha/blob/master/heartbeat/ZFS" target="_blank" rel="external">https://github.com/skiselkov/stmf-ha/blob/master/heartbeat/ZFS</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 755 /usr/lib/ocf/resource.d/heartbeat/ZFS </span><br><span class="line">chmod 755 /usr/lib/ocf/resource.d/heartbeat/Lustre-ZFS</span><br></pre></td></tr></table></figure></p>
<p>It ‘ s written by Paciucci Gabriele (intel)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Lustre-ZFS </span></span><br><span class="line"><span class="comment">#      Description: Manages a Lustre target on a shared storage medium.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># usage: ./Lustre-ZFS &#123;start|stop|status|monitor|validate-all|meta-data&#125;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#      OCF parameters are as below:</span></span><br><span class="line"><span class="comment">#        OCF_RESKEY_vdev</span></span><br><span class="line"><span class="comment">#	OCF_RESKEY_mountpoint</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># OCF_RESKEY_vdev : name of the target the script should operate on</span></span><br><span class="line"><span class="comment"># OCF_RESKEY_mountpoint : name of the target the script should operate on</span></span><br><span class="line"></span><br><span class="line">: <span class="variable">$&#123;OCF_FUNCTIONS_DIR=$&#123;OCF_ROOT&#125;</span>/resource.d/heartbeat&#125;</span><br><span class="line">. <span class="variable">$&#123;OCF_FUNCTIONS_DIR&#125;</span>/.ocf-shellfuncs</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">usage</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"usage: <span class="variable">$0</span> &#123;start|stop|status|monitor|meta-data&#125;"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">meta_data</span></span>() &#123;</span><br><span class="line">    cat &lt;&lt;END</span><br><span class="line">&lt;?xml version=<span class="string">"1.0"</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE resource-agent SYSTEM <span class="string">"ra-api-1.dtd"</span>&gt;</span><br><span class="line">&lt;resource-agent name=<span class="string">"Lustre-ZFS"</span>&gt;</span><br><span class="line">&lt;version&gt;1.0&lt;/version&gt;</span><br><span class="line"></span><br><span class="line">&lt;longdesc lang=<span class="string">"en"</span>&gt;</span><br><span class="line">Resource script <span class="keyword">for</span> a Lustre ZFS Target.</span><br><span class="line">&lt;/longdesc&gt;</span><br><span class="line"></span><br><span class="line">&lt;shortdesc lang=<span class="string">"en"</span>&gt;Manages Lustre ZFS Targets&lt;/shortdesc&gt;</span><br><span class="line"></span><br><span class="line">&lt;parameters&gt;</span><br><span class="line">&lt;parameter name=<span class="string">"vdev"</span> required=<span class="string">"1"</span>&gt;</span><br><span class="line">&lt;longdesc lang=<span class="string">"en"</span>&gt;</span><br><span class="line">The name of the ZFS vdev.</span><br><span class="line">&lt;/longdesc&gt;</span><br><span class="line">&lt;shortdesc lang=<span class="string">"en"</span>&gt;vdev&lt;/shortdesc&gt;</span><br><span class="line">&lt;content <span class="built_in">type</span>=<span class="string">"string"</span> default=<span class="string">""</span> /&gt;</span><br><span class="line">&lt;/parameter&gt;</span><br><span class="line"></span><br><span class="line">&lt;parameter name=<span class="string">"mountpoint"</span> required=<span class="string">"1"</span>&gt;</span><br><span class="line">&lt;longdesc lang=<span class="string">"en"</span>&gt;</span><br><span class="line">The mount point <span class="keyword">for</span> the target</span><br><span class="line">&lt;/longdesc&gt;</span><br><span class="line">&lt;shortdesc lang=<span class="string">"en"</span>&gt;mountpoint&lt;/shortdesc&gt;</span><br><span class="line">&lt;content <span class="built_in">type</span>=<span class="string">"string"</span> default=<span class="string">""</span> /&gt;</span><br><span class="line">&lt;/parameter&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;/parameters&gt;</span><br><span class="line"></span><br><span class="line">&lt;actions&gt;</span><br><span class="line">&lt;action name=<span class="string">"start"</span> timeout=<span class="string">"60"</span> /&gt;</span><br><span class="line">&lt;action name=<span class="string">"stop"</span> timeout=<span class="string">"60"</span> /&gt;</span><br><span class="line">&lt;action name=<span class="string">"notify"</span> timeout=<span class="string">"60"</span> /&gt;</span><br><span class="line">&lt;action name=<span class="string">"monitor"</span> depth=<span class="string">"0"</span> timeout=<span class="string">"40"</span> interval=<span class="string">"20"</span> /&gt;</span><br><span class="line">&lt;action name=<span class="string">"validate-all"</span> timeout=<span class="string">"5"</span> /&gt;</span><br><span class="line">&lt;action name=<span class="string">"meta-data"</span> timeout=<span class="string">"5"</span> /&gt;</span><br><span class="line">&lt;/actions&gt;</span><br><span class="line">&lt;/resource-agent&gt;</span><br><span class="line">END</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">Target_start</span></span>() &#123;</span><br><span class="line">    <span class="comment"># See if the device is already mounted.</span></span><br><span class="line">    <span class="keyword">if</span> Target_status &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">        ocf_<span class="built_in">log</span> info <span class="string">"Target <span class="variable">$TARGET</span> is already started."</span></span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$OCF_SUCCESS</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># this is not necessary, mount should start modules </span></span><br><span class="line"><span class="comment">#    if ! grep -e 'lustre$' /proc/filesystems &gt;/dev/null; then</span></span><br><span class="line"><span class="comment">#        ocf_log err "Couldn't find the lustre module in /proc/filesystems"</span></span><br><span class="line"><span class="comment">#        return $OCF_ERR_ARGS</span></span><br><span class="line"><span class="comment">#    fi</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># start the target</span></span><br><span class="line"><span class="comment">#    if ! chroma-agent mount_target --uuid $TARGET; then</span></span><br><span class="line">    <span class="keyword">if</span> ! mount -t lustre <span class="variable">$TARGET</span> <span class="variable">$MOUNT_POINT</span>; <span class="keyword">then</span></span><br><span class="line">        ocf_<span class="built_in">log</span> err <span class="string">"Couldn't start target <span class="variable">$TARGET</span>"</span></span><br><span class="line">        <span class="built_in">return</span> <span class="variable">$OCF_ERR_GENERIC</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$OCF_SUCCESS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">Target_notify</span></span>() &#123;</span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$OCF_SUCCESS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">Target_stop</span></span>() &#123;</span><br><span class="line">    <span class="comment"># started already?</span></span><br><span class="line">    Target_status &gt;/dev/null 2&gt;&amp;1</span><br><span class="line">    <span class="keyword">if</span> [ $? <span class="_">-eq</span> <span class="variable">$OCF_NOT_RUNNING</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="comment"># woo!  nothing to do.</span></span><br><span class="line">        rc=<span class="variable">$OCF_SUCCESS</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line"><span class="comment">#        chroma-agent unmount_target --uuid $TARGET</span></span><br><span class="line">        umount <span class="variable">$MOUNT_POINT</span> </span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$rc</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">Target_status</span></span>() &#123;</span><br><span class="line">    <span class="comment"># call the agent to see if it's running</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#    if chroma-agent target_running --uuid $TARGET &gt;/dev/null 2&gt;&amp;1; then</span></span><br><span class="line">    <span class="keyword">if</span> cat /proc/mounts |grep <span class="variable">$MOUNT_POINT</span> &gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">        rc=<span class="variable">$OCF_SUCCESS</span></span><br><span class="line">        msg=<span class="string">"<span class="variable">$TARGET</span> is started (running)"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        rc=<span class="variable">$OCF_NOT_RUNNING</span></span><br><span class="line">        msg=<span class="string">"<span class="variable">$TARGET</span> is stopped"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">"<span class="variable">$OP</span>"</span> = <span class="string">"status"</span> ]; <span class="keyword">then</span></span><br><span class="line">        ocf_<span class="built_in">log</span> info <span class="string">"<span class="variable">$msg</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> <span class="variable">$rc</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">Target_validate_all</span></span>() &#123;</span><br><span class="line">	<span class="built_in">return</span> <span class="variable">$OCF_SUCCESS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> <span class="_">-ne</span> 1 ]; <span class="keyword">then</span></span><br><span class="line">    usage</span><br><span class="line">    <span class="built_in">exit</span> <span class="variable">$OCF_ERR_ARGS</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">TARGET=<span class="variable">$OCF_RESKEY_vdev</span></span><br><span class="line">MOUNT_POINT=<span class="variable">$OCF_RESKEY_mountpoint</span></span><br><span class="line">OP=<span class="variable">$1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># These operations do not require instance parameters</span></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$OP</span> <span class="keyword">in</span></span><br><span class="line">meta-data)    meta_data</span><br><span class="line">              <span class="built_in">exit</span> <span class="variable">$OCF_SUCCESS</span></span><br><span class="line">              ;;</span><br><span class="line">usage)        usage</span><br><span class="line">              <span class="built_in">exit</span> <span class="variable">$OCF_SUCCESS</span></span><br><span class="line">              ;;</span><br><span class="line">status)       Target_status</span><br><span class="line">              <span class="built_in">exit</span> $?</span><br><span class="line">              ;;</span><br><span class="line">monitor)      Target_status</span><br><span class="line">              <span class="built_in">exit</span> $?</span><br><span class="line">              ;;</span><br><span class="line">validate-all) Target_validate_all</span><br><span class="line">              <span class="built_in">exit</span> $?</span><br><span class="line">              ;;</span><br><span class="line">stop)         Target_stop</span><br><span class="line">              <span class="built_in">exit</span> $?</span><br><span class="line">              ;;</span><br><span class="line">start)        Target_start</span><br><span class="line">              ;;</span><br><span class="line">*)            usage</span><br><span class="line">              <span class="built_in">exit</span> <span class="variable">$OCF_ERR_UNIMPLEMENTED</span></span><br><span class="line">              ;;</span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"><span class="built_in">exit</span> $?</span><br></pre></td></tr></table></figure>
<h4 id="Configuration-HA"><a href="#Configuration-HA" class="headerlink" title="Configuration HA"></a>Configuration HA</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pcs property <span class="built_in">set</span> no-quorum-policy=ignore</span><br><span class="line">pcs property <span class="built_in">set</span> stonith-enabled=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..11&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  pcs resource create ost-<span class="variable">$i</span> ocf:heartbeat:ZFS  pool=ost-<span class="variable">$i</span></span><br><span class="line"> pcs resource update ost-<span class="variable">$i</span> op start interval=0 timeout=360</span><br><span class="line"> pcs resource update ost-<span class="variable">$i</span> op stop interval=0 timeout=360</span><br><span class="line"> pcs resource update ost-<span class="variable">$i</span> op monitor interval=5 timeout=60</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..11&#125;</span><br><span class="line"> <span class="keyword">do</span></span><br><span class="line">    mkdir /lustre_ost<span class="variable">$i</span></span><br><span class="line">    pcs resource create lustre_ost<span class="variable">$i</span> ocf:heartbeat:Lustre-ZFS vdev=<span class="string">"ost-<span class="variable">$i</span>/ost-<span class="variable">$i</span>"</span> mountpoint=<span class="string">"/lustre_ost<span class="variable">$i</span>"</span></span><br><span class="line"> pcs resource update lustre_ost<span class="variable">$i</span> op start interval=0 timeout=360</span><br><span class="line"> pcs resource update lustre_ost<span class="variable">$i</span> op stop interval=0 timeout=360</span><br><span class="line"> pcs resource update lustre_ost<span class="variable">$i</span> op  monitor interval=5 timeout=60</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;0..11&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">pcs constraint order ost-<span class="variable">$i</span> <span class="keyword">then</span> lustre_ost<span class="variable">$i</span></span><br><span class="line">pcs constraint colocation add lustre_ost<span class="variable">$i</span> with ost-<span class="variable">$i</span></span><br><span class="line">pcs resource meta ost-<span class="variable">$i</span> migration-threshold=5</span><br><span class="line">pcs resource meta lustre_ost<span class="variable">$i</span> migration-threshold=5</span><br><span class="line">pcs resource meta ost-<span class="variable">$i</span> failure-timeout=360</span><br><span class="line">pcs resource meta lustre_ost<span class="variable">$i</span> failure-timeout=360</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">pcs stonith create oss-11-4-fencing fence_ipmilan pcmk_host_list=<span class="string">"OSS-11-4.local"</span> ipaddr=<span class="string">"192.xx.xx.4"</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_<span class="built_in">wait</span>=4 op monitor interval=60s</span><br><span class="line">pcs stonith create oss-11-5-fencing fence_ipmilan pcmk_host_list=<span class="string">"OSS-11-4.local"</span> ipaddr=<span class="string">"192.xx.xx.5"</span> login=ADMIN passwd=ADMIN lanplus=<span class="literal">true</span> power_<span class="built_in">wait</span>=4 op monitor interval=60s</span><br></pre></td></tr></table></figure>
<h3 id="pcs-status-1"><a href="#pcs-status-1" class="headerlink" title="pcs status"></a>pcs status</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Cluster <span class="symbol">name:</span> </span><br><span class="line">Last <span class="symbol">updated:</span> Tue Aug <span class="number">25</span> <span class="number">15</span><span class="symbol">:</span><span class="number">36</span><span class="symbol">:</span><span class="number">31</span> <span class="number">2015</span></span><br><span class="line">Last <span class="symbol">change:</span> Thu Aug <span class="number">20</span> <span class="number">15</span><span class="symbol">:</span><span class="number">44</span><span class="symbol">:</span><span class="number">16</span> <span class="number">2015</span></span><br><span class="line"><span class="symbol">Stack:</span> classic openais (with plugin)</span><br><span class="line">Current <span class="symbol">DC:</span> OSS-<span class="number">11</span>-<span class="number">4</span>.local - partition with quorum</span><br><span class="line"><span class="symbol">Version:</span> <span class="number">1.1</span>.<span class="number">11</span>-<span class="number">97629</span>de</span><br><span class="line"><span class="number">2</span> Nodes configured, <span class="number">2</span> expected votes</span><br><span class="line"><span class="number">26</span> Resources configured</span><br><span class="line"></span><br><span class="line"><span class="symbol">Online:</span> [ OSS-<span class="number">11</span>-<span class="number">4</span>.local OSS-<span class="number">11</span>-<span class="number">5</span>.local ]</span><br><span class="line"></span><br><span class="line">Full list of <span class="symbol">resources:</span></span><br><span class="line"></span><br><span class="line"> oss-<span class="number">11</span>-<span class="number">4</span>-fencing (<span class="symbol">stonith:</span>fence_ipmilan)<span class="symbol">:</span> Started OSS-<span class="number">11</span>-<span class="number">4</span>.local </span><br><span class="line"> oss-<span class="number">11</span>-<span class="number">5</span>-fencing (<span class="symbol">stonith:</span>fence_ipmilan)<span class="symbol">:</span> Started OSS-<span class="number">11</span>-<span class="number">5</span>.local </span><br><span class="line"> ost-<span class="number">0</span> (<span class="symbol">ocf:</span><span class="symbol">:heartbeat</span><span class="symbol">:ZFS</span>)<span class="symbol">:</span> Started OSS-<span class="number">11</span>-<span class="number">4</span>.local </span><br><span class="line"> ost-<span class="number">1</span> (<span class="symbol">ocf:</span><span class="symbol">:heartbeat</span><span class="symbol">:ZFS</span>)<span class="symbol">:</span> Started OSS-<span class="number">11</span>-<span class="number">5</span>.local </span><br><span class="line"> ost-<span class="number">2</span> (<span class="symbol">ocf:</span><span class="symbol">:heartbeat</span><span class="symbol">:ZFS</span>)<span class="symbol">:</span> Started OSS-<span class="number">11</span>-<span class="number">4</span>.local </span><br><span class="line"> ost-<span class="number">3</span> (<span class="symbol">ocf:</span><span class="symbol">:heartbeat</span><span class="symbol">:ZFS</span>)<span class="symbol">:</span> Started OSS-<span class="number">11</span>-<span class="number">5</span>.local </span><br><span class="line">………..</span><br><span class="line"> lustre_ost7 (<span class="symbol">ocf:</span><span class="symbol">:heartbeat</span><span class="symbol">:Lustre-ZFS</span>)<span class="symbol">:</span> Started OSS-<span class="number">11</span>-<span class="number">5</span>.local </span><br><span class="line"> lustre_ost8 (<span class="symbol">ocf:</span><span class="symbol">:heartbeat</span><span class="symbol">:Lustre-ZFS</span>)<span class="symbol">:</span> Started OSS-<span class="number">11</span>-<span class="number">4</span>.local </span><br><span class="line"> lustre_ost9 (<span class="symbol">ocf:</span><span class="symbol">:heartbeat</span><span class="symbol">:Lustre-ZFS</span>)<span class="symbol">:</span> Started OSS-<span class="number">11</span>-<span class="number">5</span>.local </span><br><span class="line"> lustre_ost1<span class="number">0</span> (<span class="symbol">ocf:</span><span class="symbol">:heartbeat</span><span class="symbol">:Lustre-ZFS</span>)<span class="symbol">:</span> Started OSS-<span class="number">11</span>-<span class="number">4</span>.local </span><br><span class="line"> lustre_ost11 (<span class="symbol">ocf:</span><span class="symbol">:heartbeat</span><span class="symbol">:Lustre-ZFS</span>)<span class="symbol">:</span> Started OSS-<span class="number">11</span>-<span class="number">5</span>.local</span><br></pre></td></tr></table></figure>
<h4 id="Destroy-cluster"><a href="#Destroy-cluster" class="headerlink" title="Destroy cluster"></a>Destroy cluster</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ pcs resource destroy --all</span><br><span class="line"><span class="comment"># or</span></span><br><span class="line">$ rm <span class="_">-f</span> /var/lib/pacemaker/cib</span><br></pre></td></tr></table></figure>
<h4 id="Update-pacemaker-host"><a href="#Update-pacemaker-host" class="headerlink" title="Update pacemaker host"></a>Update pacemaker host</h4><p>Because if you set ip addr in pcmk_host_list, it will not work.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcs resource update fence_cngb-mds-m20-1 pcmk_host_list=cngb-mds-m20-1</span><br></pre></td></tr></table></figure></p>
<h4 id="Standby-node"><a href="#Standby-node" class="headerlink" title="Standby node"></a>Standby node</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pcs cluster standby node | --all</span><br><span class="line">pcs cluster unstandby node | --all</span><br></pre></td></tr></table></figure>
<p>Reference</p>
<p><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html-single/DM_Multipath/" target="_blank" rel="external">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html-single/DM_Multipath/</a><br><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Configuring_the_Red_Hat_High_Availability_Add-On_with_Pacemaker/index.html" target="_blank" rel="external">https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Configuring_the_Red_Hat_High_Availability_Add-On_with_Pacemaker/index.html</a><br><a href="https://github.com/zfsonlinux/zfs/labels/Bug" target="_blank" rel="external">https://github.com/zfsonlinux/zfs/labels/Bug</a><br><a href="https://github.com/skiselkov/stmf-ha" target="_blank" rel="external">https://github.com/skiselkov/stmf-ha</a><br><a href="https://github.com/zfsonlinux/pkg-zfs/wiki/Ubuntu-ZFS-mountall-FAQ-and-troubleshooting" target="_blank" rel="external">https://github.com/zfsonlinux/pkg-zfs/wiki/Ubuntu-ZFS-mountall-FAQ-and-troubleshooting</a><br><a href="http://linux-ha.996297.n3.nabble.com/custom-script-status-td14629.html" target="_blank" rel="external">http://linux-ha.996297.n3.nabble.com/custom-script-status-td14629.html</a><br><a href="https://www.youtube.com/watch?v=2XQ3Kvtd-sw" target="_blank" rel="external">https://www.youtube.com/watch?v=2XQ3Kvtd-sw</a><br><a href="http://open-zfs.org/wiki/Main_Page" target="_blank" rel="external">http://open-zfs.org/wiki/Main_Page</a><br><a href="http://irvingpop.github.io/blog/2015/03/01/redhat7-clustering-experiments/" target="_blank" rel="external">http://irvingpop.github.io/blog/2015/03/01/redhat7-clustering-experiments/</a></p>
]]></content>
      
        <categories>
            
            <category> Linux configuration </category>
            
        </categories>
        
        
        <tags>
            
            <tag> linux </tag>
            
            <tag> ha </tag>
            
            <tag> cluster </tag>
            
            <tag> corosync </tag>
            
            <tag> pacemaker </tag>
            
            <tag> lustre </tag>
            
            <tag> zfs </tag>
            
        </tags>
        
    </entry>
    
  
  
</search>
