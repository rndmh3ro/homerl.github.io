<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="linux,nic,Ethernet,benchmark," />





  <link rel="alternate" href="/atom.xml" title="Homer's Blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="RDMA supportRDMA allows for communication between systems but can bypass the overhead associated with the operating system kernel, so applications have reduced latency and much lower CPU utilization.">
<meta property="og:type" content="article">
<meta property="og:title" content="Benchmark ConnectX®-3 Pro VMA">
<meta property="og:url" content="http://yoursite.com/2016/06/03/Benchmark_ConnectX®_3_Pro/index.html">
<meta property="og:site_name" content="Homer's Blog">
<meta property="og:description" content="RDMA supportRDMA allows for communication between systems but can bypass the overhead associated with the operating system kernel, so applications have reduced latency and much lower CPU utilization.">
<meta property="og:image" content="http://sandilands.info/sgordon/images/wireshark-capture-1.png">
<meta property="og:image" content="http://sandilands.info/sgordon/images/wireshark-capture-2.png">
<meta property="og:image" content="https://dl.dropboxusercontent.com/u/4919408/tec/blog/net/net_kernel/tcp_packet_reception.png">
<meta property="og:image" content="https://dl.dropboxusercontent.com/u/4919408/tec/blog/net/net_kernel/tcp_packet_transmission.png">
<meta property="og:image" content="http://yoursite.com/img/mellanox_network.jpg">
<meta property="og:updated_time" content="2016-06-14T08:55:45.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Benchmark ConnectX®-3 Pro VMA">
<meta name="twitter:description" content="RDMA supportRDMA allows for communication between systems but can bypass the overhead associated with the operating system kernel, so applications have reduced latency and much lower CPU utilization.">
<meta name="twitter:image" content="http://sandilands.info/sgordon/images/wireshark-capture-1.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'Author'
    }
  };
</script>

  <title> Benchmark ConnectX®-3 Pro VMA | Homer's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Homer's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-home fa-fw"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-th fa-fw"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-user fa-fw"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-archive fa-fw"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-tags fa-fw"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tools">
          <a href="/tools" rel="section">
            
              <i class="menu-item-icon fa fa-heartbeat fa-fw"></i> <br />
            
            Tools
          </a>
        </li>
      
        
        <li class="menu-item menu-item-rss">
          <a href="/atom.xml" rel="section">
            
              <i class="menu-item-icon fa fa-rss fa-fw"></i> <br />
            
            Rss
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            Search
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'K4XNzEUeT9VohamGXb51','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Benchmark ConnectX®-3 Pro VMA
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Posted on</span>
            <time itemprop="dateCreated" datetime="2016-06-03T11:22:42+08:00" content="2016-06-03">
              2016-06-03
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Linux-configuration/" itemprop="url" rel="index">
                    <span itemprop="name">Linux configuration</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/06/03/Benchmark_ConnectX®_3_Pro/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/06/03/Benchmark_ConnectX®_3_Pro/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="RDMA-support"><a href="#RDMA-support" class="headerlink" title="RDMA support"></a>RDMA support</h3><p>RDMA allows for communication between systems but can bypass the overhead associated with the operating system kernel, so applications have reduced latency and much lower CPU utilization.</p>
<p><a href="https://github.com/Mellanox/libvma" target="_blank" rel="external">libvma</a><br>Linux user space library for network socket acceleration based on RDMA compatible network adaptors</p>
<p>socket ip layer ?</p>
<h3 id="Update-driver"><a href="#Update-driver" class="headerlink" title="Update driver"></a>Update driver</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apt install module-init-tools dkms</span><br><span class="line">modprobe -r mlx4_en</span><br><span class="line">modprobe -r mlx4_core</span><br><span class="line">modprobe mlx4_en mlx4_core</span><br><span class="line">modinfo mlx4_core</span><br><span class="line">filename:       /lib/modules/4.4.0-22-generic/updates/dkms/mlx4_core.ko</span><br><span class="line">version:        3.3-1.0.0</span><br><span class="line">license:        Dual BSD/GPL</span><br><span class="line">description:    Mellanox ConnectX HCA low-level driver</span><br><span class="line">author:         Roland Dreier</span><br><span class="line">srcversion:     E63C21909524B057DF41E97</span><br></pre></td></tr></table></figure>
<h3 id="NIC-info"><a href="#NIC-info" class="headerlink" title="NIC info"></a>NIC info</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ethtool -i enp5s0</span><br><span class="line">driver: mlx4_en</span><br><span class="line">version: 3.3-1.0.0 (31 May 2016)</span><br><span class="line">firmware-version: 2.36.5000</span><br><span class="line">expansion-rom-version: </span><br><span class="line">bus-info: 0000:05:00.0</span><br><span class="line">supports-statistics: yes</span><br><span class="line">supports-test: yes</span><br><span class="line">supports-eeprom-access: no</span><br><span class="line">supports-register-dump: no</span><br><span class="line">supports-priv-flags: yes</span><br></pre></td></tr></table></figure>
<h3 id="NIC-offload"><a href="#NIC-offload" class="headerlink" title="NIC offload"></a>NIC offload</h3><table>
<thead>
<tr>
<th>Features</th>
</tr>
</thead>
<tbody>
<tr>
<td>TSO (TCP Segmentation Offload)</td>
<td>on</td>
</tr>
<tr>
<td>GSO (Generic Segmentation Offload)</td>
<td>on</td>
</tr>
<tr>
<td>GRO (Generic Receive Offload)</td>
<td>on</td>
</tr>
<tr>
<td>rx-checksumming</td>
<td>on</td>
</tr>
<tr>
<td>tx-checksumming</td>
<td>on</td>
</tr>
<tr>
<td>scatter-gather</td>
<td>on</td>
</tr>
</tbody>
</table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool --offload enp5s0 rx on tx on</span><br><span class="line">Actual changes:</span><br><span class="line">rx-checksumming: on</span><br><span class="line">tx-checksumming: on</span><br><span class="line">	tx-checksum-ipv4: on</span><br><span class="line">	tx-checksum-ipv6: on</span><br><span class="line">tcp-segmentation-offload: on</span><br><span class="line">	tx-tcp-segmentation: on</span><br><span class="line">	tx-tcp6-segmentation: on</span><br><span class="line"></span><br><span class="line">$ ethtool -k enp4s0d1 | grep -v fixed</span><br><span class="line">Features <span class="keyword">for</span> enp4s0d1:</span><br><span class="line">rx-checksumming: on</span><br><span class="line">tx-checksumming: on</span><br><span class="line">	tx-checksum-ipv4: on</span><br><span class="line">	tx-checksum-ipv6: on</span><br><span class="line">scatter-gather: on</span><br><span class="line">	tx-scatter-gather: on</span><br><span class="line">tcp-segmentation-offload: on</span><br><span class="line">	tx-tcp-segmentation: on</span><br><span class="line">	tx-tcp6-segmentation: on</span><br><span class="line">generic-segmentation-offload: on</span><br><span class="line">generic-receive-offload: on</span><br><span class="line">rx-vlan-offload: on</span><br><span class="line">tx-vlan-offload: on</span><br><span class="line">ntuple-filters: on</span><br><span class="line">receive-hashing: on</span><br><span class="line">tx-nocache-copy: off</span><br><span class="line">loopback: off</span><br><span class="line">rx-fcs: off</span><br><span class="line">tx-vlan-stag-hw-insert: off</span><br><span class="line">rx-vlan-stag-hw-parse: on</span><br><span class="line"></span><br><span class="line"><span class="comment">#enable TSO</span></span><br><span class="line">$ ethtool -K enp4s0 tso on</span><br><span class="line">$ ethtool -K enp4s0 gso off</span><br></pre></td></tr></table></figure>
<p>Transmit:</p>
<ul>
<li>TSO</li>
<li>GSO  (software ?)</li>
</ul>
<p>Receive:</p>
<ul>
<li>GRO</li>
</ul>
<p>Interrupt mitigation or interrupt coalescing</p>
<p>rx-frames[-irq] rx-usecs[-irq] tx-frames[-irq] tx-usecs[-irq]</p>
<p><a href="http://serverfault.com/questions/278756/interpreting-ethtool-coalesce-output" target="_blank" rel="external">The frames parameters specify how many packets are received/transmitted before generating an interrupt. The usecs parameters specify how many microseconds after at least 1 packet is received/transmitted before generating an interrupt. The [-irq] parameters are the corresponding delays in updating the status when the interrupt is disabled.</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$ ethtool -c enp4s0d1</span><br><span class="line">Coalesce parameters <span class="keyword">for</span> enp4s0d1:</span><br><span class="line">Adaptive RX: off  TX: off</span><br><span class="line">stats-block-usecs: 0</span><br><span class="line">sample-interval: 0</span><br><span class="line">pkt-rate-low: 400000</span><br><span class="line">pkt-rate-high: 450000</span><br><span class="line"></span><br><span class="line">rx-usecs: 0</span><br><span class="line">rx-frames: 0</span><br><span class="line">rx-usecs-irq: 0</span><br><span class="line">rx-frames-irq: 0</span><br><span class="line"></span><br><span class="line">tx-usecs: 8</span><br><span class="line">tx-frames: 16</span><br><span class="line">tx-usecs-irq: 0</span><br><span class="line">tx-frames-irq: 256</span><br><span class="line"></span><br><span class="line">rx-usecs-low: 0</span><br><span class="line">rx-frame-low: 0</span><br><span class="line">tx-usecs-low: 0</span><br><span class="line">tx-frame-low: 0</span><br><span class="line"></span><br><span class="line">rx-usecs-high: 128</span><br><span class="line">rx-frame-high: 0</span><br><span class="line">tx-usecs-high: 0</span><br><span class="line">tx-frame-high: 0</span><br><span class="line"></span><br><span class="line"><span class="comment">#reduce lantency,improve cpu usage</span></span><br><span class="line">$ ethtool -C enp5s0 adaptive-rx off rx-usecs 0 rx-frames 0</span><br><span class="line">$ ethtool -C enp5s0d1 adaptive-rx off rx-usecs 0 rx-frames 0</span><br></pre></td></tr></table></figure>
<p>if you need to improve value of rx-usecs, improve latency and througput, and suggestion improve<br>net.ipv4.tcp_tso_win_divisor = 30 (default 3) too.</p>
<p><a href="http://digital.ni.com/public.nsf/allkb/65B0708FE161D8C0852563DA00620887" target="_blank" rel="external">What is Scatter-Gather DMA</a><br><a href="https://lwn.net/Articles/358910/" target="_blank" rel="external">Replace LRO with GRO</a><br><a href="https://en.wikipedia.org/wiki/Direct_memory_access" target="_blank" rel="external">Scatter-gather or vectored I/O DMA allows the transfer of data to and from multiple memory areas in a single DMA transaction. It is equivalent to the chaining together of multiple simple DMA requests. The motivation is to off-load multiple input/output interrupt and data copy tasks from the CPU</a></p>
<h5 id="About-GSO"><a href="#About-GSO" class="headerlink" title="About GSO"></a>About GSO</h5><p><a href="https://lwn.net/Articles/188489/" target="_blank" rel="external">Many people have observed that a lot of the savings in TSO come from traversing the networking stack once rather than many times for each super-packet.  These savings can be obtained without hardware support.</a><br>[GSO like TSO is only effective if the MTU is significantly less than the<br>maximum value of 64K.  So only the case where the MTU was set to 1500 is<br>of interest.</p>
<p>TSO 是使得网络协议栈能够将大块 buffer 推送至网卡，然后网卡执行分片工作，这样减轻了 CPU 的负荷，但 TSO 需要硬件来实现分片功能；而性能上的提高，主要是因为延缓分片而减轻了 CPU 的负载，因此，可以考虑将 TSO 技术一般化，因为其本质实际是延缓分片，这种技术，在 Linux 中被叫做 GSO(Generic Segmentation Offload)，它比 TSO 更通用，原因在于它不需要硬件的支持分片就可使用，对于支持 TSO 功能的硬件，则先经过 GSO 功能，然后使用网卡的硬件分片能力执行分片；而对于不支持 TSO 功能的网卡，将分片的执行，放在了将数据推送的网卡的前一刻，也就是在调用驱动的 xmit 函数前。(<a href="https://www.ibm.com/developerworks/cn/linux/l-cn-network-pt/#icomments" target="_blank" rel="external">https://www.ibm.com/developerworks/cn/linux/l-cn-network-pt/#icomments</a>)</p>
<p>if mtu 1500, kernel will split large data to 1448 bytes per packages , after enable gso (hardware), There are some 2896 bytes packages in tcpdump, and split operation in nic device.</p>
<p><a href="https://en.wikipedia.org/wiki/Goodput" target="_blank" rel="external">20 bytes of IPv4 header information and 20 bytes of TCP header information,Linux and Mac OS are further limited to 1448 bytes as they also carry a 12-byte time stamp</a><br>1500-20-20-12=1448</p>
<p><img src="http://sandilands.info/sgordon/images/wireshark-capture-1.png" alt=""><br><img src="http://sandilands.info/sgordon/images/wireshark-capture-2.png" alt=""><br><a href="http://sandilands.info/sgordon/segmentation-offloading-with-wireshark-and-ethtool" target="_blank" rel="external">Segmentation and Checksum Offloading: Turning Off with ethtool</a></p>
<h4 id="DMA-Ring-Buffer-Sizes-and-statistics"><a href="#DMA-Ring-Buffer-Sizes-and-statistics" class="headerlink" title="DMA Ring Buffer Sizes and statistics"></a>DMA Ring Buffer Sizes and statistics</h4><p>The pre-set maximum is 8192 packets. The default is 256 packets. For purposes of LAN testing, using the smallest possible ring size provides the best results<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">ethtool -S enp5s0</span><br><span class="line"></span><br><span class="line"><span class="comment"># ethtool -S eth0 | grep rx_no_buffer_count</span></span><br><span class="line">     rx_no_buffer_count: 100590</span><br><span class="line"><span class="comment"># ethtool -S eth0 | grep rx_missed_errors  </span></span><br><span class="line">     rx_missed_errors: 9188</span><br><span class="line"></span><br><span class="line">reduce buffer,<span class="keyword">in</span> this old machine, 4096 is maxinum</span><br><span class="line"></span><br><span class="line"><span class="comment">#1GbE</span></span><br><span class="line">$ ethtool -G eth0 rx 2048 tx 2048</span><br><span class="line"></span><br><span class="line">$ ethtool -g eth0</span><br><span class="line">Ring parameters <span class="keyword">for</span> eth0:</span><br><span class="line">Pre-set maximums:</span><br><span class="line">RX:		4096</span><br><span class="line">RX Mini:	0</span><br><span class="line">RX Jumbo:	0</span><br><span class="line">TX:		4096</span><br><span class="line">Current hardware settings:</span><br><span class="line">RX:		2048</span><br><span class="line">RX Mini:	0</span><br><span class="line">RX Jumbo:	0</span><br><span class="line">TX:		2048</span><br><span class="line"></span><br><span class="line"><span class="comment">#10GbE</span></span><br><span class="line">$ ethtool -g enp4s0</span><br><span class="line">Ring parameters <span class="keyword">for</span> enp4s0:</span><br><span class="line">Pre-set maximums:</span><br><span class="line">RX:		8192</span><br><span class="line">RX Mini:	0</span><br><span class="line">RX Jumbo:	0</span><br><span class="line">TX:		8192</span><br><span class="line">Current hardware settings:</span><br><span class="line">RX:		1024</span><br><span class="line">RX Mini:	0</span><br><span class="line">RX Jumbo:	0</span><br><span class="line">TX:		512</span><br></pre></td></tr></table></figure></p>
<h4 id="Enable-RSS-RFS"><a href="#Enable-RSS-RFS" class="headerlink" title="Enable RSS/RFS"></a>Enable RSS/RFS</h4><p>RSS Contemporary NICs support multiple receive and transmit descriptor queues (multi-queue). you can show it from /etc/interrupt</p>
<p><a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Performance_Tuning_Guide/network-rfs.html" target="_blank" rel="external">Receive Flow Steering (RFS) extends RPS behavior to increase the CPU cache hit rate and thereby reduce network latency</a><br><a href="http://www.mellanox.com/related-docs/prod_software/Mellanox_OFED_Linux_User_Manual_v2.2-1.0.1.pdf" target="_blank" rel="external">Enabling the RFS requires enabling the ‘ntuple’ flag via the ethtool,RFS requires the kernel to be compiled with the CONFIG_RFS_ACCEL option. This options is available in kernels 2.6.39 and above. Furthermore, RFS requires Device Managed Flow Steering support.</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ethtool -K enp5s0 ntuple on</span><br><span class="line">ethtool -K enp5s0d1 ntuple on</span><br></pre></td></tr></table></figure>
<h4 id="RSS-RFS-XPS"><a href="#RSS-RFS-XPS" class="headerlink" title="RSS RFS XPS"></a>RSS RFS XPS</h4><p><a href="http://www.mellanox.com/related-docs/prod_software/Mellanox_OFED_Linux_Release_Notes_3_1-1_0_3.pdf" target="_blank" rel="external">Added Transmit Packet Steering (XPS) support</a><br><a href="http://www.mellanox.com/related-docs/prod_software/Mellanox_OFED_Linux_Release_Notes_3_1-1_0_3.pdf" target="_blank" rel="external">RFS does not support UDP</a><br><a href="http://www.mellanox.com/related-docs/prod_software/Mellanox_OFED_Linux_Release_Notes_3_1-1_0_3.pdf" target="_blank" rel="external">RSS support of fragmented IP datagram</a><br><a href="http://www.mellanox.com/related-docs/prod_software/Mellanox_OFED_Linux_User_Manual_v2.2-1.0.1.pdf" target="_blank" rel="external">XOR RSS Hash Function</a></p>
<h4 id="Enable-Receive-Packet-Steering"><a href="#Enable-Receive-Packet-Steering" class="headerlink" title="Enable Receive Packet Steering"></a>Enable Receive Packet Steering</h4><p>Maybe mellanox not support hardware acceleration<br>Receive Packet Steering (RPS) is logically a software implementation of RSS</p>
<p>RPS has some advantages over RSS: </p>
<ul>
<li>it can be used with any NIC,</li>
<li>software filters can easily be added to hash over new protocols,</li>
<li>it does not increase hardware device interrupt rate (although it doesintroduce inter-processor interrupts (IPIs)).<br><a href="https://www.kernel.org/doc/Documentation/networking/scaling.txt" target="_blank" rel="external">kernel networking scaling</a></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span> <span class="string">'%x\n'</span> <span class="string">"<span class="variable">$((2#10101)</span>)"</span> <span class="comment"># core 0,2,4</span></span><br><span class="line">15</span><br><span class="line"><span class="built_in">printf</span> <span class="string">'%x\n'</span> <span class="string">"<span class="variable">$((2#10101000000)</span>)"</span> core 6,8,10</span><br><span class="line">540</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(ls /sys/class/net/enp5s0/queues/ | grep rx-);</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> 15 &gt; /sys/class/net/enp5s0/queues/<span class="variable">$i</span>/rps_cpus;</span><br><span class="line">        cat /sys/class/net/enp5s0/queues/<span class="variable">$i</span>/rps_cpus;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> $(ls /sys/class/net/enp5s0d1/queues/ | grep rx-);</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        <span class="built_in">echo</span> 540 &gt; /sys/class/net/enp5s0/queues/<span class="variable">$i</span>/rps_cpus;</span><br><span class="line">        cat /sys/class/net/enp5s0/queues/<span class="variable">$i</span>/rps_cpus;</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h4 id="Enable-autonegotiation"><a href="#Enable-autonegotiation" class="headerlink" title="Enable autonegotiation"></a>Enable autonegotiation</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ethtool -A enp5s0 autoneg on <span class="comment">#could not work for mellanox</span></span><br><span class="line">Cannot <span class="built_in">set</span> device pause parameters: Invalid argument</span><br><span class="line"></span><br><span class="line">ethtool -A enp5s0 rx on</span><br><span class="line">ethtool -A enp5s0 tx on</span><br><span class="line"></span><br><span class="line">ethtool <span class="_">-a</span>  <span class="variable">$nic0</span></span><br><span class="line">Pause parameters <span class="keyword">for</span> enp5s0:</span><br><span class="line">Autonegotiate:  off</span><br><span class="line">RX:             on</span><br><span class="line">TX:             on</span><br></pre></td></tr></table></figure>
<h3 id="CPU-info"><a href="#CPU-info" class="headerlink" title="CPU info"></a>CPU info</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu-16:/sys/class/net/enp5s0/device<span class="comment"># cat /sys/class/net/enp5s0/device/numa_node </span></span><br><span class="line">0</span><br><span class="line">root@ubuntu-16:/sys/class/net/enp5s0d1/device<span class="comment"># cat /sys/class/net/enp5s0d1/device/numa_node </span></span><br><span class="line">0</span><br><span class="line"></span><br><span class="line">cat /sys/class/net/enp5s0/device/<span class="built_in">local</span>_cpus</span><br><span class="line">0000,00000000,00000000,00000000,00000555</span><br><span class="line"></span><br><span class="line"><span class="comment">#same with</span></span><br><span class="line"><span class="built_in">printf</span> <span class="string">'%x\n'</span> <span class="string">"<span class="variable">$((2#10101010101)</span>)"</span></span><br><span class="line">555</span><br><span class="line"></span><br><span class="line"><span class="comment"># CPU Tubro mode</span></span><br><span class="line">```bash</span><br><span class="line">cat /sys/devices/system/cpu/cpu0/cpufreq/cpuinfo_max_freq</span><br><span class="line">3200000</span><br><span class="line"></span><br><span class="line"><span class="comment"># Disable cstate in grub.conf</span></span><br><span class="line">intel_idle.max_cstate=0 processor.max_cstate=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># disable irqbalance</span></span><br><span class="line">/etc/init.d/irqbalance stop</span><br><span class="line">[ ok ] Stopping irqbalance (via systemctl): irqbalance.service.</span><br><span class="line"></span><br><span class="line"><span class="comment"># install numactl collectl irqstat</span></span><br><span class="line">apt install numactl collectl</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/lanceshelton/irqstat</span><br><span class="line"></span><br><span class="line"><span class="comment">#lscpu</span></span><br><span class="line">Architecture:          x86_64</span><br><span class="line">CPU op-mode(s):        32-bit, 64-bit</span><br><span class="line">Byte Order:            Little Endian</span><br><span class="line">CPU(s):                12</span><br><span class="line">On-line CPU(s) list:   0-11</span><br><span class="line">Thread(s) per core:    1</span><br><span class="line">Core(s) per socket:    6</span><br><span class="line">Socket(s):             2</span><br><span class="line">NUMA node(s):          2</span><br><span class="line">Vendor ID:             GenuineIntel</span><br><span class="line">CPU family:            6</span><br><span class="line">Model:                 63</span><br><span class="line">Model name:            Intel(R) Xeon(R) CPU E5-2620 v3 @ 2.40GHz</span><br><span class="line">Stepping:              2</span><br><span class="line">CPU MHz:               1200.187</span><br><span class="line">CPU max MHz:           3200.0000</span><br><span class="line">CPU min MHz:           1200.0000</span><br><span class="line">BogoMIPS:              4795.72</span><br><span class="line">Virtualization:        VT-x</span><br><span class="line">L1d cache:             32K</span><br><span class="line">L1i cache:             32K</span><br><span class="line">L2 cache:              256K</span><br><span class="line">L3 cache:              15360K</span><br><span class="line">NUMA node0 CPU(s):     0,2,4,6,8,10</span><br><span class="line">NUMA node1 CPU(s):     1,3,5,7,9,11</span><br></pre></td></tr></table></figure>
<p>That means you ‘d better use cpus in numa node0, I guess, if numa node1 read/write data to the PCIE device, the data has to pass through QPI(Intel QuickPath Interconnect)<br>In my benchmark ,numactl will bind all applications on numa node0.</p>
<h3 id="OPS"><a href="#OPS" class="headerlink" title="OPS"></a>OPS</h3><ul>
<li>Disabled hyper thread    </li>
<li>Enable turbo mode</li>
<li>Enable numa, preferred each node</li>
<li>Disabled irqbalance</li>
</ul>
<h4 id="CPU-Affinity"><a href="#CPU-Affinity" class="headerlink" title="CPU Affinity"></a>CPU Affinity</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span> <span class="string">'%x\n'</span> <span class="string">"<span class="variable">$((2#10101010101)</span>)"</span></span><br><span class="line">555 <span class="comment">#numa_node0</span></span><br><span class="line"></span><br><span class="line">awk -F: <span class="string">'$0~/enp5/ || $0~/mlx4/ &#123;print $1&#125;'</span> /proc/interrupts | <span class="keyword">while</span> <span class="built_in">read</span> line</span><br><span class="line"><span class="keyword">do</span> </span><br><span class="line">        <span class="built_in">echo</span> 555 &gt; /proc/irq/<span class="variable">$line</span>/smp_affinity </span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h4 id="sysctl-conf-for-ipv4"><a href="#sysctl-conf-for-ipv4" class="headerlink" title="sysctl.conf for ipv4"></a>sysctl.conf for ipv4</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_sack = 0 <span class="comment">#Disable the TCP timestamps option for better CPU utilization</span></span><br><span class="line">net.core.netdev_budget = 300 </span><br><span class="line">net.ipv4.tcp_timestamps=0 <span class="comment">#Disable the TCP timestamps option for better CPU utilization</span></span><br><span class="line">net.core.netdev_max_backlog=250000 <span class="comment">#Increase the maximum length of processor input queues</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Increase the TCP maximum and default buffer sizes </span></span><br><span class="line">net.core.rmem_max=4194304</span><br><span class="line">net.core.wmem_max=4194304</span><br><span class="line">net.core.rmem_default=4194304</span><br><span class="line">net.core.wmem_default=4194304</span><br><span class="line">net.core.optmem_max=4194304</span><br><span class="line"></span><br><span class="line"><span class="comment">#Increase memory thresholds to prevent packet dropping</span></span><br><span class="line">net.ipv4.tcp_rmem=<span class="string">"4096 87380 4194304"</span></span><br><span class="line">net.ipv4.tcp_wmem=<span class="string">"4096 65536 4194304"</span></span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_low_latency=1 <span class="comment">#Enable low latency mode for TCP</span></span><br><span class="line">net.ipv4.tcp_adv_win_scale=1  <span class="comment">#A value of 1 means the socket buffer will be divided evenly between TCP windows size and application.</span></span><br></pre></td></tr></table></figure>
<h4 id="txqueueleng"><a href="#txqueueleng" class="headerlink" title="txqueueleng"></a>txqueueleng</h4><p><a href="https://www.nas.nasa.gov/assets/pdf/papers/NAS_Technical_Report_NAS-2014-01.pdf" target="_blank" rel="external">This queue parameter is mostly applicable for high-speed WAN transfers. For low-latency networks, the default setting of 1000 is sufficient. The receiving end is configured with the sysctl setting net.core.netdev_max_backlog. The default for this setting is also 1000 and does not need to be modified unless there is significant latency.</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ip link <span class="built_in">set</span> dev enp5s0 txqueuelen 1000</span><br><span class="line">ip link <span class="built_in">set</span> dev enp5s0d1 txqueuelen 1000</span><br><span class="line">ip link <span class="built_in">set</span> dev bond0 txqueuelen 2000</span><br></pre></td></tr></table></figure></p>
<h4 id="Enable-jumbo-frames"><a href="#Enable-jumbo-frames" class="headerlink" title="Enable jumbo frames"></a><a href="http://ehealth-aussie.blogspot.com/2011/11/in-depth-look-into-path-mtu-discovery.html" target="_blank" rel="external">Enable jumbo frames</a></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">net.ipv4.tcp_mtu_probing = 1</span><br><span class="line">net.ipv4.tcp_base_mss = 512</span><br><span class="line">net.ipv4.ip_no_pmtu_disc = 0</span><br></pre></td></tr></table></figure>
<p><img src="https://dl.dropboxusercontent.com/u/4919408/tec/blog/net/net_kernel/tcp_packet_reception.png" alt=""><br><img src="https://dl.dropboxusercontent.com/u/4919408/tec/blog/net/net_kernel/tcp_packet_transmission.png" alt=""></p>
<h3 id="Configure-libvma"><a href="#Configure-libvma" class="headerlink" title="Configure libvma"></a>Configure libvma</h3><p><a href="https://github.com/Mellanox/libvma/wiki/Build-Instruction" target="_blank" rel="external">Install libvma in linux</a><br><a href="https://github.com/Mellanox/libvma/blob/master/src/vma/util/libvma.conf#L22" target="_blank" rel="external">libvma.conf</a><br><a href="https://community.mellanox.com/docs/DOC-2431" target="_blank" rel="external">Using ConnectX-3 Pro with VMA over Ubuntu 16.04 Inbox Driver</a><br><a href="http://www.mellanox.com/page/products_dyn?product_family=26" target="_blank" rel="external">Mellanox OpenFabrics Enterprise Distribution for Linux MLNX_OFED</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> apt-get install dkms infiniband-diags libibverbs* ibacm librdmacm* libmlx4* libmlx5* mstflint libibcm.* libibmad.* libibumad* opensm srptools libmlx4-dev librdmacm-dev rdmacm-utils ibverbs-utils perftest vlan ibutils</span><br><span class="line"> apt-get install libnl-3-200 libnl-route-3-200 libnl-route-3-dev libnl-utils</span><br><span class="line"> git <span class="built_in">clone</span> https://github.com/Mellanox/libvma.git $ <span class="built_in">cd</span> libvma </span><br><span class="line"> ./autogen.sh</span><br><span class="line"> ./configure --prefix=/usr</span><br><span class="line"> make -j 12</span><br><span class="line"> make install</span><br><span class="line"> ldconfig</span><br><span class="line"> <span class="built_in">echo</span> options mlx4_core <span class="built_in">log</span>_num_mgm_entry_size=-1 &gt; /etc/modprobe.d/mlnx.conf</span><br><span class="line"> <span class="built_in">echo</span> 1000000000 &gt; /proc/sys/kernel/shmmax</span><br><span class="line"> <span class="built_in">echo</span> 800 &gt; /proc/sys/vm/nr_hugepage</span><br><span class="line"> <span class="built_in">ulimit</span> <span class="_">-l</span> unlimited</span><br><span class="line"> LD_PRELOAD=libvma.so &lt;<span class="built_in">test</span>_app&gt;</span><br><span class="line"></span><br><span class="line">$ cat /etc/modprobe.d/mlx4.conf </span><br><span class="line"><span class="comment"># mlx4_core gets automatically loaded, load mlx4_en also (LP: #1115710)</span></span><br><span class="line">softdep mlx4_core post: mlx4_en</span><br><span class="line"><span class="comment">#options mlx4_en inline_thold=0</span></span><br><span class="line">options mlx4_core port_<span class="built_in">type</span>_array=2,2 num_vfs=2 probe_vf=0 <span class="built_in">enable</span>_64b_cqe_eqe=0  <span class="built_in">log</span>_num_mgm_entry_size=-1</span><br></pre></td></tr></table></figure></p>
<h3 id="Benchmark"><a href="#Benchmark" class="headerlink" title="Benchmark"></a>Benchmark</h3><h4 id="Architecture"><a href="#Architecture" class="headerlink" title="Architecture"></a>Architecture</h4><p><img src="/img/mellanox_network.jpg" alt="Network_Arch"><br>CPU is not bottle neck, 2620 was enough for quad/dual 10GbE</p>
<h4 id="sockperf"><a href="#sockperf" class="headerlink" title="sockperf"></a>sockperf</h4><p>sockperf: == version #2.7-53.git6f0f32c1fb02 ==<br>MTU 1500<br>single core server/client, single port</p>
<p>./sockperf server –tcp -p 11111<br>./sockperf server -p 11111 #udp<br>numactl -C 2 /opt/sockperf/bin/sockperf tp -m 256  -i 192.168.12.201 -p 11111 -t 20<br>numactl -C 2 /opt/sockperf/bin/sockperf pp -m 256  -i 192.168.12.201 -p 11111 -t 20</p>
<p>Throughput (MBps)</p>
<table>
<thead>
<tr>
<th>msg size bytes</th>
<th>TCP TP MBps</th>
<th>TCP TP VMA</th>
<th>UDP TP</th>
<th>UDP TP VMA</th>
</tr>
</thead>
<tbody>
<tr>
<td>256</td>
<td>289.160</td>
<td>695.808</td>
<td>78.632</td>
<td>766.952</td>
</tr>
<tr>
<td>512</td>
<td>420.863</td>
<td>1125.157</td>
<td>154.019</td>
<td>1055.240</td>
</tr>
<tr>
<td>1024</td>
<td>1129.297</td>
<td>1130.277</td>
<td>301.421</td>
<td>1119.500</td>
</tr>
<tr>
<td>2048</td>
<td>1131.170</td>
<td>1130.346</td>
<td>381.049</td>
<td>1123.660</td>
</tr>
<tr>
<td>4096</td>
<td>1131.160</td>
<td>1130.387</td>
<td>564.496</td>
<td>1141.008</td>
</tr>
</tbody>
</table>
<p>Package num (msg/s)<br>msg/s=(send+rec msg) per second</p>
<table>
<thead>
<tr>
<th>msg size bytes</th>
<th>TCP PP</th>
<th>TCP PP VMA</th>
<th>TCP PP 3x</th>
<th>TCP PP 3x VMA</th>
<th>Intel X540</th>
<th>ConnectX-3</th>
<th>ConnectX-3 VMA</th>
</tr>
</thead>
<tbody>
<tr>
<td>256</td>
<td>61813</td>
<td>261712</td>
<td>181845</td>
<td>702355</td>
<td>53663</td>
<td>63698</td>
<td>258556</td>
</tr>
<tr>
<td>512</td>
<td>65832</td>
<td>225369</td>
<td>154585</td>
<td>615563</td>
<td>53414</td>
<td>52425</td>
<td>223479</td>
</tr>
<tr>
<td>1024</td>
<td>51411</td>
<td>182045</td>
<td>158244</td>
<td>503944</td>
<td>53067</td>
<td>56812</td>
<td>179406</td>
</tr>
<tr>
<td>2048</td>
<td>40918</td>
<td>130620</td>
<td>130946</td>
<td>353721</td>
<td>36214</td>
<td>35772</td>
<td>127449</td>
</tr>
</tbody>
</table>
<p>AVG Latency(us)                                                                                                       </p>
<table>
<thead>
<tr>
<th>msg size bytes</th>
<th>TCP PP</th>
<th>TCP PP VMA</th>
<th>TCP PP 3x</th>
<th>TCP PP 3x VMA</th>
<th>Intel X540</th>
<th>ConnectX-3</th>
<th>ConnectX-3 VMA</th>
</tr>
</thead>
<tbody>
<tr>
<td>256</td>
<td>14.611</td>
<td>3.798</td>
<td>16.7707</td>
<td>4.268</td>
<td>17.072</td>
<td>15.644</td>
<td>3.845</td>
</tr>
<tr>
<td>512</td>
<td>16.162</td>
<td>4.434</td>
<td>19.8913</td>
<td>4.866</td>
<td>18.667</td>
<td>19.013</td>
<td>4.456</td>
</tr>
<tr>
<td>1024</td>
<td>17.433</td>
<td>5.455</td>
<td>30.7607</td>
<td>5.9526</td>
<td>18.789</td>
<td>17.547</td>
<td>5.576</td>
</tr>
<tr>
<td>2048</td>
<td>24.768</td>
<td>7.849</td>
<td>28.7957</td>
<td>8.49</td>
<td>27.556</td>
<td>27.347</td>
<td>7.857</td>
</tr>
</tbody>
</table>
<h4 id="UDP-performance"><a href="#UDP-performance" class="headerlink" title="UDP performance"></a>UDP performance</h4><table>
<thead>
<tr>
<th>msg size bytes</th>
<th>UDP PP</th>
<th>UDP PP VMA </th>
</tr>
</thead>
<tbody>
<tr>
<td>256</td>
<td>65921</td>
<td>311823     </td>
</tr>
<tr>
<td>512</td>
<td>68160</td>
<td>261528     </td>
</tr>
<tr>
<td>1024</td>
<td>62480</td>
<td>203539     </td>
</tr>
<tr>
<td>1472</td>
<td>62233</td>
<td>171311     </td>
</tr>
<tr>
<td>2048</td>
<td>49457</td>
<td>46734      </td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>msg size bytes</th>
<th>UDP PP</th>
<th>UDP PP VMA </th>
</tr>
</thead>
<tbody>
<tr>
<td>256</td>
<td>9.474</td>
<td>3.201       </td>
</tr>
<tr>
<td>512</td>
<td>9.635</td>
<td>3.757       </td>
</tr>
<tr>
<td>1024</td>
<td>10.800</td>
<td>4.822       </td>
</tr>
<tr>
<td>1472</td>
<td>16.016</td>
<td>5.815           </td>
</tr>
<tr>
<td>2048</td>
<td>20.161</td>
<td>19.953      </td>
</tr>
</tbody>
</table>
<h4 id="netperf"><a href="#netperf" class="headerlink" title="netperf"></a>netperf</h4><p>numactl -C 2 netserver -D  -4 -v 2 -p 5000 -f -L 192.168.12.201<br>numactl -N 0 ./netperf -n 6 -p 5000 -H 192.168.12.201 -c -C -t TCP_STREAM -l 15 -T 2,2 – -m $((2<strong>$i))<br>numactl -N 0 ./netperf -n 6 -p 5000 -H 192.168.12.201 -c -C -t TCP_RR -l 20 -T 2,2 – -m $((2</strong>$i))<br>numactl -N 0 ./netperf -n 6 -p 5000 -H 192.168.12.201 -c -C -t UDP_RR -l 20 -T 2,2 – -m $((2**$i))</p>
<table>
<thead>
<tr>
<th>msg size bytes</th>
<th>TCP RR</th>
<th>TCP RR VMA</th>
<th>UDP RR</th>
<th>UDP RR VMA </th>
</tr>
</thead>
<tbody>
<tr>
<td>256</td>
<td>43428.69</td>
<td>129390.97</td>
<td>49805.09</td>
<td>146545.15  </td>
</tr>
<tr>
<td>512</td>
<td>37705.07</td>
<td>107808.85</td>
<td>46393.12</td>
<td>125839.11  </td>
</tr>
<tr>
<td>1024</td>
<td>35005.28</td>
<td>90787.06</td>
<td>39591.57</td>
<td>98669.99   </td>
</tr>
<tr>
<td>2048</td>
<td>23688.22</td>
<td>63992.85</td>
<td>22633.36</td>
<td>19961.70   </td>
</tr>
<tr>
<td>4096</td>
<td>22933.14</td>
<td>51851.17</td>
<td>20772.47</td>
<td>18604.53   </td>
</tr>
</tbody>
</table>
<h4 id="redis-benchmark"><a href="#redis-benchmark" class="headerlink" title="redis-benchmark"></a>redis-benchmark</h4><p>LD_PRELOAD=libvma.so VMA_STATS_FD_NUM=500 redis-server –port 7777  –protected-mode no –maxmemory 12000mb –maxmemory-samples 10 –maxmemory-policy allkeys-lru<br>numactl -C 2 redis-benchmark -r 10000000 -n 20000000 -t get,set,lpush,lpop -P 16 -q -h 192.168.12.201 -p 7777 -d 16</p>
<p>set/get/lpush/lpop records/s</p>
<table>
<thead>
<tr>
<th>size bytes</th>
<th>set</th>
<th>get</th>
<th>lpush</th>
<th>lpop</th>
<th>set vma</th>
<th>get vma</th>
<th>lpush vma</th>
<th>lpop vma   </th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>909628.44</td>
<td>995668.88</td>
<td>1125492.38</td>
<td>1092836.38</td>
<td>1051801.25</td>
<td>1383604.25</td>
<td>1427857.50</td>
<td>1412230.00 </td>
</tr>
<tr>
<td>16</td>
<td>877077.62</td>
<td>975181.56</td>
<td>1126506.75</td>
<td>1058537.12</td>
<td>960937.88</td>
<td>1332001.25</td>
<td>1403213.38</td>
<td>1408054.00 </td>
</tr>
<tr>
<td>64</td>
<td>765814.06</td>
<td>963205.56</td>
<td>881834.19</td>
<td>1040203.94</td>
<td>785360.88</td>
<td>1114082.00</td>
<td>1179384.38</td>
<td>1258890.88 </td>
</tr>
<tr>
<td>256</td>
<td>596801.12</td>
<td>714030.69</td>
<td>787928.94</td>
<td>864416.31</td>
<td>614420.50</td>
<td>943129.31</td>
<td>868847.50</td>
<td>970167.38  </td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>size bytes</th>
<th>set x4</th>
<th>get x4</th>
<th>lpush x4</th>
<th>lpop x4</th>
<th>set x4 vma</th>
<th>get x4</th>
<th>lpush x4</th>
<th>lpop x4   </th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>1179965.09</td>
<td>1580834.26</td>
<td>2055718.79</td>
<td>2001333.44</td>
<td>2432077.24</td>
<td>3466123.12</td>
<td>3255039.99</td>
<td>3349659.25</td>
</tr>
<tr>
<td>16</td>
<td>1205777.63</td>
<td>1656787.75</td>
<td>1685172.72</td>
<td>2167017.68</td>
<td>2212556.32</td>
<td>3204048.56</td>
<td>3243653</td>
<td>3355042</td>
</tr>
<tr>
<td>64</td>
<td>1125920.34</td>
<td>1491794.08</td>
<td>1603009.35</td>
<td>2040705.93</td>
<td>2004204.13</td>
<td>3079092.74</td>
<td>2744756.94</td>
<td>3079859.44</td>
</tr>
<tr>
<td>256</td>
<td>1172390.68</td>
<td>1236795.19</td>
<td>1024634.36</td>
<td>1474094.21</td>
<td>1717803</td>
<td>2521588</td>
<td>1659403.82</td>
<td>2402496.31</td>
</tr>
</tbody>
</table>
<p>Intel X540</p>
<table>
<thead>
<tr>
<th>size bytes</th>
<th>set x4</th>
<th>get x4</th>
<th>lpush x4</th>
<th>lpop x4   </th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>1512821.64</td>
<td>2118883.93</td>
<td>1834559.35</td>
<td>1960360.28</td>
</tr>
<tr>
<td>16</td>
<td>1449761.53</td>
<td>1851285.18</td>
<td>1910151.44</td>
<td>2017602.97</td>
</tr>
<tr>
<td>64</td>
<td>1199011.03</td>
<td>1773449.28</td>
<td>1612987.21</td>
<td>1806331.65</td>
</tr>
<tr>
<td>256</td>
<td>1097519.72</td>
<td>1121691.17</td>
<td>1145548.86</td>
<td>1398369.94</td>
</tr>
</tbody>
</table>
<p>ConnectX-3 </p>
<table>
<thead>
<tr>
<th>size bytes</th>
<th>set x4 VMA</th>
<th>get x4 VMA</th>
<th>lpush x4 VMA</th>
<th>lpop x4 VMA</th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>2455271.19</td>
<td>3476625.19</td>
<td>3360328.38</td>
<td>3401881.00</td>
</tr>
<tr>
<td>16</td>
<td>2461504.31</td>
<td>3309726.63</td>
<td>3224818.00</td>
<td>3322884.63</td>
</tr>
<tr>
<td>64</td>
<td>1954063.35</td>
<td>2876987.38</td>
<td>2729820.24</td>
<td>3035352.45</td>
</tr>
<tr>
<td>256</td>
<td>1498470.37</td>
<td>2356658.57</td>
<td>1650766.50</td>
<td>2362893.44</td>
</tr>
</tbody>
</table>
<p>Because not enough memory in single node, so I can’ t benchamrk 6xredis-server benchmark with 6xredis-benchmark<br>echo 1024 &gt; /proc/sys/net/core/somaxconn<br>vm.overcommit_memory = 1<br>echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled (reduce performance when you enable VMA, cancel)<br>13562:M 10 Jun 01:02:39.054 # WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.<br>13562:M 10 Jun 01:02:39.054 # Server started, Redis version 3.2.0<br>13562:M 10 Jun 01:02:39.054 # WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add ‘vm.overcommit_memory = 1’ to /etc/sysctl.conf and then reboot or run the command ‘sysctl vm.overcommit_memory=1’ for this to take effect.<br>13562:M 10 Jun 01:02:39.054 # WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command ‘echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled’ as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</p>
<ul>
<li>In VMA environment, if you disable Transparent Huge Pages, redis performance will decreased.</li>
</ul>
<h4 id="qperf"><a href="#qperf" class="headerlink" title="qperf"></a>qperf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> VMA PANIC: ib_ctx_handler73:ib_ctx_handler() ibv device 0x1523ee0 pd allocation failure (ibv context 0x15266d0) (errno=13 Permission denied)</span><br><span class="line">terminate called without an active exception</span><br><span class="line"> VMA PANIC: ib_ctx_handler73:ib_ctx_handler() ibv device 0x1523ee0 pd allocation failure (ibv context 0x15266d0) (errno=13 Permission denied)</span><br><span class="line">terminate called without an active exception</span><br><span class="line"> VMA PANIC: ib_ctx_handler73:ib_ctx_handler() ibv device 0x1523ee0 pd allocation failure (ibv context 0x15266d0) (errno=13 Permission denied)</span><br><span class="line">terminate called without an active exception</span><br></pre></td></tr></table></figure>
<p>###Another function<br><a href="http://www.intel.com/content/dam/www/public/us/en/documents/product-briefs/ethernet-x710-brief.pdf" target="_blank" rel="external">ethernet brief</a></p>
<p><a href="https://www.nas.nasa.gov/assets/pdf/papers/NAS_Technical_Report_NAS-2014-01.pdf" target="_blank" rel="external">Comparison of 40G RDMA and Traditional Ethernet Technologies</a><br><a href="http://www.mellanox.com/related-docs/prod_software/Performance_Tuning_Guide_for_Mellanox_Network_Adapters.pdf" target="_blank" rel="external">Performance Tuning Guidelines for Mellanox Network Adapters</a><br><a href="http://jaseywang.me/2013/11/02/10g82599eb-%E7%BD%91%E5%8D%A1%E6%B5%8B%E8%AF%95%E4%BC%98%E5%8C%96ethtool/" target="_blank" rel="external">10G 82599EB 网卡测试优化</a></p>

      
    </div>

    <div>
      
        
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/linux/" rel="tag">#linux</a>
          
            <a href="/tags/nic/" rel="tag">#nic</a>
          
            <a href="/tags/Ethernet/" rel="tag">#Ethernet</a>
          
            <a href="/tags/benchmark/" rel="tag">#benchmark</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/06/02/About-SSD-power-loss/" rel="next" title="About SSD power loss">
                <i class="fa fa-chevron-left"></i> About SSD power loss
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/06/16/Main-board-SATA-bottle-neck/" rel="prev" title="Main board SATA port bottle neck">
                Main board SATA port bottle neck <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/img/mq1-penn.jpg"
               alt="Homer Li" />
          <p class="site-author-name" itemprop="name">Homer Li</p>
          <p class="site-description motion-element" itemprop="description">The chioce you make, the risks you take</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">66</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>
          
          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">categories</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">94</span>
                <span class="site-state-item-name">tags</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/homerl/" target="_blank">
                  
                    <i class="fa fa-github"></i> GitHub
                  
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://plus.google.com/u/0/112219574615546910314" target="_blank">
                  
                    <i class="fa fa-globe"></i> G+
                  
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="http://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator">
            <i class="fa fa-angle-double-up"></i>
          </div>
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#RDMA-support"><span class="nav-number">1.</span> <span class="nav-text">RDMA support</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Update-driver"><span class="nav-number">2.</span> <span class="nav-text">Update driver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NIC-info"><span class="nav-number">3.</span> <span class="nav-text">NIC info</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NIC-offload"><span class="nav-number">4.</span> <span class="nav-text">NIC offload</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#About-GSO"><span class="nav-number">4.0.1.</span> <span class="nav-text">About GSO</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DMA-Ring-Buffer-Sizes-and-statistics"><span class="nav-number">4.1.</span> <span class="nav-text">DMA Ring Buffer Sizes and statistics</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Enable-RSS-RFS"><span class="nav-number">4.2.</span> <span class="nav-text">Enable RSS/RFS</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RSS-RFS-XPS"><span class="nav-number">4.3.</span> <span class="nav-text">RSS RFS XPS</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Enable-Receive-Packet-Steering"><span class="nav-number">4.4.</span> <span class="nav-text">Enable Receive Packet Steering</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Enable-autonegotiation"><span class="nav-number">4.5.</span> <span class="nav-text">Enable autonegotiation</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CPU-info"><span class="nav-number">5.</span> <span class="nav-text">CPU info</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OPS"><span class="nav-number">6.</span> <span class="nav-text">OPS</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CPU-Affinity"><span class="nav-number">6.1.</span> <span class="nav-text">CPU Affinity</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sysctl-conf-for-ipv4"><span class="nav-number">6.2.</span> <span class="nav-text">sysctl.conf for ipv4</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#txqueueleng"><span class="nav-number">6.3.</span> <span class="nav-text">txqueueleng</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Enable-jumbo-frames"><span class="nav-number">6.4.</span> <span class="nav-text">Enable jumbo frames</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Configure-libvma"><span class="nav-number">7.</span> <span class="nav-text">Configure libvma</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Benchmark"><span class="nav-number">8.</span> <span class="nav-text">Benchmark</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Architecture"><span class="nav-number">8.1.</span> <span class="nav-text">Architecture</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#sockperf"><span class="nav-number">8.2.</span> <span class="nav-text">sockperf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UDP-performance"><span class="nav-number">8.3.</span> <span class="nav-text">UDP performance</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#netperf"><span class="nav-number">8.4.</span> <span class="nav-text">netperf</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#redis-benchmark"><span class="nav-number">8.5.</span> <span class="nav-text">redis-benchmark</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#qperf"><span class="nav-number">8.6.</span> <span class="nav-text">qperf</span></a></li></ol></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator">
            <i class="fa fa-angle-double-down"></i>
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Homer Li</span>
&nbsp&nbsp&nbsp Pageviews: <span id="busuanzi_value_site_pv"></span> &nbsp&nbsp&nbsp
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
&nbsp&nbsp&nbsp You are the <span id="busuanzi_value_site_uv"></span>th visitor &nbsp&nbsp&nbsp
</div>



      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  


  




<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  
  
<script type="text/javascript" src="/js/src/scrollspy.js?v=0.5.0"></script>

<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 1 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = NexT.utils.escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    NexT.motion.middleWares.sidebar = function () {
      var $tocContent = $('.post-toc-content');

      if (CONFIG.scheme !== 'Pisces' && (CONFIG.sidebar.display === 'post' || CONFIG.sidebar.display === 'always')) {
        if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
          NexT.utils.displaySidebar();
        }
      }
    };
  });
</script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  



  

    <script type="text/javascript">
      var disqus_shortname = 'homersblog';
      var disqus_identifier = '2016/06/03/Benchmark_ConnectX®_3_Pro/';
      var disqus_title = 'Benchmark ConnectX®-3 Pro VMA';
      var disqus_url = 'http://yoursite.com/2016/06/03/Benchmark_ConnectX®_3_Pro/';

      function run_disqus_script(disqus_script){
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      }

      run_disqus_script('count.js');
      
        run_disqus_script('embed.js');
      
    </script>
  




  
  
  <script type="text/javascript">
    // Popup Window;
    var scrollTop = '';
    var newHeight = '100';

    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
       search_path = "search.xml";
    }
    var path = "/" + search_path;

    // monitor main search box;
    $('#search-input').on('input', function() {
    if ($(this).val().length <= 0) {
      $('#search-result').hide();
      return;
    }
    $('i.search-keyword').text($(this).val());
    $('a.search-result[href!="#"]').each(function(){
      this.href = this.href.replace(/\=(.*?)(?=%20site)/,'='+$('#search-input').val())
    });
    $('#search-result').show();
    });

    // search function;
    var searchFunc = function(path, search_id, content_id) {
    'use strict';
    searchFunc = function(){};
    $.ajax({
        url: path,
        dataType: "xml",
        async: false,
        success: function( xmlResponse ) {
            // get the contents from search data
            var datas = $( "entry", xmlResponse ).map(function() {
                return {
                    title: $( "title", this ).text(),
                    content: $("content",this).text(),
                    url: $( "url" , this).text()
                };
            }).get();
            var $input = document.getElementById(search_id);
            var $resultContent = document.getElementById(content_id);
            $input.addEventListener('input', function(){
                var str='<ul class=\"search-result-list\">';                
                var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                $resultContent.innerHTML = "";
                if (this.value.trim().length <= 0) {
                    return;
                }
                // perform local searching
                datas.forEach(function(data) {
                    var isMatch = true;
                    var content_index = [];
                    var data_title = data.title.trim().toLowerCase();
                    var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                    var data_url = data.url;
                    var index_title = -1;
                    var index_content = -1;
                    var first_occur = -1;
                    // only match artiles with not empty titles and contents
                    if(data_title != '' && data_content != '') {
                        keywords.forEach(function(keyword, i) {
                            index_title = data_title.indexOf(keyword);
                            index_content = data_content.indexOf(keyword);
                            if( index_title < 0 && index_content < 0 ){
                                isMatch = false;
                            } else {
                                if (index_content < 0) {
                                    index_content = 0;
                                }
                                if (i == 0) {
                                    first_occur = index_content;
                                }
                            }
                        });
                    }
                    // show search results
                    if (isMatch) {
                        str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                        var content = data.content.trim().replace(/<[^>]+>/g,"");
                        if (first_occur >= 0) {
                            // cut out 100 characters
                            var start = first_occur - 20;
                            var end = first_occur + 80;
                            if(start < 0){
                                start = 0;
                            }
                            if(start == 0){
                                end = 100;
                            }
                            if(end > content.length){
                                end = content.length;
                            }
                            var match_content = content.substr(start, end); 
                            // highlight all keywords
                            keywords.forEach(function(keyword){
                                var regS = new RegExp(keyword, "gi");
                                match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                            });
                            
                            str += "<p class=\"search-result\">" + match_content +"...</p>"
                        }
                        str += "</li>";
                    }
                });
                str += "</ul>";
                $resultContent.innerHTML = str;
            });
        }
    });}

    // handle and trigger popup window;
    $(window).bind('scroll', function() {
      scrollTop = $( window ).scrollTop();
      newHeight = scrollTop + 100;
    });
    $('#search-result a').mousedown(function(e) {
        window.location.href = this.href;
      });
    $('.popup-trigger').mousedown(function(e) {
      searchFunc(path, 'local-search-input', 'local-search-result');
      $('#local-search-input').val($('#search-input').val());
      document.getElementById('local-search-input').dispatchEvent(new Event('input'));
      e.stopPropagation();
      if(jQuery(window).width() < 750) {
        $('.site-search-form').after( $( ".popup" ) );
        $('.popup').show().addClass('popup-mobile').css('top', 0);
        $('html, body').animate({
          scrollTop: $('.popup').offset().top
        }, 500);
      } else {
        $('.popup').removeClass('popup-mobile').css('top', newHeight).toggle();
      };
    });

    $('#search-input').focus(function() {
    if ($(this).val().length > 0) {
      $('#search-result').show();
      }
    });
    $('#search-input').blur(function() {
      $('#search-result').hide();
    });

    $('html').click(function() {
      $('.popup').hide();
    });
    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>

  

  


</body>
</html>
